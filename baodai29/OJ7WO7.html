
    <!DOCTYPE html>
    <html lang="vi">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Bài Tập Luyện Tập</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
        <script>
            window.MathJax = {
                tex: {
                    packages: {'[+]': ['ams']},
                    inlineMath: [['$', '$'], ['\\(', '\\)']],
                    displayMath: [['$$', '$$'], ['\\[', '\\]']]
                },
                chtml: {
                    fontCache: 'global',
                    linebreaks: {
                        automatic: true
                    }
                }
            };
        </script>
        <script type="text/javascript" id="MathJax-script" async
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
        </script>
        <style>
            body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #f0f4f8; }
            .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
            @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
            .question-card {
                background-color: white;
                border-radius: 1rem;
                padding: 1.5rem 2rem;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                border-left: 5px solid transparent;
                transition: all 0.3s ease;
            }
            .ai-explanation {
                background-color: #f0f9ff;
                color: #0c4a6e;
                padding: 1rem;
                border-radius: 0.75rem;
                font-size: 0.9rem;
                margin-top: 1rem;
                border-left: 4px solid #38bdf8;
            }
            .feedback-icon { width: 1.5rem; height: 1.5rem; }
            .option-label {
                transition: all 0.2s ease-in-out;
                border: 2px solid #e5e7eb;
            }
            .option-label:hover {
                border-color: #6366f1;
                background-color: #eef2ff;
            }
            .option-label.correct {
                border-color: #10b981 !important;
                background-color: #ecfdf5 !important;
                color: #065f46;
            }
            .option-label.incorrect {
                border-color: #ef4444 !important;
                background-color: #fef2f2 !important;
                color: #991b1b;
            }
            .statement-item.correct { background-color: #ecfdf5; border-color: #10b981; }
            .statement-item.incorrect { background-color: #fef2f2; border-color: #ef4444; }
            .prose { max-width: 100%; }
            .prose h1, .prose h2, .prose h3 { font-weight: 600; }
            .prose p { margin-top: 0.5em; margin-bottom: 0.5em; }
            .prose ul, .prose ol { margin-top: 1em; margin-bottom: 1em; padding-left: 1.5em; }
            .prose li > p { margin-top: 0; margin-bottom: 0; }
            .prose code { background-color: #e5e7eb; padding: 0.2em 0.4em; margin: 0; font-size: 85%; border-radius: 3px; }
            .prose pre { background-color: #e5e7eb; padding: 1em; border-radius: 0.5em; overflow-x: auto; }
            .prose pre code { background-color: transparent; padding: 0; }
            details[open] > summary .details-arrow {
                transform: rotate(180deg);
            }
        </style>
    </head>
    <body class="bg-slate-100 text-slate-800">
        <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md transform transition-all" style="animation: fadeIn 0.3s ease-out;">
                <h2 class="text-2xl font-bold mb-2 text-center text-slate-800">Thông Tin Học Sinh</h2>
                <p class="text-center text-slate-500 mb-6">Vui lòng nhập để bắt đầu làm bài.</p>
                <form id="student-info-form">
                    <div class="mb-4">
                        <label for="student-name" class="block text-sm font-medium text-slate-700 mb-1">Họ và tên</label>
                        <input type="text" id="student-name" required class="mt-1 block w-full block border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="student-class" class="block text-sm font-medium text-slate-700 mb-1">Lớp</label>
                        <input type="text" id="student-class" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="exam-code" class="block text-sm font-medium text-slate-700 mb-1">Mã đề</label>
                        <input type="text" id="exam-code" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Nhập mã đề giáo viên cung cấp">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Giáo viên:</label>
                        <p class="mt-1 text-slate-800 bg-slate-100 p-2.5 rounded-lg">HUỲNH BẢO ĐẠI</p>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">Bắt đầu làm bài</button>
                </form>
            </div>
        </div>
        <div class="container mx-auto p-4 md:p-8 max-w-4xl">
            <header class="mb-10 p-8 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg">
                <div class="flex justify-between items-center flex-wrap gap-4">
                    <div>
                        <h1 class="text-4xl font-bold">Bài Tập Luyện Tập</h1>
                        <p class="text-lg text-blue-100 mt-2">Hãy hoàn thành các câu hỏi dưới đây một cách tốt nhất!</p>
                        <p class="text-sm text-blue-200 mt-4">Tác giả: HUỲNH BẢO ĐẠI</p>
                    </div>
                    <div id="timer-container" class="text-right">
                         <div id="timer-display" class="text-3xl font-bold tracking-wider bg-white/20 px-4 py-2 rounded-lg">--:--</div>
                         <div id="retries-display" class="text-sm mt-1 text-blue-200"></div>
                    </div>
                </div>
            </header>
            <main id="student-quiz-container" class="space-y-8 hidden">
                <!-- Questions will be rendered here by JS -->
            </main>
            <footer class="mt-10 text-center">
                <button id="submit-quiz-btn" class="bg-indigo-600 text-white py-3 px-12 rounded-full font-bold text-lg hover:bg-indigo-700 transition-all duration-300 shadow-lg hover:shadow-xl hidden transform hover:scale-105">Nộp Bài</button>
                <div id="result-container" class="mt-6 hidden"></div>
                <div id="ai-feedback-container" class="mt-8 text-left hidden"></div>
                <div id="post-submit-options" class="hidden mt-6 flex flex-col sm:flex-row items-center justify-center gap-4">
                    <button id="retry-quiz-btn" class="w-full sm:w-auto bg-slate-600 text-white py-2.5 px-6 rounded-lg font-semibold hover:bg-slate-700 transition-transform transform hover:scale-105">Làm Lại Đề Này</button>
                </div>
            </footer>
        </div>

        <div id="proctoring-widget" class="fixed bottom-4 right-4 bg-yellow-100 text-yellow-800 p-3 rounded-lg shadow-lg text-sm z-50 hidden border border-yellow-300" style="max-width: 200px;">
            <h4 class="font-bold mb-2 border-b border-yellow-300 pb-1 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 3.001-1.742 3.001H4.42c-1.53 0-2.493-1.667-1.743-3.001l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                Giám sát
            </h4>
            <p>Thoát màn hình: <span id="tab-switch-count" class="font-bold">0</span></p>
            <p>Sao chép: <span id="copy-count" class="font-bold">0</span></p>
            <p>Dán: <span id="paste-count" class="font-bold">0</span></p>
        </div>

        <script type="module">
            import { GoogleGenAI, Type } from "https://esm.sh/@google/genai@^1.13.0";
            let quizData = [{"type":"multiple-choice","question":"Ngành kĩ thuật điện chủ yếu nghiên cứu và ứng dụng các vấn đề liên quan đến quá trình nào của điện năng?","questionImage":null,"mappedType":"multiple-choice","options":["Sản xuất, truyền tải, phân phối và sử dụng.","Thiết kế, chế tạo và lắp đặt thiết bị cơ khí.","Phân tích cấu trúc vật liệu và hợp kim.","Quản lí tài chính và tiếp thị sản phẩm điện."],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Vai trò nào sau đây của kĩ thuật điện là quan trọng nhất trong các ngành sản xuất công nghiệp hiện đại?","questionImage":null,"mappedType":"multiple-choice","options":["Cung cấp năng lượng vận hành máy móc, thiết bị.","Cung cấp nguyên liệu thô cho sản xuất.","Quản lý nhân sự và đào tạo công nhân.","Xây dựng chiến lược tiếp thị sản phẩm."],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Trong đời sống hàng ngày, kĩ thuật điện đóng vai trò chủ yếu trong việc cung cấp tiện ích nào?","questionImage":null,"mappedType":"multiple-choice","options":["Giải trí và thông tin.","Năng lượng cho sinh hoạt và chiếu sáng.","Phương tiện giao thông công cộng.","Vật liệu xây dựng cơ bản."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Một trong những triển vọng phát triển quan trọng của kĩ thuật điện hiện nay là tập trung vào việc khai thác các nguồn năng lượng nào?","questionImage":null,"mappedType":"multiple-choice","options":["Năng lượng hóa thạch truyền thống.","Năng lượng hạt nhân.","Năng lượng tái tạo (như mặt trời, gió, thủy điện nhỏ).","Năng lượng từ phản ứng hóa học."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Lưới điện thông minh (Smart Grid) mang lại ưu điểm nổi bật nào cho hệ thống điện?","questionImage":null,"mappedType":"multiple-choice","options":["Chỉ tập trung vào sản xuất điện từ than đá.","Giảm thiểu khả năng tương tác với người dùng.","Tăng cường hiệu quả, độ tin cậy và khả năng thích ứng.","Chỉ sử dụng điện một chiều ($DC$)."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Khái niệm kĩ thuật điện bao gồm các hoạt động nào sau đây?","questionImage":null,"mappedType":"multiple-choice","options":["Sản xuất, truyền tải, phân phối và sử dụng điện.","Chỉ tập trung vào sản xuất và truyền tải điện năng.","Chủ yếu là thiết kế mạch điện tử và phần mềm.","Nghiên cứu về các phản ứng hóa học tạo ra năng lượng."],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Trong sản xuất công nghiệp hiện đại, vai trò chủ yếu của kĩ thuật điện là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Quản lí tài chính và tiếp thị sản phẩm.","Cung cấp năng lượng, điều khiển tự động hóa các dây chuyền sản xuất.","Nghiên cứu thị trường và hành vi người tiêu dùng.","Thiết kế kiến trúc cho các nhà máy và khu công nghiệp."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Vị trí của kĩ thuật điện trong đời sống hàng ngày được thể hiện rõ nhất qua hoạt động nào?","questionImage":null,"mappedType":"multiple-choice","options":["Phát triển các loại hình nghệ thuật mới.","Cung cấp điện năng cho chiếu sáng, thông tin liên lạc và các thiết bị gia dụng.","Xây dựng các công trình giao thông công cộng lớn.","Chế biến thực phẩm và sản xuất đồ uống."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Một trong những triển vọng phát triển quan trọng của ngành kĩ thuật điện, được nhắc đến trong chương trình, là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Tăng cường khai thác các nguồn năng lượng hóa thạch truyền thống.","Phát triển mạnh mẽ các nguồn năng lượng tái tạo.","Chuyển dịch hoàn toàn sang năng lượng hạt nhân.","Đẩy mạnh sản xuất điện từ than đá."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Ưu điểm chính của lưới điện thông minh (smart grid) so với lưới điện truyền thống là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Chỉ sử dụng các thiết bị cơ khí đơn giản, không cần công nghệ cao.","Khó khăn trong việc tích hợp các nguồn năng lượng phân tán.","Nâng cao độ tin cậy, hiệu quả và khả năng quản lí thông qua giám sát và điều khiển thời gian thực.","Yêu cầu sự can thiệp thủ công nhiều hơn trong vận hành."],"optionsImage":[],"correctAnswerIndex":2},{"type":"true-false","main_question":"Nhận định nào sau đây về các ngành nghề trong lĩnh vực kĩ thuật điện là đúng hay sai?","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Kĩ sư điện chỉ làm việc với các hệ thống điện dân dụng trong các hộ gia đình.","is_correct":false},{"statement":"Ngành kĩ thuật điện bao gồm việc thiết kế và giám sát thi công các hệ thống truyền tải và phân phối điện năng.","is_correct":true},{"statement":"Người làm nghề thợ điện cần có kiến thức vững chắc về an toàn điện và khả năng đọc bản vẽ kĩ thuật điện.","is_correct":true},{"statement":"Trong bối cảnh cách mạng công nghiệp 4.0, kĩ sư điện ngày càng cần có thêm kiến thức về trí tuệ nhân tạo (AI) và Internet vạn vật (IoT) để phát triển các hệ thống điện thông minh.","is_correct":true}]},{"type":"true-false","main_question":"Đánh giá các phát biểu sau về vai trò của từng ngành nghề trong lĩnh vực kĩ thuật điện.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Thợ điện có trách nhiệm trực tiếp lắp đặt và sửa chữa các thiết bị điện.","is_correct":true},{"statement":"Kĩ sư tự động hóa điện chủ yếu làm việc với các hệ thống điều khiển tự động trong các nhà máy sản xuất.","is_correct":true},{"statement":"Để đảm bảo an toàn, tất cả các công việc liên quan đến điện áp cao đều có thể được thực hiện bởi bất kì thợ điện nào có kinh nghiệm.","is_correct":false},{"statement":"Vai trò của kĩ sư thiết kế hệ thống điện chỉ giới hạn ở việc chọn lựa linh kiện mà không cần quan tâm đến hiệu quả năng lượng hay tác động môi trường của hệ thống.","is_correct":false}]},{"type":"true-false","main_question":"Phát biểu nào sau đây về yêu cầu kiến thức và kỹ năng trong các ngành nghề kĩ thuật điện là đúng hay sai?","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Các ngành nghề kĩ thuật điện thường yêu cầu người lao động có khả năng làm việc với các dụng cụ đo điện.","is_correct":true},{"statement":"Kĩ sư điện cần có kiến thức vững về vật lí và toán học để phân tích và giải quyết các bài toán về mạch điện.","is_correct":true},{"statement":"Để trở thành chuyên gia trong lĩnh vực điện tử công suất, người học chỉ cần nắm vững lí thuyết mà không cần thực hành lắp ráp mạch điện.","is_correct":false},{"statement":"Sự phát triển của xe điện và lưới điện thông minh đòi hỏi các kĩ sư điện ngày càng phải có kiến thức liên ngành về cơ khí, hóa học và công nghệ thông tin.","is_correct":true}]},{"type":"true-false","main_question":"Nhận định nào sau đây về các lĩnh vực chuyên môn và tầm ảnh hưởng của ngành kĩ thuật điện là đúng hay sai?","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Lĩnh vực kĩ thuật điện đóng vai trò quan trọng trong việc cung cấp điện cho đời sống và sản xuất.","is_correct":true},{"statement":"Kĩ thuật điện năng là một nhánh của kĩ thuật điện tập trung vào việc sản xuất, truyền tải và phân phối điện.","is_correct":true},{"statement":"Việc sử dụng năng lượng mặt trời và gió để sản xuất điện không thuộc phạm vi quan tâm của ngành kĩ thuật điện.","is_correct":false},{"statement":"Kĩ sư điện làm việc trong lĩnh vực vi điện tử (microelectronics) cần có hiểu biết sâu về vật liệu bán dẫn và quy trình chế tạo linh kiện ở cấp độ nanomet.","is_correct":true}]},{"type":"true-false","main_question":"Chọn câu đúng hoặc sai về những hiểu lầm phổ biến và xu hướng phát triển trong ngành kĩ thuật điện.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Chỉ nam giới mới có thể làm việc trong các ngành nghề kĩ thuật điện do tính chất công việc nặng nhọc.","is_correct":false},{"statement":"Ngành kĩ thuật điện hiện nay đang có xu hướng phát triển mạnh mẽ các giải pháp tiết kiệm năng lượng và hiệu quả năng lượng.","is_correct":true},{"statement":"Kĩ sư bảo trì điện tại các tòa nhà cao tầng không cần phải có kiến thức về hệ thống báo cháy hay camera giám sát.","is_correct":false},{"statement":"Để đạt được mục tiêu phát triển bền vững, ngành kĩ thuật điện đang dịch chuyển mạnh mẽ từ mô hình tập trung truyền thống sang các hệ thống phân tán, tự phục hồi với sự hỗ trợ của công nghệ số.","is_correct":true}]},{"type":"multiple-choice","question":"Dòng điện xoay chiều ba pha là hệ thống gồm ba dòng điện xoay chiều một pha có cùng biên độ, cùng tần số và lệch pha nhau một góc bao nhiêu?","questionImage":null,"mappedType":"multiple-choice","options":["$\\dfrac{\\pi}{3} \\text{ rad}$","$\\dfrac{\\pi}{2} \\text{ rad}$","$\\dfrac{2\\pi}{3} \\text{ rad}$","$\\pi \\text{ rad}$"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Trong mạch điện xoay chiều ba pha đối xứng, khi nguồn và tải được nối hình sao (Y), mối quan hệ giữa điện áp dây ($U_d$) và điện áp pha ($U_p$) là gì?","questionImage":null,"mappedType":"multiple-choice","options":["$U_d = U_p$","$U_d = \\sqrt{3} U_p$","$U_p = \\sqrt{3} U_d$","$U_d = 3 U_p$"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Trong mạch điện xoay chiều ba pha đối xứng, khi nguồn và tải được nối hình tam giác (Delta), mối quan hệ giữa dòng điện dây ($I_d$) và dòng điện pha ($I_p$) là gì?","questionImage":null,"mappedType":"multiple-choice","options":["$I_d = I_p$","$I_p = \\sqrt{3} I_d$","$I_d = 3 I_p$","$I_d = \\sqrt{3} I_p$"],"optionsImage":[],"correctAnswerIndex":3},{"type":"multiple-choice","question":"Sự lệch pha giữa các suất điện động trong máy phát điện xoay chiều ba pha đối xứng là bao nhiêu?","questionImage":null,"mappedType":"multiple-choice","options":["$90^{\\circ}$","$120^{\\circ}$","$180^{\\circ}$","$360^{\\circ}$"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Trong mạch điện xoay chiều ba pha đối xứng, khi nguồn và tải được nối hình sao, mối quan hệ giữa điện áp dây ($U_d$) và điện áp pha ($U_p$) là gì?","questionImage":null,"mappedType":"multiple-choice","options":["$U_d = U_p$","$U_d = \\sqrt{2} U_p$","$U_d = \\sqrt{3} U_p$","$U_d = 3 U_p$"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Hệ thống điện quốc gia của Việt Nam bao gồm những thành phần cơ bản nào?","questionImage":null,"mappedType":"multiple-choice","options":["Nguồn điện, lưới điện và tải tiêu thụ","Nguồn điện, trạm biến áp và nhà máy phát điện","Lưới điện, trạm phân phối và hộ gia đình","Máy biến áp, đường dây tải điện và phụ tải"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Trong hệ thống điện quốc gia, lưới điện có vai trò chính là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Sản xuất ra điện năng","Tiêu thụ điện năng","Truyền tải và phân phối điện năng từ nơi sản xuất đến nơi tiêu thụ","Điều khiển toàn bộ hệ thống điện"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Điện áp $500\text{kV}$ thuộc cấp điện áp nào trong hệ thống điện quốc gia Việt Nam?","questionImage":null,"mappedType":"multiple-choice","options":["Hạ áp","Trung áp","Cao áp","Siêu cao áp"],"optionsImage":[],"correctAnswerIndex":3},{"type":"multiple-choice","question":"Cấu trúc chung của hệ thống điện quốc gia bao gồm những thành phần chính nào?","questionImage":null,"mappedType":"multiple-choice","options":["Nguồn điện, lưới điện, tải tiêu thụ.","Nguồn điện, nhà máy điện, trạm biến áp.","Lưới điện, đường dây truyền tải, hộ gia đình.","Nguồn điện, công tơ điện, tải tiêu thụ."],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Vai trò chính của lưới điện truyền tải trong hệ thống điện quốc gia là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Biến đổi điện năng thành các dạng năng lượng khác để sử dụng.","Phát điện năng từ các nhà máy điện.","Truyền tải điện năng từ các nhà máy điện đến các trung tâm phụ tải lớn.","Phân phối điện năng đến các hộ tiêu thụ cuối cùng."],"optionsImage":[],"correctAnswerIndex":2},{"type":"true-false","main_question":"Phát biểu nào sau đây về sản xuất điện năng bằng nhiệt điện là đúng?","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Nhiệt điện sử dụng nhiên liệu hóa thạch như than đá, dầu mỏ, khí đốt để đun nóng nước tạo hơi nước làm quay tuabin phát điện.","is_correct":true},{"statement":"Ưu điểm chính của nhiệt điện là khả năng hoạt động ổn định, liên tục và không phụ thuộc nhiều vào yếu tố thời tiết như các nguồn năng lượng tái tạo.","is_correct":true},{"statement":"Một trong những hạn chế lớn nhất của nhiệt điện là không thể xây dựng gần các trung tâm phụ tải điện lớn, gây khó khăn trong việc truyền tải.","is_correct":false},{"statement":"Để giảm thiểu ô nhiễm môi trường từ nhà máy nhiệt điện, các công nghệ thu giữ carbon (Carbon Capture and Storage - CCS) đã được áp dụng rộng rãi và chứng minh hiệu quả kinh tế cao trên toàn cầu.","is_correct":false}]},{"type":"true-false","main_question":"Phát biểu nào sau đây về sản xuất điện năng bằng thủy điện là đúng?","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Thủy điện khai thác năng lượng của dòng nước chảy từ trên cao xuống thấp để làm quay tuabin phát điện.","is_correct":true},{"statement":"Thủy điện là nguồn năng lượng tái tạo, không thải khí gây hiệu ứng nhà kính trong quá trình vận hành, góp phần bảo vệ môi trường.","is_correct":true},{"statement":"Chi phí xây dựng nhà máy thủy điện thường thấp hơn đáng kể so với các nhà máy nhiệt điện có cùng công suất, do không cần công nghệ xử lý nhiên liệu phức tạp.","is_correct":false},{"statement":"Một trong những thách thức lớn nhất của thủy điện là khả năng gây ra lũ lụt nghiêm trọng ở vùng hạ lưu do việc xả lũ đột ngột từ hồ chứa.","is_correct":false}]},{"type":"true-false","main_question":"Phát biểu nào sau đây về sản xuất điện năng bằng điện hạt nhân là đúng?","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Điện hạt nhân sử dụng phản ứng phân hạch của các nguyên tố phóng xạ như Urani để tạo ra nhiệt đun nóng nước, làm quay tuabin phát điện.","is_correct":true},{"statement":"Lượng chất thải phóng xạ từ nhà máy điện hạt nhân rất lớn và cần phải được lưu trữ an toàn trong thời gian rất dài, gây ra thách thức lớn về quản lý môi trường.","is_correct":true},{"statement":"Điện hạt nhân là phương pháp sản xuất điện năng có chi phí vận hành cao nhất do yêu cầu về an ninh, an toàn và xử lý chất thải đặc biệt.","is_correct":false},{"statement":"Mặc dù có rủi ro về sự cố, nhưng các hệ thống an toàn hiện đại của nhà máy điện hạt nhân hoàn toàn loại bỏ khả năng xảy ra các thảm họa quy mô lớn như Chernobyl hay Fukushima.","is_correct":false}]},{"type":"true-false","main_question":"Phát biểu nào sau đây về sản xuất điện năng từ năng lượng tái tạo (điện gió, điện mặt trời) là đúng?","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Điện mặt trời chuyển đổi trực tiếp năng lượng ánh sáng mặt trời thành điện năng thông qua các tấm pin quang điện.","is_correct":true},{"statement":"Điện gió và điện mặt trời đều là các nguồn năng lượng sạch, không thải ra khí nhà kính trong quá trình vận hành, góp phần giảm thiểu biến đổi khí hậu.","is_correct":true},{"statement":"Nhược điểm chung của điện gió và điện mặt trời là phụ thuộc nhiều vào điều kiện tự nhiên (gió, nắng), dẫn đến tính không ổn định và khó khăn trong việc cung cấp điện liên tục.","is_correct":true},{"statement":"Công nghệ lưu trữ điện năng quy mô lớn (như pin lithium-ion) hiện nay đã đủ tiên tiến và có chi phí hiệu quả để giải quyết hoàn toàn vấn đề không ổn định của điện gió và điện mặt trời, giúp chúng có thể thay thế hoàn toàn các nguồn điện truyền thống.","is_correct":false}]},{"type":"true-false","main_question":"Phát biểu nào sau đây về các phương pháp sản xuất điện năng ở Việt Nam là đúng?","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Việt Nam có tiềm năng lớn về thủy điện và nhiệt điện than, đây là hai nguồn cung cấp điện năng chủ yếu cho hệ thống điện quốc gia hiện nay.","is_correct":true},{"statement":"Điện gió và điện mặt trời là hai nguồn năng lượng tái tạo đang được chú trọng phát triển mạnh mẽ ở Việt Nam nhằm đa dạng hóa cơ cấu nguồn điện và giảm phát thải.","is_correct":true},{"statement":"Do đặc điểm địa lý và nguồn tài nguyên, Việt Nam không có tiềm năng phát triển điện mặt trời quy mô lớn, chỉ phù hợp với các hệ thống điện mặt trời mái nhà nhỏ lẻ.","is_correct":false},{"statement":"Điện hạt nhân là phương án tối ưu nhất cho Việt Nam trong bối cảnh hiện tại để đảm bảo an ninh năng lượng và đạt mục tiêu phát thải ròng bằng không vào năm $2050$.","is_correct":false}]},{"type":"multiple-choice","question":"Cấu trúc chung của mạng điện sản xuất quy mô nhỏ thường bao gồm những phần nào?","questionImage":null,"mappedType":"multiple-choice","options":["Nguồn điện, đường dây tải điện, thiết bị đóng cắt, thiết bị bảo vệ.","Máy phát điện, trạm biến áp, đường dây truyền tải cao thế.","Hệ thống đèn chiếu sáng, quạt thông gió.","Máy tính điều khiển trung tâm và các cảm biến."],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Trong mạng điện sản xuất quy mô nhỏ, thiết bị nào có vai trò chính là bảo vệ mạch điện và các thiết bị điện khỏi quá tải hoặc ngắn mạch?","questionImage":null,"mappedType":"multiple-choice","options":["Máy biến áp.","Cầu dao tự động (Aptomat).","Đồng hồ đo điện.","Ổ cắm điện."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Để phân phối điện năng đến các tải tiêu thụ trong mạng điện sản xuất quy mô nhỏ, người ta thường sử dụng thiết bị nào sau đây?","questionImage":null,"mappedType":"multiple-choice","options":["Công tơ điện.","Bảng phân phối điện (Tủ điện tổng).","Máy cắt không khí (ACB).","Rơle nhiệt."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Trong mạng điện sản xuất quy mô nhỏ, trình tự kết nối các thành phần cơ bản từ nguồn điện lưới đến các thiết bị tiêu thụ điện thường là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Thiết bị tiêu thụ \b\to\b Tủ phân phối \b\to\b Át tô mát \b\to\b Công tơ điện","Công tơ điện \b\to\b Át tô mát tổng \b\to\b Tủ phân phối \b\to\b Thiết bị tiêu thụ","Át tô mát tổng \b\to\b Công tơ điện \b\to\b Tủ phân phối \b\to\b Thiết bị tiêu thụ","Tủ phân phối \b\to\b Công tơ điện \b\to\b Át tô mát tổng \b\to\b Thiết bị tiêu thụ"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Át tô mát tổng (CB tổng) trong mạng điện sản xuất quy mô nhỏ có vai trò quan trọng nhất là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Đo lường điện năng tiêu thụ của toàn bộ mạng","Bảo vệ mạch điện chính khỏi quá tải và ngắn mạch","Điều chỉnh điện áp cung cấp cho các thiết bị","Cải thiện hệ số công suất của mạng điện"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Tủ phân phối điện (DB - Distribution Board) trong mạng điện sản xuất quy mô nhỏ được sử dụng với mục đích chính nào?","questionImage":null,"mappedType":"multiple-choice","options":["Tăng cường độ sáng của hệ thống chiếu sáng","Phân chia và điều khiển nguồn điện đến các khu vực hoặc nhóm thiết bị khác nhau","Chuyển đổi dòng điện xoay chiều thành dòng điện một chiều","Lưu trữ năng lượng điện dự phòng"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Để đảm bảo an toàn và cho phép điều khiển độc lập từng máy móc hoặc nhóm máy móc trong một mạng điện sản xuất quy mô nhỏ, thiết bị nào thường được lắp đặt cho mỗi tải riêng lẻ?","questionImage":null,"mappedType":"multiple-choice","options":["Biến áp","Tụ bù","Át tô mát nhánh (MCB)","Máy phát điện"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Tại sao việc thực hiện nối đất cho các vỏ thiết bị điện bằng kim loại là hết sức cần thiết trong mạng điện sản xuất quy mô nhỏ?","questionImage":null,"mappedType":"multiple-choice","options":["Để giảm thiểu tổn thất năng lượng điện trong quá trình truyền tải","Để cân bằng pha và cải thiện chất lượng điện áp","Để bảo vệ người sử dụng khỏi nguy cơ bị điện giật khi có sự cố rò điện","Để tăng cường tính thẩm mỹ của hệ thống điện"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Ở Việt Nam, điện áp định mức của mạng điện hạ áp dùng trong sinh hoạt là bao nhiêu?","questionImage":null,"mappedType":"multiple-choice","options":["$110 \\text{ V}$","$220 \\text{ V}$","$380 \\text{ V}$","$500 \\text{ V}$"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Tần số của dòng điện xoay chiều trong mạng điện hạ áp dùng trong sinh hoạt ở Việt Nam là bao nhiêu?","questionImage":null,"mappedType":"multiple-choice","options":["$50 \\text{ Hz}$","$60 \\text{ Hz}$","$100 \\text{ Hz}$","$40 \\text{ Hz}$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Mạng điện hạ áp một pha dùng trong sinh hoạt thường sử dụng bao nhiêu dây dẫn để tải điện từ lưới điện đến hộ gia đình?","questionImage":null,"mappedType":"multiple-choice","options":["Một dây","Hai dây","Ba dây","Bốn dây"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Dây trung tính (dây $N$) trong mạng điện hạ áp sinh hoạt có chức năng chủ yếu là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Dẫn điện áp cao đến tải tiêu thụ","Tạo ra điện áp $380 \\text{ V}$","Tạo đường về cho dòng điện và duy trì điện áp an toàn cho vỏ thiết bị khi có sự cố","Truyền tín hiệu điều khiển"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Thiết bị nào sau đây có chức năng bảo vệ mạng điện hạ áp sinh hoạt khỏi sự cố quá tải và ngắn mạch?","questionImage":null,"mappedType":"multiple-choice","options":["Đồng hồ đo điện","Công tắc","Ổ cắm điện","Cầu chì hoặc aptomat"],"optionsImage":[],"correctAnswerIndex":3},{"type":"multiple-choice","question":"Trong mạng điện hạ áp dùng trong sinh hoạt, những thành phần cơ bản nào là cần thiết để đảm bảo hệ thống hoạt động đúng chức năng?","questionImage":null,"mappedType":"multiple-choice","options":["Chỉ gồm nguồn điện và các thiết bị tiêu thụ điện.","Bao gồm nguồn điện, các thiết bị đóng cắt, bảo vệ và các thiết bị sử dụng điện.","Chỉ cần nguồn điện, dây dẫn và các ổ cắm điện.","Bao gồm nguồn điện, dây dẫn, phụ tải, thiết bị đóng cắt, thiết bị bảo vệ và điều khiển."],"optionsImage":[],"correctAnswerIndex":3},{"type":"multiple-choice","question":"Tại Việt Nam, mạng điện hạ áp một pha dùng trong sinh hoạt thường có các thông số kĩ thuật cơ bản về điện áp và tần số danh định là bao nhiêu?","questionImage":null,"mappedType":"multiple-choice","options":["Điện áp $220\\,\\text{V}$, tần số $50\\,\\text{Hz}$.","Điện áp $380\\,\\text{V}$, tần số $50\\,\\text{Hz}$.","Điện áp $220\\,\\text{V}$, tần số $60\\,\\text{Hz}$.","Điện áp $110\\,\\text{V}$, tần số $50\\,\\text{Hz}$."],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Khi thiết kế hoặc vận hành mạng điện hạ áp dùng trong sinh hoạt, việc lắp đặt aptomat (cầu dao tự động) có mục đích chính là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Điều chỉnh điện áp phù hợp với từng thiết bị điện.","Giới hạn công suất tiêu thụ của toàn bộ ngôi nhà.","Tự động ngắt mạch điện khi xảy ra quá tải hoặc ngắn mạch để bảo vệ an toàn cho hệ thống và người sử dụng.","Chuyển đổi dòng điện một chiều thành dòng điện xoay chiều."],"optionsImage":[],"correctAnswerIndex":2}];
            const quizOptions = {"timeLimit":60,"retriesAllowed":100,"showAnswers":true,"showExplanation":true,"aiAssessment":true,"scoring":{"mc":5,"tf":2,"sa":2,"essay":1,"tfMethod":"even"}};
            const googleScriptUrl = "https://script.google.com/macros/s/AKfycbwFrgRsOYyp5I4KnPDffimwrwMXH_c5bpxjxqUDnqxqnjoQHV8mUoUZfAwGfWY9CgYf/exec";
            const correctExamCode = "OJ7WO7";
            const teacherApiKey = "AIzaSyDTFy_GnA8GaPaZNP2avwinsBnrDB7hcRw";
            let studentInfo = {};
            let isSubmitted = false;
            let timerInterval;
            let retriesLeft = quizOptions.retriesAllowed;
            let studentApiKey = "";
            let ai = null;

            let proctoringLog = {
                thoatManHinh: 0,
                saoChep: 0,
                dan: 0,
                suKien: []
            };

            const studentQuizContainer = document.getElementById('student-quiz-container');
            const submitBtn = document.getElementById('submit-quiz-btn');
            const resultContainer = document.getElementById('result-container');
            const postSubmitOptions = document.getElementById('post-submit-options');
            const retryBtn = document.getElementById('retry-quiz-btn');
            const loginModal = document.getElementById('login-modal');
            const studentInfoForm = document.getElementById('student-info-form');
            const timerDisplay = document.getElementById('timer-display');
            const retriesDisplay = document.getElementById('retries-display');

            function formatAIText(text) {
                if (!text) return '';
                let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                formattedText = formattedText.replace(/\n/g, '<br>');
                return formattedText;
            }

            function shuffleQuiz() {
                // Shuffle options/statements within each question first
                quizData.forEach(item => {
                    // Shuffle multiple-choice options and their corresponding images
                    if (item.mappedType === 'multiple-choice' && item.options && item.options.length > 0) {
                        const correctAnswerText = item.options[item.correctAnswerIndex];
                        let optionsWithImages = item.options.map((opt, index) => ({
                            text: opt,
                            image: (item.optionsImage && item.optionsImage[index]) ? item.optionsImage[index] : null
                        }));
                        // Fisher-Yates shuffle
                        for (let i = optionsWithImages.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [optionsWithImages[i], optionsWithImages[j]] = [optionsWithImages[j], optionsWithImages[i]];
                        }
                        // Update the item with shuffled data
                        item.options = optionsWithImages.map(opt => opt.text);
                        item.optionsImage = optionsWithImages.map(opt => opt.image);
                        item.correctAnswerIndex = item.options.indexOf(correctAnswerText);
                    }
                    // Shuffle true-false statements
                    if (item.mappedType === 'true-false' && item.statements && item.statements.length > 0) {
                         for (let i = item.statements.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [item.statements[i], item.statements[j]] = [item.statements[j], item.statements[i]];
                        }
                    }
                });
                // Then, group questions by type and shuffle within each group
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});
                let shuffledQuizData = [];
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    if (grouped[partType]) {
                        const partQuestions = grouped[partType];
                        for (let i = partQuestions.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [partQuestions[i], partQuestions[j]] = [partQuestions[j], partQuestions[i]];
                        }
                        shuffledQuizData = shuffledQuizData.concat(partQuestions);
                    }
                });
               
                quizData = shuffledQuizData;
            }
            // --- Timer Function ---
            function startTimer(duration, display) {
                let timer = duration, minutes, seconds;
                clearInterval(timerInterval); // Clear any existing timer
                if(duration <= 0) {
                     display.textContent = "∞";
                     return;
                }
                timerInterval = setInterval(function () {
                    minutes = parseInt(timer / 60, 10);
                    seconds = parseInt(timer % 60, 10);
                    minutes = minutes < 10 ? "0" + minutes : minutes;
                    seconds = seconds < 10 ? "0" + seconds : seconds;
                    display.textContent = minutes + ":" + seconds;
                    if (--timer < 0) {
                        clearInterval(timerInterval);
                        alert("Hết giờ làm bài!");
                        handleSubmit();
                    }
                }, 1000);
            }
            
            async function showExplanation(index, button) {
                const item = quizData[index];
                const questionCard = document.getElementById(`student-q-${index}`);
                const feedbackDiv = document.getElementById(`q-${index}-feedback`);
                if (!questionCard || !feedbackDiv) return;

                const existingExplanation = feedbackDiv.querySelector('.ai-explanation');
                if (existingExplanation) {
                    existingExplanation.remove();
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Xem giải thích
                    `;
                    return;
                }

                button.disabled = true;
                button.innerHTML = '<div class="loader mr-2"></div> Đang tải...';

                if (item.explanation) {
                    displayExplanation(item.explanation, feedbackDiv, button);
                    return;
                }

                if (!ai) {
                    alert("Tính năng giải thích yêu cầu API Key, nhưng chưa được cấu hình bởi giáo viên.");
                    button.disabled = false;
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Xem giải thích
                    `;
                    return;
                }

                const questionText = item.question || item.main_question;
                let prompt = `Bạn là một trợ lý giáo viên AI, am hiểu sâu sắc Chương trình GDPT 2018. Hãy cung cấp một lời giải chi tiết, từng bước một cho câu hỏi sau đây. Lời giải phải chính xác, dễ hiểu và phù hợp với phương pháp giảng dạy của chương trình học, TUYỆT ĐỐI KHÔNG sử dụng kiến thức của lớp cao hơn để giải thích.\n\n--- CÂU HỎI ---\n${questionText}\n\n`;
                if (item.mappedType === 'multiple-choice') {
                    prompt += `--- CÁC LỰA CHỌN ---\n${item.options.map((opt, i) => `${String.fromCharCode(65 + i)}. ${opt}`).join('\n')}\n\n`;
                    prompt += `--- ĐÁP ÁN ĐÚNG ---\n${String.fromCharCode(65 + item.correctAnswerIndex)}. ${item.options[item.correctAnswerIndex]}`;
                } else if (item.mappedType === 'true-false') {
                    prompt += `--- CÁC MỆNH ĐỀ & ĐÁP ÁN ---\n${item.statements.map(s => ` - ${s.statement} -> ${s.is_correct ? 'Đúng' : 'Sai'}`).join('\n')}`;
                } else {
                    prompt += `--- ĐÁP ÁN / GỢI Ý ---\n${item.answer}`;
                }
                prompt += `\n\n--- YÊU CẦU ---\nGiải thích rõ ràng tại sao đáp án lại đúng, từng bước một. Dùng **...** để in đậm các thuật ngữ quan trọng. Định dạng tất cả các công thức toán học bằng LaTeX.`;

                try {
                    const response = await ai.models.generateContent({ model: "gemini-2.5-flash", contents: prompt });
                    const explanationText = response.text; // Keep it raw
                    item.explanation = explanationText; // Cache it
                    displayExplanation(explanationText, feedbackDiv, button);
                } catch (error) {
                    console.error("Lỗi khi tạo giải thích:", error);
                    feedbackDiv.insertAdjacentHTML('beforeend', '<div class="ai-explanation text-red-600">Lỗi: Không thể tạo giải thích.</div>');
                    button.disabled = false;
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Thử lại
                    `;
                }
            }

            function displayExplanation(explanationText, container, button) {
                container.insertAdjacentHTML('beforeend', `<div class="ai-explanation prose prose-sm">${formatAIText(explanationText)}</div>`);
                if (window.MathJax) MathJax.typesetPromise([container]);
                button.disabled = false;
                button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    Ẩn giải thích
                `;
            }
           
            function renderStudentQuiz() {
                studentQuizContainer.innerHTML = '';
               
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});
                const groupInfo = {
                    'multiple-choice': { title: 'PHẦN I. TRẮC NGHIỆM KHÁCH QUAN', subtitle: 'Chọn đáp án đúng nhất trong các lựa chọn sau.' },
                    'true-false': { title: 'PHẦN II. CÂU HỎI ĐÚNG - SAI', subtitle: 'Xác định tính đúng hoặc sai cho mỗi mệnh đề dưới đây.' },
                    'short-answer': { title: 'PHẦN III. CÂU HỎI TRẢ LỜI NGẮN', subtitle: 'Điền đáp án ngắn gọn vào phần trả lời.' },
                    'essay': { title: 'PHẦN IV. CÂU HỎI TỰ LUẬN', subtitle: 'Trình bày chi tiết bài giải của bạn.' }
                };
               
                let questionCounter = 0;
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    const questions = grouped[partType];
                    if (!questions || questions.length === 0) return;
                   
                    let groupHTML = `<div class="group-container space-y-8 mb-12">`;
                    const info = groupInfo[partType];
                    groupHTML += `
                        <div class="group-header pb-3 border-b-2 border-slate-300 mb-6">
                            <h2 class="text-2xl font-bold text-slate-800">${info.title}</h2>
                            ${info.subtitle ? `<p class="text-md text-slate-600 italic mt-1">${info.subtitle}</p>` : ''}
                        </div>
                    `;
                    questions.forEach((item, localIndex) => {
                        const globalIndex = quizData.indexOf(item);
                        questionCounter++;
                        groupHTML += `<div class="question-card" id="student-q-${globalIndex}">`;
                        let questionText = (item.question || item.main_question || '').replace(/\n/g, '<br>');
                       
                        groupHTML += `<div class="flex items-start">
                                     <div class="flex-grow">
                                         <div class="flex items-center mb-2">
                                             <span class="font-bold text-lg mr-3 text-indigo-600">Câu ${questionCounter}:</span>
                                             <div id="q-${globalIndex}-feedback-icon"></div>
                                         </div>
                                         <div class="question-content mt-2 text-lg text-slate-700">${questionText}</div>
                                         ${item.questionImage ? `<img src="${item.questionImage}" class="mt-4 rounded-lg max-w-full md:max-w-md border shadow-sm">` : ''}
                                     </div>
                                 </div>`;
                       
                        groupHTML += `<div class="mt-6">`;
                        switch(item.mappedType) {
                            case 'multiple-choice':
                                groupHTML += `<div class="options-grid grid grid-cols-1 md:grid-cols-2 gap-4">`;
                                item.options.forEach((opt, i) => {
                                    groupHTML += `<label for="q${globalIndex}-opt${i}" id="q${globalIndex}-opt-label${i}" class="option-label flex items-start p-4 border-2 rounded-xl cursor-pointer hover:bg-indigo-50 hover:border-indigo-400">
                                                     <input type="radio" name="q${globalIndex}" id="q${globalIndex}-opt${i}" value="${i}" class="flex-shrink-0 mt-1 h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                                     <div class="ml-3 flex-grow">
                                                         <span class="font-semibold text-slate-800">${String.fromCharCode(65 + i)}.</span>
                                                         <span class="option-content text-slate-700">${opt || ''}</span>
                                                         ${(item.optionsImage && item.optionsImage[i]) ? `<img src="${item.optionsImage[i]}" class="mt-2 rounded-lg max-w-xs border shadow-sm">` : ''}
                                                     </div>
                                                 </label>`;
                                });
                                groupHTML += `</div>`;
                                break;
                            case 'true-false':
                                 groupHTML += `<div class="space-y-4">`;
                                 item.statements.forEach((s, i) => {
                                     groupHTML += `<div class="statement-item border-t pt-4">
                                                  <p class="mb-3 text-slate-700">${String.fromCharCode(97 + i)}) ${s.statement || ''}</p>
                                                  <div class="flex gap-x-6">
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="true" class="mr-2 h-4 w-4"> Đúng</label>
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="false" class="mr-2 h-4 w-4"> Sai</label>
                                                  </div>
                                              </div>`;
                                 });
                                 groupHTML += `</div>`;
                                 break;
                            case 'short-answer':
                                groupHTML += `<input type="text" name="q${globalIndex}" class="mt-1 block w-full md:w-1/2 border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Nhập đáp án của bạn...">`;
                                break;
                            case 'essay':
                                groupHTML += `<textarea name="q${globalIndex}" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" rows="5" placeholder="Nhập câu trả lời tự luận của bạn..."></textarea>`;
                                break;
                        }
                        groupHTML += `</div><div id="q-${globalIndex}-feedback" class="mt-4"></div></div>`;
                    });
                    groupHTML += `</div>`;
                    studentQuizContainer.innerHTML += groupHTML;
                });
               
                if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                    MathJax.typesetPromise([studentQuizContainer]);
                }
            }
           
            async function generatePerformanceReview(allAnswersData) {
                const feedbackContainer = document.getElementById('ai-feedback-container');
                if (!feedbackContainer || !ai) return null;
                feedbackContainer.classList.remove('hidden');
                feedbackContainer.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-slate-800 mb-4">📝 Phân Tích & Gợi Ý Từ Trợ Lý AI</h3>
                        <div id="ai-feedback-loader" class="text-center py-6">
                            <svg class="animate-spin mx-auto h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p class="mt-3 text-slate-600">AI đang phân tích bài làm của bạn...</p>
                        </div>
                        <div id="ai-feedback-summary" class="hidden prose prose-sm max-w-none"></div>
                        <div id="ai-feedback-details" class="hidden mt-4 space-y-2"></div>
                    </div>
                `;
               
                const loader = document.getElementById('ai-feedback-loader');
                const summaryDiv = document.getElementById('ai-feedback-summary');
                const detailsDiv = document.getElementById('ai-feedback-details');
                const incorrectAnswers = allAnswersData.filter(a => !a.isCorrect);
                if (incorrectAnswers.length === 0) {
                    feedbackContainer.innerHTML = `
                        <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                            <h3 class="text-xl font-bold text-green-600">🎉 Chúc mừng!</h3>
                            <p class="mt-2 text-slate-700">Bạn đã trả lời đúng tất cả các câu hỏi. Làm tốt lắm!</p>
                        </div>
                    `;
                    return { overallFeedback: { summary: "Xuất sắc! Học sinh đã đã trả lời đúng tất cả các câu hỏi." } };
                }
                const summaryPrompt = `Bạn là một trợ lý giáo viên, nói tiếng Việt. Dựa vào tóm tắt các câu trả lời sai của học sinh, hãy đưa ra một nhận xét tổng quan ngắn gọn (khoảng 3-4 câu) về năng lực của học sinh, bao gồm điểm mạnh (suy luận từ các câu làm đúng), điểm yếu (dựa trên các câu sai) và một vài gợi ý ôn tập chung. Lời văn phải khích lệ, rõ ràng. Dùng **...** để in đậm các thuật ngữ quan trọng.
                Tóm tắt lỗi sai:
                ${JSON.stringify(incorrectAnswers.map(a => ({ cau: a.questionNumber, loai: a.type, cauHoi: a.question.substring(0, 50) + '...' })), null, 2)}`;
                try {
                    const response = await ai.models.generateContent({
                        model: "gemini-2.5-flash",
                        contents: summaryPrompt
                    });
                    summaryDiv.innerHTML = formatAIText(response.text);
                    loader.classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                    detailsDiv.classList.remove('hidden'); 
                } catch (e) {
                    console.error("Lỗi khi lấy nhận xét tổng quan:", e);
                    summaryDiv.innerHTML = '<p class="text-red-600">Lỗi khi tạo nhận xét tổng quan.</p>';
                    loader.classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                }
               
                const summaryForSheet = summaryDiv.innerText.substring(0, 200) + "...";
                return { overallFeedback: { summary: summaryForSheet } };
            }
            async function handleSubmit() {
                if (isSubmitted) return;
                isSubmitted = true;
                clearInterval(timerInterval);
                
                document.querySelectorAll('input, textarea').forEach(input => input.disabled = true);
                submitBtn.classList.add('hidden');
                postSubmitOptions.classList.remove('hidden');
                if (retriesLeft > 0) {
                    retryBtn.classList.remove('hidden');
                } else {
                    retryBtn.classList.add('hidden');
                }

                const proctoringDataString = JSON.stringify(proctoringLog);

                let totalStudentScore = 0;
                let totalCorrectAnswers = 0;
                let allAnswersData = [];
                const questionCounts = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    acc[type] = (acc[type] || 0) + 1;
                    return acc;
                }, {});
                
                quizData.forEach((item, index) => {
                    let questionNumber = index + 1;
                    let answerData = { questionNumber, type: item.type };
                    switch (item.mappedType) {
                        case 'multiple-choice':
                            const selectedOption = document.querySelector(`input[name="q${index}"]:checked`);
                            const isCorrectMC = selectedOption ? parseInt(selectedOption.value) === item.correctAnswerIndex : false;
                            if (isCorrectMC) {
                                totalCorrectAnswers++;
                                if (questionCounts['multiple-choice'] > 0) {
                                   totalStudentScore += quizOptions.scoring.mc / questionCounts['multiple-choice'];
                                }
                            }
                            answerData.question = item.question;
                            answerData.options = item.options;
                            answerData.yourAnswer = selectedOption ? String.fromCharCode(65 + parseInt(selectedOption.value)) : "Không trả lời";
                            answerData.correctAnswer = String.fromCharCode(65 + item.correctAnswerIndex);
                            answerData.isCorrect = isCorrectMC;
                            break;
                        case 'true-false':
                            let correctStatementsCount = 0;
                            let yourAnswerPattern = [];
                            let correctAnswerPattern = [];
                            let details = [];
                            item.statements.forEach((s, i) => {
                                const selectedTF = document.querySelector(`input[name="q${index}-s${i}"]:checked`);
                                const studentChoice = selectedTF ? selectedTF.value === 'true' : null;
                                const isStatementCorrect = studentChoice === s.is_correct;
                               
                                if (isStatementCorrect) correctStatementsCount++;
                               
                                yourAnswerPattern.push(studentChoice === null ? '?' : (studentChoice ? 'Đ' : 'S'));
                                correctAnswerPattern.push(s.is_correct ? 'Đ' : 'S');
                                details.push({ statement: s.statement, yourChoice: studentChoice === null ? 'Không trả lời' : (studentChoice ? 'Đúng' : 'Sai'), correctChoice: s.is_correct ? 'Đúng' : 'Sai', isCorrect: isStatementCorrect });
                            });
                            
                            let scorePerTfQuestion = 0;
                            if (questionCounts['true-false'] > 0) {
                                scorePerTfQuestion = quizOptions.scoring.tf / questionCounts['true-false'];
                            }
                            let questionPoints = 0;
                            if (quizOptions.scoring.tfMethod === 'progressive') {
                                const progressivePoints = { 0: 0, 1: 0.1, 2: 0.25, 3: 0.5, 4: 1.0 };
                                questionPoints = progressivePoints[correctStatementsCount] * scorePerTfQuestion;
                            } else { // even
                                questionPoints = (correctStatementsCount / 4) * scorePerTfQuestion;
                            }
                            totalStudentScore += questionPoints;

                            if(correctStatementsCount === 4) totalCorrectAnswers++;
                            answerData.question = item.main_question;
                            answerData.yourAnswer = yourAnswerPattern.join('-');
                            answerData.correctAnswer = correctAnswerPattern.join('-');
                            answerData.isCorrect = correctStatementsCount === 4;
                            answerData.details = details;
                            break;
                       
                        case 'short-answer':
                            const saInput = document.querySelector(`input[name="q${index}"]`);
                            const studentAnswerRaw = saInput ? (saInput.value ?? '').trim() : "";
                            const correctAnswerRaw = (item.answer ?? '').toString().trim().replace(/\$/g, '');
                            let isCorrectSA = false;
                            const studentAnswerNormalized = studentAnswerRaw.replace(',', '.');
                            const correctAnswerNormalized = correctAnswerRaw.replace(',', '.');
                            if (studentAnswerNormalized.toLowerCase() === correctAnswerNormalized.toLowerCase()) {
                                isCorrectSA = true;
                            }
                             if (isCorrectSA) {
                                totalCorrectAnswers++;
                                if (questionCounts['short-answer'] > 0) {
                                   totalStudentScore += quizOptions.scoring.sa / questionCounts['short-answer'];
                                }
                            }
                            answerData.question = item.question;
                            answerData.yourAnswer = studentAnswerRaw || "Không trả lời";
                            answerData.correctAnswer = correctAnswerRaw;
                            answerData.isCorrect = isCorrectSA;
                            break;
                           
                        case 'essay':
                             const essayInput = document.querySelector(`textarea[name="q${index}"]`);
                             answerData.question = item.question;
                             answerData.yourAnswer = essayInput.value || "Không trả lời";
                             answerData.correctAnswer = item.answer;
                             answerData.isCorrect = null; // Needs manual grading
                             break;
                    }
                    allAnswersData.push(answerData);
                });
                
                const finalScore = totalStudentScore;
                
                let competencyAssessment = "Giáo viên không yêu cầu AI phân tích bài làm.";
                if (quizOptions.aiAssessment) {
                    const feedbackData = await generatePerformanceReview(allAnswersData);
                    if (feedbackData && feedbackData.overallFeedback && feedbackData.overallFeedback.summary) {
                        competencyAssessment = feedbackData.overallFeedback.summary;
                    } else {
                        competencyAssessment = "Có lỗi xảy ra trong quá trình AI phân tích bài làm.";
                    }
                }
                
                if (quizOptions.showAnswers) {
                    const totalQuestions = quizData.length;
                    resultContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg text-center">
                        <h3 class="text-2xl font-bold text-slate-800">KẾT QUẢ BÀI LÀM</h3>
                        <p class="mt-4 text-lg">Số câu đúng hoàn toàn: <span class="font-bold text-green-600">${totalCorrectAnswers}/${totalQuestions}</span></p>
                        <p class="text-2xl mt-2">Điểm (thang 10): <span class="font-bold text-blue-600">${finalScore.toFixed(2)}</span></p>
                        ${questionCounts['essay'] > 0 ? `<p class="text-sm text-gray-600 italic mt-1">Lưu ý: Điểm trên chưa bao gồm ${quizOptions.scoring.essay} điểm của phần Tự luận.</p>` : ''}
                    </div>`;
                    resultContainer.classList.remove('hidden');

                    allAnswersData.forEach((ans, index) => {
                        const questionCard = document.getElementById(`student-q-${index}`);
                        const feedbackIconDiv = document.getElementById(`q-${index}-feedback-icon`);
                        const feedbackDiv = document.getElementById(`q-${index}-feedback`);
                        if (!questionCard || !feedbackIconDiv || !feedbackDiv) return;

                        const iconHTML = ans.isCorrect === true
                            ? '<svg class="feedback-icon text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>'
                            : (ans.isCorrect === false ? '<svg class="feedback-icon text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>' : '');
                        feedbackIconDiv.innerHTML = iconHTML;

                        if (ans.type.includes('multiple-choice')) {
                            const studentChoice = ans.yourAnswer === "Không trả lời" ? -1 : ans.yourAnswer.charCodeAt(0) - 65;
                            const correctChoice = ans.correctAnswer.charCodeAt(0) - 65;
                            document.getElementById(`q-${index}-opt-label${correctChoice}`)?.classList.add('correct');
                            if (studentChoice !== -1 && studentChoice !== correctChoice) {
                                document.getElementById(`q-${index}-opt-label${studentChoice}`)?.classList.add('incorrect');
                            }
                        } else if (ans.type === 'true-false') {
                            const statementItems = questionCard.querySelectorAll('.statement-item');
                            ans.details.forEach((detail, i) => { if(statementItems[i]) { statementItems[i].classList.add(detail.isCorrect ? 'correct' : 'incorrect'); }});
                        }

                        if (quizOptions.showExplanation) {
                            feedbackDiv.innerHTML = `<button data-explain-index="${index}" class="explain-btn mt-4 flex items-center px-4 py-2 bg-blue-100 text-blue-800 text-sm font-semibold rounded-lg hover:bg-blue-200 transition-colors">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Xem giải thích
                            </button>`;
                        }
                    });
                    
                    document.querySelectorAll('.explain-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const button = e.currentTarget;
                            const index = parseInt(button.dataset.explainIndex, 10);
                            showExplanation(index, button);
                        });
                    });

                    if (window.MathJax) await window.MathJax.typesetPromise([studentQuizContainer]);
                } else {
                     resultContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg text-center"><h3 class="text-xl font-bold text-green-600">Nộp bài thành công!</h3><p class="mt-2 text-slate-700">Bạn đã hoàn thành bài làm. Kết quả sẽ được giáo viên công bố sau.</p></div>`;
                    resultContainer.classList.remove('hidden');
                }
                
                const formData = new FormData();
                formData.append('name', studentInfo.name);
                formData.append('class', studentInfo.class);
                formData.append('score', `${finalScore.toFixed(2)}/10`);
                formData.append('assessment', competencyAssessment);
                formData.append('timestamp', new Date().toLocaleString('vi-VN'));
                formData.append('examCode', correctExamCode);
                formData.append('monitoringLog', proctoringDataString);
                formData.append('answerDetails', JSON.stringify(allAnswersData));
               
                fetch(googleScriptUrl, { method: 'POST', body: formData})
                    .then(res => console.log("Successfully submitted to Google Sheet"))
                    .catch(err => console.error("Error submitting to Google Sheet:", err));
            }
           
            function startNewAttempt() {
                isSubmitted = false;
                proctoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0, suKien: [] };
                const proctoringWidget = document.getElementById('proctoring-widget');
                if (proctoringWidget) {
                    proctoringWidget.classList.add('hidden');
                    document.getElementById('tab-switch-count').textContent = '0';
                    document.getElementById('copy-count').textContent = '0';
                    document.getElementById('paste-count').textContent = '0';
                }

                renderStudentQuiz();
                resultContainer.classList.add('hidden');
                document.getElementById('ai-feedback-container').classList.add('hidden');
                postSubmitOptions.classList.add('hidden');
                submitBtn.classList.remove('hidden');
                 if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                }
                retriesLeft--;
                retriesDisplay.textContent = `Lượt làm lại còn: ${retriesLeft}`;
                window.scrollTo(0, 0);
            }
            studentInfoForm.addEventListener('submit', (e) => {
                e.preventDefault();
               
                const enteredCode = document.getElementById('exam-code').value.trim().toUpperCase();
                if (correctExamCode && enteredCode !== correctExamCode) {
                    alert('Mã đề không chính xác. Vui lòng kiểm tra lại!');
                    return;
                }
               
                studentApiKey = teacherApiKey;
                if (!studentApiKey) {
                    console.warn('Cảnh báo: Giáo viên chưa cấu hình API Key. Các tính năng AI sẽ không hoạt động.');
                }
       
                try {
                    if (studentApiKey) {
                       ai = new GoogleGenAI({ apiKey: studentApiKey });
                    }
                } catch(e) {
                    console.error("Lỗi khởi tạo Gemini API với key của giáo viên.", e);
                    alert("Cảnh báo: API Key của giáo viên không hợp lệ. Vui lòng báo cho giáo viên. Các tính năng AI sẽ không hoạt động.");
                    ai = null;
                }
                shuffleQuiz();
               
                studentInfo.name = document.getElementById('student-name').value;
                studentInfo.class = document.getElementById('student-class').value;
                loginModal.classList.add('hidden');
                studentQuizContainer.classList.remove('hidden');
                submitBtn.classList.remove('hidden');
               
                if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                } else {
                    timerDisplay.textContent = "Không giới hạn";
                }
                retriesDisplay.textContent = `Lượt làm lại còn: ${retriesLeft}`;
                renderStudentQuiz();

                const proctoringWidget = document.getElementById('proctoring-widget');
                const tabSwitchCountEl = document.getElementById('tab-switch-count');
                const copyCountEl = document.getElementById('copy-count');
                const pasteCountEl = document.getElementById('paste-count');

                function updateProctoringUI() {
                    if (proctoringLog.thoatManHinh > 0 || proctoringLog.saoChep > 0 || proctoringLog.dan > 0) {
                        proctoringWidget.classList.remove('hidden');
                    }
                    tabSwitchCountEl.textContent = proctoringLog.thoatManHinh;
                    copyCountEl.textContent = proctoringLog.saoChep;
                    pasteCountEl.textContent = proctoringLog.dan;
                }

                // Disable Right Click
                document.addEventListener('contextmenu', e => e.preventDefault());

                // Track Tab Switching
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && !isSubmitted) {
                        proctoringLog.thoatManHinh++;
                        proctoringLog.suKien.push({ loai: 'chuyen_tab', thoiGian: new Date().toISOString() });
                        updateProctoringUI();
                    }
                });

                // Track Copying
                document.addEventListener('copy', () => {
                    if (isSubmitted) return;
                    proctoringLog.saoChep++;
                    proctoringLog.suKien.push({ loai: 'sao_chep', thoiGian: new Date().toISOString() });
                    updateProctoringUI();
                });

                // Track Pasting
                document.addEventListener('paste', () => {
                    if (isSubmitted) return;
                    proctoringLog.dan++;
                    proctoringLog.suKien.push({ loai: 'dan', thoiGian: new Date().toISOString() });
                    updateProctoringUI();
                });
            });
            
            submitBtn.addEventListener('click', handleSubmit);
            retryBtn.addEventListener('click', () => {
                shuffleQuiz();
                startNewAttempt();
            });
        </script>
    </body>
    </html>
    