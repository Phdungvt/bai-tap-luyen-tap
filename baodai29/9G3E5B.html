
    <!DOCTYPE html>
    <html lang="vi">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Bài Tập Luyện Tập</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
        <script>
            window.MathJax = {
                tex: {
                    packages: {'[+]': ['ams']},
                    inlineMath: [['$', '$'], ['\\(', '\\)']],
                    displayMath: [['$$', '$$'], ['\\[', '\\]']]
                },
                chtml: {
                    fontCache: 'global',
                    linebreaks: {
                        automatic: true
                    }
                }
            };
        </script>
        <script type="text/javascript" id="MathJax-script" async
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
        </script>
        <style>
            body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #f0f4f8; }
            .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
            @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
            .question-card {
                background-color: white;
                border-radius: 1rem;
                padding: 1.5rem 2rem;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                border-left: 5px solid transparent;
                transition: all 0.3s ease;
            }
            .ai-explanation {
                background-color: #f0f9ff;
                color: #0c4a6e;
                padding: 1rem;
                border-radius: 0.75rem;
                font-size: 0.9rem;
                margin-top: 1rem;
                border-left: 4px solid #38bdf8;
            }
            .feedback-icon { width: 1.5rem; height: 1.5rem; }
            .option-label {
                transition: all 0.2s ease-in-out;
                border: 2px solid #e5e7eb;
            }
            .option-label:hover {
                border-color: #6366f1;
                background-color: #eef2ff;
            }
            .option-label.correct {
                border-color: #10b981 !important;
                background-color: #ecfdf5 !important;
                color: #065f46;
            }
            .option-label.incorrect {
                border-color: #ef4444 !important;
                background-color: #fef2f2 !important;
                color: #991b1b;
            }
            .statement-item.correct { background-color: #ecfdf5; border-color: #10b981; }
            .statement-item.incorrect { background-color: #fef2f2; border-color: #ef4444; }
            .prose { max-width: 100%; }
            .prose h1, .prose h2, .prose h3 { font-weight: 600; }
            .prose p { margin-top: 0.5em; margin-bottom: 0.5em; }
            .prose ul, .prose ol { margin-top: 1em; margin-bottom: 1em; padding-left: 1.5em; }
            .prose li > p { margin-top: 0; margin-bottom: 0; }
            .prose code { background-color: #e5e7eb; padding: 0.2em 0.4em; margin: 0; font-size: 85%; border-radius: 3px; }
            .prose pre { background-color: #e5e7eb; padding: 1em; border-radius: 0.5em; overflow-x: auto; }
            .prose pre code { background-color: transparent; padding: 0; }
            details[open] > summary .details-arrow {
                transform: rotate(180deg);
            }
        </style>
    </head>
    <body class="bg-slate-100 text-slate-800">
        <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md transform transition-all" style="animation: fadeIn 0.3s ease-out;">
                <h2 class="text-2xl font-bold mb-2 text-center text-slate-800">Thông Tin Học Sinh</h2>
                <p class="text-center text-slate-500 mb-6">Vui lòng nhập để bắt đầu làm bài.</p>
                <form id="student-info-form">
                    <div class="mb-4">
                        <label for="student-name" class="block text-sm font-medium text-slate-700 mb-1">Họ và tên</label>
                        <input type="text" id="student-name" required class="mt-1 block w-full block border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="student-class" class="block text-sm font-medium text-slate-700 mb-1">Lớp</label>
                        <input type="text" id="student-class" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="exam-code" class="block text-sm font-medium text-slate-700 mb-1">Mã đề</label>
                        <input type="text" id="exam-code" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Nhập mã đề giáo viên cung cấp">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Giáo viên:</label>
                        <p class="mt-1 text-slate-800 bg-slate-100 p-2.5 rounded-lg">HUỲNH BẢO ĐẠI</p>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">Bắt đầu làm bài</button>
                </form>
            </div>
        </div>
        <div class="container mx-auto p-4 md:p-8 max-w-4xl">
            <header class="mb-10 p-8 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg">
                <div class="flex justify-between items-center flex-wrap gap-4">
                    <div>
                        <h1 class="text-4xl font-bold">Bài Tập Luyện Tập</h1>
                        <p class="text-lg text-blue-100 mt-2">Hãy hoàn thành các câu hỏi dưới đây một cách tốt nhất!</p>
                        <p class="text-sm text-blue-200 mt-4">Tác giả: HUỲNH BẢO ĐẠI</p>
                    </div>
                    <div id="timer-container" class="text-right">
                         <div id="timer-display" class="text-3xl font-bold tracking-wider bg-white/20 px-4 py-2 rounded-lg">--:--</div>
                         <div id="retries-display" class="text-sm mt-1 text-blue-200"></div>
                    </div>
                </div>
            </header>
            <main id="student-quiz-container" class="space-y-8 hidden">
                <!-- Questions will be rendered here by JS -->
            </main>
            <footer class="mt-10 text-center">
                <button id="submit-quiz-btn" class="bg-indigo-600 text-white py-3 px-12 rounded-full font-bold text-lg hover:bg-indigo-700 transition-all duration-300 shadow-lg hover:shadow-xl hidden transform hover:scale-105">Nộp Bài</button>
                <div id="result-container" class="mt-6 hidden"></div>
                <div id="ai-feedback-container" class="mt-8 text-left hidden"></div>
                <div id="post-submit-options" class="hidden mt-6 flex flex-col sm:flex-row items-center justify-center gap-4">
                    <button id="retry-quiz-btn" class="w-full sm:w-auto bg-slate-600 text-white py-2.5 px-6 rounded-lg font-semibold hover:bg-slate-700 transition-transform transform hover:scale-105">Làm Lại Đề Này</button>
                </div>
            </footer>
        </div>

        <div id="proctoring-widget" class="fixed bottom-4 right-4 bg-yellow-100 text-yellow-800 p-3 rounded-lg shadow-lg text-sm z-50 hidden border border-yellow-300" style="max-width: 200px;">
            <h4 class="font-bold mb-2 border-b border-yellow-300 pb-1 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 3.001-1.742 3.001H4.42c-1.53 0-2.493-1.667-1.743-3.001l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                Giám sát
            </h4>
            <p>Thoát màn hình: <span id="tab-switch-count" class="font-bold">0</span></p>
            <p>Sao chép: <span id="copy-count" class="font-bold">0</span></p>
            <p>Dán: <span id="paste-count" class="font-bold">0</span></p>
        </div>

        <script type="module">
            import { GoogleGenAI, Type } from "https://esm.sh/@google/genai@^1.13.0";
            let quizData = [{"type":"multiple-choice","question":"Kĩ thuật điện bao gồm những lĩnh vực chính nào liên quan đến điện năng?","questionImage":null,"mappedType":"multiple-choice","options":["Sản xuất, truyền tải, phân phối và sử dụng điện.","Thiết kế mạch điện tử và lập trình vi điều khiển.","Chế tạo máy móc cơ khí và tự động hóa.","Quản lý tài nguyên nước và năng lượng hạt nhân."],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Vai trò nào sau đây mô tả đúng nhất tầm quan trọng của kĩ thuật điện trong sản xuất và đời sống hiện đại?","questionImage":null,"mappedType":"multiple-choice","options":["Là nguồn năng lượng chính và thiết yếu, thúc đẩy mọi hoạt động công nghiệp, nông nghiệp và sinh hoạt.","Chủ yếu cung cấp giải pháp giải trí và các thiết bị điện tử dân dụng đơn giản.","Hỗ trợ phát triển các ngành nghệ thuật và văn hóa truyền thống.","Giới hạn trong việc phát triển các phương tiện giao thông chạy bằng nhiên liệu hóa thạch."],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Trong bối cảnh triển vọng phát triển của kĩ thuật điện, nguồn năng lượng tái tạo nào đang được đặc biệt chú trọng tại Việt Nam để đảm bảo an ninh năng lượng và phát triển bền vững?","questionImage":null,"mappedType":"multiple-choice","options":["Điện mặt trời và điện gió.","Điện than và điện dầu.","Điện hạt nhân và điện thủy triều.","Điện khí tự nhiên và điện sinh khối quy mô nhỏ."],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Lưới điện thông minh (Smart Grid) được đánh giá là một triển vọng lớn của kĩ thuật điện. Ưu điểm nổi bật của lưới điện thông minh so với lưới điện truyền thống là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Khả năng tự động phát hiện, cô lập và khắc phục sự cố, tối ưu hóa phân phối điện, và tích hợp năng lượng tái tạo.","Chỉ sử dụng điện một chiều ($DC$) thay vì xoay chiều ($AC$), giúp giảm tổn thất năng lượng.","Yêu cầu ít bảo trì hơn do không có bất kì bộ phận chuyển động nào trong hệ thống.","Chỉ phục vụ cho các khu vực đô thị lớn, không áp dụng được cho vùng nông thôn và vùng sâu, vùng xa."],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Ngành kĩ thuật điện có vị trí như thế nào trong bối cảnh cuộc cách mạng công nghiệp $4.0$ đang diễn ra mạnh mẽ trên toàn cầu?","questionImage":null,"mappedType":"multiple-choice","options":["Là một trong những ngành công nghiệp nền tảng, thiết yếu, thúc đẩy sự phát triển của tự động hóa, kết nối thông minh và Internet vạn vật ($IoT$).","Chỉ đóng vai trò thứ yếu, chủ yếu phục vụ các ngành công nghiệp khác mà không có sự đổi mới đáng kể.","Đã lỗi thời và đang dần được thay thế bởi các công nghệ thông tin và truyền thông.","Chủ yếu tập trung vào sản xuất các thiết bị điện gia dụng thông thường và ít có đóng góp vào công nghệ cao."],"optionsImage":[],"correctAnswerIndex":0},{"type":"true-false","main_question":"Kĩ thuật điện là một lĩnh vực quan trọng trong sản xuất và đời sống. Hãy cho biết các phát biểu sau đây về kĩ thuật điện là đúng hay sai.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Kĩ thuật điện chỉ tập trung vào việc sản xuất năng lượng điện.","is_correct":false},{"statement":"Một trong các hoạt động cốt lõi của kĩ thuật điện là truyền tải và phân phối điện năng đến người tiêu dùng.","is_correct":true},{"statement":"Việc tối ưu hóa hiệu suất sử dụng điện trong các thiết bị gia dụng là một khía cạnh của kĩ thuật điện.","is_correct":true},{"statement":"Ngành kĩ thuật điện hiện nay chủ yếu nghiên cứu các vật liệu siêu dẫn để giảm tổn thất trên đường dây truyền tải mà không xem xét các yếu tố kinh tế.","is_correct":false}]},{"type":"true-false","main_question":"Kĩ thuật điện đóng vai trò thiết yếu trong sự phát triển của các ngành công nghiệp. Hãy đánh giá tính đúng/sai của các nhận định dưới đây.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Kĩ thuật điện cung cấp năng lượng cho hầu hết các hoạt động sản xuất công nghiệp và dịch vụ.","is_correct":true},{"statement":"Nhờ có kĩ thuật điện, hệ thống chiếu sáng trong các đô thị và nhà máy mới có thể hoạt động hiệu quả.","is_correct":true},{"statement":"Trong nông nghiệp hiện đại, việc ứng dụng các hệ thống tưới tiêu tự động và quản lí môi trường nhà kính đều không cần đến sự đóng góp của kĩ thuật điện.","is_correct":false},{"statement":"Sự phát triển của trí tuệ nhân tạo ($AI$) và học máy ($Machine$ $Learning$) phụ thuộc hoàn toàn vào tốc độ tính toán của các chip điện tử mà không cần quan tâm đến nguồn cung cấp điện ổn định.","is_correct":false}]},{"type":"true-false","main_question":"Triển vọng phát triển của kĩ thuật điện hướng tới các công nghệ mới và bền vững. Hãy xác định đúng/sai cho các phát biểu sau.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Năng lượng tái tạo như điện mặt trời và điện gió là một trong những hướng phát triển quan trọng của kĩ thuật điện.","is_correct":true},{"statement":"Lưới điện thông minh ($Smart$ $Grid$) giúp tối ưu hóa việc phân phối điện bằng cách tích hợp công nghệ thông tin và truyền thông.","is_correct":true},{"statement":"Việc phát triển pin lưu trữ năng lượng hiệu quả cao không còn là ưu tiên hàng đầu trong bối cảnh năng lượng tái tạo phát triển mạnh mẽ.","is_correct":false},{"statement":"Công nghệ Internet vạn vật ($IoT$) trong kĩ thuật điện chỉ nhằm mục đích thu thập dữ liệu về mức tiêu thụ điện mà không có khả năng tự động điều khiển hoặc phản ứng tức thời.","is_correct":false}]},{"type":"multiple-choice","question":"Dòng điện xoay chiều ba pha là hệ thống gồm ba dòng điện xoay chiều có đặc điểm gì?","questionImage":null,"mappedType":"multiple-choice","options":["Có cùng biên độ, cùng tần số và lệch pha nhau $120^{\\circ}$.","Có cùng biên độ, cùng tần số và cùng pha.","Có cùng biên độ nhưng tần số và pha khác nhau.","Có biên độ và tần số khác nhau, cùng pha."],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Để tạo ra suất điện động xoay chiều ba pha, người ta thường đặt ba cuộn dây giống nhau lệch nhau bao nhiêu độ trong không gian?","questionImage":null,"mappedType":"multiple-choice","options":["$0^{\\circ}$","$90^{\\circ}$","$120^{\\circ}$","$180^{\\circ}$"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Trong máy phát điện xoay chiều ba pha, ba suất điện động xoay chiều có trị số hiệu dụng bằng nhau và lệch pha nhau bao nhiêu?","questionImage":null,"mappedType":"multiple-choice","options":["$\frac{\\pi}{2}$ rad","$\\pi$ rad","$\frac{2\\pi}{3}$ rad","$\frac{\\pi}{4}$ rad"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Khi nối hình sao ba pha, điểm chung của ba cuộn dây nguồn được gọi là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Điểm pha","Điểm dây","Điểm trung tính","Điểm tải"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Trong mạch điện xoay chiều ba pha đối xứng nối hình sao, mối quan hệ giữa điện áp dây ($U_d$) và điện áp pha ($U_p$) là gì?","questionImage":null,"mappedType":"multiple-choice","options":["$U_d = U_p$","$U_d = \\sqrt{2}U_p$","$U_d = \\sqrt{3}U_p$","$U_d = 2U_p$"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Khi nối nguồn điện ba pha hình tam giác, mỗi đầu cuộn dây của pha này được nối với đầu nào của cuộn dây pha kia?","questionImage":null,"mappedType":"multiple-choice","options":["Cùng đầu","Ngược đầu","Trung điểm của cuộn dây tiếp theo","Điểm cuối của cuộn dây tiếp theo"],"optionsImage":[],"correctAnswerIndex":3},{"type":"multiple-choice","question":"Trong mạch điện xoay chiều ba pha đối xứng nối hình tam giác, mối quan hệ giữa dòng điện dây ($I_d$) và dòng điện pha ($I_p$) là gì?","questionImage":null,"mappedType":"multiple-choice","options":["$I_d = I_p$","$I_d = \\sqrt{2}I_p$","$I_d = \\sqrt{3}I_p$","$I_d = 2I_p$"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Dòng điện chạy trong dây dẫn nối từ nguồn đến tải trong hệ thống điện ba pha được gọi là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Dòng điện pha","Dòng điện trung tính","Dòng điện dây","Dòng điện tải"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Điện áp giữa một dây pha và dây trung tính (nếu có) hoặc giữa hai đầu của một cuộn dây pha được gọi là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Điện áp dây","Điện áp pha","Điện áp nguồn","Điện áp tải"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Một trong những ưu điểm nổi bật của việc sử dụng hệ thống điện xoay chiều ba pha so với một pha là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Công suất truyền tải nhỏ hơn.","Hiệu quả sử dụng vật liệu đường dây cao hơn.","Chỉ sử dụng được cho tải một pha.","Khó khởi động động cơ điện."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Hệ thống điện quốc gia bao gồm mấy thành phần chính?","questionImage":null,"mappedType":"multiple-choice","options":["$2$","$3$","$4$","$5$"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Trong hệ thống điện quốc gia, nguồn điện có vai trò gì?","questionImage":null,"mappedType":"multiple-choice","options":["Truyền tải điện năng đi xa","Phân phối điện đến các hộ tiêu thụ","Sản xuất ra điện năng","Tiêu thụ điện năng"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Vai trò chính của lưới điện trong hệ thống điện quốc gia là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Phát điện","Biến đổi điện năng","Truyền tải và phân phối điện năng","Sử dụng điện năng"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Thành phần nào trong hệ thống điện quốc gia có chức năng sử dụng điện năng để phục vụ sản xuất và đời sống?","questionImage":null,"mappedType":"multiple-choice","options":["Nguồn điện","Lưới điện","Tải tiêu thụ","Trạm biến áp"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Đường dây truyền tải điện $500kV$ Bắc - Nam thuộc cấp điện áp nào trong hệ thống điện quốc gia?","questionImage":null,"mappedType":"multiple-choice","options":["Hạ áp","Trung áp","Cao áp","Siêu cao áp"],"optionsImage":[],"correctAnswerIndex":3},{"type":"multiple-choice","question":"Cấp điện áp \"Hạ áp\" trong hệ thống điện quốc gia có giá trị điện áp như thế nào?","questionImage":null,"mappedType":"multiple-choice","options":["Dưới $1kV$","Từ $1kV$ đến $35kV$","Từ $35kV$ đến $220kV$","Trên $220kV$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Cấp điện áp \"Trung áp\" trong hệ thống điện quốc gia có giá trị điện áp trong khoảng nào?","questionImage":null,"mappedType":"multiple-choice","options":["Dưới $1kV$","Từ $1kV$ đến $35kV$","Từ $35kV$ đến $220kV$","Trên $220kV$"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Cấp điện áp \"Cao áp\" trong hệ thống điện quốc gia có giá trị điện áp trong khoảng nào?","questionImage":null,"mappedType":"multiple-choice","options":["Dưới $1kV$","Từ $1kV$ đến $35kV$","Từ $35kV$ đến $220kV$","Trên $220kV$"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Trạm biến áp đóng vai trò quan trọng nào trong lưới điện truyền tải và phân phối?","questionImage":null,"mappedType":"multiple-choice","options":["Sản xuất điện năng","Điều chỉnh tần số dòng điện","Thay đổi cấp điện áp để phù hợp với việc truyền tải hoặc sử dụng","Lưu trữ điện năng"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Mục đích chính của việc xây dựng và vận hành hệ thống điện quốc gia là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Tập trung sản xuất điện tại một vài địa điểm lớn","Đảm bảo cung cấp điện liên tục, ổn định và hiệu quả cho mọi nhu cầu","Hạn chế sử dụng điện năng","Chỉ phục vụ cho các ngành công nghiệp nặng"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Dòng điện xoay chiều ba pha là hệ thống gồm ba dòng điện xoay chiều một pha có cùng biên độ, cùng tần số và lệch pha nhau một góc bao nhiêu?","questionImage":null,"mappedType":"multiple-choice","options":["$\\frac{\\pi}{3}$ rad","$\\frac{\\pi}{2}$ rad","$\\frac{2\\pi}{3}$ rad","$\\pi$ rad"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Trong mạch điện xoay chiều ba pha đối xứng, khi nguồn và tải được nối hình sao, phát biểu nào sau đây về mối quan hệ giữa điện áp dây ($U_d$) và điện áp pha ($U_p$) là đúng?","questionImage":null,"mappedType":"multiple-choice","options":["$U_d = U_p$","$U_d = \\sqrt{3} U_p$","$U_p = \\sqrt{3} U_d$","$U_d = \\frac{1}{\\sqrt{3}} U_p$"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Trong mạch điện xoay chiều ba pha đối xứng, khi nguồn và tải được nối hình tam giác, phát biểu nào sau đây về mối quan hệ giữa dòng điện dây ($I_d$) và dòng điện pha ($I_p$) là đúng?","questionImage":null,"mappedType":"multiple-choice","options":["$I_d = I_p$","$I_d = \\sqrt{3} I_p$","$I_p = \\sqrt{3} I_d$","$I_d = \\frac{1}{\\sqrt{3}} I_p$"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Ưu điểm nổi bật của việc sử dụng dòng điện xoay chiều ba pha so với dòng điện một pha trong truyền tải và phân phối điện năng là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Đơn giản hóa cấu trúc mạng lưới điện.","Tiết kiệm vật liệu dẫn điện và giảm tổn thất công suất.","Dễ dàng chuyển đổi thành dòng điện một chiều.","Không yêu cầu các thiết bị bảo vệ phức tạp."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Trong cách nối hình sao của tải ba pha, điểm nào sau đây được gọi là điểm trung tính?","questionImage":null,"mappedType":"multiple-choice","options":["Điểm nối chung của ba đầu dây cuối các pha của tải.","Điểm nối chung của ba đầu dây đầu các pha của tải.","Điểm đầu của một pha bất kỳ của tải.","Điểm cuối của một pha bất kỳ của tải."],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Cấu trúc chung của hệ thống điện quốc gia bao gồm những thành phần chính nào?","questionImage":null,"mappedType":"multiple-choice","options":["Nhà máy điện và đường dây truyền tải.","Nguồn điện, lưới điện và tải tiêu thụ.","Trạm biến áp và đường dây phân phối.","Máy phát điện, máy biến áp và hộ gia đình."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Vai trò chính của nguồn điện trong hệ thống điện quốc gia là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Truyền tải điện năng đi xa.","Biến đổi điện áp phù hợp cho tải.","Sản xuất điện năng.","Tiêu thụ điện năng."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Lưới điện truyền tải có vai trò như thế nào trong hệ thống điện quốc gia?","questionImage":null,"mappedType":"multiple-choice","options":["Đưa điện đến trực tiếp các hộ tiêu thụ với điện áp thấp.","Biến đổi điện áp từ cao xuống thấp để phân phối.","Truyền tải điện năng từ các nhà máy điện đến các khu vực tiêu thụ lớn với điện áp cao.","Tiêu thụ điện năng để vận hành các thiết bị công nghiệp."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Trong hệ thống điện quốc gia, cấp điện áp $110 \text{ kV}$ thuộc loại lưới điện nào?","questionImage":null,"mappedType":"multiple-choice","options":["Lưới điện hạ áp.","Lưới điện trung áp.","Lưới điện cao áp.","Lưới điện siêu cao áp."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Tầm quan trọng của việc có nhiều cấp điện áp khác nhau (hạ áp, trung áp, cao áp, siêu cao áp) trong hệ thống điện quốc gia là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Giúp giảm chi phí sản xuất điện tại nhà máy.","Đảm bảo hiệu quả truyền tải điện năng đi xa và cung cấp điện an toàn, phù hợp cho mọi đối tượng tiêu thụ.","Chỉ để phục vụ các nhà máy công nghiệp lớn.","Đơn giản hóa cấu trúc hệ thống điện."],"optionsImage":[],"correctAnswerIndex":1},{"type":"true-false","main_question":"Về dòng điện xoay chiều ba pha, hãy đánh giá các phát biểu sau:","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Dòng điện xoay chiều ba pha là hệ thống gồm ba dòng điện xoay chiều một pha có cùng biên độ, tần số và lệch pha nhau $120^{\\circ}$ điện.","is_correct":true},{"statement":"Trong máy phát điện xoay chiều ba pha, để tạo ra ba sức điện động lệch pha nhau $120^{\\circ}$ điện, người ta bố trí ba cuộn dây giống hệt nhau lệch nhau $120^{\\circ}$ trong không gian.","is_correct":true},{"statement":"Nếu một hệ thống ba pha có điện áp pha hiệu dụng là $U_p = 220 \\text{ V}$, thì điện áp giữa hai dây bất kì (điện áp dây) luôn là $U_d = 380 \\text{ V}$.","is_correct":false},{"statement":"Công suất tức thời toàn phần của mạch điện xoay chiều ba pha đối xứng khi tải đối xứng luôn không đổi và bằng ba lần công suất tức thời của một pha.","is_correct":true}]},{"type":"true-false","main_question":"Về cách nối nguồn và tải trong mạch điện xoay chiều ba pha đối xứng, hãy đánh giá các phát biểu sau:","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Nguồn điện ba pha và tải ba pha có thể được nối theo hai cách cơ bản là nối hình sao hoặc nối hình tam giác.","is_correct":true},{"statement":"Trong cách nối hình sao cho tải đối xứng, dòng điện chạy qua mỗi tải (dòng điện pha) bằng dòng điện chạy trong dây dẫn chính (dòng điện dây).","is_correct":true},{"statement":"Nếu một tải ba pha đối xứng hình tam giác có trở kháng mỗi pha là $Z_p = 20 \\Omega$ được nối vào nguồn hình sao có điện áp pha $U_p = 220 \\text{ V}$, thì dòng điện pha của tải là $I_p = 11 \\text{ A}$.","is_correct":false},{"statement":"Để đảm bảo điện áp đặt vào mỗi pha của tải là $220 \\text{ V}$ khi nguồn có điện áp pha $U_p = 220 \\text{ V}$, nếu tải nối hình sao thì điện áp dây phải là $220 \\sqrt{3} \\text{ V}$, còn nếu tải nối hình tam giác thì điện áp dây phải là $220 \\text{ V}$.","is_correct":true}]},{"type":"true-false","main_question":"Về cấu trúc và vai trò của các thành phần trong hệ thống điện quốc gia, hãy cho biết các nhận định sau đây là đúng hay sai.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Nguồn điện là thành phần có vai trò sản xuất ra năng lượng điện.","is_correct":true},{"statement":"Lưới điện truyền tải có nhiệm vụ vận chuyển điện năng từ các nhà máy điện đến các khu vực dân cư và công nghiệp với khoảng cách xa.","is_correct":true},{"statement":"Tải tiêu thụ trong hệ thống điện quốc gia chỉ bao gồm các thiết bị điện sử dụng trong sinh hoạt gia đình.","is_correct":false},{"statement":"Đường dây $500\text{kV}$ Bắc - Nam thuộc lưới điện phân phối, có vai trò chính là cung cấp điện trực tiếp cho các phụ tải lớn ở hai đầu đất nước.","is_correct":false}]},{"type":"true-false","main_question":"Khi phân tích về các cấp điện áp và vai trò của từng thành phần trong hệ thống điện quốc gia, hãy xác định các nhận định sau đây là đúng hay sai.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Hệ thống điện quốc gia bao gồm ba thành phần chính là nguồn điện, lưới điện và tải tiêu thụ.","is_correct":true},{"statement":"Lưới điện phân phối có nhiệm vụ nhận điện từ lưới điện truyền tải và đưa đến trực tiếp các hộ gia đình, cơ sở sản xuất nhỏ.","is_correct":true},{"statement":"Để giảm thiểu tổn thất điện năng trên đường dây truyền tải, điện áp cần được hạ xuống mức thấp nhất có thể.","is_correct":false},{"statement":"Điện áp $22\text{kV}$ hoặc $35\text{kV}$ được xếp vào cấp điện áp siêu cao áp, được sử dụng để truyền tải điện năng đi qua các tỉnh thành lớn.","is_correct":false}]},{"type":"multiple-choice","question":"Kĩ thuật điện là ngành khoa học kĩ thuật nghiên cứu, thiết kế, chế tạo và ứng dụng các hệ thống liên quan đến việc gì?","questionImage":null,"mappedType":"multiple-choice","options":["Sản xuất, truyền tải, phân phối và sử dụng điện năng.","Chỉ sản xuất và truyền tải điện năng.","Chỉ phân phối và sử dụng điện năng.","Nghiên cứu các vật liệu dẫn điện."],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Trong ngành công nghiệp, kĩ thuật điện đóng vai trò chủ chốt trong việc cung cấp năng lượng cho hoạt động nào?","questionImage":null,"mappedType":"multiple-choice","options":["Vận hành máy móc, thiết bị sản xuất.","Thiết kế kiến trúc nhà xưởng.","Quản lí nhân sự.","Tiếp thị sản phẩm."],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Vai trò nào sau đây của kĩ thuật điện thể hiện rõ nhất trong đời sống sinh hoạt hàng ngày của con người?","questionImage":null,"mappedType":"multiple-choice","options":["Cung cấp năng lượng cho các thiết bị gia dụng và chiếu sáng.","Nghiên cứu các phương pháp bảo vệ môi trường.","Phát triển công nghệ vũ trụ.","Xây dựng các công trình giao thông."],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Phát triển năng lượng tái tạo như điện mặt trời, điện gió là một trong những __________ của kĩ thuật điện trong tương lai.","questionImage":null,"mappedType":"multiple-choice","options":["triển vọng phát triển","thách thức lớn nhất","hạn chế chính","lĩnh vực bị thu hẹp"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Lưới điện thông minh (Smart Grid) được xem là một __________ quan trọng của kĩ thuật điện nhằm tối ưu hóa việc cung cấp và sử dụng điện năng.","questionImage":null,"mappedType":"multiple-choice","options":["triển vọng phát triển","hạn chế kĩ thuật","nguyên tắc cơ bản","mô hình lỗi thời"],"optionsImage":[],"correctAnswerIndex":0}];
            const quizOptions = {"timeLimit":60,"retriesAllowed":100,"showAnswers":true,"showExplanation":true,"aiAssessment":true,"scoring":{"mc":5,"tf":2,"sa":2,"essay":1,"tfMethod":"even"}};
            const googleScriptUrl = "https://script.google.com/macros/s/AKfycbwFrgRsOYyp5I4KnPDffimwrwMXH_c5bpxjxqUDnqxqnjoQHV8mUoUZfAwGfWY9CgYf/exec";
            const correctExamCode = "9G3E5B";
            const teacherApiKey = "AIzaSyDTFy_GnA8GaPaZNP2avwinsBnrDB7hcRw";
            let studentInfo = {};
            let isSubmitted = false;
            let timerInterval;
            let retriesLeft = quizOptions.retriesAllowed;
            let studentApiKey = "";
            let ai = null;

            let proctoringLog = {
                thoatManHinh: 0,
                saoChep: 0,
                dan: 0,
                suKien: []
            };

            const studentQuizContainer = document.getElementById('student-quiz-container');
            const submitBtn = document.getElementById('submit-quiz-btn');
            const resultContainer = document.getElementById('result-container');
            const postSubmitOptions = document.getElementById('post-submit-options');
            const retryBtn = document.getElementById('retry-quiz-btn');
            const loginModal = document.getElementById('login-modal');
            const studentInfoForm = document.getElementById('student-info-form');
            const timerDisplay = document.getElementById('timer-display');
            const retriesDisplay = document.getElementById('retries-display');
            function shuffleQuiz() {
                // Shuffle options/statements within each question first
                quizData.forEach(item => {
                    // Shuffle multiple-choice options and their corresponding images
                    if (item.mappedType === 'multiple-choice' && item.options && item.options.length > 0) {
                        const correctAnswerText = item.options[item.correctAnswerIndex];
                        let optionsWithImages = item.options.map((opt, index) => ({
                            text: opt,
                            image: (item.optionsImage && item.optionsImage[index]) ? item.optionsImage[index] : null
                        }));
                        // Fisher-Yates shuffle
                        for (let i = optionsWithImages.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [optionsWithImages[i], optionsWithImages[j]] = [optionsWithImages[j], optionsWithImages[i]];
                        }
                        // Update the item with shuffled data
                        item.options = optionsWithImages.map(opt => opt.text);
                        item.optionsImage = optionsWithImages.map(opt => opt.image);
                        item.correctAnswerIndex = item.options.indexOf(correctAnswerText);
                    }
                    // Shuffle true-false statements
                    if (item.mappedType === 'true-false' && item.statements && item.statements.length > 0) {
                         for (let i = item.statements.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [item.statements[i], item.statements[j]] = [item.statements[j], item.statements[i]];
                        }
                    }
                });
                // Then, group questions by type and shuffle within each group
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});
                let shuffledQuizData = [];
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    if (grouped[partType]) {
                        const partQuestions = grouped[partType];
                        for (let i = partQuestions.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [partQuestions[i], partQuestions[j]] = [partQuestions[j], partQuestions[i]];
                        }
                        shuffledQuizData = shuffledQuizData.concat(partQuestions);
                    }
                });
               
                quizData = shuffledQuizData;
            }
            // --- Timer Function ---
            function startTimer(duration, display) {
                let timer = duration, minutes, seconds;
                clearInterval(timerInterval); // Clear any existing timer
                if(duration <= 0) {
                     display.textContent = "∞";
                     return;
                }
                timerInterval = setInterval(function () {
                    minutes = parseInt(timer / 60, 10);
                    seconds = parseInt(timer % 60, 10);
                    minutes = minutes < 10 ? "0" + minutes : minutes;
                    seconds = seconds < 10 ? "0" + seconds : seconds;
                    display.textContent = minutes + ":" + seconds;
                    if (--timer < 0) {
                        clearInterval(timerInterval);
                        alert("Hết giờ làm bài!");
                        handleSubmit();
                    }
                }, 1000);
            }
            
            async function showExplanation(index, button) {
                const item = quizData[index];
                const questionCard = document.getElementById(`student-q-${index}`);
                const feedbackDiv = document.getElementById(`q-${index}-feedback`);
                if (!questionCard || !feedbackDiv) return;

                const existingExplanation = feedbackDiv.querySelector('.ai-explanation');
                if (existingExplanation) {
                    existingExplanation.remove();
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Xem giải thích
                    `;
                    return;
                }

                button.disabled = true;
                button.innerHTML = '<div class="loader mr-2"></div> Đang tải...';

                if (item.explanation) {
                    displayExplanation(item.explanation, feedbackDiv, button);
                    return;
                }

                if (!ai) {
                    alert("Tính năng giải thích yêu cầu API Key, nhưng chưa được cấu hình bởi giáo viên.");
                    button.disabled = false;
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Xem giải thích
                    `;
                    return;
                }

                const questionText = item.question || item.main_question;
                let prompt = `Bạn là một trợ lý giáo viên AI, am hiểu sâu sắc Chương trình GDPT 2018. Hãy cung cấp một lời giải chi tiết, từng bước một cho câu hỏi sau đây. Lời giải phải chính xác, dễ hiểu và phù hợp với phương pháp giảng dạy của chương trình học, TUYỆT ĐỐI KHÔNG sử dụng kiến thức của lớp cao hơn để giải thích.\n\n--- CÂU HỎI ---\n${questionText}\n\n`;
                if (item.mappedType === 'multiple-choice') {
                    prompt += `--- CÁC LỰA CHỌN ---\n${item.options.map((opt, i) => `${String.fromCharCode(65 + i)}. ${opt}`).join('\n')}\n\n`;
                    prompt += `--- ĐÁP ÁN ĐÚNG ---\n${String.fromCharCode(65 + item.correctAnswerIndex)}. ${item.options[item.correctAnswerIndex]}`;
                } else if (item.mappedType === 'true-false') {
                    prompt += `--- CÁC MỆNH ĐỀ & ĐÁP ÁN ---\n${item.statements.map(s => ` - ${s.statement} -> ${s.is_correct ? 'Đúng' : 'Sai'}`).join('\n')}`;
                } else {
                    prompt += `--- ĐÁP ÁN / GỢI Ý ---\n${item.answer}`;
                }
                prompt += `\n\n--- YÊU CẦU ---\nGiải thích rõ ràng tại sao đáp án lại đúng, từng bước một. Định dạng tất cả các công thức toán học bằng LaTeX.`;

                try {
                    const response = await ai.models.generateContent({ model: "gemini-2.5-flash", contents: prompt });
                    const explanationText = response.text.replace(/\n/g, '<br>');
                    item.explanation = explanationText; // Cache it
                    displayExplanation(explanationText, feedbackDiv, button);
                } catch (error) {
                    console.error("Lỗi khi tạo giải thích:", error);
                    feedbackDiv.insertAdjacentHTML('beforeend', '<div class="ai-explanation text-red-600">Lỗi: Không thể tạo giải thích.</div>');
                    button.disabled = false;
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Thử lại
                    `;
                }
            }

            function displayExplanation(explanationText, container, button) {
                container.insertAdjacentHTML('beforeend', `<div class="ai-explanation prose prose-sm">${explanationText}</div>`);
                if (window.MathJax) MathJax.typesetPromise([container]);
                button.disabled = false;
                button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    Ẩn giải thích
                `;
            }
           
            function renderStudentQuiz() {
                studentQuizContainer.innerHTML = '';
               
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});
                const groupInfo = {
                    'multiple-choice': { title: 'PHẦN I. TRẮC NGHIỆM KHÁCH QUAN', subtitle: 'Chọn đáp án đúng nhất trong các lựa chọn sau.' },
                    'true-false': { title: 'PHẦN II. CÂU HỎI ĐÚNG - SAI', subtitle: 'Xác định tính đúng hoặc sai cho mỗi mệnh đề dưới đây.' },
                    'short-answer': { title: 'PHẦN III. CÂU HỎI TRẢ LỜI NGẮN', subtitle: 'Điền đáp án ngắn gọn vào phần trả lời.' },
                    'essay': { title: 'PHẦN IV. CÂU HỎI TỰ LUẬN', subtitle: 'Trình bày chi tiết bài giải của bạn.' }
                };
               
                let questionCounter = 0;
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    const questions = grouped[partType];
                    if (!questions || questions.length === 0) return;
                   
                    let groupHTML = `<div class="group-container space-y-8 mb-12">`;
                    const info = groupInfo[partType];
                    groupHTML += `
                        <div class="group-header pb-3 border-b-2 border-slate-300 mb-6">
                            <h2 class="text-2xl font-bold text-slate-800">${info.title}</h2>
                            ${info.subtitle ? `<p class="text-md text-slate-600 italic mt-1">${info.subtitle}</p>` : ''}
                        </div>
                    `;
                    questions.forEach((item, localIndex) => {
                        const globalIndex = quizData.indexOf(item);
                        questionCounter++;
                        groupHTML += `<div class="question-card" id="student-q-${globalIndex}">`;
                        let questionText = (item.question || item.main_question || '').replace(/\n/g, '<br>');
                       
                        groupHTML += `<div class="flex items-start">
                                     <div class="flex-grow">
                                         <div class="flex items-center mb-2">
                                             <span class="font-bold text-lg mr-3 text-indigo-600">Câu ${questionCounter}:</span>
                                             <div id="q-${globalIndex}-feedback-icon"></div>
                                         </div>
                                         <div class="question-content mt-2 text-lg text-slate-700">${questionText}</div>
                                         ${item.questionImage ? `<img src="${item.questionImage}" class="mt-4 rounded-lg max-w-full md:max-w-md border shadow-sm">` : ''}
                                     </div>
                                 </div>`;
                       
                        groupHTML += `<div class="mt-6">`;
                        switch(item.mappedType) {
                            case 'multiple-choice':
                                groupHTML += `<div class="options-grid grid grid-cols-1 md:grid-cols-2 gap-4">`;
                                item.options.forEach((opt, i) => {
                                    groupHTML += `<label for="q${globalIndex}-opt${i}" id="q${globalIndex}-opt-label${i}" class="option-label flex items-start p-4 border-2 rounded-xl cursor-pointer hover:bg-indigo-50 hover:border-indigo-400">
                                                     <input type="radio" name="q${globalIndex}" id="q${globalIndex}-opt${i}" value="${i}" class="flex-shrink-0 mt-1 h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                                     <div class="ml-3 flex-grow">
                                                         <span class="font-semibold text-slate-800">${String.fromCharCode(65 + i)}.</span>
                                                         <span class="option-content text-slate-700">${opt || ''}</span>
                                                         ${(item.optionsImage && item.optionsImage[i]) ? `<img src="${item.optionsImage[i]}" class="mt-2 rounded-lg max-w-xs border shadow-sm">` : ''}
                                                     </div>
                                                 </label>`;
                                });
                                groupHTML += `</div>`;
                                break;
                            case 'true-false':
                                 groupHTML += `<div class="space-y-4">`;
                                 item.statements.forEach((s, i) => {
                                     groupHTML += `<div class="statement-item border-t pt-4">
                                                  <p class="mb-3 text-slate-700">${String.fromCharCode(97 + i)}) ${s.statement || ''}</p>
                                                  <div class="flex gap-x-6">
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="true" class="mr-2 h-4 w-4"> Đúng</label>
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="false" class="mr-2 h-4 w-4"> Sai</label>
                                                  </div>
                                              </div>`;
                                 });
                                 groupHTML += `</div>`;
                                 break;
                            case 'short-answer':
                                groupHTML += `<input type="text" name="q${globalIndex}" class="mt-1 block w-full md:w-1/2 border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Nhập đáp án của bạn...">`;
                                break;
                            case 'essay':
                                groupHTML += `<textarea name="q${globalIndex}" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" rows="5" placeholder="Nhập câu trả lời tự luận của bạn..."></textarea>`;
                                break;
                        }
                        groupHTML += `</div><div id="q-${globalIndex}-feedback" class="mt-4"></div></div>`;
                    });
                    groupHTML += `</div>`;
                    studentQuizContainer.innerHTML += groupHTML;
                });
               
                if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                    MathJax.typesetPromise([studentQuizContainer]);
                }
            }
           
            async function generatePerformanceReview(allAnswersData) {
                const feedbackContainer = document.getElementById('ai-feedback-container');
                if (!feedbackContainer || !ai) return null;
                feedbackContainer.classList.remove('hidden');
                feedbackContainer.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-slate-800 mb-4">📝 Phân Tích & Gợi Ý Từ Trợ Lý AI</h3>
                        <div id="ai-feedback-loader" class="text-center py-6">
                            <svg class="animate-spin mx-auto h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p class="mt-3 text-slate-600">AI đang phân tích bài làm của bạn...</p>
                        </div>
                        <div id="ai-feedback-summary" class="hidden prose prose-sm max-w-none"></div>
                        <div id="ai-feedback-details" class="hidden mt-4 space-y-2"></div>
                    </div>
                `;
               
                const loader = document.getElementById('ai-feedback-loader');
                const summaryDiv = document.getElementById('ai-feedback-summary');
                const detailsDiv = document.getElementById('ai-feedback-details');
                const incorrectAnswers = allAnswersData.filter(a => !a.isCorrect);
                if (incorrectAnswers.length === 0) {
                    feedbackContainer.innerHTML = `
                        <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                            <h3 class="text-xl font-bold text-green-600">🎉 Chúc mừng!</h3>
                            <p class="mt-2 text-slate-700">Bạn đã trả lời đúng tất cả các câu hỏi. Làm tốt lắm!</p>
                        </div>
                    `;
                    return { overallFeedback: { summary: "Xuất sắc! Học sinh đã đã trả lời đúng tất cả các câu hỏi." } };
                }
                const summaryPrompt = `Bạn là một trợ lý giáo viên, nói tiếng Việt. Dựa vào tóm tắt các câu trả lời sai của học sinh, hãy đưa ra một nhận xét tổng quan ngắn gọn (khoảng 3-4 câu) về năng lực của học sinh, bao gồm điểm mạnh (suy luận từ các câu làm đúng), điểm yếu (dựa trên các câu sai) và một vài gợi ý ôn tập chung. Lời văn phải khích lệ, rõ ràng.
                Tóm tắt lỗi sai:
                ${JSON.stringify(incorrectAnswers.map(a => ({ cau: a.questionNumber, loai: a.type, cauHoi: a.question.substring(0, 50) + '...' })), null, 2)}`;
                try {
                    const response = await ai.models.generateContent({
                        model: "gemini-2.5-flash",
                        contents: summaryPrompt
                    });
                    summaryDiv.innerHTML = response.text.replace(/\n/g, '<br>');
                    loader.classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                    detailsDiv.classList.remove('hidden'); 
                } catch (e) {
                    console.error("Lỗi khi lấy nhận xét tổng quan:", e);
                    summaryDiv.innerHTML = '<p class="text-red-600">Lỗi khi tạo nhận xét tổng quan.</p>';
                    loader.classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                }
               
                const summaryForSheet = summaryDiv.innerText.substring(0, 200) + "...";
                return { overallFeedback: { summary: summaryForSheet } };
            }
            async function handleSubmit() {
                if (isSubmitted) return;
                isSubmitted = true;
                clearInterval(timerInterval);
                
                document.querySelectorAll('input, textarea').forEach(input => input.disabled = true);
                submitBtn.classList.add('hidden');
                postSubmitOptions.classList.remove('hidden');
                if (retriesLeft > 0) {
                    retryBtn.classList.remove('hidden');
                } else {
                    retryBtn.classList.add('hidden');
                }

                const proctoringDataString = JSON.stringify(proctoringLog);

                let totalStudentScore = 0;
                let totalCorrectAnswers = 0;
                let allAnswersData = [];
                const questionCounts = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    acc[type] = (acc[type] || 0) + 1;
                    return acc;
                }, {});
                
                quizData.forEach((item, index) => {
                    let questionNumber = index + 1;
                    let answerData = { questionNumber, type: item.type };
                    switch (item.mappedType) {
                        case 'multiple-choice':
                            const selectedOption = document.querySelector(`input[name="q${index}"]:checked`);
                            const isCorrectMC = selectedOption ? parseInt(selectedOption.value) === item.correctAnswerIndex : false;
                            if (isCorrectMC) {
                                totalCorrectAnswers++;
                                if (questionCounts['multiple-choice'] > 0) {
                                   totalStudentScore += quizOptions.scoring.mc / questionCounts['multiple-choice'];
                                }
                            }
                            answerData.question = item.question;
                            answerData.options = item.options;
                            answerData.yourAnswer = selectedOption ? String.fromCharCode(65 + parseInt(selectedOption.value)) : "Không trả lời";
                            answerData.correctAnswer = String.fromCharCode(65 + item.correctAnswerIndex);
                            answerData.isCorrect = isCorrectMC;
                            break;
                        case 'true-false':
                            let correctStatementsCount = 0;
                            let yourAnswerPattern = [];
                            let correctAnswerPattern = [];
                            let details = [];
                            item.statements.forEach((s, i) => {
                                const selectedTF = document.querySelector(`input[name="q${index}-s${i}"]:checked`);
                                const studentChoice = selectedTF ? selectedTF.value === 'true' : null;
                                const isStatementCorrect = studentChoice === s.is_correct;
                               
                                if (isStatementCorrect) correctStatementsCount++;
                               
                                yourAnswerPattern.push(studentChoice === null ? '?' : (studentChoice ? 'Đ' : 'S'));
                                correctAnswerPattern.push(s.is_correct ? 'Đ' : 'S');
                                details.push({ statement: s.statement, yourChoice: studentChoice === null ? 'Không trả lời' : (studentChoice ? 'Đúng' : 'Sai'), correctChoice: s.is_correct ? 'Đúng' : 'Sai', isCorrect: isStatementCorrect });
                            });
                            
                            let scorePerTfQuestion = 0;
                            if (questionCounts['true-false'] > 0) {
                                scorePerTfQuestion = quizOptions.scoring.tf / questionCounts['true-false'];
                            }
                            let questionPoints = 0;
                            if (quizOptions.scoring.tfMethod === 'progressive') {
                                const progressivePoints = { 0: 0, 1: 0.1, 2: 0.25, 3: 0.5, 4: 1.0 };
                                questionPoints = progressivePoints[correctStatementsCount] * scorePerTfQuestion;
                            } else { // even
                                questionPoints = (correctStatementsCount / 4) * scorePerTfQuestion;
                            }
                            totalStudentScore += questionPoints;

                            if(correctStatementsCount === 4) totalCorrectAnswers++;
                            answerData.question = item.main_question;
                            answerData.yourAnswer = yourAnswerPattern.join('-');
                            answerData.correctAnswer = correctAnswerPattern.join('-');
                            answerData.isCorrect = correctStatementsCount === 4;
                            answerData.details = details;
                            break;
                       
                        case 'short-answer':
                            const saInput = document.querySelector(`input[name="q${index}"]`);
                            const studentAnswerRaw = saInput ? (saInput.value ?? '').trim() : "";
                            const correctAnswerRaw = (item.answer ?? '').toString().trim().replace(/\$/g, '');
                            let isCorrectSA = false;
                            const studentAnswerNormalized = studentAnswerRaw.replace(',', '.');
                            const correctAnswerNormalized = correctAnswerRaw.replace(',', '.');
                            if (studentAnswerNormalized.toLowerCase() === correctAnswerNormalized.toLowerCase()) {
                                isCorrectSA = true;
                            }
                             if (isCorrectSA) {
                                totalCorrectAnswers++;
                                if (questionCounts['short-answer'] > 0) {
                                   totalStudentScore += quizOptions.scoring.sa / questionCounts['short-answer'];
                                }
                            }
                            answerData.question = item.question;
                            answerData.yourAnswer = studentAnswerRaw || "Không trả lời";
                            answerData.correctAnswer = correctAnswerRaw;
                            answerData.isCorrect = isCorrectSA;
                            break;
                           
                        case 'essay':
                             const essayInput = document.querySelector(`textarea[name="q${index}"]`);
                             answerData.question = item.question;
                             answerData.yourAnswer = essayInput.value || "Không trả lời";
                             answerData.correctAnswer = item.answer;
                             answerData.isCorrect = null; // Needs manual grading
                             break;
                    }
                    allAnswersData.push(answerData);
                });
                
                const finalScore = totalStudentScore;
                
                let competencyAssessment = "Giáo viên không yêu cầu AI phân tích bài làm.";
                if (quizOptions.aiAssessment) {
                    const feedbackData = await generatePerformanceReview(allAnswersData);
                    if (feedbackData && feedbackData.overallFeedback && feedbackData.overallFeedback.summary) {
                        competencyAssessment = feedbackData.overallFeedback.summary;
                    } else {
                        competencyAssessment = "Có lỗi xảy ra trong quá trình AI phân tích bài làm.";
                    }
                }
                
                if (quizOptions.showAnswers) {
                    const totalQuestions = quizData.length;
                    resultContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg text-center">
                        <h3 class="text-2xl font-bold text-slate-800">KẾT QUẢ BÀI LÀM</h3>
                        <p class="mt-4 text-lg">Số câu đúng hoàn toàn: <span class="font-bold text-green-600">${totalCorrectAnswers}/${totalQuestions}</span></p>
                        <p class="text-2xl mt-2">Điểm (thang 10): <span class="font-bold text-blue-600">${finalScore.toFixed(2)}</span></p>
                        ${questionCounts['essay'] > 0 ? `<p class="text-sm text-gray-600 italic mt-1">Lưu ý: Điểm trên chưa bao gồm ${quizOptions.scoring.essay} điểm của phần Tự luận.</p>` : ''}
                    </div>`;
                    resultContainer.classList.remove('hidden');

                    allAnswersData.forEach((ans, index) => {
                        const questionCard = document.getElementById(`student-q-${index}`);
                        const feedbackIconDiv = document.getElementById(`q-${index}-feedback-icon`);
                        const feedbackDiv = document.getElementById(`q-${index}-feedback`);
                        if (!questionCard || !feedbackIconDiv || !feedbackDiv) return;

                        const iconHTML = ans.isCorrect === true
                            ? '<svg class="feedback-icon text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>'
                            : (ans.isCorrect === false ? '<svg class="feedback-icon text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>' : '');
                        feedbackIconDiv.innerHTML = iconHTML;

                        if (ans.type.includes('multiple-choice')) {
                            const studentChoice = ans.yourAnswer === "Không trả lời" ? -1 : ans.yourAnswer.charCodeAt(0) - 65;
                            const correctChoice = ans.correctAnswer.charCodeAt(0) - 65;
                            document.getElementById(`q-${index}-opt-label${correctChoice}`)?.classList.add('correct');
                            if (studentChoice !== -1 && studentChoice !== correctChoice) {
                                document.getElementById(`q-${index}-opt-label${studentChoice}`)?.classList.add('incorrect');
                            }
                        } else if (ans.type === 'true-false') {
                            const statementItems = questionCard.querySelectorAll('.statement-item');
                            ans.details.forEach((detail, i) => { if(statementItems[i]) { statementItems[i].classList.add(detail.isCorrect ? 'correct' : 'incorrect'); }});
                        }

                        if (quizOptions.showExplanation) {
                            feedbackDiv.innerHTML = `<button data-explain-index="${index}" class="explain-btn mt-4 flex items-center px-4 py-2 bg-blue-100 text-blue-800 text-sm font-semibold rounded-lg hover:bg-blue-200 transition-colors">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Xem giải thích
                            </button>`;
                        }
                    });
                    
                    document.querySelectorAll('.explain-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const button = e.currentTarget;
                            const index = parseInt(button.dataset.explainIndex, 10);
                            showExplanation(index, button);
                        });
                    });

                    if (window.MathJax) await window.MathJax.typesetPromise([studentQuizContainer]);
                } else {
                     resultContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg text-center"><h3 class="text-xl font-bold text-green-600">Nộp bài thành công!</h3><p class="mt-2 text-slate-700">Bạn đã hoàn thành bài làm. Kết quả sẽ được giáo viên công bố sau.</p></div>`;
                    resultContainer.classList.remove('hidden');
                }
                
                const formData = new FormData();
                formData.append('name', studentInfo.name);
                formData.append('class', studentInfo.class);
                formData.append('score', `${finalScore.toFixed(2)}/10`);
                formData.append('assessment', competencyAssessment);
                formData.append('timestamp', new Date().toLocaleString('vi-VN'));
                formData.append('examCode', correctExamCode);
                formData.append('monitoringLog', proctoringDataString);
                formData.append('answerDetails', JSON.stringify(allAnswersData));
               
                fetch(googleScriptUrl, { method: 'POST', body: formData})
                    .then(res => console.log("Successfully submitted to Google Sheet"))
                    .catch(err => console.error("Error submitting to Google Sheet:", err));
            }
           
            function startNewAttempt() {
                isSubmitted = false;
                proctoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0, suKien: [] };
                const proctoringWidget = document.getElementById('proctoring-widget');
                if (proctoringWidget) {
                    proctoringWidget.classList.add('hidden');
                    document.getElementById('tab-switch-count').textContent = '0';
                    document.getElementById('copy-count').textContent = '0';
                    document.getElementById('paste-count').textContent = '0';
                }

                renderStudentQuiz();
                resultContainer.classList.add('hidden');
                document.getElementById('ai-feedback-container').classList.add('hidden');
                postSubmitOptions.classList.add('hidden');
                submitBtn.classList.remove('hidden');
                 if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                }
                retriesLeft--;
                retriesDisplay.textContent = `Lượt làm lại còn: ${retriesLeft}`;
                window.scrollTo(0, 0);
            }
            studentInfoForm.addEventListener('submit', (e) => {
                e.preventDefault();
               
                const enteredCode = document.getElementById('exam-code').value.trim().toUpperCase();
                if (correctExamCode && enteredCode !== correctExamCode) {
                    alert('Mã đề không chính xác. Vui lòng kiểm tra lại!');
                    return;
                }
               
                studentApiKey = teacherApiKey;
                if (!studentApiKey) {
                    console.warn('Cảnh báo: Giáo viên chưa cấu hình API Key. Các tính năng AI sẽ không hoạt động.');
                }
       
                try {
                    if (studentApiKey) {
                       ai = new GoogleGenAI({ apiKey: studentApiKey });
                    }
                } catch(e) {
                    console.error("Lỗi khởi tạo Gemini API với key của giáo viên.", e);
                    alert("Cảnh báo: API Key của giáo viên không hợp lệ. Vui lòng báo cho giáo viên. Các tính năng AI sẽ không hoạt động.");
                    ai = null;
                }
                shuffleQuiz();
               
                studentInfo.name = document.getElementById('student-name').value;
                studentInfo.class = document.getElementById('student-class').value;
                loginModal.classList.add('hidden');
                studentQuizContainer.classList.remove('hidden');
                submitBtn.classList.remove('hidden');
               
                if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                } else {
                    timerDisplay.textContent = "Không giới hạn";
                }
                retriesDisplay.textContent = `Lượt làm lại còn: ${retriesLeft}`;
                renderStudentQuiz();

                const proctoringWidget = document.getElementById('proctoring-widget');
                const tabSwitchCountEl = document.getElementById('tab-switch-count');
                const copyCountEl = document.getElementById('copy-count');
                const pasteCountEl = document.getElementById('paste-count');

                function updateProctoringUI() {
                    if (proctoringLog.thoatManHinh > 0 || proctoringLog.saoChep > 0 || proctoringLog.dan > 0) {
                        proctoringWidget.classList.remove('hidden');
                    }
                    tabSwitchCountEl.textContent = proctoringLog.thoatManHinh;
                    copyCountEl.textContent = proctoringLog.saoChep;
                    pasteCountEl.textContent = proctoringLog.dan;
                }

                // Disable Right Click
                document.addEventListener('contextmenu', e => e.preventDefault());

                // Track Tab Switching
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && !isSubmitted) {
                        proctoringLog.thoatManHinh++;
                        proctoringLog.suKien.push({ loai: 'chuyen_tab', thoiGian: new Date().toISOString() });
                        updateProctoringUI();
                    }
                });

                // Track Copying
                document.addEventListener('copy', () => {
                    if (isSubmitted) return;
                    proctoringLog.saoChep++;
                    proctoringLog.suKien.push({ loai: 'sao_chep', thoiGian: new Date().toISOString() });
                    updateProctoringUI();
                });

                // Track Pasting
                document.addEventListener('paste', () => {
                    if (isSubmitted) return;
                    proctoringLog.dan++;
                    proctoringLog.suKien.push({ loai: 'dan', thoiGian: new Date().toISOString() });
                    updateProctoringUI();
                });
            });
            
            submitBtn.addEventListener('click', handleSubmit);
            retryBtn.addEventListener('click', () => {
                shuffleQuiz();
                startNewAttempt();
            });
        </script>
    </body>
    </html>
    