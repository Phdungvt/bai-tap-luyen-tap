
    <!DOCTYPE html>
    <html lang="vi">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Bài Tập Luyện Tập</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
        <script>
            window.MathJax = {
                tex: {
                    packages: {'[+]': ['ams']},
                    inlineMath: [['$', '$'], ['\\(', '\\)']],
                    displayMath: [['$$', '$$'], ['\\[', '\\]']]
                },
                chtml: {
                    fontCache: 'global',
                    linebreaks: {
                        automatic: true
                    }
                }
            };
        </script>
        <script type="text/javascript" id="MathJax-script" async
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
        </script>
        <style>
            body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #f0f4f8; }
            .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
            @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
            .question-card {
                background-color: white;
                border-radius: 1rem;
                padding: 1.5rem 2rem;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                border-left: 5px solid transparent;
                transition: all 0.3s ease;
            }
            .ai-explanation {
                background-color: #f0f9ff;
                color: #0c4a6e;
                padding: 1rem;
                border-radius: 0.75rem;
                font-size: 0.9rem;
                margin-top: 1rem;
                border-left: 4px solid #38bdf8;
            }
            .feedback-icon { width: 1.5rem; height: 1.5rem; }
            .option-label {
                transition: all 0.2s ease-in-out;
                border: 2px solid #e5e7eb;
            }
            .option-label:hover {
                border-color: #6366f1;
                background-color: #eef2ff;
            }
            .option-label.correct {
                border-color: #10b981 !important;
                background-color: #ecfdf5 !important;
                color: #065f46;
            }
            .option-label.incorrect {
                border-color: #ef4444 !important;
                background-color: #fef2f2 !important;
                color: #991b1b;
            }
            .statement-item.correct { background-color: #ecfdf5; border-color: #10b981; }
            .statement-item.incorrect { background-color: #fef2f2; border-color: #ef4444; }
            .prose { max-width: 100%; }
            .prose h1, .prose h2, .prose h3 { font-weight: 600; }
            .prose p { margin-top: 0.5em; margin-bottom: 0.5em; }
            .prose ul, .prose ol { margin-top: 1em; margin-bottom: 1em; padding-left: 1.5em; }
            .prose li > p { margin-top: 0; margin-bottom: 0; }
            .prose code { background-color: #e5e7eb; padding: 0.2em 0.4em; margin: 0; font-size: 85%; border-radius: 3px; }
            .prose pre { background-color: #e5e7eb; padding: 1em; border-radius: 0.5em; overflow-x: auto; }
            .prose pre code { background-color: transparent; padding: 0; }
            details[open] > summary .details-arrow {
                transform: rotate(180deg);
            }
        </style>
    </head>
    <body class="bg-slate-100 text-slate-800">
        <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md transform transition-all" style="animation: fadeIn 0.3s ease-out;">
                <h2 class="text-2xl font-bold mb-2 text-center text-slate-800">Thông Tin Học Sinh</h2>
                <p class="text-center text-slate-500 mb-6">Vui lòng nhập để bắt đầu làm bài.</p>
                <form id="student-info-form">
                    <div class="mb-4">
                        <label for="student-name" class="block text-sm font-medium text-slate-700 mb-1">Họ và tên</label>
                        <input type="text" id="student-name" required class="mt-1 block w-full block border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="student-class" class="block text-sm font-medium text-slate-700 mb-1">Lớp</label>
                        <input type="text" id="student-class" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="exam-code" class="block text-sm font-medium text-slate-700 mb-1">Mã đề</label>
                        <input type="text" id="exam-code" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Nhập mã đề giáo viên cung cấp">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Giáo viên:</label>
                        <p class="mt-1 text-slate-800 bg-slate-100 p-2.5 rounded-lg">LÊ MỘNG HÒA</p>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">Bắt đầu làm bài</button>
                </form>
            </div>
        </div>
        <div class="container mx-auto p-4 md:p-8 max-w-4xl">
            <header class="mb-10 p-8 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg">
                <div class="flex justify-between items-center flex-wrap gap-4">
                    <div>
                        <h1 class="text-4xl font-bold">Bài Tập Luyện Tập</h1>
                        <p class="text-lg text-blue-100 mt-2">Hãy hoàn thành các câu hỏi dưới đây một cách tốt nhất!</p>
                        <p class="text-sm text-blue-200 mt-4">Tác giả: LÊ MỘNG HÒA</p>
                    </div>
                    <div id="timer-container" class="text-right">
                         <div id="timer-display" class="text-3xl font-bold tracking-wider bg-white/20 px-4 py-2 rounded-lg">--:--</div>
                         <div id="retries-display" class="text-sm mt-1 text-blue-200"></div>
                    </div>
                </div>
            </header>
            <main id="student-quiz-container" class="space-y-8 hidden">
                <!-- Questions will be rendered here by JS -->
            </main>
            <footer class="mt-10 text-center">
                <button id="submit-quiz-btn" class="bg-indigo-600 text-white py-3 px-12 rounded-full font-bold text-lg hover:bg-indigo-700 transition-all duration-300 shadow-lg hover:shadow-xl hidden transform hover:scale-105">Nộp Bài</button>
                <div id="result-container" class="mt-6 hidden"></div>
                <div id="ai-feedback-container" class="mt-8 text-left hidden"></div>
                <div id="post-submit-options" class="hidden mt-6 flex flex-col sm:flex-row items-center justify-center gap-4">
                    <button id="retry-quiz-btn" class="w-full sm:w-auto bg-slate-600 text-white py-2.5 px-6 rounded-lg font-semibold hover:bg-slate-700 transition-transform transform hover:scale-105">Làm Lại Đề Này</button>
                </div>
            </footer>
        </div>

        <div id="proctoring-widget" class="fixed bottom-4 right-4 bg-yellow-100 text-yellow-800 p-3 rounded-lg shadow-lg text-sm z-50 hidden border border-yellow-300" style="max-width: 200px;">
            <h4 class="font-bold mb-2 border-b border-yellow-300 pb-1 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 3.001-1.742 3.001H4.42c-1.53 0-2.493-1.667-1.743-3.001l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                Giám sát
            </h4>
            <p>Thoát màn hình: <span id="tab-switch-count" class="font-bold">0</span></p>
            <p>Sao chép: <span id="copy-count" class="font-bold">0</span></p>
            <p>Dán: <span id="paste-count" class="font-bold">0</span></p>
        </div>

        <script type="module">
            import { GoogleGenAI, Type } from "https://esm.sh/@google/genai@^1.13.0";
            let quizData = [{"type":"multiple-choice","question":"Cho hệ phương trình $ \\begin{cases} y = x - 3 \\\\ 2x + 3y = 1 \\end{cases} $. Nghiệm của hệ là gì?","questionImage":null,"mappedType":"multiple-choice","options":["$(2; -1)$","$(-1; 2)$","$(1; -2)$","$(-2; 1)$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Giải hệ phương trình $ \\begin{cases} 2x - y = 5 \\\\ x + 3y = 6 \\end{cases} $ bằng phương pháp thế.","questionImage":null,"mappedType":"multiple-choice","options":["$(3; 1)$","$(1; 3)$","$(-3; -1)$","$(-1; -3)$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Cặp số nào sau đây là nghiệm của hệ phương trình $ \\begin{cases} 3x + y = 7 \\\\ x - 2y = 0 \\end{cases} $?","questionImage":null,"mappedType":"multiple-choice","options":["$(2; 1)$","$(1; 2)$","$(0; 0)$","$(7; 0)$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Giải hệ phương trình $ \\begin{cases} x + y = 5 \\\\ x - y = 1 \\end{cases} $ bằng phương pháp cộng đại số.","questionImage":null,"mappedType":"multiple-choice","options":["$(3; 2)$","$(2; 3)$","$(1; 4)$","$(4; 1)$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Tìm nghiệm của hệ phương trình $ \\begin{cases} 2x + 3y = 7 \\\\ 2x - y = 3 \\end{cases} $.","questionImage":null,"mappedType":"multiple-choice","options":["$(2; 1)$","$(1; 2)$","$(-2; -1)$","$(-1; -2)$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Nghiệm của hệ phương trình $ \\begin{cases} 3x + 2y = 8 \\\\ 5x - 3y = 7 \\end{cases} $ là:","questionImage":null,"mappedType":"multiple-choice","options":["$(2; 1)$","$(1; 2)$","$(0; 4)$","$(4; -2)$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Cặp số $ (1; -1) $ có phải là nghiệm của hệ phương trình $ \\begin{cases} 3x + 2y = 1 \\\\ x - y = 2 \\end{cases} $ không?","questionImage":null,"mappedType":"multiple-choice","options":["Có","Không","Chỉ là nghiệm của phương trình thứ nhất","Chỉ là nghiệm của phương trình thứ hai"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Khi giải hệ phương trình $ \\begin{cases} 2x + y = 7 \\\\ 3x - 2y = 1 \\end{cases} $ bằng phương pháp thế, bước nào sau đây là đúng nếu ta rút $y$ từ phương trình thứ nhất?","questionImage":null,"mappedType":"multiple-choice","options":["$y = 7 - 2x$ và $3x - 2(7 - 2x) = 1$","$y = 7 - 2x$ và $3x - 2(2x - 7) = 1$","$x = \\frac{7 - y}{2}$ và $3x - 2y = 1$","$y = 2x - 7$ và $3x - 2(2x - 7) = 1$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Để giải hệ phương trình $ \\begin{cases} 4x + y = 11 \\\\ 2x - 3y = -1 \\end{cases} $ bằng phương pháp cộng đại số, ta nên nhân phương trình nào với bao nhiêu để triệt tiêu $y$?","questionImage":null,"mappedType":"multiple-choice","options":["Nhân phương trình thứ nhất với $3$","Nhân phương trình thứ hai với $3$","Nhân phương trình thứ nhất với $2$","Nhân phương trình thứ hai với $2$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Hệ phương trình nào sau đây vô nghiệm?","questionImage":null,"mappedType":"multiple-choice","options":["$ \\begin{cases} x + y = 3 \\\\ x - y = 1 \\end{cases} $","$ \\begin{cases} x + y = 2 \\\\ 2x + 2y = 4 \\end{cases} $","$ \\begin{cases} x + y = 1 \\\\ x + y = 2 \\end{cases} $","$ \\begin{cases} x = 1 \\\\ y = 2 \\end{cases} $"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Tổng số tuổi của hai anh em là $40$ tuổi. Biết anh hơn em $6$ tuổi. Hỏi số tuổi của mỗi người là bao nhiêu?","questionImage":null,"mappedType":"multiple-choice","options":["Anh $23$ tuổi, em $17$ tuổi.","Anh $20$ tuổi, em $20$ tuổi.","Anh $26$ tuổi, em $14$ tuổi.","Anh $22$ tuổi, em $18$ tuổi."],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Lan mua $2$ cây bút bi và $3$ cây thước kẻ hết $23.000$ đồng. Mai mua $3$ cây bút bi và $2$ cây thước kẻ như thế hết $22.000$ đồng. Hỏi giá tiền một cây bút bi và một cây thước kẻ là bao nhiêu?","questionImage":null,"mappedType":"multiple-choice","options":["Bút $4.000$ đồng, thước $5.000$ đồng.","Bút $5.000$ đồng, thước $4.000$ đồng.","Bút $3.000$ đồng, thước $6.000$ đồng.","Bút $4.500$ đồng, thước $4.000$ đồng."],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Hai vòi nước cùng chảy vào một bể cạn thì sau $4$ giờ đầy bể. Nếu chảy riêng, vòi thứ nhất chảy đầy bể nhanh hơn vòi thứ hai là $6$ giờ. Hỏi nếu chảy riêng, mỗi vòi chảy đầy bể trong bao lâu?","questionImage":null,"mappedType":"multiple-choice","options":["Vòi $1$: $6$ giờ, vòi $2$: $12$ giờ.","Vòi $1$: $8$ giờ, vòi $2$: $14$ giờ.","Vòi $1$: $5$ giờ, vòi $2$: $11$ giờ.","Vòi $1$: $10$ giờ, vòi $2$: $16$ giờ."],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Tìm một số có hai chữ số, biết rằng tổng các chữ số của nó bằng $9$, và nếu đổi chỗ hai chữ số cho nhau thì được một số lớn hơn số ban đầu là $27$ đơn vị.","questionImage":null,"mappedType":"multiple-choice","options":["$36$.","$63$.","$27$.","$18$."],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Một ca nô đi xuôi dòng $100$ km hết $4$ giờ. Đi ngược dòng $72$ km hết $3$ giờ. Tính vận tốc riêng của ca nô và vận tốc dòng nước.","questionImage":null,"mappedType":"multiple-choice","options":["Vận tốc ca nô riêng $24,5$ km/h, vận tốc dòng nước $0,5$ km/h.","Vận tốc ca nô riêng $25$ km/h, vận tốc dòng nước $1$ km/h.","Vận tốc ca nô riêng $24$ km/h, vận tốc dòng nước $0,5$ km/h.","Vận tốc ca nô riêng $24$ km/h, vận tốc dòng nước $1$ km/h."],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Một mảnh vườn hình chữ nhật có chu vi là $30$ m. Nếu tăng chiều rộng $3$ m và giảm chiều dài $1$ m thì diện tích mảnh vườn tăng thêm $14$ m$^2$. Tính chiều dài và chiều rộng ban đầu của mảnh vườn.","questionImage":null,"mappedType":"multiple-choice","options":["Chiều dài $8$ m, chiều rộng $7$ m.","Chiều dài $10$ m, chiều rộng $5$ m.","Chiều dài $9$ m, chiều rộng $6$ m.","Chiều dài $7$ m, chiều rộng $8$ m."],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Có hai loại dung dịch muối. Dung dịch thứ nhất chứa $5\text{\textperthousand}$ muối, dung dịch thứ hai chứa $10\text{\textperthousand}$ muối. Cần trộn bao nhiêu gam mỗi loại dung dịch để được $200$ gam dung dịch chứa $8\text{\textperthousand}$ muối?","questionImage":null,"mappedType":"multiple-choice","options":["$80$ g dung dịch $5\text{\textperthousand}$ và $120$ g dung dịch $10\text{\textperthousand}$.","$120$ g dung dịch $5\text{\textperthousand}$ và $80$ g dung dịch $10\text{\textperthousand}$.","$90$ g dung dịch $5\text{\textperthousand}$ và $110$ g dung dịch $10\text{\textperthousand}$.","$100$ g dung dịch $5\text{\textperthousand}$ và $100$ g dung dịch $10\text{\textperthousand}$."],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Hai xí nghiệp theo kế hoạch phải sản xuất tổng cộng $700$ sản phẩm. Thực tế, xí nghiệp $A$ vượt mức $15\text{\textperthousand}$ kế hoạch, xí nghiệp $B$ vượt mức $10\text{\textperthousand}$ kế hoạch, nên tổng cộng cả hai xí nghiệp sản xuất được $780$ sản phẩm. Hỏi theo kế hoạch mỗi xí nghiệp phải sản xuất bao nhiêu sản phẩm?","questionImage":null,"mappedType":"multiple-choice","options":["Xí nghiệp $A$: $200$ sản phẩm, Xí nghiệp $B$: $500$ sản phẩm.","Xí nghiệp $A$: $500$ sản phẩm, Xí nghiệp $B$: $200$ sản phẩm.","Xí nghiệp $A$: $250$ sản phẩm, Xí nghiệp $B$: $450$ sản phẩm.","Xí nghiệp $A$: $300$ sản phẩm, Xí nghiệp $B$: $400$ sản phẩm."],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Một trang trại có tổng cộng $36$ con gồm gà và chó. Tổng số chân của chúng là $100$ chân. Hỏi trang trại có bao nhiêu con gà và bao nhiêu con chó?","questionImage":null,"mappedType":"multiple-choice","options":["$22$ con gà, $14$ con chó.","$14$ con gà, $22$ con chó.","$20$ con gà, $16$ con chó.","$18$ con gà, $18$ con chó."],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Một người gửi tổng cộng $100.000.000$ đồng vào hai tài khoản tiết kiệm khác nhau. Tài khoản thứ nhất có lãi suất $6\\%$ mỗi năm, tài khoản thứ hai có lãi suất $8\\%$ mỗi năm. Sau một năm, tổng số tiền lãi mà người đó nhận được là $7.200.000$ đồng. Hỏi người đó đã gửi bao nhiêu tiền vào mỗi tài khoản?","questionImage":null,"mappedType":"multiple-choice","options":["$40.000.000$ đồng với lãi suất $6\\%$, $60.000.000$ đồng với lãi suất $8\\%$.","$60.000.000$ đồng với lãi suất $6\\%$, $40.000.000$ đồng với lãi suất $8\\%$.","$50.000.000$ đồng với lãi suất $6\\%$, $50.000.000$ đồng với lãi suất $8\\%$.","$30.000.000$ đồng với lãi suất $6\\%$, $70.000.000$ đồng với lãi suất $8\\%$. trăm."],"optionsImage":[],"correctAnswerIndex":0},{"type":"essay","question":"Giải hệ phương trình sau bằng phương pháp thế: $$\\begin{cases} x + y = 7 \\\\ 2x - y = 2 \\end{cases}$$","questionImage":null,"mappedType":"essay","answer":"Gợi ý: Từ phương trình thứ nhất, rút $y$ theo $x$ ta được $y = 7 - x$. Sau đó, thế vào phương trình thứ hai để tìm $x$. Cuối cùng tìm $y$. Nghiệm của hệ là $(x; y) = (3; 4)$."},{"type":"essay","question":"Giải hệ phương trình sau bằng phương pháp cộng đại số: $$\\begin{cases} 3x + 2y = 13 \\\\ 4x - 2y = 8 \\end{cases}$$","questionImage":null,"mappedType":"essay","answer":"Gợi ý: Cộng trực tiếp hai phương trình để khử ẩn $y$. Sau đó tìm $x$, rồi thế $x$ vào một trong hai phương trình ban đầu để tìm $y$. Nghiệm của hệ là $(x; y) = (3; 2)$."},{"type":"essay","question":"Giải hệ phương trình sau bằng phương pháp thế: $$\\begin{cases} 2x - y = 5 \\\\ x + 3y = -1 \\end{cases}$$","questionImage":null,"mappedType":"essay","answer":"Gợi ý: Từ phương trình thứ nhất, rút $y$ theo $x$ ta được $y = 2x - 5$. Sau đó, thế vào phương trình thứ hai để tìm $x$. Cuối cùng tìm $y$. Nghiệm của hệ là $(x; y) = (2; -1)$."},{"type":"essay","question":"Giải hệ phương trình sau bằng phương pháp cộng đại số: $$\\begin{cases} 5x - 3y = 11 \\\\ x + y = 5 \\end{cases}$$","questionImage":null,"mappedType":"essay","answer":"Gợi ý: Nhân phương trình thứ hai với $3$ rồi cộng với phương trình thứ nhất để khử ẩn $y$. Sau đó tìm $x$, rồi thế $x$ vào một trong hai phương trình ban đầu để tìm $y$. Nghiệm của hệ là $(x; y) = (4; 1)$."},{"type":"essay","question":"Giải hệ phương trình sau bằng phương pháp thế: $$\\begin{cases} x - 4y = -10 \\\\ 3x + y = 9 \\end{cases}$$","questionImage":null,"mappedType":"essay","answer":"Gợi ý: Từ phương trình thứ nhất, rút $x$ theo $y$ ta được $x = 4y - 10$. Sau đó, thế vào phương trình thứ hai để tìm $y$. Cuối cùng tìm $x$. Nghiệm của hệ là $(x; y) = (2; 3)$."},{"type":"essay","question":"Giải hệ phương trình sau bằng phương pháp cộng đại số: $$\\begin{cases} 4x + 5y = 14 \\\\ 2x - 3y = 0 \\end{cases}$$","questionImage":null,"mappedType":"essay","answer":"Gợi ý: Nhân phương trình thứ hai với $2$ rồi trừ đi phương trình thứ nhất để khử ẩn $x$. Sau đó tìm $y$, rồi thế $y$ vào một trong hai phương trình ban đầu để tìm $x$. Nghiệm của hệ là $(x; y) = (3; 2)$."},{"type":"essay","question":"Giải hệ phương trình sau bằng phương pháp thế: $$\\begin{cases} 3x + y = 1 \\\\ -x + 2y = 5 \\end{cases}$$","questionImage":null,"mappedType":"essay","answer":"Gợi ý: Từ phương trình thứ nhất, rút $y$ theo $x$ ta được $y = 1 - 3x$. Sau đó, thế vào phương trình thứ hai để tìm $x$. Cuối cùng tìm $y$. Nghiệm của hệ là $(x; y) = (-1; 4)$."},{"type":"essay","question":"Giải hệ phương trình sau bằng phương pháp cộng đại số: $$\\begin{cases} 6x - 2y = 8 \\\\ -3x + 4y = 1 \\end{cases}$$","questionImage":null,"mappedType":"essay","answer":"Gợi ý: Nhân phương trình thứ hai với $2$ rồi cộng với phương trình thứ nhất để khử ẩn $x$. Sau đó tìm $y$, rồi thế $y$ vào một trong hai phương trình ban đầu để tìm $x$. Nghiệm của hệ là $(x; y) = (3; 5)$."},{"type":"essay","question":"Giải hệ phương trình sau bằng phương pháp thế: $$\\begin{cases} 5x + 2y = 12 \\\\ x = 2y - 4 \\end{cases}$$","questionImage":null,"mappedType":"essay","answer":"Gợi ý: Từ phương trình thứ hai, đã có $x$ theo $y$. Thế trực tiếp $x = 2y - 4$ vào phương trình thứ nhất để tìm $y$. Cuối cùng tìm $x$. Nghiệm của hệ là $(x; y) = (0; 6)$."},{"type":"essay","question":"Giải hệ phương trình sau bằng phương pháp cộng đại số: $$\\begin{cases} 2x + 7y = 9 \\\\ 5x - 3y = 2 \\end{cases}$$","questionImage":null,"mappedType":"essay","answer":"Gợi ý: Nhân phương trình thứ nhất với $5$, phương trình thứ hai với $2$. Sau đó trừ hai phương trình mới để khử ẩn $x$. Sau đó tìm $y$, rồi thế $y$ vào một trong hai phương trình ban đầu để tìm $x$. Nghiệm của hệ là $(x; y) = (1; 1)$."},{"type":"essay","question":"Tìm một số tự nhiên có hai chữ số, biết rằng tổng các chữ số của nó bằng $9$. Nếu đổi chỗ hai chữ số cho nhau thì được số mới lớn hơn số ban đầu là $27$ đơn vị. Hỏi số tự nhiên đó là số nào?","questionImage":null,"mappedType":"essay","answer":"Gợi ý: Gọi chữ số hàng chục là $x$ và chữ số hàng đơn vị là $y$. Lập hệ phương trình dựa trên hai điều kiện đã cho: $x+y=9$ và $(10y+x)-(10x+y)=27$. Giải hệ phương trình để tìm $x$ và $y$."},{"type":"essay","question":"Hiện tại, tuổi của cha gấp $4$ lần tuổi của con. Cách đây $5$ năm, tuổi cha gấp $9$ lần tuổi con. Tính tuổi của mỗi người hiện nay.","questionImage":null,"mappedType":"essay","answer":"Gợi ý: Gọi tuổi hiện tại của cha là $x$ và tuổi hiện tại của con là $y$. Lập hệ phương trình dựa trên điều kiện \"Hiện tại, tuổi của cha gấp $4$ lần tuổi của con\" ($x=4y$) và \"Cách đây $5$ năm, tuổi cha gấp $9$ lần tuổi con\" ($x-5=9(y-5)$)."},{"type":"essay","question":"Hai đội công nhân cùng làm chung một công việc và hoàn thành trong $12$ ngày. Nếu đội $A$ làm riêng trong $4$ ngày, rồi đội $B$ làm tiếp trong $10$ ngày thì hoàn thành $\frac{2}{3}$ công việc. Hỏi nếu làm riêng, mỗi đội hoàn thành công việc đó trong bao nhiêu ngày?","questionImage":null,"mappedType":"essay","answer":"Gợi ý: Gọi $x$ (ngày) là thời gian đội $A$ làm một mình xong việc, $y$ (ngày) là thời gian đội $B$ làm một mình xong việc. Năng suất làm việc của đội $A$ là $\frac{1}{x}$ (công việc/ngày) và của đội $B$ là $\frac{1}{y}$ (công việc/ngày).\n\nKhi hai đội làm chung, năng suất chung là $\frac{1}{x} + \frac{1}{y}$. Hoàn thành công việc trong $12$ ngày nghĩa là:\n$$\\frac{1}{x} + \\frac{1}{y} = \\frac{1}{12}$$\nKhi đội $A$ làm riêng trong $4$ ngày và đội $B$ làm tiếp trong $10$ ngày, họ hoàn thành $\\frac{2}{3}$ công việc:\n$$\\frac{4}{x} + \\frac{10}{y} = \\frac{2}{3}$$\nTừ đó, ta có hệ phương trình:\n$$\\begin{cases}\n\\frac{1}{x} + \\frac{1}{y} = \\frac{1}{12} \\\\\n\\frac{4}{x} + \\frac{10}{y} = \\frac{2}{3}\n\\end{cases}$$\nGiải hệ phương trình trên để tìm $x$ và $y$."},{"type":"multiple-choice","question":"Cần pha bao nhiêu gam dung dịch muối $10^{\\circ}/_o$ và bao nhiêu gam dung dịch muối $40^{\\circ}/_o$ để được $150$ gam dung dịch muối $28^{\\circ}/_o$?","questionImage":null,"mappedType":"multiple-choice","options":["$60$ gam dung dịch muối $10^{\\circ}/_o$ và $90$ gam dung dịch muối $40^{\\circ}/_o$.","$90$ gam dung dịch muối $10^{\\circ}/_o$ và $60$ gam dung dịch muối $40^{\\circ}/_o$.","$75$ gam dung dịch muối $10^{\\circ}/_o$ và $75$ gam dung dịch muối $40^{\\circ}/_o$.","$50$ gam dung dịch muối $10^{\\circ}/_o$ và $100$ gam dung dịch muối $40^{\\circ}/_o$."],"optionsImage":[],"correctAnswerIndex":0},{"type":"essay","question":"Một ca nô xuôi dòng sông từ bến $A$ đến bến $B$ mất $2$ giờ $20$ phút, và ngược dòng từ bến $B$ về bến $A$ mất $3$ giờ $15$ phút. Biết vận tốc dòng nước là $4$ km/h. Tính vận tốc riêng của ca nô và khoảng cách giữa hai bến $A$, $B$.","questionImage":null,"mappedType":"essay","answer":"Gợi ý: Đổi thời gian về giờ (ví dụ: $2$ giờ $20$ phút = $\\frac{7}{3}$ giờ, $3$ giờ $15$ phút = $\\frac{13}{4}$ giờ). Gọi vận tốc riêng của ca nô là $x$ (km/h) và khoảng cách $AB$ là $y$ (km). Lập hệ phương trình dựa trên công thức $S=v \\times t$: $\\frac{y}{x+4}=\\frac{7}{3}$ và $\\frac{y}{x-4}=\\frac{13}{4}$."},{"type":"essay","question":"Một hình chữ nhật có chu vi là $72$ m. Nếu tăng chiều dài thêm $6$ m và giảm chiều rộng đi $2$ m thì diện tích của nó tăng thêm $18$ m$^2$. Tính chiều dài và chiều rộng của hình chữ nhật ban đầu.","questionImage":null,"mappedType":"essay","answer":"Gợi ý: Gọi chiều dài là $x$ (m) và chiều rộng là $y$ (m). Lập hệ phương trình: $2(x+y)=72$ (chu vi) và $(x+6)(y-2) - xy = 18$ (diện tích thay đổi)."},{"type":"essay","question":"Một cửa hàng bán $2$ loại bánh với giá khác nhau. Ngày thứ nhất bán được $20$ hộp bánh loại $X$ và $15$ hộp bánh loại $Y$, thu về được $9.750.000$ đồng. Ngày thứ hai bán được $12$ hộp bánh loại $X$ và $10$ hộp bánh loại $Y$, thu về được $6.100.000$ đồng. Hỏi giá tiền mỗi loại bánh là bao nhiêu?","questionImage":null,"mappedType":"essay","answer":"Gợi ý: Gọi giá một hộp bánh loại $X$ là $x$ (đồng) và giá một hộp bánh loại $Y$ là $y$ (đồng). Lập hệ phương trình: $20x+15y=9.750.000$ và $12x+10y=6.100.000$."},{"type":"essay","question":"Một người gửi tổng cộng $120$ triệu đồng vào hai ngân hàng với hai kì hạn khác nhau. Sau một năm, tổng số tiền lãi người đó nhận được là $9,9$ triệu đồng. Biết rằng lãi suất ở ngân hàng thứ nhất là $7,5^{\text{o}}\text{/}\text{o}$ một năm, ngân hàng thứ hai là $9^{\text{o}}\text{/}\text{o}$ một năm. Hỏi người đó đã gửi vào mỗi ngân hàng bao nhiêu tiền?","questionImage":null,"mappedType":"essay","answer":"Gợi ý: Gọi $x$ (triệu đồng) là số tiền gửi vào ngân hàng thứ nhất và $y$ (triệu đồng) là số tiền gửi vào ngân hàng thứ hai. Lập hệ phương trình: $x+y=120$ và $0,075x+0,09y=9,9$."},{"type":"essay","question":"Hai xe đạp khởi hành cùng lúc từ hai địa điểm $A$ và $B$ cách nhau $160$ km, đi ngược chiều nhau và gặp nhau sau $2,5$ giờ. Tìm vận tốc của mỗi xe, biết rằng nếu xe đi từ $A$ tăng vận tốc thêm $8$ km/h thì hai xe sẽ gặp nhau tại chính giữa quãng đường $AB$.","questionImage":null,"mappedType":"essay","answer":"Gợi ý: Gọi vận tốc xe đi từ $A$ là $v_A$ (km/h) và vận tốc xe đi từ $B$ là $v_B$ (km/h). Lập hệ phương trình: $2,5(v_A+v_B)=160$ và (cho trường hợp gặp nhau ở giữa) $\frac{80}{v_A+8}=\frac{80}{v_B}$ (thời gian gặp nhau bằng nhau) dẫn đến $v_A+8=v_B$."},{"type":"essay","question":"Một cửa hàng nhập về $350$ kg gạo nếp và gạo tẻ. Giá nhập $1$ kg gạo nếp là $18.000$ đồng, giá nhập $1$ kg gạo tẻ là $15.000$ đồng. Tổng số tiền nhập hàng là $5.700.000$ đồng. Hỏi cửa hàng đã nhập về bao nhiêu kg mỗi loại gạo?","questionImage":null,"mappedType":"essay","answer":"Gợi ý: Gọi $x$ (kg) là khối lượng gạo nếp và $y$ (kg) là khối lượng gạo tẻ. Lập hệ phương trình: $x+y=350$ và $18000x+15000y=5.700.000$."},{"type":"essay","question":"Hai ca nô khởi hành cùng lúc từ hai bến sông $A$ và $B$ cách nhau $120$ km, đi ngược chiều nhau và gặp nhau sau $2$ giờ. Biết rằng vận tốc của ca nô xuất phát từ $A$ lớn hơn vận tốc của ca nô xuất phát từ $B$ là $6$ km/h. Hãy tính vận tốc riêng của mỗi ca nô khi nước yên lặng.","questionImage":null,"mappedType":"essay","answer":"Gọi vận tốc ca nô từ $A$ là $v_A$ (km/h) và vận tốc ca nô từ $B$ là $v_B$ (km/h). Điều kiện $v_A > 0$, $v_B > 0$. Theo đề bài ta có hệ phương trình: $$ \\begin{cases} v_A + v_B = \\frac{120}{2} \\\\ v_A - v_B = 6 \\end{cases} \\Rightarrow \\begin{cases} v_A + v_B = 60 \\\\ v_A - v_B = 6 \\end{cases} $$ Cộng hai phương trình ta được $2v_A = 66 \\Rightarrow v_A = 33$. Thay vào phương trình thứ nhất ta được $33 + v_B = 60 \\Rightarrow v_B = 27$. Vậy vận tốc ca nô từ $A$ là $33$ km/h, vận tốc ca nô từ $B$ là $27$ km/h."},{"type":"essay","question":"Giải hệ phương trình sau bằng phương pháp thế: $$ \\begin{cases} x - 3y = 7 \\\\ 2x + 5y = -8 \\end{cases} $$","questionImage":null,"mappedType":"essay","answer":"Từ phương trình thứ nhất, ta có $x = 3y + 7$. Thay vào phương trình thứ hai: $2(3y + 7) + 5y = -8 \\Rightarrow 6y + 14 + 5y = -8 \\Rightarrow 11y = -22 \\Rightarrow y = -2$. Thay $y = -2$ vào $x = 3y + 7$: $x = 3(-2) + 7 = -6 + 7 = 1$. Vậy nghiệm của hệ phương trình là $(x; y) = (1; -2)$."},{"type":"essay","question":"Giải hệ phương trình sau bằng phương pháp cộng đại số: $$ \\begin{cases} 4x + 3y = -1 \\\\ 5x + 2y = 4 \\end{cases} $$","questionImage":null,"mappedType":"essay","answer":"Nhân phương trình thứ nhất với $2$, phương trình thứ hai với $3$, ta được: $$ \\begin{cases} 8x + 6y = -2 \\\\ 15x + 6y = 12 \\end{cases} $$ Trừ phương trình thứ nhất cho phương trình thứ hai (hoặc ngược lại): $(8x + 6y) - (15x + 6y) = -2 - 12 \\Rightarrow -7x = -14 \\Rightarrow x = 2$. Thay $x = 2$ vào phương trình $4x + 3y = -1$: $4(2) + 3y = -1 \\Rightarrow 8 + 3y = -1 \\Rightarrow 3y = -9 \\Rightarrow y = -3$. Vậy nghiệm của hệ phương trình là $(x; y) = (2; -3)$."},{"type":"essay","question":"Một cửa hàng bán tổng cộng $150$ chiếc điện thoại di động và máy tính bảng trong một tháng. Doanh thu từ điện thoại là $120$ triệu đồng, và doanh thu từ máy tính bảng là $100$ triệu đồng. Biết rằng giá mỗi chiếc điện thoại là $4$ triệu đồng và giá mỗi chiếc máy tính bảng là $5$ triệu đồng. Hãy tính số lượng điện thoại và máy tính bảng đã bán trong tháng đó.","questionImage":null,"mappedType":"essay","answer":"Gọi $x$ là số điện thoại đã bán và $y$ là số máy tính bảng đã bán. Điều kiện $x, y \\in \\mathbb{N}^*$. Theo đề bài ta có hệ phương trình: $$ \\begin{cases} x + y = 150 \\\\ 4x + 5y = \\frac{120 \\times 10^6 + 100 \\times 10^6}{10^6} \\end{cases} \\Rightarrow \\begin{cases} x + y = 150 \\\\ 4x + 5y = 220 \\end{cases} $$ Từ phương trình thứ nhất, $x = 150 - y$. Thay vào phương trình thứ hai: $4(150 - y) + 5y = 220 \\Rightarrow 600 - 4y + 5y = 220 \\Rightarrow y = 220 - 600 \\Rightarrow y = -380$. (Lỗi đề bài: Doanh thu không khớp với số lượng và giá tiền. Sửa lại đề để có nghiệm dương). Nếu đề bài sửa lại thành: Tổng doanh thu là $620$ triệu đồng. Giá mỗi chiếc điện thoại là $4$ triệu đồng và giá mỗi chiếc máy tính bảng là $5$ triệu đồng. $$ \\begin{cases} x + y = 150 \\\\ 4x + 5y = 620 \\end{cases} $$ Từ phương trình thứ nhất, $x = 150 - y$. Thay vào phương trình thứ hai: $4(150 - y) + 5y = 620 \\Rightarrow 600 - 4y + 5y = 620 \\Rightarrow y = 20$. Suy ra $x = 150 - 20 = 130$. Vậy cửa hàng đã bán $130$ điện thoại và $20$ máy tính bảng."},{"type":"essay","question":"Tìm hai số tự nhiên, biết rằng tổng của chúng bằng $105$ và nếu lấy số lớn chia cho số bé thì được thương là $4$ và số dư là $5$.","questionImage":null,"mappedType":"essay","answer":"Gọi hai số tự nhiên cần tìm là $x$ và $y$, với $x > y$. Điều kiện $x, y \\in \\mathbb{N}$. Theo đề bài ta có hệ phương trình: $$ \\begin{cases} x + y = 105 \\\\ x = 4y + 5 \\end{cases} $$ Thay phương trình thứ hai vào phương trình thứ nhất: $(4y + 5) + y = 105 \\Rightarrow 5y + 5 = 105 \\Rightarrow 5y = 100 \\Rightarrow y = 20$. Thay $y = 20$ vào $x = 4y + 5$: $x = 4(20) + 5 = 80 + 5 = 85$. Vậy hai số cần tìm là $85$ và $20$."},{"type":"essay","question":"Hai vòi nước cùng chảy vào một bể không có nước thì sau $4$ giờ đầy bể. Nếu vòi thứ nhất chảy trong $3$ giờ và vòi thứ hai chảy trong $6$ giờ thì đầy bể. Hỏi nếu mỗi vòi chảy riêng thì sau bao lâu sẽ đầy bể?","questionImage":null,"mappedType":"essay","answer":"Gợi ý: Gọi thời gian vòi thứ nhất chảy riêng đầy bể là $x$ (giờ), thời gian vòi thứ hai chảy riêng đầy bể là $y$ (giờ). Đơn vị công việc mỗi giờ của vòi 1 là $\\frac{1}{x}$, vòi 2 là $\\frac{1}{y}$. Lập hệ phương trình: $\\left\\{ \\begin{array}{l} \\frac{1}{x} + \\frac{1}{y} = \\frac{1}{4} \\\\ 3\\frac{1}{x} + 6\\frac{1}{y} = 1 \\end{array} \\right.$. Giải hệ ta được $x=6$ giờ, $y=12$ giờ."},{"type":"essay","question":"Hai ô tô khởi hành cùng một lúc từ hai địa điểm $A$ và $B$ cách nhau $120$ km và đi ngược chiều nhau. Sau $1,5$ giờ thì chúng gặp nhau. Tìm vận tốc của mỗi ô tô, biết rằng vận tốc của ô tô đi từ $A$ lớn hơn vận tốc của ô tô đi từ $B$ là $10$ km/h.","questionImage":null,"mappedType":"essay","answer":"Gợi ý: Gọi vận tốc của ô tô đi từ $A$ là $x$ (km/h) và vận tốc của ô tô đi từ $B$ là $y$ (km/h). Lập hệ phương trình: $\\left\\{ \\begin{array}{l} x - y = 10 \\\\ 1,5x + 1,5y = 120 \\end{array} \\right.$. Giải hệ ta được $x = 45$ km/h, $y = 35$ km/h."},{"type":"essay","question":"Tìm một số tự nhiên có hai chữ số, biết rằng tổng các chữ số của nó bằng $12$. Nếu đổi chỗ hai chữ số cho nhau thì được một số mới lớn hơn số ban đầu là $18$ đơn vị.","questionImage":null,"mappedType":"essay","answer":"Gợi ý: Gọi chữ số hàng chục là $x$ và chữ số hàng đơn vị là $y$. Số ban đầu là $10x+y$. Số mới là $10y+x$. Lập hệ phương trình: $\\left\\{ \\begin{array}{l} x + y = 12 \\\\ (10y+x) - (10x+y) = 18 \\end{array} \\right.$. Giải hệ ta được $x=5$, $y=7$. Số cần tìm là $57$."},{"type":"essay","question":"Một cửa hàng bán $6$ chiếc áo sơ mi và $4$ chiếc quần âu với giá $1.160.000$ đồng. Cửa hàng đó bán $3$ chiếc áo sơ mi và $5$ chiếc quần âu cùng loại với giá $970.000$ đồng. Hỏi giá tiền một chiếc áo sơ mi và một chiếc quần âu là bao nhiêu?","questionImage":null,"mappedType":"essay","answer":"Gợi ý: Gọi giá một chiếc áo sơ mi là $x$ (đồng) và giá một chiếc quần âu là $y$ (đồng). Lập hệ phương trình: $\\left\\{ \\begin{array}{l} 6x + 4y = 1.160.000 \\\\ 3x + 5y = 970.000 \\end{array} \\right.$. Giải hệ ta được $x=100.000$ đồng, $y=140.000$ đồng."},{"type":"essay","question":"Một khu vườn hình chữ nhật có chu vi là $160$ m. Nếu tăng chiều rộng thêm $10$ m và giảm chiều dài đi $20$ m thì diện tích khu vườn không đổi. Tính chiều dài và chiều rộng ban đầu của khu vườn.","questionImage":null,"mappedType":"essay","answer":"Gợi ý: Gọi chiều dài ban đầu là $a$ (m) và chiều rộng ban đầu là $b$ (m). Lập hệ phương trình: $\\left\\{ \\begin{array}{l} 2(a+b) = 160 \\\\ (a-20)(b+10) = ab \\end{array} \\right.$. Giải hệ ta được $a=60$ m, $b=20$ m."}];
            const quizOptions = {"timeLimit":60,"retriesAllowed":1,"showAnswers":true,"showExplanation":true,"aiAssessment":true,"scoring":{"mc":10,"tf":0,"sa":0,"essay":0,"tfMethod":"progressive"}};
            const googleScriptUrl = "https://ai-quiz.io.vn/?utm_source=zalo&utm_medium=zalo&utm_campaign=zalo";
            const correctExamCode = "AQGRB0";
            const teacherApiKey = "025883436";
            let studentInfo = {};
            let isSubmitted = false;
            let timerInterval;
            let retriesLeft = quizOptions.retriesAllowed;
            let studentApiKey = "";
            let ai = null;

            let proctoringLog = {
                thoatManHinh: 0,
                saoChep: 0,
                dan: 0,
                suKien: []
            };

            const studentQuizContainer = document.getElementById('student-quiz-container');
            const submitBtn = document.getElementById('submit-quiz-btn');
            const resultContainer = document.getElementById('result-container');
            const postSubmitOptions = document.getElementById('post-submit-options');
            const retryBtn = document.getElementById('retry-quiz-btn');
            const loginModal = document.getElementById('login-modal');
            const studentInfoForm = document.getElementById('student-info-form');
            const timerDisplay = document.getElementById('timer-display');
            const retriesDisplay = document.getElementById('retries-display');
            function shuffleQuiz() {
                // Shuffle options/statements within each question first
                quizData.forEach(item => {
                    // Shuffle multiple-choice options and their corresponding images
                    if (item.mappedType === 'multiple-choice' && item.options && item.options.length > 0) {
                        const correctAnswerText = item.options[item.correctAnswerIndex];
                        let optionsWithImages = item.options.map((opt, index) => ({
                            text: opt,
                            image: (item.optionsImage && item.optionsImage[index]) ? item.optionsImage[index] : null
                        }));
                        // Fisher-Yates shuffle
                        for (let i = optionsWithImages.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [optionsWithImages[i], optionsWithImages[j]] = [optionsWithImages[j], optionsWithImages[i]];
                        }
                        // Update the item with shuffled data
                        item.options = optionsWithImages.map(opt => opt.text);
                        item.optionsImage = optionsWithImages.map(opt => opt.image);
                        item.correctAnswerIndex = item.options.indexOf(correctAnswerText);
                    }
                    // Shuffle true-false statements
                    if (item.mappedType === 'true-false' && item.statements && item.statements.length > 0) {
                         for (let i = item.statements.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [item.statements[i], item.statements[j]] = [item.statements[j], item.statements[i]];
                        }
                    }
                });
                // Then, group questions by type and shuffle within each group
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});
                let shuffledQuizData = [];
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    if (grouped[partType]) {
                        const partQuestions = grouped[partType];
                        for (let i = partQuestions.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [partQuestions[i], partQuestions[j]] = [partQuestions[j], partQuestions[i]];
                        }
                        shuffledQuizData = shuffledQuizData.concat(partQuestions);
                    }
                });
               
                quizData = shuffledQuizData;
            }
            // --- Timer Function ---
            function startTimer(duration, display) {
                let timer = duration, minutes, seconds;
                clearInterval(timerInterval); // Clear any existing timer
                if(duration <= 0) {
                     display.textContent = "∞";
                     return;
                }
                timerInterval = setInterval(function () {
                    minutes = parseInt(timer / 60, 10);
                    seconds = parseInt(timer % 60, 10);
                    minutes = minutes < 10 ? "0" + minutes : minutes;
                    seconds = seconds < 10 ? "0" + seconds : seconds;
                    display.textContent = minutes + ":" + seconds;
                    if (--timer < 0) {
                        clearInterval(timerInterval);
                        alert("Hết giờ làm bài!");
                        handleSubmit();
                    }
                }, 1000);
            }
            
            async function showExplanation(index, button) {
                const item = quizData[index];
                const questionCard = document.getElementById(`student-q-${index}`);
                const feedbackDiv = document.getElementById(`q-${index}-feedback`);
                if (!questionCard || !feedbackDiv) return;

                const existingExplanation = feedbackDiv.querySelector('.ai-explanation');
                if (existingExplanation) {
                    existingExplanation.remove();
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Xem giải thích
                    `;
                    return;
                }

                button.disabled = true;
                button.innerHTML = '<div class="loader mr-2"></div> Đang tải...';

                if (item.explanation) {
                    displayExplanation(item.explanation, feedbackDiv, button);
                    return;
                }

                if (!ai) {
                    alert("Tính năng giải thích yêu cầu API Key, nhưng chưa được cấu hình bởi giáo viên.");
                    button.disabled = false;
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Xem giải thích
                    `;
                    return;
                }

                const questionText = item.question || item.main_question;
                let prompt = `Bạn là một trợ lý giáo viên AI, am hiểu sâu sắc Chương trình GDPT 2018. Hãy cung cấp một lời giải chi tiết, từng bước một cho câu hỏi sau đây. Lời giải phải chính xác, dễ hiểu và phù hợp với phương pháp giảng dạy của chương trình học, TUYỆT ĐỐI KHÔNG sử dụng kiến thức của lớp cao hơn để giải thích.\n\n--- CÂU HỎI ---\n${questionText}\n\n`;
                if (item.mappedType === 'multiple-choice') {
                    prompt += `--- CÁC LỰA CHỌN ---\n${item.options.map((opt, i) => `${String.fromCharCode(65 + i)}. ${opt}`).join('\n')}\n\n`;
                    prompt += `--- ĐÁP ÁN ĐÚNG ---\n${String.fromCharCode(65 + item.correctAnswerIndex)}. ${item.options[item.correctAnswerIndex]}`;
                } else if (item.mappedType === 'true-false') {
                    prompt += `--- CÁC MỆNH ĐỀ & ĐÁP ÁN ---\n${item.statements.map(s => ` - ${s.statement} -> ${s.is_correct ? 'Đúng' : 'Sai'}`).join('\n')}`;
                } else {
                    prompt += `--- ĐÁP ÁN / GỢI Ý ---\n${item.answer}`;
                }
                prompt += `\n\n--- YÊU CẦU ---\nGiải thích rõ ràng tại sao đáp án lại đúng, từng bước một. Định dạng tất cả các công thức toán học bằng LaTeX.`;

                try {
                    const response = await ai.models.generateContent({ model: "gemini-2.5-flash", contents: prompt });
                    const explanationText = response.text.replace(/\n/g, '<br>');
                    item.explanation = explanationText; // Cache it
                    displayExplanation(explanationText, feedbackDiv, button);
                } catch (error) {
                    console.error("Lỗi khi tạo giải thích:", error);
                    feedbackDiv.insertAdjacentHTML('beforeend', '<div class="ai-explanation text-red-600">Lỗi: Không thể tạo giải thích.</div>');
                    button.disabled = false;
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Thử lại
                    `;
                }
            }

            function displayExplanation(explanationText, container, button) {
                container.insertAdjacentHTML('beforeend', `<div class="ai-explanation prose prose-sm">${explanationText}</div>`);
                if (window.MathJax) MathJax.typesetPromise([container]);
                button.disabled = false;
                button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    Ẩn giải thích
                `;
            }
           
            function renderStudentQuiz() {
                studentQuizContainer.innerHTML = '';
               
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});
                const groupInfo = {
                    'multiple-choice': { title: 'PHẦN I. TRẮC NGHIỆM KHÁCH QUAN', subtitle: 'Chọn đáp án đúng nhất trong các lựa chọn sau.' },
                    'true-false': { title: 'PHẦN II. CÂU HỎI ĐÚNG - SAI', subtitle: 'Xác định tính đúng hoặc sai cho mỗi mệnh đề dưới đây.' },
                    'short-answer': { title: 'PHẦN III. CÂU HỎI TRẢ LỜI NGẮN', subtitle: 'Điền đáp án ngắn gọn vào phần trả lời.' },
                    'essay': { title: 'PHẦN IV. CÂU HỎI TỰ LUẬN', subtitle: 'Trình bày chi tiết bài giải của bạn.' }
                };
               
                let questionCounter = 0;
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    const questions = grouped[partType];
                    if (!questions || questions.length === 0) return;
                   
                    let groupHTML = `<div class="group-container space-y-8 mb-12">`;
                    const info = groupInfo[partType];
                    groupHTML += `
                        <div class="group-header pb-3 border-b-2 border-slate-300 mb-6">
                            <h2 class="text-2xl font-bold text-slate-800">${info.title}</h2>
                            ${info.subtitle ? `<p class="text-md text-slate-600 italic mt-1">${info.subtitle}</p>` : ''}
                        </div>
                    `;
                    questions.forEach((item, localIndex) => {
                        const globalIndex = quizData.indexOf(item);
                        questionCounter++;
                        groupHTML += `<div class="question-card" id="student-q-${globalIndex}">`;
                        let questionText = (item.question || item.main_question || '').replace(/\n/g, '<br>');
                       
                        groupHTML += `<div class="flex items-start">
                                     <div class="flex-grow">
                                         <div class="flex items-center mb-2">
                                             <span class="font-bold text-lg mr-3 text-indigo-600">Câu ${questionCounter}:</span>
                                             <div id="q-${globalIndex}-feedback-icon"></div>
                                         </div>
                                         <div class="question-content mt-2 text-lg text-slate-700">${questionText}</div>
                                         ${item.questionImage ? `<img src="${item.questionImage}" class="mt-4 rounded-lg max-w-full md:max-w-md border shadow-sm">` : ''}
                                     </div>
                                 </div>`;
                       
                        groupHTML += `<div class="mt-6">`;
                        switch(item.mappedType) {
                            case 'multiple-choice':
                                groupHTML += `<div class="options-grid grid grid-cols-1 md:grid-cols-2 gap-4">`;
                                item.options.forEach((opt, i) => {
                                    groupHTML += `<label for="q${globalIndex}-opt${i}" id="q${globalIndex}-opt-label${i}" class="option-label flex items-start p-4 border-2 rounded-xl cursor-pointer hover:bg-indigo-50 hover:border-indigo-400">
                                                     <input type="radio" name="q${globalIndex}" id="q${globalIndex}-opt${i}" value="${i}" class="flex-shrink-0 mt-1 h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                                     <div class="ml-3 flex-grow">
                                                         <span class="font-semibold text-slate-800">${String.fromCharCode(65 + i)}.</span>
                                                         <span class="option-content text-slate-700">${opt || ''}</span>
                                                         ${(item.optionsImage && item.optionsImage[i]) ? `<img src="${item.optionsImage[i]}" class="mt-2 rounded-lg max-w-xs border shadow-sm">` : ''}
                                                     </div>
                                                 </label>`;
                                });
                                groupHTML += `</div>`;
                                break;
                            case 'true-false':
                                 groupHTML += `<div class="space-y-4">`;
                                 item.statements.forEach((s, i) => {
                                     groupHTML += `<div class="statement-item border-t pt-4">
                                                  <p class="mb-3 text-slate-700">${String.fromCharCode(97 + i)}) ${s.statement || ''}</p>
                                                  <div class="flex gap-x-6">
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="true" class="mr-2 h-4 w-4"> Đúng</label>
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="false" class="mr-2 h-4 w-4"> Sai</label>
                                                  </div>
                                              </div>`;
                                 });
                                 groupHTML += `</div>`;
                                 break;
                            case 'short-answer':
                                groupHTML += `<input type="text" name="q${globalIndex}" class="mt-1 block w-full md:w-1/2 border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Nhập đáp án của bạn...">`;
                                break;
                            case 'essay':
                                groupHTML += `<textarea name="q${globalIndex}" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" rows="5" placeholder="Nhập câu trả lời tự luận của bạn..."></textarea>`;
                                break;
                        }
                        groupHTML += `</div><div id="q-${globalIndex}-feedback" class="mt-4"></div></div>`;
                    });
                    groupHTML += `</div>`;
                    studentQuizContainer.innerHTML += groupHTML;
                });
               
                if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                    MathJax.typesetPromise([studentQuizContainer]);
                }
            }
           
            async function generatePerformanceReview(allAnswersData) {
                const feedbackContainer = document.getElementById('ai-feedback-container');
                if (!feedbackContainer || !ai) return null;
                feedbackContainer.classList.remove('hidden');
                feedbackContainer.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-slate-800 mb-4">📝 Phân Tích & Gợi Ý Từ Trợ Lý AI</h3>
                        <div id="ai-feedback-loader" class="text-center py-6">
                            <svg class="animate-spin mx-auto h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p class="mt-3 text-slate-600">AI đang phân tích bài làm của bạn...</p>
                        </div>
                        <div id="ai-feedback-summary" class="hidden prose prose-sm max-w-none"></div>
                        <div id="ai-feedback-details" class="hidden mt-4 space-y-2"></div>
                    </div>
                `;
               
                const loader = document.getElementById('ai-feedback-loader');
                const summaryDiv = document.getElementById('ai-feedback-summary');
                const detailsDiv = document.getElementById('ai-feedback-details');
                const incorrectAnswers = allAnswersData.filter(a => !a.isCorrect);
                if (incorrectAnswers.length === 0) {
                    feedbackContainer.innerHTML = `
                        <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                            <h3 class="text-xl font-bold text-green-600">🎉 Chúc mừng!</h3>
                            <p class="mt-2 text-slate-700">Bạn đã trả lời đúng tất cả các câu hỏi. Làm tốt lắm!</p>
                        </div>
                    `;
                    return { overallFeedback: { summary: "Xuất sắc! Học sinh đã đã trả lời đúng tất cả các câu hỏi." } };
                }
                const summaryPrompt = `Bạn là một trợ lý giáo viên, nói tiếng Việt. Dựa vào tóm tắt các câu trả lời sai của học sinh, hãy đưa ra một nhận xét tổng quan ngắn gọn (khoảng 3-4 câu) về năng lực của học sinh, bao gồm điểm mạnh (suy luận từ các câu làm đúng), điểm yếu (dựa trên các câu sai) và một vài gợi ý ôn tập chung. Lời văn phải khích lệ, rõ ràng.
                Tóm tắt lỗi sai:
                ${JSON.stringify(incorrectAnswers.map(a => ({ cau: a.questionNumber, loai: a.type, cauHoi: a.question.substring(0, 50) + '...' })), null, 2)}`;
                try {
                    const response = await ai.models.generateContent({
                        model: "gemini-2.5-flash",
                        contents: summaryPrompt
                    });
                    summaryDiv.innerHTML = response.text.replace(/\n/g, '<br>');
                    loader.classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                    detailsDiv.classList.remove('hidden'); 
                } catch (e) {
                    console.error("Lỗi khi lấy nhận xét tổng quan:", e);
                    summaryDiv.innerHTML = '<p class="text-red-600">Lỗi khi tạo nhận xét tổng quan.</p>';
                    loader.classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                }
               
                const summaryForSheet = summaryDiv.innerText.substring(0, 200) + "...";
                return { overallFeedback: { summary: summaryForSheet } };
            }
            async function handleSubmit() {
                if (isSubmitted) return;
                isSubmitted = true;
                clearInterval(timerInterval);
                
                document.querySelectorAll('input, textarea').forEach(input => input.disabled = true);
                submitBtn.classList.add('hidden');
                postSubmitOptions.classList.remove('hidden');
                if (retriesLeft > 0) {
                    retryBtn.classList.remove('hidden');
                } else {
                    retryBtn.classList.add('hidden');
                }

                const proctoringDataString = JSON.stringify(proctoringLog);

                let totalStudentScore = 0;
                let totalCorrectAnswers = 0;
                let allAnswersData = [];
                const questionCounts = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    acc[type] = (acc[type] || 0) + 1;
                    return acc;
                }, {});
                
                quizData.forEach((item, index) => {
                    let questionNumber = index + 1;
                    let answerData = { questionNumber, type: item.type };
                    switch (item.mappedType) {
                        case 'multiple-choice':
                            const selectedOption = document.querySelector(`input[name="q${index}"]:checked`);
                            const isCorrectMC = selectedOption ? parseInt(selectedOption.value) === item.correctAnswerIndex : false;
                            if (isCorrectMC) {
                                totalCorrectAnswers++;
                                if (questionCounts['multiple-choice'] > 0) {
                                   totalStudentScore += quizOptions.scoring.mc / questionCounts['multiple-choice'];
                                }
                            }
                            answerData.question = item.question;
                            answerData.options = item.options;
                            answerData.yourAnswer = selectedOption ? String.fromCharCode(65 + parseInt(selectedOption.value)) : "Không trả lời";
                            answerData.correctAnswer = String.fromCharCode(65 + item.correctAnswerIndex);
                            answerData.isCorrect = isCorrectMC;
                            break;
                        case 'true-false':
                            let correctStatementsCount = 0;
                            let yourAnswerPattern = [];
                            let correctAnswerPattern = [];
                            let details = [];
                            item.statements.forEach((s, i) => {
                                const selectedTF = document.querySelector(`input[name="q${index}-s${i}"]:checked`);
                                const studentChoice = selectedTF ? selectedTF.value === 'true' : null;
                                const isStatementCorrect = studentChoice === s.is_correct;
                               
                                if (isStatementCorrect) correctStatementsCount++;
                               
                                yourAnswerPattern.push(studentChoice === null ? '?' : (studentChoice ? 'Đ' : 'S'));
                                correctAnswerPattern.push(s.is_correct ? 'Đ' : 'S');
                                details.push({ statement: s.statement, yourChoice: studentChoice === null ? 'Không trả lời' : (studentChoice ? 'Đúng' : 'Sai'), correctChoice: s.is_correct ? 'Đúng' : 'Sai', isCorrect: isStatementCorrect });
                            });
                            
                            let scorePerTfQuestion = 0;
                            if (questionCounts['true-false'] > 0) {
                                scorePerTfQuestion = quizOptions.scoring.tf / questionCounts['true-false'];
                            }
                            let questionPoints = 0;
                            if (quizOptions.scoring.tfMethod === 'progressive') {
                                const progressivePoints = { 0: 0, 1: 0.1, 2: 0.25, 3: 0.5, 4: 1.0 };
                                questionPoints = progressivePoints[correctStatementsCount] * scorePerTfQuestion;
                            } else { // even
                                questionPoints = (correctStatementsCount / 4) * scorePerTfQuestion;
                            }
                            totalStudentScore += questionPoints;

                            if(correctStatementsCount === 4) totalCorrectAnswers++;
                            answerData.question = item.main_question;
                            answerData.yourAnswer = yourAnswerPattern.join('-');
                            answerData.correctAnswer = correctAnswerPattern.join('-');
                            answerData.isCorrect = correctStatementsCount === 4;
                            answerData.details = details;
                            break;
                       
                        case 'short-answer':
                            const saInput = document.querySelector(`input[name="q${index}"]`);
                            const studentAnswerRaw = saInput ? (saInput.value ?? '').trim() : "";
                            const correctAnswerRaw = (item.answer ?? '').toString().trim().replace(/\$/g, '');
                            let isCorrectSA = false;
                            const studentAnswerNormalized = studentAnswerRaw.replace(',', '.');
                            const correctAnswerNormalized = correctAnswerRaw.replace(',', '.');
                            if (studentAnswerNormalized.toLowerCase() === correctAnswerNormalized.toLowerCase()) {
                                isCorrectSA = true;
                            }
                             if (isCorrectSA) {
                                totalCorrectAnswers++;
                                if (questionCounts['short-answer'] > 0) {
                                   totalStudentScore += quizOptions.scoring.sa / questionCounts['short-answer'];
                                }
                            }
                            answerData.question = item.question;
                            answerData.yourAnswer = studentAnswerRaw || "Không trả lời";
                            answerData.correctAnswer = correctAnswerRaw;
                            answerData.isCorrect = isCorrectSA;
                            break;
                           
                        case 'essay':
                             const essayInput = document.querySelector(`textarea[name="q${index}"]`);
                             answerData.question = item.question;
                             answerData.yourAnswer = essayInput.value || "Không trả lời";
                             answerData.correctAnswer = item.answer;
                             answerData.isCorrect = null; // Needs manual grading
                             break;
                    }
                    allAnswersData.push(answerData);
                });
                
                const finalScore = totalStudentScore;
                
                let competencyAssessment = "Giáo viên không yêu cầu AI phân tích bài làm.";
                if (quizOptions.aiAssessment) {
                    const feedbackData = await generatePerformanceReview(allAnswersData);
                    if (feedbackData && feedbackData.overallFeedback && feedbackData.overallFeedback.summary) {
                        competencyAssessment = feedbackData.overallFeedback.summary;
                    } else {
                        competencyAssessment = "Có lỗi xảy ra trong quá trình AI phân tích bài làm.";
                    }
                }
                
                if (quizOptions.showAnswers) {
                    const totalQuestions = quizData.length;
                    resultContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg text-center">
                        <h3 class="text-2xl font-bold text-slate-800">KẾT QUẢ BÀI LÀM</h3>
                        <p class="mt-4 text-lg">Số câu đúng hoàn toàn: <span class="font-bold text-green-600">${totalCorrectAnswers}/${totalQuestions}</span></p>
                        <p class="text-2xl mt-2">Điểm (thang 10): <span class="font-bold text-blue-600">${finalScore.toFixed(2)}</span></p>
                        ${questionCounts['essay'] > 0 ? `<p class="text-sm text-gray-600 italic mt-1">Lưu ý: Điểm trên chưa bao gồm ${quizOptions.scoring.essay} điểm của phần Tự luận.</p>` : ''}
                    </div>`;
                    resultContainer.classList.remove('hidden');

                    allAnswersData.forEach((ans, index) => {
                        const questionCard = document.getElementById(`student-q-${index}`);
                        const feedbackIconDiv = document.getElementById(`q-${index}-feedback-icon`);
                        const feedbackDiv = document.getElementById(`q-${index}-feedback`);
                        if (!questionCard || !feedbackIconDiv || !feedbackDiv) return;

                        const iconHTML = ans.isCorrect === true
                            ? '<svg class="feedback-icon text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>'
                            : (ans.isCorrect === false ? '<svg class="feedback-icon text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>' : '');
                        feedbackIconDiv.innerHTML = iconHTML;

                        if (ans.type.includes('multiple-choice')) {
                            const studentChoice = ans.yourAnswer === "Không trả lời" ? -1 : ans.yourAnswer.charCodeAt(0) - 65;
                            const correctChoice = ans.correctAnswer.charCodeAt(0) - 65;
                            document.getElementById(`q-${index}-opt-label${correctChoice}`)?.classList.add('correct');
                            if (studentChoice !== -1 && studentChoice !== correctChoice) {
                                document.getElementById(`q-${index}-opt-label${studentChoice}`)?.classList.add('incorrect');
                            }
                        } else if (ans.type === 'true-false') {
                            const statementItems = questionCard.querySelectorAll('.statement-item');
                            ans.details.forEach((detail, i) => { if(statementItems[i]) { statementItems[i].classList.add(detail.isCorrect ? 'correct' : 'incorrect'); }});
                        }

                        if (quizOptions.showExplanation) {
                            feedbackDiv.innerHTML = `<button data-explain-index="${index}" class="explain-btn mt-4 flex items-center px-4 py-2 bg-blue-100 text-blue-800 text-sm font-semibold rounded-lg hover:bg-blue-200 transition-colors">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Xem giải thích
                            </button>`;
                        }
                    });
                    
                    document.querySelectorAll('.explain-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const button = e.currentTarget;
                            const index = parseInt(button.dataset.explainIndex, 10);
                            showExplanation(index, button);
                        });
                    });

                    if (window.MathJax) await window.MathJax.typesetPromise([studentQuizContainer]);
                } else {
                     resultContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg text-center"><h3 class="text-xl font-bold text-green-600">Nộp bài thành công!</h3><p class="mt-2 text-slate-700">Bạn đã hoàn thành bài làm. Kết quả sẽ được giáo viên công bố sau.</p></div>`;
                    resultContainer.classList.remove('hidden');
                }
                
                const formData = new FormData();
                formData.append('name', studentInfo.name);
                formData.append('class', studentInfo.class);
                formData.append('score', `${finalScore.toFixed(2)}/10`);
                formData.append('assessment', competencyAssessment);
                formData.append('timestamp', new Date().toLocaleString('vi-VN'));
                formData.append('examCode', correctExamCode);
                formData.append('monitoringLog', proctoringDataString);
                formData.append('answerDetails', JSON.stringify(allAnswersData));
               
                fetch(googleScriptUrl, { method: 'POST', body: formData})
                    .then(res => console.log("Successfully submitted to Google Sheet"))
                    .catch(err => console.error("Error submitting to Google Sheet:", err));
            }
           
            function startNewAttempt() {
                isSubmitted = false;
                proctoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0, suKien: [] };
                const proctoringWidget = document.getElementById('proctoring-widget');
                if (proctoringWidget) {
                    proctoringWidget.classList.add('hidden');
                    document.getElementById('tab-switch-count').textContent = '0';
                    document.getElementById('copy-count').textContent = '0';
                    document.getElementById('paste-count').textContent = '0';
                }

                renderStudentQuiz();
                resultContainer.classList.add('hidden');
                document.getElementById('ai-feedback-container').classList.add('hidden');
                postSubmitOptions.classList.add('hidden');
                submitBtn.classList.remove('hidden');
                 if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                }
                retriesLeft--;
                retriesDisplay.textContent = `Lượt làm lại còn: ${retriesLeft}`;
                window.scrollTo(0, 0);
            }
            studentInfoForm.addEventListener('submit', (e) => {
                e.preventDefault();
               
                const enteredCode = document.getElementById('exam-code').value.trim().toUpperCase();
                if (correctExamCode && enteredCode !== correctExamCode) {
                    alert('Mã đề không chính xác. Vui lòng kiểm tra lại!');
                    return;
                }
               
                studentApiKey = teacherApiKey;
                if (!studentApiKey) {
                    console.warn('Cảnh báo: Giáo viên chưa cấu hình API Key. Các tính năng AI sẽ không hoạt động.');
                }
       
                try {
                    if (studentApiKey) {
                       ai = new GoogleGenAI({ apiKey: studentApiKey });
                    }
                } catch(e) {
                    console.error("Lỗi khởi tạo Gemini API với key của giáo viên.", e);
                    alert("Cảnh báo: API Key của giáo viên không hợp lệ. Vui lòng báo cho giáo viên. Các tính năng AI sẽ không hoạt động.");
                    ai = null;
                }
                shuffleQuiz();
               
                studentInfo.name = document.getElementById('student-name').value;
                studentInfo.class = document.getElementById('student-class').value;
                loginModal.classList.add('hidden');
                studentQuizContainer.classList.remove('hidden');
                submitBtn.classList.remove('hidden');
               
                if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                } else {
                    timerDisplay.textContent = "Không giới hạn";
                }
                retriesDisplay.textContent = `Lượt làm lại còn: ${retriesLeft}`;
                renderStudentQuiz();

                const proctoringWidget = document.getElementById('proctoring-widget');
                const tabSwitchCountEl = document.getElementById('tab-switch-count');
                const copyCountEl = document.getElementById('copy-count');
                const pasteCountEl = document.getElementById('paste-count');

                function updateProctoringUI() {
                    if (proctoringLog.thoatManHinh > 0 || proctoringLog.saoChep > 0 || proctoringLog.dan > 0) {
                        proctoringWidget.classList.remove('hidden');
                    }
                    tabSwitchCountEl.textContent = proctoringLog.thoatManHinh;
                    copyCountEl.textContent = proctoringLog.saoChep;
                    pasteCountEl.textContent = proctoringLog.dan;
                }

                // Disable Right Click
                document.addEventListener('contextmenu', e => e.preventDefault());

                // Track Tab Switching
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && !isSubmitted) {
                        proctoringLog.thoatManHinh++;
                        proctoringLog.suKien.push({ loai: 'chuyen_tab', thoiGian: new Date().toISOString() });
                        updateProctoringUI();
                    }
                });

                // Track Copying
                document.addEventListener('copy', () => {
                    if (isSubmitted) return;
                    proctoringLog.saoChep++;
                    proctoringLog.suKien.push({ loai: 'sao_chep', thoiGian: new Date().toISOString() });
                    updateProctoringUI();
                });

                // Track Pasting
                document.addEventListener('paste', () => {
                    if (isSubmitted) return;
                    proctoringLog.dan++;
                    proctoringLog.suKien.push({ loai: 'dan', thoiGian: new Date().toISOString() });
                    updateProctoringUI();
                });
            });
            
            submitBtn.addEventListener('click', handleSubmit);
            retryBtn.addEventListener('click', () => {
                shuffleQuiz();
                startNewAttempt();
            });
        </script>
    </body>
    </html>
    