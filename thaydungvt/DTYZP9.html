
    <!DOCTYPE html>
    <html lang="vi">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>B√†i t·∫≠p 24/9/2025</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
        <script>
            window.MathJax = {
                tex: {
                    inlineMath: [['$', '$'], ['\\(', '\\)']],
                    displayMath: [['$$', '$$'], ['\\[', '\\]']]
                },
                chtml: {
                    fontCache: 'global',
                    linebreaks: {
                        automatic: true
                    }
                }
            };
        </script>
        <script type="text/javascript" id="MathJax-script" async
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
        </script>
        <style>
            body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #f0f4f8; }
            .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
            @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
            .question-card { 
                background-color: white; 
                border-radius: 1rem; 
                padding: 1.5rem 2rem; 
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                border-left: 5px solid transparent;
                transition: all 0.3s ease;
            }
            .ai-explanation { 
                background-color: #f0f9ff; 
                color: #0c4a6e;
                padding: 1rem; 
                border-radius: 0.75rem; 
                font-size: 0.9rem; 
                margin-top: 1rem; 
                border-left: 4px solid #38bdf8;
            }
            .feedback-icon { width: 1.5rem; height: 1.5rem; }
            .option-label {
                transition: all 0.2s ease-in-out;
                border: 2px solid #e5e7eb;
            }
            .option-label:hover {
                border-color: #6366f1;
                background-color: #eef2ff;
            }
            .option-label.correct { 
                border-color: #10b981 !important; 
                background-color: #ecfdf5 !important; 
                color: #065f46;
            }
            .option-label.incorrect { 
                border-color: #ef4444 !important; 
                background-color: #fef2f2 !important;
                color: #991b1b;
            }
            .statement-item.correct { background-color: #ecfdf5; border-color: #10b981; }
            .statement-item.incorrect { background-color: #fef2f2; border-color: #ef4444; }
            .tts-btn { transition: all 0.2s ease; }
            .tts-btn:hover { background-color: #e0e7ff; }
            .tts-btn.playing { color: #4f46e5; }
            .prose { max-width: 100%; }
            .prose h1, .prose h2, .prose h3 { font-weight: 600; }
            .prose p { margin-top: 0.5em; margin-bottom: 0.5em; }
            .prose ul, .prose ol { margin-top: 1em; margin-bottom: 1em; padding-left: 1.5em; }
            .prose li > p { margin-top: 0; margin-bottom: 0; }
            .prose code { background-color: #e5e7eb; padding: 0.2em 0.4em; margin: 0; font-size: 85%; border-radius: 3px; }
            .prose pre { background-color: #e5e7eb; padding: 1em; border-radius: 0.5em; overflow-x: auto; }
            .prose pre code { background-color: transparent; padding: 0; }
            details[open] > summary .details-arrow {
                transform: rotate(180deg);
            }
        </style>
    </head>
    <body class="bg-slate-100 text-slate-800">
        <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md transform transition-all" style="animation: fadeIn 0.3s ease-out;">
                <h2 class="text-2xl font-bold mb-2 text-center text-slate-800">Th√¥ng Tin H·ªçc Sinh</h2>
                <p class="text-center text-slate-500 mb-6">Vui l√≤ng nh·∫≠p ƒë·ªÉ b·∫Øt ƒë·∫ßu l√†m b√†i.</p>
                <form id="student-info-form">
                    <div class="mb-4">
                        <label for="student-name" class="block text-sm font-medium text-slate-700 mb-1">H·ªç v√† t√™n</label>
                        <input type="text" id="student-name" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="student-class" class="block text-sm font-medium text-slate-700 mb-1">L·ªõp</label>
                        <input type="text" id="student-class" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="exam-code" class="block text-sm font-medium text-slate-700 mb-1">M√£ ƒë·ªÅ</label>
                        <input type="text" id="exam-code" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Nh·∫≠p m√£ ƒë·ªÅ gi√°o vi√™n cung c·∫•p">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Gi√°o vi√™n:</label>
                        <p class="mt-1 text-slate-800 bg-slate-100 p-2.5 rounded-lg">sdsf</p>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">B·∫Øt ƒë·∫ßu l√†m b√†i</button>
                </form>
            </div>
        </div>

        <div class="container mx-auto p-4 md:p-8 max-w-4xl">
            <header class="mb-10 p-8 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg">
                <div class="flex justify-between items-center flex-wrap gap-4">
                    <div>
                        <h1 class="text-4xl font-bold">B√†i t·∫≠p 24/9/2025</h1>
                        <p class="text-lg text-blue-100 mt-2">H√£y ho√†n th√†nh c√°c c√¢u h·ªèi d∆∞·ªõi ƒë√¢y m·ªôt c√°ch t·ªët nh·∫•t!</p>
                        <p class="text-sm text-blue-200 mt-4">T√°c gi·∫£: sdsf</p>
                    </div>
                    <div id="timer-container" class="text-right">
                         <div id="timer-display" class="text-3xl font-bold tracking-wider bg-white/20 px-4 py-2 rounded-lg">--:--</div>
                         <div id="retries-display" class="text-sm mt-1 text-blue-200"></div>
                    </div>
                </div>
            </header>
            <main id="student-quiz-container" class="space-y-8 hidden">
                <!-- Questions will be rendered here by JS -->
            </main>
            <footer class="mt-10 text-center">
                <button id="submit-quiz-btn" class="bg-indigo-600 text-white py-3 px-12 rounded-full font-bold text-lg hover:bg-indigo-700 transition-all duration-300 shadow-lg hover:shadow-xl hidden transform hover:scale-105">N·ªôp B√†i</button>
                <div id="result-container" class="mt-6 hidden"></div>
                <div id="ai-feedback-container" class="mt-8 text-left hidden"></div>
                <div id="post-submit-options" class="hidden mt-6 flex flex-col sm:flex-row items-center justify-center gap-4">
                    <button id="retry-quiz-btn" class="w-full sm:w-auto bg-slate-600 text-white py-2.5 px-6 rounded-lg font-semibold hover:bg-slate-700 transition-transform transform hover:scale-105">L√†m L·∫°i ƒê·ªÅ N√†y</button>
                </div>
            </footer>
        </div>

        <script type="module">
            import { GoogleGenAI, Type } from "https://esm.sh/@google/genai@^1.13.0";

            let quizData = [{"type":"multiple-choice","question":"Cho h√†m s·ªë $y = x^3 - 3x^2 + 5$. M·ªánh ƒë·ªÅ n√†o d∆∞·ªõi ƒë√¢y ƒë√∫ng?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["H√†m s·ªë ƒë·ªìng bi·∫øn tr√™n kho·∫£ng $(0; 2)$.","H√†m s·ªë ngh·ªãch bi·∫øn tr√™n kho·∫£ng $(0; 2)$.","H√†m s·ªë ƒë·ªìng bi·∫øn tr√™n kho·∫£ng $(-\\frac{1}{2}; 1)$.","H√†m s·ªë ngh·ªãch bi·∫øn tr√™n kho·∫£ng $(2; +\\infty)$."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Cho h√†m s·ªë $y = -x^4 + 2x^2 - 3$. M·ªánh ƒë·ªÅ n√†o d∆∞·ªõi ƒë√¢y ƒë√∫ng?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["H√†m s·ªë ƒë·ªìng bi·∫øn tr√™n kho·∫£ng $(-\\&infty; -1)$.","H√†m s·ªë ngh·ªãch bi·∫øn tr√™n kho·∫£ng $(0; 1)$.","H√†m s·ªë ƒë·ªìng bi·∫øn tr√™n kho·∫£ng $(1; +\\&infty)$.","H√†m s·ªë ngh·ªãch bi·∫øn tr√™n kho·∫£ng $(-1; 0)$. "],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Cho h√†m s·ªë $y = \\frac{2x+1}{x-1}$. M·ªánh ƒë·ªÅ n√†o d∆∞·ªõi ƒë√¢y ƒë√∫ng?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["H√†m s·ªë ƒë·ªìng bi·∫øn tr√™n kho·∫£ng $(1; +\\&infty)$.","H√†m s·ªë ƒë·ªìng bi·∫øn tr√™n kho·∫£ng $(-\\infty; 1)$.","H√†m s·ªë ngh·ªãch bi·∫øn tr√™n kho·∫£ng $(-\\infty; 1)$ v√† $(1; +\\&infty)$.","H√†m s·ªë ƒë·ªìng bi·∫øn tr√™n $(-\\infty; +\\&infty) \\setminus \\{1\\}$."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Cho h√†m s·ªë $y = x^3 - 6x^2 + 9x + 1$. ƒêi·ªÉm c·ª±c ƒë·∫°i c·ªßa h√†m s·ªë l√†:","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["$x = 1$","$x = 3$","$x = 0$","Kh√¥ng c√≥ ƒëi·ªÉm c·ª±c ƒë·∫°i."],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Gi√° tr·ªã c·ª±c ti·ªÉu c·ªßa h√†m s·ªë $y = -x^4 + 2x^2 + 5$ l√†:","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["$5$","$6$","$2$","Kh√¥ng c√≥ gi√° tr·ªã c·ª±c ti·ªÉu."],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"H√†m s·ªë $y = \\frac{x-2}{x+1}$ c√≥ bao nhi√™u ƒëi·ªÉm c·ª±c tr·ªã?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["$0$","$1$","$2$","$3$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Cho h√†m s·ªë $y = f(x)$ c√≥ b·∫£ng bi·∫øn thi√™n nh∆∞ sau:$$ \\begin{array}{c|ccccccc} x & -\\infty & & 0 & & 2 & & +\\infty \\\\ \\hline f'(x) & & + & 0 & - & 0 & + & \\\\ \\hline f(x) & & \\nearrow & 3 & \\searrow & -1 & \\nearrow & \\end{array} $$H√†m s·ªë ƒë·ªìng bi·∫øn tr√™n kho·∫£ng n√†o d∆∞·ªõi ƒë√¢y?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["$(0; 2)$","$(-\\infty; 0)$","$(-\\infty; 2)$","$(0; +\\infty)$"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Cho h√†m s·ªë $y = f(x)$ c√≥ b·∫£ng bi·∫øn thi√™n nh∆∞ sau:$$ \\begin{array}{c|ccccccc} x & -\\infty & & 0 & & 2 & & +\\infty \\\\ \\hline f'(x) & & + & 0 & - & 0 & + & \\\\ \\hline f(x) & & \\nearrow & 3 & \\searrow & -1 & \\nearrow & \\end{array} $$Gi√° tr·ªã c·ª±c ƒë·∫°i c·ªßa h√†m s·ªë l√†:","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["$x=0$","$y=3$","$x=2$","$y=-1$"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Cho h√†m s·ªë $y = f(x)$ c√≥ b·∫£ng bi·∫øn thi√™n nh∆∞ sau:$$ \\begin{array}{c|cc||ccc} x & -\\infty & & 1 & & +\\infty \\\\ \\hline f'(x) & & - & & - & \\\\ \\hline f(x) & +\\infty & \\searrow & & \\searrow & 2 \\end{array} $$H√†m s·ªë ngh·ªãch bi·∫øn tr√™n kho·∫£ng n√†o d∆∞·ªõi ƒë√¢y?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["$(-\\infty; 1)$","$(1; +\\infty)$","$(-\\infty; +\\infty)$","$(-\\infty; 1)$ v√† $(1; +\\infty)$"],"optionsImage":[],"correctAnswerIndex":3},{"type":"multiple-choice","question":"Cho h√†m s·ªë $y = f(x)$ c√≥ b·∫£ng bi·∫øn thi√™n nh∆∞ sau:$$ \\begin{array}{c|cc||ccc} x & -\\infty & & 1 & & +\\infty \\\\ \\hline f'(x) & & - & & - & \\\\ \\hline f(x) & 2 & \\searrow & & \\searrow & 2 \\end{array} $$H√†m s·ªë ƒë√£ cho c√≥ bao nhi√™u ƒëi·ªÉm c·ª±c tr·ªã?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["$0$","$1$","$2$","$3$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Cho h√†m s·ªë $y=f(x)$ c√≥ b·∫£ng bi·∫øn thi√™n nh∆∞ sau:$$\\begin{array}{c|ccccccc}x & -\\infty & & 0 & & 2 & & +\\infty \\\\ \\hline f'(x) & & + & 0 & - & 0 & + & \\\\ \\hline f(x) & -\\infty & \\nearrow & 5 & \\searrow & 1 & \\nearrow & +\\infty \\end{array}$$Kh·∫≥ng ƒë·ªãnh n√†o sau ƒë√¢y l√† SAI?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["H√†m s·ªë ƒë·∫°t c·ª±c ƒë·∫°i t·∫°i $x=0$.","H√†m s·ªë ƒë·∫°t c·ª±c ti·ªÉu t·∫°i $x=2$.","H√†m s·ªë ƒë·ªìng bi·∫øn tr√™n kho·∫£ng $(-\\infty; 5)$.","H√†m s·ªë ngh·ªãch bi·∫øn tr√™n kho·∫£ng $(0; 2)$."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Cho h√†m s·ªë $y=f(x)$ li√™n t·ª•c tr√™n $\\mathbb{R} \\setminus \\{1\\}$ v√† c√≥ b·∫£ng bi·∫øn thi√™n nh∆∞ sau:$$\\begin{array}{c|ccccccc}x & -\\infty & & 0 & & 1 & & 2 & & +\\infty \\\\ \\hline f'(x) & & + & 0 & - & || & - & 0 & + & \\\\ \\hline f(x) & & \\nearrow & -3 & \\searrow & || & \\searrow & 1 & \\nearrow & \\end{array}$$Kh·∫≥ng ƒë·ªãnh n√†o sau ƒë√¢y l√† ƒê√öNG?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["H√†m s·ªë c√≥ gi√° tr·ªã c·ª±c ƒë·∫°i b·∫±ng $1$.","H√†m s·ªë ngh·ªãch bi·∫øn tr√™n kho·∫£ng $(-\\infty; 1)$.","ƒêi·ªÉm c·ª±c ti·ªÉu c·ªßa h√†m s·ªë l√† $x=2$.","H√†m s·ªë ƒë·ªìng bi·∫øn tr√™n kho·∫£ng $(0; 1)$."],"optionsImage":[],"correctAnswerIndex":2}];
            const quizOptions = {"timeLimit":45,"retriesAllowed":1,"showAnswers":false,"showExplanation":false,"scoring":{"mc":5,"sa":2,"essay":1,"tfMethod":"progressive"}};
            const apiKey = "AIzaSyAFszbgk4jn4W3yKG1Ruq9w6lckwSvXy3s"; 
            const googleScriptUrl = "https://script.google.com/macros/s/AKfycbwySChC78GoE29SaqLvHl0TvvY5fJQhdbsEw5zQxB7s3nO60swLHa9BCKqIgvhzdgq-0w/exec";
            const correctExamCode = "DTYZP9";
            let studentInfo = {};
            let isSubmitted = false;
            let timerInterval;
            let retriesLeft = quizOptions.retriesAllowed;
            let currentAudio = null; // To manage audio playback
            let ai = null;
            if (apiKey) {
                try {
                    ai = new GoogleGenAI({ apiKey });
                } catch(e) {
                    console.error("Invalid API Key provided for student page.", e);
                }
            }

            function formatAndCleanLatex(text) {
                if (!text || typeof text !== 'string') return text;
                let formattedText = text.replace(/\[/g, '$').replace(/\]/g, '$');
                formattedText = formattedText.replace(/\$(.*?)\$/g, (match, content) => `$ ${content.trim()} $`);
                formattedText = formattedText.replace(/\$\$(.*?)\$\$/gs, (match, content) => `$$ ${content.trim()} $$`);
                return formattedText;
            }

            const studentQuizContainer = document.getElementById('student-quiz-container');
            const submitBtn = document.getElementById('submit-quiz-btn');
            const resultContainer = document.getElementById('result-container');
            const postSubmitOptions = document.getElementById('post-submit-options');
            const retryBtn = document.getElementById('retry-quiz-btn');
            const loginModal = document.getElementById('login-modal');
            const studentInfoForm = document.getElementById('student-info-form');
            const timerDisplay = document.getElementById('timer-display');
            const retriesDisplay = document.getElementById('retries-display');

            function shuffleQuestions() {
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});

                let shuffledQuizData = [];
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];

                partOrder.forEach(partType => {
                    if (grouped[partType]) {
                        const partQuestions = grouped[partType];
                        for (let i = partQuestions.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [partQuestions[i], partQuestions[j]] = [partQuestions[j], partQuestions[i]];
                        }
                        shuffledQuizData = shuffledQuizData.concat(partQuestions);
                    }
                });
                
                quizData = shuffledQuizData;
            }

            // --- Timer Function ---
            function startTimer(duration, display) {
                let timer = duration, minutes, seconds;
                clearInterval(timerInterval); // Clear any existing timer
                if(duration <= 0) {
                     display.textContent = "‚àû";
                     return;
                }
                timerInterval = setInterval(function () {
                    minutes = parseInt(timer / 60, 10);
                    seconds = parseInt(timer % 60, 10);

                    minutes = minutes < 10 ? "0" + minutes : minutes;
                    seconds = seconds < 10 ? "0" + seconds : seconds;

                    display.textContent = minutes + ":" + seconds;

                    if (--timer < 0) {
                        clearInterval(timerInterval);
                        alert("H·∫øt gi·ªù l√†m b√†i!");
                        handleSubmit();
                    }
                }, 1000);
            }

            // --- Gemini API Caller (for TTS) ---
            async function callGeminiAPI(payload, apiKey, model = 'gemini-2.5-flash-preview-tts') {
                 if (!apiKey) {
                    alert("API Key kh√¥ng h·ª£p l·ªá. Kh√¥ng th·ªÉ th·ª±c hi·ªán y√™u c·∫ßu.");
                    return null;
                }
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
                
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`API Error: ${errorBody.error?.message || response.status}`);
                    }
                    
                    const result = await response.json();
                    const candidate = result.candidates && result.candidates[0];

                    if (candidate && candidate.content && candidate.content.parts && candidate.content.parts[0]) {
                        return candidate.content.parts[0]; // Return the whole part
                    } else {
                         if (result.promptFeedback && result.promptFeedback.blockReason) {
                               throw new Error(`API call blocked: ${result.promptFeedback.blockReason}`);
                         }
                        return null;
                    }
                } catch (error) {
                    console.error("L·ªói khi g·ªçi Gemini API:", error);
                    return null;
                }
            }
            
            // --- TTS Feature Functions ---
            function base64ToArrayBuffer(base64) {
                const binaryString = window.atob(base64);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return bytes.buffer;
            }

            function pcmToWav(pcmData, sampleRate) {
                const numChannels = 1;
                const bytesPerSample = 2; // 16-bit
                const blockAlign = numChannels * bytesPerSample;
                const byteRate = sampleRate * blockAlign;
                const dataSize = pcmData.byteLength;
                const buffer = new ArrayBuffer(44 + dataSize);
                const view = new DataView(buffer);

                /* RIFF identifier */
                writeString(view, 0, 'RIFF');
                /* file length */
                view.setUint32(4, 36 + dataSize, true);
                /* RIFF type */
                writeString(view, 8, 'WAVE');
                /* format chunk identifier */
                writeString(view, 12, 'fmt ');
                /* format chunk length */
                view.setUint32(16, 16, true);
                /* sample format (raw) */
                view.setUint16(20, 1, true);
                /* channel count */
                view.setUint16(22, numChannels, true);
                /* sample rate */
                view.setUint32(24, sampleRate, true);
                /* byte rate (sample rate * block align) */
                view.setUint32(28, byteRate, true);
                /* block align (channel count * bytes per sample) */
                view.setUint16(32, blockAlign, true);
                /* bits per sample */
                view.setUint16(34, 16, true);
                /* data chunk identifier */
                writeString(view, 36, 'data');
                /* data chunk length */
                view.setUint32(40, dataSize, true);

                // Write PCM data
                const pcm16 = new Int16Array(pcmData);
                for (let i = 0; i < pcm16.length; i++) {
                    view.setInt16(44 + i * 2, pcm16[i], true);
                }

                function writeString(view, offset, string) {
                    for (let i = 0; i < string.length; i++) {
                        view.setUint8(offset + i, string.charCodeAt(i));
                    }
                }

                return new Blob([view], { type: 'audio/wav' });
            }

            async function playTTS(text, button) {
                if (currentAudio && !currentAudio.paused) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                    document.querySelectorAll('.tts-btn.playing').forEach(b => b.classList.remove('playing'));
                    if (currentAudio.src.startsWith('blob:')) {
                        URL.revokeObjectURL(currentAudio.src);
                    }
                    if (currentAudio.dataset.text === text) {
                        currentAudio = null;
                        return; // Stop if the same button is clicked again
                    }
                }

                button.classList.add('playing');
                const originalIcon = button.innerHTML;
                button.innerHTML = '<div class="small-loader"></div>';
                button.disabled = true;

                try {
                    const payload = {
                        contents: [{ parts: [{ text: `N√≥i m·ªôt c√°ch r√µ r√†ng, t·ª± nhi√™n: ${text}` }] }],
                        generationConfig: { responseModalities: ["AUDIO"] },
                    };

                    const resultPart = await callGeminiAPI(payload, apiKey, 'gemini-2.5-flash-preview-tts');

                    if (resultPart && resultPart.inlineData) {
                        const audioData = resultPart.inlineData.data;
                        const mimeType = resultPart.inlineData.mimeType;
                        const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                        const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;

                        const pcmData = base64ToArrayBuffer(audioData);
                        const wavBlob = pcmToWav(pcmData, sampleRate);
                        const audioUrl = URL.createObjectURL(wavBlob);

                        currentAudio = new Audio(audioUrl);
                        currentAudio.dataset.text = text;
                        currentAudio.play();
                        currentAudio.onended = () => {
                            button.classList.remove('playing');
                            URL.revokeObjectURL(audioUrl);
                            currentAudio = null;
                        };
                    } else {
                        throw new Error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c d·ªØ li·ªáu √¢m thanh.");
                    }
                } catch (error) {
                    console.error("L·ªói TTS:", error);
                    alert("Kh√¥ng th·ªÉ ph√°t √¢m thanh. Vui l√≤ng th·ª≠ l·∫°i.");
                     button.classList.remove('playing');
                } finally {
                    button.innerHTML = originalIcon;
                    button.disabled = false;
                }
            }

            function getTextForTTS(item) {
                let text = item.question || item.main_question || '';
                text = text.replace(/\$/g, ''); // Remove LaTeX delimiters for cleaner speech

                if (item.mappedType === 'multiple-choice' && item.options) {
                    const optionsText = item.options.map((opt, i) => `${String.fromCharCode(65 + i)}. ${opt}`).join(' ');
                    text += ' ' + optionsText.replace(/\$/g, '');
                } else if (item.mappedType === 'true-false' && item.statements) {
                    const statementsText = item.statements.map((s, i) => `${String.fromCharCode(97 + i)}. ${s.statement}`).join(' ');
                    text += ' ' + statementsText.replace(/\$/g, '');
                }
                return text;
            }

            function renderStudentQuiz() {
                studentQuizContainer.innerHTML = '';
                
                const groupedQuestions = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});

                const groupInfo = {
                    'multiple-choice': { title: 'PH·∫¶N I. TR·∫ÆC NGHI·ªÜM KH√ÅCH QUAN', subtitle: 'Ch·ªçn ƒë√°p √°n ƒë√∫ng nh·∫•t trong c√°c l·ª±a ch·ªçn sau.' },
                    'true-false': { title: 'PH·∫¶N II. C√ÇU H·ªéI ƒê√öNG - SAI', subtitle: 'X√°c ƒë·ªãnh t√≠nh ƒë√∫ng ho·∫∑c sai cho m·ªói m·ªánh ƒë·ªÅ d∆∞·ªõi ƒë√¢y.' },
                    'short-answer': { title: 'PH·∫¶N III. C√ÇU H·ªéI TR·∫¢ L·ªúI NG·∫ÆN', subtitle: 'ƒêi·ªÅn ƒë√°p √°n ng·∫Øn g·ªçn v√†o ph·∫ßn tr·∫£ l·ªùi.' },
                    'essay': { title: 'PH·∫¶N IV. C√ÇU H·ªéI T·ª∞ LU·∫¨N', subtitle: 'Tr√¨nh b√†y chi ti·∫øt b√†i gi·∫£i c·ªßa b·∫°n.' }
                };
                
                let questionCounter = 0;
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];

                partOrder.forEach(partType => {
                    const questions = groupedQuestions[partType];
                    if (!questions || questions.length === 0) return;
                    
                    const info = groupInfo[partType];
                    let groupHTML = `<div class="group-container space-y-8 mb-12">`;
                    groupHTML += `
                        <div class="group-header pb-3 border-b-2 border-slate-300 mb-6">
                            <h2 class="text-2xl font-bold text-slate-800">${info.title}</h2>
                            ${info.subtitle ? `<p class="text-md text-slate-600 italic mt-1">${info.subtitle}</p>` : ''}
                        </div>
                    `;

                    questions.forEach((item, localIndex) => {
                        const globalIndex = quizData.indexOf(item);
                        questionCounter++;
                        groupHTML += `<div class="question-card" id="student-q-${globalIndex}">`;
                        let questionText = formatAndCleanLatex(item.question || item.main_question || '').replace(/\n/g, '<br>');
                        
                        const textToSpeak = getTextForTTS(item);
                        
                        groupHTML += `<div class="flex items-start">
                                     <div class="flex-grow">
                                         <div class="flex items-center mb-2">
                                             <span class="font-bold text-lg mr-3 text-indigo-600">C√¢u ${questionCounter}:</span>
                                             <div id="q-${globalIndex}-feedback-icon"></div>
                                         </div>
                                         <div class="question-content mt-2 text-lg text-slate-700">${questionText}</div>
                                         ${item.questionImage ? `<img src="${item.questionImage}" class="mt-4 rounded-lg max-w-full md:max-w-md border shadow-sm">` : ''}
                                     </div>
                                     <button class="tts-btn ml-4 p-2 rounded-full text-gray-500 hover:text-indigo-600" data-text-to-speak="${textToSpeak.replace(/"/g, '&quot;')}">
                                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                             <path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.858 5.858a3 3 0 014.243 0L12 7.757l1.9-1.9a3 3 0 014.242 0 3 3 0 010 4.242L12 16.242l-6.042-6.042a3 3 0 010-4.242z" />
                                         </svg>
                                     </button>
                                 </div>`;
                        
                        groupHTML += `<div class="mt-6">`;
                        switch(item.mappedType) {
                            case 'multiple-choice':
                                groupHTML += `<div class="options-grid grid grid-cols-1 md:grid-cols-2 gap-4">`;
                                item.options.forEach((opt, i) => {
                                    groupHTML += `<label for="q${globalIndex}-opt${i}" id="q${globalIndex}-opt-label${i}" class="option-label flex items-center p-4 border-2 rounded-xl cursor-pointer hover:bg-indigo-50 hover:border-indigo-400">
                                                 <input type="radio" name="q${globalIndex}" id="q${globalIndex}-opt${i}" value="${i}" class="mt-1 h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                                 <span class="font-semibold mx-3 text-slate-800">${String.fromCharCode(65 + i)}.</span>
                                                 <div class="flex-grow option-content text-slate-700">${formatAndCleanLatex(opt)}</div>
                                             </label>`;
                                });
                                groupHTML += `</div>`;
                                break;
                            case 'true-false':
                                 groupHTML += `<div class="space-y-4">`;
                                 item.statements.forEach((s, i) => {
                                     groupHTML += `<div class="statement-item border-t pt-4">
                                                  <p class="mb-3 text-slate-700">${String.fromCharCode(97 + i)}) ${formatAndCleanLatex(s.statement)}</p>
                                                  <div class="flex gap-x-6">
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="true" class="mr-2 h-4 w-4"> ƒê√∫ng</label>
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="false" class="mr-2 h-4 w-4"> Sai</label>
                                                  </div>
                                              </div>`;
                                 });
                                 groupHTML += `</div>`;
                                 break;
                            case 'short-answer':
                                groupHTML += `<input type="text" name="q${globalIndex}" class="mt-1 block w-full md:w-1/2 border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Nh·∫≠p ƒë√°p √°n c·ªßa b·∫°n...">`;
                                break;
                            case 'essay':
                                groupHTML += `<textarea name="q${globalIndex}" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" rows="5" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi t·ª± lu·∫≠n c·ªßa b·∫°n..."></textarea>`;
                                break;
                        }
                        groupHTML += `</div><div id="q-${globalIndex}-feedback" class="mt-4"></div></div>`;
                    });
                    groupHTML += `</div>`;
                    studentQuizContainer.innerHTML += groupHTML;
                });
                

                if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                    MathJax.typesetPromise([studentQuizContainer]);
                }
                
                document.querySelectorAll('.tts-btn').forEach(btn => {
                    btn.addEventListener('click', () => playTTS(btn.dataset.textToSpeak, btn));
                });
            }

            async function generatePerformanceReview(allAnswersData) {
                const feedbackContainer = document.getElementById('ai-feedback-container');
                if (!feedbackContainer || !ai) return null;

                feedbackContainer.classList.remove('hidden');
                feedbackContainer.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-slate-800 mb-4">üìù Ph√¢n T√≠ch & G·ª£i √ù T·ª´ Tr·ª£ L√Ω AI</h3>
                        <div id="ai-feedback-loader" class="text-center py-6">
                             <svg class="animate-spin mx-auto h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                             <p class="mt-3 text-slate-600">AI ƒëang ph√¢n t√≠ch b√†i l√†m c·ªßa b·∫°n, vui l√≤ng ch·ªù trong gi√¢y l√°t...</p>
                        </div>
                        <div id="ai-feedback-content" class="hidden"></div>
                    </div>
                `;

                const incorrectAnswers = allAnswersData.filter(a => !a.isCorrect);

                if (incorrectAnswers.length === 0) {
                     feedbackContainer.innerHTML = `
                        <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                            <h3 class="text-xl font-bold text-green-600">üéâ Ch√∫c m·ª´ng!</h3>
                            <p class="mt-2 text-slate-700">B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng t·∫•t c·∫£ c√°c c√¢u h·ªèi. L√†m t·ªët l·∫Øm!</p>
                        </div>
                     `;
                    return { overallFeedback: { summary: "Xu·∫•t s·∫Øc! H·ªçc sinh ƒë√£ tr·∫£ l·ªùi ƒë√∫ng t·∫•t c·∫£ c√°c c√¢u h·ªèi.", strengths: "Tr·∫£ l·ªùi ƒë√∫ng t·∫•t c·∫£ c√°c c√¢u h·ªèi.", areasForImprovement: "Kh√¥ng c√≥." } };
                }

                 const prompt = `B·∫°n l√† m·ªôt tr·ª£ l√Ω gi√°o vi√™n chuy√™n nghi·ªáp v√† th√¢n thi·ªán, n√≥i ti·∫øng Vi·ªát. Nhi·ªám v·ª• c·ªßa b·∫°n l√† ph√¢n t√≠ch k·∫øt qu·∫£ b√†i l√†m c·ªßa m·ªôt h·ªçc sinh v√† ƒë∆∞a ra nh·∫≠n x√©t mang t√≠nh x√¢y d·ª±ng.
                
                D∆∞·ªõi ƒë√¢y l√† to√†n b·ªô b√†i l√†m c·ªßa h·ªçc sinh, bao g·ªìm c√°c c√¢u tr·∫£ l·ªùi sai:
                ${JSON.stringify(incorrectAnswers, null, 2)}
                
                D·ª±a v√†o c√°c l·ªói sai n√†y, h√£y t·∫°o m·ªôt ph·∫£n h·ªìi. L·ªùi vƒÉn ph·∫£i kh√≠ch l·ªá, r√µ r√†ng, d·ªÖ hi·ªÉu.
                QUAN TR·ªåNG: V·ªõi c√°c c√¢u h·ªèi ƒê√∫ng/Sai (type: 'true-false'), h√£y ch√∫ √Ω v√†o tr∆∞·ªùng 'details' ƒë·ªÉ ph√¢n t√≠ch l·ªói sai ·ªü t·ª´ng m·ªánh ƒë·ªÅ nh·ªè.
                
                - 'summary': T√≥m t·∫Øt nƒÉng l·ª±c c·ªßa h·ªçc sinh trong 1-2 c√¢u ng·∫Øn g·ªçn, s√∫c t√≠ch ƒë·ªÉ g·ª≠i cho gi√°o vi√™n. V√≠ d·ª•: 'N·∫Øm v·ªØng ki·∫øn th·ª©c c∆° b·∫£n nh∆∞ng c·∫ßn c·∫£i thi·ªán k·ªπ nƒÉng t√≠nh to√°n.'
                - 'strengths': Nh·∫≠n x√©t chi ti·∫øt v·ªÅ ƒëi·ªÉm m·∫°nh, ph·∫ßn ki·∫øn th·ª©c h·ªçc sinh ƒë√£ n·∫Øm v·ªØng (suy lu·∫≠n t·ª´ c√°c c√¢u l√†m ƒë√∫ng, kh√¥ng c√≥ trong d·ªØ li·ªáu c√¢u sai) ƒë·ªÉ hi·ªÉn th·ªã cho h·ªçc sinh.
                - 'areasForImprovement': Nh·∫≠n x√©t chi ti·∫øt v·ªÅ nh·ªØng m·∫£ng ki·∫øn th·ª©c h·ªçc sinh c·∫ßn c·∫£i thi·ªán d·ª±a tr√™n c√°c c√¢u sai ƒë·ªÉ hi·ªÉn th·ªã cho h·ªçc sinh.
                - 'studySuggestions': G·ª£i √Ω 2-3 ch·ªß ƒë·ªÅ ki·∫øn th·ª©c c·ª• th·ªÉ c·∫ßn √¥n t·∫≠p l·∫°i, d·ª±a tr√™n b·∫£n ch·∫•t c·ªßa c√°c c√¢u h·ªèi sai.
                - 'errorAnalysis': Ch·ªâ bao g·ªìm c√°c c√¢u h·ªèi h·ªçc sinh tr·∫£ l·ªùi sai. Gi·∫£i th√≠ch chi ti·∫øt t·ª´ng b∆∞·ªõc t·∫°i sao ƒë√°p √°n ƒë√∫ng l√† ƒë√∫ng, v√† ph√¢n t√≠ch l·ªói sai trong c√¢u tr·∫£ l·ªùi c·ªßa h·ªçc sinh. L·ªùi gi·∫£i ph·∫£i r√µ r√†ng, logic, v√† s·ª≠ d·ª•ng LaTeX cho c√¥ng th·ª©c to√°n n·∫øu c·∫ßn.`;
                
                const schema = {
                    type: Type.OBJECT,
                    properties: {
                        "overallFeedback": {
                            type: Type.OBJECT,
                            properties: {
                                "summary": { type: Type.STRING },
                                "strengths": { type: Type.STRING },
                                "areasForImprovement": { type: Type.STRING }
                            },
                            required: ["summary", "strengths", "areasForImprovement"]
                        },
                        "studySuggestions": {
                            type: Type.ARRAY,
                            items: { type: Type.STRING }
                        },
                        "errorAnalysis": {
                            type: Type.ARRAY,
                            items: {
                                type: Type.OBJECT,
                                properties: {
                                    "questionNumber": { type: Type.STRING },
                                    "explanation": { type: Type.STRING }
                                },
                                required: ["questionNumber", "explanation"]
                            }
                        }
                    },
                    required: ["overallFeedback", "studySuggestions", "errorAnalysis"]
                };

                try {
                    const response = await ai.models.generateContent({
                        model: "gemini-2.5-flash",
                        contents: prompt,
                        config: {
                            responseMimeType: "application/json",
                            responseSchema: schema
                        }
                    });

                    const resultText = response.text;
                    const feedbackData = JSON.parse(resultText);

                    const loader = document.getElementById('ai-feedback-loader');
                    const contentDiv = document.getElementById('ai-feedback-content');

                    let html = '';

                    // Overall Feedback
                    html += `
                        <div class="mb-6 space-y-4">
                            <div>
                                <h4 class="font-bold text-lg text-slate-700 mb-2">üëç Ph·∫ßn l√†m t·ªët</h4>
                                <p class="text-slate-600 bg-green-50 p-3 rounded-lg border border-green-200">${feedbackData.overallFeedback.strengths}</p>
                            </div>
                            <div>
                                <h4 class="font-bold text-lg text-slate-700 mb-2">ü§î Ph·∫ßn c·∫ßn c·∫£i thi·ªán</h4>
                                <p class="text-slate-600 bg-yellow-50 p-3 rounded-lg border border-yellow-200">${feedbackData.overallFeedback.areasForImprovement}</p>
                            </div>
                            <div>
                                <h4 class="font-bold text-lg text-slate-700 mb-2">üìö G·ª£i √Ω √¥n t·∫≠p</h4>
                                <ul class="list-disc list-inside text-slate-600 bg-blue-50 p-3 rounded-lg border border-blue-200 space-y-1">
                                    ${feedbackData.studySuggestions.map(s => `<li>${s}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    `;

                    // Error Analysis
                    html += `<h4 class="font-bold text-lg text-slate-700 mb-3 pt-4 border-t">üîé S·ª≠a l·ªói chi ti·∫øt</h4>`;
                    html += '<div class="space-y-4">';
                    feedbackData.errorAnalysis.forEach(analysis => {
                        const questionInfo = allAnswersData.find(q => q.questionNumber === analysis.questionNumber);
                        if (!questionInfo) return;
                        html += `
                            <details class="bg-slate-50 border rounded-lg overflow-hidden">
                                <summary class="font-semibold p-4 cursor-pointer hover:bg-slate-100 flex justify-between items-center">
                                    <span>C√¢u ${analysis.questionNumber}: B·∫°n ch·ªçn <span class="text-red-600">${questionInfo.yourAnswer}</span>, ƒë√°p √°n ƒë√∫ng l√† <span class="text-green-600">${questionInfo.correctAnswer}</span></span>
                                    <svg class="w-5 h-5 transition-transform transform details-arrow" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                                </summary>
                                <div class="p-4 border-t bg-white prose prose-sm max-w-none">
                                    ${formatAndCleanLatex(analysis.explanation).replace(/\n/g, '<br>')}
                                </div>
                            </details>
                        `;
                    });
                    html += '</div>';

                    contentDiv.innerHTML = html;
                    loader.classList.add('hidden');
                    contentDiv.classList.remove('hidden');

                    if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                        MathJax.typesetPromise([contentDiv]);
                    }
                    
                    return feedbackData;

                } catch (error) {
                    console.error("Error generating or rendering feedback:", error);
                    const feedbackContent = document.getElementById('ai-feedback-content');
                    if (feedbackContent) {
                        feedbackContent.innerHTML = `<p class="text-red-600">Xin l·ªói, ƒë√£ c√≥ l·ªói x·∫£y ra khi AI ph√¢n t√≠ch b√†i l√†m c·ªßa b·∫°n. Vui l√≤ng th·ª≠ l·∫°i sau.</p>`;
                        feedbackContent.classList.remove('hidden');
                        document.getElementById('ai-feedback-loader').classList.add('hidden');
                    }
                    return null;
                }
            }


            async function handleSubmit() {
                if (isSubmitted) return;
                isSubmitted = true;
                clearInterval(timerInterval);

                let totalStudentScore = 0;
                let totalCorrectAnswers = 0;
                let allAnswersData = [];

                const questionCounts = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    acc[type] = (acc[type] || 0) + 1;
                    return acc;
                }, {});

                // --- GRADING LOGIC ---
                quizData.forEach((item, index) => {
                    let questionNumber = index + 1;
                    let answerData = { questionNumber };

                    switch (item.mappedType) {
                        case 'multiple-choice':
                            const selectedOption = document.querySelector(`input[name="q${index}"]:checked`);
                            const isCorrectMC = selectedOption ? parseInt(selectedOption.value) === item.correctAnswerIndex : false;
                            if (isCorrectMC) {
                                totalCorrectAnswers++;
                                if (questionCounts['multiple-choice'] > 0) {
                                   totalStudentScore += quizOptions.scoring.mc / questionCounts['multiple-choice'];
                                }
                            }
                            answerData.type = 'multiple-choice';
                            answerData.question = item.question;
                            answerData.options = item.options;
                            answerData.yourAnswer = selectedOption ? String.fromCharCode(65 + parseInt(selectedOption.value)) : "Kh√¥ng tr·∫£ l·ªùi";
                            answerData.correctAnswer = String.fromCharCode(65 + item.correctAnswerIndex);
                            answerData.isCorrect = isCorrectMC;
                            break;

                        case 'true-false':
                            let correctStatementsCount = 0;
                            let yourAnswerPattern = [];
                            let correctAnswerPattern = [];
                            let details = [];

                            item.statements.forEach((s, i) => {
                                const selectedTF = document.querySelector(`input[name="q${index}-s${i}"]:checked`);
                                const studentChoice = selectedTF ? selectedTF.value === 'true' : null;
                                const isStatementCorrect = studentChoice === s.is_correct;
                                
                                if (isStatementCorrect) correctStatementsCount++;
                                
                                yourAnswerPattern.push(studentChoice === null ? '?' : (studentChoice ? 'ƒê' : 'S'));
                                correctAnswerPattern.push(s.is_correct ? 'ƒê' : 'S');
                                details.push({ statement: s.statement, yourChoice: studentChoice === null ? 'Kh√¥ng tr·∫£ l·ªùi' : (studentChoice ? 'ƒê√∫ng' : 'Sai'), correctChoice: s.is_correct ? 'ƒê√∫ng' : 'Sai', isCorrect: isStatementCorrect });
                            });

                            let questionPoints = 0;
                            if (quizOptions.scoring.tfMethod === 'progressive') {
                                const progressivePoints = { 0: 0, 1: 0.1, 2: 0.25, 3: 0.5, 4: 1.0 };
                                questionPoints = progressivePoints[correctStatementsCount];
                            } else { // even
                                questionPoints = correctStatementsCount * 0.25;
                            }
                            totalStudentScore += questionPoints;
                            if(correctStatementsCount === 4) totalCorrectAnswers++;

                            answerData.type = 'true-false';
                            answerData.question = item.main_question;
                            answerData.yourAnswer = yourAnswerPattern.join('-');
                            answerData.correctAnswer = correctAnswerPattern.join('-');
                            answerData.isCorrect = correctStatementsCount === 4;
                            answerData.details = details;
                            break;
                        
                        case 'short-answer':
                            const saInput = document.querySelector(`input[name="q${index}"]`);
                            const saAnswer = saInput ? saInput.value.trim().toLowerCase() : "";
                            const isCorrectSA = saAnswer === item.answer.trim().toLowerCase();
                             if (isCorrectSA) {
                                totalCorrectAnswers++;
                                if (questionCounts['short-answer'] > 0) {
                                   totalStudentScore += quizOptions.scoring.sa / questionCounts['short-answer'];
                                }
                            }
                            answerData.type = 'short-answer';
                            answerData.question = item.question;
                            answerData.yourAnswer = saInput.value || "Kh√¥ng tr·∫£ l·ªùi";
                            answerData.correctAnswer = item.answer;
                            answerData.isCorrect = isCorrectSA;
                            break;
                            
                        case 'essay':
                             const essayInput = document.querySelector(`textarea[name="q${index}"]`);
                             answerData.type = 'essay';
                             answerData.question = item.question;
                             answerData.yourAnswer = essayInput.value || "Kh√¥ng tr·∫£ l·ªùi";
                             answerData.correctAnswer = item.answer;
                             answerData.isCorrect = null; // Needs manual grading
                             break;
                    }
                    allAnswersData.push(answerData);
                });

                // --- SCORE CALCULATION & DISPLAY ---
                // The teacher sets the points for each section. The final score is the sum of these points.
                // It is displayed on a 10-point scale, so we assume the teacher sets the total points to 10.
                const finalScore = totalStudentScore;
                const totalQuestions = quizData.length;


                // --- RENDER SUMMARY TABLE ---
                let summaryTableHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                    <h3 class="text-xl font-bold text-slate-800 mb-4">üéØ T·ªîNG K·∫æT:</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-center text-slate-600">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100 rounded-t-lg">
                                <tr>
                                    <th scope="col" class="px-4 py-3 font-semibold">C√¢u</th>
                                    <th scope="col" class="px-4 py-3 font-semibold">ƒê√°p √°n c·ªßa b·∫°n</th>
                                    <th scope="col" class="px-4 py-3 font-semibold">ƒê√°p √°n ƒë√∫ng</th>
                                    <th scope="col" class="px-4 py-3 font-semibold">K·∫øt qu·∫£</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                allAnswersData.forEach(ans => {
                    summaryTableHTML += `
                        <tr class="bg-white border-b">
                            <td class="px-4 py-3 font-medium">${ans.questionNumber}</td>
                            <td class="px-4 py-3 ${ans.isCorrect ? '' : 'text-red-500 font-bold'}">${ans.yourAnswer}</td>
                            <td class="px-4 py-3">${ans.correctAnswer}</td>
                            <td class="px-4 py-3 flex justify-center">${ans.isCorrect === true ? 
                                '<svg class="w-6 h-6 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>' : 
                                (ans.isCorrect === false ? '<svg class="w-6 h-6 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>' : '<span>-</span>')
                            }</td>
                        </tr>`;
                });

                summaryTableHTML += `
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4 space-y-1 text-left">
                        <p class="font-semibold text-green-600">‚úÖ S·ªë c√¢u ƒë√∫ng ho√†n to√†n: ${totalCorrectAnswers}/${totalQuestions}</p>
                         <p class="font-semibold text-blue-600">üìä ƒêi·ªÉm (thang 10): ${finalScore.toFixed(2)}/10</p>
                         ${questionCounts['essay'] > 0 ? `<p class="text-sm text-gray-600 italic">L∆∞u √Ω: ƒêi·ªÉm tr√™n ch∆∞a bao g·ªìm ${quizOptions.scoring.essay} ƒëi·ªÉm c·ªßa ph·∫ßn T·ª± lu·∫≠n c·∫ßn gi√°o vi√™n ch·∫•m.</p>` : ''}
                    </div>
                </div>`;
                
                resultContainer.innerHTML = summaryTableHTML;
                resultContainer.classList.remove('hidden');

                // Wait for MathJax rendering to complete and add a small buffer time.
                // This prevents a race condition where the AI is called before the results table is fully rendered,
                // which can cause errors in data collection for the AI prompt.
                if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                    await window.MathJax.typesetPromise([resultContainer]);
                }
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // 3. Call AI feedback generation if enabled and create assessment string
                let competencyAssessment = "Gi√°o vi√™n kh√¥ng y√™u c·∫ßu AI ph√¢n t√≠ch b√†i l√†m.";
                if (quizOptions.showAnswers && quizOptions.showExplanation) {
                    const feedbackData = await generatePerformanceReview(allAnswersData);
                    if (feedbackData && feedbackData.overallFeedback && feedbackData.overallFeedback.summary) {
                        competencyAssessment = feedbackData.overallFeedback.summary;
                    } else {
                        competencyAssessment = "C√≥ l·ªói x·∫£y ra trong qu√° tr√¨nh AI ph√¢n t√≠ch b√†i l√†m.";
                    }
                }

                // 4. Disable inputs, show post-submit options, and send data
                document.querySelectorAll('input, textarea').forEach(input => input.disabled = true);
                submitBtn.classList.add('hidden');
                postSubmitOptions.classList.remove('hidden');
                if (retriesLeft > 0) {
                    retryBtn.classList.remove('hidden');
                } else {
                    retryBtn.classList.add('hidden');
                }
                
                const formData = new FormData();
                formData.append('name', studentInfo.name);
                formData.append('class', studentInfo.class);
                formData.append('score', `${finalScore.toFixed(2)}/10`);
                formData.append('assessment', competencyAssessment);
                formData.append('timestamp', new Date().toLocaleString('vi-VN'));
                
                fetch(googleScriptUrl, { method: 'POST', body: formData})
                    .then(res => console.log("Successfully submitted to Google Sheet"))
                    .catch(err => console.error("Error submitting to Google Sheet:", err));
            }
            
            function startNewAttempt() {
                 isSubmitted = false;
                renderStudentQuiz();
                resultContainer.classList.add('hidden');
                document.getElementById('ai-feedback-container').classList.add('hidden');
                postSubmitOptions.classList.add('hidden');
                submitBtn.classList.remove('hidden');
                 if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                }
                retriesLeft--;
                retriesDisplay.textContent = `L∆∞·ª£t l√†m l·∫°i c√≤n: ${retriesLeft}`;
                window.scrollTo(0, 0);
            }

            studentInfoForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const enteredCode = document.getElementById('exam-code').value.trim().toUpperCase();
                if (enteredCode !== correctExamCode) {
                    alert('M√£ ƒë·ªÅ kh√¥ng ch√≠nh x√°c. Vui l√≤ng ki·ªÉm tra l·∫°i!');
                    return;
                }

                shuffleQuestions();
                
                studentInfo.name = document.getElementById('student-name').value;
                studentInfo.class = document.getElementById('student-class').value;
                loginModal.classList.add('hidden');
                studentQuizContainer.classList.remove('hidden');
                submitBtn.classList.remove('hidden');
                
                if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                } else {
                    timerDisplay.textContent = "Kh√¥ng gi·ªõi h·∫°n";
                }

                retriesDisplay.textContent = `L∆∞·ª£t l√†m l·∫°i c√≤n: ${retriesLeft}`;

                renderStudentQuiz();
            });

            // Attach the submit listener once.
            submitBtn.addEventListener('click', handleSubmit);

            retryBtn.addEventListener('click', () => {
                shuffleQuestions();
                startNewAttempt();
            });
        </script>
    </body>
    </html>
    