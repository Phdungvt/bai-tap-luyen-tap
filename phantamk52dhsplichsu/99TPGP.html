
    <!DOCTYPE html>
    <html lang="vi">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Äá» kiá»ƒm tra</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
        <script>
            window.MathJax = {
                tex: {
                    packages: {'[+]': ['ams']},
                    inlineMath: [['$', '$'], ['\\(', '\\)']],
                    displayMath: [['$$', '$$'], ['\\[', '\\]']]
                },
                chtml: {
                    fontCache: 'global',
                    linebreaks: {
                        automatic: true
                    }
                }
            };
        </script>
        <script type="text/javascript" id="MathJax-script" async
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
        </script>
        <style>
            body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #f0f4f8; }
            .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
            @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
            .question-card {
                background-color: white;
                border-radius: 1rem;
                padding: 1.5rem 2rem;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                border-left: 5px solid transparent;
                transition: all 0.3s ease;
            }
            .ai-explanation {
                background-color: #f0f9ff;
                color: #0c4a6e;
                padding: 1rem;
                border-radius: 0.75rem;
                font-size: 0.9rem;
                margin-top: 1rem;
                border-left: 4px solid #38bdf8;
            }
            .feedback-icon { width: 1.5rem; height: 1.5rem; }
            .option-label {
                transition: all 0.2s ease-in-out;
                border: 2px solid #e5e7eb;
            }
            .option-label:hover {
                border-color: #6366f1;
                background-color: #eef2ff;
            }
            .option-label.correct {
                border-color: #10b981 !important;
                background-color: #ecfdf5 !important;
                color: #065f46;
            }
            .option-label.incorrect {
                border-color: #ef4444 !important;
                background-color: #fef2f2 !important;
                color: #991b1b;
            }
            .statement-item.correct { background-color: #ecfdf5; border-color: #10b981; }
            .statement-item.incorrect { background-color: #fef2f2; border-color: #ef4444; }
            .prose { max-width: 100%; }
            .prose h1, .prose h2, .prose h3 { font-weight: 600; }
            .prose p { margin-top: 0.5em; margin-bottom: 0.5em; }
            .prose ul, .prose ol { margin-top: 1em; margin-bottom: 1em; padding-left: 1.5em; }
            .prose li > p { margin-top: 0; margin-bottom: 0; }
            .prose code { background-color: #e5e7eb; padding: 0.2em 0.4em; margin: 0; font-size: 85%; border-radius: 3px; }
            .prose pre { background-color: #e5e7eb; padding: 1em; border-radius: 0.5em; overflow-x: auto; }
            .prose pre code { background-color: transparent; padding: 0; }
            details[open] > summary .details-arrow {
                transform: rotate(180deg);
            }
        </style>
    </head>
    <body class="bg-slate-100 text-slate-800">
        <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md transform transition-all" style="animation: fadeIn 0.3s ease-out;">
                <h2 class="text-2xl font-bold mb-2 text-center text-slate-800">ThÃ´ng Tin Há»c Sinh</h2>
                <p class="text-center text-slate-500 mb-6">Vui lÃ²ng nháº­p Ä‘á»ƒ báº¯t Ä‘áº§u lÃ m bÃ i.</p>
                <form id="student-info-form">
                    <div class="mb-4">
                        <label for="student-name" class="block text-sm font-medium text-slate-700 mb-1">Há» vÃ  tÃªn</label>
                        <input type="text" id="student-name" required class="mt-1 block w-full block border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="student-class" class="block text-sm font-medium text-slate-700 mb-1">Lá»›p</label>
                        <input type="text" id="student-class" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="exam-code" class="block text-sm font-medium text-slate-700 mb-1">MÃ£ Ä‘á»</label>
                        <input type="text" id="exam-code" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Nháº­p mÃ£ Ä‘á» giÃ¡o viÃªn cung cáº¥p">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 mb-1">GiÃ¡o viÃªn:</label>
                        <p class="mt-1 text-slate-800 bg-slate-100 p-2.5 rounded-lg">Phan VÄƒn Tam</p>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">Báº¯t Ä‘áº§u lÃ m bÃ i</button>
                </form>
            </div>
        </div>
        <div class="container mx-auto p-4 md:p-8 max-w-4xl">
            <header class="mb-10 p-8 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg">
                <div class="flex justify-between items-center flex-wrap gap-4">
                    <div>
                        <h1 class="text-4xl font-bold">Äá» kiá»ƒm tra</h1>
                        <p class="text-lg text-blue-100 mt-2">HÃ£y hoÃ n thÃ nh cÃ¡c cÃ¢u há»i dÆ°á»›i Ä‘Ã¢y má»™t cÃ¡ch tá»‘t nháº¥t!</p>
                        <p class="text-sm text-blue-200 mt-4">TÃ¡c giáº£: Phan VÄƒn Tam</p>
                    </div>
                    <div id="timer-container" class="text-right">
                         <div id="timer-display" class="text-3xl font-bold tracking-wider bg-white/20 px-4 py-2 rounded-lg">--:--</div>
                         <div id="retries-display" class="text-sm mt-1 text-blue-200"></div>
                    </div>
                </div>
            </header>
            <main id="student-quiz-container" class="space-y-8 hidden">
                <!-- Questions will be rendered here by JS -->
            </main>
            <footer class="mt-10 text-center">
                <button id="submit-quiz-btn" class="bg-indigo-600 text-white py-3 px-12 rounded-full font-bold text-lg hover:bg-indigo-700 transition-all duration-300 shadow-lg hover:shadow-xl hidden transform hover:scale-105">Ná»™p BÃ i</button>
                <div id="result-container" class="mt-6 hidden"></div>
                <div id="ai-feedback-container" class="mt-8 text-left hidden"></div>
                <div id="post-submit-options" class="hidden mt-6 flex flex-col sm:flex-row items-center justify-center gap-4">
                    <button id="retry-quiz-btn" class="w-full sm:w-auto bg-slate-600 text-white py-2.5 px-6 rounded-lg font-semibold hover:bg-slate-700 transition-transform transform hover:scale-105">LÃ m Láº¡i Äá» NÃ y</button>
                </div>
            </footer>
        </div>

        <div id="proctoring-widget" class="fixed bottom-4 right-4 bg-yellow-100 text-yellow-800 p-3 rounded-lg shadow-lg text-sm z-50 hidden border border-yellow-300" style="max-width: 200px;">
            <h4 class="font-bold mb-2 border-b border-yellow-300 pb-1 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 3.001-1.742 3.001H4.42c-1.53 0-2.493-1.667-1.743-3.001l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                GiÃ¡m sÃ¡t
            </h4>
            <p>ThoÃ¡t mÃ n hÃ¬nh: <span id="tab-switch-count" class="font-bold">0</span></p>
            <p>Sao chÃ©p: <span id="copy-count" class="font-bold">0</span></p>
            <p>DÃ¡n: <span id="paste-count" class="font-bold">0</span></p>
        </div>

        <script type="module">
            import { GoogleGenAI, Type } from "https://esm.sh/@google/genai@^1.13.0";
            let quizData = [{"type":"multiple-choice","question":"Há»‡ thá»‘ng Ä‘áº³ng cáº¥p nÃ o Ä‘Ã£ tá»“n táº¡i trong xÃ£ há»™i áº¤n Äá»™ cá»• Ä‘áº¡i, chia con ngÆ°á»i thÃ nh nhiá»u táº§ng lá»›p khÃ¡c nhau vá»›i nhá»¯ng quy Ä‘á»‹nh nghiÃªm ngáº·t vá» Ä‘á»‹a vá»‹ vÃ  nghá» nghiá»‡p?","questionImage":null,"mappedType":"multiple-choice","options":["Äáº³ng cáº¥p VÃ¡c-na","Äáº³ng cáº¥p Sa-ra-sin","Äáº³ng cáº¥p Pari","Äáº³ng cáº¥p Kha-li-pha"],"optionsImage":[],"correctAnswerIndex":0},{"type":"true-false","main_question":"VÄƒn minh áº¤n Äá»™ cá»• Ä‘áº¡i Ä‘Ã£ Ä‘áº¡t Ä‘Æ°á»£c nhiá»u thÃ nh tá»±u rá»±c rá»¡ vÃ  cÃ³ áº£nh hÆ°á»Ÿng sÃ¢u rá»™ng Ä‘áº¿n nhiá»u khu vá»±c khÃ¡c.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Hai con sÃ´ng chÃ­nh gáº¯n liá»n vá»›i sá»± hÃ¬nh thÃ nh vÃ  phÃ¡t triá»ƒn cá»§a ná»n vÄƒn minh áº¤n Äá»™ cá»• Ä‘áº¡i lÃ  sÃ´ng áº¤n vÃ  sÃ´ng Háº±ng.","is_correct":true},{"statement":"Cháº¿ Ä‘á»™ Ä‘áº³ng cáº¥p VÃ¡c-na á»Ÿ áº¤n Äá»™ cá»• Ä‘áº¡i lÃ  má»™t há»‡ thá»‘ng phÃ¢n chia xÃ£ há»™i dá»±a trÃªn Ä‘á»‹a vá»‹ vÃ  nghá» nghiá»‡p, mang tÃ­nh cháº¥t cá»©ng nháº¯c vÃ  Ã­t cÃ³ sá»± thay Ä‘á»•i.","is_correct":true},{"statement":"Pháº­t giÃ¡o, má»™t trong nhá»¯ng tÃ´n giÃ¡o lá»›n cá»§a áº¤n Äá»™ cá»• Ä‘áº¡i, Ä‘Æ°á»£c sÃ¡ng láº­p bá»Ÿi GÃ³t-ta-ma XÃ­t-Ä‘Ã¡c-ta (ThÃ­ch Ca MÃ¢u Ni) vÃ  chá»§ trÆ°Æ¡ng thá» Ä‘a tháº§n.","is_correct":false},{"statement":"NgÆ°á»i áº¤n Äá»™ cá»• Ä‘áº¡i Ä‘Ã£ phÃ¡t minh ra chá»¯ sá»‘ $0$ vÃ  há»‡ Ä‘áº¿m tháº­p phÃ¢n, nhÆ°ng nhá»¯ng thÃ nh tá»±u nÃ y chá»‰ Ä‘Æ°á»£c sá»­ dá»¥ng ná»™i bá»™ vÃ  khÃ´ng cÃ³ áº£nh hÆ°á»Ÿng Ä‘Ã¡ng ká»ƒ Ä‘áº¿n cÃ¡c ná»n vÄƒn minh khÃ¡c.","is_correct":false}]},{"type":"true-false","main_question":"Nhá»¯ng nháº­n Ä‘á»‹nh nÃ o sau Ä‘Ã¢y vá» ná»n vÄƒn minh áº¤n Äá»™ cá»• Ä‘áº¡i lÃ  Ä‘Ãºng hay sai?","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Hai con sÃ´ng chÃ­nh gáº¯n liá»n vá»›i sá»± hÃ¬nh thÃ nh vÃ  phÃ¡t triá»ƒn cá»§a ná»n vÄƒn minh áº¤n Äá»™ cá»• Ä‘áº¡i lÃ  sÃ´ng áº¤n vÃ  sÃ´ng Háº±ng.","is_correct":true},{"statement":"Cháº¿ Ä‘á»™ Ä‘áº³ng cáº¥p VÃ¡c-na á»Ÿ áº¤n Äá»™ cá»• Ä‘áº¡i cho phÃ©p má»i ngÆ°á»i thuá»™c cÃ¡c Ä‘áº³ng cáº¥p khÃ¡c nhau tá»± do káº¿t hÃ´n vÃ  thay Ä‘á»•i nghá» nghiá»‡p.","is_correct":false},{"statement":"Trong cÃ¡c tÃ´n giÃ¡o lá»›n á»Ÿ áº¤n Äá»™ cá»• Ä‘áº¡i, chá»‰ cÃ³ Pháº­t giÃ¡o lÃ  truyá»n bÃ¡ ra bÃªn ngoÃ i vÃ  khÃ´ng cÃ²n tá»“n táº¡i á»Ÿ áº¤n Äá»™ cho Ä‘áº¿n ngÃ y nay.","is_correct":false},{"statement":"NgoÃ i chá»¯ Pháº¡n, áº¤n Äá»™ cá»• Ä‘áº¡i cÃ²n phÃ¡t triá»ƒn rá»±c rá»¡ cÃ¡c bá»™ sá»­ thi nhÆ° Ma-ha-bha-ra-ta vÃ  Ra-ma-y-a-na, Ä‘á»“ng thá»i cÃ³ nhá»¯ng Ä‘Ã³ng gÃ³p quan trá»ng cho thiÃªn vÄƒn há»c vÃ  toÃ¡n há»c, bao gá»“m viá»‡c tÃ¬m ra sá»‘ $0$ vÃ  há»‡ Ä‘áº¿m tháº­p phÃ¢n.","is_correct":true}]},{"type":"true-false","main_question":"DÆ°á»›i Ä‘Ã¢y lÃ  má»™t sá»‘ nháº­n Ä‘á»‹nh vá» ná»n vÄƒn minh áº¤n Äá»™ cá»• Ä‘áº¡i. HÃ£y cho biáº¿t nhá»¯ng nháº­n Ä‘á»‹nh nÃ o lÃ  Ä‘Ãºng vÃ  nhá»¯ng nháº­n Ä‘á»‹nh nÃ o lÃ  sai.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Ná»n vÄƒn minh áº¤n Äá»™ cá»• Ä‘áº¡i hÃ¬nh thÃ nh chá»§ yáº¿u trÃªn lÆ°u vá»±c hai con sÃ´ng lá»›n lÃ  sÃ´ng áº¤n vÃ  sÃ´ng Háº±ng.","is_correct":true},{"statement":"Cháº¿ Ä‘á»™ Ä‘áº³ng cáº¥p VÃ¡c-na á»Ÿ áº¤n Äá»™ cá»• Ä‘áº¡i lÃ  má»™t há»‡ thá»‘ng xÃ£ há»™i linh hoáº¡t, cho phÃ©p ngÆ°á»i dÃ¢n dá»… dÃ ng thay Ä‘á»•i Ä‘áº³ng cáº¥p dá»±a trÃªn tÃ i nÄƒng vÃ  ná»— lá»±c cÃ¡ nhÃ¢n.","is_correct":false},{"statement":"Pháº­t giÃ¡o, má»™t trong nhá»¯ng tÃ´n giÃ¡o lá»›n ra Ä‘á»i á»Ÿ áº¤n Äá»™ cá»• Ä‘áº¡i, Ä‘Ã£ pháº£n Ä‘á»‘i máº¡nh máº½ cháº¿ Ä‘á»™ Ä‘áº³ng cáº¥p VÃ¡c-na vÃ  chá»§ trÆ°Æ¡ng bÃ¬nh Ä‘áº³ng giá»¯a má»i ngÆ°á»i.","is_correct":true},{"statement":"Máº·c dÃ¹ cÃ³ nhiá»u Ä‘Ã³ng gÃ³p quan trá»ng cho vÄƒn hÃ³a tháº¿ giá»›i, ná»n vÄƒn minh áº¤n Äá»™ cá»• Ä‘áº¡i láº¡i khÃ´ng cÃ³ báº¥t ká»³ thÃ nh tá»±u Ä‘Ã¡ng ká»ƒ nÃ o vá» kiáº¿n trÃºc vÃ  Ä‘iÃªu kháº¯c mÃ  chá»§ yáº¿u táº­p trung vÃ o vÄƒn há»c vÃ  tÃ´n giÃ¡o.","is_correct":false}]},{"type":"true-false","main_question":"ÄÃ¡nh giÃ¡ cÃ¡c nháº­n Ä‘á»‹nh sau Ä‘Ã¢y vá» ná»n vÄƒn minh áº¤n Äá»™ cá»• Ä‘áº¡i:","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Ná»n vÄƒn minh áº¤n Äá»™ cá»• Ä‘áº¡i Ä‘Æ°á»£c hÃ¬nh thÃ nh vÃ  phÃ¡t triá»ƒn gáº¯n liá»n vá»›i hai con sÃ´ng lá»›n lÃ  sÃ´ng áº¤n vÃ  sÃ´ng Háº±ng.","is_correct":true},{"statement":"Cháº¿ Ä‘á»™ Ä‘áº³ng cáº¥p VÃ¡c-na quy Ä‘á»‹nh cháº·t cháº½ Ä‘á»‹a vá»‹ xÃ£ há»™i cá»§a má»—i ngÆ°á»i, nhÆ°ng khÃ´ng cÃ³ sá»± phÃ¢n biá»‡t Ä‘á»‘i xá»­ trong cÃ´ng viá»‡c vÃ  giÃ¡o dá»¥c.","is_correct":false},{"statement":"Pháº­t giÃ¡o ra Ä‘á»i á»Ÿ áº¤n Äá»™ cá»• Ä‘áº¡i khÃ´ng chá»‰ áº£nh hÆ°á»Ÿng sÃ¢u sáº¯c Ä‘áº¿n Ä‘á»i sá»‘ng tÃ¢m linh mÃ  cÃ²n gÃ³p pháº§n quan trá»ng vÃ o sá»± phÃ¡t triá»ƒn cá»§a kiáº¿n trÃºc, Ä‘iÃªu kháº¯c qua viá»‡c xÃ¢y dá»±ng cÃ¡c chÃ¹a thÃ¡p, tÆ°á»£ng Pháº­t.","is_correct":true},{"statement":"Máº·c dÃ¹ cháº¿ Ä‘á»™ Ä‘áº³ng cáº¥p VÃ¡c-na gÃ¢y ra sá»± báº¥t bÃ¬nh Ä‘áº³ng sÃ¢u sáº¯c, nhÆ°ng nÃ³ láº¡i lÃ  yáº¿u tá»‘ then chá»‘t giÃºp duy trÃ¬ sá»± á»•n Ä‘á»‹nh xÃ£ há»™i vÃ  Ä‘oÃ n káº¿t cá»™ng Ä‘á»“ng trong suá»‘t hÃ ng nghÃ¬n nÄƒm cá»§a lá»‹ch sá»­ áº¤n Äá»™ cá»• Ä‘áº¡i.","is_correct":false}]},{"type":"multiple-choice","question":"Hai dÃ²ng sÃ´ng lá»›n nÃ o Ä‘Ã£ cÃ³ vai trÃ² quan trá»ng trong viá»‡c hÃ¬nh thÃ nh ná»n vÄƒn minh Trung Quá»‘c cá»• Ä‘áº¡i?","questionImage":null,"mappedType":"multiple-choice","options":["SÃ´ng Nin vÃ  sÃ´ng Æ -phrÃ¡t.","SÃ´ng áº¤n vÃ  sÃ´ng Háº±ng.","SÃ´ng HoÃ ng HÃ  vÃ  sÃ´ng TrÆ°á»ng Giang.","SÃ´ng Ti-gÆ¡-rÆ¡ vÃ  sÃ´ng HoÃ ng HÃ ."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Yáº¿u tá»‘ tá»± nhiÃªn nÃ o Ä‘Ã³ng vai trÃ² quan trá»ng nháº¥t trong viá»‡c hÃ¬nh thÃ nh ná»n vÄƒn minh Trung Quá»‘c cá»• Ä‘áº¡i?","questionImage":null,"mappedType":"multiple-choice","options":["CÃ¡c con sÃ´ng HoÃ ng HÃ  vÃ  TrÆ°á»ng Giang bá»“i Ä‘áº¯p phÃ¹ sa mÃ u má»¡.","Äá»‹a hÃ¬nh Ä‘á»“i nÃºi hiá»ƒm trá»Ÿ, táº¡o thÃ nh rÃ o cáº£n tá»± nhiÃªn báº£o vá»‡ Ä‘áº¥t nÆ°á»›c.","Vá»‹ trÃ­ Ä‘á»‹a lÃ­ gáº§n biá»ƒn, thuáº­n lá»£i cho giao thÆ°Æ¡ng hÃ ng háº£i.","KhÃ­ háº­u khÃ´ háº¡n, buá»™c ngÆ°á»i dÃ¢n pháº£i phÃ¡t triá»ƒn kÄ© thuáº­t thá»§y lá»£i sá»›m."],"optionsImage":[],"correctAnswerIndex":0},{"type":"true-false","main_question":"ÄÃ¡nh giÃ¡ cÃ¡c nháº­n Ä‘á»‹nh dÆ°á»›i Ä‘Ã¢y vá» Ä‘iá»u kiá»‡n tá»± nhiÃªn vÃ  quÃ¡ trÃ¬nh thá»‘ng nháº¥t Trung Quá»‘c cá»• Ä‘áº¡i:","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Ná»n vÄƒn minh Trung Quá»‘c cá»• Ä‘áº¡i hÃ¬nh thÃ nh vÃ  phÃ¡t triá»ƒn sá»›m trÃªn lÆ°u vá»±c hai con sÃ´ng lá»›n lÃ  HoÃ ng HÃ  vÃ  TrÆ°á»ng Giang.","is_correct":true},{"statement":"Sá»± bá»“i Ä‘áº¯p phÃ¹ sa cá»§a sÃ´ng HoÃ ng HÃ  vÃ  TrÆ°á»ng Giang Ä‘Ã£ táº¡o Ä‘iá»u kiá»‡n thuáº­n lá»£i cho viá»‡c phÃ¡t triá»ƒn nÃ´ng nghiá»‡p, lÃ  cÆ¡ sá»Ÿ quan trá»ng cho sá»± ra Ä‘á»i cá»§a nhÃ  nÆ°á»›c Trung Quá»‘c.","is_correct":true},{"statement":"Táº§n Thá»§y HoÃ ng lÃ  ngÆ°á»i Ä‘Ã£ thá»‘ng nháº¥t Trung Quá»‘c, cháº¥m dá»©t cá»¥c diá»‡n chia cáº¯t kÃ©o dÃ i vÃ  xÃ¡c láº­p cháº¿ Ä‘á»™ phong kiáº¿n táº­p quyá»n Ä‘áº§u tiÃªn.","is_correct":true},{"statement":"DÆ°á»›i thá»i Táº§n Thá»§y HoÃ ng, Nho giÃ¡o Ä‘Æ°á»£c Ä‘á» cao vÃ  trá»Ÿ thÃ nh tÆ° tÆ°á»Ÿng chÃ­nh thá»‘ng cá»§a nhÃ  nÆ°á»›c phong kiáº¿n Trung Quá»‘c, Ä‘á»‹nh hÃ¬nh xÃ£ há»™i phong kiáº¿n.","is_correct":false}]},{"type":"true-false","main_question":"ÄÃ¡nh giÃ¡ cÃ¡c nháº­n Ä‘á»‹nh dÆ°á»›i Ä‘Ã¢y vá» nhá»¯ng thÃ nh tá»±u vÄƒn hÃ³a tiÃªu biá»ƒu cá»§a Trung Quá»‘c cá»• Ä‘áº¡i Ä‘áº¿n tháº¿ ká»‰ VII:","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Nho giÃ¡o lÃ  má»™t trong nhá»¯ng há»‡ tÆ° tÆ°á»Ÿng lá»›n, cÃ³ áº£nh hÆ°á»Ÿng sÃ¢u rá»™ng Ä‘áº¿n Ä‘á»i sá»‘ng xÃ£ há»™i vÃ  chÃ­nh trá»‹ Trung Quá»‘c cá»• Ä‘áº¡i.","is_correct":true},{"statement":"Chá»¯ viáº¿t Trung Quá»‘c cá»• Ä‘áº¡i ban Ä‘áº§u lÃ  chá»¯ tÆ°á»£ng hÃ¬nh, sau nÃ y phÃ¡t triá»ƒn thÃ nh chá»¯ HÃ¡n Ä‘Æ°á»£c sá»­ dá»¥ng rá»™ng rÃ£i vÃ  cÃ³ áº£nh hÆ°á»Ÿng Ä‘áº¿n cÃ¡c nÆ°á»›c lÃ¡ng giá»ng.","is_correct":true},{"statement":"Bá»™ 'Sá»­ kÃ­' cá»§a nhÃ  sá»­ há»c TÆ° MÃ£ ThiÃªn lÃ  cÃ´ng trÃ¬nh sá»­ há»c Ä‘á»“ sá»™, Ä‘Æ°á»£c xem lÃ  Ä‘á»‰nh cao cá»§a sá»­ há»c Trung Quá»‘c cá»• Ä‘áº¡i vÃ  Ä‘áº·t ná»n mÃ³ng cho cÃ¡c tháº¿ há»‡ sau.","is_correct":true},{"statement":"Ká»¹ thuáº­t lÃ m giáº¥y Ä‘Æ°á»£c phÃ¡t minh á»Ÿ Trung Quá»‘c vÃ  Ä‘Ã£ Ä‘Æ°á»£c truyá»n bÃ¡ rá»™ng rÃ£i sang cÃ¡c nÆ°á»›c phÆ°Æ¡ng TÃ¢y qua Con Ä‘Æ°á»ng tÆ¡ lá»¥a ngay trong thá»i kÃ¬ cá»• Ä‘áº¡i (Ä‘áº¿n tháº¿ ká»‰ VII), gÃ³p pháº§n thÃºc Ä‘áº©y sá»± phÃ¡t triá»ƒn vÄƒn minh tháº¿ giá»›i.","is_correct":false}]},{"type":"true-false","main_question":"Chá»n phÃ¡t biá»ƒu Ä‘Ãºng hoáº·c sai vá» tÃ¡c Ä‘á»™ng cá»§a Ä‘iá»u kiá»‡n tá»± nhiÃªn Ä‘á»‘i vá»›i sá»± hÃ¬nh thÃ nh ná»n vÄƒn minh Trung Quá»‘c cá»• Ä‘áº¡i.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"SÃ´ng HoÃ ng HÃ  vÃ  TrÆ°á»ng Giang lÃ  hai con sÃ´ng lá»›n cÃ³ vai trÃ² quan trá»ng trong sá»± hÃ¬nh thÃ nh ná»n vÄƒn minh Trung Quá»‘c cá»• Ä‘áº¡i.","is_correct":true},{"statement":"LÆ°u vá»±c sÃ´ng HoÃ ng HÃ  lÃ  nÆ¡i cÃ³ Ä‘iá»u kiá»‡n tá»± nhiÃªn kháº¯c nghiá»‡t, gÃ¢y nhiá»u khÃ³ khÄƒn cho sá»± phÃ¡t triá»ƒn nÃ´ng nghiá»‡p.","is_correct":false},{"statement":"Há»‡ thá»‘ng Ä‘Ãª Ä‘iá»u vÃ  thá»§y lá»£i ra Ä‘á»i chá»§ yáº¿u do nhu cáº§u giao thÆ°Æ¡ng buÃ´n bÃ¡n giá»¯a cÃ¡c vÃ¹ng miá»n á»Ÿ Trung Quá»‘c cá»• Ä‘áº¡i.","is_correct":false},{"statement":"Do Ä‘iá»u kiá»‡n tá»± nhiÃªn biá»‡t láº­p bá»Ÿi cÃ¡c dÃ£y nÃºi vÃ  sa máº¡c á»Ÿ phÃ­a báº¯c vÃ  tÃ¢y, vÄƒn minh Trung Quá»‘c cá»• Ä‘áº¡i Ã­t bá»‹ áº£nh hÆ°á»Ÿng bá»Ÿi cÃ¡c ná»n vÄƒn minh bÃªn ngoÃ i.","is_correct":true}]},{"type":"true-false","main_question":"Chá»n phÃ¡t biá»ƒu Ä‘Ãºng hoáº·c sai vá» quÃ¡ trÃ¬nh thá»‘ng nháº¥t dÆ°á»›i thá»i Táº§n Thá»§y HoÃ ng vÃ  cÃ¡c thÃ nh tá»±u vÄƒn hÃ³a tiÃªu biá»ƒu cá»§a Trung Quá»‘c cá»• Ä‘áº¡i.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Táº§n Thá»§y HoÃ ng lÃ  ngÆ°á»i Ä‘Ã£ cháº¥m dá»©t thá»i kÃ¬ XuÃ¢n Thu - Chiáº¿n Quá»‘c vÃ  thá»‘ng nháº¥t Trung Quá»‘c.","is_correct":true},{"statement":"DÆ°á»›i thá»i Táº§n Thá»§y HoÃ ng, tÆ° tÆ°á»Ÿng Nho giÃ¡o Ä‘Æ°á»£c Ä‘á» cao vÃ  trá»Ÿ thÃ nh há»‡ tÆ° tÆ°á»Ÿng chÃ­nh thá»©c cá»§a nhÃ  nÆ°á»›c.","is_correct":false},{"statement":"Chá»¯ viáº¿t cá»§a Trung Quá»‘c cá»• Ä‘áº¡i Ä‘Ã£ hÃ¬nh thÃ nh tá»« thá»i nhÃ  ThÆ°Æ¡ng, nhÆ°ng chá»‰ Ä‘áº¿n thá»i Táº§n Thá»§y HoÃ ng má»›i Ä‘Æ°á»£c thá»‘ng nháº¥t thÃ nh má»™t loáº¡i chá»¯ viáº¿t chung.","is_correct":true},{"statement":"Y há»c Trung Quá»‘c cá»• Ä‘áº¡i Ä‘Ã£ phÃ¡t triá»ƒn cÃ¡c phÆ°Æ¡ng phÃ¡p chá»¯a bá»‡nh phá»©c táº¡p nhÆ° pháº«u thuáº­t ná»™i táº¡ng vÃ  cáº¥y ghÃ©p táº¡ng tá»« ráº¥t sá»›m.","is_correct":false}]},{"type":"multiple-choice","question":"Äiá»u kiá»‡n tá»± nhiÃªn nÃ o Ä‘Ã£ tÃ¡c Ä‘á»™ng máº¡nh máº½ Ä‘áº¿n viá»‡c hÃ¬nh thÃ nh cÃ¡c nhÃ  nÆ°á»›c thÃ nh bang Ä‘á»™c láº­p, tá»± trá»‹ á»Ÿ Hy Láº¡p cá»• Ä‘áº¡i?","questionImage":null,"mappedType":"multiple-choice","options":["Äá»‹a hÃ¬nh chá»§ yáº¿u lÃ  Ä‘á»“i nÃºi, bá»‹ chia cáº¯t máº¡nh bá»Ÿi nhiá»u dÃ£y nÃºi vÃ  biá»ƒn.","CÃ³ nhiá»u dÃ²ng sÃ´ng lá»›n cháº£y qua, Ä‘áº¥t Ä‘ai phÃ¹ sa mÃ u má»¡.","KhÃ­ háº­u nÃ³ng áº©m quanh nÄƒm, thuáº­n lá»£i cho nÃ´ng nghiá»‡p lÃºa nÆ°á»›c.","GiÃ u tÃ i nguyÃªn khoÃ¡ng sáº£n quÃ½ hiáº¿m nhÆ° vÃ ng, báº¡c, Ä‘Ã¡ quÃ½."],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"CÃ¡c vÆ°Æ¡ng quá»‘c cá»• á»Ÿ ÄÃ´ng Nam Ã (nhÆ° ChÄƒm-pa, PhÃ¹ Nam) Ä‘Ã£ xuáº¥t hiá»‡n vÃ o khoáº£ng thá»i gian nÃ o?","questionImage":null,"mappedType":"multiple-choice","options":["TrÆ°á»›c tháº¿ ká»‰ VII","Tá»« tháº¿ ká»‰ VII Ä‘áº¿n tháº¿ ká»‰ X","Sau tháº¿ ká»‰ X","Tá»« tháº¿ ká»‰ XII trá»Ÿ Ä‘i"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"CÃ¡c vÆ°Æ¡ng quá»‘c cá»• á»Ÿ ÄÃ´ng Nam Ã nhÆ° PhÃ¹ Nam, ChÄƒm-pa Ä‘Ã£ sá»›m hÃ¬nh thÃ nh vÃ  phÃ¡t triá»ƒn máº¡nh máº½ cÃ¡c hoáº¡t Ä‘á»™ng giao thÆ°Æ¡ng Ä‘Æ°á»ng biá»ƒn. NguyÃªn nhÃ¢n chá»§ yáº¿u dáº«n Ä‘áº¿n sá»± phÃ¡t triá»ƒn nÃ y lÃ  gÃ¬?","questionImage":null,"mappedType":"multiple-choice","options":["ÄÆ°á»£c sá»± báº£o há»™ cá»§a cÃ¡c Ä‘áº¿ quá»‘c lá»›n.","Tiáº¿p thu máº¡nh máº½ khoa há»c - kÄ© thuáº­t hÃ ng háº£i tá»« phÆ°Æ¡ng TÃ¢y.","Vá»‹ trÃ­ Ä‘á»‹a lÃ­ náº±m trÃªn tuyáº¿n Ä‘Æ°á»ng giao thÆ°Æ¡ng hÃ ng háº£i quá»‘c táº¿, cÃ³ nhiá»u cáº£ng biá»ƒn tá»± nhiÃªn, thuáº­n lá»£i cho viá»‡c tiáº¿p xÃºc vÃ  buÃ´n bÃ¡n vá»›i bÃªn ngoÃ i.","CÃ³ nguá»“n tÃ i nguyÃªn thiÃªn nhiÃªn phong phÃº Ä‘á»ƒ xuáº¥t kháº©u."],"optionsImage":[],"correctAnswerIndex":2},{"type":"essay","question":"La MÃ£ cá»• Ä‘áº¡i Ä‘Ã£ Ä‘á»ƒ láº¡i nhiá»u dáº¥u áº¥n sÃ¢u sáº¯c trong lá»‹ch sá»­ nhÃ¢n loáº¡i, tá»« thá»ƒ cháº¿ chÃ­nh trá»‹ Ä‘áº¿n nhá»¯ng thÃ nh tá»±u vÄƒn hÃ³a rá»±c rá»¡. Dá»±a vÃ o kiáº¿n thá»©c Ä‘Ã£ há»c, em hÃ£y phÃ¢n tÃ­ch:\n1. Sá»± áº£nh hÆ°á»Ÿng cá»§a Ä‘iá»u kiá»‡n tá»± nhiÃªn Ä‘á»‘i vá»›i sá»± phÃ¡t triá»ƒn kinh táº¿ vÃ  chÃ­nh trá»‹ cá»§a La MÃ£ cá»• Ä‘áº¡i.\n2. Nhá»¯ng Ä‘Ã³ng gÃ³p ná»•i báº­t cá»§a La MÃ£ cá»• Ä‘áº¡i trong lÄ©nh vá»±c kiáº¿n trÃºc vÃ  phÃ¡p luáº­t, Ä‘á»“ng thá»i liÃªn há»‡ má»™t vÃ­ dá»¥ cá»¥ thá»ƒ vá» sá»± áº£nh hÆ°á»Ÿng cá»§a nhá»¯ng thÃ nh tá»±u nÃ y Ä‘á»‘i vá»›i xÃ£ há»™i hiá»‡n nay.","questionImage":null,"mappedType":"essay","answer":"Gá»£i Ã½ Ä‘Ã¡p Ã¡n:\n1.  **áº¢nh hÆ°á»Ÿng cá»§a Ä‘iá»u kiá»‡n tá»± nhiÃªn:**\n    *   **Vá»‹ trÃ­ Ä‘á»‹a lÃ­:** BÃ¡n Ä‘áº£o Italia náº±m á»Ÿ trung tÃ¢m Äá»‹a Trung Háº£i, lÃ  cáº§u ná»‘i giá»¯a ba chÃ¢u lá»¥c (Ã‚u, Ã, Phi), táº¡o Ä‘iá»u kiá»‡n thuáº­n lá»£i cho giao thÆ°Æ¡ng, buÃ´n bÃ¡n vÃ  má»Ÿ rá»™ng lÃ£nh thá»•.\n    *   **KhÃ­ háº­u vÃ  Ä‘áº¥t Ä‘ai:** KhÃ­ háº­u Äá»‹a Trung Háº£i áº¥m Ã¡p, Ä‘áº¥t Ä‘ai mÃ u má»¡ á»Ÿ má»™t sá»‘ vÃ¹ng (nhÆ° Ä‘á»“ng báº±ng Latium), thuáº­n lá»£i cho phÃ¡t triá»ƒn nÃ´ng nghiá»‡p (trá»“ng lÃºa mÃ¬, nho, Ã´ liu) vÃ  chÄƒn nuÃ´i. Tuy nhiÃªn, Ä‘á»‹a hÃ¬nh Ä‘á»“i nÃºi chiáº¿m pháº§n lá»›n cÅ©ng thÃºc Ä‘áº©y ngÆ°á»i La MÃ£ tÃ¬m kiáº¿m Ä‘áº¥t Ä‘ai má»›i, dáº«n Ä‘áº¿n cÃ¡c cuá»™c chinh pháº¡t.\n    *   **TÃ i nguyÃªn:** CÃ³ cÃ¡c má» kim loáº¡i (sáº¯t, Ä‘á»“ng), nguá»“n Ä‘Ã¡ xÃ¢y dá»±ng dá»“i dÃ o, táº¡o ná»n táº£ng cho sá»± phÃ¡t triá»ƒn cá»§a thá»§ cÃ´ng nghiá»‡p vÃ  kiáº¿n trÃºc.\n    *   **Há»‡ thá»‘ng sÃ´ng ngÃ²i:** CÃ¡c con sÃ´ng nhÆ° Tiber táº¡o Ä‘iá»u kiá»‡n thuáº­n lá»£i cho giao thÃ´ng ná»™i Ä‘á»‹a vÃ  cung cáº¥p nÆ°á»›c cho nÃ´ng nghiá»‡p.\n    *   **TÃ¡c Ä‘á»™ng Ä‘áº¿n chÃ­nh trá»‹:** Äiá»u kiá»‡n tá»± nhiÃªn Ä‘a dáº¡ng vÃ  vá»‹ trÃ­ trung tÃ¢m gÃ³p pháº§n hÃ¬nh thÃ nh má»™t nhÃ  nÆ°á»›c máº¡nh máº½, cÃ³ kháº£ nÄƒng tá»• chá»©c quÃ¢n sá»± Ä‘á»ƒ chinh phá»¥c vÃ  quáº£n lÃ½ má»™t Ä‘áº¿ cháº¿ rá»™ng lá»›n.\n\n2.  **ÄÃ³ng gÃ³p vá» kiáº¿n trÃºc vÃ  phÃ¡p luáº­t, vÃ  sá»± áº£nh hÆ°á»Ÿng Ä‘áº¿n hiá»‡n nay:**\n    *   **Kiáº¿n trÃºc:**\n        *   NgÆ°á»i La MÃ£ ná»•i tiáº¿ng vá»›i viá»‡c xÃ¢y dá»±ng cÃ¡c cÃ´ng trÃ¬nh kiáº¿n trÃºc Ä‘á»“ sá»™, kiÃªn cá»‘ vÃ  cÃ³ tÃ­nh thá»±c dá»¥ng cao nhÆ° **Ä‘áº¥u trÆ°á»ng (Colosseum)**, **kháº£i hoÃ n mÃ´n**, **Ä‘á»n thá» (Pantheon)**, **cÃ´ng trÃ¬nh dáº«n nÆ°á»›c (á»‘ng mÃ¡ng)**, **cáº§u cá»‘ng**, **Ä‘Æ°á»ng sÃ¡**. Há» Ä‘Ã£ á»©ng dá»¥ng thÃ nh cÃ´ng **vÃ²m cuá»‘n, mÃ¡i trÃ²n vÃ  bÃª tÃ´ng** trong xÃ¢y dá»±ng.\n        *   **áº¢nh hÆ°á»Ÿng hiá»‡n nay:** Nhiá»u kiáº¿n trÃºc sÆ° ngÃ y nay váº«n láº¥y cáº£m há»©ng tá»« phong cÃ¡ch kiáº¿n trÃºc La MÃ£. CÃ¡c cÃ´ng trÃ¬nh cÃ´ng cá»™ng nhÆ° sÃ¢n váº­n Ä‘á»™ng, nhÃ  hÃ¡t, há»‡ thá»‘ng cáº§u Ä‘Æ°á»ng, thá»§y lá»£i hiá»‡n Ä‘áº¡i váº«n káº¿ thá»«a nhá»¯ng nguyÃªn lÃ­ xÃ¢y dá»±ng bá»n vá»¯ng vÃ  thiáº¿t káº¿ chá»©c nÄƒng cá»§a ngÆ°á»i La MÃ£.\n    *   **PhÃ¡p luáº­t:**\n        *   **Luáº­t phÃ¡p La MÃ£** Ä‘Æ°á»£c coi lÃ  má»™t trong nhá»¯ng thÃ nh tá»±u vÄ© Ä‘áº¡i nháº¥t cá»§a ná»n vÄƒn minh cá»• Ä‘áº¡i, vá»›i há»‡ thá»‘ng luáº­t cháº·t cháº½, chi tiáº¿t, bao gá»“m **Luáº­t DÃ¢n sá»±, Luáº­t CÃ´ng, Luáº­t Tá»‘ tá»¥ng, Luáº­t Quá»‘c táº¿**. CÃ¡c nguyÃªn táº¯c nhÆ° **"}];
            const quizOptions = {"timeLimit":45,"retriesAllowed":1,"showAnswers":true,"showExplanation":true,"aiAssessment":true,"scoring":{"mc":5,"tf":2,"sa":2,"essay":1,"tfMethod":"progressive"}};
            const googleScriptUrl = "https://docs.google.com/document/d/1MlcXqtM2AwsLxUe5hVgsu-qK0aDVvwtexuxW0rl1a1E/edit?tab=t.0";
            const correctExamCode = "99TPGP";
            const teacherApiKey = "AIzaSyD6NfqsNprHk70OU5RMmmng-zoRV_kKVMY";
            let studentInfo = {};
            let isSubmitted = false;
            let timerInterval;
            let retriesLeft = quizOptions.retriesAllowed;
            let studentApiKey = "";
            let ai = null;

            let proctoringLog = {
                thoatManHinh: 0,
                saoChep: 0,
                dan: 0,
                suKien: []
            };

            const studentQuizContainer = document.getElementById('student-quiz-container');
            const submitBtn = document.getElementById('submit-quiz-btn');
            const resultContainer = document.getElementById('result-container');
            const postSubmitOptions = document.getElementById('post-submit-options');
            const retryBtn = document.getElementById('retry-quiz-btn');
            const loginModal = document.getElementById('login-modal');
            const studentInfoForm = document.getElementById('student-info-form');
            const timerDisplay = document.getElementById('timer-display');
            const retriesDisplay = document.getElementById('retries-display');

            function formatAIText(text) {
                if (!text) return '';
                let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                formattedText = formattedText.replace(/\n/g, '<br>');
                return formattedText;
            }

            function shuffleQuiz() {
                // Shuffle options/statements within each question first
                quizData.forEach(item => {
                    // Shuffle multiple-choice options and their corresponding images
                    if (item.mappedType === 'multiple-choice' && item.options && item.options.length > 0) {
                        const correctAnswerText = item.options[item.correctAnswerIndex];
                        let optionsWithImages = item.options.map((opt, index) => ({
                            text: opt,
                            image: (item.optionsImage && item.optionsImage[index]) ? item.optionsImage[index] : null
                        }));
                        // Fisher-Yates shuffle
                        for (let i = optionsWithImages.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [optionsWithImages[i], optionsWithImages[j]] = [optionsWithImages[j], optionsWithImages[i]];
                        }
                        // Update the item with shuffled data
                        item.options = optionsWithImages.map(opt => opt.text);
                        item.optionsImage = optionsWithImages.map(opt => opt.image);
                        item.correctAnswerIndex = item.options.indexOf(correctAnswerText);
                    }
                    // Shuffle true-false statements
                    if (item.mappedType === 'true-false' && item.statements && item.statements.length > 0) {
                         for (let i = item.statements.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [item.statements[i], item.statements[j]] = [item.statements[j], item.statements[i]];
                        }
                    }
                });
                // Then, group questions by type and shuffle within each group
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});
                let shuffledQuizData = [];
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    if (grouped[partType]) {
                        const partQuestions = grouped[partType];
                        for (let i = partQuestions.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [partQuestions[i], partQuestions[j]] = [partQuestions[j], partQuestions[i]];
                        }
                        shuffledQuizData = shuffledQuizData.concat(partQuestions);
                    }
                });
               
                quizData = shuffledQuizData;
            }
            // --- Timer Function ---
            function startTimer(duration, display) {
                let timer = duration, minutes, seconds;
                clearInterval(timerInterval); // Clear any existing timer
                if(duration <= 0) {
                     display.textContent = "âˆ";
                     return;
                }
                timerInterval = setInterval(function () {
                    minutes = parseInt(timer / 60, 10);
                    seconds = parseInt(timer % 60, 10);
                    minutes = minutes < 10 ? "0" + minutes : minutes;
                    seconds = seconds < 10 ? "0" + seconds : seconds;
                    display.textContent = minutes + ":" + seconds;
                    if (--timer < 0) {
                        clearInterval(timerInterval);
                        alert("Háº¿t giá» lÃ m bÃ i!");
                        handleSubmit();
                    }
                }, 1000);
            }
            
            async function showExplanation(index, button) {
                const item = quizData[index];
                const questionCard = document.getElementById(`student-q-${index}`);
                const feedbackDiv = document.getElementById(`q-${index}-feedback`);
                if (!questionCard || !feedbackDiv) return;

                const existingExplanation = feedbackDiv.querySelector('.ai-explanation');
                if (existingExplanation) {
                    existingExplanation.remove();
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Xem giáº£i thÃ­ch
                    `;
                    return;
                }

                button.disabled = true;
                button.innerHTML = '<div class="loader mr-2"></div> Äang táº£i...';

                if (item.explanation) {
                    displayExplanation(item.explanation, feedbackDiv, button);
                    return;
                }

                if (!ai) {
                    alert("TÃ­nh nÄƒng giáº£i thÃ­ch yÃªu cáº§u API Key, nhÆ°ng chÆ°a Ä‘Æ°á»£c cáº¥u hÃ¬nh bá»Ÿi giÃ¡o viÃªn.");
                    button.disabled = false;
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Xem giáº£i thÃ­ch
                    `;
                    return;
                }

                const questionText = item.question || item.main_question;
                let prompt = `Báº¡n lÃ  má»™t trá»£ lÃ½ giÃ¡o viÃªn AI, am hiá»ƒu sÃ¢u sáº¯c ChÆ°Æ¡ng trÃ¬nh GDPT 2018. HÃ£y cung cáº¥p má»™t lá»i giáº£i chi tiáº¿t, tá»«ng bÆ°á»›c má»™t cho cÃ¢u há»i sau Ä‘Ã¢y. Lá»i giáº£i pháº£i chÃ­nh xÃ¡c, dá»… hiá»ƒu vÃ  phÃ¹ há»£p vá»›i phÆ°Æ¡ng phÃ¡p giáº£ng dáº¡y cá»§a chÆ°Æ¡ng trÃ¬nh há»c, TUYá»†T Äá»I KHÃ”NG sá»­ dá»¥ng kiáº¿n thá»©c cá»§a lá»›p cao hÆ¡n Ä‘á»ƒ giáº£i thÃ­ch.\n\n--- CÃ‚U Há»I ---\n${questionText}\n\n`;
                if (item.mappedType === 'multiple-choice') {
                    prompt += `--- CÃC Lá»°A CHá»ŒN ---\n${item.options.map((opt, i) => `${String.fromCharCode(65 + i)}. ${opt}`).join('\n')}\n\n`;
                    prompt += `--- ÄÃP ÃN ÄÃšNG ---\n${String.fromCharCode(65 + item.correctAnswerIndex)}. ${item.options[item.correctAnswerIndex]}`;
                } else if (item.mappedType === 'true-false') {
                    prompt += `--- CÃC Má»†NH Äá»€ & ÄÃP ÃN ---\n${item.statements.map(s => ` - ${s.statement} -> ${s.is_correct ? 'ÄÃºng' : 'Sai'}`).join('\n')}`;
                } else {
                    prompt += `--- ÄÃP ÃN / Gá»¢I Ã ---\n${item.answer}`;
                }
                prompt += `\n\n--- YÃŠU Cáº¦U ---\nGiáº£i thÃ­ch rÃµ rÃ ng táº¡i sao Ä‘Ã¡p Ã¡n láº¡i Ä‘Ãºng, tá»«ng bÆ°á»›c má»™t. DÃ¹ng **...** Ä‘á»ƒ in Ä‘áº­m cÃ¡c thuáº­t ngá»¯ quan trá»ng. Äá»‹nh dáº¡ng táº¥t cáº£ cÃ¡c cÃ´ng thá»©c toÃ¡n há»c báº±ng LaTeX.`;

                try {
                    const response = await ai.models.generateContent({ model: "gemini-2.5-flash", contents: prompt });
                    const explanationText = response.text; // Keep it raw
                    item.explanation = explanationText; // Cache it
                    displayExplanation(explanationText, feedbackDiv, button);
                } catch (error) {
                    console.error("Lá»—i khi táº¡o giáº£i thÃ­ch:", error);
                    feedbackDiv.insertAdjacentHTML('beforeend', '<div class="ai-explanation text-red-600">Lá»—i: KhÃ´ng thá»ƒ táº¡o giáº£i thÃ­ch.</div>');
                    button.disabled = false;
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Thá»­ láº¡i
                    `;
                }
            }

            function displayExplanation(explanationText, container, button) {
                container.insertAdjacentHTML('beforeend', `<div class="ai-explanation prose prose-sm">${formatAIText(explanationText)}</div>`);
                if (window.MathJax) MathJax.typesetPromise([container]);
                button.disabled = false;
                button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    áº¨n giáº£i thÃ­ch
                `;
            }
           
            function renderStudentQuiz() {
                studentQuizContainer.innerHTML = '';
               
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});
                const groupInfo = {
                    'multiple-choice': { title: 'PHáº¦N I. TRáº®C NGHIá»†M KHÃCH QUAN', subtitle: 'Chá»n Ä‘Ã¡p Ã¡n Ä‘Ãºng nháº¥t trong cÃ¡c lá»±a chá»n sau.' },
                    'true-false': { title: 'PHáº¦N II. CÃ‚U Há»I ÄÃšNG - SAI', subtitle: 'XÃ¡c Ä‘á»‹nh tÃ­nh Ä‘Ãºng hoáº·c sai cho má»—i má»‡nh Ä‘á» dÆ°á»›i Ä‘Ã¢y.' },
                    'short-answer': { title: 'PHáº¦N III. CÃ‚U Há»I TRáº¢ Lá»œI NGáº®N', subtitle: 'Äiá»n Ä‘Ã¡p Ã¡n ngáº¯n gá»n vÃ o pháº§n tráº£ lá»i.' },
                    'essay': { title: 'PHáº¦N IV. CÃ‚U Há»I Tá»° LUáº¬N', subtitle: 'TrÃ¬nh bÃ y chi tiáº¿t bÃ i giáº£i cá»§a báº¡n.' }
                };
               
                let questionCounter = 0;
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    const questions = grouped[partType];
                    if (!questions || questions.length === 0) return;
                   
                    let groupHTML = `<div class="group-container space-y-8 mb-12">`;
                    const info = groupInfo[partType];
                    groupHTML += `
                        <div class="group-header pb-3 border-b-2 border-slate-300 mb-6">
                            <h2 class="text-2xl font-bold text-slate-800">${info.title}</h2>
                            ${info.subtitle ? `<p class="text-md text-slate-600 italic mt-1">${info.subtitle}</p>` : ''}
                        </div>
                    `;
                    questions.forEach((item, localIndex) => {
                        const globalIndex = quizData.indexOf(item);
                        questionCounter++;
                        groupHTML += `<div class="question-card" id="student-q-${globalIndex}">`;
                        let questionText = (item.question || item.main_question || '').replace(/\n/g, '<br>');
                       
                        groupHTML += `<div class="flex items-start">
                                     <div class="flex-grow">
                                         <div class="flex items-center mb-2">
                                             <span class="font-bold text-lg mr-3 text-indigo-600">CÃ¢u ${questionCounter}:</span>
                                             <div id="q-${globalIndex}-feedback-icon"></div>
                                         </div>
                                         <div class="question-content mt-2 text-lg text-slate-700">${questionText}</div>
                                         ${item.questionImage ? `<img src="${item.questionImage}" class="mt-4 rounded-lg max-w-full md:max-w-md border shadow-sm">` : ''}
                                     </div>
                                 </div>`;
                       
                        groupHTML += `<div class="mt-6">`;
                        switch(item.mappedType) {
                            case 'multiple-choice':
                                groupHTML += `<div class="options-grid grid grid-cols-1 md:grid-cols-2 gap-4">`;
                                item.options.forEach((opt, i) => {
                                    groupHTML += `<label for="q${globalIndex}-opt${i}" id="q${globalIndex}-opt-label${i}" class="option-label flex items-start p-4 border-2 rounded-xl cursor-pointer hover:bg-indigo-50 hover:border-indigo-400">
                                                     <input type="radio" name="q${globalIndex}" id="q${globalIndex}-opt${i}" value="${i}" class="flex-shrink-0 mt-1 h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                                     <div class="ml-3 flex-grow">
                                                         <span class="font-semibold text-slate-800">${String.fromCharCode(65 + i)}.</span>
                                                         <span class="option-content text-slate-700">${opt || ''}</span>
                                                         ${(item.optionsImage && item.optionsImage[i]) ? `<img src="${item.optionsImage[i]}" class="mt-2 rounded-lg max-w-xs border shadow-sm">` : ''}
                                                     </div>
                                                 </label>`;
                                });
                                groupHTML += `</div>`;
                                break;
                            case 'true-false':
                                 groupHTML += `<div class="space-y-4">`;
                                 item.statements.forEach((s, i) => {
                                     groupHTML += `<div class="statement-item border-t pt-4">
                                                  <p class="mb-3 text-slate-700">${String.fromCharCode(97 + i)}) ${s.statement || ''}</p>
                                                  <div class="flex gap-x-6">
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="true" class="mr-2 h-4 w-4"> ÄÃºng</label>
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="false" class="mr-2 h-4 w-4"> Sai</label>
                                                  </div>
                                              </div>`;
                                 });
                                 groupHTML += `</div>`;
                                 break;
                            case 'short-answer':
                                groupHTML += `<input type="text" name="q${globalIndex}" class="mt-1 block w-full md:w-1/2 border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Nháº­p Ä‘Ã¡p Ã¡n cá»§a báº¡n...">`;
                                break;
                            case 'essay':
                                groupHTML += `<textarea name="q${globalIndex}" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" rows="5" placeholder="Nháº­p cÃ¢u tráº£ lá»i tá»± luáº­n cá»§a báº¡n..."></textarea>`;
                                break;
                        }
                        groupHTML += `</div><div id="q-${globalIndex}-feedback" class="mt-4"></div></div>`;
                    });
                    groupHTML += `</div>`;
                    studentQuizContainer.innerHTML += groupHTML;
                });
               
                if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                    MathJax.typesetPromise([studentQuizContainer]);
                }
            }
           
            async function generatePerformanceReview(allAnswersData) {
                const feedbackContainer = document.getElementById('ai-feedback-container');
                if (!feedbackContainer || !ai) return null;
                feedbackContainer.classList.remove('hidden');
                feedbackContainer.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-slate-800 mb-4">ğŸ“ PhÃ¢n TÃ­ch & Gá»£i Ã Tá»« Trá»£ LÃ½ AI</h3>
                        <div id="ai-feedback-loader" class="text-center py-6">
                            <svg class="animate-spin mx-auto h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p class="mt-3 text-slate-600">AI Ä‘ang phÃ¢n tÃ­ch bÃ i lÃ m cá»§a báº¡n...</p>
                        </div>
                        <div id="ai-feedback-summary" class="hidden prose prose-sm max-w-none"></div>
                        <div id="ai-feedback-details" class="hidden mt-4 space-y-2"></div>
                    </div>
                `;
               
                const loader = document.getElementById('ai-feedback-loader');
                const summaryDiv = document.getElementById('ai-feedback-summary');
                const detailsDiv = document.getElementById('ai-feedback-details');
                const incorrectAnswers = allAnswersData.filter(a => !a.isCorrect);
                if (incorrectAnswers.length === 0) {
                    feedbackContainer.innerHTML = `
                        <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                            <h3 class="text-xl font-bold text-green-600">ğŸ‰ ChÃºc má»«ng!</h3>
                            <p class="mt-2 text-slate-700">Báº¡n Ä‘Ã£ tráº£ lá»i Ä‘Ãºng táº¥t cáº£ cÃ¡c cÃ¢u há»i. LÃ m tá»‘t láº¯m!</p>
                        </div>
                    `;
                    return { overallFeedback: { summary: "Xuáº¥t sáº¯c! Há»c sinh Ä‘Ã£ Ä‘Ã£ tráº£ lá»i Ä‘Ãºng táº¥t cáº£ cÃ¡c cÃ¢u há»i." } };
                }
                const summaryPrompt = `Báº¡n lÃ  má»™t trá»£ lÃ½ giÃ¡o viÃªn, nÃ³i tiáº¿ng Viá»‡t. Dá»±a vÃ o tÃ³m táº¯t cÃ¡c cÃ¢u tráº£ lá»i sai cá»§a há»c sinh, hÃ£y Ä‘Æ°a ra má»™t nháº­n xÃ©t tá»•ng quan ngáº¯n gá»n (khoáº£ng 3-4 cÃ¢u) vá» nÄƒng lá»±c cá»§a há»c sinh, bao gá»“m Ä‘iá»ƒm máº¡nh (suy luáº­n tá»« cÃ¡c cÃ¢u lÃ m Ä‘Ãºng), Ä‘iá»ƒm yáº¿u (dá»±a trÃªn cÃ¡c cÃ¢u sai) vÃ  má»™t vÃ i gá»£i Ã½ Ã´n táº­p chung. Lá»i vÄƒn pháº£i khÃ­ch lá»‡, rÃµ rÃ ng. DÃ¹ng **...** Ä‘á»ƒ in Ä‘áº­m cÃ¡c thuáº­t ngá»¯ quan trá»ng.
                TÃ³m táº¯t lá»—i sai:
                ${JSON.stringify(incorrectAnswers.map(a => ({ cau: a.questionNumber, loai: a.type, cauHoi: a.question.substring(0, 50) + '...' })), null, 2)}`;
                try {
                    const response = await ai.models.generateContent({
                        model: "gemini-2.5-flash",
                        contents: summaryPrompt
                    });
                    summaryDiv.innerHTML = formatAIText(response.text);
                    loader.classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                    detailsDiv.classList.remove('hidden'); 
                } catch (e) {
                    console.error("Lá»—i khi láº¥y nháº­n xÃ©t tá»•ng quan:", e);
                    summaryDiv.innerHTML = '<p class="text-red-600">Lá»—i khi táº¡o nháº­n xÃ©t tá»•ng quan.</p>';
                    loader.classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                }
               
                const summaryForSheet = summaryDiv.innerText.substring(0, 200) + "...";
                return { overallFeedback: { summary: summaryForSheet } };
            }
            async function handleSubmit() {
                if (isSubmitted) return;
                isSubmitted = true;
                clearInterval(timerInterval);
                
                document.querySelectorAll('input, textarea').forEach(input => input.disabled = true);
                submitBtn.classList.add('hidden');
                postSubmitOptions.classList.remove('hidden');
                if (retriesLeft > 0) {
                    retryBtn.classList.remove('hidden');
                } else {
                    retryBtn.classList.add('hidden');
                }

                const proctoringDataString = JSON.stringify(proctoringLog);

                let totalStudentScore = 0;
                let totalCorrectAnswers = 0;
                let allAnswersData = [];
                const questionCounts = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    acc[type] = (acc[type] || 0) + 1;
                    return acc;
                }, {});
                
                quizData.forEach((item, index) => {
                    let questionNumber = index + 1;
                    let answerData = { questionNumber, type: item.type };
                    switch (item.mappedType) {
                        case 'multiple-choice':
                            const selectedOption = document.querySelector(`input[name="q${index}"]:checked`);
                            const isCorrectMC = selectedOption ? parseInt(selectedOption.value) === item.correctAnswerIndex : false;
                            if (isCorrectMC) {
                                totalCorrectAnswers++;
                                if (questionCounts['multiple-choice'] > 0) {
                                   totalStudentScore += quizOptions.scoring.mc / questionCounts['multiple-choice'];
                                }
                            }
                            answerData.question = item.question;
                            answerData.options = item.options;
                            answerData.yourAnswer = selectedOption ? String.fromCharCode(65 + parseInt(selectedOption.value)) : "KhÃ´ng tráº£ lá»i";
                            answerData.correctAnswer = String.fromCharCode(65 + item.correctAnswerIndex);
                            answerData.isCorrect = isCorrectMC;
                            break;
                        case 'true-false':
                            let correctStatementsCount = 0;
                            let yourAnswerPattern = [];
                            let correctAnswerPattern = [];
                            let details = [];
                            item.statements.forEach((s, i) => {
                                const selectedTF = document.querySelector(`input[name="q${index}-s${i}"]:checked`);
                                const studentChoice = selectedTF ? selectedTF.value === 'true' : null;
                                const isStatementCorrect = studentChoice === s.is_correct;
                               
                                if (isStatementCorrect) correctStatementsCount++;
                               
                                yourAnswerPattern.push(studentChoice === null ? '?' : (studentChoice ? 'Ä' : 'S'));
                                correctAnswerPattern.push(s.is_correct ? 'Ä' : 'S');
                                details.push({ statement: s.statement, yourChoice: studentChoice === null ? 'KhÃ´ng tráº£ lá»i' : (studentChoice ? 'ÄÃºng' : 'Sai'), correctChoice: s.is_correct ? 'ÄÃºng' : 'Sai', isCorrect: isStatementCorrect });
                            });
                            
                            let scorePerTfQuestion = 0;
                            if (questionCounts['true-false'] > 0) {
                                scorePerTfQuestion = quizOptions.scoring.tf / questionCounts['true-false'];
                            }
                            let questionPoints = 0;
                            if (quizOptions.scoring.tfMethod === 'progressive') {
                                const progressivePoints = { 0: 0, 1: 0.1, 2: 0.25, 3: 0.5, 4: 1.0 };
                                questionPoints = progressivePoints[correctStatementsCount] * scorePerTfQuestion;
                            } else { // even
                                questionPoints = (correctStatementsCount / 4) * scorePerTfQuestion;
                            }
                            totalStudentScore += questionPoints;

                            if(correctStatementsCount === 4) totalCorrectAnswers++;
                            answerData.question = item.main_question;
                            answerData.yourAnswer = yourAnswerPattern.join('-');
                            answerData.correctAnswer = correctAnswerPattern.join('-');
                            answerData.isCorrect = correctStatementsCount === 4;
                            answerData.details = details;
                            break;
                       
                        case 'short-answer':
                            const saInput = document.querySelector(`input[name="q${index}"]`);
                            const studentAnswerRaw = saInput ? (saInput.value ?? '').trim() : "";
                            const correctAnswerRaw = (item.answer ?? '').toString().trim().replace(/\$/g, '');
                            let isCorrectSA = false;
                            const studentAnswerNormalized = studentAnswerRaw.replace(',', '.');
                            const correctAnswerNormalized = correctAnswerRaw.replace(',', '.');
                            if (studentAnswerNormalized.toLowerCase() === correctAnswerNormalized.toLowerCase()) {
                                isCorrectSA = true;
                            }
                             if (isCorrectSA) {
                                totalCorrectAnswers++;
                                if (questionCounts['short-answer'] > 0) {
                                   totalStudentScore += quizOptions.scoring.sa / questionCounts['short-answer'];
                                }
                            }
                            answerData.question = item.question;
                            answerData.yourAnswer = studentAnswerRaw || "KhÃ´ng tráº£ lá»i";
                            answerData.correctAnswer = correctAnswerRaw;
                            answerData.isCorrect = isCorrectSA;
                            break;
                           
                        case 'essay':
                             const essayInput = document.querySelector(`textarea[name="q${index}"]`);
                             answerData.question = item.question;
                             answerData.yourAnswer = essayInput.value || "KhÃ´ng tráº£ lá»i";
                             answerData.correctAnswer = item.answer;
                             answerData.isCorrect = null; // Needs manual grading
                             break;
                    }
                    allAnswersData.push(answerData);
                });
                
                const finalScore = totalStudentScore;
                
                let competencyAssessment = "GiÃ¡o viÃªn khÃ´ng yÃªu cáº§u AI phÃ¢n tÃ­ch bÃ i lÃ m.";
                if (quizOptions.aiAssessment) {
                    const feedbackData = await generatePerformanceReview(allAnswersData);
                    if (feedbackData && feedbackData.overallFeedback && feedbackData.overallFeedback.summary) {
                        competencyAssessment = feedbackData.overallFeedback.summary;
                    } else {
                        competencyAssessment = "CÃ³ lá»—i xáº£y ra trong quÃ¡ trÃ¬nh AI phÃ¢n tÃ­ch bÃ i lÃ m.";
                    }
                }
                
                if (quizOptions.showAnswers) {
                    const totalQuestions = quizData.length;
                    resultContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg text-center">
                        <h3 class="text-2xl font-bold text-slate-800">Káº¾T QUáº¢ BÃ€I LÃ€M</h3>
                        <p class="mt-4 text-lg">Sá»‘ cÃ¢u Ä‘Ãºng hoÃ n toÃ n: <span class="font-bold text-green-600">${totalCorrectAnswers}/${totalQuestions}</span></p>
                        <p class="text-2xl mt-2">Äiá»ƒm (thang 10): <span class="font-bold text-blue-600">${finalScore.toFixed(2)}</span></p>
                        ${questionCounts['essay'] > 0 ? `<p class="text-sm text-gray-600 italic mt-1">LÆ°u Ã½: Äiá»ƒm trÃªn chÆ°a bao gá»“m ${quizOptions.scoring.essay} Ä‘iá»ƒm cá»§a pháº§n Tá»± luáº­n.</p>` : ''}
                    </div>`;
                    resultContainer.classList.remove('hidden');

                    allAnswersData.forEach((ans, index) => {
                        const questionCard = document.getElementById(`student-q-${index}`);
                        const feedbackIconDiv = document.getElementById(`q-${index}-feedback-icon`);
                        const feedbackDiv = document.getElementById(`q-${index}-feedback`);
                        if (!questionCard || !feedbackIconDiv || !feedbackDiv) return;

                        const iconHTML = ans.isCorrect === true
                            ? '<svg class="feedback-icon text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>'
                            : (ans.isCorrect === false ? '<svg class="feedback-icon text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>' : '');
                        feedbackIconDiv.innerHTML = iconHTML;

                        if (ans.type.includes('multiple-choice')) {
                            const studentChoice = ans.yourAnswer === "KhÃ´ng tráº£ lá»i" ? -1 : ans.yourAnswer.charCodeAt(0) - 65;
                            const correctChoice = ans.correctAnswer.charCodeAt(0) - 65;
                            document.getElementById(`q-${index}-opt-label${correctChoice}`)?.classList.add('correct');
                            if (studentChoice !== -1 && studentChoice !== correctChoice) {
                                document.getElementById(`q-${index}-opt-label${studentChoice}`)?.classList.add('incorrect');
                            }
                        } else if (ans.type === 'true-false') {
                            const statementItems = questionCard.querySelectorAll('.statement-item');
                            ans.details.forEach((detail, i) => { if(statementItems[i]) { statementItems[i].classList.add(detail.isCorrect ? 'correct' : 'incorrect'); }});
                        }

                        if (quizOptions.showExplanation) {
                            feedbackDiv.innerHTML = `<button data-explain-index="${index}" class="explain-btn mt-4 flex items-center px-4 py-2 bg-blue-100 text-blue-800 text-sm font-semibold rounded-lg hover:bg-blue-200 transition-colors">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Xem giáº£i thÃ­ch
                            </button>`;
                        }
                    });
                    
                    document.querySelectorAll('.explain-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const button = e.currentTarget;
                            const index = parseInt(button.dataset.explainIndex, 10);
                            showExplanation(index, button);
                        });
                    });

                    if (window.MathJax) await window.MathJax.typesetPromise([studentQuizContainer]);
                } else {
                     resultContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg text-center"><h3 class="text-xl font-bold text-green-600">Ná»™p bÃ i thÃ nh cÃ´ng!</h3><p class="mt-2 text-slate-700">Báº¡n Ä‘Ã£ hoÃ n thÃ nh bÃ i lÃ m. Káº¿t quáº£ sáº½ Ä‘Æ°á»£c giÃ¡o viÃªn cÃ´ng bá»‘ sau.</p></div>`;
                    resultContainer.classList.remove('hidden');
                }
                
                const formData = new FormData();
                formData.append('name', studentInfo.name);
                formData.append('class', studentInfo.class);
                formData.append('score', `${finalScore.toFixed(2)}/10`);
                formData.append('assessment', competencyAssessment);
                formData.append('timestamp', new Date().toLocaleString('vi-VN'));
                formData.append('examCode', correctExamCode);
                formData.append('monitoringLog', proctoringDataString);
                formData.append('answerDetails', JSON.stringify(allAnswersData));
               
                fetch(googleScriptUrl, { method: 'POST', body: formData})
                    .then(res => console.log("Successfully submitted to Google Sheet"))
                    .catch(err => console.error("Error submitting to Google Sheet:", err));
            }
           
            function startNewAttempt() {
                isSubmitted = false;
                proctoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0, suKien: [] };
                const proctoringWidget = document.getElementById('proctoring-widget');
                if (proctoringWidget) {
                    proctoringWidget.classList.add('hidden');
                    document.getElementById('tab-switch-count').textContent = '0';
                    document.getElementById('copy-count').textContent = '0';
                    document.getElementById('paste-count').textContent = '0';
                }

                renderStudentQuiz();
                resultContainer.classList.add('hidden');
                document.getElementById('ai-feedback-container').classList.add('hidden');
                postSubmitOptions.classList.add('hidden');
                submitBtn.classList.remove('hidden');
                 if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                }
                retriesLeft--;
                retriesDisplay.textContent = `LÆ°á»£t lÃ m láº¡i cÃ²n: ${retriesLeft}`;
                window.scrollTo(0, 0);
            }
            studentInfoForm.addEventListener('submit', (e) => {
                e.preventDefault();
               
                const enteredCode = document.getElementById('exam-code').value.trim().toUpperCase();
                if (correctExamCode && enteredCode !== correctExamCode) {
                    alert('MÃ£ Ä‘á» khÃ´ng chÃ­nh xÃ¡c. Vui lÃ²ng kiá»ƒm tra láº¡i!');
                    return;
                }
               
                studentApiKey = teacherApiKey;
                if (!studentApiKey) {
                    console.warn('Cáº£nh bÃ¡o: GiÃ¡o viÃªn chÆ°a cáº¥u hÃ¬nh API Key. CÃ¡c tÃ­nh nÄƒng AI sáº½ khÃ´ng hoáº¡t Ä‘á»™ng.');
                }
       
                try {
                    if (studentApiKey) {
                       ai = new GoogleGenAI({ apiKey: studentApiKey });
                    }
                } catch(e) {
                    console.error("Lá»—i khá»Ÿi táº¡o Gemini API vá»›i key cá»§a giÃ¡o viÃªn.", e);
                    alert("Cáº£nh bÃ¡o: API Key cá»§a giÃ¡o viÃªn khÃ´ng há»£p lá»‡. Vui lÃ²ng bÃ¡o cho giÃ¡o viÃªn. CÃ¡c tÃ­nh nÄƒng AI sáº½ khÃ´ng hoáº¡t Ä‘á»™ng.");
                    ai = null;
                }
                shuffleQuiz();
               
                studentInfo.name = document.getElementById('student-name').value;
                studentInfo.class = document.getElementById('student-class').value;
                loginModal.classList.add('hidden');
                studentQuizContainer.classList.remove('hidden');
                submitBtn.classList.remove('hidden');
               
                if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                } else {
                    timerDisplay.textContent = "KhÃ´ng giá»›i háº¡n";
                }
                retriesDisplay.textContent = `LÆ°á»£t lÃ m láº¡i cÃ²n: ${retriesLeft}`;
                renderStudentQuiz();

                const proctoringWidget = document.getElementById('proctoring-widget');
                const tabSwitchCountEl = document.getElementById('tab-switch-count');
                const copyCountEl = document.getElementById('copy-count');
                const pasteCountEl = document.getElementById('paste-count');

                function updateProctoringUI() {
                    if (proctoringLog.thoatManHinh > 0 || proctoringLog.saoChep > 0 || proctoringLog.dan > 0) {
                        proctoringWidget.classList.remove('hidden');
                    }
                    tabSwitchCountEl.textContent = proctoringLog.thoatManHinh;
                    copyCountEl.textContent = proctoringLog.saoChep;
                    pasteCountEl.textContent = proctoringLog.dan;
                }

                // Disable Right Click
                document.addEventListener('contextmenu', e => e.preventDefault());

                // Track Tab Switching
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && !isSubmitted) {
                        proctoringLog.thoatManHinh++;
                        proctoringLog.suKien.push({ loai: 'chuyen_tab', thoiGian: new Date().toISOString() });
                        updateProctoringUI();
                    }
                });

                // Track Copying
                document.addEventListener('copy', () => {
                    if (isSubmitted) return;
                    proctoringLog.saoChep++;
                    proctoringLog.suKien.push({ loai: 'sao_chep', thoiGian: new Date().toISOString() });
                    updateProctoringUI();
                });

                // Track Pasting
                document.addEventListener('paste', () => {
                    if (isSubmitted) return;
                    proctoringLog.dan++;
                    proctoringLog.suKien.push({ loai: 'dan', thoiGian: new Date().toISOString() });
                    updateProctoringUI();
                });
            });
            
            submitBtn.addEventListener('click', handleSubmit);
            retryBtn.addEventListener('click', () => {
                shuffleQuiz();
                startNewAttempt();
            });
        </script>
    </body>
    </html>
    