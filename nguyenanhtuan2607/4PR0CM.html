
    <!DOCTYPE html>
    <html lang="vi">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>KIỂM TRA 15 PHÚT</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
        <script>
            window.MathJax = {
                tex: {
                    packages: {'[+]': ['ams']},
                    inlineMath: [['$', '$'], ['\\(', '\\)']],
                    displayMath: [['$$', '$$'], ['\\[', '\\]']]
                },
                chtml: {
                    fontCache: 'global',
                    linebreaks: {
                        automatic: true
                    }
                }
            };
        </script>
        <script type="text/javascript" id="MathJax-script" async
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
        </script>
        <style>
            body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #f0f4f8; }
            .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
            @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
            .question-card {
                background-color: white;
                border-radius: 1rem;
                padding: 1.5rem 2rem;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                border-left: 5px solid transparent;
                transition: all 0.3s ease;
            }
            .ai-explanation {
                background-color: #f0f9ff;
                color: #0c4a6e;
                padding: 1rem;
                border-radius: 0.75rem;
                font-size: 0.9rem;
                margin-top: 1rem;
                border-left: 4px solid #38bdf8;
            }
            .feedback-icon { width: 1.5rem; height: 1.5rem; }
            .option-label {
                transition: all 0.2s ease-in-out;
                border: 2px solid #e5e7eb;
            }
            .option-label:hover {
                border-color: #6366f1;
                background-color: #eef2ff;
            }
            .option-label.correct {
                border-color: #10b981 !important;
                background-color: #ecfdf5 !important;
                color: #065f46;
            }
            .option-label.incorrect {
                border-color: #ef4444 !important;
                background-color: #fef2f2 !important;
                color: #991b1b;
            }
            .statement-item.correct { background-color: #ecfdf5; border-color: #10b981; }
            .statement-item.incorrect { background-color: #fef2f2; border-color: #ef4444; }
            .prose { max-width: 100%; }
            .prose h1, .prose h2, .prose h3 { font-weight: 600; }
            .prose p { margin-top: 0.5em; margin-bottom: 0.5em; }
            .prose ul, .prose ol { margin-top: 1em; margin-bottom: 1em; padding-left: 1.5em; }
            .prose li > p { margin-top: 0; margin-bottom: 0; }
            .prose code { background-color: #e5e7eb; padding: 0.2em 0.4em; margin: 0; font-size: 85%; border-radius: 3px; }
            .prose pre { background-color: #e5e7eb; padding: 1em; border-radius: 0.5em; overflow-x: auto; }
            .prose pre code { background-color: transparent; padding: 0; }
            details[open] > summary .details-arrow {
                transform: rotate(180deg);
            }
        </style>
    </head>
    <body class="bg-slate-100 text-slate-800">
        <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md transform transition-all" style="animation: fadeIn 0.3s ease-out;">
                <h2 class="text-2xl font-bold mb-2 text-center text-slate-800">Thông Tin Học Sinh</h2>
                <p class="text-center text-slate-500 mb-6">Vui lòng nhập để bắt đầu làm bài.</p>
                <form id="student-info-form">
                    <div class="mb-4">
                        <label for="student-name" class="block text-sm font-medium text-slate-700 mb-1">Họ và tên</label>
                        <input type="text" id="student-name" required class="mt-1 block w-full block border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="student-class" class="block text-sm font-medium text-slate-700 mb-1">Lớp</label>
                        <input type="text" id="student-class" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="exam-code" class="block text-sm font-medium text-slate-700 mb-1">Mã đề</label>
                        <input type="text" id="exam-code" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Nhập mã đề giáo viên cung cấp">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Giáo viên:</label>
                        <p class="mt-1 text-slate-800 bg-slate-100 p-2.5 rounded-lg">THẦY TUẤN TIN HỌC</p>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">Bắt đầu làm bài</button>
                </form>
            </div>
        </div>
        <div class="container mx-auto p-4 md:p-8 max-w-4xl">
            <header class="mb-10 p-8 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg">
                <div class="flex justify-between items-center flex-wrap gap-4">
                    <div>
                        <h1 class="text-4xl font-bold">KIỂM TRA 15 PHÚT</h1>
                        <p class="text-lg text-blue-100 mt-2">Hãy hoàn thành các câu hỏi dưới đây một cách tốt nhất!</p>
                        <p class="text-sm text-blue-200 mt-4">Tác giả: THẦY TUẤN TIN HỌC</p>
                    </div>
                    <div id="timer-container" class="text-right">
                         <div id="timer-display" class="text-3xl font-bold tracking-wider bg-white/20 px-4 py-2 rounded-lg">--:--</div>
                         <div id="retries-display" class="text-sm mt-1 text-blue-200"></div>
                    </div>
                </div>
            </header>
            <main id="student-quiz-container" class="space-y-8 hidden">
                <!-- Questions will be rendered here by JS -->
            </main>
            <footer class="mt-10 text-center">
                <button id="submit-quiz-btn" class="bg-indigo-600 text-white py-3 px-12 rounded-full font-bold text-lg hover:bg-indigo-700 transition-all duration-300 shadow-lg hover:shadow-xl hidden transform hover:scale-105">Nộp Bài</button>
                <div id="result-container" class="mt-6 hidden"></div>
                <div id="ai-feedback-container" class="mt-8 text-left hidden"></div>
                <div id="post-submit-options" class="hidden mt-6 flex flex-col sm:flex-row items-center justify-center gap-4">
                    <button id="retry-quiz-btn" class="w-full sm:w-auto bg-slate-600 text-white py-2.5 px-6 rounded-lg font-semibold hover:bg-slate-700 transition-transform transform hover:scale-105">Làm Lại Đề Này</button>
                </div>
            </footer>
        </div>

        <div id="proctoring-widget" class="fixed bottom-4 right-4 bg-yellow-100 text-yellow-800 p-3 rounded-lg shadow-lg text-sm z-50 hidden border border-yellow-300" style="max-width: 200px;">
            <h4 class="font-bold mb-2 border-b border-yellow-300 pb-1 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 3.001-1.742 3.001H4.42c-1.53 0-2.493-1.667-1.743-3.001l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                Giám sát
            </h4>
            <p>Thoát màn hình: <span id="tab-switch-count" class="font-bold">0</span></p>
            <p>Sao chép: <span id="copy-count" class="font-bold">0</span></p>
            <p>Dán: <span id="paste-count" class="font-bold">0</span></p>
        </div>

        <script type="module">
            import { GoogleGenAI, Type } from "https://esm.sh/@google/genai@^1.13.0";
            let quizData = [{"type":"multiple-choice","question":"Trong Tin học lớp $5$, \"sản phẩm số đơn giản\" có thể hiểu là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Một đồ vật được làm thủ công bằng tay.","Một sản phẩm được tạo ra bằng máy tính hoặc thiết bị điện tử.","Một cuốn sách giáo khoa in trên giấy.","Một trò chơi dân gian."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Để tạo ra một thiệp chúc mừng trên máy tính, em cần sử dụng loại phần mềm nào?","questionImage":null,"mappedType":"multiple-choice","options":["Phần mềm soạn thảo văn bản.","Phần mềm trình chiếu.","Phần mềm đồ họa.","Phần mềm bảng tính."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Theo mục tiêu bài học, một ví dụ về sản phẩm số đơn giản mà em có thể tạo ra bằng phần mềm đồ họa là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Một bài hát mới.","Một bộ phim hoạt hình dài.","Một thiệp chúc mừng.","Một robot tự động."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Khi sử dụng phần mềm đồ họa để tạo thiệp, thao tác cơ bản nào giúp em thêm chữ vào thiệp?","questionImage":null,"mappedType":"multiple-choice","options":["Thay đổi kích thước ảnh.","Dùng công cụ vẽ hình.","Sử dụng công cụ gõ chữ (Text tool).","Tô màu nền."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Tại sao việc tự thiết kế một tấm thiệp chúc mừng bằng phần mềm đồ họa lại ý nghĩa hơn?","questionImage":null,"mappedType":"multiple-choice","options":["Vì thiệp tự làm sẽ bền hơn thiệp mua sẵn.","Vì thiệp tự làm thể hiện sự sáng tạo và tình cảm của người làm.","Vì mọi người đều bắt buộc phải tự làm thiệp.","Vì phần mềm đồ họa luôn miễn phí."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Khi gấp giấy để tạo sản phẩm thủ công, vật liệu chính mà chúng ta sử dụng là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Giấy màu","Vải","Nhựa","Kim loại"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Để cắt các chi tiết của sản phẩm thủ công từ giấy theo hướng dẫn, chúng ta thường sử dụng công cụ nào sau đây?","questionImage":null,"mappedType":"multiple-choice","options":["Búa","Kéo","Tua vít","Cờ lê"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Mục đích chính của việc xem một video hướng dẫn làm sản phẩm thủ công là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Để nghe nhạc giải trí.","Để biết cách thực hiện từng bước tạo ra sản phẩm.","Để tìm hiểu lịch sử của sản phẩm.","Để xem người khác làm việc."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Sản phẩm nào sau đây là một ví dụ về đồ dùng tiện lợi cho gia đình có thể tạo ra bằng cách gấp giấy theo hướng dẫn?","questionImage":null,"mappedType":"multiple-choice","options":["Bàn học","Ghế sofa","Hộp bút chì","Tủ quần áo"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Việc tự tay tạo ra các đồ dùng tiện lợi cho gia đình mang lại lợi ích gì?","questionImage":null,"mappedType":"multiple-choice","options":["Giúp chúng ta tốn nhiều tiền hơn.","Giúp phát triển sự sáng tạo và tiết kiệm chi phí.","Làm cho căn nhà trở nên chật chội hơn.","Không có lợi ích gì đáng kể."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Khi sử dụng phần mềm đồ hoạ để tạo một sản phẩm số đơn giản như thiệp chúc mừng, mục đích chính của việc này là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Để tính toán các phép toán phức tạp","Để vẽ hình, tô màu, chèn chữ và sắp xếp các đối tượng trang trí","Để gửi thư điện tử cho bạn bè","Để xem các chương trình truyền hình"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Để bắt đầu tạo một thiệp chúc mừng bằng phần mềm đồ hoạ, bước đầu tiên em thường làm là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Ngay lập tức in thiệp ra giấy","Chọn một mẫu thiệp có sẵn hoặc bắt đầu với một trang trắng","Gửi thiệp qua thư điện tử cho người thân","Chèn nhạc nền vào thiệp"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Khi em muốn thêm dòng chữ như \"Chúc mừng sinh nhật\" vào thiệp chúc mừng đang thiết kế trên phần mềm đồ hoạ, em sẽ sử dụng công cụ nào?","questionImage":null,"mappedType":"multiple-choice","options":["Công cụ đổ màu (Fill Tool)","Công cụ chèn ảnh (Image Tool)","Công cụ văn bản (Text Tool)","Công cụ tẩy (Eraser Tool)"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Sau khi hoàn thành sản phẩm số đơn giản như một thiệp chúc mừng, tại sao việc lưu lại sản phẩm là rất quan trọng?","questionImage":null,"mappedType":"multiple-choice","options":["Để chơi trò chơi trên máy tính","Để đảm bảo không bị mất sản phẩm và có thể mở ra chỉnh sửa hoặc sử dụng lại sau này","Để kiểm tra thông tin thời tiết","Để nghe nhạc trực tuyến"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Theo chương trình Tin học lớp 5, sản phẩm số đơn giản nào thường được tạo ra bằng phần mềm đồ hoạ để tặng người thân nhân một dịp đặc biệt?","questionImage":null,"mappedType":"multiple-choice","options":["Một trò chơi điện tử phức tạp","Một bài thuyết trình khoa học về động vật","Một thiệp chúc mừng sinh nhật hoặc ngày lễ","Một ứng dụng di động"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Hà đang soạn thảo một câu chuyện trên máy tính. Em muốn di chuyển đoạn văn 'Chú chó nhỏ chạy ra sân...' từ giữa câu chuyện xuống cuối bài. Thao tác nào sau đây giúp Hà thực hiện điều đó một cách nhanh chóng và hiệu quả nhất?","questionImage":null,"mappedType":"multiple-choice","options":["Chọn đoạn văn -> Sao chép -> Dán vào cuối bài -> Xóa đoạn văn gốc.","Chọn đoạn văn -> Cắt -> Dán vào cuối bài.","Chọn đoạn văn -> Kéo thả đoạn văn xuống cuối bài.","Chọn đoạn văn -> Nhấn phím Delete -> Gõ lại đoạn văn ở cuối bài."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Nam muốn trình bày tiêu đề 'Món ăn yêu thích của em' sao cho thật nổi bật với chữ màu xanh, kích thước lớn và in đậm. Nam đã thực hiện bước 1 là 'Chọn toàn bộ tiêu đề'. Vậy, các bước tiếp theo Nam cần làm theo trình tự nào để đạt được kết quả mong muốn?","questionImage":null,"mappedType":"multiple-choice","options":["Chọn màu chữ xanh, sau đó chọn kích thước chữ lớn, rồi chọn kiểu chữ in đậm.","Chọn kiểu chữ in đậm, sau đó chọn màu chữ xanh, rồi chọn kích thước chữ lớn.","Chọn kích thước chữ lớn, sau đó chọn kiểu chữ in đậm, rồi chọn màu chữ xanh.","Thứ tự các bước chọn màu chữ, kích thước chữ, kiểu chữ sau khi đã chọn văn bản đều mang lại cùng kết quả."],"optionsImage":[],"correctAnswerIndex":3},{"type":"multiple-choice","question":"Mai đang viết bài văn về vườn hoa nhà mình và muốn chèn một bức ảnh chụp bông hoa hồng vào bài. Mai đã đặt con trỏ chuột vào vị trí muốn chèn ảnh. Bước tiếp theo Mai cần làm là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Mở thư mục chứa ảnh hoa hồng và kéo ảnh vào văn bản.","Vào thẻ 'Chèn' (Insert) trên thanh công cụ, sau đó chọn 'Ảnh' (Pictures) và tìm đến ảnh hoa hồng để chèn.","Nhấn tổ hợp phím Ctrl + V để dán ảnh.","Kích chuột phải vào văn bản và chọn 'Chèn ảnh' (Insert Picture)."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Bình muốn sao chép một đoạn thơ từ tài liệu này sang tài liệu khác. Bình đã chọn đoạn thơ và nhấn tổ hợp phím Ctrl + C. Khi Bình chuyển sang tài liệu mới và nhấn Ctrl + V nhưng không thấy đoạn thơ xuất hiện. Theo em, Bình có thể đã quên thực hiện thao tác nào?","questionImage":null,"mappedType":"multiple-choice","options":["Đặt con trỏ chuột vào vị trí muốn dán trong tài liệu mới.","Chọn lại đoạn thơ trước khi nhấn Ctrl + C (đoạn thơ chưa được chọn đúng cách).","Lưu tài liệu gốc trước khi sao chép.","Khởi động lại phần mềm soạn thảo văn bản."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Cô giáo yêu cầu Mai tạo một thông báo quan trọng trên máy tính để dán lên bảng tin của lớp. Dòng chữ 'Hạn chót nộp bài: Thứ Sáu!' cần được làm nổi bật để mọi người chú ý ngay lập tức. Mai nên sử dụng những thao tác định dạng nào sau đây để đạt hiệu quả tốt nhất?","questionImage":null,"mappedType":"multiple-choice","options":["Chỉ đổi màu chữ thành màu xanh.","Chỉ tăng kích thước chữ.","Chọn cả kích thước chữ lớn, in đậm và đổi màu chữ sang màu đỏ hoặc màu nổi bật khác.","Chỉ đổi kiểu chữ thành một font chữ khác."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Em đang thiết kế một tấm thiệp chúc mừng sinh nhật cho bạn. Để viết lời chúc “Chúc mừng sinh nhật bạn yêu!” thật nổi bật trên thiệp, em nên sử dụng công cụ nào trong phần mềm đồ họa?","questionImage":null,"mappedType":"multiple-choice","options":["Công cụ hình Elip (Oval tool)","Công cụ Chữ A (Text tool)","Công cụ Cục tẩy (Eraser tool)","Công cụ Kính lúp (Magnifier tool)"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Sau khi đã vẽ xong một hình bông hoa màu đỏ tươi trên tấm thiệp, nhưng em nhận ra bông hoa đó nên có màu vàng. Các bước nào sau đây giúp em đổi màu bông hoa nhanh nhất và chính xác nhất?","questionImage":null,"mappedType":"multiple-choice","options":["Chọn công cụ \"Cục tẩy\" để xóa hình và vẽ lại bông hoa màu vàng.","Chọn màu vàng từ bảng màu, sau đó chọn công cụ \"Tô màu\" (Fill with color) và nhấp vào bông hoa.","Chọn công cụ \"Kính lúp\" để phóng to bông hoa rồi dùng \"Bút chì\" tô từng chút một.","Đóng phần mềm và mở lại file, sau đó chọn màu vàng."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Để tạo một thiệp mừng Giáng sinh thật sinh động, em muốn thêm hình ảnh cây thông Noel và ông già Noel đã được lưu trong thư mục ảnh trên máy tính của mình. Em sẽ dùng tính năng nào trong phần mềm đồ họa?","questionImage":null,"mappedType":"multiple-choice","options":["Chức năng \"Vẽ tự do\" (Free-Form Select).","Chức năng \"Xoay\" (Rotate).","Chức năng \"Chèn ảnh\" (Insert Picture/Image).","Chức năng \"Độ dày nét vẽ\" (Size/Stroke size)."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Em đã hoàn thành việc thiết kế một tấm thiệp cảm ơn cô giáo. Để lưu lại sản phẩm này và có thể gửi cho cô qua mạng xã hội, em cần thực hiện hành động nào?","questionImage":null,"mappedType":"multiple-choice","options":["Nhấn phím Esc trên bàn phím.","Chọn \"Tệp\" (File) -> \"Mở\" (Open).","Chọn \"Tệp\" (File) -> \"Lưu\" (Save) hoặc \"Lưu dưới dạng\" (Save As).","Chỉ cần đóng phần mềm lại."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Khi em đang tạo một tấm thiệp chúc Tết, em muốn thay đổi vị trí của một hình ảnh chú mèo may mắn để nó không che mất phần chữ viết. Em nên sử dụng công cụ nào để di chuyển hình ảnh này?","questionImage":null,"mappedType":"multiple-choice","options":["Công cụ \"Tô màu\" (Fill with color).","Công cụ \"Chọn\" (Select) rồi kéo hình ảnh đến vị trí mới.","Công cụ \"Cọ vẽ\" (Brush).","Công cụ \"Xóa hình\" (Eraser)."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Bạn An muốn gấp một con thuyền bằng giấy theo video hướng dẫn. Video gợi ý sử dụng loại giấy màu chuyên dụng để gấp giấy origami. Tuy nhiên, An chỉ có giấy vở học sinh thông thường. Theo em, An nên làm gì để sản phẩm cuối cùng vẫn đẹp và bền nhất có thể trong điều kiện hiện tại?","questionImage":null,"mappedType":"multiple-choice","options":["Dùng giấy vở học sinh để gấp, không cần quan tâm đến loại giấy video hướng dẫn.","Tìm một loại giấy dày hơn giấy vở, ví dụ như bìa cứng hoặc giấy thủ công, thay vì giấy vở.","Gấp thuyền bằng giấy vở nhưng phải cẩn thận hơn rất nhiều để tránh bị rách.","Chờ đến khi mua được giấy origami chuyên dụng mới bắt đầu gấp."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Sau khi xem video hướng dẫn làm hộp bút bằng chai nhựa tái chế, bạn Bình bắt đầu thực hiện. Video hướng dẫn cắt bỏ phần đáy chai, sau đó trang trí. Bình đã cắt đáy chai xong. Bước tiếp theo Bình cần làm theo video để hoàn thành hộp bút là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Dán thêm quai xách vào thân chai.","Bắt đầu trang trí bên ngoài hộp bút.","Đổ keo vào đáy chai để làm nặng hộp bút.","Cắt thêm một mảnh vải để bọc bên trong hộp."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Khi đang làm một chiếc đèn lồng giấy theo video hướng dẫn, bạn Mai gặp khó khăn ở bước dán các mảnh giấy lại với nhau. Keo dán bạn đang dùng bị khô quá nhanh, khiến các mảnh giấy chưa kịp dính chắc đã bung ra. Để khắc phục tình huống này và hoàn thành chiếc đèn lồng, Mai nên làm gì?","questionImage":null,"mappedType":"multiple-choice","options":["Cố gắng dán thật nhanh tay hơn.","Tìm một loại keo dán khác có thời gian khô lâu hơn hoặc dùng băng dính.","Bỏ qua bước dán và chỉ xếp các mảnh giấy lại với nhau.","Nhờ người lớn làm hộ bước dán khó này."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Video hướng dẫn làm một món đồ chơi từ vỏ hộp sữa có nhiều chi tiết nhỏ và các thao tác gấp, cắt phức tạp. Bạn Hùng đã xem video $1$ lần nhưng vẫn cảm thấy chưa tự tin để bắt đầu làm. Hùng nên làm gì để đảm bảo mình có thể thực hiện đúng các bước và tạo ra sản phẩm hoàn chỉnh?","questionImage":null,"mappedType":"multiple-choice","options":["Bắt đầu làm ngay và tự mình tìm cách giải quyết khi gặp khó khăn.","Chỉ xem lại những đoạn video có thao tác phức tạp $1$ lần nữa trước khi làm.","Xem lại toàn bộ video nhiều lần, đặc biệt chú ý các chi tiết nhỏ và thao tác khó.","Tìm một video hướng dẫn khác đơn giản hơn để làm theo."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Cô giáo giao bài tập về nhà là làm một sản phẩm tái chế để trang trí góc học tập. Bạn Linh tìm được $3$ video hướng dẫn khác nhau: Video $1$: Hướng dẫn làm đồ chơi bằng chai nhựa. Video $2$: Hướng dẫn làm khung ảnh bằng bìa carton. Video $3$: Hướng dẫn làm hộp đựng bút bằng vỏ hộp sữa. Theo mục tiêu bài tập của cô giáo, Linh nên chọn video nào để làm theo là phù hợp nhất?","questionImage":null,"mappedType":"multiple-choice","options":["Video $1$","Video $2$","Video $3$","Bất kỳ video nào cũng được, miễn là sản phẩm tái chế."],"optionsImage":[],"correctAnswerIndex":1}];
            const quizOptions = {"timeLimit":15,"retriesAllowed":0,"showAnswers":true,"showExplanation":true,"aiAssessment":true,"scoring":{"mc":5,"tf":2,"sa":2,"essay":1,"tfMethod":"even"}};
            const googleScriptUrl = "https://script.google.com/macros/s/AKfycbxSHD6OJgic1bgfC4uKfbg7bem5uApC_szh7Z5-a_xDRtCE8OSeEcoWbRb4A6YL-Xhf1w/exec";
            const correctExamCode = "4PR0CM";
            const teacherApiKey = "AIzaSyBnkpWWf5WM_LZCQ56L2Xqy7wJTyj9fHoo";
            let studentInfo = {};
            let isSubmitted = false;
            let timerInterval;
            let retriesLeft = quizOptions.retriesAllowed;
            let studentApiKey = "";
            let ai = null;

            let proctoringLog = {
                thoatManHinh: 0,
                saoChep: 0,
                dan: 0,
                suKien: []
            };

            const studentQuizContainer = document.getElementById('student-quiz-container');
            const submitBtn = document.getElementById('submit-quiz-btn');
            const resultContainer = document.getElementById('result-container');
            const postSubmitOptions = document.getElementById('post-submit-options');
            const retryBtn = document.getElementById('retry-quiz-btn');
            const loginModal = document.getElementById('login-modal');
            const studentInfoForm = document.getElementById('student-info-form');
            const timerDisplay = document.getElementById('timer-display');
            const retriesDisplay = document.getElementById('retries-display');
            function shuffleQuiz() {
                // Shuffle options/statements within each question first
                quizData.forEach(item => {
                    // Shuffle multiple-choice options and their corresponding images
                    if (item.mappedType === 'multiple-choice' && item.options && item.options.length > 0) {
                        const correctAnswerText = item.options[item.correctAnswerIndex];
                        let optionsWithImages = item.options.map((opt, index) => ({
                            text: opt,
                            image: (item.optionsImage && item.optionsImage[index]) ? item.optionsImage[index] : null
                        }));
                        // Fisher-Yates shuffle
                        for (let i = optionsWithImages.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [optionsWithImages[i], optionsWithImages[j]] = [optionsWithImages[j], optionsWithImages[i]];
                        }
                        // Update the item with shuffled data
                        item.options = optionsWithImages.map(opt => opt.text);
                        item.optionsImage = optionsWithImages.map(opt => opt.image);
                        item.correctAnswerIndex = item.options.indexOf(correctAnswerText);
                    }
                    // Shuffle true-false statements
                    if (item.mappedType === 'true-false' && item.statements && item.statements.length > 0) {
                         for (let i = item.statements.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [item.statements[i], item.statements[j]] = [item.statements[j], item.statements[i]];
                        }
                    }
                });
                // Then, group questions by type and shuffle within each group
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});
                let shuffledQuizData = [];
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    if (grouped[partType]) {
                        const partQuestions = grouped[partType];
                        for (let i = partQuestions.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [partQuestions[i], partQuestions[j]] = [partQuestions[j], partQuestions[i]];
                        }
                        shuffledQuizData = shuffledQuizData.concat(partQuestions);
                    }
                });
               
                quizData = shuffledQuizData;
            }
            // --- Timer Function ---
            function startTimer(duration, display) {
                let timer = duration, minutes, seconds;
                clearInterval(timerInterval); // Clear any existing timer
                if(duration <= 0) {
                     display.textContent = "∞";
                     return;
                }
                timerInterval = setInterval(function () {
                    minutes = parseInt(timer / 60, 10);
                    seconds = parseInt(timer % 60, 10);
                    minutes = minutes < 10 ? "0" + minutes : minutes;
                    seconds = seconds < 10 ? "0" + seconds : seconds;
                    display.textContent = minutes + ":" + seconds;
                    if (--timer < 0) {
                        clearInterval(timerInterval);
                        alert("Hết giờ làm bài!");
                        handleSubmit();
                    }
                }, 1000);
            }
            
            async function showExplanation(index, button) {
                const item = quizData[index];
                const questionCard = document.getElementById(`student-q-${index}`);
                const feedbackDiv = document.getElementById(`q-${index}-feedback`);
                if (!questionCard || !feedbackDiv) return;

                const existingExplanation = feedbackDiv.querySelector('.ai-explanation');
                if (existingExplanation) {
                    existingExplanation.remove();
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Xem giải thích
                    `;
                    return;
                }

                button.disabled = true;
                button.innerHTML = '<div class="loader mr-2"></div> Đang tải...';

                if (item.explanation) {
                    displayExplanation(item.explanation, feedbackDiv, button);
                    return;
                }

                if (!ai) {
                    alert("Tính năng giải thích yêu cầu API Key, nhưng chưa được cấu hình bởi giáo viên.");
                    button.disabled = false;
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Xem giải thích
                    `;
                    return;
                }

                const questionText = item.question || item.main_question;
                let prompt = `Bạn là một trợ lý giáo viên AI, am hiểu sâu sắc Chương trình GDPT 2018. Hãy cung cấp một lời giải chi tiết, từng bước một cho câu hỏi sau đây. Lời giải phải chính xác, dễ hiểu và phù hợp với phương pháp giảng dạy của chương trình học, TUYỆT ĐỐI KHÔNG sử dụng kiến thức của lớp cao hơn để giải thích.\n\n--- CÂU HỎI ---\n${questionText}\n\n`;
                if (item.mappedType === 'multiple-choice') {
                    prompt += `--- CÁC LỰA CHỌN ---\n${item.options.map((opt, i) => `${String.fromCharCode(65 + i)}. ${opt}`).join('\n')}\n\n`;
                    prompt += `--- ĐÁP ÁN ĐÚNG ---\n${String.fromCharCode(65 + item.correctAnswerIndex)}. ${item.options[item.correctAnswerIndex]}`;
                } else if (item.mappedType === 'true-false') {
                    prompt += `--- CÁC MỆNH ĐỀ & ĐÁP ÁN ---\n${item.statements.map(s => ` - ${s.statement} -> ${s.is_correct ? 'Đúng' : 'Sai'}`).join('\n')}`;
                } else {
                    prompt += `--- ĐÁP ÁN / GỢI Ý ---\n${item.answer}`;
                }
                prompt += `\n\n--- YÊU CẦU ---\nGiải thích rõ ràng tại sao đáp án lại đúng, từng bước một. Định dạng tất cả các công thức toán học bằng LaTeX. 
--- QUY TẮC BẮT BUỘC VỀ TOÁN HỌC (LaTeX) ---
1. **TUYỆT ĐỐI MỌI THỨ:** Tất cả các công thức, kí hiệu, biến số, hằng số, tập hợp toán học PHẢI được bao bọc bởi mã LaTeX.
2. **DÙNG DẤU ĐÔ LA ($):**
    * Dùng '$ công thức $' cho công thức trong cùng dòng (inline). VÍ DỤ: "Tập xác định $D$ của hàm số $y = \dfrac{x-3}{x}$."
    * Dùng '$$ công thức $$' CHỈ KHI công thức cần nằm trên một dòng riêng (display). KHÔNG dùng cho công thức inline.
    * **NHẮC LẠI:** Mọi thứ liên quan đến toán, dù là một biến số đơn lẻ như $x$ hay một số như $5$, đều phải nằm trong hai dấu $.
3. **LỆNH VÀ KÍ HIỆU CHUẨN:**
    * **Phép nhân (Multiplication):** Luôn dùng lệnh `\times` hoặc `\cdot`. TUYỆT ĐỐI KHÔNG viết chữ "nhân" hay "times".
    * **Kí hiệu vô cực:** Luôn dùng `\infty`. TUYỆT ĐỐI KHÔNG dùng `\&infty;`, `&infty;`, `inf`.
    * **Kí hiệu độ:** Luôn dùng `^{\circ}`.
    * **Lệnh phân số:** Dùng `\dfrac{tử}{mẫu}` cho phân thức, `\frac{tử}{mẫu}` cho phân số nhỏ.
    * **Văn bản trong công thức:** Dùng lệnh `\text{...}`. VÍ DỤ: `$\text{Hàm số đồng biến trên } (0;1)$`.
    * **Dấu ngoặc co giãn:** Dùng `\left( ... \right)`, `\left[ ... \right]`, `\left\{ ... \right\}` khi ngoặc chứa biểu thức cao như phân số.
4. **VÍ DỤ CỤ THỂ:**
    * SAI: Cho tập hợp A = {1; 2; 3}
    * ĐÚNG: Cho tập hợp $A = \{1; 2; 3\}$
    * SAI: Đáp án là {1; 2; 5}
    * ĐÚNG: Đáp án là $\{1; 2; 5\}$

--- QUY TẮC CẤM TUYỆT ĐỐI (LỖI NGHIÊM TRỌNG CẦN TRÁNH) ---
BẠN TUYỆT ĐỐI KHÔNG BAO GIỜ được viết các từ sai sau đây trong biểu thức toán học. Đây là một lỗi nghiêm trọng và sẽ làm cho câu trả lời không hợp lệ. Hãy luôn sử dụng lệnh đúng.

*   **SAI:** `rac{...}{...}`   ->   **ĐÚNG:** `\dfrac{...}{...}` hoặc `\frac{...}{...}`
*   **SAI:** `ext{...}`     ->   **ĐÚNG:** `\text{...}`
*   **SAI:** `imes`           ->   **ĐÚNG:** `\times`
*   **SAI:** `dive`           ->   **ĐÚNG:** `\div` hoặc `:`
*   **SAI:** `&infty;` hoặc `inf`  ->   **ĐÚNG:** `\infty`

--- QUY TẮC BẮT BUỘC VỀ VẼ HÌNH (CỰC KỲ QUAN TRỌNG) ---
5. **LỆNH CẤM TUYỆT ĐỐI VỀ HÌNH ẢNH GIẢ:** Cấm tuyệt đối việc viết các cụm từ tham chiếu đến hình ảnh mà không thực sự tạo ra hình ảnh bằng mã.
    *   **TUYỆT ĐỐI KHÔNG VIẾT:** "Quan sát hình vẽ bên dưới", "Cho hình vẽ sau", "Như hình bên", "Xem hình vẽ", "[Hình vẽ]", "[Image]" hoặc bất kỳ cụm từ nào tương tự NẾU BẠN KHÔNG KÈM THEO mã shortcode (`DT[...]`, `BBT[...]`, `[HHKG][...]`, etc.) hoặc mã `<TIKZ>...</TIKZ>` ngay sau đó.
    *   **HẬU QUẢ:** Vi phạm quy tắc này sẽ làm cho câu hỏi trở nên vô nghĩa và không thể sử dụng được. Đây là lỗi nghiêm trọng nhất cần tránh.
    *   **QUY TRÌNH ĐÚNG:** Nếu một câu hỏi cần hình vẽ, BẠN PHẢI tạo mã cho hình vẽ đó.

6. **TUYỆT ĐỐI KHÔNG ĐẶT SHORTCODE TRONG DẤU ĐÔ LA ($):** Các mã shortcode như `[HHP]...`, `DT[...]`, `BBT[...]`, `[HHKG]...`, v.v. là các lệnh đặc biệt, không phải công thức toán học. Cấm tuyệt đối việc viết `$[HHP]$[TG]$[A]$[B]$[C]$` hay `$[DT][B1][2][-1]$`. Chúng phải được viết trần, không có dấu $.

7. **PHÂN BIỆT RÕ RÀNG 5 LOẠI MÃ HÌNH:**
    a) **ĐỒ THỊ HÀM SỐ & BẢNG BIẾN THIÊN:** PHẢI dùng mã shortcode. Cú pháp: `DT[...]` hoặc `BBT[...]`.
    b) **HÌNH HỌC KHÔNG GIAN (MẪU CÓ SẴN):** Nếu hình thuộc 14 mẫu có sẵn, PHẢI dùng mã shortcode. Cú pháp: `[HHKG][LOẠI_HÌNH][MÃ_SỐ]`.
    c) **BIỂU DIỄN TẬP HỢP SỐ TRÊN TRỤC SỐ:** PHẢI dùng mã shortcode. Cú pháp: `[KHOANG|DOAN|NUA_KHOANG][a][b][MÃ_SỐ]`.
    d) **BIỂU DIỄN MIỀN NGHIỆM BPT:** Dùng shortcode `[BPT][a][b][c][LOẠI]` cho MỘT bất phương trình.
    e) **HÌNH HỌC KHÁC (Tùy chỉnh) & HỆ BPT:** PHẢI dùng mã TikZ và đặt trong thẻ <TIKZ>...</TIKZ>.

8. **QUY TẮC CHO ĐỒ THỊ & BẢNG BIẾN THIÊN (Dùng Shortcode `DT`/`BBT`):**
    * **CÚ PHÁP:** `DT[LOẠI_HÀM][a][b][c]...` (Đồ thị) hoặc `BBT[LOẠI_HÀM][a][b][c]...` (Bảng biến thiên).
    * **QUY ƯỚC MÃ `LOẠI_HÀM`:**
        * `B1`: Hàm bậc nhất $y=ax+b$. Ví dụ: Cho đồ thị hàm số $y=2x-1$, viết: `DT[B1][2][-1]` và ví dụ `BBT[B1][2][-1]`
        * `B2`: Hàm bậc hai $y=ax^2+bx+c$. Ví dụ: Cho đồ thị hàm số $y=x^2-2x+1$, viết: `DT[B2][1][-2][1]` và ví dụ `BBT[B2][1][-2][1]`
        * `B3`: Hàm bậc ba $y=ax^3+bx^2+cx+d$. Ví dụ: Lập bảng biến thiên của $y=-x^3+2$, viết: `BBT[B3][-1][0][0][2]`
        * `B4`: Hàm bậc bốn trùng phương $y=ax^4+bx^2+c$. Ví dụ: `DT[B4][1][-4][0]`
        * `PT11`: Hàm phân thức $y=\dfrac{ax+b}{cx+d}$. Ví dụ: `BBT[PT11][2][1][1][-1]`
        * `PT21`: Hàm phân thức $y=\dfrac{ax^2+bx+c}{dx+e}$. Ví dụ: `DT[PT21][1][-3][2][1][1]` và `BBT[PT21][1][-3][2][1][1]`

9. **QUY TẮC CHO ĐỒ THỊ HÀM SỐ LƯỢNG GIÁC (Dùng Shortcode `LG_...`):**
    * Dùng khi câu hỏi cần đồ thị của hàm số lượng giác dạng $y = a \cdot f(bx+c) + d$.
    * **CÚ PHÁP TUYỆT ĐỐI:** Toàn bộ shortcode PHẢI được bao bọc bởi một cặp dấu ngoặc vuông `[]` ở ngoài cùng.
      * **ĐÚNG:** `[MÃ_HÀM][a][b][c][d]`
      * **SAI:** `MÃ_HÀM[a][b][c][d]` (Thiếu ngoặc vuông ngoài cùng)
    * **[a], [b], [d]:** là các hệ số số thực.
    * **[c]:** là hệ số pha, có thể là số thực hoặc biểu thức chứa `pi` (ví dụ: `pi/2`).
    * **QUY ƯỚC MÃ HÀM:**
        * `LG_SIN`: Cho hàm số sin. Ví dụ ĐÚNG: `[LG_SIN][2][1][pi/2][1]`. Ví dụ SAI: `LG_SIN[2][1][pi/2][1]`.
        * `LG_COS`: Cho hàm số cos. Ví dụ ĐÚNG: `[LG_COS][1][2][0][0]`.
        * `LG_TAN`: Cho hàm số tan.
        * `LG_COTANG`: Cho hàm số cot.
    * **LỆNH CẤM:** Cấm tuyệt đối việc mô tả bằng chữ. PHẢI sinh mã shortcode đúng cú pháp đã chỉ định.

10. **QUY TẮC CHO HÌNH HỌC KHÔNG GIAN (Dùng Shortcode `HHKG`):**
    * Dùng khi câu hỏi cần một hình không gian tiêu chuẩn đã được định nghĩa sẵn.
    * **CÚ PHÁP:** `[HHKG][TÊN_HÌNH][MÃ_SỐ]`. Trong đó, **[TÊN_HÌNH]** là tên các đỉnh của hình được nêu trong câu hỏi (ví dụ: S.ABC, ABCD, ABC.A'B'C').
    * **VÍ DỤ:**
        * Câu hỏi "Cho hình chóp S.ABC có đường cao SA...", viết: `[HHKG][S.ABC][2]`.
        * Câu hỏi "Cho tứ diện A.BCD...", viết: `[HHKG][A.BCD][1]`.
    * **DANH SÁCH MÃ SỐ VÀ MÔ TẢ:**
        * 1: Tứ diện cơ bản
        * 2: S.ABC có đường cao h = SA
        * 3: S.ABC đều
        * 4: S.ABC có SBC đứng
        * 5: Chóp S.ABCD có h = SA
        * 6: S.ABCD đều
        * 7: S.ABCD có SAB đứng
        * 8: Lăng trụ đứng tam giác
        * 9: Lăng trụ xiên tam giác
        * 10: Hình hộp chữ nhật
        * 11: Hình nón cơ bản
        * 12: Hình trụ cơ bản
        * 13: Hình cầu cơ bản
        * 14: Hình Lập phương

11. **QUY TẮC VẼ TẬP HỢP SỐ THỰC (Dùng Shortcode `KHOANG`, `DOAN`, `NUA_KHOANG`):**
    * Dùng khi câu hỏi yêu cầu biểu diễn một khoảng, đoạn hoặc nửa khoảng trên trục số.
    * **CÚ PHÁP:** `[LOẠI_TẬP_HỢP][a][b][MÃ_SỐ]`.
    * **[LOẠI_TẬP_HỢP]:** `KHOANG`, `DOAN`, hoặc `NUA_KHOANG`.
    * **[a], [b]:** Là các giá trị số của hai đầu mút. Nếu là vô cực, hãy để trống.
    * **VÍ DỤ:**
        * "Biểu diễn khoảng $(2; 5)$ trên trục số", viết: `[KHOANG][2][5][1]`.
        * "Biểu diễn đoạn `[-1; 3]` trên trục số", viết: `[DOAN][-1][3][4]`.
        * "Biểu diễn nửa khoảng `[0; +\infty)`", viết: `[NUA_KHOANG][0][][7]`.
    * **DANH SÁCH MÃ SỐ:**
        * 1: Khoảng `(a; b)`
        * 2: Khoảng `(a; +\infty)`
        * 3: Khoảng `(-\infty; b)`
        * 4: Đoạn `[a; b]`
        * 5: Nửa khoảng `[a; b)`
        * 6: Nửa khoảng `(a; b]`
        * 7: Nửa khoảng `[a; +\infty)`
        * 8: Nửa khoảng `(-\infty; b]`

12. **QUY TẮC BIỂU DIỄN MIỀN NGHIỆM BPT (Dùng Shortcode `BPT`):**
    * Dùng khi câu hỏi yêu cầu biểu diễn miền nghiệm của **MỘT** bất phương trình bậc nhất hai ẩn.
    * **CÚ PHÁP:** `[BPT][a][b][c][LOẠI]`.
    * **[a], [b], [c]:** là các hệ số của BPT `ax + by ? c`.
    * **[LOẠI]:**
        * `L1`: $ax+by \le c$
        * `L2`: $ax+by < c$
        * `L3`: $ax+by > c$
        * `L4`: $ax+by \ge c$
    * **VÍ DỤ:** "Biểu diễn miền nghiệm của $x - 2y < 4$", viết: `[BPT][1][-2][4][L2]`.

13. **QUY TẮC CHO HÌNH HỌC TÙY CHỈNH (Dùng TikZ):**
    * **KHI NÀO DÙNG:** Áp dụng cho MỌI hình vẽ không thuộc các mã shortcode đã định nghĩa (HHKG, DT, BBT, LG, HHP, DTLG, BXD, BPT, KHOANG...). Ví dụ: hình học phẳng phức tạp, đồ thị không chuẩn, sơ đồ Venn, hệ bất phương trình, hình không gian không có trong mẫu, v.v.
    * **CÚ PHÁP BẮT BUỘC:** Toàn bộ mã TikZ để vẽ hình PHẢI được đặt bên trong một cặp thẻ đặc biệt: <TIKZ>...</TIKZ>.
    * **YÊU CẦU CHẤT LƯỢNG MÃ TIKZ:**
        * Mã phải đầy đủ và có thể biên dịch được, nằm trong môi trường `\begin{tikzpicture} ... \end{tikzpicture}`.
        * Sử dụng các thư viện TikZ cần thiết (ví dụ: `\usetikzlibrary{calc, intersections, angles, quotes}`).
        * Đảm bảo tất cả các điểm được định nghĩa trước khi sử dụng.
        * Ghi nhãn các điểm, góc và các yếu tố quan trọng một cách rõ ràng.
        * TUYỆT ĐỐI KHÔNG mô tả hình bằng chữ (ví dụ: "[Vẽ hình tam giác ABC]"). PHẢI tạo mã TikZ.
    * **VÍ DỤ (Hệ BPT):** Để vẽ miền nghiệm của `{ x >= 0, y >= 0, x+y <= 2 }`, bạn PHẢI viết mã TikZ đầy đủ trong thẻ <TIKZ>, ví dụ: <TIKZ>\begin{tikzpicture}...\addplot[fill=cyan, fill opacity=0.4] coordinates {(0,0) (2,0) (0,2)} -- cycle;...\end{tikzpicture}</TIKZ>
    * **VÍ DỤ (Góc trong tam giác):** Để vẽ và ghi nhãn góc trong của tam giác, hãy dùng thư viện `angles` và `quotes`.
<TIKZ>\begin{tikzpicture}
\usetikzlibrary{angles,quotes}
\coordinate (A) at (0,3);
\coordinate (B) at (-2,0);
\coordinate (C) at (2,0);
\draw (C) -- (B) -- (A) -- cycle;
\node at (A) [above] {$A$};
\node at (B) [below left] {$B$};
\node at (C) [below right] {$C$};
\pic[draw, angle radius=5mm, "{$40^{\circ}$}", angle eccentricity=1.2] {angle = B--A--C};
\pic[draw, angle radius=5mm, "{$60^{\circ}$}", angle eccentricity=1.2] {angle = C--B--A};
\pic[draw, angle radius=5mm, "{$80^{\circ}$}", angle eccentricity=1.2] {angle = A--C--B};
\end{tikzpicture}</TIKZ>

14. **QUY TẮC CHO HÌNH HỌC PHẲNG (HHP), ĐƯỜNG TRÒN LƯỢNG GIÁC (DTLG) VÀ BẢNG XÉT DẤU (BXD):**
    * **HÌNH HỌC PHẲNG (HHP):**
        * Cú pháp: `[HHP][MÃ_HÌNH][ĐỈNH_1][ĐỈNH_2]...` hoặc `HHP[MÃ_HÌNH][ĐỈNH_1]...`. Ví dụ: `[HHP][TG][A][B][C]`.
        * **Mã Hình HHP:**
            * `TG`: Tam giác thường.
            * `HV`: Hình vuông.
            * `HBH`: Hình bình hành.
            * `HCN`: Hình chữ nhật.
            * `HTHANG`: Hình thang.
            * `TGD`: Tam giác đều.
            * `TGVC_TAI_A`: Tam giác vuông cân tại đỉnh đầu tiên.
            * `TGVTAI_A`: Tam giác vuông tại đỉnh đầu tiên.
            * `ELIP`: Hình elip (không cần đỉnh).
    * **ĐƯỜNG TRÒN LƯỢNG GIÁC (DTLG):**
        * Dùng để biểu diễn góc trên đường tròn đơn vị.
        * Cú pháp: `[DTLG][góc]`. Trong đó `góc` là số đo bằng độ.
        * Ví dụ: `[DTLG][45]` để vẽ góc $45^\circ$.
    * **BẢNG XÉT DẤU (BXD):**
        * Cú pháp: `BXD[B3][a][b][c][d]`.
        * Mục đích: Vẽ bảng xét dấu cho đạo hàm của hàm bậc ba $y=ax^3+bx^2+cx+d$.
        * Ví dụ: `BXD[B3][1][0][-3][1]`

--- QUY TẮC BẮT BUỘC VỀ VẼ BẢNG (TABLES) ---
15. **MỌI BẢNG PHẢI CÓ ĐƯỜNG KẺ:** Tất cả các bảng BẮT BUỘC phải có đường kẻ ngang đầy đủ giữa các hàng (dùng `\hline`) và đường kẻ dọc giữa các cột (dùng ký tự `|` trong định nghĩa cột, ví dụ: `{|c|c|}`). Bảng không có đường kẻ là không hợp lệ và sẽ bị từ chối.

16. **DÙNG MÔI TRƯỜNG BẢNG BIỂU (QUAN TRỌNG):** Khi câu hỏi yêu cầu hoặc nội dung có một bảng dữ liệu (ví dụ: bảng tần số dạng cột), BẮT BUỘC phải sử dụng môi trường `tabular` hoặc `array` của LaTeX. Toàn bộ khối bảng (từ `\begin{...}` đến `\end{...}`) PHẢI được đặt bên trong cặp dấu `$$...$$ ` để hiển thị đúng và được căn giữa. TUYỆT ĐỐI KHÔNG dùng môi trường `\begin{center}...end{center}` cho bảng.
    * **VÍ DỤ MẪU (Bảng tần số dạng cột):**
      $$
      \begin{array}{|c|c|}
      \hline
      \textbf{Lớp ghép nhóm} & \textbf{Tần số} \\
      \hline
      [18; 25) & 7 \\
      \hline
      [25; 32) & 8 \\
      \hline
      [32; 39) & 6 \\
      \hline
      [39; 46) & 4 \\
      \hline
      \textbf{Tổng} & 25 \\
      \hline
      \end{array}
      $$
    * **LƯU Ý:**
        * Toàn bộ khối `\begin{array} ... \end{array}` hoặc `\begin{tabular} ... \end{tabular}` PHẢI nằm trong `$$...$$ `.
        * Các giá trị số hoặc biểu thức toán học trong các ô của bảng vẫn PHẢI tuân thủ quy tắc 1 (dùng $...$). Ví dụ: `$\dfrac{1}{2}$` hoặc `$n=25$`.
        * Dùng `\hline` để kẻ dòng ngang.
        * Dùng `|` trong định dạng cột (ví dụ: `{|c|c|c|}`) để kẻ dòng dọc.
        * Dùng `\textbf{...}` để in đậm tiêu đề.
        * Dùng `\\ ` để xuống dòng trong bảng.

17. **BẢNG TẦN SỐ DẠNG NGANG:** Khi câu hỏi yêu cầu tạo bảng thống kê hoặc bảng tần số theo chiều ngang (các nhóm giá trị/dữ liệu ở hàng trên, tần số/số liệu tương ứng ở hàng dưới), BẮT BUỘC phải dùng định dạng mẫu sau. Lưu ý cột tiêu đề (cột đầu tiên) thường được căn lề trái (`l`) và nội dung chữ phải dùng lệnh `\text{...}`.
    * **VÍ DỤ MẪU (Bảng tần số dạng ngang):**
      $$
      \begin{array}{|l|c|c|c|c|}
      \hline
      \text{Thời gian (phút)} & [25;30) & [30;35) & [35;40) & [40;45) \\
      \hline
      \text{Số học sinh} & 8 & 16 & 4 & 2 \\
      \hline
      \end{array}
      $$

18. **QUY TẮC VẼ GÓC NGOÀI (CHỈ ÁP DỤNG KHI ĐỀ BÀI YÊU CẦU RÕ):**
    1. Chỉ sử dụng quy tắc này khi đề bài yêu cầu vẽ **'góc ngoài'**.
    2. Góc ngoài tại đỉnh C của tam giác ABC là góc kề bù với góc trong ACB.
    3. **Cách vẽ DUY NHẤT:** Kéo dài cạnh BC tới điểm D. Góc ngoài là góc ACD.
    4. **Lệnh vẽ DUY NHẤT:** Dùng `\pic[..., "{$...$}"]{angle=D--C--A}`. Thứ tự `D--C--A` là bắt buộc để cung góc quay đúng (ngược chiều kim đồng hồ).
    5. **LỆNH CẤM:** TUYỆT ĐỐI KHÔNG được áp dụng logic vẽ 'góc ngoài' này cho các góc trong thông thường. TUYỆT ĐỐI KHÔNG dùng lệnh `\tkzLabelAngles` cho góc ngoài.

19. **QUY TẮC VẼ GÓC TRONG (MẶC ĐỊNH CHO MỌI GÓC KHÔNG PHẢI 'GÓC NGOÀI'):**
    1. Khi vẽ một góc thông thường của đa giác (ví dụ $\widehat{B}$), nó được hiểu là góc **TRONG**.
    2. Để cung góc luôn nằm **BÊN TRONG** đa giác, thứ tự các điểm trong lệnh `angle=P1--V--P2` phải tạo ra một vòng quay **ngược chiều kim đồng hồ**.
    3. **QUY TẮC GHI NHỚ CHO TAM GIÁC (với các đỉnh A, B, C xếp ngược chiều kim đồng hồ):**
        * Góc trong tại A: `angle=B--A--C`
        * Góc trong tại B: `angle=C--B--A`
        * Góc trong tại C: `angle=A--C--B`
    4. AI phải luôn kiểm tra để đảm bảo quy tắc vòng quay ngược chiều kim đồng hồ được tuân thủ cho MỌI góc trong.

20. **QUY TẮC THAM KHẢO: CÁC LỆNH TIKZ HÌNH HỌC PHẲNG HỮU ÍCH:** Khi cần vẽ hình học phẳng tùy chỉnh (không thuộc shortcode HHP), hãy tham khảo các lệnh sau đây để đánh dấu các yếu tố và tô màu miền. LUÔN dùng thẻ <TIKZ>.
    *   **ĐÁNH DẤU ĐOẠN THẲNG BẰNG NHAU:**
        `\tkzMarkSegments[mark=||](A,B A,C)`
    *   **ĐÁNH DẤU GÓC VUÔNG:**
        `\tkzMarkRightAngles[size=0.17](A,B,C)`
    *   **ĐÁNH DẤU GÓC (KHÔNG VUÔNG):**
        `\tkzMarkAngles[size=0.7cm,arc=ll,mark=|](A,B,C)`
    *   **GÁN NHÃN CHO GÓC (BÊN TRONG CUNG TRÒN):**
        `\tkzLabelAngles[pos=0.6](A,B,C){$\alpha$}` (Lưu ý: `pos` nhỏ hơn 1 để nhãn nằm trong cung tròn).
    *   **TÔ MÀU MIỀN ĐA GIÁC:**
        `\tkzFillPolygon[color=green!80, fill opacity=0.5](A,B,C)`
    *   **TÔ MIỀN GIỚI HẠN BỞI ĐỒ THỊ (VÍ DỤ TÍCH PHÂN):**
        `\fill[pattern=north east lines,opacity=0.8] plot[domain=-1:3](\x,{(\x)^3-3*(\x)^2-\x+3})--cycle;`
`;

                try {
                    const response = await ai.models.generateContent({ model: "gemini-2.5-flash", contents: prompt });
                    const explanationText = response.text.replace(/\n/g, '<br>');
                    item.explanation = explanationText; // Cache it
                    displayExplanation(explanationText, feedbackDiv, button);
                } catch (error) {
                    console.error("Lỗi khi tạo giải thích:", error);
                    feedbackDiv.insertAdjacentHTML('beforeend', '<div class="ai-explanation text-red-600">Lỗi: Không thể tạo giải thích.</div>');
                    button.disabled = false;
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Thử lại
                    `;
                }
            }

            function displayExplanation(explanationText, container, button) {
                container.insertAdjacentHTML('beforeend', `<div class="ai-explanation prose prose-sm">${explanationText}</div>`);
                if (window.MathJax) MathJax.typesetPromise([container]);
                button.disabled = false;
                button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    Ẩn giải thích
                `;
            }
           
            function renderStudentQuiz() {
                studentQuizContainer.innerHTML = '';
               
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});
                const groupInfo = {
                    'multiple-choice': { title: 'PHẦN I. TRẮC NGHIỆM KHÁCH QUAN', subtitle: 'Chọn đáp án đúng nhất trong các lựa chọn sau.' },
                    'true-false': { title: 'PHẦN II. CÂU HỎI ĐÚNG - SAI', subtitle: 'Xác định tính đúng hoặc sai cho mỗi mệnh đề dưới đây.' },
                    'short-answer': { title: 'PHẦN III. CÂU HỎI TRẢ LỜI NGẮN', subtitle: 'Điền đáp án ngắn gọn vào phần trả lời.' },
                    'essay': { title: 'PHẦN IV. CÂU HỎI TỰ LUẬN', subtitle: 'Trình bày chi tiết bài giải của bạn.' }
                };
               
                let questionCounter = 0;
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    const questions = grouped[partType];
                    if (!questions || questions.length === 0) return;
                   
                    let groupHTML = `<div class="group-container space-y-8 mb-12">`;
                    const info = groupInfo[partType];
                    groupHTML += `
                        <div class="group-header pb-3 border-b-2 border-slate-300 mb-6">
                            <h2 class="text-2xl font-bold text-slate-800">${info.title}</h2>
                            ${info.subtitle ? `<p class="text-md text-slate-600 italic mt-1">${info.subtitle}</p>` : ''}
                        </div>
                    `;
                    questions.forEach((item, localIndex) => {
                        const globalIndex = quizData.indexOf(item);
                        questionCounter++;
                        groupHTML += `<div class="question-card" id="student-q-${globalIndex}">`;
                        let questionText = (item.question || item.main_question || '').replace(/\n/g, '<br>');
                       
                        groupHTML += `<div class="flex items-start">
                                     <div class="flex-grow">
                                         <div class="flex items-center mb-2">
                                             <span class="font-bold text-lg mr-3 text-indigo-600">Câu ${questionCounter}:</span>
                                             <div id="q-${globalIndex}-feedback-icon"></div>
                                         </div>
                                         <div class="question-content mt-2 text-lg text-slate-700">${questionText}</div>
                                         ${item.questionImage ? `<img src="${item.questionImage}" class="mt-4 rounded-lg max-w-full md:max-w-md border shadow-sm">` : ''}
                                     </div>
                                 </div>`;
                       
                        groupHTML += `<div class="mt-6">`;
                        switch(item.mappedType) {
                            case 'multiple-choice':
                                groupHTML += `<div class="options-grid grid grid-cols-1 md:grid-cols-2 gap-4">`;
                                item.options.forEach((opt, i) => {
                                    groupHTML += `<label for="q${globalIndex}-opt${i}" id="q${globalIndex}-opt-label${i}" class="option-label flex items-start p-4 border-2 rounded-xl cursor-pointer hover:bg-indigo-50 hover:border-indigo-400">
                                                     <input type="radio" name="q${globalIndex}" id="q${globalIndex}-opt${i}" value="${i}" class="flex-shrink-0 mt-1 h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                                     <div class="ml-3 flex-grow">
                                                         <span class="font-semibold text-slate-800">${String.fromCharCode(65 + i)}.</span>
                                                         <span class="option-content text-slate-700">${opt || ''}</span>
                                                         ${(item.optionsImage && item.optionsImage[i]) ? `<img src="${item.optionsImage[i]}" class="mt-2 rounded-lg max-w-xs border shadow-sm">` : ''}
                                                     </div>
                                                 </label>`;
                                });
                                groupHTML += `</div>`;
                                break;
                            case 'true-false':
                                 groupHTML += `<div class="space-y-4">`;
                                 item.statements.forEach((s, i) => {
                                     groupHTML += `<div class="statement-item border-t pt-4">
                                                  <p class="mb-3 text-slate-700">${String.fromCharCode(97 + i)}) ${s.statement || ''}</p>
                                                  <div class="flex gap-x-6">
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="true" class="mr-2 h-4 w-4"> Đúng</label>
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="false" class="mr-2 h-4 w-4"> Sai</label>
                                                  </div>
                                              </div>`;
                                 });
                                 groupHTML += `</div>`;
                                 break;
                            case 'short-answer':
                                groupHTML += `<input type="text" name="q${globalIndex}" class="mt-1 block w-full md:w-1/2 border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Nhập đáp án của bạn...">`;
                                break;
                            case 'essay':
                                groupHTML += `<textarea name="q${globalIndex}" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" rows="5" placeholder="Nhập câu trả lời tự luận của bạn..."></textarea>`;
                                break;
                        }
                        groupHTML += `</div><div id="q-${globalIndex}-feedback" class="mt-4"></div></div>`;
                    });
                    groupHTML += `</div>`;
                    studentQuizContainer.innerHTML += groupHTML;
                });
               
                if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                    MathJax.typesetPromise([studentQuizContainer]);
                }
            }
           
            async function generatePerformanceReview(allAnswersData) {
                const feedbackContainer = document.getElementById('ai-feedback-container');
                if (!feedbackContainer || !ai) return null;
                feedbackContainer.classList.remove('hidden');
                feedbackContainer.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-slate-800 mb-4">📝 Phân Tích & Gợi Ý Từ Trợ Lý AI</h3>
                        <div id="ai-feedback-loader" class="text-center py-6">
                            <svg class="animate-spin mx-auto h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p class="mt-3 text-slate-600">AI đang phân tích bài làm của bạn...</p>
                        </div>
                        <div id="ai-feedback-summary" class="hidden prose prose-sm max-w-none"></div>
                        <div id="ai-feedback-details" class="hidden mt-4 space-y-2"></div>
                    </div>
                `;
               
                const loader = document.getElementById('ai-feedback-loader');
                const summaryDiv = document.getElementById('ai-feedback-summary');
                const detailsDiv = document.getElementById('ai-feedback-details');
                const incorrectAnswers = allAnswersData.filter(a => !a.isCorrect);
                if (incorrectAnswers.length === 0) {
                    feedbackContainer.innerHTML = `
                        <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                            <h3 class="text-xl font-bold text-green-600">🎉 Chúc mừng!</h3>
                            <p class="mt-2 text-slate-700">Bạn đã trả lời đúng tất cả các câu hỏi. Làm tốt lắm!</p>
                        </div>
                    `;
                    return { overallFeedback: { summary: "Xuất sắc! Học sinh đã đã trả lời đúng tất cả các câu hỏi." } };
                }
                const summaryPrompt = `Bạn là một trợ lý giáo viên, nói tiếng Việt. Dựa vào tóm tắt các câu trả lời sai của học sinh, hãy đưa ra một nhận xét tổng quan ngắn gọn (khoảng 3-4 câu) về năng lực của học sinh, bao gồm điểm mạnh (suy luận từ các câu làm đúng), điểm yếu (dựa trên các câu sai) và một vài gợi ý ôn tập chung. Lời văn phải khích lệ, rõ ràng.
                Tóm tắt lỗi sai:
                ${JSON.stringify(incorrectAnswers.map(a => ({ cau: a.questionNumber, loai: a.type, cauHoi: a.question.substring(0, 50) + '...' })), null, 2)}`;
                try {
                    const response = await ai.models.generateContent({
                        model: "gemini-2.5-flash",
                        contents: summaryPrompt
                    });
                    summaryDiv.innerHTML = response.text.replace(/\n/g, '<br>');
                    loader.classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                    detailsDiv.classList.remove('hidden'); 
                } catch (e) {
                    console.error("Lỗi khi lấy nhận xét tổng quan:", e);
                    summaryDiv.innerHTML = '<p class="text-red-600">Lỗi khi tạo nhận xét tổng quan.</p>';
                    loader.classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                }
               
                const summaryForSheet = summaryDiv.innerText.substring(0, 200) + "...";
                return { overallFeedback: { summary: summaryForSheet } };
            }
            async function handleSubmit() {
                if (isSubmitted) return;
                isSubmitted = true;
                clearInterval(timerInterval);
                
                document.querySelectorAll('input, textarea').forEach(input => input.disabled = true);
                submitBtn.classList.add('hidden');
                postSubmitOptions.classList.remove('hidden');
                if (retriesLeft > 0) {
                    retryBtn.classList.remove('hidden');
                } else {
                    retryBtn.classList.add('hidden');
                }

                const proctoringDataString = JSON.stringify(proctoringLog);

                let totalStudentScore = 0;
                let totalCorrectAnswers = 0;
                let allAnswersData = [];
                const questionCounts = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    acc[type] = (acc[type] || 0) + 1;
                    return acc;
                }, {});
                
                quizData.forEach((item, index) => {
                    let questionNumber = index + 1;
                    let answerData = { questionNumber, type: item.type };
                    switch (item.mappedType) {
                        case 'multiple-choice':
                            const selectedOption = document.querySelector(`input[name="q${index}"]:checked`);
                            const isCorrectMC = selectedOption ? parseInt(selectedOption.value) === item.correctAnswerIndex : false;
                            if (isCorrectMC) {
                                totalCorrectAnswers++;
                                if (questionCounts['multiple-choice'] > 0) {
                                   totalStudentScore += quizOptions.scoring.mc / questionCounts['multiple-choice'];
                                }
                            }
                            answerData.question = item.question;
                            answerData.options = item.options;
                            answerData.yourAnswer = selectedOption ? String.fromCharCode(65 + parseInt(selectedOption.value)) : "Không trả lời";
                            answerData.correctAnswer = String.fromCharCode(65 + item.correctAnswerIndex);
                            answerData.isCorrect = isCorrectMC;
                            break;
                        case 'true-false':
                            let correctStatementsCount = 0;
                            let yourAnswerPattern = [];
                            let correctAnswerPattern = [];
                            let details = [];
                            item.statements.forEach((s, i) => {
                                const selectedTF = document.querySelector(`input[name="q${index}-s${i}"]:checked`);
                                const studentChoice = selectedTF ? selectedTF.value === 'true' : null;
                                const isStatementCorrect = studentChoice === s.is_correct;
                               
                                if (isStatementCorrect) correctStatementsCount++;
                               
                                yourAnswerPattern.push(studentChoice === null ? '?' : (studentChoice ? 'Đ' : 'S'));
                                correctAnswerPattern.push(s.is_correct ? 'Đ' : 'S');
                                details.push({ statement: s.statement, yourChoice: studentChoice === null ? 'Không trả lời' : (studentChoice ? 'Đúng' : 'Sai'), correctChoice: s.is_correct ? 'Đúng' : 'Sai', isCorrect: isStatementCorrect });
                            });
                            
                            let scorePerTfQuestion = 0;
                            if (questionCounts['true-false'] > 0) {
                                scorePerTfQuestion = quizOptions.scoring.tf / questionCounts['true-false'];
                            }
                            let questionPoints = 0;
                            if (quizOptions.scoring.tfMethod === 'progressive') {
                                const progressivePoints = { 0: 0, 1: 0.1, 2: 0.25, 3: 0.5, 4: 1.0 };
                                questionPoints = progressivePoints[correctStatementsCount] * scorePerTfQuestion;
                            } else { // even
                                questionPoints = (correctStatementsCount / 4) * scorePerTfQuestion;
                            }
                            totalStudentScore += questionPoints;

                            if(correctStatementsCount === 4) totalCorrectAnswers++;
                            answerData.question = item.main_question;
                            answerData.yourAnswer = yourAnswerPattern.join('-');
                            answerData.correctAnswer = correctAnswerPattern.join('-');
                            answerData.isCorrect = correctStatementsCount === 4;
                            answerData.details = details;
                            break;
                       
                        case 'short-answer':
                            const saInput = document.querySelector(`input[name="q${index}"]`);
                            const studentAnswerRaw = saInput ? (saInput.value ?? '').trim() : "";
                            const correctAnswerRaw = (item.answer ?? '').toString().trim().replace(/\$/g, '');
                            let isCorrectSA = false;
                            const studentAnswerNormalized = studentAnswerRaw.replace(',', '.');
                            const correctAnswerNormalized = correctAnswerRaw.replace(',', '.');
                            if (studentAnswerNormalized.toLowerCase() === correctAnswerNormalized.toLowerCase()) {
                                isCorrectSA = true;
                            }
                             if (isCorrectSA) {
                                totalCorrectAnswers++;
                                if (questionCounts['short-answer'] > 0) {
                                   totalStudentScore += quizOptions.scoring.sa / questionCounts['short-answer'];
                                }
                            }
                            answerData.question = item.question;
                            answerData.yourAnswer = studentAnswerRaw || "Không trả lời";
                            answerData.correctAnswer = correctAnswerRaw;
                            answerData.isCorrect = isCorrectSA;
                            break;
                           
                        case 'essay':
                             const essayInput = document.querySelector(`textarea[name="q${index}"]`);
                             answerData.question = item.question;
                             answerData.yourAnswer = essayInput.value || "Không trả lời";
                             answerData.correctAnswer = item.answer;
                             answerData.isCorrect = null; // Needs manual grading
                             break;
                    }
                    allAnswersData.push(answerData);
                });
                
                const finalScore = totalStudentScore;
                
                let competencyAssessment = "Giáo viên không yêu cầu AI phân tích bài làm.";
                if (quizOptions.aiAssessment) {
                    const feedbackData = await generatePerformanceReview(allAnswersData);
                    if (feedbackData && feedbackData.overallFeedback && feedbackData.overallFeedback.summary) {
                        competencyAssessment = feedbackData.overallFeedback.summary;
                    } else {
                        competencyAssessment = "Có lỗi xảy ra trong quá trình AI phân tích bài làm.";
                    }
                }
                
                if (quizOptions.showAnswers) {
                    const totalQuestions = quizData.length;
                    resultContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg text-center">
                        <h3 class="text-2xl font-bold text-slate-800">KẾT QUẢ BÀI LÀM</h3>
                        <p class="mt-4 text-lg">Số câu đúng hoàn toàn: <span class="font-bold text-green-600">${totalCorrectAnswers}/${totalQuestions}</span></p>
                        <p class="text-2xl mt-2">Điểm (thang 10): <span class="font-bold text-blue-600">${finalScore.toFixed(2)}</span></p>
                        ${questionCounts['essay'] > 0 ? `<p class="text-sm text-gray-600 italic mt-1">Lưu ý: Điểm trên chưa bao gồm ${quizOptions.scoring.essay} điểm của phần Tự luận.</p>` : ''}
                    </div>`;
                    resultContainer.classList.remove('hidden');

                    allAnswersData.forEach((ans, index) => {
                        const questionCard = document.getElementById(`student-q-${index}`);
                        const feedbackIconDiv = document.getElementById(`q-${index}-feedback-icon`);
                        const feedbackDiv = document.getElementById(`q-${index}-feedback`);
                        if (!questionCard || !feedbackIconDiv || !feedbackDiv) return;

                        const iconHTML = ans.isCorrect === true
                            ? '<svg class="feedback-icon text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>'
                            : (ans.isCorrect === false ? '<svg class="feedback-icon text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>' : '');
                        feedbackIconDiv.innerHTML = iconHTML;

                        if (ans.type.includes('multiple-choice')) {
                            const studentChoice = ans.yourAnswer === "Không trả lời" ? -1 : ans.yourAnswer.charCodeAt(0) - 65;
                            const correctChoice = ans.correctAnswer.charCodeAt(0) - 65;
                            document.getElementById(`q-${index}-opt-label${correctChoice}`)?.classList.add('correct');
                            if (studentChoice !== -1 && studentChoice !== correctChoice) {
                                document.getElementById(`q-${index}-opt-label${studentChoice}`)?.classList.add('incorrect');
                            }
                        } else if (ans.type === 'true-false') {
                            const statementItems = questionCard.querySelectorAll('.statement-item');
                            ans.details.forEach((detail, i) => { if(statementItems[i]) { statementItems[i].classList.add(detail.isCorrect ? 'correct' : 'incorrect'); }});
                        }

                        if (quizOptions.showExplanation) {
                            feedbackDiv.innerHTML = `<button data-explain-index="${index}" class="explain-btn mt-4 flex items-center px-4 py-2 bg-blue-100 text-blue-800 text-sm font-semibold rounded-lg hover:bg-blue-200 transition-colors">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Xem giải thích
                            </button>`;
                        }
                    });
                    
                    document.querySelectorAll('.explain-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const button = e.currentTarget;
                            const index = parseInt(button.dataset.explainIndex, 10);
                            showExplanation(index, button);
                        });
                    });

                    if (window.MathJax) await window.MathJax.typesetPromise([studentQuizContainer]);
                } else {
                     resultContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg text-center"><h3 class="text-xl font-bold text-green-600">Nộp bài thành công!</h3><p class="mt-2 text-slate-700">Bạn đã hoàn thành bài làm. Kết quả sẽ được giáo viên công bố sau.</p></div>`;
                    resultContainer.classList.remove('hidden');
                }
                
                const formData = new FormData();
                formData.append('name', studentInfo.name);
                formData.append('class', studentInfo.class);
                formData.append('score', `${finalScore.toFixed(2)}/10`);
                formData.append('assessment', competencyAssessment);
                formData.append('timestamp', new Date().toLocaleString('vi-VN'));
                formData.append('examCode', correctExamCode);
                formData.append('monitoringLog', proctoringDataString);
                formData.append('answerDetails', JSON.stringify(allAnswersData));
               
                fetch(googleScriptUrl, { method: 'POST', body: formData})
                    .then(res => console.log("Successfully submitted to Google Sheet"))
                    .catch(err => console.error("Error submitting to Google Sheet:", err));
            }
           
            function startNewAttempt() {
                isSubmitted = false;
                proctoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0, suKien: [] };
                const proctoringWidget = document.getElementById('proctoring-widget');
                if (proctoringWidget) {
                    proctoringWidget.classList.add('hidden');
                    document.getElementById('tab-switch-count').textContent = '0';
                    document.getElementById('copy-count').textContent = '0';
                    document.getElementById('paste-count').textContent = '0';
                }

                renderStudentQuiz();
                resultContainer.classList.add('hidden');
                document.getElementById('ai-feedback-container').classList.add('hidden');
                postSubmitOptions.classList.add('hidden');
                submitBtn.classList.remove('hidden');
                 if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                }
                retriesLeft--;
                retriesDisplay.textContent = `Lượt làm lại còn: ${retriesLeft}`;
                window.scrollTo(0, 0);
            }
            studentInfoForm.addEventListener('submit', (e) => {
                e.preventDefault();
               
                const enteredCode = document.getElementById('exam-code').value.trim().toUpperCase();
                if (enteredCode !== correctExamCode) {
                    alert('Mã đề không chính xác. Vui lòng kiểm tra lại!');
                    return;
                }
               
                studentApiKey = teacherApiKey;
                if (!studentApiKey) {
                    console.warn('Cảnh báo: Giáo viên chưa cấu hình API Key. Các tính năng AI sẽ không hoạt động.');
                }
       
                try {
                    if (studentApiKey) {
                       ai = new GoogleGenAI({ apiKey: studentApiKey });
                    }
                } catch(e) {
                    console.error("Lỗi khởi tạo Gemini API với key của giáo viên.", e);
                    alert("Cảnh báo: API Key của giáo viên không hợp lệ. Vui lòng báo cho giáo viên. Các tính năng AI sẽ không hoạt động.");
                    ai = null;
                }
                shuffleQuiz();
               
                studentInfo.name = document.getElementById('student-name').value;
                studentInfo.class = document.getElementById('student-class').value;
                loginModal.classList.add('hidden');
                studentQuizContainer.classList.remove('hidden');
                submitBtn.classList.remove('hidden');
               
                if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                } else {
                    timerDisplay.textContent = "Không giới hạn";
                }
                retriesDisplay.textContent = `Lượt làm lại còn: ${retriesLeft}`;
                renderStudentQuiz();

                const proctoringWidget = document.getElementById('proctoring-widget');
                const tabSwitchCountEl = document.getElementById('tab-switch-count');
                const copyCountEl = document.getElementById('copy-count');
                const pasteCountEl = document.getElementById('paste-count');

                function updateProctoringUI() {
                    if (proctoringLog.thoatManHinh > 0 || proctoringLog.saoChep > 0 || proctoringLog.dan > 0) {
                        proctoringWidget.classList.remove('hidden');
                    }
                    tabSwitchCountEl.textContent = proctoringLog.thoatManHinh;
                    copyCountEl.textContent = proctoringLog.saoChep;
                    pasteCountEl.textContent = proctoringLog.dan;
                }

                // Disable Right Click
                document.addEventListener('contextmenu', e => e.preventDefault());

                // Track Tab Switching
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && !isSubmitted) {
                        proctoringLog.thoatManHinh++;
                        proctoringLog.suKien.push({ loai: 'chuyen_tab', thoiGian: new Date().toISOString() });
                        updateProctoringUI();
                    }
                });

                // Track Copying
                document.addEventListener('copy', () => {
                    if (isSubmitted) return;
                    proctoringLog.saoChep++;
                    proctoringLog.suKien.push({ loai: 'sao_chep', thoiGian: new Date().toISOString() });
                    updateProctoringUI();
                });

                // Track Pasting
                document.addEventListener('paste', () => {
                    if (isSubmitted) return;
                    proctoringLog.dan++;
                    proctoringLog.suKien.push({ loai: 'dan', thoiGian: new Date().toISOString() });
                    updateProctoringUI();
                });
            });
            
            submitBtn.addEventListener('click', handleSubmit);
            retryBtn.addEventListener('click', () => {
                shuffleQuiz();
                startNewAttempt();
            });
        </script>
    </body>
    </html>
    