
    <!DOCTYPE html>
    <html lang="vi">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Bài Tập Luyện Tập</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
        <script>
            window.MathJax = {
                tex: {
                    packages: {'[+]': ['ams']},
                    inlineMath: [['$', '$'], ['\\(', '\\)']],
                    displayMath: [['$$', '$$'], ['\\[', '\\]']]
                },
                chtml: {
                    fontCache: 'global',
                    linebreaks: {
                        automatic: true
                    }
                }
            };
        </script>
        <script type="text/javascript" id="MathJax-script" async
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
        </script>
        <style>
            body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #f0f4f8; }
            .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
            @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
            .question-card {
                background-color: white;
                border-radius: 1rem;
                padding: 1.5rem 2rem;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                border-left: 5px solid transparent;
                transition: all 0.3s ease;
            }
            .ai-explanation {
                background-color: #f0f9ff;
                color: #0c4a6e;
                padding: 1rem;
                border-radius: 0.75rem;
                font-size: 0.9rem;
                margin-top: 1rem;
                border-left: 4px solid #38bdf8;
            }
            .feedback-icon { width: 1.5rem; height: 1.5rem; }
            .option-label {
                transition: all 0.2s ease-in-out;
                border: 2px solid #e5e7eb;
            }
            .option-label:hover {
                border-color: #6366f1;
                background-color: #eef2ff;
            }
            .option-label.correct {
                border-color: #10b981 !important;
                background-color: #ecfdf5 !important;
                color: #065f46;
            }
            .option-label.incorrect {
                border-color: #ef4444 !important;
                background-color: #fef2f2 !important;
                color: #991b1b;
            }
            .statement-item.correct { background-color: #ecfdf5; border-color: #10b981; }
            .statement-item.incorrect { background-color: #fef2f2; border-color: #ef4444; }
            .prose { max-width: 100%; }
            .prose h1, .prose h2, .prose h3 { font-weight: 600; }
            .prose p { margin-top: 0.5em; margin-bottom: 0.5em; }
            .prose ul, .prose ol { margin-top: 1em; margin-bottom: 1em; padding-left: 1.5em; }
            .prose li > p { margin-top: 0; margin-bottom: 0; }
            .prose code { background-color: #e5e7eb; padding: 0.2em 0.4em; margin: 0; font-size: 85%; border-radius: 3px; }
            .prose pre { background-color: #e5e7eb; padding: 1em; border-radius: 0.5em; overflow-x: auto; }
            .prose pre code { background-color: transparent; padding: 0; }
            details[open] > summary .details-arrow {
                transform: rotate(180deg);
            }
        </style>
    </head>
    <body class="bg-slate-100 text-slate-800">
        <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md transform transition-all" style="animation: fadeIn 0.3s ease-out;">
                <h2 class="text-2xl font-bold mb-2 text-center text-slate-800">Thông Tin Học Sinh</h2>
                <p class="text-center text-slate-500 mb-6">Vui lòng nhập để bắt đầu làm bài.</p>
                <form id="student-info-form">
                    <div class="mb-4">
                        <label for="student-name" class="block text-sm font-medium text-slate-700 mb-1">Họ và tên</label>
                        <input type="text" id="student-name" required class="mt-1 block w-full block border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="student-class" class="block text-sm font-medium text-slate-700 mb-1">Lớp</label>
                        <input type="text" id="student-class" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="exam-code" class="block text-sm font-medium text-slate-700 mb-1">Mã đề</label>
                        <input type="text" id="exam-code" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Nhập mã đề giáo viên cung cấp">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Giáo viên:</label>
                        <p class="mt-1 text-slate-800 bg-slate-100 p-2.5 rounded-lg">LÊ VĂN ĐÔNG</p>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">Bắt đầu làm bài</button>
                </form>
            </div>
        </div>
        <div class="container mx-auto p-4 md:p-8 max-w-4xl">
            <header class="mb-10 p-8 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg">
                <div class="flex justify-between items-center flex-wrap gap-4">
                    <div>
                        <h1 class="text-4xl font-bold">Bài Tập Luyện Tập</h1>
                        <p class="text-lg text-blue-100 mt-2">Hãy hoàn thành các câu hỏi dưới đây một cách tốt nhất!</p>
                        <p class="text-sm text-blue-200 mt-4">Tác giả: LÊ VĂN ĐÔNG</p>
                    </div>
                    <div id="timer-container" class="text-right">
                         <div id="timer-display" class="text-3xl font-bold tracking-wider bg-white/20 px-4 py-2 rounded-lg">--:--</div>
                         <div id="retries-display" class="text-sm mt-1 text-blue-200"></div>
                    </div>
                </div>
            </header>
            <main id="student-quiz-container" class="space-y-8 hidden">
                <!-- Questions will be rendered here by JS -->
            </main>
            <footer class="mt-10 text-center">
                <button id="submit-quiz-btn" class="bg-indigo-600 text-white py-3 px-12 rounded-full font-bold text-lg hover:bg-indigo-700 transition-all duration-300 shadow-lg hover:shadow-xl hidden transform hover:scale-105">Nộp Bài</button>
                <div id="result-container" class="mt-6 hidden"></div>
                <div id="ai-feedback-container" class="mt-8 text-left hidden"></div>
                <div id="post-submit-options" class="hidden mt-6 flex flex-col sm:flex-row items-center justify-center gap-4">
                    <button id="retry-quiz-btn" class="w-full sm:w-auto bg-slate-600 text-white py-2.5 px-6 rounded-lg font-semibold hover:bg-slate-700 transition-transform transform hover:scale-105">Làm Lại Đề Này</button>
                </div>
            </footer>
        </div>

        <div id="proctoring-widget" class="fixed bottom-4 right-4 bg-yellow-100 text-yellow-800 p-3 rounded-lg shadow-lg text-sm z-50 hidden border border-yellow-300" style="max-width: 200px;">
            <h4 class="font-bold mb-2 border-b border-yellow-300 pb-1 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 3.001-1.742 3.001H4.42c-1.53 0-2.493-1.667-1.743-3.001l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                Giám sát
            </h4>
            <p>Thoát màn hình: <span id="tab-switch-count" class="font-bold">0</span></p>
            <p>Sao chép: <span id="copy-count" class="font-bold">0</span></p>
            <p>Dán: <span id="paste-count" class="font-bold">0</span></p>
        </div>

        <script type="module">
            import { GoogleGenAI, Type } from "https://esm.sh/@google/genai@^1.13.0";
            let quizData = [{"type":"multiple-choice","question":"Trong bài học về chia sẻ tài nguyên trên mạng, phương thức chia sẻ tài nguyên tệp và thư mục nào sau đây KHÔNG được đề cập?","questionImage":null,"mappedType":"multiple-choice","options":["Chia sẻ qua mạng có dây","Chia sẻ qua mạng không dây","Chia sẻ qua mạng vệ tinh","Chia sẻ qua đám mây"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Theo tài liệu, 'Không gian mạng (thế giới ảo)' được định nghĩa là nơi con người giao tiếp với nhau chủ yếu bằng cách nào?","questionImage":null,"mappedType":"multiple-choice","options":["Các phương tiện truyền thông dựa trên công nghệ số hóa và nền tảng trực tuyến.","Trực tiếp gặp gỡ và trao đổi thông tin.","Thông qua thư từ và bưu phẩm truyền thống.","Sử dụng tín hiệu khói và đèn."],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Đặc trưng cơ bản nào sau đây là một trong những khả năng cốt lõi của Trí tuệ nhân tạo (AI)?","questionImage":null,"mappedType":"multiple-choice","options":["Khả năng tự động sao chép phần mềm và dữ liệu","Khả năng suy luận và học hỏi từ dữ liệu","Khả năng tăng tốc độ xử lí của phần cứng máy tính","Khả năng mã hóa thông tin cá nhân"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Một học sinh muốn tìm kiếm thông tin về dự báo thời tiết cho ngày mai bằng cách nói với trợ lí ảo: \"Trời mai thế nào?\". Trợ lí ảo phản hồi lại: \"Bạn muốn biết thời tiết ở địa điểm nào?\". Phản hồi này của trợ lí ảo thể hiện đặc trưng cơ bản nào của Trí tuệ nhân tạo (AI)?","questionImage":null,"mappedType":"multiple-choice","options":["Khả năng học hỏi từ dữ liệu người dùng để cá nhân hóa kết quả.","Khả năng suy luận để dự đoán nhu cầu tiếp theo của người dùng.","Khả năng hiểu ngôn ngữ tự nhiên và giải quyết vấn đề bằng cách yêu cầu làm rõ thông tin thiếu.","Khả năng nhận thức môi trường vật lí và tương tác với các đối tượng xung quanh."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Một hệ thống Trí tuệ nhân tạo (AI) được thiết kế để hỗ trợ các bác sĩ trong việc chẩn đoán bệnh. Hệ thống này có khả năng phân tích lượng lớn dữ liệu bệnh án, hình ảnh y tế và các kết quả xét nghiệm để đưa ra dự đoán ban đầu. Điều đặc biệt là, sau mỗi lần đưa ra chẩn đoán và nhận phản hồi về tính chính xác của nó, hệ thống lại tự động điều chỉnh thuật toán và cải thiện độ tin cậy của các dự đoán trong tương lai. Khả năng này của hệ thống AI thể hiện rõ nhất đặc trưng cơ bản nào của Trí tuệ nhân tạo?","questionImage":null,"mappedType":"multiple-choice","options":["Khả năng suy luận","Khả năng học","Khả năng nhận thức","Khả năng giải quyết vấn đề"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Trong bối cảnh chính phủ cân nhắc triển khai rộng rãi hệ thống giám sát công cộng sử dụng Trí tuệ nhân tạo (AI) để nâng cao an ninh và giảm tội phạm, một nhóm chuyên gia cảnh báo về những rủi ro tiềm ẩn. Để đạt được sự cân bằng tối ưu giữa hiệu quả của AI và việc bảo vệ các giá trị xã hội, vấn đề nào sau đây đòi hỏi sự phân tích và giải quyết **phức tạp nhất** ở cấp độ vận dụng cao về đạo đức và pháp lý?","questionImage":null,"mappedType":"multiple-choice","options":["Áp lực thất nghiệp đối với nhân viên an ninh truyền thống do AI tự động hóa nhiều quy trình.","Nguy cơ hệ thống AI bị tấn công mạng, dẫn đến lộ lọt dữ liệu nhạy cảm hoặc bị lợi dụng cho mục đích xấu.","Khả năng AI đưa ra các quyết định hoặc dự đoán có tính phân biệt đối xử do dữ liệu huấn luyện không đại diện hoặc có định kiến, làm tổn hại đến quyền riêng tư và công bằng xã hội.","Yêu cầu xây dựng một khung pháp lý quốc tế đồng bộ và có khả năng thích ứng cao để quản lý sự phát triển nhanh chóng của công nghệ AI."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Một doanh nghiệp đang xem xét tích hợp trí tuệ nhân tạo (AI) vào hệ thống quản lý dữ liệu khách hàng và quy trình sản xuất. Theo các chuyên gia, việc này có thể mang lại hiệu quả lớn nhưng cũng tiềm ẩn nhiều rủi ro. Trong bối cảnh này, cảnh báo nào dưới đây thể hiện mối lo ngại sâu sắc nhất về vấn đề an ninh và quyền riêng tư?","questionImage":null,"mappedType":"multiple-choice","options":["Việc AI tự động hóa có thể dẫn đến việc cắt giảm một số vị trí việc làm, gây ra tình trạng thất nghiệp.","Nếu hệ thống AI không được bảo vệ chặt chẽ, thông tin cá nhân của khách hàng và dữ liệu sản xuất độc quyền có thể bị truy cập trái phép hoặc lạm dụng.","Sự phụ thuộc quá mức vào quyết định của AI có thể làm mất đi tính chủ động và khả năng phân tích của đội ngũ quản lý.","Chi phí ban đầu để triển khai và duy trì các hệ thống AI tiên tiến là rất lớn, ảnh hưởng đến ngân sách của doanh nghiệp."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Mối quan ngại về quyền riêng tư và bảo mật thông tin là một trong những cảnh báo quan trọng khi phát triển và ứng dụng Trí tuệ nhân tạo. Tuy nhiên, vấn đề này cũng là một nhược điểm chung của giao tiếp trong không gian mạng. Dựa vào tài liệu, nhược điểm nào sau đây mô tả đúng nhất về rủi ro liên quan đến an toàn thông tin cá nhân khi giao tiếp trực tuyến?","questionImage":null,"mappedType":"multiple-choice","options":["Thiếu tín hiệu phi ngôn ngữ","Nguy cơ bảo mật và quyền riêng tư","Thiếu kết nối quan hệ cá nhân chặt chẽ","Dễ bị ảnh hưởng bởi sự cố kĩ thuật"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Theo chương trình Tin học phổ thông, lĩnh vực nào sau đây được xem là phát triển mạnh mẽ nhờ ứng dụng của Trí tuệ nhân tạo (AI)?","questionImage":null,"mappedType":"multiple-choice","options":["Y học","Tài chính","Giao thông","Tất cả các lĩnh vực trên"],"optionsImage":[],"correctAnswerIndex":3},{"type":"multiple-choice","question":"Một trong những cảnh báo về sự phát triển của Trí tuệ nhân tạo (AI) được đề cập trong chương trình Tin học phổ thông là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Áp lực thất nghiệp","Giảm hiệu suất làm việc của con người","Tăng chi phí vận hành hệ thống","Thiếu nguồn năng lượng cung cấp cho AI"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Thiết bị mạng nào có chức năng chính là chuyển đổi tín hiệu số sang tín hiệu tương tự và ngược lại để truyền dữ liệu qua đường dây điện thoại hoặc cáp quang?","questionImage":null,"mappedType":"multiple-choice","options":["Hub","Switch","Modem","Router"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Trong một mạng cục bộ (LAN), thiết bị nào hoạt động bằng cách nhận dữ liệu từ một cổng và truyền tải dữ liệu đó đến TẤT CẢ các cổng còn lại, bất kể dữ liệu đó dành cho thiết bị nào?","questionImage":null,"mappedType":"multiple-choice","options":["Switch","Router","Modem","Hub"],"optionsImage":[],"correctAnswerIndex":3},{"type":"multiple-choice","question":"Theo tài liệu đã cho, nhận định nào sau đây là một ưu điểm của giao tiếp trong không gian mạng?","questionImage":null,"mappedType":"multiple-choice","options":["Luôn đảm bảo an toàn tuyệt đối về bảo mật và quyền riêng tư cho người dùng.","Hoàn toàn không phụ thuộc vào các sự cố kỹ thuật.","Mở rộng khả năng kết nối và giao lưu xã hội, không bị giới hạn bởi khoảng cách địa lý.","Giúp tăng cường các tín hiệu giao tiếp phi ngôn ngữ."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"An muốn chia sẻ một thư mục chứa tài liệu học tập với bạn Bình trong mạng cục bộ của trường. An đã thực hiện các bước để chọn thư mục và thiết lập quyền chia sẻ \"Read/Write\". Tuy nhiên, khi Bình cố gắng truy cập thư mục này từ máy của An, Bình nhận được thông báo lỗi \"Windows cannot access \\AnPC\\TaiLieuHocTap\". Dựa vào các yêu cầu về thiết lập môi trường chia sẻ trong mạng cục bộ được học, An cần kiểm tra yếu tố nào sau đây *trước tiên* để khắc phục sự cố?","questionImage":null,"mappedType":"multiple-choice","options":["Máy tính của An đã được thiết lập chế độ mạng \"Mạng riêng\" (Private network) thay vì \"Mạng công cộng\" (Public network) chưa.","Tường lửa trên máy tính của An có đang bật và chặn các kết nối chia sẻ hay không.","An có thực hiện đúng các bước để \"Chia sẻ thư mục\" trong cửa sổ Properties chưa.","An đã kiểm tra xem máy tính của Bình có bị nhiễm virus gây chặn truy cập mạng không."],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Trong một diễn đàn trực tuyến về một vấn đề xã hội nhạy cảm, người dùng $X$ đăng thông tin sai lệch và có những bình luận gay gắt, xúc phạm một nhóm người. Bạn $Y$ đăng một câu chuyện cá nhân để phản bác thông tin của $X$, nhưng vô tình tiết lộ chi tiết riêng tư nhạy cảm của một người bạn. Bạn $Z$ thấy bài viết của $Y$ có giá trị nên đã chia sẻ rộng rãi, khiến thông tin riêng tư của người bạn kia bị lan truyền. Nếu bạn là một người dùng khác (Bạn $C$) quan sát tình huống này, hành động nào sau đây thể hiện tính nhân văn và phù hợp nhất với việc ứng xử trong không gian mạng?","questionImage":null,"mappedType":"multiple-choice","options":["Báo cáo ngay bài viết của người dùng $X$ vì vi phạm quy tắc diễn đàn. Đồng thời, liên hệ riêng với bạn $Y$ để đề nghị chỉnh sửa hoặc xóa phần thông tin nhạy cảm của bạn mình và yêu cầu bạn $Z$ gỡ bỏ bài chia sẻ.","Công khai bình luận vào bài viết của người dùng $X$, chỉ trích mạnh mẽ hành vi phát tán tin giả và yêu cầu $X$ xin lỗi, xóa bài. Sau đó, công khai cảnh báo $Y$ và $Z$ về việc vi phạm quyền riêng tư.","Chia sẻ lại bài viết của bạn $Y$ lên các nhóm khác để thông tin đúng được lan tỏa rộng rãi hơn, đồng thời thêm bình luận nhắc nhở về việc không nên tiết lộ thông tin cá nhân.","Không làm gì cả vì mọi người cần tự chịu trách nhiệm về những gì họ đăng tải hoặc chia sẻ trên không gian mạng."],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Trong một tình huống truyền dữ liệu qua mạng Internet, một người dùng đồng thời thực hiện hai hoạt động: (1) gọi video trực tuyến và (2) tải về một tệp tin dung lượng lớn. Người dùng nhận thấy rằng cuộc gọi video đôi khi có thể bị giật hình hoặc trễ tiếng, nhưng tệp tin tải về luôn hoàn chỉnh và không bị lỗi. Với kiến thức về giao thức TCP và IP, giải thích nào sau đây phù hợp nhất cho hiện tượng trên?","questionImage":null,"mappedType":"multiple-choice","options":["Giao thức TCP được ưu tiên cho cuộc gọi video để đảm bảo chất lượng cao, còn giao thức IP xử lí việc truyền tệp tin nhanh chóng. Sự giật, trễ là do tắc nghẽn mạng chung.","Cuộc gọi video thường sử dụng giao thức UDP để giảm độ trễ, chấp nhận mất mát gói tin nhỏ; trong khi tải tệp tin sử dụng giao thức TCP để đảm bảo dữ liệu được truyền tải đầy đủ và chính xác. Cả hai loại dữ liệu đều được định tuyến bởi giao thức IP.","Cả hai hoạt động đều sử dụng giao thức TCP để đảm bảo an toàn dữ liệu. Tuy nhiên, dữ liệu video được ưu tiên thấp hơn nên dễ bị gián đoạn hơn so với việc tải tệp.","Giao thức IP chịu trách nhiệm đảm bảo thứ tự các gói tin và giao thức TCP giúp định tuyến chúng. Hiện tượng giật, trễ trong cuộc gọi video là do sự cố trên máy chủ dịch vụ."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Chị Lan đang làm việc trên máy tính của mình và muốn chia sẻ một thư mục chứa báo cáo công việc quan trọng với hai đối tượng: sếp của chị (anh Bình) và nhóm làm việc (Nhóm A). Yêu cầu đặt ra là anh Bình có thể đọc và chỉnh sửa báo cáo, trong khi Nhóm A chỉ có thể đọc mà không được phép chỉnh sửa. Để thực hiện đúng yêu cầu này, chị Lan cần thực hiện những thao tác thiết lập quyền chia sẻ nào sau đây?","questionImage":null,"mappedType":"multiple-choice","options":["Thiết lập quyền chia sẻ \"Read\" cho cả anh Bình và Nhóm A.","Thiết lập quyền chia sẻ \"Read/Write\" cho anh Bình, và quyền \"Read\" cho Nhóm A.","Thiết lập quyền chia sẻ \"Full Control\" cho cả anh Bình và Nhóm A.","Thiết lập quyền chia sẻ \"Read/Write\" cho cả anh Bình và Nhóm A."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Trong Bài 5 \"Thực hành chia sẻ tài nguyên trên mạng\", để thiết lập môi trường chia sẻ tệp và máy in cho người dùng trong mạng cục bộ, một trong những yêu cầu quan trọng là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Thiết lập chế độ mạng công cộng.","Thiết lập cho phép nhìn thấy, cho phép chia sẻ tệp và máy in.","Luôn giữ tường lửa hoạt động để đảm bảo an toàn.","Chỉ chia sẻ qua mạng Internet."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Vai trò chính của giao thức mạng là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Chuyển đổi tín hiệu analog thành tín hiệu số.","Quản lý mức tiêu thụ điện năng của các thiết bị mạng.","Xác định các quy tắc và tiêu chuẩn giao tiếp giữa các thiết bị trên mạng.","Chỉ mã hóa dữ liệu cho mục đích bảo mật."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Chức năng nào sau đây mô tả vai trò cốt lõi của giao thức TCP trong truyền dữ liệu?","questionImage":null,"mappedType":"multiple-choice","options":["Gán địa chỉ duy nhất cho các thiết bị trên mạng.","Định tuyến các gói dữ liệu qua các mạng khác nhau.","Đảm bảo việc truyền dữ liệu đáng tin cậy, có thứ tự và được kiểm tra lỗi.","Chuyển đổi tên miền thành địa chỉ IP."],"optionsImage":[],"correctAnswerIndex":2},{"type":"true-false","main_question":"Một bệnh viện lớn đang xem xét triển khai một hệ thống trí tuệ nhân tạo (AI) để hỗ trợ các bác sĩ trong việc chẩn đoán bệnh. Sau khi tìm hiểu về khả năng của AI, bệnh viện đưa ra một số nhận định. Hãy cho biết những nhận định nào dưới đây là đúng.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Hệ thống AI có thể được huấn luyện để nhận diện các dấu hiệu bệnh lí từ hình ảnh y tế như X-quang hoặc MRI.","is_correct":true},{"statement":"Việc sử dụng AI trong y học giúp tăng tốc độ chẩn đoán, nhưng vẫn cần sự giám sát của con người để đảm bảo tính chính xác và an toàn.","is_correct":true},{"statement":"Mặc dù AI có thể đưa ra các gợi ý chẩn đoán với độ chính xác cao, quyết định cuối cùng về phác đồ điều trị và trách nhiệm pháp lí vẫn thuộc về bác sĩ điều trị.","is_correct":true},{"statement":"Với sự phát triển của AI, trong tương lai gần, vai trò của các bác sĩ chuyên khoa chẩn đoán như bác sĩ X-quang, bác sĩ giải phẫu bệnh sẽ hoàn toàn bị thay thế bởi các thuật toán AI.","is_correct":false}]},{"type":"true-false","main_question":"Một tập đoàn công nghệ lớn đang nghiên cứu phát triển các hệ thống xe tự lái hoàn toàn. Tuy nhiên, cùng với tiềm năng to lớn, sự phát triển của công nghệ này cũng đặt ra nhiều vấn đề cần được quan tâm. Hãy đánh giá các nhận định sau đây về những cảnh báo liên quan đến xe tự lái.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Công nghệ xe tự lái có thể giúp giảm thiểu tai nạn giao thông do lỗi của con người.","is_correct":true},{"statement":"Một trong những lo ngại lớn nhất về xe tự lái là vấn đề bảo mật dữ liệu cá nhân của người dùng và nguy cơ bị tấn công mạng.","is_correct":true},{"statement":"Nếu xe tự lái trở nên phổ biến, ngành vận tải có thể đối mặt với áp lực lớn về thất nghiệp đối với tài xế chuyên nghiệp.","is_correct":true},{"statement":"Để đảm bảo an toàn tuyệt đối, các hệ thống xe tự lái phải được thiết kế để luôn ưu tiên bảo toàn tính mạng của hành khách trên xe, ngay cả khi điều đó có thể gây nguy hiểm cho người đi đường khác trong tình huống khẩn cấp.","is_correct":false}]},{"type":"true-false","main_question":"Một gia đình đang gặp vấn đề với hiệu suất mạng nội bộ chậm chạp khi nhiều thiết bị như máy tính và Smart TV cùng lúc truy cập. Họ đang cân nhắc việc thay thế thiết bị kết nối mạng hiện tại bằng một giải pháp hiệu quả hơn. Dựa vào kiến thức về các thiết bị mạng, hãy đánh giá các nhận định dưới đây về việc lựa chọn thiết bị mới:","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Thiết bị mạng ban đầu của gia đình, nếu là Hub, sẽ ưu tiên gửi gói dữ liệu đến cổng của thiết bị đích thông qua địa chỉ MAC đã học được.","is_correct":false},{"statement":"Switch có khả năng học địa chỉ MAC của các thiết bị kết nối vào các cổng của nó, từ đó xây dựng bảng địa chỉ để chuyển tiếp dữ liệu một cách thông minh đến cổng đích.","is_correct":true},{"statement":"Việc thay thế Hub bằng Switch sẽ giúp tạo ra các miền xung đột (collision domain) riêng biệt cho mỗi thiết bị kết nối, từ đó giảm đáng kể khả năng xảy ra va chạm dữ liệu.","is_correct":true},{"statement":"Trong một mạng gia đình có kết nối Internet, việc sử dụng Switch thay thế cho Router để phân bổ địa chỉ IP tự động (DHCP) và thực hiện dịch vụ NAT cho các thiết bị trong mạng là hoàn toàn khả thi.","is_correct":false}]},{"type":"true-false","main_question":"Một doanh nghiệp nhỏ vừa thuê mặt bằng mới và cần thiết lập hệ thống mạng. Họ yêu cầu hệ thống phải kết nối được với Internet, cho phép các máy tính trong văn phòng giao tiếp với nhau, và cung cấp kết nối Wi-Fi cho nhân viên và khách hàng. Dựa vào kiến thức về các thiết bị mạng, hãy đánh giá các nhận định sau để doanh nghiệp có thể thiết lập hệ thống một cách hiệu quả:","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Để kết nối với Internet, doanh nghiệp bắt buộc phải có một Modem, thiết bị này có chức năng chuyển đổi tín hiệu từ nhà cung cấp dịch vụ (ISP) thành tín hiệu mà mạng cục bộ có thể sử dụng.","is_correct":true},{"statement":"Router trong hệ thống mạng này có vai trò chính là định tuyến các gói tin giữa mạng nội bộ của doanh nghiệp và mạng Internet, đồng thời quản lý việc cấp phát địa chỉ IP cho các thiết bị trong mạng LAN.","is_correct":true},{"statement":"Để cung cấp kết nối Wi-Fi an toàn cho nhân viên và khách hàng, doanh nghiệp chỉ cần triển khai một hoặc nhiều WAP cơ bản và kết nối chúng trực tiếp vào Switch mạng, bởi vì WAP tự động quản lý tất cả các chính sách bảo mật và cấp phát địa chỉ IP.","is_correct":false},{"statement":"Nếu doanh nghiệp muốn phân chia mạng nội bộ thành các mạng con riêng biệt (ví dụ: mạng cho kế toán, mạng cho marketing) để tăng cường bảo mật và quản lý lưu lượng, họ có thể chỉ cần sử dụng các Switch có tính năng VLAN mà không cần cấu hình thêm Router để định tuyến giữa các VLAN đó.","is_correct":false}]},{"type":"true-false","main_question":"Trong một buổi học trực tuyến, giáo viên yêu cầu mỗi học sinh gửi một tệp bài tập về nhà đến địa chỉ máy chủ. Quá trình này đòi hỏi sự phối hợp của nhiều thành phần và quy tắc khác nhau trong mạng máy tính. Về vai trò của giao thức mạng và đặc điểm của giao thức IP trong tình huống này, hãy cho biết các nhận định sau đây là Đúng hay Sai:","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Giao thức mạng là tập hợp các quy tắc định nghĩa cách các thiết bị giao tiếp với nhau trong mạng.","is_correct":true},{"statement":"Địa chỉ IP của máy tính gửi tệp sẽ thay đổi nếu học sinh chuyển từ mạng Wi-Fi ở nhà sang mạng 4G trên điện thoại, trong khi địa chỉ IP công cộng là duy nhất trên Internet tại một thời điểm.","is_correct":true},{"statement":"Để tệp bài tập của học sinh có thể đi từ máy tính cá nhân qua nhiều thiết bị mạng (như router, switch) đến máy chủ, giao thức IP đóng vai trò như một người dẫn đường, quyết định tuyến đường tốt nhất cho các gói dữ liệu dựa trên địa chỉ đích.","is_correct":true},{"statement":"Nếu một gói dữ liệu chứa một phần của tệp bài tập bị mất trên đường đến máy chủ, giao thức IP sẽ tự động gửi lại gói đó cho đến khi máy chủ nhận được đầy đủ và đúng thứ tự các gói dữ liệu.","is_correct":false}]},{"type":"true-false","main_question":"Trong bối cảnh hội nghị truyền hình trực tuyến hoặc giao dịch chứng khoán, bạn quan sát thấy đôi khi luồng video/âm thanh có thể bị giật hoặc trễ nhẹ, nhưng các tin nhắn văn bản trao đổi hoặc lệnh giao dịch chứng khoán luôn được đảm bảo gửi và nhận chính xác, không mất mát. Tình huống này minh họa sự khác biệt trong cách các giao thức mạng xử lý dữ liệu. Về chức năng của giao thức TCP và UDP cùng các vấn đề liên quan, hãy cho biết các nhận định sau đây là Đúng hay Sai:","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Giao thức TCP ($Transmission$ $Control$ $Protocol$) là lựa chọn ưu tiên cho các dữ liệu yêu cầu độ chính xác cao như lệnh giao dịch chứng khoán hoặc tin nhắn văn bản trong hội nghị. Nó đảm bảo các gói dữ liệu được truyền tải tuần tự, đầy đủ và không bị lỗi nhờ cơ chế kiểm soát luồng và kiểm soát tắc nghẽn hiệu quả.","is_correct":true},{"statement":"Trước khi các bên tham gia hội nghị truyền hình có thể trao đổi các tập tin hay tài liệu quan trọng, giao thức TCP cần thực hiện quy trình '$bắt$ $tay$ $ba$ $bước$' ($three$-$way$ $handshake$) để thiết lập một phiên kết nối đáng tin cậy, đồng bộ hóa các tham số và chuẩn bị cho việc truyền dữ liệu.","is_correct":true},{"statement":"Nếu một gói dữ liệu chứa thông tin quan trọng về lệnh mua/bán chứng khoán bị mất trên đường truyền, TCP sẽ tự động phát hiện và yêu cầu gửi lại gói đó. Cơ chế này đảm bảo tính toàn vẹn của giao dịch, dù có thể dẫn đến một độ trễ nhỏ hơn so với việc không có cơ chế kiểm soát lỗi.","is_correct":true},{"statement":"Đối với dữ liệu thời gian thực nhạy cảm với độ trễ như luồng hình ảnh và âm thanh trong hội nghị trực tuyến, giao thức UDP ($User$ $Datagram$ $Protocol$) thường được ưu tiên sử dụng. UDP tập trung vào tốc độ truyền dẫn và liên tục, chấp nhận rủi ro mất một số gói dữ liệu nhỏ để duy trì trải nghiệm mượt mà, tránh tình trạng gián đoạn hoặc 'lag' kéo dài.","is_correct":true}]}];
            const quizOptions = {"timeLimit":45,"retriesAllowed":1,"showAnswers":true,"showExplanation":true,"aiAssessment":true,"scoring":{"mc":7,"tf":3,"sa":0,"essay":0,"tfMethod":"progressive"}};
            const googleScriptUrl = "https://script.google.com/macros/s/AKfycbzAhhPPCUgw-uU55gOj87Tm16ugz8FuBlRwQ7sECOBiOWBC8n6SI2mt_mQblXdoCdje/exec";
            const correctExamCode = "92PIK0";
            const teacherApiKey = "AIzaSyDzpJyodrQYlL0_OmSq4k3snugEgphM6IE";
            let studentInfo = {};
            let isSubmitted = false;
            let timerInterval;
            let retriesLeft = quizOptions.retriesAllowed;
            let studentApiKey = "";
            let ai = null;

            let proctoringLog = {
                thoatManHinh: 0,
                saoChep: 0,
                dan: 0,
                suKien: []
            };

            const studentQuizContainer = document.getElementById('student-quiz-container');
            const submitBtn = document.getElementById('submit-quiz-btn');
            const resultContainer = document.getElementById('result-container');
            const postSubmitOptions = document.getElementById('post-submit-options');
            const retryBtn = document.getElementById('retry-quiz-btn');
            const loginModal = document.getElementById('login-modal');
            const studentInfoForm = document.getElementById('student-info-form');
            const timerDisplay = document.getElementById('timer-display');
            const retriesDisplay = document.getElementById('retries-display');
            function shuffleQuiz() {
                // Shuffle options/statements within each question first
                quizData.forEach(item => {
                    // Shuffle multiple-choice options and their corresponding images
                    if (item.mappedType === 'multiple-choice' && item.options && item.options.length > 0) {
                        const correctAnswerText = item.options[item.correctAnswerIndex];
                        let optionsWithImages = item.options.map((opt, index) => ({
                            text: opt,
                            image: (item.optionsImage && item.optionsImage[index]) ? item.optionsImage[index] : null
                        }));
                        // Fisher-Yates shuffle
                        for (let i = optionsWithImages.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [optionsWithImages[i], optionsWithImages[j]] = [optionsWithImages[j], optionsWithImages[i]];
                        }
                        // Update the item with shuffled data
                        item.options = optionsWithImages.map(opt => opt.text);
                        item.optionsImage = optionsWithImages.map(opt => opt.image);
                        item.correctAnswerIndex = item.options.indexOf(correctAnswerText);
                    }
                    // Shuffle true-false statements
                    if (item.mappedType === 'true-false' && item.statements && item.statements.length > 0) {
                         for (let i = item.statements.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [item.statements[i], item.statements[j]] = [item.statements[j], item.statements[i]];
                        }
                    }
                });
                // Then, group questions by type and shuffle within each group
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});
                let shuffledQuizData = [];
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    if (grouped[partType]) {
                        const partQuestions = grouped[partType];
                        for (let i = partQuestions.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [partQuestions[i], partQuestions[j]] = [partQuestions[j], partQuestions[i]];
                        }
                        shuffledQuizData = shuffledQuizData.concat(partQuestions);
                    }
                });
               
                quizData = shuffledQuizData;
            }
            // --- Timer Function ---
            function startTimer(duration, display) {
                let timer = duration, minutes, seconds;
                clearInterval(timerInterval); // Clear any existing timer
                if(duration <= 0) {
                     display.textContent = "∞";
                     return;
                }
                timerInterval = setInterval(function () {
                    minutes = parseInt(timer / 60, 10);
                    seconds = parseInt(timer % 60, 10);
                    minutes = minutes < 10 ? "0" + minutes : minutes;
                    seconds = seconds < 10 ? "0" + seconds : seconds;
                    display.textContent = minutes + ":" + seconds;
                    if (--timer < 0) {
                        clearInterval(timerInterval);
                        alert("Hết giờ làm bài!");
                        handleSubmit();
                    }
                }, 1000);
            }
            
            async function showExplanation(index, button) {
                const item = quizData[index];
                const questionCard = document.getElementById(`student-q-${index}`);
                const feedbackDiv = document.getElementById(`q-${index}-feedback`);
                if (!questionCard || !feedbackDiv) return;

                const existingExplanation = feedbackDiv.querySelector('.ai-explanation');
                if (existingExplanation) {
                    existingExplanation.remove();
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Xem giải thích
                    `;
                    return;
                }

                button.disabled = true;
                button.innerHTML = '<div class="loader mr-2"></div> Đang tải...';

                if (item.explanation) {
                    displayExplanation(item.explanation, feedbackDiv, button);
                    return;
                }

                if (!ai) {
                    alert("Tính năng giải thích yêu cầu API Key, nhưng chưa được cấu hình bởi giáo viên.");
                    button.disabled = false;
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Xem giải thích
                    `;
                    return;
                }

                const questionText = item.question || item.main_question;
                let prompt = `Bạn là một trợ lý giáo viên AI, am hiểu sâu sắc Chương trình GDPT 2018. Hãy cung cấp một lời giải chi tiết, từng bước một cho câu hỏi sau đây. Lời giải phải chính xác, dễ hiểu và phù hợp với phương pháp giảng dạy của chương trình học, TUYỆT ĐỐI KHÔNG sử dụng kiến thức của lớp cao hơn để giải thích.\n\n--- CÂU HỎI ---\n${questionText}\n\n`;
                if (item.mappedType === 'multiple-choice') {
                    prompt += `--- CÁC LỰA CHỌN ---\n${item.options.map((opt, i) => `${String.fromCharCode(65 + i)}. ${opt}`).join('\n')}\n\n`;
                    prompt += `--- ĐÁP ÁN ĐÚNG ---\n${String.fromCharCode(65 + item.correctAnswerIndex)}. ${item.options[item.correctAnswerIndex]}`;
                } else if (item.mappedType === 'true-false') {
                    prompt += `--- CÁC MỆNH ĐỀ & ĐÁP ÁN ---\n${item.statements.map(s => ` - ${s.statement} -> ${s.is_correct ? 'Đúng' : 'Sai'}`).join('\n')}`;
                } else {
                    prompt += `--- ĐÁP ÁN / GỢI Ý ---\n${item.answer}`;
                }
                prompt += `\n\n--- YÊU CẦU ---\nGiải thích rõ ràng tại sao đáp án lại đúng, từng bước một. Định dạng tất cả các công thức toán học bằng LaTeX.`;

                try {
                    const response = await ai.models.generateContent({ model: "gemini-2.5-flash", contents: prompt });
                    const explanationText = response.text.replace(/\n/g, '<br>');
                    item.explanation = explanationText; // Cache it
                    displayExplanation(explanationText, feedbackDiv, button);
                } catch (error) {
                    console.error("Lỗi khi tạo giải thích:", error);
                    feedbackDiv.insertAdjacentHTML('beforeend', '<div class="ai-explanation text-red-600">Lỗi: Không thể tạo giải thích.</div>');
                    button.disabled = false;
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Thử lại
                    `;
                }
            }

            function displayExplanation(explanationText, container, button) {
                container.insertAdjacentHTML('beforeend', `<div class="ai-explanation prose prose-sm">${explanationText}</div>`);
                if (window.MathJax) MathJax.typesetPromise([container]);
                button.disabled = false;
                button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    Ẩn giải thích
                `;
            }
           
            function renderStudentQuiz() {
                studentQuizContainer.innerHTML = '';
               
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});
                const groupInfo = {
                    'multiple-choice': { title: 'PHẦN I. TRẮC NGHIỆM KHÁCH QUAN', subtitle: 'Chọn đáp án đúng nhất trong các lựa chọn sau.' },
                    'true-false': { title: 'PHẦN II. CÂU HỎI ĐÚNG - SAI', subtitle: 'Xác định tính đúng hoặc sai cho mỗi mệnh đề dưới đây.' },
                    'short-answer': { title: 'PHẦN III. CÂU HỎI TRẢ LỜI NGẮN', subtitle: 'Điền đáp án ngắn gọn vào phần trả lời.' },
                    'essay': { title: 'PHẦN IV. CÂU HỎI TỰ LUẬN', subtitle: 'Trình bày chi tiết bài giải của bạn.' }
                };
               
                let questionCounter = 0;
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    const questions = grouped[partType];
                    if (!questions || questions.length === 0) return;
                   
                    let groupHTML = `<div class="group-container space-y-8 mb-12">`;
                    const info = groupInfo[partType];
                    groupHTML += `
                        <div class="group-header pb-3 border-b-2 border-slate-300 mb-6">
                            <h2 class="text-2xl font-bold text-slate-800">${info.title}</h2>
                            ${info.subtitle ? `<p class="text-md text-slate-600 italic mt-1">${info.subtitle}</p>` : ''}
                        </div>
                    `;
                    questions.forEach((item, localIndex) => {
                        const globalIndex = quizData.indexOf(item);
                        questionCounter++;
                        groupHTML += `<div class="question-card" id="student-q-${globalIndex}">`;
                        let questionText = (item.question || item.main_question || '').replace(/\n/g, '<br>');
                       
                        groupHTML += `<div class="flex items-start">
                                     <div class="flex-grow">
                                         <div class="flex items-center mb-2">
                                             <span class="font-bold text-lg mr-3 text-indigo-600">Câu ${questionCounter}:</span>
                                             <div id="q-${globalIndex}-feedback-icon"></div>
                                         </div>
                                         <div class="question-content mt-2 text-lg text-slate-700">${questionText}</div>
                                         ${item.questionImage ? `<img src="${item.questionImage}" class="mt-4 rounded-lg max-w-full md:max-w-md border shadow-sm">` : ''}
                                     </div>
                                 </div>`;
                       
                        groupHTML += `<div class="mt-6">`;
                        switch(item.mappedType) {
                            case 'multiple-choice':
                                groupHTML += `<div class="options-grid grid grid-cols-1 md:grid-cols-2 gap-4">`;
                                item.options.forEach((opt, i) => {
                                    groupHTML += `<label for="q${globalIndex}-opt${i}" id="q${globalIndex}-opt-label${i}" class="option-label flex items-start p-4 border-2 rounded-xl cursor-pointer hover:bg-indigo-50 hover:border-indigo-400">
                                                     <input type="radio" name="q${globalIndex}" id="q${globalIndex}-opt${i}" value="${i}" class="flex-shrink-0 mt-1 h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                                     <div class="ml-3 flex-grow">
                                                         <span class="font-semibold text-slate-800">${String.fromCharCode(65 + i)}.</span>
                                                         <span class="option-content text-slate-700">${opt || ''}</span>
                                                         ${(item.optionsImage && item.optionsImage[i]) ? `<img src="${item.optionsImage[i]}" class="mt-2 rounded-lg max-w-xs border shadow-sm">` : ''}
                                                     </div>
                                                 </label>`;
                                });
                                groupHTML += `</div>`;
                                break;
                            case 'true-false':
                                 groupHTML += `<div class="space-y-4">`;
                                 item.statements.forEach((s, i) => {
                                     groupHTML += `<div class="statement-item border-t pt-4">
                                                  <p class="mb-3 text-slate-700">${String.fromCharCode(97 + i)}) ${s.statement || ''}</p>
                                                  <div class="flex gap-x-6">
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="true" class="mr-2 h-4 w-4"> Đúng</label>
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="false" class="mr-2 h-4 w-4"> Sai</label>
                                                  </div>
                                              </div>`;
                                 });
                                 groupHTML += `</div>`;
                                 break;
                            case 'short-answer':
                                groupHTML += `<input type="text" name="q${globalIndex}" class="mt-1 block w-full md:w-1/2 border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Nhập đáp án của bạn...">`;
                                break;
                            case 'essay':
                                groupHTML += `<textarea name="q${globalIndex}" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" rows="5" placeholder="Nhập câu trả lời tự luận của bạn..."></textarea>`;
                                break;
                        }
                        groupHTML += `</div><div id="q-${globalIndex}-feedback" class="mt-4"></div></div>`;
                    });
                    groupHTML += `</div>`;
                    studentQuizContainer.innerHTML += groupHTML;
                });
               
                if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                    MathJax.typesetPromise([studentQuizContainer]);
                }
            }
           
            async function generatePerformanceReview(allAnswersData) {
                const feedbackContainer = document.getElementById('ai-feedback-container');
                if (!feedbackContainer || !ai) return null;
                feedbackContainer.classList.remove('hidden');
                feedbackContainer.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-slate-800 mb-4">📝 Phân Tích & Gợi Ý Từ Trợ Lý AI</h3>
                        <div id="ai-feedback-loader" class="text-center py-6">
                            <svg class="animate-spin mx-auto h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p class="mt-3 text-slate-600">AI đang phân tích bài làm của bạn...</p>
                        </div>
                        <div id="ai-feedback-summary" class="hidden prose prose-sm max-w-none"></div>
                        <div id="ai-feedback-details" class="hidden mt-4 space-y-2"></div>
                    </div>
                `;
               
                const loader = document.getElementById('ai-feedback-loader');
                const summaryDiv = document.getElementById('ai-feedback-summary');
                const detailsDiv = document.getElementById('ai-feedback-details');
                const incorrectAnswers = allAnswersData.filter(a => !a.isCorrect);
                if (incorrectAnswers.length === 0) {
                    feedbackContainer.innerHTML = `
                        <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                            <h3 class="text-xl font-bold text-green-600">🎉 Chúc mừng!</h3>
                            <p class="mt-2 text-slate-700">Bạn đã trả lời đúng tất cả các câu hỏi. Làm tốt lắm!</p>
                        </div>
                    `;
                    return { overallFeedback: { summary: "Xuất sắc! Học sinh đã đã trả lời đúng tất cả các câu hỏi." } };
                }
                const summaryPrompt = `Bạn là một trợ lý giáo viên, nói tiếng Việt. Dựa vào tóm tắt các câu trả lời sai của học sinh, hãy đưa ra một nhận xét tổng quan ngắn gọn (khoảng 3-4 câu) về năng lực của học sinh, bao gồm điểm mạnh (suy luận từ các câu làm đúng), điểm yếu (dựa trên các câu sai) và một vài gợi ý ôn tập chung. Lời văn phải khích lệ, rõ ràng.
                Tóm tắt lỗi sai:
                ${JSON.stringify(incorrectAnswers.map(a => ({ cau: a.questionNumber, loai: a.type, cauHoi: a.question.substring(0, 50) + '...' })), null, 2)}`;
                try {
                    const summaryResponse = await ai.models.generateContent({
                        model: "gemini-2.5-flash",
                        contents: summaryPrompt
                    });
                    summaryDiv.innerHTML = summaryResponse.text.replace(/\n/g, '<br>');
                    loader.classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                    detailsDiv.classList.remove('hidden'); 
                } catch (e) {
                    console.error("Lỗi khi lấy nhận xét tổng quan:", e);
                    summaryDiv.innerHTML = '<p class="text-red-600">Lỗi khi tạo nhận xét tổng quan.</p>';
                    loader.classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                }
               
                const summaryForSheet = summaryDiv.innerText.substring(0, 200) + "...";
                return { overallFeedback: { summary: summaryForSheet } };
            }
            async function handleSubmit() {
                if (isSubmitted) return;
                isSubmitted = true;
                clearInterval(timerInterval);
                
                document.querySelectorAll('input, textarea').forEach(input => input.disabled = true);
                submitBtn.classList.add('hidden');
                postSubmitOptions.classList.remove('hidden');
                if (retriesLeft > 0) {
                    retryBtn.classList.remove('hidden');
                } else {
                    retryBtn.classList.add('hidden');
                }

                const proctoringDataString = JSON.stringify(proctoringLog);

                let totalStudentScore = 0;
                let totalCorrectAnswers = 0;
                let allAnswersData = [];
                const questionCounts = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    acc[type] = (acc[type] || 0) + 1;
                    return acc;
                }, {});
                
                quizData.forEach((item, index) => {
                    let questionNumber = index + 1;
                    let answerData = { questionNumber, type: item.type };
                    switch (item.mappedType) {
                        case 'multiple-choice':
                            const selectedOption = document.querySelector(`input[name="q${index}"]:checked`);
                            const isCorrectMC = selectedOption ? parseInt(selectedOption.value) === item.correctAnswerIndex : false;
                            if (isCorrectMC) {
                                totalCorrectAnswers++;
                                if (questionCounts['multiple-choice'] > 0) {
                                   totalStudentScore += quizOptions.scoring.mc / questionCounts['multiple-choice'];
                                }
                            }
                            answerData.question = item.question;
                            answerData.options = item.options;
                            answerData.yourAnswer = selectedOption ? String.fromCharCode(65 + parseInt(selectedOption.value)) : "Không trả lời";
                            answerData.correctAnswer = String.fromCharCode(65 + item.correctAnswerIndex);
                            answerData.isCorrect = isCorrectMC;
                            break;
                        case 'true-false':
                            let correctStatementsCount = 0;
                            let yourAnswerPattern = [];
                            let correctAnswerPattern = [];
                            let details = [];
                            item.statements.forEach((s, i) => {
                                const selectedTF = document.querySelector(`input[name="q${index}-s${i}"]:checked`);
                                const studentChoice = selectedTF ? selectedTF.value === 'true' : null;
                                const isStatementCorrect = studentChoice === s.is_correct;
                               
                                if (isStatementCorrect) correctStatementsCount++;
                               
                                yourAnswerPattern.push(studentChoice === null ? '?' : (studentChoice ? 'Đ' : 'S'));
                                correctAnswerPattern.push(s.is_correct ? 'Đ' : 'S');
                                details.push({ statement: s.statement, yourChoice: studentChoice === null ? 'Không trả lời' : (studentChoice ? 'Đúng' : 'Sai'), correctChoice: s.is_correct ? 'Đúng' : 'Sai', isCorrect: isStatementCorrect });
                            });
                            
                            let scorePerTfQuestion = 0;
                            if (questionCounts['true-false'] > 0) {
                                scorePerTfQuestion = quizOptions.scoring.tf / questionCounts['true-false'];
                            }
                            let questionPoints = 0;
                            if (quizOptions.scoring.tfMethod === 'progressive') {
                                const progressivePoints = { 0: 0, 1: 0.1, 2: 0.25, 3: 0.5, 4: 1.0 };
                                questionPoints = progressivePoints[correctStatementsCount] * scorePerTfQuestion;
                            } else { // even
                                questionPoints = (correctStatementsCount / 4) * scorePerTfQuestion;
                            }
                            totalStudentScore += questionPoints;

                            if(correctStatementsCount === 4) totalCorrectAnswers++;
                            answerData.question = item.main_question;
                            answerData.yourAnswer = yourAnswerPattern.join('-');
                            answerData.correctAnswer = correctAnswerPattern.join('-');
                            answerData.isCorrect = correctStatementsCount === 4;
                            answerData.details = details;
                            break;
                       
                        case 'short-answer':
                            const saInput = document.querySelector(`input[name="q${index}"]`);
                            const studentAnswerRaw = saInput ? (saInput.value ?? '').trim() : "";
                            const correctAnswerRaw = (item.answer ?? '').toString().trim().replace(/\$/g, '');
                            let isCorrectSA = false;
                            const studentAnswerNormalized = studentAnswerRaw.replace(',', '.');
                            const correctAnswerNormalized = correctAnswerRaw.replace(',', '.');
                            if (studentAnswerNormalized.toLowerCase() === correctAnswerNormalized.toLowerCase()) {
                                isCorrectSA = true;
                            }
                             if (isCorrectSA) {
                                totalCorrectAnswers++;
                                if (questionCounts['short-answer'] > 0) {
                                   totalStudentScore += quizOptions.scoring.sa / questionCounts['short-answer'];
                                }
                            }
                            answerData.question = item.question;
                            answerData.yourAnswer = studentAnswerRaw || "Không trả lời";
                            answerData.correctAnswer = correctAnswerRaw;
                            answerData.isCorrect = isCorrectSA;
                            break;
                           
                        case 'essay':
                             const essayInput = document.querySelector(`textarea[name="q${index}"]`);
                             answerData.question = item.question;
                             answerData.yourAnswer = essayInput.value || "Không trả lời";
                             answerData.correctAnswer = item.answer;
                             answerData.isCorrect = null; // Needs manual grading
                             break;
                    }
                    allAnswersData.push(answerData);
                });
                
                const finalScore = totalStudentScore;
                
                let competencyAssessment = "Giáo viên không yêu cầu AI phân tích bài làm.";
                if (quizOptions.aiAssessment) {
                    const feedbackData = await generatePerformanceReview(allAnswersData);
                    if (feedbackData && feedbackData.overallFeedback && feedbackData.overallFeedback.summary) {
                        competencyAssessment = feedbackData.overallFeedback.summary;
                    } else {
                        competencyAssessment = "Có lỗi xảy ra trong quá trình AI phân tích bài làm.";
                    }
                }
                
                if (quizOptions.showAnswers) {
                    const totalQuestions = quizData.length;
                    resultContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg text-center">
                        <h3 class="text-2xl font-bold text-slate-800">KẾT QUẢ BÀI LÀM</h3>
                        <p class="mt-4 text-lg">Số câu đúng hoàn toàn: <span class="font-bold text-green-600">${totalCorrectAnswers}/${totalQuestions}</span></p>
                        <p class="text-2xl mt-2">Điểm (thang 10): <span class="font-bold text-blue-600">${finalScore.toFixed(2)}</span></p>
                        ${questionCounts['essay'] > 0 ? `<p class="text-sm text-gray-600 italic mt-1">Lưu ý: Điểm trên chưa bao gồm ${quizOptions.scoring.essay} điểm của phần Tự luận.</p>` : ''}
                    </div>`;
                    resultContainer.classList.remove('hidden');

                    allAnswersData.forEach((ans, index) => {
                        const questionCard = document.getElementById(`student-q-${index}`);
                        const feedbackIconDiv = document.getElementById(`q-${index}-feedback-icon`);
                        const feedbackDiv = document.getElementById(`q-${index}-feedback`);
                        if (!questionCard || !feedbackIconDiv || !feedbackDiv) return;

                        const iconHTML = ans.isCorrect === true
                            ? '<svg class="feedback-icon text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>'
                            : (ans.isCorrect === false ? '<svg class="feedback-icon text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>' : '');
                        feedbackIconDiv.innerHTML = iconHTML;

                        if (ans.type.includes('multiple-choice')) {
                            const studentChoice = ans.yourAnswer === "Không trả lời" ? -1 : ans.yourAnswer.charCodeAt(0) - 65;
                            const correctChoice = ans.correctAnswer.charCodeAt(0) - 65;
                            document.getElementById(`q-${index}-opt-label${correctChoice}`)?.classList.add('correct');
                            if (studentChoice !== -1 && studentChoice !== correctChoice) {
                                document.getElementById(`q-${index}-opt-label${studentChoice}`)?.classList.add('incorrect');
                            }
                        } else if (ans.type === 'true-false') {
                            const statementItems = questionCard.querySelectorAll('.statement-item');
                            ans.details.forEach((detail, i) => { if(statementItems[i]) { statementItems[i].classList.add(detail.isCorrect ? 'correct' : 'incorrect'); }});
                        }

                        if (quizOptions.showExplanation) {
                            feedbackDiv.innerHTML = `<button data-explain-index="${index}" class="explain-btn mt-4 flex items-center px-4 py-2 bg-blue-100 text-blue-800 text-sm font-semibold rounded-lg hover:bg-blue-200 transition-colors">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Xem giải thích
                            </button>`;
                        }
                    });
                    
                    document.querySelectorAll('.explain-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const button = e.currentTarget;
                            const index = parseInt(button.dataset.explainIndex, 10);
                            showExplanation(index, button);
                        });
                    });

                    if (window.MathJax) await window.MathJax.typesetPromise([studentQuizContainer]);
                } else {
                     resultContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg text-center"><h3 class="text-xl font-bold text-green-600">Nộp bài thành công!</h3><p class="mt-2 text-slate-700">Bạn đã hoàn thành bài làm. Kết quả sẽ được giáo viên công bố sau.</p></div>`;
                    resultContainer.classList.remove('hidden');
                }
                
                const formData = new FormData();
                formData.append('name', studentInfo.name);
                formData.append('class', studentInfo.class);
                formData.append('score', `${finalScore.toFixed(2)}/10`);
                formData.append('assessment', competencyAssessment);
                formData.append('timestamp', new Date().toLocaleString('vi-VN'));
                formData.append('examCode', correctExamCode);
                formData.append('monitoringLog', proctoringDataString);
                formData.append('answerDetails', JSON.stringify(allAnswersData));
               
                fetch(googleScriptUrl, { method: 'POST', body: formData})
                    .then(res => console.log("Successfully submitted to Google Sheet"))
                    .catch(err => console.error("Error submitting to Google Sheet:", err));
            }
           
            function startNewAttempt() {
                isSubmitted = false;
                proctoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0, suKien: [] };
                const proctoringWidget = document.getElementById('proctoring-widget');
                if (proctoringWidget) {
                    proctoringWidget.classList.add('hidden');
                    document.getElementById('tab-switch-count').textContent = '0';
                    document.getElementById('copy-count').textContent = '0';
                    document.getElementById('paste-count').textContent = '0';
                }

                renderStudentQuiz();
                resultContainer.classList.add('hidden');
                document.getElementById('ai-feedback-container').classList.add('hidden');
                postSubmitOptions.classList.add('hidden');
                submitBtn.classList.remove('hidden');
                 if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                }
                retriesLeft--;
                retriesDisplay.textContent = `Lượt làm lại còn: ${retriesLeft}`;
                window.scrollTo(0, 0);
            }
            studentInfoForm.addEventListener('submit', (e) => {
                e.preventDefault();
               
                const enteredCode = document.getElementById('exam-code').value.trim().toUpperCase();
                if (enteredCode !== correctExamCode) {
                    alert('Mã đề không chính xác. Vui lòng kiểm tra lại!');
                    return;
                }
               
                studentApiKey = teacherApiKey;
                if (!studentApiKey) {
                    console.warn('Cảnh báo: Giáo viên chưa cấu hình API Key. Các tính năng AI sẽ không hoạt động.');
                }
       
                try {
                    if (studentApiKey) {
                       ai = new GoogleGenAI({ apiKey: studentApiKey });
                    }
                } catch(e) {
                    console.error("Lỗi khởi tạo Gemini API với key của giáo viên.", e);
                    alert("Cảnh báo: API Key của giáo viên không hợp lệ. Vui lòng báo cho giáo viên. Các tính năng AI sẽ không hoạt động.");
                    ai = null;
                }
                shuffleQuiz();
               
                studentInfo.name = document.getElementById('student-name').value;
                studentInfo.class = document.getElementById('student-class').value;
                loginModal.classList.add('hidden');
                studentQuizContainer.classList.remove('hidden');
                submitBtn.classList.remove('hidden');
               
                if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                } else {
                    timerDisplay.textContent = "Không giới hạn";
                }
                retriesDisplay.textContent = `Lượt làm lại còn: ${retriesLeft}`;
                renderStudentQuiz();

                const proctoringWidget = document.getElementById('proctoring-widget');
                const tabSwitchCountEl = document.getElementById('tab-switch-count');
                const copyCountEl = document.getElementById('copy-count');
                const pasteCountEl = document.getElementById('paste-count');

                function updateProctoringUI() {
                    if (proctoringLog.thoatManHinh > 0 || proctoringLog.saoChep > 0 || proctoringLog.dan > 0) {
                        proctoringWidget.classList.remove('hidden');
                    }
                    tabSwitchCountEl.textContent = proctoringLog.thoatManHinh;
                    copyCountEl.textContent = proctoringLog.saoChep;
                    pasteCountEl.textContent = proctoringLog.dan;
                }

                // Disable Right Click
                document.addEventListener('contextmenu', e => e.preventDefault());

                // Track Tab Switching
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && !isSubmitted) {
                        proctoringLog.thoatManHinh++;
                        proctoringLog.suKien.push({ loai: 'chuyen_tab', thoiGian: new Date().toISOString() });
                        updateProctoringUI();
                    }
                });

                // Track Copying
                document.addEventListener('copy', () => {
                    if (isSubmitted) return;
                    proctoringLog.saoChep++;
                    proctoringLog.suKien.push({ loai: 'sao_chep', thoiGian: new Date().toISOString() });
                    updateProctoringUI();
                });

                // Track Pasting
                document.addEventListener('paste', () => {
                    if (isSubmitted) return;
                    proctoringLog.dan++;
                    proctoringLog.suKien.push({ loai: 'dan', thoiGian: new Date().toISOString() });
                    updateProctoringUI();
                });
            });
            
            submitBtn.addEventListener('click', handleSubmit);
            retryBtn.addEventListener('click', () => {
                shuffleQuiz();
                startNewAttempt();
            });
        </script>
    </body>
    </html>
    