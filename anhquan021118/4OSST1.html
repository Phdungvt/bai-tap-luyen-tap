
    <!DOCTYPE html>
    <html lang="vi">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Bài Tập Luyện Tập</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
        <script>
            window.MathJax = {
                tex: {
                    packages: {'[+]': ['ams']},
                    inlineMath: [['$', '$'], ['\\(', '\\)']],
                    displayMath: [['$$', '$$'], ['\\[', '\\]']]
                },
                chtml: {
                    fontCache: 'global',
                    linebreaks: {
                        automatic: true
                    }
                }
            };
        </script>
        <script type="text/javascript" id="MathJax-script" async
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
        </script>
        <style>
            body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #f0f4f8; }
            .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
            @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
            .question-card {
                background-color: white;
                border-radius: 1rem;
                padding: 1.5rem 2rem;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                border-left: 5px solid transparent;
                transition: all 0.3s ease;
            }
            .ai-explanation {
                background-color: #f0f9ff;
                color: #0c4a6e;
                padding: 1rem;
                border-radius: 0.75rem;
                font-size: 0.9rem;
                margin-top: 1rem;
                border-left: 4px solid #38bdf8;
            }
            .feedback-icon { width: 1.5rem; height: 1.5rem; }
            .option-label {
                transition: all 0.2s ease-in-out;
                border: 2px solid #e5e7eb;
            }
            .option-label:hover {
                border-color: #6366f1;
                background-color: #eef2ff;
            }
            .option-label.correct {
                border-color: #10b981 !important;
                background-color: #ecfdf5 !important;
                color: #065f46;
            }
            .option-label.incorrect {
                border-color: #ef4444 !important;
                background-color: #fef2f2 !important;
                color: #991b1b;
            }
            .statement-item.correct { background-color: #ecfdf5; border-color: #10b981; }
            .statement-item.incorrect { background-color: #fef2f2; border-color: #ef4444; }
            .tts-btn { transition: all 0.2s ease; }
            .tts-btn:hover { background-color: #e0e7ff; }
            .tts-btn.playing { color: #4f46e5; }
            .prose { max-width: 100%; }
            .prose h1, .prose h2, .prose h3 { font-weight: 600; }
            .prose p { margin-top: 0.5em; margin-bottom: 0.5em; }
            .prose ul, .prose ol { margin-top: 1em; margin-bottom: 1em; padding-left: 1.5em; }
            .prose li > p { margin-top: 0; margin-bottom: 0; }
            .prose code { background-color: #e5e7eb; padding: 0.2em 0.4em; margin: 0; font-size: 85%; border-radius: 3px; }
            .prose pre { background-color: #e5e7eb; padding: 1em; border-radius: 0.5em; overflow-x: auto; }
            .prose pre code { background-color: transparent; padding: 0; }
            details[open] > summary .details-arrow {
                transform: rotate(180deg);
            }
        </style>
    </head>
    <body class="bg-slate-100 text-slate-800">
        <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md transform transition-all" style="animation: fadeIn 0.3s ease-out;">
                <h2 class="text-2xl font-bold mb-2 text-center text-slate-800">Thông Tin Học Sinh</h2>
                <p class="text-center text-slate-500 mb-6">Vui lòng nhập để bắt đầu làm bài.</p>
                <form id="student-info-form">
                    <div class="mb-4">
                        <label for="student-name" class="block text-sm font-medium text-slate-700 mb-1">Họ và tên</label>
                        <input type="text" id="student-name" required class="mt-1 block w-full block border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="student-class" class="block text-sm font-medium text-slate-700 mb-1">Lớp</label>
                        <input type="text" id="student-class" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="exam-code" class="block text-sm font-medium text-slate-700 mb-1">Mã đề</label>
                        <input type="text" id="exam-code" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Nhập mã đề giáo viên cung cấp">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Giáo viên:</label>
                        <p class="mt-1 text-slate-800 bg-slate-100 p-2.5 rounded-lg">Lê Văn Đông</p>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">Bắt đầu làm bài</button>
                </form>
            </div>
        </div>
        <div class="container mx-auto p-4 md:p-8 max-w-4xl">
            <header class="mb-10 p-8 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg">
                <div class="flex justify-between items-center flex-wrap gap-4">
                    <div>
                        <h1 class="text-4xl font-bold">Bài Tập Luyện Tập</h1>
                        <p class="text-lg text-blue-100 mt-2">Hãy hoàn thành các câu hỏi dưới đây một cách tốt nhất!</p>
                        <p class="text-sm text-blue-200 mt-4">Tác giả: Lê Văn Đông</p>
                    </div>
                    <div id="timer-container" class="text-right">
                         <div id="timer-display" class="text-3xl font-bold tracking-wider bg-white/20 px-4 py-2 rounded-lg">--:--</div>
                         <div id="retries-display" class="text-sm mt-1 text-blue-200"></div>
                    </div>
                </div>
            </header>
            <main id="student-quiz-container" class="space-y-8 hidden">
                <!-- Questions will be rendered here by JS -->
            </main>
            <footer class="mt-10 text-center">
                <button id="submit-quiz-btn" class="bg-indigo-600 text-white py-3 px-12 rounded-full font-bold text-lg hover:bg-indigo-700 transition-all duration-300 shadow-lg hover:shadow-xl hidden transform hover:scale-105">Nộp Bài</button>
                <div id="result-container" class="mt-6 hidden"></div>
                <div id="ai-feedback-container" class="mt-8 text-left hidden"></div>
                <div id="post-submit-options" class="hidden mt-6 flex flex-col sm:flex-row items-center justify-center gap-4">
                    <button id="retry-quiz-btn" class="w-full sm:w-auto bg-slate-600 text-white py-2.5 px-6 rounded-lg font-semibold hover:bg-slate-700 transition-transform transform hover:scale-105">Làm Lại Đề Này</button>
                </div>
            </footer>
        </div>

        <div id="proctoring-widget" class="fixed bottom-4 right-4 bg-yellow-100 text-yellow-800 p-3 rounded-lg shadow-lg text-sm z-50 hidden border border-yellow-300" style="max-width: 200px;">
            <h4 class="font-bold mb-2 border-b border-yellow-300 pb-1 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 3.001-1.742 3.001H4.42c-1.53 0-2.493-1.667-1.743-3.001l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                Giám sát
            </h4>
            <p>Thoát màn hình: <span id="tab-switch-count" class="font-bold">0</span></p>
            <p>Sao chép: <span id="copy-count" class="font-bold">0</span></p>
            <p>Dán: <span id="paste-count" class="font-bold">0</span></p>
        </div>

        <script type="module">
            import { GoogleGenAI, Type } from "https://esm.sh/@google/genai@^1.13.0";
            let quizData = [{"type":"multiple-choice","question":"Trí tuệ nhân tạo (AI) được định nghĩa sơ lược là gì?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["Khả năng của máy móc để thực hiện các công việc lặp đi lặp lại một cách nhanh chóng.","Khả năng của máy móc để mô phỏng và tự động hóa các quá trình tư duy, học hỏi và giải quyết vấn đề của con người.","Khả năng của máy móc để lưu trữ một lượng lớn dữ liệu và truy xuất chúng khi cần thiết.","Khả năng của máy móc để kết nối internet và trao đổi thông tin với các thiết bị khác."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Đặc trưng cơ bản nào sau đây thể hiện khả năng của Trí tuệ nhân tạo (AI) trong việc tiếp thu kiến thức và kỹ năng từ dữ liệu hoặc kinh nghiệm?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["Khả năng lưu trữ thông tin không giới hạn.","Khả năng tính toán số học phức tạp với tốc độ cao.","Khả năng học (Machine Learning).","Khả năng hiển thị đồ họa 3D chân thực."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Ứng dụng tiêu biểu nào của Trí tuệ nhân tạo (AI) giúp người dùng tương tác với thiết bị thông qua giọng nói để thực hiện các tác vụ như đặt lịch hẹn, gọi điện thoại hoặc tìm kiếm thông tin?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["Hệ điều hành máy tính cá nhân.","Phần mềm xử lí văn bản (Word processor).","Trợ lí ảo (Virtual Assistant) như Siri, Google Assistant, Alexa.","Trình duyệt web (Web browser)."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Lĩnh vực nào sau đây đã phát triển mạnh mẽ nhờ vào ứng dụng của Trí tuệ nhân tạo (AI), đặc biệt trong việc hỗ trợ chẩn đoán bệnh, phát triển thuốc và quản lí hồ sơ bệnh án?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["Nông nghiệp truyền thống.","Thủ công mỹ nghệ.","Y học.","Văn học cổ điển."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Sự phát triển mạnh mẽ của Trí tuệ nhân tạo (AI) có thể gây ra cảnh báo nào sau đây đối với xã hội, đặc biệt trong thị trường lao động?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["Giảm chi phí sản xuất hàng hóa.","Tăng năng suất lao động tổng thể.","Áp lực thất nghiệp do tự động hóa và thay thế lao động con người.","Cải thiện chất lượng dịch vụ khách hàng."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Lĩnh vực nào sau đây được xem là phát triển mạnh mẽ nhờ ứng dụng của Trí tuệ nhân tạo (AI) trong chẩn đoán và điều trị bệnh?","questionImage":null,"explanation":"Dưới đây là lời giải chi tiết, từng bước một, cho câu hỏi: \"Lĩnh vực nào sau đây được xem là phát triển mạnh mẽ nhờ ứng dụng của Trí tuệ nhân tạo (AI) trong chẩn đoán và điều trị bệnh?\"\n\n**Đáp án đúng: A. Y học**\n\n**Giải thích chi tiết:**\n\n1.  **Phân tích câu hỏi:** Câu hỏi tập trung vào ứng dụng của Trí tuệ nhân tạo (AI) trong hai khía cạnh cụ thể: \"chẩn đoán và điều trị bệnh\". Nhiệm vụ là xác định lĩnh vực nào hưởng lợi nhiều nhất từ các ứng dụng này.\n\n2.  **Xác định lĩnh vực liên quan trực tiếp:**\n    *   \"Chẩn đoán bệnh\" và \"điều trị bệnh\" là những hoạt động cốt lõi và độc quyền của ngành Y học.\n    *   Trí tuệ nhân tạo là một công nghệ đa ngành, nhưng khi được áp dụng vào chẩn đoán và điều trị, nó trực tiếp phục vụ mục đích của Y học.\n\n3.  **Vai trò của AI trong chẩn đoán bệnh:**\n    *   **Phân tích hình ảnh y tế:** AI có thể được huấn luyện để phân tích các loại hình ảnh y tế như X-quang, MRI, CT scan, siêu âm với độ chính xác cao, giúp phát hiện sớm các dấu hiệu của bệnh (ví dụ: khối u, tổn thương nhỏ, bất thường về cấu trúc). Các thuật toán học sâu (deep learning), đặc biệt là mạng nơ-ron tích chập (Convolutional Neural Networks - CNN), đã chứng tỏ hiệu quả vượt trội trong việc này.\n    *   **Phân tích dữ liệu lâm sàng:** AI có thể xử lý lượng lớn dữ liệu bệnh án điện tử, kết quả xét nghiệm, thông tin di truyền để nhận diện các mô hình, dự đoán nguy cơ mắc bệnh hoặc xác định các chẩn đoán tiềm ẩn mà con người có thể bỏ sót.\n    *   **Chẩn đoán sớm và chính xác:** Bằng cách tự động hóa và tăng cường khả năng phân tích, AI giúp giảm thiểu sai sót, tăng tốc độ chẩn đoán và cho phép phát hiện bệnh ở giai đoạn sớm hơn, khi việc điều trị thường hiệu quả hơn.\n\n4.  **Vai trò của AI trong điều trị bệnh:**\n    *   **Y học cá nhân hóa:** AI có khả năng phân tích dữ liệu di truyền của bệnh nhân, lịch sử bệnh án, phản ứng với thuốc trong quá khứ để đề xuất phác đồ điều trị tối ưu và cá nhân hóa cho từng người bệnh. Điều này giúp tăng hiệu quả điều trị và giảm tác dụng phụ không mong muốn.\n    *   **Phát triển và khám phá thuốc mới:** AI được sử dụng để sàng lọc hàng tỷ hợp chất hóa học, dự đoán khả năng liên kết với mục tiêu protein của bệnh, từ đó rút ngắn đáng kể thời gian và chi phí cho quá trình phát triển thuốc. Nó có thể dự đoán độc tính và hiệu quả của các phân tử thuốc tiềm năng.\n    *   **Hỗ trợ phẫu thuật robot:** Các hệ thống robot được điều khiển bởi AI có thể hỗ trợ các bác sĩ phẫu thuật thực hiện các ca mổ phức tạp với độ chính xác và ổn định cao hơn, giảm xâm lấn và thời gian hồi phục cho bệnh nhân.\n    *   **Theo dõi và quản lý bệnh:** AI có thể phân tích dữ liệu từ các thiết bị đeo tay thông minh hoặc thiết bị y tế tại nhà để theo dõi sức khỏe bệnh nhân, cảnh báo sớm các biến chứng hoặc điều chỉnh kế hoạch điều trị từ xa.\n\n5.  **Kết luận:**\n    Các ứng dụng của AI trong chẩn đoán và điều trị bệnh đã và đang cách mạng hóa ngành Y học, mang lại những tiến bộ vượt bậc về độ chính xác, hiệu quả và khả năng cá nhân hóa. Do đó, Y học là lĩnh vực được xem là phát triển mạnh mẽ nhất nhờ ứng dụng này.","mappedType":"multiple-choice","options":["Y học","Nông nghiệp","Khai thác khoáng sản","Du lịch"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Công nghệ Trí tuệ nhân tạo (AI) có thể giúp cải thiện đáng kể hiệu quả trong lĩnh vực nào thông qua việc phát triển xe tự lái và hệ thống quản lý giao thông thông minh?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["Giáo dục","Giao thông","Nghệ thuật","Thể thao"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Phát hiện gian lận và dự đoán xu hướng thị trường là những ứng dụng quan trọng của Trí tuệ nhân tạo (AI) trong lĩnh vực nào?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["Sản xuất","Giáo dục","Tài chính","Giải trí"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Một trong những cảnh báo về sự phát triển của Trí tuệ nhân tạo (AI) liên quan đến tác động của nó đối với thị trường lao động là gì?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["Tăng cường quyền riêng tư","Tạo ra nhiều việc làm mới","Áp lực thất nghiệp","Cải thiện an ninh mạng"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Nguy cơ nào sau đây là một trong những cảnh báo quan trọng về sự phát triển của Trí tuệ nhân tạo (AI), đặc biệt liên quan đến dữ liệu cá nhân của người dùng?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["Nâng cao chất lượng giáo dục","Rủi ro an ninh và quyền riêng tư","Tối ưu hóa sản xuất","Giảm chi phí vận chuyển"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Trong bối cảnh công nghệ hiện đại, khái niệm Trí tuệ nhân tạo (AI) được hiểu sơ lược là gì?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["Một nhánh của khoa học máy tính tập trung vào việc tạo ra các hệ thống có khả năng thực hiện các tác vụ đòi hỏi trí thông minh của con người.","Một loại ngôn ngữ lập trình mới dành riêng cho robot.","Hệ thống cơ sở dữ liệu lưu trữ lượng lớn thông tin mà không có khả năng xử lý.","Một công nghệ chỉ cho phép máy tính thực hiện các lệnh được lập trình sẵn mà không học hỏi."],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Đặc trưng cơ bản nào sau đây KHÔNG phải là một đặc trưng của Trí tuệ nhân tạo (AI)?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["Khả năng học hỏi từ dữ liệu và kinh nghiệm.","Khả năng suy luận và ra quyết định dựa trên thông tin có sẵn.","Khả năng tự động thay thế hoàn toàn con người trong mọi công việc mà không cần giám sát.","Khả năng nhận thức, hiểu và phản hồi lại ngôn ngữ tự nhiên của con người."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Trợ lí ảo như Siri, Google Assistant là ví dụ tiêu biểu cho ứng dụng nào của Trí tuệ nhân tạo (AI)?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["Hệ thống quản lý cơ sở dữ liệu quan hệ.","Công cụ xử lý văn bản truyền thống.","Ứng dụng dịch tự động và nhận dạng giọng nói, giúp tương tác với người dùng qua ngôn ngữ tự nhiên.","Phần mềm thiết kế đồ họa chuyên nghiệp."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Lĩnh vực nào dưới đây đã chứng kiến sự phát triển mạnh mẽ và những chuyển đổi đáng kể nhờ vào các ứng dụng của Trí tuệ nhân tạo (AI)?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["Sản xuất thủ công truyền thống.","Y học, đặc biệt trong chẩn đoán hình ảnh và phát triển thuốc.","Kế toán bằng sổ sách thủ công.","Nghề nông sử dụng phương pháp gieo trồng lạc hậu."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Sự phát triển của Trí tuệ nhân tạo (AI) đặt ra cảnh báo về một số rủi ro tiềm ẩn. Cảnh báo nào sau đây là một trong những mối quan tâm chính?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["Giảm thiểu áp lực thất nghiệp do AI tạo ra nhiều việc làm mới.","Tăng cường quyền riêng tư cho người dùng thông qua các hệ thống AI.","Rủi ro về an ninh khi các hệ thống AI có thể bị tấn công hoặc lợi dụng.","Đơn giản hóa các vấn đề phức tạp, giúp con người không cần tư duy nhiều."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Lĩnh vực nào sau đây được Trí tuệ nhân tạo (AI) hỗ trợ mạnh mẽ trong việc đưa ra các quyết định đầu tư và phát hiện gian lận?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["Y học","Giao thông vận tải","Tài chính","Giáo dục"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Trong lĩnh vực giao thông, ứng dụng nổi bật nào của Trí tuệ nhân tạo (AI) đang được nghiên cứu và phát triển để giảm thiểu tai nạn và tắc nghẽn?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["Hệ thống đèn tín hiệu tự động","Xe tự lái","Ứng dụng bản đồ số","Thiết bị giám sát hành trình"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Một trong những cảnh báo lớn về tác động tiêu cực của sự phát triển Trí tuệ nhân tạo (AI) đối với xã hội là gì?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["Giảm chi phí sản xuất","Tăng cường khả năng sáng tạo của con người","Áp lực thất nghiệp do tự động hóa","Cải thiện hiệu quả chẩn đoán y tế"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Việc thu thập và phân tích lượng lớn dữ liệu cá nhân bởi các hệ thống Trí tuệ nhân tạo (AI) đặt ra mối lo ngại chủ yếu nào?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["Giảm năng suất lao động","Rủi ro về quyền riêng tư","Thiếu nhân lực IT","Chi phí nghiên cứu quá cao"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Ứng dụng của Trí tuệ nhân tạo (AI) trong ngành sản xuất thường tập trung vào việc nào sau đây?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["Phát triển phương pháp điều trị bệnh mới","Tối ưu hóa chuỗi cung ứng và kiểm soát chất lượng","Tạo ra các tác phẩm nghệ thuật","Thiết kế trò chơi điện tử"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Một chính phủ đang xem xét việc đầu tư lớn vào phát triển và ứng dụng Trí tuệ nhân tạo (AI) trong nhiều lĩnh vực công cộng như quản lý đô thị, dịch vụ hành chính và giáo dục. Tuy nhiên, các chuyên gia đã đưa ra cảnh báo về những rủi ro tiềm ẩn của AI. Trong bối cảnh này, vấn đề nào sau đây CÓ KHẢ NĂNG NHẤT sẽ trở thành thách thức lớn về mặt xã hội khi AI được triển khai rộng rãi?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["Khả năng AI tạo ra các tác phẩm nghệ thuật không phù hợp với chuẩn mực xã hội.","AI gây áp lực thất nghiệp đáng kể do tự động hóa các công việc đòi hỏi lao động thủ công hoặc lặp lại.","AI bị giới hạn bởi tốc độ xử lý thông tin, không thể đáp ứng nhu cầu thực tế.","AI không thể tích hợp được vào các hệ thống máy tính hiện có."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Một công ty công nghệ muốn phát triển hệ thống Trí tuệ nhân tạo (AI) để tạo ra các chương trình học tập cá nhân hóa cho học sinh, giúp tối ưu hóa quá trình tiếp thu kiến thức và kỹ năng. Để hệ thống AI này thực sự hiệu quả và đáp ứng đúng mục tiêu, đặc trưng cơ bản nào của AI cần được ưu tiên phát triển và tận dụng mạnh mẽ nhất?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["Khả năng ghi nhớ và truy xuất thông tin nhanh chóng từ một cơ sở dữ liệu cố định.","Khả năng thực hiện các phép tính toán phức tạp với độ chính xác tuyệt đối.","Khả năng học hỏi liên tục từ dữ liệu học tập của từng học sinh để tự điều chỉnh và cải thiện phương pháp giảng dạy.","Khả năng trình bày thông tin theo nhiều định dạng đồ họa khác nhau."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Một chính phủ đang xây dựng chiến lược quốc gia về phát triển và ứng dụng Trí tuệ nhân tạo (AI) rộng rãi trong mọi lĩnh vực. Tuy nhiên, các chuyên gia cảnh báo rằng sự phát triển nhanh chóng của AI có thể dẫn đến những thách thức lớn. Trong các cảnh báo sau, thách thức nào được xem là cần ưu tiên giải quyết hàng đầu để đảm bảo sự phát triển bền vững và công bằng của xã hội?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["Áp lực thất nghiệp do AI thay thế lao động trong nhiều ngành nghề.","Vấn đề quyền riêng tư và bảo mật dữ liệu cá nhân khi AI thu thập và xử lý lượng lớn thông tin.","Rủi ro an ninh mạng và khả năng AI bị lạm dụng cho mục đích xấu.","Chi phí đầu tư ban đầu cao và yêu cầu về cơ sở hạ tầng công nghệ."],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Một công ty khởi nghiệp trong lĩnh vực nông nghiệp công nghệ cao đang lên kế hoạch triển khai hệ thống AI để tối ưu hóa quy trình trồng trọt, dự đoán sâu bệnh và quản lý năng suất. Để đạt được thành công bền vững, công ty cần cân nhắc những yếu tố nào dưới đây một cách toàn diện nhất?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["Chỉ tập trung vào việc thu thập dữ liệu lớn và thuật toán học sâu để tăng độ chính xác của dự đoán.","Đảm bảo nguồn vốn đầu tư dồi dào và tiếp cận các thị trường xuất khẩu mới.","Vừa khai thác tiềm năng tăng năng suất, giảm chi phí nhờ AI, vừa có chiến lược đào tạo lại nhân sự để thích ứng với công nghệ mới và bảo vệ dữ liệu sản xuất.","Ưu tiên phát triển các loại cây trồng biến đổi gen để tăng khả năng chống chịu sâu bệnh."],"optionsImage":[],"correctAnswerIndex":2},{"type":"true-false","main_question":"Đánh giá các mệnh đề sau về Trí tuệ nhân tạo (AI):","questionImage":null,"explanation":null,"mappedType":"true-false","statements":[{"statement":"Trí tuệ nhân tạo (AI) là một lĩnh vực mới nổi của công nghệ thông tin, chỉ tập trung vào việc mô phỏng hành vi của robot công nghiệp.","is_correct":false},{"statement":"Một trong những đặc trưng cơ bản của AI là khả năng suy luận logic và giải quyết vấn đề dựa trên dữ liệu đã được học.","is_correct":true},{"statement":"Các ứng dụng như nhận dạng khuôn mặt trên điện thoại thông minh hoặc hệ thống gợi ý sản phẩm của các sàn thương mại điện tử đều là những ví dụ điển hình của việc ứng dụng Trí tuệ nhân tạo vào đời sống.","is_correct":true},{"statement":"Trong lĩnh vực tài chính, AI chủ yếu được sử dụng để phân tích dữ liệu thị trường và dự đoán xu hướng, nhưng không thể đóng vai trò trong việc phát hiện gian lận hoặc tự động hóa giao dịch cổ phiếu.","is_correct":false}]},{"type":"true-false","main_question":"Phân tích các phát biểu sau về tác động và cảnh báo đối với sự phát triển của Trí tuệ nhân tạo (AI):","questionImage":null,"explanation":null,"mappedType":"true-false","statements":[{"statement":"Việc tự động hóa các quy trình sản xuất bằng AI giúp tăng hiệu suất và giảm chi phí, nhưng đồng thời cũng tạo ra áp lực về việc làm cho những người lao động thủ công.","is_correct":true},{"statement":"Một trong những rủi ro chính của việc ứng dụng AI là vấn đề quyền riêng tư khi dữ liệu cá nhân được thu thập và xử lý với quy mô lớn.","is_correct":true},{"statement":"Các hệ thống AI tiên tiến hoàn toàn miễn nhiễm với các cuộc tấn công mạng và rủi ro an ninh, bởi vì chúng có khả năng tự vá lỗi và tự bảo vệ.","is_correct":false},{"statement":"Để giảm thiểu các tác động tiêu cực của AI đến xã hội, các chính phủ chỉ cần tập trung vào việc ban hành luật cấm AI trong một số lĩnh vực nhạy cảm mà không cần đầu tư vào đào tạo lại nguồn nhân lực.","is_correct":false}]},{"type":"true-false","main_question":"Đánh giá tính đúng/sai của các phát biểu sau về ứng dụng của Trí tuệ nhân tạo (AI) trong khoa học và đời sống:","questionImage":null,"explanation":null,"mappedType":"true-false","statements":[{"statement":"Trí tuệ nhân tạo (AI) có khả năng tự động hóa các tác vụ lặp đi lặp lại và phân tích dữ liệu lớn một cách hiệu quả.","is_correct":true},{"statement":"Trong lĩnh vực y học, ứng dụng chính của AI chỉ giới hạn trong việc hỗ trợ các ca phẫu thuật phức tạp.","is_correct":false},{"statement":"Hệ thống giao thông thông minh ứng dụng AI chỉ có thể tối ưu hóa lộ trình cho phương tiện công cộng mà không thể áp dụng cho việc điều phối xe cá nhân.","is_correct":false},{"statement":"Việc sử dụng AI trong tài chính chắc chắn sẽ loại bỏ hoàn toàn rủi ro đầu tư do AI có khả năng dự đoán thị trường một cách tuyệt đối chính xác.","is_correct":false}]},{"type":"true-false","main_question":"Đánh giá tính đúng/sai của các phát biểu sau về những cảnh báo và rủi ro liên quan đến sự phát triển của Trí tuệ nhân tạo (AI):","questionImage":null,"explanation":null,"mappedType":"true-false","statements":[{"statement":"Một trong những cảnh báo quan trọng về AI là khả năng tạo ra áp lực thất nghiệp trong một số ngành nghề do tự động hóa.","is_correct":true},{"statement":"Rủi ro về an ninh khi phát triển AI chỉ tập trung vào việc dữ liệu cá nhân bị đánh cắp và không bao gồm các mối đe dọa khác như AI được sử dụng cho mục đích xấu.","is_correct":false},{"statement":"Quyền riêng tư của người dùng luôn được đảm bảo tuyệt đối khi AI thu thập và xử lí dữ liệu cá nhân, miễn là các tổ chức tuân thủ đúng luật pháp hiện hành.","is_correct":false},{"statement":"Sự tiến bộ vượt bậc của AI chắc chắn sẽ dẫn đến việc loại bỏ hoàn toàn vai trò của giáo viên trong tương lai gần, vì AI có thể hoàn toàn thay thế con người trong việc truyền đạt kiến thức và cá nhân hóa việc học.","is_correct":false}]},{"type":"true-false","main_question":"Xét về bản chất và ứng dụng của Trí tuệ nhân tạo (AI), hãy xác định tính đúng sai của các nhận định dưới đây:","questionImage":null,"explanation":null,"mappedType":"true-false","statements":[{"statement":"Trí tuệ nhân tạo ($AI$) là lĩnh vực khoa học máy tính tập trung vào việc tạo ra các hệ thống có khả năng mô phỏng trí tuệ con người.","is_correct":true},{"statement":"Một trong những đặc trưng cơ bản của $AI$ là khả năng học hỏi từ dữ liệu và cải thiện hiệu suất theo thời gian.","is_correct":true},{"statement":"Ứng dụng $AI$ trong lĩnh vực y học chỉ giới hạn ở việc quản lý hồ sơ bệnh án, không thể hỗ trợ chẩn đoán hay phẫu thuật.","is_correct":false},{"statement":"Sự phát triển mạnh mẽ của các hệ thống $AI$ tiên tiến luôn đảm bảo quyền riêng tư và an ninh dữ liệu người dùng một cách tuyệt đối, loại bỏ mọi rủi ro tiềm tàng về lạm dụng thông tin.","is_correct":false}]},{"type":"true-false","main_question":"Trong thời đại công nghệ số bùng nổ, Trí tuệ nhân tạo ($AI$) đã và đang len lỏi vào mọi ngóc ngách của đời sống, từ những thiết bị cá nhân cho đến các ngành công nghiệp cốt lõi. Sự phát triển này đặt ra nhiều câu hỏi về đặc điểm thực sự và tầm ảnh hưởng sâu rộng của $AI$. Dựa trên hiểu biết của bạn về Trí tuệ nhân tạo, hãy đánh giá tính đúng sai của các nhận định sau đây:","questionImage":null,"explanation":null,"mappedType":"true-false","statements":[{"statement":"Trợ lí ảo như Siri hay Google Assistant là một ví dụ tiêu biểu của ứng dụng Trí tuệ nhân tạo trong cuộc sống hàng ngày.","is_correct":true},{"statement":"Trí tuệ nhân tạo có thể hiểu ngôn ngữ tự nhiên và giải quyết vấn đề, nhưng không có khả năng suy luận logic như con người.","is_correct":false},{"statement":"Việc ứng dụng $AI$ trong sản xuất ô tô tự lái chủ yếu nằm ở khâu lắp ráp robot, không liên quan đến việc xử lý dữ liệu cảm biến và ra quyết định trong môi trường thực.","is_correct":false},{"statement":"Mặc dù $AI$ mang lại nhiều lợi ích, nhưng áp lực về thất nghiệp do tự động hóa và các vấn đề liên quan đến quyền sở hữu trí tuệ đối với các tác phẩm do $AI$ tạo ra là những thách thức nghiêm trọng mà xã hội cần đối mặt.","is_correct":true}]},{"type":"true-false","main_question":"An là một người trẻ tuổi luôn cập nhật các công nghệ mới. Một ngày nọ, khi đang sử dụng trợ lý ảo để điều khiển nhà thông minh và di chuyển trên đường phố đông đúc với các hệ thống đèn tín hiệu tự động, An bắt đầu suy nghĩ về vai trò ngày càng tăng của Trí tuệ nhân tạo (AI) trong đời sống và các ngành khoa học. Để hiểu rõ hơn về AI, An đã tập hợp một số nhận định dưới đây. Bạn hãy giúp An đánh giá tính đúng/sai của các phát biểu này:","questionImage":null,"explanation":null,"mappedType":"true-false","statements":[{"statement":"AI có khả năng nhận diện hình ảnh và giọng nói, giúp tự động hóa nhiều tác vụ hàng ngày.","is_correct":true},{"statement":"Trong lĩnh vực y học, AI chủ yếu hỗ trợ bác sĩ trong việc chẩn đoán bệnh thông qua phân tích hình ảnh X-quang, MRI một cách nhanh chóng và chính xác, nhưng không thể hỗ trợ trong quá trình phẫu thuật.","is_correct":false},{"statement":"Việc ứng dụng AI vào hệ thống giao thông thông minh giúp tối ưu hóa luồng xe và điều tiết đèn tín hiệu hiệu quả hơn, tuy nhiên không có khả năng dự đoán các điểm tắc nghẽn tiềm năng dựa trên dữ liệu lịch sử và thời gian thực.","is_correct":false},{"statement":"Mặc dù AI đã cải thiện đáng kể hiệu quả sản xuất trong các nhà máy, nhưng việc ứng dụng robot AI vào dây chuyền sản xuất luôn đòi hỏi một sự đầu tư ban đầu thấp và không cần bất kỳ sự điều chỉnh nào đối với quy trình hoạt động hiện có.","is_correct":false}]},{"type":"true-false","main_question":"Trong bối cảnh Trí tuệ nhân tạo (AI) đang ngày càng trở nên phổ biến và được ứng dụng rộng rãi từ đời sống cá nhân đến các hệ thống trọng yếu, kéo theo nhiều cuộc tranh luận về những cảnh báo và thách thức đi kèm. Hãy đánh giá tính đúng/sai của các nhận định dưới đây về vấn đề này:","questionImage":null,"explanation":null,"mappedType":"true-false","statements":[{"statement":"Một trong những lo ngại khi AI phát triển mạnh mẽ là vấn đề về quyền riêng tư dữ liệu cá nhân, đặc biệt khi các hệ thống AI thu thập và xử lý một lượng lớn thông tin người dùng.","is_correct":true},{"statement":"Sự phát triển của AI có thể tạo ra áp lực lớn về việc thay đổi cơ cấu việc làm, đòi hỏi người lao động phải liên tục học hỏi và thích nghi với các kỹ năng mới để duy trì năng lực cạnh tranh trong thị trường lao động.","is_correct":true},{"statement":"Để giảm thiểu rủi ro an ninh mạng khi ứng dụng AI vào các hệ thống trọng yếu như hạ tầng quốc gia, việc mã hóa dữ liệu đầu vào và đầu ra là đủ để đảm bảo an toàn tuyệt đối và không cần thêm các biện pháp kiểm soát truy cập hay giám sát liên tục.","is_correct":false},{"statement":"Mặc dù AI có khả năng xử lý lượng lớn dữ liệu để đưa ra dự đoán và hỗ trợ ra quyết định, nhưng khả năng tự chủ của nó trong việc xác định các mối đe dọa an ninh mạng và phản ứng lại mà không cần sự can thiệp của con người là một khả năng hiện hữu và hoàn toàn đáng tin cậy trong các hệ thống phòng thủ tiên tiến nhất.","is_correct":false}]}];
            const quizOptions = {"timeLimit":45,"retriesAllowed":1,"showAnswers":true,"showExplanation":true,"aiAssessment":true,"scoring":{"mc":7,"tf":3,"sa":0,"essay":0,"tfMethod":"progressive"}};
            const googleScriptUrl = "https://script.google.com/macros/s/AKfycbzAhhPPCUgw-uU55gOj87Tm16ugz8FuBlRwQ7sECOBiOWBC8n6SI2mt_mQblXdoCdje/exec";
            const correctExamCode = "4OSST1";
            const teacherApiKey = "AIzaSyDzpJyodrQYlL0_OmSq4k3snugEgphM6IE";
            let studentInfo = {};
            let isSubmitted = false;
            let timerInterval;
            let retriesLeft = quizOptions.retriesAllowed;
            let currentAudio = null; // To manage audio playback
            let studentApiKey = "";
            let ai = null;

            let proctoringLog = {
                thoatManHinh: 0,
                saoChep: 0,
                dan: 0,
                suKien: []
            };

            const studentQuizContainer = document.getElementById('student-quiz-container');
            const submitBtn = document.getElementById('submit-quiz-btn');
            const resultContainer = document.getElementById('result-container');
            const postSubmitOptions = document.getElementById('post-submit-options');
            const retryBtn = document.getElementById('retry-quiz-btn');
            const loginModal = document.getElementById('login-modal');
            const studentInfoForm = document.getElementById('student-info-form');
            const timerDisplay = document.getElementById('timer-display');
            const retriesDisplay = document.getElementById('retries-display');
            function shuffleQuiz() {
                // Shuffle options/statements within each question first
                quizData.forEach(item => {
                    // Shuffle multiple-choice options and their corresponding images
                    if (item.mappedType === 'multiple-choice' && item.options && item.options.length > 0) {
                        const correctAnswerText = item.options[item.correctAnswerIndex];
                        let optionsWithImages = item.options.map((opt, index) => ({
                            text: opt,
                            image: (item.optionsImage && item.optionsImage[index]) ? item.optionsImage[index] : null
                        }));
                        // Fisher-Yates shuffle
                        for (let i = optionsWithImages.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [optionsWithImages[i], optionsWithImages[j]] = [optionsWithImages[j], optionsWithImages[i]];
                        }
                        // Update the item with shuffled data
                        item.options = optionsWithImages.map(opt => opt.text);
                        item.optionsImage = optionsWithImages.map(opt => opt.image);
                        item.correctAnswerIndex = item.options.indexOf(correctAnswerText);
                    }
                    // Shuffle true-false statements
                    if (item.mappedType === 'true-false' && item.statements && item.statements.length > 0) {
                         for (let i = item.statements.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [item.statements[i], item.statements[j]] = [item.statements[j], item.statements[i]];
                        }
                    }
                });
                // Then, group questions by type and shuffle within each group
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});
                let shuffledQuizData = [];
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    if (grouped[partType]) {
                        const partQuestions = grouped[partType];
                        for (let i = partQuestions.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [partQuestions[i], partQuestions[j]] = [partQuestions[j], partQuestions[i]];
                        }
                        shuffledQuizData = shuffledQuizData.concat(partQuestions);
                    }
                });
               
                quizData = shuffledQuizData;
            }
            // --- Timer Function ---
            function startTimer(duration, display) {
                let timer = duration, minutes, seconds;
                clearInterval(timerInterval); // Clear any existing timer
                if(duration <= 0) {
                     display.textContent = "∞";
                     return;
                }
                timerInterval = setInterval(function () {
                    minutes = parseInt(timer / 60, 10);
                    seconds = parseInt(timer % 60, 10);
                    minutes = minutes < 10 ? "0" + minutes : minutes;
                    seconds = seconds < 10 ? "0" + seconds : seconds;
                    display.textContent = minutes + ":" + seconds;
                    if (--timer < 0) {
                        clearInterval(timerInterval);
                        alert("Hết giờ làm bài!");
                        handleSubmit();
                    }
                }, 1000);
            }
            // --- Gemini API Caller (for TTS) ---
            async function callGeminiAPI(payload, model = 'gemini-2.5-flash-preview-tts') {
                 if (!studentApiKey) {
                    alert("API Key không hợp lệ. Không thể thực hiện yêu cầu.");
                    return null;
                }
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${studentApiKey}`;
               
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`API Error: ${errorBody.error?.message || response.status}`);
                    }
                    const result = await response.json();
                    const candidate = result.candidates && result.candidates[0];
                    if (candidate && candidate.content && candidate.content.parts && candidate.content.parts[0]) {
                        return candidate.content.parts[0]; // Return the whole part
                    } else {
                         if (result.promptFeedback && result.promptFeedback.blockReason) {
                               throw new Error(`API call blocked: ${result.promptFeedback.blockReason}`);
                         }
                        return null;
                    }
                } catch (error) {
                    console.error("Lỗi khi gọi Gemini API:", error);
                    return null;
                }
            }
           
            // --- TTS Feature Functions ---
            function base64ToArrayBuffer(base64) {
                const binaryString = window.atob(base64);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return bytes.buffer;
            }
            function pcmToWav(pcmData, sampleRate) {
                const numChannels = 1;
                const bytesPerSample = 2; // 16-bit
                const blockAlign = numChannels * bytesPerSample;
                const byteRate = sampleRate * blockAlign;
                const dataSize = pcmData.byteLength;
                const buffer = new ArrayBuffer(44 + dataSize);
                const view = new DataView(buffer);
                /* RIFF identifier */
                writeString(view, 0, 'RIFF');
                /* file length */
                view.setUint32(4, 36 + dataSize, true);
                /* RIFF type */
                writeString(view, 8, 'WAVE');
                /* format chunk identifier */
                writeString(view, 12, 'fmt ');
                /* format chunk length */
                view.setUint32(16, 16, true);
                /* sample format (raw) */
                view.setUint16(20, 1, true);
                /* channel count */
                view.setUint16(22, numChannels, true);
                /* sample rate */
                view.setUint32(24, sampleRate, true);
                /* byte rate (sample rate * block align) */
                view.setUint32(28, byteRate, true);
                /* block align (channel count * bytes per sample) */
                view.setUint16(32, blockAlign, true);
                /* bits per sample */
                view.setUint16(34, 16, true);
                /* data chunk identifier */
                writeString(view, 36, 'data');
                /* data chunk length */
                view.setUint32(40, dataSize, true);
                // Write PCM data
                const pcm16 = new Int16Array(pcmData);
                for (let i = 0; i < pcm16.length; i++) {
                    view.setInt16(44 + i * 2, pcm16[i], true);
                }
                function writeString(view, offset, string) {
                    for (let i = 0; i < string.length; i++) {
                        view.setUint8(offset + i, string.charCodeAt(i));
                    }
                }
                return new Blob([view], { type: 'audio/wav' });
            }
            async function playTTS(text, button) {
                if (currentAudio && !currentAudio.paused) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                    document.querySelectorAll('.tts-btn.playing').forEach(b => b.classList.remove('playing'));
                    if (currentAudio.src.startsWith('blob:')) {
                        URL.revokeObjectURL(currentAudio.src);
                    }
                    if (currentAudio.dataset.text === text) {
                        currentAudio = null;
                        return; // Stop if the same button is clicked again
                    }
                }
                button.classList.add('playing');
                const originalIcon = button.innerHTML; // A bit tricky, but let's try
                button.innerHTML = '<div class="small-loader"></div>';
                button.disabled = true;
                try {
                    const payload = {
                        contents: [{ parts: [{ text: `Nói một cách rõ ràng, tự nhiên: ${text}` }] }],
                        generationConfig: { responseModalities: ["AUDIO"] },
                    };
                    const resultPart = await callGeminiAPI(payload, 'gemini-2.5-flash-preview-tts');
                    if (resultPart && resultPart.inlineData) {
                        const audioData = resultPart.inlineData.data;
                        const mimeType = resultPart.inlineData.mimeType;
                        const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                        const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;
                        const pcmData = base64ToArrayBuffer(audioData);
                        const wavBlob = pcmToWav(pcmData, sampleRate);
                        const audioUrl = URL.createObjectURL(wavBlob);
                        currentAudio = new Audio(audioUrl);
                        currentAudio.dataset.text = text;
                        currentAudio.play();
                        currentAudio.onended = () => {
                            button.classList.remove('playing');
                            URL.revokeObjectURL(audioUrl);
                            currentAudio = null;
                        };
                    } else {
                        throw new Error("Không nhận được dữ liệu âm thanh.");
                    }
                } catch (error) {
                    console.error("Lỗi TTS:", error);
                    alert("Không thể phát âm thanh. Vui lòng thử lại.");
                     button.classList.remove('playing');
                } finally {
                    button.innerHTML = originalIcon;
                    button.disabled = false;
                }
            }
            function getTextForTTS(item) {
                let text = item.question || item.main_question || '';
                text = text.replace(/\$/g, ''); // Remove LaTeX delimiters for cleaner speech
                if (item.mappedType === 'multiple-choice' && item.options) {
                    const optionsText = item.options.map((opt, i) => `${String.fromCharCode(65 + i)}. ${opt}`).join(' ');
                    text += ' ' + optionsText.replace(/\$/g, '');
                } else if (item.mappedType === 'true-false' && item.statements) {
                    const statementsText = item.statements.map((s, i) => `${String.fromCharCode(97 + i)}. ${s.statement}`).join(' ');
                    text += ' ' + statementsText.replace(/\$/g, '');
                }
                return text;
            }
            function renderStudentQuiz() {
                studentQuizContainer.innerHTML = '';
               
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});
                const groupInfo = {
                    'multiple-choice': { title: 'PHẦN I. TRẮC NGHIỆM KHÁCH QUAN', subtitle: 'Chọn đáp án đúng nhất trong các lựa chọn sau.' },
                    'true-false': { title: 'PHẦN II. CÂU HỎI ĐÚNG - SAI', subtitle: 'Xác định tính đúng hoặc sai cho mỗi mệnh đề dưới đây.' },
                    'short-answer': { title: 'PHẦN III. CÂU HỎI TRẢ LỜI NGẮN', subtitle: 'Điền đáp án ngắn gọn vào phần trả lời.' },
                    'essay': { title: 'PHẦN IV. CÂU HỎI TỰ LUẬN', subtitle: 'Trình bày chi tiết bài giải của bạn.' }
                };
               
                let questionCounter = 0;
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    const questions = grouped[partType];
                    if (!questions || questions.length === 0) return;
                   
                    let groupHTML = `<div class="group-container space-y-8 mb-12">`;
                    const info = groupInfo[partType];
                    groupHTML += `
                        <div class="group-header pb-3 border-b-2 border-slate-300 mb-6">
                            <h2 class="text-2xl font-bold text-slate-800">${info.title}</h2>
                            ${info.subtitle ? `<p class="text-md text-slate-600 italic mt-1">${info.subtitle}</p>` : ''}
                        </div>
                    `;
                    questions.forEach((item, localIndex) => {
                        const globalIndex = quizData.indexOf(item);
                        questionCounter++;
                        groupHTML += `<div class="question-card" id="student-q-${globalIndex}">`;
                        let questionText = (item.question || item.main_question || '').replace(/\n/g, '<br>');
                       
                        const textToSpeak = getTextForTTS(item);
                       
                        groupHTML += `<div class="flex items-start">
                                     <div class="flex-grow">
                                         <div class="flex items-center mb-2">
                                             <span class="font-bold text-lg mr-3 text-indigo-600">Câu ${questionCounter}:</span>
                                             <div id="q-${globalIndex}-feedback-icon"></div>
                                         </div>
                                         <div class="question-content mt-2 text-lg text-slate-700">${questionText}</div>
                                         ${item.questionImage ? `<img src="${item.questionImage}" class="mt-4 rounded-lg max-w-full md:max-w-md border shadow-sm">` : ''}
                                     </div>
                                     <button class="tts-btn ml-4 p-2 rounded-full text-gray-500 hover:text-indigo-600" data-text-to-speak="${textToSpeak.replace(/"/g, '&quot;')}">
                                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                             <path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.858 5.858a3 3 0 014.243 0L12 7.757l1.9-1.9a3 3 0 014.242 0 3 3 0 010 4.242L12 16.242l-6.042-6.042a3 3 0 010-4.242z" />
                                         </svg>
                                     </button>
                                 </div>`;
                       
                        groupHTML += `<div class="mt-6">`;
                        switch(item.mappedType) {
                            case 'multiple-choice':
                                groupHTML += `<div class="options-grid grid grid-cols-1 md:grid-cols-2 gap-4">`;
                                item.options.forEach((opt, i) => {
                                    groupHTML += `<label for="q${globalIndex}-opt${i}" id="q${globalIndex}-opt-label${i}" class="option-label flex items-start p-4 border-2 rounded-xl cursor-pointer hover:bg-indigo-50 hover:border-indigo-400">
                                                     <input type="radio" name="q${globalIndex}" id="q${globalIndex}-opt${i}" value="${i}" class="flex-shrink-0 mt-1 h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                                     <div class="ml-3 flex-grow">
                                                         <span class="font-semibold text-slate-800">${String.fromCharCode(65 + i)}.</span>
                                                         <span class="option-content text-slate-700">${opt || ''}</span>
                                                         ${(item.optionsImage && item.optionsImage[i]) ? `<img src="${item.optionsImage[i]}" class="mt-2 rounded-lg max-w-xs border shadow-sm">` : ''}
                                                     </div>
                                                 </label>`;
                                });
                                groupHTML += `</div>`;
                                break;
                            case 'true-false':
                                 groupHTML += `<div class="space-y-4">`;
                                 item.statements.forEach((s, i) => {
                                     groupHTML += `<div class="statement-item border-t pt-4">
                                                  <p class="mb-3 text-slate-700">${String.fromCharCode(97 + i)}) ${s.statement || ''}</p>
                                                  <div class="flex gap-x-6">
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="true" class="mr-2 h-4 w-4"> Đúng</label>
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="false" class="mr-2 h-4 w-4"> Sai</label>
                                                  </div>
                                              </div>`;
                                 });
                                 groupHTML += `</div>`;
                                 break;
                            case 'short-answer':
                                groupHTML += `<input type="text" name="q${globalIndex}" class="mt-1 block w-full md:w-1/2 border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Nhập đáp án của bạn...">`;
                                break;
                            case 'essay':
                                groupHTML += `<textarea name="q${globalIndex}" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" rows="5" placeholder="Nhập câu trả lời tự luận của bạn..."></textarea>`;
                                break;
                        }
                        groupHTML += `</div><div id="q-${globalIndex}-feedback" class="mt-4"></div></div>`;
                    });
                    groupHTML += `</div>`;
                    studentQuizContainer.innerHTML += groupHTML;
                });
               
                if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                    MathJax.typesetPromise([studentQuizContainer]);
                }
               
                document.querySelectorAll('.tts-btn').forEach(btn => {
                    btn.addEventListener('click', () => playTTS(btn.dataset.textToSpeak, btn));
                });
            }
           
            async function generatePerformanceReview(allAnswersData) {
                const feedbackContainer = document.getElementById('ai-feedback-container');
                if (!feedbackContainer || !ai) return null;
                feedbackContainer.classList.remove('hidden');
                feedbackContainer.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-slate-800 mb-4">📝 Phân Tích & Gợi Ý Từ Trợ Lý AI</h3>
                        <div id="ai-feedback-loader" class="text-center py-6">
                            <svg class="animate-spin mx-auto h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p class="mt-3 text-slate-600">AI đang phân tích bài làm của bạn...</p>
                        </div>
                        <div id="ai-feedback-summary" class="hidden prose prose-sm max-w-none"></div>
                        <div id="ai-feedback-details" class="hidden mt-4 space-y-2"></div>
                    </div>
                `;
               
                const loader = document.getElementById('ai-feedback-loader');
                const summaryDiv = document.getElementById('ai-feedback-summary');
                const detailsDiv = document.getElementById('ai-feedback-details');
                const incorrectAnswers = allAnswersData.filter(a => !a.isCorrect);
                if (incorrectAnswers.length === 0) {
                    feedbackContainer.innerHTML = `
                        <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                            <h3 class="text-xl font-bold text-green-600">🎉 Chúc mừng!</h3>
                            <p class="mt-2 text-slate-700">Bạn đã trả lời đúng tất cả các câu hỏi. Làm tốt lắm!</p>
                        </div>
                    `;
                    return { overallFeedback: { summary: "Xuất sắc! Học sinh đã đã trả lời đúng tất cả các câu hỏi." } };
                }
                const summaryPrompt = `Bạn là một trợ lý giáo viên, nói tiếng Việt. Dựa vào tóm tắt các câu trả lời sai của học sinh, hãy đưa ra một nhận xét tổng quan ngắn gọn (khoảng 3-4 câu) về năng lực của học sinh, bao gồm điểm mạnh (suy luận từ các câu làm đúng), điểm yếu (dựa trên các câu sai) và một vài gợi ý ôn tập chung. Lời văn phải khích lệ, rõ ràng.
                Tóm tắt lỗi sai:
                ${JSON.stringify(incorrectAnswers.map(a => ({ cau: a.questionNumber, loai: a.type, cauHoi: a.question.substring(0, 50) + '...' })), null, 2)}`;
                try {
                    const summaryResponse = await ai.models.generateContent({
                        model: "gemini-2.5-flash",
                        contents: summaryPrompt
                    });
                    summaryDiv.innerHTML = summaryResponse.text.replace(/\n/g, '<br>');
                    loader.classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                    detailsDiv.classList.remove('hidden'); 
                } catch (e) {
                    console.error("Lỗi khi lấy nhận xét tổng quan:", e);
                    summaryDiv.innerHTML = '<p class="text-red-600">Lỗi khi tạo nhận xét tổng quan.</p>';
                    loader.classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                }
               
                const summaryForSheet = summaryDiv.innerText.substring(0, 200) + "...";
                return { overallFeedback: { summary: summaryForSheet } };
            }
            async function handleSubmit() {
                if (isSubmitted) return;
                isSubmitted = true;
                clearInterval(timerInterval);
                
                document.querySelectorAll('input, textarea').forEach(input => input.disabled = true);
                submitBtn.classList.add('hidden');
                postSubmitOptions.classList.remove('hidden');
                if (retriesLeft > 0) {
                    retryBtn.classList.remove('hidden');
                } else {
                    retryBtn.classList.add('hidden');
                }

                const proctoringDataString = JSON.stringify(proctoringLog);

                let totalStudentScore = 0;
                let totalCorrectAnswers = 0;
                let allAnswersData = [];
                const questionCounts = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    acc[type] = (acc[type] || 0) + 1;
                    return acc;
                }, {});
                
                // --- GRADING LOGIC (runs for all cases now) ---
                quizData.forEach((item, index) => {
                    let questionNumber = index + 1;
                    let answerData = { questionNumber, type: item.type };
                    switch (item.mappedType) {
                        case 'multiple-choice':
                            const selectedOption = document.querySelector(`input[name="q${index}"]:checked`);
                            const isCorrectMC = selectedOption ? parseInt(selectedOption.value) === item.correctAnswerIndex : false;
                            if (isCorrectMC) {
                                totalCorrectAnswers++;
                                if (questionCounts['multiple-choice'] > 0) {
                                   totalStudentScore += quizOptions.scoring.mc / questionCounts['multiple-choice'];
                                }
                            }
                            answerData.question = item.question;
                            answerData.options = item.options;
                            answerData.yourAnswer = selectedOption ? String.fromCharCode(65 + parseInt(selectedOption.value)) : "Không trả lời";
                            answerData.correctAnswer = String.fromCharCode(65 + item.correctAnswerIndex);
                            answerData.isCorrect = isCorrectMC;
                            break;
                        case 'true-false':
                            let correctStatementsCount = 0;
                            let yourAnswerPattern = [];
                            let correctAnswerPattern = [];
                            let details = [];
                            item.statements.forEach((s, i) => {
                                const selectedTF = document.querySelector(`input[name="q${index}-s${i}"]:checked`);
                                const studentChoice = selectedTF ? selectedTF.value === 'true' : null;
                                const isStatementCorrect = studentChoice === s.is_correct;
                               
                                if (isStatementCorrect) correctStatementsCount++;
                               
                                yourAnswerPattern.push(studentChoice === null ? '?' : (studentChoice ? 'Đ' : 'S'));
                                correctAnswerPattern.push(s.is_correct ? 'Đ' : 'S');
                                details.push({ statement: s.statement, yourChoice: studentChoice === null ? 'Không trả lời' : (studentChoice ? 'Đúng' : 'Sai'), correctChoice: s.is_correct ? 'Đúng' : 'Sai', isCorrect: isStatementCorrect });
                            });
                            
                            let scorePerTfQuestion = 0;
                            if (questionCounts['true-false'] > 0) {
                                scorePerTfQuestion = quizOptions.scoring.tf / questionCounts['true-false'];
                            }
                            let questionPoints = 0;
                            if (quizOptions.scoring.tfMethod === 'progressive') {
                                const progressivePoints = { 0: 0, 1: 0.1, 2: 0.25, 3: 0.5, 4: 1.0 };
                                questionPoints = progressivePoints[correctStatementsCount] * scorePerTfQuestion;
                            } else { // even
                                questionPoints = (correctStatementsCount / 4) * scorePerTfQuestion;
                            }
                            totalStudentScore += questionPoints;

                            if(correctStatementsCount === 4) totalCorrectAnswers++;
                            answerData.question = item.main_question;
                            answerData.yourAnswer = yourAnswerPattern.join('-');
                            answerData.correctAnswer = correctAnswerPattern.join('-');
                            answerData.isCorrect = correctStatementsCount === 4;
                            answerData.details = details;
                            break;
                       
                        case 'short-answer':
                            const saInput = document.querySelector(`input[name="q${index}"]`);
                            const studentAnswerRaw = saInput ? (saInput.value ?? '').trim() : "";
                            const correctAnswerRaw = (item.answer ?? '').toString().trim().replace(/\$/g, '');
                            let isCorrectSA = false;

                            // Normalize both to use '.' as decimal separator for comparison
                            const studentAnswerNormalized = studentAnswerRaw.replace(',', '.');
                            const correctAnswerNormalized = correctAnswerRaw.replace(',', '.');
                            
                            // Perform a single, case-insensitive string comparison.
                            // This is strict about decimal places but allows for different separators (',' vs '.').
                            if (studentAnswerNormalized.toLowerCase() === correctAnswerNormalized.toLowerCase()) {
                                isCorrectSA = true;
                            }
                             
                             if (isCorrectSA) {
                                totalCorrectAnswers++;
                                if (questionCounts['short-answer'] > 0) {
                                   totalStudentScore += quizOptions.scoring.sa / questionCounts['short-answer'];
                                }
                            }
                            answerData.question = item.question;
                            answerData.yourAnswer = studentAnswerRaw || "Không trả lời";
                            answerData.correctAnswer = correctAnswerRaw;
                            answerData.isCorrect = isCorrectSA;
                            break;
                           
                        case 'essay':
                             const essayInput = document.querySelector(`textarea[name="q${index}"]`);
                             answerData.question = item.question;
                             answerData.yourAnswer = essayInput.value || "Không trả lời";
                             answerData.correctAnswer = item.answer;
                             answerData.isCorrect = null; // Needs manual grading
                             break;
                    }
                    allAnswersData.push(answerData);
                });
                
                const finalScore = totalStudentScore;
                
                let competencyAssessment = "Giáo viên không yêu cầu AI phân tích bài làm.";
                if (quizOptions.aiAssessment) {
                    const feedbackData = await generatePerformanceReview(allAnswersData);
                    if (feedbackData && feedbackData.overallFeedback && feedbackData.overallFeedback.summary) {
                        competencyAssessment = feedbackData.overallFeedback.summary;
                    } else {
                        competencyAssessment = "Có lỗi xảy ra trong quá trình AI phân tích bài làm.";
                    }
                }
                
                // --- UI DISPLAY LOGIC ---
                if (quizOptions.showAnswers) {
                    const totalQuestions = quizData.length;
                    let summaryTableHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                        <h3 class="text-xl font-bold text-slate-800 mb-4">🎯 TỔNG KẾT:</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-center text-slate-600">
                                <thead class="text-xs text-slate-700 uppercase bg-slate-100 rounded-t-lg">
                                    <tr>
                                        <th scope="col" class="px-4 py-3 font-semibold">Câu</th>
                                        <th scope="col" class="px-4 py-3 font-semibold">Đáp án của bạn</th>
                                        <th scope="col" class="px-4 py-3 font-semibold">Đáp án đúng</th>
                                        <th scope="col" class="px-4 py-3 font-semibold">Kết quả</th>
                                    </tr>
                                </thead>
                                <tbody>`;
                   
                    allAnswersData.forEach(ans => {
                        let yourAnswerDisplay;
                        let tdClass = 'px-4 py-3';

                        if (ans.type === 'true-false') {
                            const yourParts = (ans.yourAnswer || '').split('-');
                            const correctParts = (ans.correctAnswer || '').split('-');
                            yourAnswerDisplay = yourParts.map((part, i) => {
                                if (part === correctParts[i]) {
                                    return `<span class="text-green-600 font-bold">${part}</span>`;
                                } else {
                                    return `<span class="text-red-600 font-bold">${part}</span>`;
                                }
                            }).join('');
                        } else {
                            yourAnswerDisplay = ans.yourAnswer;
                            if (ans.isCorrect === false) {
                                tdClass += ' text-red-500 font-bold';
                            }
                        }

                        summaryTableHTML += `
                            <tr class="bg-white border-b">
                                <td class="px-4 py-3 font-medium">${ans.questionNumber}</td>
                                <td class="${tdClass}">${yourAnswerDisplay}</td>
                                <td class="px-4 py-3">${ans.correctAnswer}</td>
                                <td class="px-4 py-3 flex justify-center">${ans.isCorrect === true ?
                                    '<svg class="w-6 h-6 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>' :
                                    (ans.isCorrect === false ? '<svg class="w-6 h-6 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>' : '<span>-</span>')
                                }</td>
                            </tr>`;
                    });
                    summaryTableHTML += `
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-4 space-y-1 text-left">
                            <p class="font-semibold text-green-600">✅ Số câu đúng hoàn toàn: ${totalCorrectAnswers}/${totalQuestions}</p>
                             <p class="font-semibold text-blue-600">📊 Điểm (thang 10): ${finalScore.toFixed(2)}/10</p>
                             ${questionCounts['essay'] > 0 ? `<p class="text-sm text-gray-600 italic">Lưu ý: Điểm trên chưa bao gồm ${quizOptions.scoring.essay} điểm của phần Tự luận cần giáo viên chấm.</p>` : ''}
                        </div>
                    </div>`;
                   
                    resultContainer.innerHTML = summaryTableHTML;
                    resultContainer.classList.remove('hidden');
                    
                    if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                        await window.MathJax.typesetPromise([resultContainer]);
                    }
                } else {
                     resultContainer.innerHTML = `
                        <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                            <h3 class="text-xl font-bold text-green-600">Nộp bài thành công!</h3>
                            <p class="mt-2 text-slate-700">Bạn đã hoàn thành bài làm. Kết quả sẽ được giáo viên công bố sau.</p>
                        </div>
                    `;
                    resultContainer.classList.remove('hidden');
                }
                
                // --- DATA SUBMISSION LOGIC (runs for all cases) ---
                const formData = new FormData();
                formData.append('name', studentInfo.name);
                formData.append('class', studentInfo.class);
                formData.append('score', `${finalScore.toFixed(2)}/10`);
                formData.append('assessment', competencyAssessment);
                formData.append('timestamp', new Date().toLocaleString('vi-VN'));
                formData.append('examCode', correctExamCode);
                formData.append('monitoringLog', proctoringDataString);
                formData.append('answerDetails', JSON.stringify(allAnswersData));
               
                fetch(googleScriptUrl, { method: 'POST', body: formData})
                    .then(res => console.log("Successfully submitted to Google Sheet"))
                    .catch(err => console.error("Error submitting to Google Sheet:", err));
            }
           
            function startNewAttempt() {
                isSubmitted = false;
                proctoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0, suKien: [] };
                const proctoringWidget = document.getElementById('proctoring-widget');
                if (proctoringWidget) {
                    proctoringWidget.classList.add('hidden');
                    document.getElementById('tab-switch-count').textContent = '0';
                    document.getElementById('copy-count').textContent = '0';
                    document.getElementById('paste-count').textContent = '0';
                }

                renderStudentQuiz();
                resultContainer.classList.add('hidden');
                document.getElementById('ai-feedback-container').classList.add('hidden');
                postSubmitOptions.classList.add('hidden');
                submitBtn.classList.remove('hidden');
                 if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                }
                retriesLeft--;
                retriesDisplay.textContent = `Lượt làm lại còn: ${retriesLeft}`;
                window.scrollTo(0, 0);
            }
            studentInfoForm.addEventListener('submit', (e) => {
                e.preventDefault();
               
                const enteredCode = document.getElementById('exam-code').value.trim().toUpperCase();
                if (enteredCode !== correctExamCode) {
                    alert('Mã đề không chính xác. Vui lòng kiểm tra lại!');
                    return;
                }
               
                studentApiKey = teacherApiKey;
                if (!studentApiKey) {
                    alert('Cảnh báo: Giáo viên chưa cấu hình API Key. Các tính năng AI sẽ không hoạt động.');
                }
       
                try {
                    if (studentApiKey) {
                       ai = new GoogleGenAI({ apiKey: studentApiKey });
                    }
                } catch(e) {
                    console.error("Lỗi khởi tạo Gemini API với key của giáo viên.", e);
                    alert("Cảnh báo: API Key của giáo viên không hợp lệ. Vui lòng báo cho giáo viên. Các tính năng AI sẽ không hoạt động.");
                    ai = null;
                }
                shuffleQuiz();
               
                studentInfo.name = document.getElementById('student-name').value;
                studentInfo.class = document.getElementById('student-class').value;
                loginModal.classList.add('hidden');
                studentQuizContainer.classList.remove('hidden');
                submitBtn.classList.remove('hidden');
               
                if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                } else {
                    timerDisplay.textContent = "Không giới hạn";
                }
                retriesDisplay.textContent = `Lượt làm lại còn: ${retriesLeft}`;
                renderStudentQuiz();

                const proctoringWidget = document.getElementById('proctoring-widget');
                const tabSwitchCountEl = document.getElementById('tab-switch-count');
                const copyCountEl = document.getElementById('copy-count');
                const pasteCountEl = document.getElementById('paste-count');

                function updateProctoringUI() {
                    if (proctoringLog.thoatManHinh > 0 || proctoringLog.saoChep > 0 || proctoringLog.dan > 0) {
                        proctoringWidget.classList.remove('hidden');
                    }
                    tabSwitchCountEl.textContent = proctoringLog.thoatManHinh;
                    copyCountEl.textContent = proctoringLog.saoChep;
                    pasteCountEl.textContent = proctoringLog.dan;
                }

                // Disable Right Click
                document.addEventListener('contextmenu', e => e.preventDefault());

                // Track Tab Switching
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && !isSubmitted) {
                        proctoringLog.thoatManHinh++;
                        proctoringLog.suKien.push({ loai: 'chuyen_tab', thoiGian: new Date().toISOString() });
                        updateProctoringUI();
                    }
                });

                // Track Copying
                document.addEventListener('copy', () => {
                    if (isSubmitted) return;
                    proctoringLog.saoChep++;
                    proctoringLog.suKien.push({ loai: 'sao_chep', thoiGian: new Date().toISOString() });
                    updateProctoringUI();
                });

                // Track Pasting
                document.addEventListener('paste', () => {
                    if (isSubmitted) return;
                    proctoringLog.dan++;
                    proctoringLog.suKien.push({ loai: 'dan', thoiGian: new Date().toISOString() });
                    updateProctoringUI();
                });
            });
            
            submitBtn.addEventListener('click', handleSubmit);
            retryBtn.addEventListener('click', () => {
                shuffleQuiz();
                startNewAttempt();
            });
        </script>
    </body>
    </html>
    