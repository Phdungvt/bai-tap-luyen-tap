
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bài kiểm tra - 27/11/2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%); min-height: 100vh; }
        .option { transition: all 0.2s ease; }
        .option:hover { background-color: #f3f4f6; }
        .option.selected { border-color: #4f46e5; background-color: #eef2ff; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2); }
        .option.correct { border-color: #22c55e; background-color: #f0fdf4; }
        .option.incorrect { border-color: #ef4444; background-color: #fef2f2; }
        .disabled { pointer-events: none; opacity: 0.7; }
        .monitoring-warning { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: #ef4444; color: white; padding: 12px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 1000; display: none; font-weight: bold; animation: fade-in-out 5s ease-in-out; }
        @keyframes fade-in-out { 0%, 100% { opacity: 0; transform: translate(-50%, -20px); } 10%, 90% { opacity: 1; transform: translate(-50%, 0); } }
        /* MathJax basic styling */
        mjx-container { display: inline-block !important; }
        .prose img.latex-image { display: inline-block; vertical-align: middle; }
        
        /* Progress Bar */
        .progress-container { position: fixed; top: 0; left: 0; width: 100%; height: 4px; background: #e5e7eb; z-index: 50; }
        .progress-bar { height: 100%; background: #4f46e5; transition: width 0.3s; width: 0%; }

        /* Navigation Panel */
        .nav-panel {
            position: fixed; right: 0; top: 0; bottom: 0; width: 280px;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            box-shadow: -4px 0 15px rgba(0,0,0,0.05);
            z-index: 40; overflow-y: auto; padding-top: 60px;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .nav-panel.open { transform: translateX(0); }
        .nav-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; padding: 16px; }
        .nav-btn {
            width: 40px; height: 40px; border-radius: 8px; border: 1px solid #e5e7eb;
            background: white; color: #4b5563; font-size: 14px; font-weight: 600;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .nav-btn:hover { border-color: #6366f1; color: #6366f1; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .nav-btn.answered { background-color: #6366f1; color: white; border-color: #6366f1; }
        .nav-btn.current { border-color: #f59e0b; color: #f59e0b; border-width: 2px; background-color: #fffbeb; }

        /* Layout Adjustment for Nav Panel */
        #app { transition: margin-right 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        body.nav-open #app { margin-right: 280px; }
        
        @media (max-width: 1024px) {
            body.nav-open #app { margin-right: 0; } /* On mobile, nav covers content */
        }

        #toggle-nav-btn {
            position: fixed; right: 24px; bottom: 24px; width: 56px; height: 56px;
            background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; border-radius: 50%;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
            display: flex; align-items: center; justify-content: center;
            z-index: 50; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
        }
        #toggle-nav-btn:hover { transform: scale(1.05); box-shadow: 0 6px 16px rgba(79, 70, 229, 0.5); }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        .question-card { transition: box-shadow 0.3s; }
        .question-card:hover { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.01); }
    </style>
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$']], displayMath: [['$$', '$$']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    <script type="importmap">
    { "imports": { 
        "@google/genai": "https://esm.sh/@google/genai@^1.13.0",
        "canvas-confetti": "https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/+esm"
    } }
    </script>
</head>
<body class="p-4 md:p-6">
    <div id="progress-container" class="progress-container hidden"><div id="progress-bar" class="progress-bar"></div></div>
    
    <button id="toggle-nav-btn" class="hidden" title="Danh sách câu hỏi">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" />
        </svg>
    </button>

    <div id="nav-panel" class="nav-panel">
        <div class="px-4 py-3 border-b bg-gray-50 sticky top-0 z-10">
            <h3 class="font-bold text-gray-800 text-lg">Danh sách câu hỏi</h3>
            <div class="flex items-center gap-4 mt-3 text-sm text-gray-600">
                <div class="flex items-center gap-1.5"><div class="w-3 h-3 border rounded bg-white"></div> Chưa làm</div>
                <div class="flex items-center gap-1.5"><div class="w-3 h-3 rounded bg-indigo-500"></div> Đã làm</div>
            </div>
        </div>
        <div id="nav-grid" class="nav-grid pb-20"></div>
    </div>

    <div id="app" class="max-w-5xl mx-auto transition-all duration-300">
        
        <div id="welcome-screen" class="bg-white rounded-2xl shadow-xl overflow-hidden max-w-2xl mx-auto mt-10">
            <div class="bg-gradient-to-r from-indigo-600 to-violet-600 p-8 text-center text-white relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9IiNmZmYiLz48L3N2Zz4=')]"></div>
                <h1 class="text-2xl md:text-3xl font-bold mb-2 relative z-10">Bài kiểm tra - 27/11/2025</h1>
                <p class="text-indigo-100 text-sm md:text-base relative z-10">Mã đề: <span class="font-mono font-bold bg-white/20 px-2 py-1 rounded text-white">1S3NZM</span></p>
                 <div class="mt-4 inline-flex items-center bg-white/10 backdrop-blur-sm px-4 py-2 rounded-full relative z-10">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd" />
                    </svg>
                    <span>Giáo viên: <span class="font-bold text-yellow-300">Giáo viên</span></span>
                </div>
            </div>
            <div class="p-8">
                <div class="space-y-5">
                    <div>
                        <label for="name" class="block text-sm font-semibold text-gray-700 mb-1">Họ và tên học sinh</label>
                        <input type="text" id="name" class="w-full border-gray-300 rounded-lg shadow-sm py-3 px-4 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all text-gray-800 placeholder-gray-400" placeholder="Nhập họ tên của bạn...">
                    </div>
                    <div>
                        <label for="class" class="block text-sm font-semibold text-gray-700 mb-1">Lớp</label>
                        <input type="text" id="class" class="w-full border-gray-300 rounded-lg shadow-sm py-3 px-4 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all text-gray-800 placeholder-gray-400" placeholder="Ví dụ: 12A1">
                    </div>
                </div>
                 <div class="mt-6 bg-amber-50 border-l-4 border-amber-400 p-4 rounded-r-lg">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-amber-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-amber-700">
                                <span class="font-bold">Lưu ý:</span> Hệ thống sẽ giám sát việc chuyển tab, sao chép/dán. Các hành vi này sẽ được ghi lại và báo cáo cho giáo viên.
                            </p>
                        </div>
                    </div>
                </div>
                <button id="start-btn" class="mt-8 w-full bg-gradient-to-r from-indigo-600 to-violet-600 text-white py-3.5 px-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl hover:translate-y-[-2px] transition-all flex items-center justify-center gap-2">
                    <span>Bắt đầu làm bài</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>

        <div id="quiz-screen" class="hidden">
             <div class="sticky top-0 z-30 -mx-4 md:-mx-6 mb-6">
                 <div class="bg-white/90 backdrop-blur-md shadow-md border-b border-gray-200 py-3 px-4 md:px-8 flex justify-between items-center">
                    <div>
                         <h2 class="text-lg md:text-xl font-bold text-gray-800 truncate max-w-[200px] md:max-w-md">Bài kiểm tra - 27/11/2025</h2>
                         <p class="text-xs text-gray-500 hidden md:block">Thí sinh: <span id="student-name-display" class="font-semibold"></span></p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div id="timer" class="text-lg md:text-xl font-mono font-bold text-red-600 bg-red-50 px-3 py-1.5 rounded-lg border border-red-100 min-w-[80px] text-center shadow-sm"></div>
                        <button id="submit-btn-top" class="md:hidden bg-green-600 text-white px-3 py-1.5 rounded-lg text-sm font-semibold shadow-sm">Nộp</button>
                    </div>
                 </div>
            </div>
            
            <div id="all-questions-container" class="space-y-6 pb-10"></div>
            
            <div class="mt-8 flex justify-end sticky bottom-4 z-20">
                <div class="bg-white/80 backdrop-blur p-2 rounded-2xl shadow-lg border border-gray-100">
                    <button id="submit-btn" class="bg-gradient-to-r from-emerald-500 to-green-600 text-white py-3 px-8 rounded-xl font-bold text-lg shadow-md hover:shadow-lg hover:from-emerald-600 hover:to-green-700 transition-all flex items-center gap-2">
                        <span>Nộp bài</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div id="results-screen" class="hidden max-w-3xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="bg-gradient-to-r from-blue-500 to-cyan-500 p-8 text-center text-white">
                <h2 class="text-3xl font-bold mb-2">Kết quả bài làm</h2>
                <p class="opacity-90">Chúc mừng bạn đã hoàn thành bài thi!</p>
            </div>
            <div class="p-8">
                <div id="score-display" class="hidden flex flex-col items-center justify-center my-4">
                    <span class="text-gray-500 text-lg uppercase tracking-widest font-semibold mb-2">Tổng điểm</span>
                    <span class="text-6xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-br from-blue-600 to-cyan-500 drop-shadow-sm"></span>
                </div>
                
                <div id="assessment-display" class="hidden mt-6 p-6 bg-indigo-50 border border-indigo-100 rounded-xl text-gray-700 shadow-inner relative">
                     <div class="absolute top-0 left-0 w-1 h-full bg-indigo-400 rounded-l-xl"></div>
                     <h3 class="font-bold text-indigo-800 mb-2 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z" />
                            <path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z" />
                        </svg>
                        Nhận xét từ AI Giáo viên
                     </h3>
                     <div class="assessment-content prose prose-indigo max-w-none"></div>
                </div>

                <div id="review-container" class="mt-10 border-t pt-8"></div>
                
                <div class="mt-10 flex flex-col sm:flex-row justify-center gap-4">
                    <button id="retry-btn" class="hidden bg-white text-indigo-600 border-2 border-indigo-600 py-3 px-6 rounded-xl font-bold hover:bg-indigo-50 transition-colors">Làm lại bài</button>
                    <button id="restart-btn" class="bg-gray-800 text-white py-3 px-6 rounded-xl font-bold hover:bg-gray-900 transition-colors shadow-md">Về trang chủ</button>
                </div>
            </div>
        </div>
        
        <div id="monitoring-warning" class="monitoring-warning">⚠️ Đã phát hiện hành vi không hợp lệ!</div>
    </div>

    <script type="module">
        import { GoogleGenAI } from "@google/genai";
        import confetti from "https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/+esm";

        const API_KEY = "AIzaSyDzpJyodrQYlL0_OmSq4k3snugEgphM6IE";
        let quizData = [{"type":"multiple-choice","question":"<strong></strong> Trí tuệ nhân tạo (AI) là gì?","main_question":null,"questionImage":null,"options":["Một lĩnh vực của khoa học máy tính tập trung vào việc tạo ra máy móc thông minh.","Một loại robot có khả năng tự sửa chữa.","Một ngôn ngữ lập trình mới.","Một hệ điều hành dành cho máy tính siêu cấp."],"optionsImage":[null,null,null,null],"correctAnswerIndex":0,"statements":[],"answer":null,"isDirty":true,"explanation":null,"questionNumber":1,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Trí tuệ nhân tạo (AI) là gì?","rendered_options":["Một lĩnh vực của khoa học máy tính tập trung vào việc tạo ra máy móc thông minh.","Một loại robot có khả năng tự sửa chữa.","Một ngôn ngữ lập trình mới.","Một hệ điều hành dành cho máy tính siêu cấp."]},{"type":"multiple-choice","question":"<strong></strong> Khả năng nào sau đây được coi là một đặc trưng cơ bản của trí tuệ nhân tạo?","main_question":null,"questionImage":null,"options":["Khả năng chạy các ứng dụng văn phòng nhanh hơn.","Khả năng học hỏi và thích nghi.","Khả năng lưu trữ dữ liệu lớn.","Khả năng kết nối mạng không dây."],"optionsImage":[null,null,null,null],"correctAnswerIndex":1,"statements":[],"answer":null,"isDirty":true,"explanation":null,"questionNumber":2,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Khả năng nào sau đây được coi là một đặc trưng cơ bản của trí tuệ nhân tạo?","rendered_options":["Khả năng chạy các ứng dụng văn phòng nhanh hơn.","Khả năng học hỏi và thích nghi.","Khả năng lưu trữ dữ liệu lớn.","Khả năng kết nối mạng không dây."]},{"type":"multiple-choice","question":"<strong></strong> Ứng dụng nào sau đây KHÔNG phải là ứng dụng phổ biến của Trí tuệ nhân tạo?","main_question":null,"questionImage":null,"options":["Xe tự lái.","Nhận diện khuôn mặt.","Trợ lý ảo (ví dụ: Siri, Google Assistant).","Thiết kế đồ họa thủ công."],"optionsImage":[null,null,null,null],"correctAnswerIndex":3,"statements":[],"answer":null,"isDirty":true,"explanation":null,"questionNumber":3,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Ứng dụng nào sau đây KHÔNG phải là ứng dụng phổ biến của Trí tuệ nhân tạo?","rendered_options":["Xe tự lái.","Nhận diện khuôn mặt.","Trợ lý ảo (ví dụ: Siri, Google Assistant).","Thiết kế đồ họa thủ công."]},{"type":"multiple-choice","question":"<strong></strong> Việc sử dụng AI trong y tế có thể mang lại lợi ích nào sau đây?","main_question":null,"questionImage":null,"options":["Hỗ trợ chẩn đoán bệnh chính xác và nhanh chóng.","Thay thế hoàn toàn bác sĩ.","Giảm chi phí mua thuốc.","Tăng tuổi thọ trung bình của dân số một cách trực tiếp."],"optionsImage":[null,null,null,null],"correctAnswerIndex":0,"statements":[],"answer":null,"isDirty":true,"explanation":null,"questionNumber":4,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Việc sử dụng AI trong y tế có thể mang lại lợi ích nào sau đây?","rendered_options":["Hỗ trợ chẩn đoán bệnh chính xác và nhanh chóng.","Thay thế hoàn toàn bác sĩ.","Giảm chi phí mua thuốc.","Tăng tuổi thọ trung bình của dân số một cách trực tiếp."]},{"type":"multiple-choice","question":"<strong></strong> Thiết bị mạng nào sau đây có chức năng kết nối nhiều máy tính trong một mạng cục bộ (LAN)?","main_question":null,"questionImage":null,"options":["Switch (Bộ chuyển mạch).","Modem (Bộ điều giải).","Router (Bộ định tuyến).","Cáp quang."],"optionsImage":[null,null,null,null],"correctAnswerIndex":0,"statements":[],"answer":null,"isDirty":true,"explanation":null,"questionNumber":5,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Thiết bị mạng nào sau đây có chức năng kết nối nhiều máy tính trong một mạng cục bộ (LAN)?","rendered_options":["Switch (Bộ chuyển mạch).","Modem (Bộ điều giải).","Router (Bộ định tuyến).","Cáp quang."]},{"type":"multiple-choice","question":"<strong></strong> Chức năng chính của Router (bộ định tuyến) là gì?","main_question":null,"questionImage":null,"options":["Chuyển đổi tín hiệu analog sang digital.","Định tuyến gói dữ liệu giữa các mạng.","Lưu trữ dữ liệu tạm thời.","Tăng cường tín hiệu Wi-Fi."],"optionsImage":[null,null,null,null],"correctAnswerIndex":1,"statements":[],"answer":null,"isDirty":true,"explanation":null,"questionNumber":6,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Chức năng chính của Router (bộ định tuyến) là gì?","rendered_options":["Chuyển đổi tín hiệu analog sang digital.","Định tuyến gói dữ liệu giữa các mạng.","Lưu trữ dữ liệu tạm thời.","Tăng cường tín hiệu Wi-Fi."]},{"type":"multiple-choice","question":"<strong></strong> Khi bạn kết nối máy tính của mình với Internet thông qua đường dây điện thoại, thiết bị nào thường được sử dụng để chuyển đổi tín hiệu?","main_question":null,"questionImage":null,"options":["Modem.","Switch.","Hub.","Repeater."],"optionsImage":[null,null,null,null],"correctAnswerIndex":0,"statements":[],"answer":null,"isDirty":true,"explanation":null,"questionNumber":7,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Khi bạn kết nối máy tính của mình với Internet thông qua đường dây điện thoại, thiết bị nào thường được sử dụng để chuyển đổi tín hiệu?","rendered_options":["Modem.","Switch.","Hub.","Repeater."]},{"type":"multiple-choice","question":"<strong></strong> Để chia sẻ một thư mục trên mạng, điều đầu tiên bạn cần làm là gì?","main_question":null,"questionImage":null,"options":["Bật tính năng chia sẻ tệp và máy in.","Cài đặt một trình duyệt web mới.","Mua thêm một ổ cứng mạng.","Thay đổi địa chỉ IP của máy tính."],"optionsImage":[null,null,null,null],"correctAnswerIndex":0,"statements":[],"answer":null,"isDirty":true,"explanation":null,"questionNumber":8,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Để chia sẻ một thư mục trên mạng, điều đầu tiên bạn cần làm là gì?","rendered_options":["Bật tính năng chia sẻ tệp và máy in.","Cài đặt một trình duyệt web mới.","Mua thêm một ổ cứng mạng.","Thay đổi địa chỉ IP của máy tính."]},{"type":"multiple-choice","question":"<strong></strong> Khi chia sẻ một tài nguyên trên mạng, việc cấp quyền truy cập là để làm gì?","main_question":null,"questionImage":null,"options":["Giúp tài nguyên được mã hóa tự động.","Xác định ai có thể truy cập và làm gì với tài nguyên.","Tăng tốc độ truyền tải dữ liệu.","Giảm dung lượng của tài nguyên."],"optionsImage":[null,null,null,null],"correctAnswerIndex":1,"statements":[],"answer":null,"isDirty":true,"explanation":null,"questionNumber":9,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Khi chia sẻ một tài nguyên trên mạng, việc cấp quyền truy cập là để làm gì?","rendered_options":["Giúp tài nguyên được mã hóa tự động.","Xác định ai có thể truy cập và làm gì với tài nguyên.","Tăng tốc độ truyền tải dữ liệu.","Giảm dung lượng của tài nguyên."]},{"type":"multiple-choice","question":"<strong></strong> Khi một tài nguyên được chia sẻ trên mạng, làm thế nào để các máy tính khác trong cùng mạng có thể tìm thấy và truy cập tài nguyên đó?","main_question":null,"questionImage":null,"options":["Duyệt qua 'Network' (Mạng) trong File Explorer hoặc nhập đường dẫn mạng.","Gửi email đến máy tính chia sẻ.","Sử dụng một phần mềm diệt virus.","Cài đặt lại hệ điều hành."],"optionsImage":[null,null,null,null],"correctAnswerIndex":0,"statements":[],"answer":null,"isDirty":true,"explanation":null,"questionNumber":10,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Khi một tài nguyên được chia sẻ trên mạng, làm thế nào để các máy tính khác trong cùng mạng có thể tìm thấy và truy cập tài nguyên đó?","rendered_options":["Duyệt qua 'Network' (Mạng) trong File Explorer hoặc nhập đường dẫn mạng.","Gửi email đến máy tính chia sẻ.","Sử dụng một phần mềm diệt virus.","Cài đặt lại hệ điều hành."]},{"type":"multiple-choice","question":"<strong></strong> Hành vi nào sau đây được coi là giao tiếp có văn hóa trong không gian mạng?","main_question":null,"questionImage":null,"options":["Sử dụng biệt danh (nick name) ẩn danh để bình luận chỉ trích.","Tôn trọng ý kiến của người khác, ngay cả khi không đồng tình.","Chia sẻ thông tin cá nhân của người khác mà không được phép.","Sử dụng ngôn ngữ tục tĩu khi tranh luận."],"optionsImage":[null,null,null,null],"correctAnswerIndex":1,"statements":[],"answer":null,"isDirty":true,"explanation":null,"questionNumber":11,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Hành vi nào sau đây được coi là giao tiếp có văn hóa trong không gian mạng?","rendered_options":["Sử dụng biệt danh (nick name) ẩn danh để bình luận chỉ trích.","Tôn trọng ý kiến của người khác, ngay cả khi không đồng tình.","Chia sẻ thông tin cá nhân của người khác mà không được phép.","Sử dụng ngôn ngữ tục tĩu khi tranh luận."]},{"type":"multiple-choice","question":"<strong></strong> Một trong những nguyên tắc quan trọng nhất khi tham gia cộng đồng trực tuyến là gì?","main_question":null,"questionImage":null,"options":["Cố gắng thu hút sự chú ý bằng mọi giá.","Chỉ chia sẻ những thông tin gây sốc.","Chịu trách nhiệm về hành vi và lời nói của mình.","Tin vào mọi thông tin được đăng tải."],"optionsImage":[null,null,null,null],"correctAnswerIndex":2,"statements":[],"answer":null,"isDirty":true,"explanation":null,"questionNumber":12,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Một trong những nguyên tắc quan trọng nhất khi tham gia cộng đồng trực tuyến là gì?","rendered_options":["Cố gắng thu hút sự chú ý bằng mọi giá.","Chỉ chia sẻ những thông tin gây sốc.","Chịu trách nhiệm về hành vi và lời nói của mình.","Tin vào mọi thông tin được đăng tải."]},{"type":"true-false","question":null,"main_question":"<strong></strong> Hãy đánh giá các phát biểu sau về ứng dụng của Trí tuệ nhân tạo:","questionImage":null,"options":[],"optionsImage":[],"correctAnswerIndex":-1,"statements":[{"statement":"Hệ thống khuyến nghị sản phẩm trên các trang thương mại điện tử là một ứng dụng của AI.","is_correct":true,"rendered_statement":"Hệ thống khuyến nghị sản phẩm trên các trang thương mại điện tử là một ứng dụng của AI."},{"statement":"AI có thể được sử dụng để dịch ngôn ngữ tự động.","is_correct":true,"rendered_statement":"AI có thể được sử dụng để dịch ngôn ngữ tự động."},{"statement":"AI hiện nay có khả năng hiểu và thể hiện cảm xúc giống hệt con người.","is_correct":false,"rendered_statement":"AI hiện nay có khả năng hiểu và thể hiện cảm xúc giống hệt con người."},{"statement":"Robot công nghiệp trong nhà máy không phải là một dạng ứng dụng của AI.","is_correct":false,"rendered_statement":"Robot công nghiệp trong nhà máy không phải là một dạng ứng dụng của AI."}],"answer":null,"isDirty":true,"explanation":null,"questionNumber":13,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Hãy đánh giá các phát biểu sau về ứng dụng của Trí tuệ nhân tạo:"},{"type":"true-false","question":null,"main_question":"<strong></strong> Hãy đánh giá các phát biểu sau về ứng dụng của Trí tuệ nhân tạo:","questionImage":null,"options":[],"optionsImage":[],"correctAnswerIndex":-1,"statements":[{"statement":"Hệ thống nhận diện giọng nói là một ứng dụng tiêu biểu của AI.","is_correct":true,"rendered_statement":"Hệ thống nhận diện giọng nói là một ứng dụng tiêu biểu của AI."},{"statement":"AI chỉ có thể được ứng dụng trong lĩnh vực công nghệ thông tin.","is_correct":false,"rendered_statement":"AI chỉ có thể được ứng dụng trong lĩnh vực công nghệ thông tin."},{"statement":"Xe tự hành hoàn toàn không sử dụng công nghệ AI.","is_correct":false,"rendered_statement":"Xe tự hành hoàn toàn không sử dụng công nghệ AI."},{"statement":"AI có thể phân tích dữ liệu lớn để tìm ra các xu hướng và mô hình ẩn.","is_correct":true,"rendered_statement":"AI có thể phân tích dữ liệu lớn để tìm ra các xu hướng và mô hình ẩn."}],"answer":null,"isDirty":true,"explanation":null,"questionNumber":14,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Hãy đánh giá các phát biểu sau về ứng dụng của Trí tuệ nhân tạo:"},{"type":"true-false","question":null,"main_question":"<strong></strong> Hãy đánh giá các phát biểu sau về tác động của Trí tuệ nhân tạo đến đời sống:","questionImage":null,"options":[],"optionsImage":[],"correctAnswerIndex":-1,"statements":[{"statement":"AI có thể giúp tối ưu hóa quy trình sản xuất, tăng năng suất.","is_correct":true,"rendered_statement":"AI có thể giúp tối ưu hóa quy trình sản xuất, tăng năng suất."},{"statement":"Việc phát triển AI có thể làm gia tăng một số loại hình tội phạm mạng mới.","is_correct":true,"rendered_statement":"Việc phát triển AI có thể làm gia tăng một số loại hình tội phạm mạng mới."},{"statement":"AI sẽ sớm thay thế hoàn toàn mọi công việc của con người trong mọi lĩnh vực.","is_correct":false,"rendered_statement":"AI sẽ sớm thay thế hoàn toàn mọi công việc của con người trong mọi lĩnh vực."},{"statement":"AI không thể góp phần vào việc giải quyết các vấn đề môi trường toàn cầu.","is_correct":false,"rendered_statement":"AI không thể góp phần vào việc giải quyết các vấn đề môi trường toàn cầu."}],"answer":null,"isDirty":true,"explanation":null,"questionNumber":15,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Hãy đánh giá các phát biểu sau về tác động của Trí tuệ nhân tạo đến đời sống:"},{"type":"true-false","question":null,"main_question":"<strong></strong> Hãy đánh giá các phát biểu sau về tác động của Trí tuệ nhân tạo đến xã hội:","questionImage":null,"options":[],"optionsImage":[],"correctAnswerIndex":-1,"statements":[{"statement":"Việc sử dụng AI trong giám sát có thể gây ra lo ngại về quyền riêng tư cá nhân.","is_correct":true,"rendered_statement":"Việc sử dụng AI trong giám sát có thể gây ra lo ngại về quyền riêng tư cá nhân."},{"statement":"AI có thể được sử dụng để tạo ra nội dung giả mạo (deepfake), gây ảnh hưởng tiêu cực đến xã hội.","is_correct":true,"rendered_statement":"AI có thể được sử dụng để tạo ra nội dung giả mạo (deepfake), gây ảnh hưởng tiêu cực đến xã hội."},{"statement":"Sự phát triển của AI không đặt ra yêu cầu nào về việc thay đổi các quy định pháp luật hiện hành.","is_correct":false,"rendered_statement":"Sự phát triển của AI không đặt ra yêu cầu nào về việc thay đổi các quy định pháp luật hiện hành."},{"statement":"Mọi quyết định do AI đưa ra đều khách quan và không mang định kiến.","is_correct":false,"rendered_statement":"Mọi quyết định do AI đưa ra đều khách quan và không mang định kiến."}],"answer":null,"isDirty":true,"explanation":null,"questionNumber":16,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Hãy đánh giá các phát biểu sau về tác động của Trí tuệ nhân tạo đến xã hội:"},{"type":"true-false","question":null,"main_question":"<strong></strong> Hãy đánh giá các phát biểu sau về thiết bị mạng:","questionImage":null,"options":[],"optionsImage":[],"correctAnswerIndex":-1,"statements":[{"statement":"Hub là thiết bị dùng để khuếch đại tín hiệu và chia sẻ kết nối mạng cho nhiều thiết bị.","is_correct":true,"rendered_statement":"Hub là thiết bị dùng để khuếch đại tín hiệu và chia sẻ kết nối mạng cho nhiều thiết bị."},{"statement":"Router chỉ dùng để kết nối các máy tính trong một mạng LAN.","is_correct":false,"rendered_statement":"Router chỉ dùng để kết nối các máy tính trong một mạng LAN."},{"statement":"Access Point (AP) dùng để tạo ra một mạng không dây (Wi-Fi).","is_correct":true,"rendered_statement":"Access Point (AP) dùng để tạo ra một mạng không dây (Wi-Fi)."},{"statement":"Cáp mạng UTP là loại cáp quang phổ biến nhất.","is_correct":false,"rendered_statement":"Cáp mạng UTP là loại cáp quang phổ biến nhất."}],"answer":null,"isDirty":true,"explanation":null,"questionNumber":17,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Hãy đánh giá các phát biểu sau về thiết bị mạng:"},{"type":"true-false","question":null,"main_question":"<strong></strong> Hãy đánh giá các phát biểu sau về thiết bị mạng:","questionImage":null,"options":[],"optionsImage":[],"correctAnswerIndex":-1,"statements":[{"statement":"Card mạng (NIC) là thiết bị cho phép máy tính kết nối với mạng.","is_correct":true,"rendered_statement":"Card mạng (NIC) là thiết bị cho phép máy tính kết nối với mạng."},{"statement":"Firewall là một thiết bị phần cứng, không thể là phần mềm.","is_correct":false,"rendered_statement":"Firewall là một thiết bị phần cứng, không thể là phần mềm."},{"statement":"Switch hoạt động ở lớp vật lý của mô hình OSI.","is_correct":false,"rendered_statement":"Switch hoạt động ở lớp vật lý của mô hình OSI."},{"statement":"Repeater được dùng để mở rộng phạm vi của tín hiệu mạng.","is_correct":true,"rendered_statement":"Repeater được dùng để mở rộng phạm vi của tín hiệu mạng."}],"answer":null,"isDirty":true,"explanation":null,"questionNumber":18,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Hãy đánh giá các phát biểu sau về thiết bị mạng:"},{"type":"true-false","question":null,"main_question":"<strong></strong> Hãy đánh giá các phát biểu sau về chức năng của thiết bị mạng:","questionImage":null,"options":[],"optionsImage":[],"correctAnswerIndex":-1,"statements":[{"statement":"Modem chuyển đổi tín hiệu số từ máy tính thành tín hiệu tương tự để truyền qua đường dây điện thoại và ngược lại.","is_correct":true,"rendered_statement":"Modem chuyển đổi tín hiệu số từ máy tính thành tín hiệu tương tự để truyền qua đường dây điện thoại và ngược lại."},{"statement":"Router thường được trang bị khả năng cấp phát địa chỉ IP tự động cho các thiết bị trong mạng (DHCP).","is_correct":true,"rendered_statement":"Router thường được trang bị khả năng cấp phát địa chỉ IP tự động cho các thiết bị trong mạng (DHCP)."},{"statement":"Switch thông minh hơn Hub vì nó có thể biết địa chỉ MAC của các thiết bị để gửi dữ liệu đúng đích.","is_correct":true,"rendered_statement":"Switch thông minh hơn Hub vì nó có thể biết địa chỉ MAC của các thiết bị để gửi dữ liệu đúng đích."},{"statement":"Access Point chỉ có thể hoạt động trong chế độ có dây.","is_correct":false,"rendered_statement":"Access Point chỉ có thể hoạt động trong chế độ có dây."}],"answer":null,"isDirty":true,"explanation":null,"questionNumber":19,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Hãy đánh giá các phát biểu sau về chức năng của thiết bị mạng:"},{"type":"true-false","question":null,"main_question":"<strong></strong> Hãy đánh giá các phát biểu sau về các thiết bị mạng trong hệ thống mạng gia đình:","questionImage":null,"options":[],"optionsImage":[],"correctAnswerIndex":-1,"statements":[{"statement":"Trong mạng gia đình, Modem và Router thường được tích hợp vào một thiết bị duy nhất.","is_correct":true,"rendered_statement":"Trong mạng gia đình, Modem và Router thường được tích hợp vào một thiết bị duy nhất."},{"statement":"Việc sử dụng Access Point rời giúp mở rộng vùng phủ sóng Wi-Fi hiệu quả hơn so với chỉ dùng Router tích hợp.","is_correct":true,"rendered_statement":"Việc sử dụng Access Point rời giúp mở rộng vùng phủ sóng Wi-Fi hiệu quả hơn so với chỉ dùng Router tích hợp."},{"statement":"Nếu muốn kết nối nhiều máy tính có dây trong nhà, việc chỉ có Router Wi-Fi là đủ.","is_correct":false,"rendered_statement":"Nếu muốn kết nối nhiều máy tính có dây trong nhà, việc chỉ có Router Wi-Fi là đủ."},{"statement":"Một thiết bị NAS (Network Attached Storage) có thể được coi là một thiết bị mạng có chức năng lưu trữ dữ liệu.","is_correct":true,"rendered_statement":"Một thiết bị NAS (Network Attached Storage) có thể được coi là một thiết bị mạng có chức năng lưu trữ dữ liệu."}],"answer":null,"isDirty":true,"explanation":null,"questionNumber":20,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Hãy đánh giá các phát biểu sau về các thiết bị mạng trong hệ thống mạng gia đình:"},{"type":"true-false","question":null,"main_question":"<strong></strong> Hãy đánh giá các phát biểu sau về giao thức mạng:","questionImage":null,"options":[],"optionsImage":[],"correctAnswerIndex":-1,"statements":[{"statement":"Giao thức mạng là tập hợp các quy tắc quy định cách các thiết bị giao tiếp với nhau trên mạng.","is_correct":true,"rendered_statement":"Giao thức mạng là tập hợp các quy tắc quy định cách các thiết bị giao tiếp với nhau trên mạng."},{"statement":"TCP/IP là bộ giao thức nền tảng của Internet.","is_correct":true,"rendered_statement":"TCP/IP là bộ giao thức nền tảng của Internet."},{"statement":"Giao thức HTTP được sử dụng để gửi và nhận thư điện tử.","is_correct":false,"rendered_statement":"Giao thức HTTP được sử dụng để gửi và nhận thư điện tử."},{"statement":"FTP là giao thức dùng để truyền tải tập tin giữa các máy tính.","is_correct":true,"rendered_statement":"FTP là giao thức dùng để truyền tải tập tin giữa các máy tính."}],"answer":null,"isDirty":true,"explanation":null,"questionNumber":21,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Hãy đánh giá các phát biểu sau về giao thức mạng:"},{"type":"true-false","question":null,"main_question":"<strong></strong> Hãy đánh giá các phát biểu sau về giao thức mạng:","questionImage":null,"options":[],"optionsImage":[],"correctAnswerIndex":-1,"statements":[{"statement":"SMTP là giao thức dùng để gửi thư điện tử.","is_correct":true,"rendered_statement":"SMTP là giao thức dùng để gửi thư điện tử."},{"statement":"Địa chỉ IP là một chuỗi số duy nhất để định danh một thiết bị trên mạng.","is_correct":true,"rendered_statement":"Địa chỉ IP là một chuỗi số duy nhất để định danh một thiết bị trên mạng."},{"statement":"Giao thức HTTPS không có mã hóa dữ liệu.","is_correct":false,"rendered_statement":"Giao thức HTTPS không có mã hóa dữ liệu."},{"statement":"DNS là hệ thống giúp chuyển đổi tên miền thành địa chỉ IP.","is_correct":true,"rendered_statement":"DNS là hệ thống giúp chuyển đổi tên miền thành địa chỉ IP."}],"answer":null,"isDirty":true,"explanation":null,"questionNumber":22,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Hãy đánh giá các phát biểu sau về giao thức mạng:"},{"type":"true-false","question":null,"main_question":"<strong></strong> Xem xét các nhận định dưới đây về chức năng của các tầng trong mô hình TCP/IP và cho biết chúng đúng hay sai:","questionImage":null,"options":[],"optionsImage":[],"correctAnswerIndex":-1,"statements":[{"statement":"Các giao thức như HTTP, FTP và SMTP hoạt động chủ yếu ở tầng Ứng dụng.","is_correct":true,"rendered_statement":"Các giao thức như HTTP, FTP và SMTP hoạt động chủ yếu ở tầng Ứng dụng."},{"statement":"Tầng Giao vận sử dụng các cổng (port numbers) để định danh các ứng dụng khác nhau trên cùng một máy chủ.","is_correct":true,"rendered_statement":"Tầng Giao vận sử dụng các cổng (port numbers) để định danh các ứng dụng khác nhau trên cùng một máy chủ."},{"statement":"Địa chỉ MAC được sử dụng để xác định thiết bị trong mạng cục bộ và thuộc tầng Mạng (Network Layer).","is_correct":false,"rendered_statement":"Địa chỉ MAC được sử dụng để xác định thiết bị trong mạng cục bộ và thuộc tầng Mạng (Network Layer)."},{"statement":"Giao thức UDP (User Datagram Protocol) là giao thức không hướng kết nối và không đảm bảo độ tin cậy của dữ liệu.","is_correct":true,"rendered_statement":"Giao thức UDP (User Datagram Protocol) là giao thức không hướng kết nối và không đảm bảo độ tin cậy của dữ liệu."}],"answer":null,"isDirty":true,"explanation":null,"questionNumber":23,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Xem xét các nhận định dưới đây về chức năng của các tầng trong mô hình TCP/IP và cho biết chúng đúng hay sai:"},{"type":"true-false","question":null,"main_question":"<strong></strong> Hãy đánh giá các phát biểu sau về sự khác biệt giữa các giao thức:","questionImage":null,"options":[],"optionsImage":[],"correctAnswerIndex":-1,"statements":[{"statement":"Sự khác biệt chính giữa HTTP và HTTPS là HTTPS sử dụng mã hóa SSL/TLS để bảo mật dữ liệu.","is_correct":true,"rendered_statement":"Sự khác biệt chính giữa HTTP và HTTPS là HTTPS sử dụng mã hóa SSL/TLS để bảo mật dữ liệu."},{"statement":"UDP phù hợp hơn TCP cho các ứng dụng yêu cầu tốc độ cao và chấp nhận mất mát dữ liệu nhỏ như truyền video trực tuyến.","is_correct":true,"rendered_statement":"UDP phù hợp hơn TCP cho các ứng dụng yêu cầu tốc độ cao và chấp nhận mất mát dữ liệu nhỏ như truyền video trực tuyến."},{"statement":"Giao thức IMAP cho phép người dùng đọc email trực tiếp trên máy chủ mà không cần tải về.","is_correct":true,"rendered_statement":"Giao thức IMAP cho phép người dùng đọc email trực tiếp trên máy chủ mà không cần tải về."},{"statement":"Khi một máy tính muốn gửi dữ liệu đến một máy tính khác trong cùng một mạng LAN, nó không cần địa chỉ IP.","is_correct":false,"rendered_statement":"Khi một máy tính muốn gửi dữ liệu đến một máy tính khác trong cùng một mạng LAN, nó không cần địa chỉ IP."}],"answer":null,"isDirty":true,"explanation":null,"questionNumber":24,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Hãy đánh giá các phát biểu sau về sự khác biệt giữa các giao thức:"},{"type":"true-false","question":null,"main_question":"<strong></strong> Hãy đánh giá các phát biểu sau về giao tiếp trong không gian mạng:","questionImage":null,"options":[],"optionsImage":[],"correctAnswerIndex":-1,"statements":[{"statement":"Sử dụng chữ viết hoa toàn bộ trong bình luận trực tuyến thường được hiểu là đang la hét.","is_correct":true,"rendered_statement":"Sử dụng chữ viết hoa toàn bộ trong bình luận trực tuyến thường được hiểu là đang la hét."},{"statement":"Bạn nên chia sẻ mật khẩu tài khoản mạng xã hội của mình cho bạn bè thân thiết.","is_correct":false,"rendered_statement":"Bạn nên chia sẻ mật khẩu tài khoản mạng xã hội của mình cho bạn bè thân thiết."},{"statement":"Việc kiểm tra thông tin trước khi chia sẻ là một hành vi ứng xử có trách nhiệm.","is_correct":true,"rendered_statement":"Việc kiểm tra thông tin trước khi chia sẻ là một hành vi ứng xử có trách nhiệm."},{"statement":"Mọi thông tin trên mạng xã hội đều đáng tin cậy.","is_correct":false,"rendered_statement":"Mọi thông tin trên mạng xã hội đều đáng tin cậy."}],"answer":null,"isDirty":true,"explanation":null,"questionNumber":25,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Hãy đánh giá các phát biểu sau về giao tiếp trong không gian mạng:"},{"type":"true-false","question":null,"main_question":"<strong></strong> Hãy đánh giá các phát biểu sau về giao tiếp trong không gian mạng:","questionImage":null,"options":[],"optionsImage":[],"correctAnswerIndex":-1,"statements":[{"statement":"Gửi tin nhắn hoặc bình luận quấy rối người khác trên mạng là một hành vi không phù hợp.","is_correct":true,"rendered_statement":"Gửi tin nhắn hoặc bình luận quấy rối người khác trên mạng là một hành vi không phù hợp."},{"statement":"Sử dụng các biểu tượng cảm xúc (emoji) là cách hiệu quả để thể hiện cảm xúc trong giao tiếp trực tuyến.","is_correct":true,"rendered_statement":"Sử dụng các biểu tượng cảm xúc (emoji) là cách hiệu quả để thể hiện cảm xúc trong giao tiếp trực tuyến."},{"statement":"Bạn có thể tự ý đăng ảnh của người khác lên mạng xã hội mà không cần xin phép.","is_correct":false,"rendered_statement":"Bạn có thể tự ý đăng ảnh của người khác lên mạng xã hội mà không cần xin phép."},{"statement":"Phớt lờ các quy tắc ứng xử của cộng đồng trực tuyến là điều bình thường.","is_correct":false,"rendered_statement":"Phớt lờ các quy tắc ứng xử của cộng đồng trực tuyến là điều bình thường."}],"answer":null,"isDirty":true,"explanation":null,"questionNumber":26,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Hãy đánh giá các phát biểu sau về giao tiếp trong không gian mạng:"},{"type":"true-false","question":null,"main_question":"<strong></strong> Hãy đánh giá các phát biểu sau về văn hóa ứng xử trong không gian mạng:","questionImage":null,"options":[],"optionsImage":[],"correctAnswerIndex":-1,"statements":[{"statement":"Việc lan truyền tin giả (fake news) có thể gây hậu quả nghiêm trọng cho cá nhân và xã hội.","is_correct":true,"rendered_statement":"Việc lan truyền tin giả (fake news) có thể gây hậu quả nghiêm trọng cho cá nhân và xã hội."},{"statement":"Khi tham gia các diễn đàn trực tuyến, nên đọc kỹ nội quy trước khi đăng bài.","is_correct":true,"rendered_statement":"Khi tham gia các diễn đàn trực tuyến, nên đọc kỹ nội quy trước khi đăng bài."},{"statement":"Để bảo vệ bản thân, bạn không nên chia sẻ quá nhiều thông tin cá nhân trên mạng xã hội.","is_correct":true,"rendered_statement":"Để bảo vệ bản thân, bạn không nên chia sẻ quá nhiều thông tin cá nhân trên mạng xã hội."},{"statement":"Việc sử dụng ngôn ngữ vùng miền trên mạng xã hội luôn là điều không nên.","is_correct":false,"rendered_statement":"Việc sử dụng ngôn ngữ vùng miền trên mạng xã hội luôn là điều không nên."}],"answer":null,"isDirty":true,"explanation":null,"questionNumber":27,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Hãy đánh giá các phát biểu sau về văn hóa ứng xử trong không gian mạng:"},{"type":"true-false","question":null,"main_question":"<strong></strong> Hãy đánh giá các phát biểu sau về các thách thức trong không gian mạng:","questionImage":null,"options":[],"optionsImage":[],"correctAnswerIndex":-1,"statements":[{"statement":"Phân biệt giữa thông tin chính xác và thông tin sai lệch trên mạng là một kỹ năng quan trọng cần được rèn luyện.","is_correct":true,"rendered_statement":"Phân biệt giữa thông tin chính xác và thông tin sai lệch trên mạng là một kỹ năng quan trọng cần được rèn luyện."},{"statement":"Ngôn ngữ thù ghét (hate speech) trên mạng có thể bị xử lý theo pháp luật hiện hành.","is_correct":true,"rendered_statement":"Ngôn ngữ thù ghét (hate speech) trên mạng có thể bị xử lý theo pháp luật hiện hành."},{"statement":"Tấn công mạng vào các hệ thống thông tin là hành vi vi phạm pháp luật và có thể bị phạt nặng.","is_correct":true,"rendered_statement":"Tấn công mạng vào các hệ thống thông tin là hành vi vi phạm pháp luật và có thể bị phạt nặng."},{"statement":"Khi phát hiện một hành vi vi phạm đạo đức trên mạng, bạn nên tự mình phản ứng gay gắt để răn đe.","is_correct":false,"rendered_statement":"Khi phát hiện một hành vi vi phạm đạo đức trên mạng, bạn nên tự mình phản ứng gay gắt để răn đe."}],"answer":null,"isDirty":true,"explanation":null,"questionNumber":28,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Hãy đánh giá các phát biểu sau về các thách thức trong không gian mạng:"},{"type":"essay","question":"<strong></strong> Trình bày những lợi ích mà Trí tuệ nhân tạo mang lại trong lĩnh vực giáo dục và y tế.<br><em>Đáp án/Gợi ý:</em><br>Trong giáo dục: Cá nhân hóa học tập, trợ giảng ảo, đánh giá tự động, phân tích dữ liệu học tập. Trong y tế: Chẩn đoán bệnh sớm và chính xác, phát triển thuốc mới, phẫu thuật robot, quản lý hồ sơ bệnh án.","main_question":null,"questionImage":null,"options":[],"optionsImage":[],"correctAnswerIndex":-1,"statements":[],"answer":null,"isDirty":true,"explanation":null,"questionNumber":29,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Trình bày những lợi ích mà Trí tuệ nhân tạo mang lại trong lĩnh vực giáo dục và y tế.<br><em>Đáp án/Gợi ý:</em><br>Trong giáo dục: Cá nhân hóa học tập, trợ giảng ảo, đánh giá tự động, phân tích dữ liệu học tập. Trong y tế: Chẩn đoán bệnh sớm và chính xác, phát triển thuốc mới, phẫu thuật robot, quản lý hồ sơ bệnh án."},{"type":"essay","question":"<strong></strong> Phân tích cách Trí tuệ nhân tạo có thể hỗ trợ con người trong việc giải quyết các vấn đề phức tạp trong đời sống hàng ngày, đưa ra ví dụ minh họa.<br><em>Đáp án/Gợi ý:</em><br>AI có thể xử lý lượng lớn dữ liệu, phát hiện mẫu, dự đoán và tối ưu hóa. Ví dụ: dự báo thời tiết, tối ưu hóa giao thông, quản lý năng lượng thông minh, hỗ trợ quyết định tài chính.","main_question":null,"questionImage":null,"options":[],"optionsImage":[],"correctAnswerIndex":-1,"statements":[],"answer":null,"isDirty":true,"explanation":null,"questionNumber":30,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Phân tích cách Trí tuệ nhân tạo có thể hỗ trợ con người trong việc giải quyết các vấn đề phức tạp trong đời sống hàng ngày, đưa ra ví dụ minh họa.<br><em>Đáp án/Gợi ý:</em><br>AI có thể xử lý lượng lớn dữ liệu, phát hiện mẫu, dự đoán và tối ưu hóa. Ví dụ: dự báo thời tiết, tối ưu hóa giao thông, quản lý năng lượng thông minh, hỗ trợ quyết định tài chính."},{"type":"essay","question":"<strong></strong> Thế nào là 'học máy' trong lĩnh vực Trí tuệ nhân tạo? Nêu một ví dụ về ứng dụng học máy mà bạn biết.<br><em>Đáp án/Gợi ý:</em><br>Học máy là nhánh của AI cho phép hệ thống học từ dữ liệu mà không cần được lập trình tường minh. Ví dụ: Hệ thống lọc thư rác (spam detection) học từ các email đã được đánh dấu spam trước đó để phân loại email mới.","main_question":null,"questionImage":null,"options":[],"optionsImage":[],"correctAnswerIndex":-1,"statements":[],"answer":null,"isDirty":true,"explanation":null,"questionNumber":31,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Thế nào là 'học máy' trong lĩnh vực Trí tuệ nhân tạo? Nêu một ví dụ về ứng dụng học máy mà bạn biết.<br><em>Đáp án/Gợi ý:</em><br>Học máy là nhánh của AI cho phép hệ thống học từ dữ liệu mà không cần được lập trình tường minh. Ví dụ: Hệ thống lọc thư rác (spam detection) học từ các email đã được đánh dấu spam trước đó để phân loại email mới."},{"type":"essay","question":"<strong></strong> Trình bày khái niệm về 'thị giác máy tính' và vai trò của nó trong các ứng dụng AI hiện đại.<br><em>Đáp án/Gợi ý:</em><br>Thị giác máy tính là lĩnh vực AI giúp máy tính 'nhìn' và 'hiểu' được hình ảnh, video. Vai trò: nhận diện vật thể, nhận diện khuôn mặt, xe tự lái, kiểm tra chất lượng sản phẩm trong công nghiệp, y tế (phân tích ảnh X-quang).","main_question":null,"questionImage":null,"options":[],"optionsImage":[],"correctAnswerIndex":-1,"statements":[],"answer":null,"isDirty":true,"explanation":null,"questionNumber":32,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Trình bày khái niệm về 'thị giác máy tính' và vai trò của nó trong các ứng dụng AI hiện đại.<br><em>Đáp án/Gợi ý:</em><br>Thị giác máy tính là lĩnh vực AI giúp máy tính 'nhìn' và 'hiểu' được hình ảnh, video. Vai trò: nhận diện vật thể, nhận diện khuôn mặt, xe tự lái, kiểm tra chất lượng sản phẩm trong công nghiệp, y tế (phân tích ảnh X-quang)."},{"type":"essay","question":"<strong></strong> Trình bày vai trò của giao thức TCP/IP trong hoạt động của Internet.<br><em>Đáp án/Gợi ý:</em><br>TCP/IP là bộ giao thức nền tảng, cho phép các thiết bị kết nối và trao đổi thông tin trên Internet. TCP đảm bảo truyền tải dữ liệu tin cậy, còn IP chịu trách nhiệm định tuyến gói tin qua các mạng khác nhau.","main_question":null,"questionImage":null,"options":[],"optionsImage":[],"correctAnswerIndex":-1,"statements":[],"answer":null,"isDirty":true,"explanation":null,"questionNumber":33,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Trình bày vai trò của giao thức TCP/IP trong hoạt động của Internet.<br><em>Đáp án/Gợi ý:</em><br>TCP/IP là bộ giao thức nền tảng, cho phép các thiết bị kết nối và trao đổi thông tin trên Internet. TCP đảm bảo truyền tải dữ liệu tin cậy, còn IP chịu trách nhiệm định tuyến gói tin qua các mạng khác nhau."},{"type":"essay","question":"<strong></strong> Nêu các chức năng chính của giao thức HTTP và HTTPS. Tại sao HTTPS được khuyến nghị sử dụng hơn HTTP?<br><em>Đáp án/Gợi ý:</em><br>HTTP: giao thức truyền siêu văn bản, dùng để truy cập web. HTTPS: tương tự HTTP nhưng có thêm lớp bảo mật SSL/TLS. HTTPS được khuyến nghị vì nó mã hóa dữ liệu, bảo vệ thông tin người dùng khỏi bị đánh cắp hoặc sửa đổi.","main_question":null,"questionImage":null,"options":[],"optionsImage":[],"correctAnswerIndex":-1,"statements":[],"answer":null,"isDirty":true,"explanation":null,"questionNumber":34,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Nêu các chức năng chính của giao thức HTTP và HTTPS. Tại sao HTTPS được khuyến nghị sử dụng hơn HTTP?<br><em>Đáp án/Gợi ý:</em><br>HTTP: giao thức truyền siêu văn bản, dùng để truy cập web. HTTPS: tương tự HTTP nhưng có thêm lớp bảo mật SSL/TLS. HTTPS được khuyến nghị vì nó mã hóa dữ liệu, bảo vệ thông tin người dùng khỏi bị đánh cắp hoặc sửa đổi."},{"type":"essay","question":"<strong></strong> Địa chỉ IP là gì? Kể tên hai loại địa chỉ IP phổ biến và giải thích sự khác biệt cơ bản giữa chúng.<br><em>Đáp án/Gợi ý:</em><br>Địa chỉ IP là một chuỗi số duy nhất để định danh một thiết bị trên mạng. Hai loại phổ biến: IPv4 (ví dụ: 192.168.1.1) và IPv6 (ví dụ: 2001:0db8::1). Khác biệt: IPv4 dùng 32 bit, số lượng hạn chế; IPv6 dùng 128 bit, cung cấp số lượng địa chỉ lớn hơn rất nhiều để đáp ứng sự phát triển của Internet.","main_question":null,"questionImage":null,"options":[],"optionsImage":[],"correctAnswerIndex":-1,"statements":[],"answer":null,"isDirty":true,"explanation":null,"questionNumber":35,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Địa chỉ IP là gì? Kể tên hai loại địa chỉ IP phổ biến và giải thích sự khác biệt cơ bản giữa chúng.<br><em>Đáp án/Gợi ý:</em><br>Địa chỉ IP là một chuỗi số duy nhất để định danh một thiết bị trên mạng. Hai loại phổ biến: IPv4 (ví dụ: 192.168.1.1) và IPv6 (ví dụ: 2001:0db8::1). Khác biệt: IPv4 dùng 32 bit, số lượng hạn chế; IPv6 dùng 128 bit, cung cấp số lượng địa chỉ lớn hơn rất nhiều để đáp ứng sự phát triển của Internet."},{"type":"essay","question":"<strong></strong> Giải thích khái niệm 'tên miền' và vai trò của hệ thống DNS trong việc truy cập các trang web.<br><em>Đáp án/Gợi ý:</em><br>Tên miền là tên dễ nhớ dùng để đại diện cho địa chỉ IP của một trang web (ví dụ: google.com). Hệ thống DNS (Domain Name System) có vai trò như một 'cuốn danh bạ' của Internet, dịch tên miền thành địa chỉ IP tương ứng để máy tính có thể tìm và kết nối đến máy chủ web đó.","main_question":null,"questionImage":null,"options":[],"optionsImage":[],"correctAnswerIndex":-1,"statements":[],"answer":null,"isDirty":true,"explanation":null,"questionNumber":36,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Giải thích khái niệm 'tên miền' và vai trò của hệ thống DNS trong việc truy cập các trang web.<br><em>Đáp án/Gợi ý:</em><br>Tên miền là tên dễ nhớ dùng để đại diện cho địa chỉ IP của một trang web (ví dụ: google.com). Hệ thống DNS (Domain Name System) có vai trò như một 'cuốn danh bạ' của Internet, dịch tên miền thành địa chỉ IP tương ứng để máy tính có thể tìm và kết nối đến máy chủ web đó."},{"type":"essay","question":"<strong></strong> Nêu các bước cơ bản để chia sẻ một thư mục trên hệ điều hành Windows cho các máy tính khác trong cùng mạng LAN.<br><em>Đáp án/Gợi ý:</em><br>1. Đảm bảo máy tính nằm trong cùng nhóm làm việc (Workgroup) và tính năng chia sẻ mạng đã được bật. 2. Chuột phải vào thư mục muốn chia sẻ, chọn 'Properties'. 3. Chuyển sang tab 'Sharing', chọn 'Advanced Sharing...'. 4. Tích vào 'Share this folder' và đặt tên chia sẻ. 5. Chọn 'Permissions' để cấp quyền truy cập (Full Control, Change, Read) cho người dùng hoặc nhóm cụ thể. 6. Áp dụng các thay đổi.","main_question":null,"questionImage":null,"options":[],"optionsImage":[],"correctAnswerIndex":-1,"statements":[],"answer":null,"isDirty":true,"explanation":null,"questionNumber":37,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Nêu các bước cơ bản để chia sẻ một thư mục trên hệ điều hành Windows cho các máy tính khác trong cùng mạng LAN.<br><em>Đáp án/Gợi ý:</em><br>1. Đảm bảo máy tính nằm trong cùng nhóm làm việc (Workgroup) và tính năng chia sẻ mạng đã được bật. 2. Chuột phải vào thư mục muốn chia sẻ, chọn 'Properties'. 3. Chuyển sang tab 'Sharing', chọn 'Advanced Sharing...'. 4. Tích vào 'Share this folder' và đặt tên chia sẻ. 5. Chọn 'Permissions' để cấp quyền truy cập (Full Control, Change, Read) cho người dùng hoặc nhóm cụ thể. 6. Áp dụng các thay đổi."},{"type":"essay","question":"<strong></strong> Giải thích tại sao việc đặt mật khẩu bảo vệ khi chia sẻ tài nguyên trên mạng lại quan trọng. Nếu không đặt mật khẩu, có rủi ro gì?<br><em>Đáp án/Gợi ý:</em><br>Đặt mật khẩu giúp bảo vệ tài nguyên khỏi truy cập trái phép. Rủi ro nếu không đặt mật khẩu: bất kỳ ai trong mạng cũng có thể xem, chỉnh sửa, xóa dữ liệu, gây mất mát thông tin, lộ bí mật cá nhân/công ty, hoặc lây nhiễm mã độc.","main_question":null,"questionImage":null,"options":[],"optionsImage":[],"correctAnswerIndex":-1,"statements":[],"answer":null,"isDirty":true,"explanation":null,"questionNumber":38,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Giải thích tại sao việc đặt mật khẩu bảo vệ khi chia sẻ tài nguyên trên mạng lại quan trọng. Nếu không đặt mật khẩu, có rủi ro gì?<br><em>Đáp án/Gợi ý:</em><br>Đặt mật khẩu giúp bảo vệ tài nguyên khỏi truy cập trái phép. Rủi ro nếu không đặt mật khẩu: bất kỳ ai trong mạng cũng có thể xem, chỉnh sửa, xóa dữ liệu, gây mất mát thông tin, lộ bí mật cá nhân/công ty, hoặc lây nhiễm mã độc."},{"type":"essay","question":"<strong></strong> Hãy trình bày cách bạn có thể truy cập một máy in được chia sẻ trên mạng từ một máy tính khác trong cùng mạng LAN.<br><em>Đáp án/Gợi ý:</em><br>1. Đảm bảo máy tính có máy in được chia sẻ đã bật tính năng chia sẻ máy in. 2. Trên máy tính muốn kết nối, vào 'Settings' (Cài đặt) -&gt; 'Devices' (Thiết bị) -&gt; 'Printers &amp; scanners' (Máy in và máy quét). 3. Chọn 'Add a printer or scanner' (Thêm máy in hoặc máy quét). 4. Chọn 'The printer that I want isn't listed' (Máy in tôi muốn không có trong danh sách). 5. Chọn 'Select a shared printer by name' và nhập đường dẫn mạng của máy in (ví dụ: \\\\TEN_MAY_TINH_CHIA_SE\\TEN_MAY_IN). 6. Thực hiện theo hướng dẫn để cài đặt driver.","main_question":null,"questionImage":null,"options":[],"optionsImage":[],"correctAnswerIndex":-1,"statements":[],"answer":null,"isDirty":true,"explanation":null,"questionNumber":39,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Hãy trình bày cách bạn có thể truy cập một máy in được chia sẻ trên mạng từ một máy tính khác trong cùng mạng LAN.<br><em>Đáp án/Gợi ý:</em><br>1. Đảm bảo máy tính có máy in được chia sẻ đã bật tính năng chia sẻ máy in. 2. Trên máy tính muốn kết nối, vào 'Settings' (Cài đặt) -&gt; 'Devices' (Thiết bị) -&gt; 'Printers &amp; scanners' (Máy in và máy quét). 3. Chọn 'Add a printer or scanner' (Thêm máy in hoặc máy quét). 4. Chọn 'The printer that I want isn't listed' (Máy in tôi muốn không có trong danh sách). 5. Chọn 'Select a shared printer by name' và nhập đường dẫn mạng của máy in (ví dụ: \\\\TEN_MAY_TINH_CHIA_SE\\TEN_MAY_IN). 6. Thực hiện theo hướng dẫn để cài đặt driver."},{"type":"essay","question":"<strong></strong> Nêu một tình huống thực tế mà việc chia sẻ tài nguyên trên mạng mang lại lợi ích rõ rệt. Phân tích lợi ích đó.<br><em>Đáp án/Gợi ý:</em><br>Tình huống: Một nhóm học sinh đang làm việc chung trên một dự án và cần truy cập cùng một bộ tài liệu tham khảo. Lợi ích: Thay vì mỗi người phải sao chép tài liệu, giáo viên hoặc một bạn có thể chia sẻ thư mục chứa tài liệu trên mạng. Các bạn khác có thể truy cập trực tiếp từ máy tính của mình, đảm bảo mọi người đều có phiên bản tài liệu mới nhất, tiết kiệm thời gian và công sức, dễ dàng cộng tác.","main_question":null,"questionImage":null,"options":[],"optionsImage":[],"correctAnswerIndex":-1,"statements":[],"answer":null,"isDirty":true,"explanation":null,"questionNumber":40,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"<strong></strong> Nêu một tình huống thực tế mà việc chia sẻ tài nguyên trên mạng mang lại lợi ích rõ rệt. Phân tích lợi ích đó.<br><em>Đáp án/Gợi ý:</em><br>Tình huống: Một nhóm học sinh đang làm việc chung trên một dự án và cần truy cập cùng một bộ tài liệu tham khảo. Lợi ích: Thay vì mỗi người phải sao chép tài liệu, giáo viên hoặc một bạn có thể chia sẻ thư mục chứa tài liệu trên mạng. Các bạn khác có thể truy cập trực tiếp từ máy tính của mình, đảm bảo mọi người đều có phiên bản tài liệu mới nhất, tiết kiệm thời gian và công sức, dễ dàng cộng tác."}];
        const options = {"title":"Bài kiểm tra - 27/11/2025","timeLimit":45,"retriesAllowed":1,"showAnswers":true,"showExplanation":true,"aiAssessment":true,"shortAnswerFormat":"freeform","examCode":"1S3NZM","teacherName":"Giáo viên","scoring":{"mc":5,"tf":2,"sa":2,"essay":1,"tfMethod":"progressive"}};
        const googleScriptUrl = "https://script.google.com/macros/s/AKfycbzAhhPPCUgw-uU55gOj87Tm16ugz8FuBlRwQ7sECOBiOWBC8n6SI2mt_mQblXdoCdje/exec";
        const examCode = "1S3NZM";
        
        let userAnswers = new Array(quizData.length).fill(null);
        let studentName = '';
        let studentClass = '';
        let timerInterval;
        let timeRemaining = options.timeLimit * 60;
        let retriesCount = 0;
        let submissionStatus = 'pending';
        let monitoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0 };
        let lastScore, lastAnswerDetails; // For retrying AI assessment

        // --- UTILS FOR SHUFFLING ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function mapType(typeStr) {
             if (!typeStr) return 'multiple-choice';
             if (typeStr.startsWith('mc-') || ['cloze-test', 'sentence-ordering', 'multiple-choice', 'paragraph-sentence-ordering'].includes(typeStr)) return 'multiple-choice';
             if (typeStr.startsWith('tf-') || typeStr === 'true-false') return 'true-false';
             if (typeStr === 'short-answer' || typeStr === 'sentence-transformation') return 'short-answer';
             return 'essay';
        }

        // --- SHUFFLE LOGIC FOR ONLINE QUIZ ---
        function applyShuffling() {
            // 1. Shuffle Options/Statements within each question
            quizData.forEach(item => {
                const shuffleOpts = item.shuffleOptions || { answers: true };
                const type = mapType(item.type);
                
                if (shuffleOpts.answers) {
                    if (type === 'multiple-choice' && item.rendered_options && item.rendered_options.length > 0) {
                        // Create indices array to shuffle
                        const indices = item.rendered_options.map((_, i) => i);
                        shuffleArray(indices);
                        
                        // Reorder rendered_options based on shuffled indices
                        item.rendered_options = indices.map(i => item.rendered_options[i]);
                        
                        // Reorder raw options (needed for review/explanation context, though mostly rendered is used)
                        if (item.options) {
                            item.options = indices.map(i => item.options[i]);
                        }
                        
                        // Update correctAnswerIndex
                        // Old index was item.correctAnswerIndex. We need to find where it went.
                        // New index is the position of the old correct index in the shuffled 'indices' array.
                        item.correctAnswerIndex = indices.indexOf(item.correctAnswerIndex);

                    } else if (type === 'true-false' && item.statements && item.statements.length > 0) {
                        // Shuffle statements array directly
                        shuffleArray(item.statements);
                    }
                }
            });

            // 2. Shuffle Question Order within Parts (respecting "Câu dẫn" aka Stem shuffle option)
            // We group questions by type first to ensure we don't mix sections
            const groupedQuestions = quizData.reduce((acc, q, index) => {
                const type = mapType(q.type);
                if (!acc[type]) acc[type] = [];
                acc[type].push({ ...q, originalIndex: index });
                return acc;
            }, {});
            
            const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
            let newQuizData = [];

            partOrder.forEach(partType => {
                const questions = groupedQuestions[partType];
                if (questions) {
                    const finalPartQuestions = new Array(questions.length).fill(null);
                    const shufflableQuestions = [];
                    
                    // Separate fixed and shufflable questions
                    questions.forEach((q, i) => {
                        const shuffleOpts = q.shuffleOptions || { stem: true };
                        if (shuffleOpts.stem) {
                            shufflableQuestions.push(q);
                        } else {
                            finalPartQuestions[i] = q;
                        }
                    });

                    // Shuffle the shufflable ones
                    shuffleArray(shufflableQuestions);

                    // Merge back
                    let shufflableIndex = 0;
                    for (let i = 0; i < finalPartQuestions.length; i++) {
                        if (finalPartQuestions[i] === null) {
                            finalPartQuestions[i] = shufflableQuestions[shufflableIndex];
                            shufflableIndex++;
                        }
                    }
                    newQuizData = newQuizData.concat(finalPartQuestions);
                }
            });
            
            // Update the global quizData with the shuffled version
            if (newQuizData.length === quizData.length) {
                quizData = newQuizData;
            }
            
            // Reset user answers array to match new length (though length is same) and clear it
            userAnswers = new Array(quizData.length).fill(null);
        }
        
        // --- FALLBACK MODELS CONFIGURATION ---
        const GEMINI_MODELS_FALLBACK = [
          "gemini-2.5-flash",
          "gemini-2.5-flash-lite",
          "gemini-2.0-flash",
          "gemini-2.0-flash-lite",
          "gemini-2.5-pro",
          "gemini-1.5-pro",
          "gemini-1.5-flash"
        ];

        // --- FALLBACK API FUNCTION FOR CLIENT (STUDENT VIEW) ---
        async function generateContentWithFallback(ai, contents, preferredModel = "gemini-2.5-flash") {
            if (!ai) throw new Error("AI instance not provided.");
            
            const uniqueModels = [...new Set([preferredModel, ...GEMINI_MODELS_FALLBACK])];
            
            let lastError;
            for (const model of uniqueModels) {
                try {
                    const response = await ai.models.generateContent({
                        model: model,
                        contents: contents
                    });
                    return response;
                } catch (error) {
                    console.warn('Model failed:', model, error);
                    lastError = error;
                    const errStr = error.toString().toLowerCase();
                    if (errStr.includes("429") || errStr.includes("quota") || errStr.includes("exhausted") || 
                        errStr.includes("503") || errStr.includes("overloaded") || errStr.includes("500") || 
                        errStr.includes("internal") || errStr.includes("resource") || errStr.includes("not found")) {
                        continue;
                    }
                     continue;
                }
            }
            throw lastError || new Error("Tất cả các mô hình AI đều bận hoặc gặp sự cố. Vui lòng thử lại sau.");
        }

        const welcomeScreen = document.getElementById('welcome-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const resultsScreen = document.getElementById('results-screen');
        const startBtn = document.getElementById('start-btn');
        const nameInput = document.getElementById('name');
        const classInput = document.getElementById('class');
        const timerEl = document.getElementById('timer');
        const submitBtn = document.getElementById('submit-btn');
        const submitBtnTop = document.getElementById('submit-btn-top');
        const scoreDisplay = document.getElementById('score-display');
        const assessmentDisplay = document.getElementById('assessment-display');
        const reviewContainer = document.getElementById('review-container');
        const retryBtn = document.getElementById('retry-btn');
        const restartBtn = document.getElementById('restart-btn');
        const warningEl = document.getElementById('monitoring-warning');
        const progressBar = document.getElementById('progress-bar');
        const progressContainer = document.getElementById('progress-container');
        const toggleNavBtn = document.getElementById('toggle-nav-btn');
        const navPanel = document.getElementById('nav-panel');
        const navGrid = document.getElementById('nav-grid');

        window.selectOption = selectOption;
        window.selectTFOption = selectTFOption;
        window.saveTextAnswer = saveTextAnswer;
        window.toggleExplanation = toggleExplanation;
        window.fetchAndRenderExplanation = fetchAndRenderExplanation;
        window.retryAIAssessment = retryAIAssessment;
        window.setupFormInputs = setupFormInputs;
        window.saveFormAnswer = saveFormAnswer;
        window.scrollToQuestion = scrollToQuestion;

        startBtn.addEventListener('click', startQuiz);
        submitBtn.addEventListener('click', confirmSubmit);
        submitBtnTop.addEventListener('click', confirmSubmit);
        retryBtn.addEventListener('click', retryQuiz);
        restartBtn.addEventListener('click', () => window.location.reload());
        
        toggleNavBtn.addEventListener('click', () => {
            navPanel.classList.toggle('open');
            document.body.classList.toggle('nav-open');
        });

        nameInput.value = localStorage.getItem('studentName') || '';
        classInput.value = localStorage.getItem('studentClass') || '';
        
        function safeTypeset(elements) {
            if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                window.MathJax.typesetPromise(elements).catch(function (err) {
                    console.error('MathJax error: ' + err.message);
                });
            }
        }
        
        function startQuiz() {
            studentName = nameInput.value.trim();
            studentClass = classInput.value.trim();
            if (!studentName || !studentClass) {
                alert('Vui lòng nhập đầy đủ Họ và tên và Lớp.');
                return;
            }
            localStorage.setItem('studentName', studentName);
            localStorage.setItem('studentClass', studentClass);
            
            document.getElementById('student-name-display').textContent = studentName;

            applyShuffling();
            
            welcomeScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            resultsScreen.classList.add('hidden');
            progressContainer.classList.remove('hidden');
            toggleNavBtn.classList.remove('hidden');
            
            if (window.innerWidth > 1024) {
                navPanel.classList.add('open');
                document.body.classList.add('nav-open');
            }

            userAnswers = new Array(quizData.length).fill(null);
            submissionStatus = 'pending';
            
            renderAllQuestions();
            renderNavPanel();
            updateProgress();
            
            if (options.timeLimit > 0) {
                timeRemaining = options.timeLimit * 60;
                startTimer();
            } else {
                timerEl.textContent = '∞';
            }
            startMonitoring();
        }

        function renderNavPanel() {
            navGrid.innerHTML = '';
            quizData.forEach((_, index) => {
                const btn = document.createElement('button');
                btn.className = 'nav-btn';
                btn.id = `nav-btn-${index}`;
                btn.textContent = index + 1;
                btn.onclick = () => scrollToQuestion(index);
                navGrid.appendChild(btn);
            });
        }

        function scrollToQuestion(index) {
            const el = document.getElementById(`q-${index}`);
            if (el) {
                const offset = 100; 
                const elementPosition = el.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - offset;
                window.scrollTo({ top: offsetPosition, behavior: "smooth" });
                
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('current'));
                document.getElementById(`nav-btn-${index}`)?.classList.add('current');
            }
            if (window.innerWidth <= 1024) {
                navPanel.classList.remove('open');
                document.body.classList.remove('nav-open');
            }
        }

        function updateProgress() {
            let answeredCount = 0;
            quizData.forEach((item, index) => {
                const answer = userAnswers[index];
                const type = mapType(item.type);
                let isAnswered = false;

                if (type === 'multiple-choice') {
                    isAnswered = answer !== null;
                } else if (type === 'true-false') {
                    isAnswered = Array.isArray(answer) && answer.filter(x => x !== null).length === item.statements.length;
                } else { 
                    isAnswered = answer && String(answer).trim().length > 0;
                }

                const btn = document.getElementById(`nav-btn-${index}`);
                if (isAnswered) {
                    answeredCount++;
                    btn?.classList.add('answered');
                } else {
                    btn?.classList.remove('answered');
                }
            });

            const percent = Math.round((answeredCount / quizData.length) * 100);
            progressBar.style.width = `${percent}%`;
        }
        
        function renderAllQuestions() {
            const container = document.getElementById('all-questions-container');
            let allHTML = '';

            const groupedQuestions = quizData.reduce((acc, q) => {
                const type = mapType(q.type);
                if (!acc[type]) acc[type] = [];
                acc[type].push(q);
                return acc;
            }, {});

            const groupInfo = {
                'multiple-choice': { title: 'PHẦN I. TRẮC NGHIỆM NHIỀU LỰA CHỌN', color: 'blue' },
                'true-false': { title: 'PHẦN II. TRẮC NGHIỆM ĐÚNG/SAI', color: 'purple' },
                'short-answer': { title: 'PHẦN III. TRẢ LỜI NGẮN', color: 'teal' },
                'essay': { title: 'PHẦN IV. TỰ LUẬN', color: 'orange' },
            };
            
            let questionCounter = 0;
            const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];

            partOrder.forEach(partType => {
                const questions = groupedQuestions[partType];
                if (!questions || questions.length === 0) return;

                const info = groupInfo[partType];
                allHTML += `
                    <div class="mb-6 pb-2 border-b-2 border-${info.color}-200 flex items-center gap-2">
                        <span class="bg-${info.color}-100 text-${info.color}-700 p-1.5 rounded-md">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                            </svg>
                        </span>
                        <h2 class="text-xl md:text-2xl font-bold text-gray-800">${info.title}</h2>
                    </div>`;
                
                questions.forEach((item) => {
                    const index = quizData.indexOf(item);
                    questionCounter++;
                    
                    let contentHTML = `<div class="question-card mb-8 p-6 border border-gray-200 bg-white rounded-2xl shadow-sm hover:shadow-md transition-shadow scroll-mt-32" id="q-${index}">`;
                    contentHTML += `
                        <div class="flex items-start gap-3 mb-4">
                             <span class="bg-gray-100 text-gray-700 font-bold px-3 py-1 rounded-lg text-sm shadow-sm">Câu ${questionCounter}</span>
                        </div>
                    `;
                    contentHTML += `<div class="prose max-w-none text-gray-800 mb-6 font-medium text-lg leading-relaxed">${item.rendered_question || ''}</div>`;

                    let answerHTML = '';
                    const savedAnswer = userAnswers[index];
                    const type = mapType(item.type);
                    
                    if (type === 'multiple-choice') {
                        answerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;
                        (item.rendered_options || []).forEach((opt, i) => {
                            const isSelected = savedAnswer === i;
                            answerHTML += `
                                <div class="option ${isSelected ? 'selected' : ''} p-4 border border-gray-200 rounded-xl cursor-pointer flex items-start gap-3 hover:bg-gray-50" data-q-index="${index}" data-opt-index="${i}" onclick="selectOption(this, ${index}, ${i})">
                                    <div class="flex-shrink-0 w-8 h-8 rounded-full border-2 ${isSelected ? 'border-indigo-600 bg-indigo-600 text-white' : 'border-gray-300 text-gray-500'} flex items-center justify-center font-bold text-sm transition-colors">${String.fromCharCode(65 + i)}</div>
                                    <div class="flex-grow pt-1 text-gray-700">${opt}</div>
                                </div>`;
                        });
                        answerHTML += `</div>`;
                    } else if (type === 'true-false') {
                         answerHTML = `<div class="space-y-3">`;
                         (item.statements || []).forEach((stmt, i) => {
                            const savedStmtAnswer = savedAnswer ? savedAnswer[i] : null;
                            const isTrueSelected = savedStmtAnswer === true;
                            const isFalseSelected = savedStmtAnswer === false;
                            answerHTML += `<div class="p-4 border border-gray-200 rounded-xl bg-gray-50 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                                                <div class="flex-grow flex gap-3">
                                                    <span class="font-bold text-gray-500">${String.fromCharCode(97 + i)})</span>
                                                    <div class="prose max-w-none text-gray-700">${stmt.rendered_statement}</div>
                                                </div>
                                                <div class="flex-shrink-0 flex gap-2 self-end sm:self-auto">
                                                    <button class="${isTrueSelected ? 'bg-blue-600 text-white shadow-md ring-2 ring-blue-300' : 'bg-white text-gray-600 border border-gray-300 hover:bg-blue-50'} px-5 py-2 rounded-lg font-semibold transition-all" onclick="selectTFOption(this, ${index}, ${i}, true)">Đúng</button>
                                                    <button class="${isFalseSelected ? 'bg-red-500 text-white shadow-md ring-2 ring-red-300' : 'bg-white text-gray-600 border border-gray-300 hover:bg-red-50'} px-5 py-2 rounded-lg font-semibold transition-all" onclick="selectTFOption(this, ${index}, ${i}, false)">Sai</button>
                                                </div>
                                            </div>`;
                        });
                        answerHTML += `</div>`;
                    } else if (type === 'short-answer') {
                        const savedAnswerStr = userAnswers[index] || '';
                        if (options.shortAnswerFormat === 'form') {
                             answerHTML = `<div id="sa-form-${index}" class="flex items-center gap-3 p-4 bg-teal-50 rounded-xl border border-teal-100">`;
                            for (let i = 0; i < 4; i++) {
                                answerHTML += `<input type="text" maxlength="1" data-q-index="${index}" class="w-12 h-14 text-center text-2xl font-bold border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring focus:ring-teal-200 focus:outline-none bg-white shadow-sm transition-all" value="">`;
                            }
                            answerHTML += `</div>`;
                        } else {
                            answerHTML = `<input type="text" class="w-full border-gray-300 rounded-xl p-4 shadow-sm focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all text-lg" placeholder="Nhập câu trả lời của bạn..." value="${savedAnswerStr}" onchange="saveTextAnswer(this, ${index})">`;
                        }
                    } else if (type === 'essay') {
                        answerHTML = `<textarea class="w-full border-gray-300 rounded-xl p-4 shadow-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all" rows="6" placeholder="Nhập bài làm tự luận..." onchange="saveTextAnswer(this, ${index})">${savedAnswer || ''}</textarea>`;
                    }

                    contentHTML += answerHTML + '</div>';
                    allHTML += contentHTML;
                });
            });
            container.innerHTML = allHTML;

            document.querySelectorAll('[id^="sa-form-"]').forEach(formContainer => {
                const inputs = formContainer.querySelectorAll('input');
                if (inputs.length > 0) {
                    setupFormInputs(inputs);
                }
            });

            safeTypeset([container]);
        }

        function setupFormInputs(inputs) {
            const qIndex = inputs[0].dataset.qIndex;
            inputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    if (e.target.value && index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }
                    saveFormAnswer(qIndex, inputs);
                });

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        inputs[index - 1].focus();
                    }
                     saveFormAnswer(qIndex, inputs);
                });
                 input.addEventListener('change', () => saveFormAnswer(qIndex, inputs));
            });
        }

        function saveFormAnswer(qIndex, inputs) {
            let combinedValue = '';
            inputs.forEach(inp => { combinedValue += inp.value; });
            userAnswers[qIndex] = combinedValue;
            updateProgress();
        }

        function selectOption(element, qIndex, optIndex) {
            userAnswers[qIndex] = optIndex;
            const questionCard = document.getElementById(`q-${qIndex}`);
            questionCard.querySelectorAll('.option').forEach(opt => {
                opt.classList.remove('selected');
                opt.querySelector('div:first-child').classList.remove('border-indigo-600', 'bg-indigo-600', 'text-white');
                opt.querySelector('div:first-child').classList.add('border-gray-300', 'text-gray-500');
            });
            element.classList.add('selected');
            element.querySelector('div:first-child').classList.remove('border-gray-300', 'text-gray-500');
            element.querySelector('div:first-child').classList.add('border-indigo-600', 'bg-indigo-600', 'text-white');
            updateProgress();
        }
        
        function selectTFOption(button, qIndex, stmtIndex, answer) {
            if (!userAnswers[qIndex] || !Array.isArray(userAnswers[qIndex])) {
                userAnswers[qIndex] = new Array(quizData[qIndex].statements.length).fill(null);
            }
            userAnswers[qIndex][stmtIndex] = answer;
            const parent = button.parentElement;
            
            // Reset styles
            const trueBtn = parent.children[0];
            const falseBtn = parent.children[1];
            
            trueBtn.className = 'bg-white text-gray-600 border border-gray-300 hover:bg-blue-50 px-5 py-2 rounded-lg font-semibold transition-all';
            falseBtn.className = 'bg-white text-gray-600 border border-gray-300 hover:bg-red-50 px-5 py-2 rounded-lg font-semibold transition-all';

            if (answer) {
                trueBtn.className = 'bg-blue-600 text-white shadow-md ring-2 ring-blue-300 px-5 py-2 rounded-lg font-semibold transition-all';
            } else {
                falseBtn.className = 'bg-red-500 text-white shadow-md ring-2 ring-red-300 px-5 py-2 rounded-lg font-semibold transition-all';
            }
            updateProgress();
        }
        
        function saveTextAnswer(element, qIndex) {
            userAnswers[qIndex] = element.value;
            updateProgress();
        }

        function confirmSubmit() {
            const unansweredQuestions = userAnswers.map((answer, index) => ({ answer, index }))
                                                .filter(item => item.answer === null || 
                                                                (Array.isArray(item.answer) && item.answer.some(a => a === null)));

            let message = "Bạn có chắc chắn muốn nộp bài không?";
            if (unansweredQuestions.length > 0) {
                message = `Bạn còn ${unansweredQuestions.length} câu chưa hoàn thành. Bạn có chắc chắn muốn nộp bài không?`;
            }

            if (confirm(message)) {
                submitQuiz();
            }
        }

        async function submitQuiz() {
            if (submissionStatus !== 'pending') return;
            submissionStatus = 'submitting';
            stopTimer();
            stopMonitoring();
            
            const submitBtnEl = document.getElementById('submit-btn');
            submitBtnEl.disabled = true;
            submitBtnEl.innerHTML = '<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Đang nộp bài...';
            
            progressContainer.classList.add('hidden');
            toggleNavBtn.classList.add('hidden');
            navPanel.classList.remove('open');
            document.body.classList.remove('nav-open');

            const { score, totalPossibleScore, answerDetails } = calculateScore();
            lastScore = score;
            lastAnswerDetails = answerDetails;
            const finalScore = (totalPossibleScore > 0 ? (score / totalPossibleScore * 10) : 0).toFixed(2);
            let aiAssessment = 'Không có';

            if (options.aiAssessment) {
                aiAssessment = await getAIAssessment(finalScore, answerDetails);
            }
            
            const submissionData = new FormData();
            submissionData.append('timestamp', new Date().toLocaleString('vi-VN'));
            submissionData.append('name', studentName);
            submissionData.append('class', studentClass);
            submissionData.append('score', finalScore);
            submissionData.append('assessment', aiAssessment);
            submissionData.append('examCode', examCode);
            submissionData.append('monitoringLog', JSON.stringify(monitoringLog));
            submissionData.append('answerDetails', JSON.stringify(answerDetails));
            
            if (googleScriptUrl) {
                try {
                    await fetch(googleScriptUrl, { method: 'POST', body: new URLSearchParams(submissionData) });
                } catch (error) {
                    console.error('Error submitting to Google Script:', error);
                    alert('Lỗi: Không thể nộp kết quả lên hệ thống. Vui lòng kiểm tra lại kết nối mạng và thử lại.');
                }
            }
            submissionStatus = 'submitted';
            showResults(finalScore, aiAssessment, answerDetails);
        }
        
        function showResults(score, assessment, answerDetails) {
            quizScreen.classList.add('hidden');
            resultsScreen.classList.remove('hidden');
            
            // Trigger Confetti
            confetti({
                particleCount: 150,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#6366f1', '#8b5cf6', '#ec4899', '#14b8a6']
            });
            
            if (options.showAnswers) {
                const scoreDisplay = document.getElementById('score-display');
                scoreDisplay.querySelector('span:last-child').textContent = score;
                scoreDisplay.classList.remove('hidden');
            } else {
                const scoreDisplay = document.getElementById('score-display');
                scoreDisplay.innerHTML = '<p class="text-3xl text-center text-green-600 font-bold mb-4">Nộp bài thành công!</p><p class="text-gray-500">Kết quả đã được ghi nhận.</p>';
                scoreDisplay.classList.remove('hidden');
            }
            
            if (options.aiAssessment) {
                if (assessment.startsWith("Lỗi")) {
                    // handled
                } else {
                     document.querySelector('#assessment-display .assessment-content').innerHTML = assessment.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                     assessmentDisplay.classList.remove('hidden');
                }
            } else {
                assessmentDisplay.classList.add('hidden');
            }
            
            if (options.showAnswers) {
                renderReview(answerDetails);
            } else {
                reviewContainer.innerHTML = '<div class="text-center p-8 bg-gray-50 rounded-xl border border-gray-200"><p class="text-gray-600">Giáo viên đã chọn không hiển thị đáp án và giải thích chi tiết.</p></div>';
            }
            
            if (retriesCount < options.retriesAllowed) retryBtn.classList.remove('hidden');
        }

        function calculateScore() {
            let score = 0;
            let totalPossibleScore = 0;
            const answerDetails = [];
            
            const mcCount = quizData.filter(q => mapType(q.type) === 'multiple-choice').length;
            const tfCount = quizData.filter(q => mapType(q.type) === 'true-false').length;
            const saCount = quizData.filter(q => mapType(q.type) === 'short-answer').length;

            const pointsPerMc = mcCount > 0 ? options.scoring.mc / mcCount : 0;
            const pointsPerTf = tfCount > 0 ? options.scoring.tf / tfCount : 0;
            const pointsPerSa = saCount > 0 ? options.scoring.sa / saCount : 0;
            
            totalPossibleScore = (options.scoring.mc || 0) + (options.scoring.tf || 0) + (options.scoring.sa || 0) + (options.scoring.essay || 0);
            if (totalPossibleScore === 0 && (mcCount + tfCount + saCount > 0)) {
                 totalPossibleScore = (pointsPerMc * mcCount) + (pointsPerTf * tfCount) + (pointsPerSa * saCount);
            }
            if (totalPossibleScore === 0 && quizData.length > 0) totalPossibleScore = 10; 

            quizData.forEach((item, index) => {
                const userAnswer = userAnswers[index];
                let isCorrect = false;
                let detail = null;
                const type = mapType(item.type);

                if (type === 'multiple-choice') {
                    isCorrect = userAnswer === item.correctAnswerIndex;
                    if(isCorrect) score += pointsPerMc;
                } else if (type === 'true-false') {
                    let correctStatements = 0;
                    detail = [];
                    (item.statements || []).forEach((stmt, i) => {
                        const isStmtCorrect = (userAnswer && userAnswer[i] === stmt.is_correct);
                        if(isStmtCorrect) correctStatements++;
                        detail.push({isCorrect: isStmtCorrect});
                    });

                    if (options.scoring.tfMethod === 'even') {
                        score += (correctStatements / 4) * pointsPerTf;
                    } else { // progressive
                        if (correctStatements === 4) score += pointsPerTf;
                        else if (correctStatements === 3) score += 0.5 * pointsPerTf;
                        else if (correctStatements === 2) score += 0.25 * pointsPerTf;
                        else if (correctStatements === 1) score += 0.1 * pointsPerTf;
                    }
                    isCorrect = correctStatements === 4;
                } else if (type === 'short-answer') {
                    const correctAnswer = (item.answer || '').toString().trim().toLowerCase();
                    const studentAnswer = (userAnswer || '').toString().trim().toLowerCase();
                    isCorrect = studentAnswer === correctAnswer;
                    if (isCorrect) {
                        score += pointsPerSa;
                    }
                } else {
                    isCorrect = null; // For 'essay' type
                }
                answerDetails.push({ questionNumber: index + 1, isCorrect, type, details: detail });
            });
            return { score, totalPossibleScore, answerDetails };
        }
        
        function renderReview(answerDetails) {
            let reviewHTML = '<h3 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-2">Xem lại bài làm chi tiết</h3>';
            quizData.forEach((item, index) => {
                const type = mapType(item.type);
                const detail = answerDetails.find(d => d.questionNumber === index + 1);
                const isCorrectQuestion = detail?.isCorrect;

                let borderColor = isCorrectQuestion ? 'border-green-200' : (isCorrectQuestion === false ? 'border-red-200' : 'border-gray-200');
                let bgColor = isCorrectQuestion ? 'bg-green-50' : (isCorrectQuestion === false ? 'bg-red-50' : 'bg-gray-50');
                
                reviewHTML += `<div class="mb-8 p-6 border ${borderColor} rounded-2xl ${bgColor} shadow-sm relative overflow-hidden">`;
                
                // Status Badge
                if (type !== 'essay') {
                     reviewHTML += `<div class="absolute top-0 right-0 px-3 py-1 text-xs font-bold uppercase tracking-wider rounded-bl-lg ${isCorrectQuestion ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}">${isCorrectQuestion ? 'Đúng' : 'Sai'}</div>`;
                }

                reviewHTML += `<div class="flex gap-2 mb-3"><span class="bg-white border border-gray-200 text-gray-700 font-bold px-2.5 py-0.5 rounded-md text-sm">Câu ${index + 1}</span></div>`;
                reviewHTML += `<div class="prose max-w-none mb-4 text-gray-800">${item.rendered_question}</div>`;

                if (type === 'multiple-choice') {
                     reviewHTML += '<div class="space-y-2">';
                     (item.rendered_options || []).forEach((opt, i) => {
                        let classes = 'p-3 border rounded-lg flex items-start gap-3';
                        let icon = '';
                        
                        if (i === item.correctAnswerIndex) {
                            classes += ' bg-green-100 border-green-400 ring-1 ring-green-400'; // Correct answer style
                            icon = '<svg class="w-5 h-5 text-green-600 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>';
                        } else if (userAnswers[index] === i) {
                            classes += ' bg-red-100 border-red-400'; // Selected wrong answer
                            icon = '<svg class="w-5 h-5 text-red-600 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>';
                        } else {
                            classes += ' bg-white border-gray-200 opacity-70';
                        }

                        reviewHTML += `<div class="${classes}">
                            <span class="font-bold flex-shrink-0 w-6">${String.fromCharCode(65 + i)}.</span>
                            <div class="flex-grow">${opt}</div>
                            ${icon}
                        </div>`;
                     });
                     reviewHTML += '</div>';
                } else if (type === 'true-false') {
                     reviewHTML += '<div class="space-y-2 mt-4">';
                     (item.statements || []).forEach((stmt, i) => {
                         const userChoice = userAnswers[index] ? userAnswers[index][i] : null;
                         const isStmtCorrect = userChoice === stmt.is_correct;
                         let classes = 'p-3 border rounded-lg flex items-center justify-between gap-4 bg-white';
                         
                         if (userChoice !== null) {
                            classes = isStmtCorrect ? 'p-3 border border-green-300 bg-green-100 rounded-lg flex items-center justify-between gap-4' : 'p-3 border border-red-300 bg-red-100 rounded-lg flex items-center justify-between gap-4';
                         }

                         reviewHTML += `<div class="${classes}">
                                         <div class="prose max-w-none text-sm">${stmt.rendered_statement}</div>
                                         <div class="flex-shrink-0 text-right text-sm">
                                             <div class="${stmt.is_correct ? 'text-green-700 font-bold' : 'text-red-700 font-bold'}">Đáp án: ${stmt.is_correct ? 'Đúng' : 'Sai'}</div>
                                             <div class="text-gray-600">Bạn chọn: <span class="font-medium">${userChoice === true ? 'Đúng' : userChoice === false ? 'Sai' : '...'}</span></div>
                                         </div>
                                     </div>`;
                     });
                     reviewHTML += '</div>';
                } else {
                    reviewHTML += `<div class="mt-4 p-4 bg-white border border-gray-200 rounded-xl">
                        <p class="text-sm font-bold text-gray-500 mb-1">Câu trả lời của bạn:</p>
                        <div class="text-gray-800">${userAnswers[index] || '<em class="text-gray-400">Chưa trả lời</em>'}</div>
                    </div>`;
                    if (item.rendered_answer) {
                        reviewHTML += `<div class="mt-3 p-4 bg-green-50 border border-green-200 rounded-xl">
                            <p class="text-sm font-bold text-green-700 mb-1">Đáp án gợi ý:</p>
                            <div class="prose max-w-none text-green-900">${item.rendered_answer}</div>
                        </div>`;
                    }
                }
                
                if (options.showExplanation) {
                     reviewHTML += `<div class="mt-4 pt-4 border-t border-gray-200/50">
                                      <button class="flex items-center gap-1 text-sm font-semibold text-indigo-600 hover:text-indigo-800 transition-colors" onclick="toggleExplanation(${index}, this)">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                        Xem giải thích chi tiết từ AI
                                      </button>
                                      <div id="explanation-${index}" class="mt-3 p-4 bg-indigo-50 border border-indigo-100 rounded-xl hidden text-sm text-gray-700 leading-relaxed"></div>
                                   </div>`;
                }
                reviewHTML += '</div>';
            });
            reviewContainer.innerHTML = reviewHTML;
            safeTypeset([reviewContainer]);
        }

        function retryQuiz() {
            retriesCount++;
            startQuiz();
        }
        
        function startTimer() {
            stopTimer();
            timerInterval = setInterval(() => {
                timeRemaining--;
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                if (timeRemaining <= 0) {
                    stopTimer();
                    alert('Đã hết thời gian làm bài!');
                    submitQuiz();
                }
            }, 1000);
        }

        function stopTimer() { clearInterval(timerInterval); }
        
        function showWarning(message) {
            warningEl.textContent = message;
            warningEl.style.display = 'block';
            warningEl.style.animation = 'none';
            warningEl.offsetHeight; 
            warningEl.style.animation = 'fade-in-out 5s ease-in-out';
        }

        function handleVisibilityChange() {
            if (document.hidden) {
                monitoringLog.thoatManHinh++;
                showWarning('⚠️ Đã phát hiện chuyển tab hoặc thu nhỏ cửa sổ!');
            }
        }
        function handleCopy() { monitoringLog.saoChep++; showWarning('⚠️ Đã phát hiện hành vi sao chép!'); }
        function handlePaste() { monitoringLog.dan++; showWarning('⚠️ Đã phát hiện hành vi dán!'); }
        function startMonitoring() {
            monitoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0 };
            document.addEventListener('visibilitychange', handleVisibilityChange);
            document.addEventListener('copy', handleCopy);
            document.addEventListener('paste', handlePaste);
        }
        function stopMonitoring() {
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            document.removeEventListener('copy', handleCopy);
            document.removeEventListener('paste', handlePaste);
        }

        async function toggleExplanation(index, button) {
            const explanationContainer = document.getElementById(`explanation-${index}`);
            if (!explanationContainer) return;

            const isHidden = explanationContainer.classList.toggle('hidden');
            button.innerHTML = isHidden 
                ? '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> Xem giải thích chi tiết từ AI' 
                : '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" /></svg> Ẩn giải thích';

            const hasLoaded = explanationContainer.hasAttribute('data-loaded');
            const hadError = explanationContainer.getAttribute('data-loaded') === 'error';

            if (!isHidden && (!hasLoaded || hadError)) {
                await fetchAndRenderExplanation(index);
            }
        }

        async function fetchAndRenderExplanation(index) {
            const explanationContainer = document.getElementById(`explanation-${index}`);
            explanationContainer.innerHTML = '<div class="flex items-center gap-2 text-indigo-500"><svg class="animate-spin h-4 w-4" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> AI đang soạn lời giải...</div>';
            explanationContainer.setAttribute('data-loaded', 'loading');

            if (!API_KEY) {
                explanationContainer.innerHTML = '<p class="text-red-500 font-medium">⚠️ Lỗi: Giáo viên chưa cung cấp khóa AI. Vui lòng liên hệ giáo viên.</p>';
                explanationContainer.setAttribute('data-loaded', 'error');
                return;
            }
            
            try {
                const ai = new GoogleGenAI({ apiKey: API_KEY });
                const item = quizData[index];
                const questionText = (mapType(item.type) === 'true-false') ? (item.main_question || '') : (item.question || '');
                let prompt = `Bạn là một trợ lý giáo viên AI xuất sắc. Hãy viết lời giải chi tiết, dễ hiểu cho câu hỏi này.\n---\nCÂU HỎI:\n${questionText}\n---`;
                
                if (mapType(item.type) === 'multiple-choice') {
                    prompt += `\n**ĐÁP ÁN ĐÚNG:** ${String.fromCharCode(65 + item.correctAnswerIndex)}. ${item.options[item.correctAnswerIndex] || ''}`;
                } else if (mapType(item.type) === 'true-false') {
                    prompt += `\n**CÁC MỆNH ĐỀ VÀ ĐÁP ÁN:**\n${item.statements.map((s, i) => `${String.fromCharCode(97 + i)}) ${s.statement || ''} -> ${s.is_correct ? 'Đúng' : 'Sai'}`).join('\n')}`;
                } else {
                    prompt += `---\n**ĐÁP ÁN / GỢI Ý:** ${item.answer || ''}`;
                }
                prompt += `\n---\n**YÊU CẦU:** Giải thích từng bước logic. Định dạng công thức toán bằng LaTeX (trong dấu $). Dùng **...** để in đậm các ý quan trọng.`;
                
                const response = await generateContentWithFallback(ai, prompt);
                const explanationText = response.text || "Không thể tạo giải thích.";
                
                let htmlContent = explanationText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                explanationContainer.innerHTML = htmlContent;
                safeTypeset([explanationContainer]);
                explanationContainer.setAttribute('data-loaded', 'true');

            } catch (error) {
                console.error("AI Explanation Error:", error);
                explanationContainer.innerHTML = `<div class="text-red-600 text-sm">Đã xảy ra lỗi khi tải lời giải. <button onclick="event.preventDefault(); fetchAndRenderExplanation(${index})" class="underline font-semibold ml-1">Thử lại</button></div>`;
                explanationContainer.setAttribute('data-loaded', 'error');
            }
        }

        async function getAIAssessment(score, answerDetails) {
            if (!API_KEY) {
                const errorMsg = "Không thể tạo nhận xét do giáo viên chưa cung cấp khóa AI.";
                document.querySelector('#assessment-display .assessment-content').innerHTML = `<p class="text-red-600">${errorMsg}</p>`;
                assessmentDisplay.classList.remove('hidden');
                return errorMsg;
            }
            
            document.querySelector('#assessment-display .assessment-content').innerHTML = '<div class="flex items-center gap-2 text-indigo-600"><svg class="animate-spin h-5 w-5" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> AI đang phân tích bài làm của bạn...</div>';
            assessmentDisplay.classList.remove('hidden');

            try {
                const ai = new GoogleGenAI({ apiKey: API_KEY });
                const wrongAnswers = answerDetails.filter(d => d.isCorrect === false || (d.type === 'true-false' && d.details && d.details.some(sub => !sub.isCorrect)));
                if (wrongAnswers.length === 0) {
                    const congrats = "Tuyệt vời! Em đã làm bài xuất sắc và không sai câu nào. Kiến thức của em rất vững vàng. Hãy tiếp tục duy trì phong độ này nhé! 🌟";
                    document.querySelector('#assessment-display .assessment-content').innerHTML = congrats;
                    return congrats;
                }
                const wrongQuestionsSummary = wrongAnswers.map(d => {
                    const item = quizData[d.questionNumber - 1];
                    const questionText = item.question || item.main_question || '';
                    return `- Câu ${d.questionNumber}: ${questionText}`;
                }).join('\n');
                
                const prompt = `Bạn là một giáo viên AI tâm lý và tận tụy. Dựa vào kết quả bài làm sau, hãy viết một đoạn nhận xét ngắn gọn (khoảng 100 từ) cho học sinh.\n**Kết quả:**\n- Điểm số: ${score} / 10\n- Các câu làm sai (nội dung tóm tắt):\n${wrongQuestionsSummary}\n**YÊU CẦU:**\n1. Bắt đầu bằng lời khen ngợi nỗ lực.\n2. Chỉ ra các mảng kiến thức cần ôn tập lại dựa trên các câu sai.\n3. Đưa ra 1 lời khuyên cụ thể để cải thiện.\n4. Kết thúc bằng lời động viên ấm áp.\n5. Sử dụng icon cảm xúc phù hợp.`;

                const response = await generateContentWithFallback(ai, prompt);
                const assessmentText = response.text || "Không thể tạo nhận xét.";
                
                document.querySelector('#assessment-display .assessment-content').innerHTML = assessmentText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                return assessmentText;

            } catch (error) {
                console.error("AI Assessment Error:", error);
                document.querySelector('#assessment-display .assessment-content').innerHTML = `<div class="text-red-600">Lỗi kết nối với AI. <button onclick="retryAIAssessment()" class="underline font-bold ml-1">Thử lại</button></div>`;
                return "Lỗi khi tạo nhận xét AI.";
            }
        }
        
        async function retryAIAssessment() {
            if (lastAnswerDetails) {
                const finalScore = (lastScore / (quizData.length > 0 ? 10 : 1) * 10).toFixed(2);
                await getAIAssessment(finalScore, lastAnswerDetails);
            }
        }
    </script>
</body>
</html>
    