
    <!DOCTYPE html>
    <html lang="vi">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Bài Tập Luyện Tập</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
        <script>
            window.MathJax = {
                tex: {
                    packages: {'[+]': ['ams']},
                    inlineMath: [['$', '$'], ['\\(', '\\)']],
                    displayMath: [['$$', '$$'], ['\\[', '\\]']]
                },
                chtml: {
                    fontCache: 'global',
                    linebreaks: {
                        automatic: true
                    }
                }
            };
        </script>
        <script type="text/javascript" id="MathJax-script" async
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
        </script>
        <style>
            body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #f0f4f8; }
            .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
            @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
            .question-card {
                background-color: white;
                border-radius: 1rem;
                padding: 1.5rem 2rem;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                border-left: 5px solid transparent;
                transition: all 0.3s ease;
            }
            .ai-explanation {
                background-color: #f0f9ff;
                color: #0c4a6e;
                padding: 1rem;
                border-radius: 0.75rem;
                font-size: 0.9rem;
                margin-top: 1rem;
                border-left: 4px solid #38bdf8;
            }
            .feedback-icon { width: 1.5rem; height: 1.5rem; }
            .option-label {
                transition: all 0.2s ease-in-out;
                border: 2px solid #e5e7eb;
            }
            .option-label:hover {
                border-color: #6366f1;
                background-color: #eef2ff;
            }
            .option-label.correct {
                border-color: #10b981 !important;
                background-color: #ecfdf5 !important;
                color: #065f46;
            }
            .option-label.incorrect {
                border-color: #ef4444 !important;
                background-color: #fef2f2 !important;
                color: #991b1b;
            }
            .statement-item.correct { background-color: #ecfdf5; border-color: #10b981; }
            .statement-item.incorrect { background-color: #fef2f2; border-color: #ef4444; }
            .prose { max-width: 100%; }
            .prose h1, .prose h2, .prose h3 { font-weight: 600; }
            .prose p { margin-top: 0.5em; margin-bottom: 0.5em; }
            .prose ul, .prose ol { margin-top: 1em; margin-bottom: 1em; padding-left: 1.5em; }
            .prose li > p { margin-top: 0; margin-bottom: 0; }
            .prose code { background-color: #e5e7eb; padding: 0.2em 0.4em; margin: 0; font-size: 85%; border-radius: 3px; }
            .prose pre { background-color: #e5e7eb; padding: 1em; border-radius: 0.5em; overflow-x: auto; }
            .prose pre code { background-color: transparent; padding: 0; }
            details[open] > summary .details-arrow {
                transform: rotate(180deg);
            }
        </style>
    </head>
    <body class="bg-slate-100 text-slate-800">
        <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md transform transition-all" style="animation: fadeIn 0.3s ease-out;">
                <h2 class="text-2xl font-bold mb-2 text-center text-slate-800">Thông Tin Học Sinh</h2>
                <p class="text-center text-slate-500 mb-6">Vui lòng nhập để bắt đầu làm bài.</p>
                <form id="student-info-form">
                    <div class="mb-4">
                        <label for="student-name" class="block text-sm font-medium text-slate-700 mb-1">Họ và tên</label>
                        <input type="text" id="student-name" required class="mt-1 block w-full block border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="student-class" class="block text-sm font-medium text-slate-700 mb-1">Lớp</label>
                        <input type="text" id="student-class" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="exam-code" class="block text-sm font-medium text-slate-700 mb-1">Mã đề</label>
                        <input type="text" id="exam-code" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Nhập mã đề giáo viên cung cấp">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Giáo viên:</label>
                        <p class="mt-1 text-slate-800 bg-slate-100 p-2.5 rounded-lg">LÊ VĂN ĐÔNG</p>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">Bắt đầu làm bài</button>
                </form>
            </div>
        </div>
        <div class="container mx-auto p-4 md:p-8 max-w-4xl">
            <header class="mb-10 p-8 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg">
                <div class="flex justify-between items-center flex-wrap gap-4">
                    <div>
                        <h1 class="text-4xl font-bold">Bài Tập Luyện Tập</h1>
                        <p class="text-lg text-blue-100 mt-2">Hãy hoàn thành các câu hỏi dưới đây một cách tốt nhất!</p>
                        <p class="text-sm text-blue-200 mt-4">Tác giả: LÊ VĂN ĐÔNG</p>
                    </div>
                    <div id="timer-container" class="text-right">
                         <div id="timer-display" class="text-3xl font-bold tracking-wider bg-white/20 px-4 py-2 rounded-lg">--:--</div>
                         <div id="retries-display" class="text-sm mt-1 text-blue-200"></div>
                    </div>
                </div>
            </header>
            <main id="student-quiz-container" class="space-y-8 hidden">
                <!-- Questions will be rendered here by JS -->
            </main>
            <footer class="mt-10 text-center">
                <button id="submit-quiz-btn" class="bg-indigo-600 text-white py-3 px-12 rounded-full font-bold text-lg hover:bg-indigo-700 transition-all duration-300 shadow-lg hover:shadow-xl hidden transform hover:scale-105">Nộp Bài</button>
                <div id="result-container" class="mt-6 hidden"></div>
                <div id="ai-feedback-container" class="mt-8 text-left hidden"></div>
                <div id="post-submit-options" class="hidden mt-6 flex flex-col sm:flex-row items-center justify-center gap-4">
                    <button id="retry-quiz-btn" class="w-full sm:w-auto bg-slate-600 text-white py-2.5 px-6 rounded-lg font-semibold hover:bg-slate-700 transition-transform transform hover:scale-105">Làm Lại Đề Này</button>
                </div>
            </footer>
        </div>

        <div id="proctoring-widget" class="fixed bottom-4 right-4 bg-yellow-100 text-yellow-800 p-3 rounded-lg shadow-lg text-sm z-50 hidden border border-yellow-300" style="max-width: 200px;">
            <h4 class="font-bold mb-2 border-b border-yellow-300 pb-1 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 3.001-1.742 3.001H4.42c-1.53 0-2.493-1.667-1.743-3.001l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                Giám sát
            </h4>
            <p>Thoát màn hình: <span id="tab-switch-count" class="font-bold">0</span></p>
            <p>Sao chép: <span id="copy-count" class="font-bold">0</span></p>
            <p>Dán: <span id="paste-count" class="font-bold">0</span></p>
        </div>

        <script type="module">
            import { GoogleGenAI, Type } from "https://esm.sh/@google/genai@^1.13.0";
            let quizData = [{"type":"multiple-choice","question":"Trí tuệ nhân tạo (AI) là lĩnh vực khoa học máy tính nghiên cứu về cách tạo ra các hệ thống có khả năng gì?","questionImage":null,"mappedType":"multiple-choice","options":["Chỉ thực hiện các phép tính toán học đơn giản.","Mô phỏng các hoạt động trí tuệ của con người.","Sản xuất hàng loạt linh kiện điện tử.","Phân tích dữ liệu bằng phương pháp thủ công."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Đặc trưng cơ bản nào sau đây KHÔNG phải là một khả năng của Trí tuệ nhân tạo (AI)?","questionImage":null,"mappedType":"multiple-choice","options":["Khả năng học hỏi từ dữ liệu.","Khả năng suy luận và đưa ra quyết định.","Khả năng tự xây dựng và lắp ráp phần cứng máy tính.","Khả năng hiểu và xử lí ngôn ngữ tự nhiên."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Ứng dụng nào sau đây là một ví dụ tiêu biểu của Trí tuệ nhân tạo trong đời sống?","questionImage":null,"mappedType":"multiple-choice","options":["Soạn thảo văn bản bằng phần mềm Word.","Dịch ngôn ngữ tự động qua ứng dụng trên điện thoại.","Tạo bảng biểu trong chương trình Excel.","Lưu trữ dữ liệu trên ổ cứng di động."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Trợ lí ảo nào sau đây là một ví dụ về ứng dụng của Trí tuệ nhân tạo trong các thiết bị di động?","questionImage":null,"mappedType":"multiple-choice","options":["Microsoft PowerPoint.","Google Maps.","Siri.","Adobe Reader."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Một trong những khả năng quan trọng của Trí tuệ nhân tạo (AI) là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Chỉ hiển thị thông tin tĩnh.","Thực hiện các tác vụ lặp đi lặp lại một cách chậm chạp.","Giải quyết các vấn đề phức tạp và đưa ra giải pháp.","Hạn chế khả năng truy cập thông tin trên internet."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Đặc điểm nào sau đây thể hiện sự khác biệt cơ bản về chức năng chuyển tiếp dữ liệu giữa Switch và Hub trong mạng cục bộ (LAN)?","questionImage":null,"mappedType":"multiple-choice","options":["Switch gửi dữ liệu đến tất cả các cổng, Hub gửi dữ liệu đến một cổng duy nhất.","Hub hoạt động ở tầng vật lí, Switch hoạt động ở tầng liên kết dữ liệu.","Switch lọc và gửi dữ liệu đến cổng đích cụ thể dựa vào địa chỉ MAC, còn Hub gửi dữ liệu đến tất cả các cổng.","Hub có khả năng tạo bảng địa chỉ MAC, còn Switch thì không."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Chức năng chính của Router trong một mạng máy tính là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Kết nối các thiết bị trong cùng một mạng cục bộ (LAN) để truyền dữ liệu.","Chuyển đổi tín hiệu dữ liệu từ dạng này sang dạng khác để truyền qua đường truyền vật lí.","Kết nối các mạng khác nhau (ví dụ: mạng LAN với Internet) và định tuyến các gói tin giữa chúng.","Cung cấp nguồn điện cho các thiết bị mạng khác hoạt động."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Thiết bị mạng nào có chức năng chính là chuyển đổi tín hiệu số thành tín hiệu tương tự và ngược lại để truyền dữ liệu qua đường dây điện thoại hoặc cáp?","questionImage":null,"mappedType":"multiple-choice","options":["Switch","Router","Modem","Hub"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Để các thiết bị như điện thoại thông minh, máy tính xách tay có thể truy cập mạng không dây trong một khu vực cục bộ, thiết bị mạng nào sau đây là cần thiết để tạo điểm truy cập?","questionImage":null,"mappedType":"multiple-choice","options":["Hub","Switch","Modem","Điểm truy cập không dây (WAP)"],"optionsImage":[],"correctAnswerIndex":3},{"type":"multiple-choice","question":"Thiết bị nào dưới đây hoạt động ở tầng Liên kết dữ liệu (Data Link Layer) của mô hình OSI và sử dụng địa chỉ MAC để quyết định chuyển tiếp khung dữ liệu (frame)?","questionImage":null,"mappedType":"multiple-choice","options":["Hub","Router","Modem","Switch"],"optionsImage":[],"correctAnswerIndex":3},{"type":"multiple-choice","question":"Giao thức mạng (Network Protocol) có vai trò cốt lõi nào trong truyền thông trên mạng máy tính?","questionImage":null,"mappedType":"multiple-choice","options":["Định nghĩa các quy tắc và định dạng để các thiết bị trên mạng có thể giao tiếp với nhau.","Chỉ xác định tốc độ truyền dữ liệu của mạng.","Là phần mềm duy nhất chịu trách nhiệm bảo mật dữ liệu.","Chỉ dùng để kết nối các máy tính ở gần nhau."],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Địa chỉ IP (Internet Protocol address) được sử dụng với mục đích chính là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Xác định duy nhất một thiết bị trên mạng và cho phép dữ liệu được gửi đến đúng đích.","Mã hóa dữ liệu trước khi truyền đi qua mạng.","Tăng cường tốc độ truy cập Internet.","Giới hạn số lượng người dùng có thể truy cập vào một máy chủ."],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Chức năng chính của giao thức IP là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Đảm bảo truyền dữ liệu tin cậy thông qua kiểm soát lỗi và truyền lại.","Phân giải tên miền (DNS) thành địa chỉ IP.","Định tuyến các gói dữ liệu (packet) giữa các mạng khác nhau.","Thực hiện mã hóa đầu cuối cho tất cả các thông tin truyền đi."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Giao thức TCP (Transmission Control Protocol) có chức năng chính nào để đảm bảo chất lượng truyền dữ liệu?","questionImage":null,"mappedType":"multiple-choice","options":["Đảm bảo truyền dữ liệu tin cậy thông qua việc kiểm tra lỗi và yêu cầu truyền lại các gói bị mất hoặc hỏng.","Phân chia các gói dữ liệu thành các phần nhỏ hơn.","Chỉ quản lí địa chỉ IP của các thiết bị trong mạng cục bộ.","Thiết lập kết nối an toàn bằng cách sử dụng mã hóa SSH."],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Trong mạng máy tính, giao thức nào chịu trách nhiệm chính trong việc định tuyến (routing) các gói dữ liệu giữa các mạng?","questionImage":null,"mappedType":"multiple-choice","options":["TCP (Transmission Control Protocol).","FTP (File Transfer Protocol).","IP (Internet Protocol).","HTTP (Hypertext Transfer Protocol)."],"optionsImage":[],"correctAnswerIndex":2},{"type":"true-false","main_question":"Phát biểu nào sau đây về thiết bị Hub và Switch là đúng hoặc sai?","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Hub là thiết bị mạng hoạt động ở tầng vật lí (Layer $1$) của mô hình OSI và truyền dữ liệu tới tất cả các cổng của nó.","is_correct":true},{"statement":"Switch hiệu quả hơn Hub trong việc gửi dữ liệu vì nó chỉ chuyển gói tin đến cổng đích cụ thể dựa vào địa chỉ MAC của thiết bị nhận.","is_correct":true},{"statement":"Trong một mạng LAN, việc thay thế Hub bằng Switch giúp giảm lưu lượng truyền tải không cần thiết và tăng hiệu suất mạng do Switch tạo ra các miền đụng độ riêng biệt cho mỗi cổng.","is_correct":true},{"statement":"Một Hub có khả năng phân đoạn mạng thành các miền quảng bá (broadcast domains) nhỏ hơn, giúp quản lí lưu lượng hiệu quả hơn so với Switch.","is_correct":false}]},{"type":"true-false","main_question":"Phát biểu nào sau đây về chức năng của Modem và Router là đúng hoặc sai?","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Modem có chức năng chuyển đổi tín hiệu số từ máy tính thành tín hiệu tương tự để truyền qua đường dây điện thoại hoặc cáp quang.","is_correct":true},{"statement":"Router là thiết bị cho phép các gói dữ liệu di chuyển giữa các mạng máy tính khác nhau, ví dụ, giữa mạng LAN của bạn và Internet.","is_correct":true},{"statement":"Trong một hệ thống mạng gia đình thông thường, Modem và Router luôn là hai thiết bị riêng biệt và không thể được tích hợp trong một thiết bị duy nhất.","is_correct":false},{"statement":"Để truy cập Internet, chỉ cần có Router mà không cần Modem, miễn là thiết bị đầu cuối có thể tạo tín hiệu số.","is_correct":false}]},{"type":"true-false","main_question":"Phát biểu nào sau đây về WAP (Wireless Access Point) và các mô hình mạng là đúng hoặc sai?","questionImage":null,"mappedType":"true-false","statements":[{"statement":"WAP (Wireless Access Point) là một thiết bị cho phép các thiết bị không dây kết nối vào mạng có dây.","is_correct":true},{"statement":"Mạng LAN (Local Area Network) là mạng máy tính cục bộ, thường giới hạn trong một khu vực địa lí nhỏ như văn phòng hoặc nhà riêng.","is_correct":true},{"statement":"Một WAP có thể tạo ra một mạng Wi-Fi độc lập hoàn toàn mà không cần kết nối với bất kỳ thiết bị mạng có dây nào khác để hoạt động và truy cập tài nguyên Internet.","is_correct":false},{"statement":"Sự khác biệt cơ bản nhất giữa mạng LAN và WAN (Wide Area Network) chủ yếu nằm ở công nghệ truyền dẫn được sử dụng, chứ không phải khoảng cách địa lí mà chúng bao phủ.","is_correct":false}]},{"type":"true-false","main_question":"Phát biểu nào sau đây so sánh chức năng chính của các thiết bị mạng là đúng hoặc sai?","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Hub hoạt động ở tầng vật lí (Layer $1$) của mô hình OSI.","is_correct":true},{"statement":"Switch hoạt động chủ yếu ở tầng liên kết dữ liệu (Layer $2$) bằng cách sử dụng địa chỉ MAC để chuyển tiếp khung dữ liệu một cách thông minh.","is_correct":true},{"statement":"Router là thiết bị hoạt động ở tầng mạng (Layer $3$), chịu trách nhiệm định tuyến gói tin giữa các mạng con dựa trên địa chỉ IP.","is_correct":true},{"statement":"Trong một mạng LAN, việc sử dụng Router để kết nối các máy tính trong cùng một dải địa chỉ IP sẽ làm tăng tốc độ truyền dữ liệu so với việc sử dụng Switch.","is_correct":false}]},{"type":"true-false","main_question":"Phát biểu nào sau đây về các khái niệm nâng cao trong mạng máy tính là đúng hoặc sai?","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Khi một máy tính gửi dữ liệu qua Hub, tất cả các máy tính khác trong cùng phân đoạn mạng sẽ nhận được dữ liệu đó, bất kể đích đến thực sự.","is_correct":true},{"statement":"Switch có khả năng phân chia mạng thành các miền đụng độ (collision domains) riêng biệt cho mỗi cổng, giúp cải thiện hiệu suất truyền dữ liệu.","is_correct":true},{"statement":"Modem là thiết bị duy nhất trong mạng gia đình có thể cung cấp địa chỉ IP cho các thiết bị thông qua tính năng DHCP (Dynamic Host Configuration Protocol).","is_correct":false},{"statement":"Một Router chỉ cần có địa chỉ IP WAN để hoạt động và không yêu cầu bất kỳ địa chỉ IP nội bộ nào cho các cổng LAN của nó.","is_correct":false}]},{"type":"true-false","main_question":"Liên quan đến giao thức mạng và giao thức IP, các phát biểu sau là Đúng hay Sai?","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Giao thức mạng là tập hợp các quy tắc quy định cách thức các thiết bị trong mạng giao tiếp với nhau.","is_correct":true},{"statement":"Giao thức IP chịu trách nhiệm đảm bảo dữ liệu được truyền đến đúng đích một cách tin cậy, không mất mát.","is_correct":false},{"statement":"Địa chỉ IP là duy nhất trên toàn bộ mạng Internet tại một thời điểm nhất định cho một thiết bị.","is_correct":true},{"statement":"Giao thức IP hoạt động ở tầng giao vận của mô hình TCP/IP.","is_correct":false}]},{"type":"true-false","main_question":"Về giao thức TCP và cơ chế hoạt động, các phát biểu sau là Đúng hay Sai?","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Giao thức TCP là một giao thức hướng kết nối (connection-oriented).","is_correct":true},{"statement":"Quá trình \"bắt tay ba bước\" (three-way handshake) được TCP sử dụng để xác định đường đi cho gói tin giữa nguồn và đích.","is_correct":false},{"statement":"Để đảm bảo tính tin cậy, TCP sử dụng cơ chế đánh số thứ tự gói tin và xác nhận đã nhận (acknowledgment).","is_correct":true},{"statement":"Trong quá trình \"bắt tay ba bước\" của TCP, bên gửi sẽ gửi cờ $SYN$, bên nhận trả lời bằng cờ $SYN$ và $ACK$, sau đó bên gửi gửi cờ $FIN$ để hoàn tất thiết lập kết nối.","is_correct":false}]},{"type":"true-false","main_question":"Khi nói về địa chỉ IP và định tuyến, các phát biểu sau là Đúng hay Sai?","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Địa chỉ IP là một chuỗi số dùng để nhận diện duy nhất một thiết bị trên mạng.","is_correct":true},{"statement":"Bộ định tuyến (router) có nhiệm vụ chuyển tiếp các gói tin dựa trên địa chỉ MAC của đích.","is_correct":false},{"statement":"Một máy tính có thể có nhiều địa chỉ IP khác nhau nếu nó kết nối đến nhiều mạng đồng thời.","is_correct":true},{"statement":"Các địa chỉ IP riêng (private IP addresses) có thể được định tuyến trực tiếp trên mạng Internet toàn cầu.","is_correct":false}]},{"type":"true-false","main_question":"So sánh giữa giao thức TCP và UDP, các phát biểu sau là Đúng hay Sai?","questionImage":null,"mappedType":"true-false","statements":[{"statement":"UDP là giao thức không hướng kết nối (connectionless).","is_correct":true},{"statement":"TCP được ưu tiên sử dụng trong các ứng dụng yêu cầu truyền dữ liệu nhanh, không quan trọng thứ tự gói tin như streaming video.","is_correct":false},{"statement":"Do không có cơ chế bắt tay và xác nhận, UDP thường có độ trễ thấp hơn TCP, phù hợp cho các ứng dụng thời gian thực.","is_correct":true},{"statement":"Trong trường hợp mạng có nhiều gói tin bị mất, TCP sẽ tự động điều chỉnh tốc độ truyền và thực hiện truyền lại, trong khi UDP sẽ bỏ qua các gói tin đó mà không có bất kỳ phản hồi nào.","is_correct":true}]},{"type":"true-false","main_question":"Về hệ giao thức TCP/IP và chức năng của các thành phần, các phát biểu sau là Đúng hay Sai?","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Hệ giao thức TCP/IP là tập hợp các giao thức được sử dụng để liên kết các thiết bị mạng trên Internet.","is_correct":true},{"statement":"Trong mô hình TCP/IP, giao thức IP chịu trách nhiệm chính về phân đoạn dữ liệu (segmentation) và tái lắp ráp (reassembly) ở bên nhận.","is_correct":false},{"statement":"Khi một trình duyệt web yêu cầu một trang HTML, giao thức HTTP hoạt động ở tầng ứng dụng, sau đó sử dụng TCP để thiết lập kết nối tin cậy, và cuối cùng dùng IP để định tuyến gói tin trên mạng.","is_correct":true},{"statement":"Nếu giao thức IP bị lỗi và không thể định tuyến các gói tin, giao thức TCP vẫn có thể tự mình tìm đường đi thay thế để đảm bảo dữ liệu đến đích.","is_correct":false}]},{"type":"short-answer","question":"Nêu một điểm khác biệt cơ bản về cách thức truyền dữ liệu giữa Hub và Switch trong mạng máy tính.","questionImage":null,"mappedType":"short-answer","answer":"Hub truyền dữ liệu đến tất cả các cổng (broadcast), trong khi Switch truyền dữ liệu đến cổng đích cụ thể dựa vào địa chỉ MAC."},{"type":"short-answer","question":"Chức năng chính của Router trong mạng máy tính là gì?","questionImage":null,"mappedType":"short-answer","answer":"Router có chức năng định tuyến (chuyển tiếp) các gói dữ liệu giữa các mạng khác nhau (ví dụ: giữa mạng LAN và Internet)."},{"type":"short-answer","question":"Thiết bị Modem đảm nhiệm vai trò gì trong việc kết nối Internet tại gia đình?","questionImage":null,"mappedType":"short-answer","answer":"Modem có chức năng điều chế và giải điều chế tín hiệu, chuyển đổi tín hiệu số từ máy tính thành tín hiệu tương tự để truyền qua đường truyền Internet (cáp quang, ADSL) và ngược lại."},{"type":"short-answer","question":"Nêu chức năng chính của thiết bị WAP (Wireless Access Point) trong hệ thống mạng không dây.","questionImage":null,"mappedType":"short-answer","answer":"WAP (Wireless Access Point) có chức năng tạo ra một điểm truy cập không dây, cho phép các thiết bị không dây kết nối vào mạng có dây."},{"type":"short-answer","question":"Hãy kể tên hai loại mạng phổ biến được phân loại dựa trên phạm vi địa lý.","questionImage":null,"mappedType":"short-answer","answer":"Hai loại mạng phổ biến được phân loại dựa trên phạm vi địa lý là Mạng cục bộ (LAN) và Mạng diện rộng (WAN)."},{"type":"short-answer","question":"Giao thức mạng có vai trò chính là gì trong truyền thông máy tính?","questionImage":null,"mappedType":"short-answer","answer":"Thiết lập các quy tắc và định dạng để các thiết bị trong mạng có thể giao tiếp và trao đổi dữ liệu hiệu quả."},{"type":"short-answer","question":"Chức năng chính của giao thức IP (Internet Protocol) trong mạng máy tính là gì?","questionImage":null,"mappedType":"short-answer","answer":"Đánh địa chỉ và định tuyến các gói dữ liệu từ nguồn đến đích trên Internet."},{"type":"short-answer","question":"Trách nhiệm chính của giao thức TCP (Transmission Control Protocol) là gì?","questionImage":null,"mappedType":"short-answer","answer":"Đảm bảo truyền dữ liệu tin cậy, theo thứ tự và không bị lỗi giữa các ứng dụng trên mạng."},{"type":"short-answer","question":"Địa chỉ IP được sử dụng để làm gì?","questionImage":null,"mappedType":"short-answer","answer":"Để nhận diện duy nhất một thiết bị trên mạng và xác định vị trí của nó để các gói dữ liệu có thể được gửi đến đúng địa chỉ."},{"type":"short-answer","question":"Trong bối cảnh giao thức mạng, \"định tuyến\" có nghĩa là gì?","questionImage":null,"mappedType":"short-answer","answer":"Là quá trình tìm ra đường đi tối ưu nhất cho các gói dữ liệu di chuyển từ máy gửi đến máy nhận qua các mạng khác nhau."},{"type":"essay","question":"Nêu và giải thích sự khác biệt cơ bản về chức năng và cách hoạt động giữa Hub và Switch trong một mạng cục bộ (LAN).","questionImage":null,"mappedType":"essay","answer":"Gợi ý: Hub hoạt động ở tầng vật lí, phát lại dữ liệu tới tất cả các cổng (broadcast). Switch hoạt động ở tầng liên kết dữ liệu, chuyển tiếp dữ liệu tới cổng đích cụ thể dựa trên địa chỉ MAC, giúp tăng hiệu suất mạng và giảm tắc nghẽn."},{"type":"essay","question":"Hãy nêu và giải thích ngắn gọn chức năng chính của ba thiết bị mạng thông dụng sau đây: Router, Modem và WAP (Điểm truy cập không dây).","questionImage":null,"mappedType":"essay","answer":"Gợi ý: Router (Bộ định tuyến) có chức năng định tuyến các gói dữ liệu giữa các mạng khác nhau và thiết lập kết nối Internet cho nhiều thiết bị. Modem (Bộ điều chế/giải điều chế) có chức năng chuyển đổi tín hiệu số từ máy tính thành tín hiệu tương tự để truyền qua đường truyền vật lí (ví dụ: cáp quang, ADSL) và ngược lại. WAP (Wireless Access Point - Điểm truy cập không dây) có chức năng tạo ra một điểm truy cập mạng Wi-Fi, cho phép các thiết bị không dây kết nối vào mạng có dây hiện có."},{"type":"essay","question":"Giải thích vai trò của giao thức mạng trong việc truyền thông tin giữa các máy tính trong một hệ thống mạng.","questionImage":null,"mappedType":"essay","answer":"Giao thức mạng là tập hợp các quy tắc và quy ước được thiết lập để điều khiển cách thức dữ liệu được truyền tải và nhận giữa các thiết bị trong mạng. Vai trò của giao thức mạng là đảm bảo rằng các thiết bị có thể hiểu và giao tiếp với nhau một cách hiệu quả, độc lập với phần cứng hoặc hệ điều hành của chúng. Nó chuẩn hóa các quy trình như đóng gói, định địa chỉ, định tuyến và kiểm soát lỗi, giúp hệ thống mạng hoạt động một cách trật tự và tin cậy."},{"type":"essay","question":"Mô tả chức năng chính của giao thức IP (Internet Protocol) và giao thức TCP (Transmission Control Protocol) trong mạng máy tính.","questionImage":null,"mappedType":"essay","answer":"Giao thức IP có chức năng chính là định địa chỉ và định tuyến dữ liệu. Nó gán một địa chỉ IP duy nhất cho mỗi thiết bị trên mạng và chịu trách nhiệm tìm đường đi (định tuyến) cho các gói dữ liệu từ nguồn đến đích. Giao thức TCP có chức năng đảm bảo truyền dữ liệu tin cậy. Nó thiết lập kết nối giữa hai thiết bị (thông qua quá trình 'bắt tay ba bước'), phân chia dữ liệu thành các phân đoạn, gửi chúng đi, và đảm bảo rằng tất cả các phân đoạn đến đích một cách đúng thứ tự và không bị lỗi. Nếu có lỗi hoặc mất mát, TCP sẽ yêu cầu gửi lại các phân đoạn đó."}];
            const quizOptions = {"timeLimit":45,"retriesAllowed":1,"showAnswers":true,"showExplanation":true,"aiAssessment":true,"scoring":{"mc":5,"tf":2,"sa":2,"essay":1,"tfMethod":"progressive"}};
            const googleScriptUrl = "https://script.google.com/macros/s/AKfycbzAhhPPCUgw-uU55gOj87Tm16ugz8FuBlRwQ7sECOBiOWBC8n6SI2mt_mQblXdoCdje/exec";
            const correctExamCode = "585ATP";
            const teacherApiKey = "AIzaSyDzpJyodrQYlL0_OmSq4k3snugEgphM6IE";
            let studentInfo = {};
            let isSubmitted = false;
            let timerInterval;
            let retriesLeft = quizOptions.retriesAllowed;
            let studentApiKey = "";
            let ai = null;

            let proctoringLog = {
                thoatManHinh: 0,
                saoChep: 0,
                dan: 0,
                suKien: []
            };

            const studentQuizContainer = document.getElementById('student-quiz-container');
            const submitBtn = document.getElementById('submit-quiz-btn');
            const resultContainer = document.getElementById('result-container');
            const postSubmitOptions = document.getElementById('post-submit-options');
            const retryBtn = document.getElementById('retry-quiz-btn');
            const loginModal = document.getElementById('login-modal');
            const studentInfoForm = document.getElementById('student-info-form');
            const timerDisplay = document.getElementById('timer-display');
            const retriesDisplay = document.getElementById('retries-display');
            function shuffleQuiz() {
                // Shuffle options/statements within each question first
                quizData.forEach(item => {
                    // Shuffle multiple-choice options and their corresponding images
                    if (item.mappedType === 'multiple-choice' && item.options && item.options.length > 0) {
                        const correctAnswerText = item.options[item.correctAnswerIndex];
                        let optionsWithImages = item.options.map((opt, index) => ({
                            text: opt,
                            image: (item.optionsImage && item.optionsImage[index]) ? item.optionsImage[index] : null
                        }));
                        // Fisher-Yates shuffle
                        for (let i = optionsWithImages.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [optionsWithImages[i], optionsWithImages[j]] = [optionsWithImages[j], optionsWithImages[i]];
                        }
                        // Update the item with shuffled data
                        item.options = optionsWithImages.map(opt => opt.text);
                        item.optionsImage = optionsWithImages.map(opt => opt.image);
                        item.correctAnswerIndex = item.options.indexOf(correctAnswerText);
                    }
                    // Shuffle true-false statements
                    if (item.mappedType === 'true-false' && item.statements && item.statements.length > 0) {
                         for (let i = item.statements.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [item.statements[i], item.statements[j]] = [item.statements[j], item.statements[i]];
                        }
                    }
                });
                // Then, group questions by type and shuffle within each group
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});
                let shuffledQuizData = [];
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    if (grouped[partType]) {
                        const partQuestions = grouped[partType];
                        for (let i = partQuestions.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [partQuestions[i], partQuestions[j]] = [partQuestions[j], partQuestions[i]];
                        }
                        shuffledQuizData = shuffledQuizData.concat(partQuestions);
                    }
                });
               
                quizData = shuffledQuizData;
            }
            // --- Timer Function ---
            function startTimer(duration, display) {
                let timer = duration, minutes, seconds;
                clearInterval(timerInterval); // Clear any existing timer
                if(duration <= 0) {
                     display.textContent = "∞";
                     return;
                }
                timerInterval = setInterval(function () {
                    minutes = parseInt(timer / 60, 10);
                    seconds = parseInt(timer % 60, 10);
                    minutes = minutes < 10 ? "0" + minutes : minutes;
                    seconds = seconds < 10 ? "0" + seconds : seconds;
                    display.textContent = minutes + ":" + seconds;
                    if (--timer < 0) {
                        clearInterval(timerInterval);
                        alert("Hết giờ làm bài!");
                        handleSubmit();
                    }
                }, 1000);
            }
            
            async function showExplanation(index, button) {
                const item = quizData[index];
                const questionCard = document.getElementById(`student-q-${index}`);
                const feedbackDiv = document.getElementById(`q-${index}-feedback`);
                if (!questionCard || !feedbackDiv) return;

                const existingExplanation = feedbackDiv.querySelector('.ai-explanation');
                if (existingExplanation) {
                    existingExplanation.remove();
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Xem giải thích
                    `;
                    return;
                }

                button.disabled = true;
                button.innerHTML = '<div class="loader mr-2"></div> Đang tải...';

                if (item.explanation) {
                    displayExplanation(item.explanation, feedbackDiv, button);
                    return;
                }

                if (!ai) {
                    alert("Tính năng giải thích yêu cầu API Key, nhưng chưa được cấu hình bởi giáo viên.");
                    button.disabled = false;
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Xem giải thích
                    `;
                    return;
                }

                const questionText = item.question || item.main_question;
                let prompt = `Bạn là một trợ lý giáo viên AI, am hiểu sâu sắc Chương trình GDPT 2018. Hãy cung cấp một lời giải chi tiết, từng bước một cho câu hỏi sau đây. Lời giải phải chính xác, dễ hiểu và phù hợp với phương pháp giảng dạy của chương trình học, TUYỆT ĐỐI KHÔNG sử dụng kiến thức của lớp cao hơn để giải thích.\n\n--- CÂU HỎI ---\n${questionText}\n\n`;
                if (item.mappedType === 'multiple-choice') {
                    prompt += `--- CÁC LỰA CHỌN ---\n${item.options.map((opt, i) => `${String.fromCharCode(65 + i)}. ${opt}`).join('\n')}\n\n`;
                    prompt += `--- ĐÁP ÁN ĐÚNG ---\n${String.fromCharCode(65 + item.correctAnswerIndex)}. ${item.options[item.correctAnswerIndex]}`;
                } else if (item.mappedType === 'true-false') {
                    prompt += `--- CÁC MỆNH ĐỀ & ĐÁP ÁN ---\n${item.statements.map(s => ` - ${s.statement} -> ${s.is_correct ? 'Đúng' : 'Sai'}`).join('\n')}`;
                } else {
                    prompt += `--- ĐÁP ÁN / GỢI Ý ---\n${item.answer}`;
                }
                prompt += `\n\n--- YÊU CẦU ---\nGiải thích rõ ràng tại sao đáp án lại đúng, từng bước một. Định dạng tất cả các công thức toán học bằng LaTeX.`;

                try {
                    const response = await ai.models.generateContent({ model: "gemini-2.5-flash", contents: prompt });
                    const explanationText = response.text.replace(/\n/g, '<br>');
                    item.explanation = explanationText; // Cache it
                    displayExplanation(explanationText, feedbackDiv, button);
                } catch (error) {
                    console.error("Lỗi khi tạo giải thích:", error);
                    feedbackDiv.insertAdjacentHTML('beforeend', '<div class="ai-explanation text-red-600">Lỗi: Không thể tạo giải thích.</div>');
                    button.disabled = false;
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Thử lại
                    `;
                }
            }

            function displayExplanation(explanationText, container, button) {
                container.insertAdjacentHTML('beforeend', `<div class="ai-explanation prose prose-sm">${explanationText}</div>`);
                if (window.MathJax) MathJax.typesetPromise([container]);
                button.disabled = false;
                button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    Ẩn giải thích
                `;
            }
           
            function renderStudentQuiz() {
                studentQuizContainer.innerHTML = '';
               
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});
                const groupInfo = {
                    'multiple-choice': { title: 'PHẦN I. TRẮC NGHIỆM KHÁCH QUAN', subtitle: 'Chọn đáp án đúng nhất trong các lựa chọn sau.' },
                    'true-false': { title: 'PHẦN II. CÂU HỎI ĐÚNG - SAI', subtitle: 'Xác định tính đúng hoặc sai cho mỗi mệnh đề dưới đây.' },
                    'short-answer': { title: 'PHẦN III. CÂU HỎI TRẢ LỜI NGẮN', subtitle: 'Điền đáp án ngắn gọn vào phần trả lời.' },
                    'essay': { title: 'PHẦN IV. CÂU HỎI TỰ LUẬN', subtitle: 'Trình bày chi tiết bài giải của bạn.' }
                };
               
                let questionCounter = 0;
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    const questions = grouped[partType];
                    if (!questions || questions.length === 0) return;
                   
                    let groupHTML = `<div class="group-container space-y-8 mb-12">`;
                    const info = groupInfo[partType];
                    groupHTML += `
                        <div class="group-header pb-3 border-b-2 border-slate-300 mb-6">
                            <h2 class="text-2xl font-bold text-slate-800">${info.title}</h2>
                            ${info.subtitle ? `<p class="text-md text-slate-600 italic mt-1">${info.subtitle}</p>` : ''}
                        </div>
                    `;
                    questions.forEach((item, localIndex) => {
                        const globalIndex = quizData.indexOf(item);
                        questionCounter++;
                        groupHTML += `<div class="question-card" id="student-q-${globalIndex}">`;
                        let questionText = (item.question || item.main_question || '').replace(/\n/g, '<br>');
                       
                        groupHTML += `<div class="flex items-start">
                                     <div class="flex-grow">
                                         <div class="flex items-center mb-2">
                                             <span class="font-bold text-lg mr-3 text-indigo-600">Câu ${questionCounter}:</span>
                                             <div id="q-${globalIndex}-feedback-icon"></div>
                                         </div>
                                         <div class="question-content mt-2 text-lg text-slate-700">${questionText}</div>
                                         ${item.questionImage ? `<img src="${item.questionImage}" class="mt-4 rounded-lg max-w-full md:max-w-md border shadow-sm">` : ''}
                                     </div>
                                 </div>`;
                       
                        groupHTML += `<div class="mt-6">`;
                        switch(item.mappedType) {
                            case 'multiple-choice':
                                groupHTML += `<div class="options-grid grid grid-cols-1 md:grid-cols-2 gap-4">`;
                                item.options.forEach((opt, i) => {
                                    groupHTML += `<label for="q${globalIndex}-opt${i}" id="q${globalIndex}-opt-label${i}" class="option-label flex items-start p-4 border-2 rounded-xl cursor-pointer hover:bg-indigo-50 hover:border-indigo-400">
                                                     <input type="radio" name="q${globalIndex}" id="q${globalIndex}-opt${i}" value="${i}" class="flex-shrink-0 mt-1 h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                                     <div class="ml-3 flex-grow">
                                                         <span class="font-semibold text-slate-800">${String.fromCharCode(65 + i)}.</span>
                                                         <span class="option-content text-slate-700">${opt || ''}</span>
                                                         ${(item.optionsImage && item.optionsImage[i]) ? `<img src="${item.optionsImage[i]}" class="mt-2 rounded-lg max-w-xs border shadow-sm">` : ''}
                                                     </div>
                                                 </label>`;
                                });
                                groupHTML += `</div>`;
                                break;
                            case 'true-false':
                                 groupHTML += `<div class="space-y-4">`;
                                 item.statements.forEach((s, i) => {
                                     groupHTML += `<div class="statement-item border-t pt-4">
                                                  <p class="mb-3 text-slate-700">${String.fromCharCode(97 + i)}) ${s.statement || ''}</p>
                                                  <div class="flex gap-x-6">
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="true" class="mr-2 h-4 w-4"> Đúng</label>
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="false" class="mr-2 h-4 w-4"> Sai</label>
                                                  </div>
                                              </div>`;
                                 });
                                 groupHTML += `</div>`;
                                 break;
                            case 'short-answer':
                                groupHTML += `<input type="text" name="q${globalIndex}" class="mt-1 block w-full md:w-1/2 border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Nhập đáp án của bạn...">`;
                                break;
                            case 'essay':
                                groupHTML += `<textarea name="q${globalIndex}" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" rows="5" placeholder="Nhập câu trả lời tự luận của bạn..."></textarea>`;
                                break;
                        }
                        groupHTML += `</div><div id="q-${globalIndex}-feedback" class="mt-4"></div></div>`;
                    });
                    groupHTML += `</div>`;
                    studentQuizContainer.innerHTML += groupHTML;
                });
               
                if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                    MathJax.typesetPromise([studentQuizContainer]);
                }
            }
           
            async function generatePerformanceReview(allAnswersData) {
                const feedbackContainer = document.getElementById('ai-feedback-container');
                if (!feedbackContainer || !ai) return null;
                feedbackContainer.classList.remove('hidden');
                feedbackContainer.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-slate-800 mb-4">📝 Phân Tích & Gợi Ý Từ Trợ Lý AI</h3>
                        <div id="ai-feedback-loader" class="text-center py-6">
                            <svg class="animate-spin mx-auto h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p class="mt-3 text-slate-600">AI đang phân tích bài làm của bạn...</p>
                        </div>
                        <div id="ai-feedback-summary" class="hidden prose prose-sm max-w-none"></div>
                        <div id="ai-feedback-details" class="hidden mt-4 space-y-2"></div>
                    </div>
                `;
               
                const loader = document.getElementById('ai-feedback-loader');
                const summaryDiv = document.getElementById('ai-feedback-summary');
                const detailsDiv = document.getElementById('ai-feedback-details');
                const incorrectAnswers = allAnswersData.filter(a => !a.isCorrect);
                if (incorrectAnswers.length === 0) {
                    feedbackContainer.innerHTML = `
                        <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                            <h3 class="text-xl font-bold text-green-600">🎉 Chúc mừng!</h3>
                            <p class="mt-2 text-slate-700">Bạn đã trả lời đúng tất cả các câu hỏi. Làm tốt lắm!</p>
                        </div>
                    `;
                    return { overallFeedback: { summary: "Xuất sắc! Học sinh đã đã trả lời đúng tất cả các câu hỏi." } };
                }
                const summaryPrompt = `Bạn là một trợ lý giáo viên, nói tiếng Việt. Dựa vào tóm tắt các câu trả lời sai của học sinh, hãy đưa ra một nhận xét tổng quan ngắn gọn (khoảng 3-4 câu) về năng lực của học sinh, bao gồm điểm mạnh (suy luận từ các câu làm đúng), điểm yếu (dựa trên các câu sai) và một vài gợi ý ôn tập chung. Lời văn phải khích lệ, rõ ràng.
                Tóm tắt lỗi sai:
                ${JSON.stringify(incorrectAnswers.map(a => ({ cau: a.questionNumber, loai: a.type, cauHoi: a.question.substring(0, 50) + '...' })), null, 2)}`;
                try {
                    const summaryResponse = await ai.models.generateContent({
                        model: "gemini-2.5-flash",
                        contents: summaryPrompt
                    });
                    summaryDiv.innerHTML = summaryResponse.text.replace(/\n/g, '<br>');
                    loader.classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                    detailsDiv.classList.remove('hidden'); 
                } catch (e) {
                    console.error("Lỗi khi lấy nhận xét tổng quan:", e);
                    summaryDiv.innerHTML = '<p class="text-red-600">Lỗi khi tạo nhận xét tổng quan.</p>';
                    loader.classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                }
               
                const summaryForSheet = summaryDiv.innerText.substring(0, 200) + "...";
                return { overallFeedback: { summary: summaryForSheet } };
            }
            async function handleSubmit() {
                if (isSubmitted) return;
                isSubmitted = true;
                clearInterval(timerInterval);
                
                document.querySelectorAll('input, textarea').forEach(input => input.disabled = true);
                submitBtn.classList.add('hidden');
                postSubmitOptions.classList.remove('hidden');
                if (retriesLeft > 0) {
                    retryBtn.classList.remove('hidden');
                } else {
                    retryBtn.classList.add('hidden');
                }

                const proctoringDataString = JSON.stringify(proctoringLog);

                let totalStudentScore = 0;
                let totalCorrectAnswers = 0;
                let allAnswersData = [];
                const questionCounts = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    acc[type] = (acc[type] || 0) + 1;
                    return acc;
                }, {});
                
                quizData.forEach((item, index) => {
                    let questionNumber = index + 1;
                    let answerData = { questionNumber, type: item.type };
                    switch (item.mappedType) {
                        case 'multiple-choice':
                            const selectedOption = document.querySelector(`input[name="q${index}"]:checked`);
                            const isCorrectMC = selectedOption ? parseInt(selectedOption.value) === item.correctAnswerIndex : false;
                            if (isCorrectMC) {
                                totalCorrectAnswers++;
                                if (questionCounts['multiple-choice'] > 0) {
                                   totalStudentScore += quizOptions.scoring.mc / questionCounts['multiple-choice'];
                                }
                            }
                            answerData.question = item.question;
                            answerData.options = item.options;
                            answerData.yourAnswer = selectedOption ? String.fromCharCode(65 + parseInt(selectedOption.value)) : "Không trả lời";
                            answerData.correctAnswer = String.fromCharCode(65 + item.correctAnswerIndex);
                            answerData.isCorrect = isCorrectMC;
                            break;
                        case 'true-false':
                            let correctStatementsCount = 0;
                            let yourAnswerPattern = [];
                            let correctAnswerPattern = [];
                            let details = [];
                            item.statements.forEach((s, i) => {
                                const selectedTF = document.querySelector(`input[name="q${index}-s${i}"]:checked`);
                                const studentChoice = selectedTF ? selectedTF.value === 'true' : null;
                                const isStatementCorrect = studentChoice === s.is_correct;
                               
                                if (isStatementCorrect) correctStatementsCount++;
                               
                                yourAnswerPattern.push(studentChoice === null ? '?' : (studentChoice ? 'Đ' : 'S'));
                                correctAnswerPattern.push(s.is_correct ? 'Đ' : 'S');
                                details.push({ statement: s.statement, yourChoice: studentChoice === null ? 'Không trả lời' : (studentChoice ? 'Đúng' : 'Sai'), correctChoice: s.is_correct ? 'Đúng' : 'Sai', isCorrect: isStatementCorrect });
                            });
                            
                            let scorePerTfQuestion = 0;
                            if (questionCounts['true-false'] > 0) {
                                scorePerTfQuestion = quizOptions.scoring.tf / questionCounts['true-false'];
                            }
                            let questionPoints = 0;
                            if (quizOptions.scoring.tfMethod === 'progressive') {
                                const progressivePoints = { 0: 0, 1: 0.1, 2: 0.25, 3: 0.5, 4: 1.0 };
                                questionPoints = progressivePoints[correctStatementsCount] * scorePerTfQuestion;
                            } else { // even
                                questionPoints = (correctStatementsCount / 4) * scorePerTfQuestion;
                            }
                            totalStudentScore += questionPoints;

                            if(correctStatementsCount === 4) totalCorrectAnswers++;
                            answerData.question = item.main_question;
                            answerData.yourAnswer = yourAnswerPattern.join('-');
                            answerData.correctAnswer = correctAnswerPattern.join('-');
                            answerData.isCorrect = correctStatementsCount === 4;
                            answerData.details = details;
                            break;
                       
                        case 'short-answer':
                            const saInput = document.querySelector(`input[name="q${index}"]`);
                            const studentAnswerRaw = saInput ? (saInput.value ?? '').trim() : "";
                            const correctAnswerRaw = (item.answer ?? '').toString().trim().replace(/\$/g, '');
                            let isCorrectSA = false;
                            const studentAnswerNormalized = studentAnswerRaw.replace(',', '.');
                            const correctAnswerNormalized = correctAnswerRaw.replace(',', '.');
                            if (studentAnswerNormalized.toLowerCase() === correctAnswerNormalized.toLowerCase()) {
                                isCorrectSA = true;
                            }
                             if (isCorrectSA) {
                                totalCorrectAnswers++;
                                if (questionCounts['short-answer'] > 0) {
                                   totalStudentScore += quizOptions.scoring.sa / questionCounts['short-answer'];
                                }
                            }
                            answerData.question = item.question;
                            answerData.yourAnswer = studentAnswerRaw || "Không trả lời";
                            answerData.correctAnswer = correctAnswerRaw;
                            answerData.isCorrect = isCorrectSA;
                            break;
                           
                        case 'essay':
                             const essayInput = document.querySelector(`textarea[name="q${index}"]`);
                             answerData.question = item.question;
                             answerData.yourAnswer = essayInput.value || "Không trả lời";
                             answerData.correctAnswer = item.answer;
                             answerData.isCorrect = null; // Needs manual grading
                             break;
                    }
                    allAnswersData.push(answerData);
                });
                
                const finalScore = totalStudentScore;
                
                let competencyAssessment = "Giáo viên không yêu cầu AI phân tích bài làm.";
                if (quizOptions.aiAssessment) {
                    const feedbackData = await generatePerformanceReview(allAnswersData);
                    if (feedbackData && feedbackData.overallFeedback && feedbackData.overallFeedback.summary) {
                        competencyAssessment = feedbackData.overallFeedback.summary;
                    } else {
                        competencyAssessment = "Có lỗi xảy ra trong quá trình AI phân tích bài làm.";
                    }
                }
                
                if (quizOptions.showAnswers) {
                    const totalQuestions = quizData.length;
                    resultContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg text-center">
                        <h3 class="text-2xl font-bold text-slate-800">KẾT QUẢ BÀI LÀM</h3>
                        <p class="mt-4 text-lg">Số câu đúng hoàn toàn: <span class="font-bold text-green-600">${totalCorrectAnswers}/${totalQuestions}</span></p>
                        <p class="text-2xl mt-2">Điểm (thang 10): <span class="font-bold text-blue-600">${finalScore.toFixed(2)}</span></p>
                        ${questionCounts['essay'] > 0 ? `<p class="text-sm text-gray-600 italic mt-1">Lưu ý: Điểm trên chưa bao gồm ${quizOptions.scoring.essay} điểm của phần Tự luận.</p>` : ''}
                    </div>`;
                    resultContainer.classList.remove('hidden');

                    allAnswersData.forEach((ans, index) => {
                        const questionCard = document.getElementById(`student-q-${index}`);
                        const feedbackIconDiv = document.getElementById(`q-${index}-feedback-icon`);
                        const feedbackDiv = document.getElementById(`q-${index}-feedback`);
                        if (!questionCard || !feedbackIconDiv || !feedbackDiv) return;

                        const iconHTML = ans.isCorrect === true
                            ? '<svg class="feedback-icon text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>'
                            : (ans.isCorrect === false ? '<svg class="feedback-icon text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>' : '');
                        feedbackIconDiv.innerHTML = iconHTML;

                        if (ans.type.includes('multiple-choice')) {
                            const studentChoice = ans.yourAnswer === "Không trả lời" ? -1 : ans.yourAnswer.charCodeAt(0) - 65;
                            const correctChoice = ans.correctAnswer.charCodeAt(0) - 65;
                            document.getElementById(`q-${index}-opt-label${correctChoice}`)?.classList.add('correct');
                            if (studentChoice !== -1 && studentChoice !== correctChoice) {
                                document.getElementById(`q-${index}-opt-label${studentChoice}`)?.classList.add('incorrect');
                            }
                        } else if (ans.type === 'true-false') {
                            const statementItems = questionCard.querySelectorAll('.statement-item');
                            ans.details.forEach((detail, i) => { if(statementItems[i]) { statementItems[i].classList.add(detail.isCorrect ? 'correct' : 'incorrect'); }});
                        }

                        if (quizOptions.showExplanation) {
                            feedbackDiv.innerHTML = `<button data-explain-index="${index}" class="explain-btn mt-4 flex items-center px-4 py-2 bg-blue-100 text-blue-800 text-sm font-semibold rounded-lg hover:bg-blue-200 transition-colors">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Xem giải thích
                            </button>`;
                        }
                    });
                    
                    document.querySelectorAll('.explain-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const button = e.currentTarget;
                            const index = parseInt(button.dataset.explainIndex, 10);
                            showExplanation(index, button);
                        });
                    });

                    if (window.MathJax) await window.MathJax.typesetPromise([studentQuizContainer]);
                } else {
                     resultContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg text-center"><h3 class="text-xl font-bold text-green-600">Nộp bài thành công!</h3><p class="mt-2 text-slate-700">Bạn đã hoàn thành bài làm. Kết quả sẽ được giáo viên công bố sau.</p></div>`;
                    resultContainer.classList.remove('hidden');
                }
                
                const formData = new FormData();
                formData.append('name', studentInfo.name);
                formData.append('class', studentInfo.class);
                formData.append('score', `${finalScore.toFixed(2)}/10`);
                formData.append('assessment', competencyAssessment);
                formData.append('timestamp', new Date().toLocaleString('vi-VN'));
                formData.append('examCode', correctExamCode);
                formData.append('monitoringLog', proctoringDataString);
                formData.append('answerDetails', JSON.stringify(allAnswersData));
               
                fetch(googleScriptUrl, { method: 'POST', body: formData})
                    .then(res => console.log("Successfully submitted to Google Sheet"))
                    .catch(err => console.error("Error submitting to Google Sheet:", err));
            }
           
            function startNewAttempt() {
                isSubmitted = false;
                proctoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0, suKien: [] };
                const proctoringWidget = document.getElementById('proctoring-widget');
                if (proctoringWidget) {
                    proctoringWidget.classList.add('hidden');
                    document.getElementById('tab-switch-count').textContent = '0';
                    document.getElementById('copy-count').textContent = '0';
                    document.getElementById('paste-count').textContent = '0';
                }

                renderStudentQuiz();
                resultContainer.classList.add('hidden');
                document.getElementById('ai-feedback-container').classList.add('hidden');
                postSubmitOptions.classList.add('hidden');
                submitBtn.classList.remove('hidden');
                 if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                }
                retriesLeft--;
                retriesDisplay.textContent = `Lượt làm lại còn: ${retriesLeft}`;
                window.scrollTo(0, 0);
            }
            studentInfoForm.addEventListener('submit', (e) => {
                e.preventDefault();
               
                const enteredCode = document.getElementById('exam-code').value.trim().toUpperCase();
                if (enteredCode !== correctExamCode) {
                    alert('Mã đề không chính xác. Vui lòng kiểm tra lại!');
                    return;
                }
               
                studentApiKey = teacherApiKey;
                if (!studentApiKey) {
                    console.warn('Cảnh báo: Giáo viên chưa cấu hình API Key. Các tính năng AI sẽ không hoạt động.');
                }
       
                try {
                    if (studentApiKey) {
                       ai = new GoogleGenAI({ apiKey: studentApiKey });
                    }
                } catch(e) {
                    console.error("Lỗi khởi tạo Gemini API với key của giáo viên.", e);
                    alert("Cảnh báo: API Key của giáo viên không hợp lệ. Vui lòng báo cho giáo viên. Các tính năng AI sẽ không hoạt động.");
                    ai = null;
                }
                shuffleQuiz();
               
                studentInfo.name = document.getElementById('student-name').value;
                studentInfo.class = document.getElementById('student-class').value;
                loginModal.classList.add('hidden');
                studentQuizContainer.classList.remove('hidden');
                submitBtn.classList.remove('hidden');
               
                if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                } else {
                    timerDisplay.textContent = "Không giới hạn";
                }
                retriesDisplay.textContent = `Lượt làm lại còn: ${retriesLeft}`;
                renderStudentQuiz();

                const proctoringWidget = document.getElementById('proctoring-widget');
                const tabSwitchCountEl = document.getElementById('tab-switch-count');
                const copyCountEl = document.getElementById('copy-count');
                const pasteCountEl = document.getElementById('paste-count');

                function updateProctoringUI() {
                    if (proctoringLog.thoatManHinh > 0 || proctoringLog.saoChep > 0 || proctoringLog.dan > 0) {
                        proctoringWidget.classList.remove('hidden');
                    }
                    tabSwitchCountEl.textContent = proctoringLog.thoatManHinh;
                    copyCountEl.textContent = proctoringLog.saoChep;
                    pasteCountEl.textContent = proctoringLog.dan;
                }

                // Disable Right Click
                document.addEventListener('contextmenu', e => e.preventDefault());

                // Track Tab Switching
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && !isSubmitted) {
                        proctoringLog.thoatManHinh++;
                        proctoringLog.suKien.push({ loai: 'chuyen_tab', thoiGian: new Date().toISOString() });
                        updateProctoringUI();
                    }
                });

                // Track Copying
                document.addEventListener('copy', () => {
                    if (isSubmitted) return;
                    proctoringLog.saoChep++;
                    proctoringLog.suKien.push({ loai: 'sao_chep', thoiGian: new Date().toISOString() });
                    updateProctoringUI();
                });

                // Track Pasting
                document.addEventListener('paste', () => {
                    if (isSubmitted) return;
                    proctoringLog.dan++;
                    proctoringLog.suKien.push({ loai: 'dan', thoiGian: new Date().toISOString() });
                    updateProctoringUI();
                });
            });
            
            submitBtn.addEventListener('click', handleSubmit);
            retryBtn.addEventListener('click', () => {
                shuffleQuiz();
                startNewAttempt();
            });
        </script>
    </body>
    </html>
    