<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quy tắc cộng. Quy tắc nhân</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- MathJax Configuration -->
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #f3f4f6; }
        .prose img { border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .hidden { display: none !important; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

    <!-- WELCOME SCREEN -->
    <div id="welcome-screen" class="flex-grow flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-indigo-100">
            <div class="text-center mb-8">
                <div class="bg-indigo-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Quy tắc cộng. Quy tắc nhân</h1>
                <p class="text-gray-500 text-sm">Giáo viên: Nguyễn Thị Của</p>
                <p id="time-status-msg" class="text-red-500 font-semibold mt-2 hidden"></p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Họ và tên</label>
                    <input type="text" id="name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow" placeholder="Nhập họ tên của bạn">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Lớp</label>
                    <input type="text" id="class" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow" placeholder="Nhập lớp (VD: 12A1)">
                </div>
                
                <button id="start-btn" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-[1.02] shadow-md mt-4">
                    BẮT ĐẦU LÀM BÀI
                </button>
            </div>
        </div>
    </div>

    <!-- QUIZ SCREEN -->
    <div id="quiz-screen" class="hidden flex-grow flex flex-col h-screen overflow-hidden">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 shadow-sm z-10 flex-shrink-0">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="font-bold text-gray-800 text-lg truncate max-w-[150px] sm:max-w-xs" id="student-name-display"></div>
                    <div class="hidden sm:block text-sm text-gray-500 border-l pl-4 border-gray-300">Quy tắc cộng. Quy tắc nhân</div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex flex-col items-end">
                        <span class="text-xs text-gray-500 uppercase font-semibold tracking-wider">Thời gian</span>
                        <span id="timer" class="text-xl font-mono font-bold text-indigo-600">00:00</span>
                    </div>
                    <button id="toggle-nav-btn" class="md:hidden p-2 text-gray-500 hover:bg-gray-100 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>
            </div>
            <!-- Progress Bar -->
            <div class="h-1 w-full bg-gray-100" id="progress-container">
                <div class="h-1 bg-green-500 transition-all duration-300" style="width: 0%" id="progress-bar"></div>
            </div>
        </header>

        <!-- Main Content Area -->
        <div class="flex-grow flex overflow-hidden relative">
            <!-- Questions List -->
            <main class="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8 scroll-smooth" id="main-scroll-area">
                <div class="max-w-3xl mx-auto pb-24" id="questions-container">
                    <!-- Questions injected here by JS -->
                </div>
            </main>

            <!-- Navigation Panel (Desktop: Sidebar / Mobile: Drawer) -->
            <aside id="nav-panel" class="absolute inset-y-0 right-0 w-72 bg-white border-l border-gray-200 transform translate-x-full md:relative md:translate-x-0 transition-transform duration-300 z-20 flex flex-col shadow-xl md:shadow-none">
                <div class="p-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
                    <h3 class="font-bold text-gray-700">Danh sách câu hỏi</h3>
                    <button class="md:hidden text-gray-500" onclick="document.getElementById('nav-panel').classList.add('translate-x-full')">✕</button>
                </div>
                <div class="flex-1 overflow-y-auto p-4">
                    <div class="grid grid-cols-5 gap-2" id="nav-grid">
                        <!-- Nav buttons injected here -->
                    </div>
                </div>
                <div class="p-4 border-t border-gray-200 bg-gray-50">
                    <button id="submit-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-colors shadow-sm flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" />
                        </svg>
                        NỘP BÀI
                    </button>
                </div>
            </aside>
        </div>
    </div>

    <!-- RESULT SCREEN -->
    <div id="result-screen" class="hidden flex-grow bg-gray-50 overflow-y-auto p-4">
        <div class="max-w-4xl mx-auto space-y-6">
            <!-- Score Card -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden text-center p-8 border border-gray-200 relative">
                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-green-400 to-blue-500"></div>
                <h2 class="text-3xl font-bold text-gray-800 mb-2">Kết Quả Bài Làm</h2>
                <div class="text-6xl font-black text-indigo-600 my-6 tracking-tighter" id="score-display">--</div>
                
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm bg-gray-50 p-4 rounded-xl border border-gray-100">
                    <div>
                        <p class="text-gray-500 uppercase text-xs font-semibold">Họ tên</p>
                        <p class="font-medium text-gray-900 text-lg" id="result-name">--</p>
                    </div>
                    <div>
                        <p class="text-gray-500 uppercase text-xs font-semibold">Lớp</p>
                        <p class="font-medium text-gray-900 text-lg" id="result-class">--</p>
                    </div>
                    <div>
                        <p class="text-gray-500 uppercase text-xs font-semibold">Thời gian</p>
                        <p class="font-medium text-gray-900 text-lg" id="result-time">--</p>
                    </div>
                </div>

                <div id="ai-assessment-container" class="mt-8 hidden text-left bg-indigo-50 p-6 rounded-xl border border-indigo-100">
                    <h3 class="flex items-center gap-2 font-bold text-indigo-800 mb-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                        Nhận xét từ AI
                    </h3>
                    <div id="ai-assessment-content" class="prose prose-sm prose-indigo max-w-none text-gray-700"></div>
                </div>

                <div class="mt-8">
                     <button id="view-answers-btn" class="hidden inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                        Xem đáp án chi tiết
                    </button>
                </div>
            </div>

            <!-- Detailed Answers -->
            <div id="detailed-answers" class="hidden bg-white rounded-2xl shadow-lg border border-gray-200 p-6 sm:p-8">
                <!-- Content injected by JS -->
            </div>
        </div>
    </div>

    <!-- CLIENT LOGIC SCRIPT -->
    <script type="module">
        
    import { GoogleGenAI } from "https://esm.sh/@google/genai@^1.13.0";

    // --- 1. DECODE DATA ---
    const quizData = JSON.parse(decodeURIComponent(escape(atob("W3sicXVlc3Rpb24iOiJC4bqhbiBBbiBtdeG7kW4gxJFpIHThu6sgbmjDoCDEkeG6v24gdHLGsOG7nW5nLiBDw7MgJDMkIGNvbiDEkcaw4budbmcgxJHhu4MgxJFpIHThu6sgbmjDoCDEkeG6v24gdHLhuqFtIHhlIGJ1w710LiBU4burIHRy4bqhbSB4ZSBidcO9dCwgY8OzICQyJCB0dXnhur9uIHhlIGJ1w710IMSR4bq/biBt4buZdCB0cuG6oW0gZ+G6p24gdHLGsOG7nW5nLiBOZ2/DoGkgcmEsIGPDsyAkMSQgY29uIMSRxrDhu51uZyBraMOhYyDEkWkgdGjhurNuZyB04burIG5ow6AgxJHhur9uIHRyxrDhu51uZyAoa2jDtG5nIHF1YSB0cuG6oW0geGUgYnXDvXQpLiBI4buPaSBi4bqhbiBBbiBjw7MgYmFvIG5oacOqdSBjw6FjaCBjaOG7jW4gxJHGsOG7nW5nIMSRaSB04burIG5ow6AgxJHhur9uIHRyxrDhu51uZz8iLCJvcHRpb25zIjpbIjYiLCI3IiwiOCIsIjkiXSwiY29ycmVjdEFuc3dlckluZGV4IjoxLCJ0eXBlIjoibXVsdGlwbGUtY2hvaWNlIiwiaXNEaXJ0eSI6ZmFsc2UsImV4cGxhbmF0aW9uIjpudWxsLCJzaHVmZmxlT3B0aW9ucyI6eyJzdGVtIjp0cnVlLCJhbnN3ZXJzIjp0cnVlfSwicXVlc3Rpb25OdW1iZXIiOjEsImlkIjoicV8xODU2OTI2MjE0IiwicXVlc3Rpb25TbmlwcGV0IjoiQuG6oW4gQW4gbXXhu5FuIMSRaSB04burIG5ow6AgxJHhur9uIHRyxrDhu51uZy4gQ8OzICQzJCBjb24gxJHGsOG7nW5nIMSR4buDIMSRaSB04burIG5ow6AgxJHhur9uIHRyLi4uIiwicmVuZGVyZWRfcXVlc3Rpb24iOiJC4bqhbiBBbiBtdeG7kW4gxJFpIHThu6sgbmjDoCDEkeG6v24gdHLGsOG7nW5nLiBDw7MgJDMkIGNvbiDEkcaw4budbmcgxJHhu4MgxJFpIHThu6sgbmjDoCDEkeG6v24gdHLhuqFtIHhlIGJ1w710LiBU4burIHRy4bqhbSB4ZSBidcO9dCwgY8OzICQyJCB0dXnhur9uIHhlIGJ1w710IMSR4bq/biBt4buZdCB0cuG6oW0gZ+G6p24gdHLGsOG7nW5nLiBOZ2/DoGkgcmEsIGPDsyAkMSQgY29uIMSRxrDhu51uZyBraMOhYyDEkWkgdGjhurNuZyB04burIG5ow6AgxJHhur9uIHRyxrDhu51uZyAoa2jDtG5nIHF1YSB0cuG6oW0geGUgYnXDvXQpLiBI4buPaSBi4bqhbiBBbiBjw7MgYmFvIG5oacOqdSBjw6FjaCBjaOG7jW4gxJHGsOG7nW5nIMSRaSB04burIG5ow6AgxJHhur9uIHRyxrDhu51uZz8iLCJyZW5kZXJlZF9vcHRpb25zIjpbIjYiLCI3IiwiOCIsIjkiXX0seyJxdWVzdGlvbiI6IlThu6sgY8OhYyBjaOG7ryBz4buRICQwLCAxLCAyLCAzLCA0LCA1JCwgY8OzIHRo4buDIGzhuq1wIMSRxrDhu6NjIGJhbyBuaGnDqnUgc+G7kSB04buxIG5oacOqbiBjw7MgJDMkIGNo4buvIHPhu5Ega2jDoWMgbmhhdSB2w6AgbMOgIHPhu5EgbOG6uz8iLCJvcHRpb25zIjpbIjQ4IiwiNTIiLCI2MCIsIjY0Il0sImNvcnJlY3RBbnN3ZXJJbmRleCI6MCwidHlwZSI6Im11bHRpcGxlLWNob2ljZSIsImlzRGlydHkiOmZhbHNlLCJleHBsYW5hdGlvbiI6bnVsbCwic2h1ZmZsZU9wdGlvbnMiOnsic3RlbSI6dHJ1ZSwiYW5zd2VycyI6dHJ1ZX0sInF1ZXN0aW9uTnVtYmVyIjoyLCJpZCI6InFfMTgxNDA4MDY5NCIsInF1ZXN0aW9uU25pcHBldCI6IlThu6sgY8OhYyBjaOG7ryBz4buRICQwLCAxLCAyLCAzLCA0LCA1JCwgY8OzIHRo4buDIGzhuq1wIMSRxrDhu6NjIGJhbyBuaGnDqnUgc+G7kSB04buxIG5oacOqLi4uIiwicmVuZGVyZWRfcXVlc3Rpb24iOiJU4burIGPDoWMgY2jhu68gc+G7kSAkMCwgMSwgMiwgMywgNCwgNSQsIGPDsyB0aOG7gyBs4bqtcCDEkcaw4bujYyBiYW8gbmhpw6p1IHPhu5EgdOG7sSBuaGnDqm4gY8OzICQzJCBjaOG7ryBz4buRIGtow6FjIG5oYXUgdsOgIGzDoCBz4buRIGzhurs/IiwicmVuZGVyZWRfb3B0aW9ucyI6WyI0OCIsIjUyIiwiNjAiLCI2NCJdfSx7InF1ZXN0aW9uIjoiQ8OzIGJhbyBuaGnDqnUgY8OhY2ggc+G6r3AgeOG6v3AgJDMkIGjhu41jIHNpbmggbmFtIHbDoCAkMiQgaOG7jWMgc2luaCBu4buvIHbDoG8gbeG7mXQgaMOgbmcgZ2jhur8gY8OzICQ1JCBjaOG7lyBuZ+G7k2kgc2FvIGNobyBjw6FjIGjhu41jIHNpbmggbuG7ryBsdcO0biBuZ+G7k2kgY+G6oW5oIG5oYXU/Iiwib3B0aW9ucyI6WyIyNCIsIjM2IiwiNDgiLCI3MiJdLCJjb3JyZWN0QW5zd2VySW5kZXgiOjIsInR5cGUiOiJtdWx0aXBsZS1jaG9pY2UiLCJpc0RpcnR5IjpmYWxzZSwiZXhwbGFuYXRpb24iOm51bGwsInNodWZmbGVPcHRpb25zIjp7InN0ZW0iOnRydWUsImFuc3dlcnMiOnRydWV9LCJxdWVzdGlvbk51bWJlciI6MywiaWQiOiJxXzY0NzkwNTI1NiIsInF1ZXN0aW9uU25pcHBldCI6IkPDsyBiYW8gbmhpw6p1IGPDoWNoIHPhuq9wIHjhur9wICQzJCBo4buNYyBzaW5oIG5hbSB2w6AgJDIkIGjhu41jIHNpbmggbuG7ryB2w6BvIG3hu5l0IC4uLiIsInJlbmRlcmVkX3F1ZXN0aW9uIjoiQ8OzIGJhbyBuaGnDqnUgY8OhY2ggc+G6r3AgeOG6v3AgJDMkIGjhu41jIHNpbmggbmFtIHbDoCAkMiQgaOG7jWMgc2luaCBu4buvIHbDoG8gbeG7mXQgaMOgbmcgZ2jhur8gY8OzICQ1JCBjaOG7lyBuZ+G7k2kgc2FvIGNobyBjw6FjIGjhu41jIHNpbmggbuG7ryBsdcO0biBuZ+G7k2kgY+G6oW5oIG5oYXU/IiwicmVuZGVyZWRfb3B0aW9ucyI6WyIyNCIsIjM2IiwiNDgiLCI3MiJdfSx7InF1ZXN0aW9uIjoiTeG7mXQgdGjGsCB2aeG7h24gY8OzICQxNSQgcXV54buDbiBzw6FjaCBUb8OhbiwgJDEwJCBxdXnhu4NuIHPDoWNoIFbhuq10IGzDrSB2w6AgJDgkIHF1eeG7g24gc8OhY2ggSMOzYSBo4buNYy4gSOG7j2kgY8OzIGJhbyBuaGnDqnUgY8OhY2ggxJHhu4MgbeG7mXQgaOG7jWMgc2luaCBjaOG7jW4gJDEkIHF1eeG7g24gc8OhY2g/Iiwib3B0aW9ucyI6WyIzIGPDoWNoIiwiMTUwIGPDoWNoIiwiMzMgY8OhY2giLCIxMjAwIGPDoWNoIl0sImNvcnJlY3RBbnN3ZXJJbmRleCI6MiwidHlwZSI6Im11bHRpcGxlLWNob2ljZSIsImlzRGlydHkiOmZhbHNlLCJleHBsYW5hdGlvbiI6bnVsbCwic2h1ZmZsZU9wdGlvbnMiOnsic3RlbSI6dHJ1ZSwiYW5zd2VycyI6dHJ1ZX0sInF1ZXN0aW9uTnVtYmVyIjo0LCJpZCI6InFfMTY4ODc0NDgyNSIsInF1ZXN0aW9uU25pcHBldCI6Ik3hu5l0IHRoxrAgdmnhu4duIGPDsyAkMTUkIHF1eeG7g24gc8OhY2ggVG/DoW4sICQxMCQgcXV54buDbiBzw6FjaCBW4bqtdCBsw60gdsOgICQ4JCBxdS4uLiIsInJlbmRlcmVkX3F1ZXN0aW9uIjoiTeG7mXQgdGjGsCB2aeG7h24gY8OzICQxNSQgcXV54buDbiBzw6FjaCBUb8OhbiwgJDEwJCBxdXnhu4NuIHPDoWNoIFbhuq10IGzDrSB2w6AgJDgkIHF1eeG7g24gc8OhY2ggSMOzYSBo4buNYy4gSOG7j2kgY8OzIGJhbyBuaGnDqnUgY8OhY2ggxJHhu4MgbeG7mXQgaOG7jWMgc2luaCBjaOG7jW4gJDEkIHF1eeG7g24gc8OhY2g/IiwicmVuZGVyZWRfb3B0aW9ucyI6WyIzIGPDoWNoIiwiMTUwIGPDoWNoIiwiMzMgY8OhY2giLCIxMjAwIGPDoWNoIl19LHsicXVlc3Rpb24iOiLEkOG7gyDEkWkgdOG7qyB0aMOgbmggcGjhu5EgJEEkIMSR4bq/biB0aMOgbmggcGjhu5EgJEIkIGPDsyAkMyQgY29uIMSRxrDhu51uZyBraMOhYyBuaGF1LCB04burIHRow6BuaCBwaOG7kSAkQiQgxJHhur9uIHRow6BuaCBwaOG7kSAkQyQgY8OzICQ1JCBjb24gxJHGsOG7nW5nIGtow6FjIG5oYXUuIEjhu49pIGPDsyBiYW8gbmhpw6p1IGPDoWNoIMSR4buDIMSRaSB04burIHRow6BuaCBwaOG7kSAkQSQgxJHhur9uIHRow6BuaCBwaOG7kSAkQyQgKHBo4bqjaSBxdWEgdGjDoG5oIHBo4buRICRCJCk/Iiwib3B0aW9ucyI6WyI4IGPDoWNoIiwiMTUgY8OhY2giLCIzIGPDoWNoIiwiNSBjw6FjaCJdLCJjb3JyZWN0QW5zd2VySW5kZXgiOjEsInR5cGUiOiJtdWx0aXBsZS1jaG9pY2UiLCJpc0RpcnR5IjpmYWxzZSwiZXhwbGFuYXRpb24iOm51bGwsInNodWZmbGVPcHRpb25zIjp7InN0ZW0iOnRydWUsImFuc3dlcnMiOnRydWV9LCJxdWVzdGlvbk51bWJlciI6NSwiaWQiOiJxXzE4MzA2ODY5NjMiLCJxdWVzdGlvblNuaXBwZXQiOiLEkOG7gyDEkWkgdOG7qyB0aMOgbmggcGjhu5EgJEEkIMSR4bq/biB0aMOgbmggcGjhu5EgJEIkIGPDsyAkMyQgY29uIMSRxrDhu51uZyBraMOhYyBuaGF1LCB0Li4uIiwicmVuZGVyZWRfcXVlc3Rpb24iOiLEkOG7gyDEkWkgdOG7qyB0aMOgbmggcGjhu5EgJEEkIMSR4bq/biB0aMOgbmggcGjhu5EgJEIkIGPDsyAkMyQgY29uIMSRxrDhu51uZyBraMOhYyBuaGF1LCB04burIHRow6BuaCBwaOG7kSAkQiQgxJHhur9uIHRow6BuaCBwaOG7kSAkQyQgY8OzICQ1JCBjb24gxJHGsOG7nW5nIGtow6FjIG5oYXUuIEjhu49pIGPDsyBiYW8gbmhpw6p1IGPDoWNoIMSR4buDIMSRaSB04burIHRow6BuaCBwaOG7kSAkQSQgxJHhur9uIHRow6BuaCBwaOG7kSAkQyQgKHBo4bqjaSBxdWEgdGjDoG5oIHBo4buRICRCJCk/IiwicmVuZGVyZWRfb3B0aW9ucyI6WyI4IGPDoWNoIiwiMTUgY8OhY2giLCIzIGPDoWNoIiwiNSBjw6FjaCJdfSx7InF1ZXN0aW9uIjoiTeG7mXQgbOG7m3AgaOG7jWMgY8OzICQyMCQgaOG7jWMgc2luaCBuYW0gdsOgICQxOCQgaOG7jWMgc2luaCBu4buvLiBD4bqnbiBjaOG7jW4gbeG7mXQgaOG7jWMgc2luaCBsw6BtIGzhu5twIHRyxrDhu59uZyB2w6AgbeG7mXQgaOG7jWMgc2luaCBsw6BtIGzhu5twIHBow7MuIEJp4bq/dCBy4bqxbmcgbOG7m3AgdHLGsOG7n25nIHBo4bqjaSBsw6AgbmFtIHbDoCBs4bubcCBwaMOzIHBo4bqjaSBsw6AgbuG7ry4gSOG7j2kgY8OzIGJhbyBuaGnDqnUgY8OhY2ggY2jhu41uPyIsIm9wdGlvbnMiOlsiMzggY8OhY2giLCIzNjAgY8OhY2giLCI3MjAgY8OhY2giLCIyMCBjw6FjaCJdLCJjb3JyZWN0QW5zd2VySW5kZXgiOjEsInR5cGUiOiJtdWx0aXBsZS1jaG9pY2UiLCJpc0RpcnR5IjpmYWxzZSwiZXhwbGFuYXRpb24iOm51bGwsInNodWZmbGVPcHRpb25zIjp7InN0ZW0iOnRydWUsImFuc3dlcnMiOnRydWV9LCJxdWVzdGlvbk51bWJlciI6NiwiaWQiOiJxXzMzNTMzMTI0IiwicXVlc3Rpb25TbmlwcGV0IjoiTeG7mXQgbOG7m3AgaOG7jWMgY8OzICQyMCQgaOG7jWMgc2luaCBuYW0gdsOgICQxOCQgaOG7jWMgc2luaCBu4buvLiBD4bqnbiBjaOG7jW4gbeG7mXQgaOG7jWMuLi4iLCJyZW5kZXJlZF9xdWVzdGlvbiI6Ik3hu5l0IGzhu5twIGjhu41jIGPDsyAkMjAkIGjhu41jIHNpbmggbmFtIHbDoCAkMTgkIGjhu41jIHNpbmggbuG7ry4gQ+G6p24gY2jhu41uIG3hu5l0IGjhu41jIHNpbmggbMOgbSBs4bubcCB0csaw4bufbmcgdsOgIG3hu5l0IGjhu41jIHNpbmggbMOgbSBs4bubcCBwaMOzLiBCaeG6v3QgcuG6sW5nIGzhu5twIHRyxrDhu59uZyBwaOG6o2kgbMOgIG5hbSB2w6AgbOG7m3AgcGjDsyBwaOG6o2kgbMOgIG7hu68uIEjhu49pIGPDsyBiYW8gbmhpw6p1IGPDoWNoIGNo4buNbj8iLCJyZW5kZXJlZF9vcHRpb25zIjpbIjM4IGPDoWNoIiwiMzYwIGPDoWNoIiwiNzIwIGPDoWNoIiwiMjAgY8OhY2giXX0seyJxdWVzdGlvbiI6Ik3hu5l0IGPhu61hIGjDoG5nIGPDsyAkOCQgbG/huqFpIMOhbyBzxqEgbWkgdsOgICQ1JCBsb+G6oWkgcXXhuqduIHTDonkuIEjhu49pIGPDsyBiYW8gbmhpw6p1IGPDoWNoIMSR4buDIG3hu5l0IGtow6FjaCBow6BuZyBjaOG7jW4gbXVhIG3hu5l0IG3Ds24gxJHhu5MgKGhv4bq3YyDDoW8gc8ahIG1pIGhv4bq3YyBxdeG6p24gdMOieSk/Iiwib3B0aW9ucyI6WyI0MCIsIjEzIiwiMyIsIjE2Il0sImNvcnJlY3RBbnN3ZXJJbmRleCI6MSwidHlwZSI6Im11bHRpcGxlLWNob2ljZSIsImlzRGlydHkiOmZhbHNlLCJleHBsYW5hdGlvbiI6bnVsbCwic2h1ZmZsZU9wdGlvbnMiOnsic3RlbSI6dHJ1ZSwiYW5zd2VycyI6dHJ1ZX0sInF1ZXN0aW9uTnVtYmVyIjo3LCJpZCI6InFfNDgyODkzODYyIiwicXVlc3Rpb25TbmlwcGV0IjoiTeG7mXQgY+G7rWEgaMOgbmcgY8OzICQ4JCBsb+G6oWkgw6FvIHPGoSBtaSB2w6AgJDUkIGxv4bqhaSBxdeG6p24gdMOieS4gSOG7j2kgY8OzIGJhbyBuaGkuLi4iLCJyZW5kZXJlZF9xdWVzdGlvbiI6Ik3hu5l0IGPhu61hIGjDoG5nIGPDsyAkOCQgbG/huqFpIMOhbyBzxqEgbWkgdsOgICQ1JCBsb+G6oWkgcXXhuqduIHTDonkuIEjhu49pIGPDsyBiYW8gbmhpw6p1IGPDoWNoIMSR4buDIG3hu5l0IGtow6FjaCBow6BuZyBjaOG7jW4gbXVhIG3hu5l0IG3Ds24gxJHhu5MgKGhv4bq3YyDDoW8gc8ahIG1pIGhv4bq3YyBxdeG6p24gdMOieSk/IiwicmVuZGVyZWRfb3B0aW9ucyI6WyI0MCIsIjEzIiwiMyIsIjE2Il19LHsicXVlc3Rpb24iOiJC4bqhbiBBbiBtdeG7kW4gxJFpIHThu6sgbmjDoCDEkeG6v24gdHLGsOG7nW5nLiBDw7MgJDMkIGNvbiDEkcaw4budbmcgxJFpIHThu6sgbmjDoCDEkeG6v24gYuG6v24geGUgYnXDvXQgdsOgICQ0JCBjb24gxJHGsOG7nW5nIMSRaSB04burIGLhur9uIHhlIGJ1w710IMSR4bq/biB0csaw4budbmcuIEjhu49pIGLhuqFuIEFuIGPDsyBiYW8gbmhpw6p1IGPDoWNoIMSR4buDIMSRaSB04burIG5ow6AgxJHhur9uIHRyxrDhu51uZyBi4bqxbmcgY8OhY2ggxJFpIHF1YSBi4bq/biB4ZSBidcO9dD8iLCJvcHRpb25zIjpbIjciLCIxMiIsIjEiLCI4MSJdLCJjb3JyZWN0QW5zd2VySW5kZXgiOjEsInR5cGUiOiJtdWx0aXBsZS1jaG9pY2UiLCJpc0RpcnR5IjpmYWxzZSwiZXhwbGFuYXRpb24iOm51bGwsInNodWZmbGVPcHRpb25zIjp7InN0ZW0iOnRydWUsImFuc3dlcnMiOnRydWV9LCJxdWVzdGlvbk51bWJlciI6OCwiaWQiOiJxXzEyMzg4MjUxMTciLCJxdWVzdGlvblNuaXBwZXQiOiJC4bqhbiBBbiBtdeG7kW4gxJFpIHThu6sgbmjDoCDEkeG6v24gdHLGsOG7nW5nLiBDw7MgJDMkIGNvbiDEkcaw4budbmcgxJFpIHThu6sgbmjDoCDEkeG6v24gYuG6v24geC4uLiIsInJlbmRlcmVkX3F1ZXN0aW9uIjoiQuG6oW4gQW4gbXXhu5FuIMSRaSB04burIG5ow6AgxJHhur9uIHRyxrDhu51uZy4gQ8OzICQzJCBjb24gxJHGsOG7nW5nIMSRaSB04burIG5ow6AgxJHhur9uIGLhur9uIHhlIGJ1w710IHbDoCAkNCQgY29uIMSRxrDhu51uZyDEkWkgdOG7qyBi4bq/biB4ZSBidcO9dCDEkeG6v24gdHLGsOG7nW5nLiBI4buPaSBi4bqhbiBBbiBjw7MgYmFvIG5oacOqdSBjw6FjaCDEkeG7gyDEkWkgdOG7qyBuaMOgIMSR4bq/biB0csaw4budbmcgYuG6sW5nIGPDoWNoIMSRaSBxdWEgYuG6v24geGUgYnXDvXQ/IiwicmVuZGVyZWRfb3B0aW9ucyI6WyI3IiwiMTIiLCIxIiwiODEiXX0seyJxdWVzdGlvbiI6IkPDsyBiYW8gbmhpw6p1IHPhu5EgdOG7sSBuaGnDqm4gY8OzIGhhaSBjaOG7ryBz4buRIGtow6FjIG5oYXUsIGJp4bq/dCBy4bqxbmcgY2jhu68gc+G7kSBow6BuZyBjaOG7pWMgbMOgIHPhu5EgbOG6uyB2w6AgY2jhu68gc+G7kSBow6BuZyDEkcahbiB24buLIGzDoCBz4buRIGNo4bq1bj8iLCJvcHRpb25zIjpbIjEwIiwiMjUiLCIyMCIsIjMwIl0sImNvcnJlY3RBbnN3ZXJJbmRleCI6MSwidHlwZSI6Im11bHRpcGxlLWNob2ljZSIsImlzRGlydHkiOmZhbHNlLCJleHBsYW5hdGlvbiI6bnVsbCwic2h1ZmZsZU9wdGlvbnMiOnsic3RlbSI6dHJ1ZSwiYW5zd2VycyI6dHJ1ZX0sInF1ZXN0aW9uTnVtYmVyIjo5LCJpZCI6InFfMTcwMDE3OTA2MiIsInF1ZXN0aW9uU25pcHBldCI6IkPDsyBiYW8gbmhpw6p1IHPhu5EgdOG7sSBuaGnDqm4gY8OzIGhhaSBjaOG7ryBz4buRIGtow6FjIG5oYXUsIGJp4bq/dCBy4bqxbmcgY2jhu68gc+G7kSBow6BuLi4uIiwicmVuZGVyZWRfcXVlc3Rpb24iOiJDw7MgYmFvIG5oacOqdSBz4buRIHThu7Egbmhpw6puIGPDsyBoYWkgY2jhu68gc+G7kSBraMOhYyBuaGF1LCBiaeG6v3QgcuG6sW5nIGNo4buvIHPhu5EgaMOgbmcgY2jhu6VjIGzDoCBz4buRIGzhursgdsOgIGNo4buvIHPhu5EgaMOgbmcgxJHGoW4gduG7iyBsw6Agc+G7kSBjaOG6tW4/IiwicmVuZGVyZWRfb3B0aW9ucyI6WyIxMCIsIjI1IiwiMjAiLCIzMCJdfSx7InF1ZXN0aW9uIjoiTeG7mXQgbmjDoCBow6BuZyBjw7MgJDQkIG3Ds24ga2hhaSB24buLLCAkNiQgbcOzbiBjaMOtbmggdsOgICQzJCBtw7NuIHRyw6FuZyBtaeG7h25nLiBI4buPaSBjw7MgYmFvIG5oacOqdSBjw6FjaCDEkeG7gyBjaOG7jW4gbeG7mXQgYuG7r2EgxINuIMSR4bqneSDEkeG7pyBn4buTbSBt4buZdCBtw7NuIGtoYWkgduG7iywgbeG7mXQgbcOzbiBjaMOtbmggdsOgIG3hu5l0IG3Ds24gdHLDoW5nIG1p4buHbmc/Iiwib3B0aW9ucyI6WyIxMyIsIjI3IiwiNzIiLCIyMiJdLCJjb3JyZWN0QW5zd2VySW5kZXgiOjIsInR5cGUiOiJtdWx0aXBsZS1jaG9pY2UiLCJpc0RpcnR5IjpmYWxzZSwiZXhwbGFuYXRpb24iOm51bGwsInNodWZmbGVPcHRpb25zIjp7InN0ZW0iOnRydWUsImFuc3dlcnMiOnRydWV9LCJxdWVzdGlvbk51bWJlciI6MTAsImlkIjoicV80OTkyMjA3MjgiLCJxdWVzdGlvblNuaXBwZXQiOiJN4buZdCBuaMOgIGjDoG5nIGPDsyAkNCQgbcOzbiBraGFpIHbhu4ssICQ2JCBtw7NuIGNow61uaCB2w6AgJDMkIG3Ds24gdHLDoW5nIG1p4buHbmcuLi4uIiwicmVuZGVyZWRfcXVlc3Rpb24iOiJN4buZdCBuaMOgIGjDoG5nIGPDsyAkNCQgbcOzbiBraGFpIHbhu4ssICQ2JCBtw7NuIGNow61uaCB2w6AgJDMkIG3Ds24gdHLDoW5nIG1p4buHbmcuIEjhu49pIGPDsyBiYW8gbmhpw6p1IGPDoWNoIMSR4buDIGNo4buNbiBt4buZdCBi4buvYSDEg24gxJHhuqd5IMSR4bunIGfhu5NtIG3hu5l0IG3Ds24ga2hhaSB24buLLCBt4buZdCBtw7NuIGNow61uaCB2w6AgbeG7mXQgbcOzbiB0csOhbmcgbWnhu4duZz8iLCJyZW5kZXJlZF9vcHRpb25zIjpbIjEzIiwiMjciLCI3MiIsIjIyIl19XQ=="))));
    const options = JSON.parse(decodeURIComponent(escape(atob("eyJ0aW1lTGltaXQiOjI1LCJyZXRyaWVzIjoxLCJzdGFydFRpbWUiOiIyMDI2LTAxLTE0VDAxOjU5OjAwLjAwMFoiLCJlbmRUaW1lIjpudWxsLCJzaG9ydEFuc3dlckZvcm1hdCI6ImZyZWVmb3JtIiwicG9pbnRzTUMiOjUsInBvaW50c1RGIjoyLCJwb2ludHNTQSI6MiwicG9pbnRzRXNzYXkiOjEsInBvaW50c1RGTWV0aG9kIjoicHJvZ3Jlc3NpdmUiLCJzaG93QW5zd2VycyI6dHJ1ZSwic2hvd0V4cGxhbmF0aW9uIjp0cnVlLCJhaUFzc2Vzc21lbnQiOnRydWUsInRlYWNoZXJOYW1lIjoiTmd1eeG7hW4gVGjhu4sgQ+G7p2EifQ=="))));
    const apiKeysEncoded = JSON.parse(decodeURIComponent(escape(atob("eyJnZW1pbmkiOiJaMlZ1TFd4aGJtY3RZMnhwWlc1MExUQXhOVGN6TXpBMk9UYz0iLCJvcGVuYWkiOiIiLCJkZWVwc2VlayI6IiJ9"))));
    const googleScriptUrl = "https://script.google.com/macros/s/AKfycbzkA_xNOupBBNrU2aZU6EjadgOHYp--mM1UdWCeY7bRky1Nv-rBemNyiyqcKGFSkpAgNg/exec";
    const examCode = "5Y5X45";
    const teacherName = "Nguyễn Thị Của";

    const apiKeys = {
        gemini: atob(apiKeysEncoded.gemini),
    };

    // --- 2. STATE ---
    let userAnswers = {};
    let timeLeft = options.timeLimit * 60;
    let timerInterval;
    let isSubmitted = false;
    let startTime = new Date();
    let monitorLog = {
        thoatManHinh: 0,
        saoChep: 0,
        dan: 0
    };

    // --- 3. DOM ELEMENTS ---
    const dom = {
        welcomeScreen: document.getElementById('welcome-screen'),
        quizScreen: document.getElementById('quiz-screen'),
        resultScreen: document.getElementById('result-screen'),
        nameInput: document.getElementById('name'),
        classInput: document.getElementById('class'),
        studentApiKeyInput: document.getElementById('student-api-key'),
        startBtn: document.getElementById('start-btn'),
        studentNameDisplay: document.getElementById('student-name-display'),
        timerDisplay: document.getElementById('timer'),
        questionsContainer: document.getElementById('questions-container'),
        navGrid: document.getElementById('nav-grid'),
        submitBtn: document.getElementById('submit-btn'),
        scoreDisplay: document.getElementById('score-display'),
        resultName: document.getElementById('result-name'),
        resultClass: document.getElementById('result-class'),
        resultTime: document.getElementById('result-time'),
        detailedAnswers: document.getElementById('detailed-answers'),
        viewAnswersBtn: document.getElementById('view-answers-btn'),
        aiAssessmentContainer: document.getElementById('ai-assessment-container'),
        aiAssessmentContent: document.getElementById('ai-assessment-content'),
        progressBar: document.getElementById('progress-bar')
    };

    // --- 4. INIT ---
    dom.startBtn.addEventListener('click', startQuiz);
    
    document.addEventListener('visibilitychange', () => {
        if (document.hidden && !isSubmitted && dom.quizScreen.style.display !== 'none') {
            monitorLog.thoatManHinh++;
        }
    });
    
    document.addEventListener('copy', () => { if(!isSubmitted) monitorLog.saoChep++; });
    document.addEventListener('paste', () => { if(!isSubmitted) monitorLog.dan++; });

    function startQuiz() {
        const name = dom.nameInput.value.trim();
        const className = dom.classInput.value.trim();
        if (!name || !className) {
            alert('Vui lòng nhập đầy đủ Họ tên và Lớp!');
            return;
        }
        
        if (dom.studentApiKeyInput && dom.studentApiKeyInput.value.trim()) {
            apiKeys.gemini = dom.studentApiKeyInput.value.trim();
        }

        dom.studentNameDisplay.textContent = name;
        dom.welcomeScreen.classList.add('hidden');
        dom.quizScreen.classList.remove('hidden');
        
        renderQuestions();
        renderNav();
        
        if (options.timeLimit > 0) {
            startTimer();
        } else {
            dom.timerDisplay.textContent = "--:--";
        }
        
        window.scrollTo(0, 0);
    }

    function startTimer() {
        updateTimerDisplay();
        timerInterval = setInterval(() => {
            timeLeft--;
            updateTimerDisplay();
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                submitQuiz(true);
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        const m = Math.floor(timeLeft / 60);
        const s = timeLeft % 60;
        dom.timerDisplay.textContent = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        
        const totalTime = options.timeLimit * 60;
        const percent = ((totalTime - timeLeft) / totalTime) * 100;
        dom.progressBar.style.width = `${percent}%`;
    }

    // --- 5. RENDER ---
    function renderQuestions() {
        dom.questionsContainer.innerHTML = '';
        quizData.forEach((item, index) => {
            const qDiv = document.createElement('div');
            qDiv.id = `q-${index}`;
            qDiv.className = "bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-6";
            
            let html = `<div class="mb-4">
                <span class="inline-block bg-indigo-100 text-indigo-800 text-xs font-bold px-2 py-1 rounded mr-2">Câu ${index + 1}</span>
                <span class="font-medium text-gray-800 text-lg">${item.rendered_question || item.question}</span>
            </div>`;

            if (item.type === 'multiple-choice' || item.type.startsWith('mc-')) {
                html += `<div class="grid grid-cols-1 md:grid-cols-2 gap-3">`;
                item.rendered_options.forEach((opt, i) => {
                    html += `
                    <label class="cursor-pointer">
                        <div class="flex items-center p-3 rounded-lg border border-gray-200 hover:bg-indigo-50 transition-colors">
                            <input type="radio" name="q-${index}" value="${i}" class="h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300" onchange="selectAnswer(${index}, ${i})">
                            <span class="ml-3 text-gray-700">${String.fromCharCode(65+i)}. ${opt}</span>
                        </div>
                    </label>`;
                });
                html += `</div>`;
            } else if (item.type === 'true-false' || item.type.startsWith('tf-')) {
                 html += `<table class="min-w-full divide-y divide-gray-200 border border-gray-200 rounded-lg">
                    <thead class="bg-gray-50"><tr><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Mệnh đề</th><th class="px-4 py-2 text-center text-xs font-medium text-gray-500 w-20">Đúng</th><th class="px-4 py-2 text-center text-xs font-medium text-gray-500 w-20">Sai</th></tr></thead>
                    <tbody class="bg-white divide-y divide-gray-200">`;
                 item.statements.forEach((stmt, i) => {
                     html += `<tr>
                        <td class="px-4 py-2 text-sm">${stmt.rendered_statement || stmt.statement}</td>
                        <td class="px-4 py-2 text-center"><input type="radio" name="q-${index}-${i}" value="true" onchange="selectTFAnswer(${index}, ${i}, true)"></td>
                        <td class="px-4 py-2 text-center"><input type="radio" name="q-${index}-${i}" value="false" onchange="selectTFAnswer(${index}, ${i}, false)"></td>
                     </tr>`;
                 });
                 html += `</tbody></table>`;
            } else {
                 html += `<textarea class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" rows="3" placeholder="Nhập câu trả lời của bạn..." oninput="inputAnswer(${index}, this.value)"></textarea>`;
            }

            qDiv.innerHTML = html;
            dom.questionsContainer.appendChild(qDiv);
        });
        
        if (window.MathJax) {
            window.MathJax.typesetPromise();
        }
    }

    function renderNav() {
        dom.navGrid.innerHTML = '';
        quizData.forEach((_, index) => {
            const btn = document.createElement('button');
            btn.id = `nav-${index}`;
            btn.className = "w-full aspect-square flex items-center justify-center rounded-md bg-gray-100 text-gray-600 text-xs font-bold hover:bg-gray-200 transition-colors";
            btn.textContent = index + 1;
            btn.onclick = () => {
                document.getElementById(`q-${index}`).scrollIntoView({ behavior: 'smooth', block: 'center' });
            };
            dom.navGrid.appendChild(btn);
        });
    }

    window.selectAnswer = (qIndex, oIndex) => {
        userAnswers[qIndex] = oIndex;
        updateNavStatus(qIndex);
    };

    window.selectTFAnswer = (qIndex, sIndex, val) => {
        if (!userAnswers[qIndex]) userAnswers[qIndex] = {};
        userAnswers[qIndex][sIndex] = val;
        if (Object.keys(userAnswers[qIndex]).length === quizData[qIndex].statements.length) {
            updateNavStatus(qIndex);
        }
    };

    window.inputAnswer = (qIndex, val) => {
        userAnswers[qIndex] = val.trim();
        if (val.trim()) updateNavStatus(qIndex);
        else document.getElementById(`nav-${qIndex}`).classList.remove('bg-indigo-600', 'text-white');
    };

    function updateNavStatus(index) {
        const btn = document.getElementById(`nav-${index}`);
        btn.classList.remove('bg-gray-100', 'text-gray-600');
        btn.classList.add('bg-indigo-600', 'text-white');
    }

    dom.submitBtn.addEventListener('click', () => {
        if (confirm('Bạn có chắc chắn muốn nộp bài?')) {
            submitQuiz();
        }
    });

    async function submitQuiz(autoSubmit = false) {
        if (isSubmitted) return;
        isSubmitted = true;
        clearInterval(timerInterval);

        let score = 0;
        let detailResults = [];

        quizData.forEach((item, index) => {
            let isCorrect = false;
            let detail = {};
            
            if (item.type === 'multiple-choice' || item.type.startsWith('mc-')) {
                if (userAnswers[index] === item.correctAnswerIndex) {
                    isCorrect = true;
                    score += (10 / quizData.length); 
                }
                detail = { userAnswer: userAnswers[index], correctAnswer: item.correctAnswerIndex };
            } else if (item.type === 'true-false' || item.type.startsWith('tf-')) {
                let correctStmtCount = 0;
                let stmtResults = [];
                item.statements.forEach((stmt, i) => {
                    const userVal = userAnswers[index] ? userAnswers[index][i] : null;
                    const stmtCorrect = userVal === stmt.is_correct;
                    if (stmtCorrect) correctStmtCount++;
                    stmtResults.push({ statement: i, user: userVal, correct: stmt.is_correct, isCorrect: stmtCorrect });
                });
                
                const itemScoreMax = 10 / quizData.length;
                let itemScore = 0;
                if(correctStmtCount === 1) itemScore = itemScoreMax * 0.1;
                if(correctStmtCount === 2) itemScore = itemScoreMax * 0.25;
                if(correctStmtCount === 3) itemScore = itemScoreMax * 0.5;
                if(correctStmtCount === 4) { itemScore = itemScoreMax; isCorrect = true; }
                
                score += itemScore;
                detail = { statements: stmtResults };
            }
            
            detailResults.push({
                id: item.id, // ID để thống kê câu hay sai
                questionNumber: index + 1,
                type: item.type,
                isCorrect: isCorrect,
                scoreEarned: 0,
                details: detail
            });
        });

        score = Math.min(10, Math.max(0, score));

        dom.quizScreen.classList.add('hidden');
        dom.resultScreen.classList.remove('hidden');
        
        dom.scoreDisplay.textContent = score.toFixed(2);
        dom.resultName.textContent = dom.nameInput.value;
        dom.resultClass.textContent = dom.classInput.value;
        dom.resultTime.textContent = new Date().toLocaleString();

        if (googleScriptUrl) {
            const payload = {
                timestamp: new Date().toISOString(),
                name: dom.nameInput.value,
                class: dom.classInput.value,
                score: score.toFixed(2),
                examCode: examCode,
                monitoringLog: JSON.stringify(monitorLog),
                answerDetails: JSON.stringify(detailResults)
            };
            
            fetch(googleScriptUrl, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).catch(e => console.error("Lỗi gửi điểm:", e));
        }

        if (options.showAnswers) {
            dom.viewAnswersBtn.classList.remove('hidden');
            renderDetailedAnswers(detailResults);
        }
        
        if (options.aiAssessment && apiKeys.gemini) {
            generateAIAssessment(score, detailResults);
        }
    }

    function renderDetailedAnswers(results) {
        let html = '<h3 class="text-xl font-bold mb-4 text-gray-800">Chi tiết đáp án</h3>';
        
        quizData.forEach((item, index) => {
            const result = results[index];
            const isCorrect = result.isCorrect;
            const color = isCorrect ? 'text-green-600' : 'text-red-600';
            
            html += `<div class="mb-6 p-4 border rounded-lg ${isCorrect ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}">
                <div class="font-bold mb-2 ${color}">Câu ${index + 1}: ${isCorrect ? 'ĐÚNG' : 'SAI'}</div>
                <div class="mb-2 text-gray-800">${item.rendered_question || item.question}</div>`;

            if (item.type === 'multiple-choice') {
                const userIdx = userAnswers[index];
                const correctIdx = item.correctAnswerIndex;
                html += `<div class="text-sm">
                    <p>Bạn chọn: ${userIdx !== undefined ? String.fromCharCode(65+userIdx) : 'Không trả lời'}</p>
                    <p class="font-bold text-green-700">Đáp án đúng: ${String.fromCharCode(65+correctIdx)}. ${item.options[correctIdx]}</p>
                </div>`;
            } else if (item.type === 'true-false') {
                 html += '<ul class="list-disc pl-5 text-sm">';
                 item.statements.forEach((s, i) => {
                     const userVal = userAnswers[index] ? userAnswers[index][i] : null;
                     const isStmtCorrect = userVal === s.is_correct;
                     html += `<li class="${isStmtCorrect ? 'text-green-700' : 'text-red-700'}">
                        Ý ${String.fromCharCode(97+i)}: ${s.statement} (Đáp án: ${s.is_correct ? 'Đúng' : 'Sai'} - Bạn chọn: ${userVal === null ? 'Trống' : (userVal ? 'Đúng' : 'Sai')})
                     </li>`;
                 });
                 html += '</ul>';
            }
            
            if (options.showExplanation && item.rendered_answer) {
                 html += `<div class="mt-3 pt-2 border-t border-gray-200 text-sm text-gray-600">
                    <strong>Giải thích/Đáp án chi tiết:</strong><br>
                    ${item.rendered_answer}
                 </div>`;
            }

            html += `</div>`;
        });
        
        dom.detailedAnswers.innerHTML = html;
        if (window.MathJax) window.MathJax.typesetPromise();
    }
    
    dom.viewAnswersBtn.addEventListener('click', () => {
        dom.detailedAnswers.classList.remove('hidden');
        dom.viewAnswersBtn.classList.add('hidden');
    });

    async function generateAIAssessment(score, results) {
        dom.aiAssessmentContainer.classList.remove('hidden');
        dom.aiAssessmentContent.textContent = "AI đang phân tích bài làm của bạn...";
        
        const summary = results.map(r => `Câu ${r.questionNumber} (${r.type}): ${r.isCorrect ? 'Đúng' : 'Sai'}`).join('; ');
        
        try {
            const genAI = new GoogleGenAI({ apiKey: apiKeys.gemini });
            const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });
            const prompt = `Hãy đóng vai một giáo viên, nhận xét ngắn gọn (khoảng 100 từ) về kết quả bài kiểm tra này của học sinh. 
            Điểm số: ${score}/10. 
            Chi tiết: ${summary}. 
            Hãy đưa ra lời khuyên để học sinh cải thiện, giọng điệu khích lệ.`;

            const result = await model.generateContent(prompt);
            const response = await result.response;
            const text = response.text();
            
            dom.aiAssessmentContent.innerHTML = text.replace(/\n/g, '<br>');
        } catch (e) {
            console.error("AI Error:", e);
            dom.aiAssessmentContent.textContent = "Không thể tải nhận xét từ AI lúc này.";
        }
    }
    
    </script>
</body>
</html>