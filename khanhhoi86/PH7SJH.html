
    <!DOCTYPE html>
    <html lang="vi">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ĐỀ THI THỬ</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
        <script>
            window.MathJax = {
                tex: {
                    packages: {'[+]': ['ams']},
                    inlineMath: [['$', '$'], ['\\(', '\\)']],
                    displayMath: [['$$', '$$'], ['\\[', '\\]']]
                },
                chtml: {
                    fontCache: 'global',
                    linebreaks: {
                        automatic: true
                    }
                }
            };
        </script>
        <script type="text/javascript" id="MathJax-script" async
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
        </script>
        <style>
            body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #f0f4f8; }
            .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
            @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
            .question-card {
                background-color: white;
                border-radius: 1rem;
                padding: 1.5rem 2rem;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                border-left: 5px solid transparent;
                transition: all 0.3s ease;
            }
            .ai-explanation {
                background-color: #f0f9ff;
                color: #0c4a6e;
                padding: 1rem;
                border-radius: 0.75rem;
                font-size: 0.9rem;
                margin-top: 1rem;
                border-left: 4px solid #38bdf8;
            }
            .feedback-icon { width: 1.5rem; height: 1.5rem; }
            .option-label {
                transition: all 0.2s ease-in-out;
                border: 2px solid #e5e7eb;
            }
            .option-label:hover {
                border-color: #6366f1;
                background-color: #eef2ff;
            }
            .option-label.correct {
                border-color: #10b981 !important;
                background-color: #ecfdf5 !important;
                color: #065f46;
            }
            .option-label.incorrect {
                border-color: #ef4444 !important;
                background-color: #fef2f2 !important;
                color: #991b1b;
            }
            .statement-item.correct { background-color: #ecfdf5; border-color: #10b981; }
            .statement-item.incorrect { background-color: #fef2f2; border-color: #ef4444; }
            .prose { max-width: 100%; }
            .prose h1, .prose h2, .prose h3 { font-weight: 600; }
            .prose p { margin-top: 0.5em; margin-bottom: 0.5em; }
            .prose ul, .prose ol { margin-top: 1em; margin-bottom: 1em; padding-left: 1.5em; }
            .prose li > p { margin-top: 0; margin-bottom: 0; }
            .prose code { background-color: #e5e7eb; padding: 0.2em 0.4em; margin: 0; font-size: 85%; border-radius: 3px; }
            .prose pre { background-color: #e5e7eb; padding: 1em; border-radius: 0.5em; overflow-x: auto; }
            .prose pre code { background-color: transparent; padding: 0; }
            details[open] > summary .details-arrow {
                transform: rotate(180deg);
            }
        </style>
    </head>
    <body class="bg-slate-100 text-slate-800">
        <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md transform transition-all" style="animation: fadeIn 0.3s ease-out;">
                <h2 class="text-2xl font-bold mb-2 text-center text-slate-800">Thông Tin Học Sinh</h2>
                <p class="text-center text-slate-500 mb-6">Vui lòng nhập để bắt đầu làm bài.</p>
                <form id="student-info-form">
                    <div class="mb-4">
                        <label for="student-name" class="block text-sm font-medium text-slate-700 mb-1">Họ và tên</label>
                        <input type="text" id="student-name" required class="mt-1 block w-full block border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="student-class" class="block text-sm font-medium text-slate-700 mb-1">Lớp</label>
                        <input type="text" id="student-class" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="exam-code" class="block text-sm font-medium text-slate-700 mb-1">Mã đề</label>
                        <input type="text" id="exam-code" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Nhập mã đề giáo viên cung cấp">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Giáo viên:</label>
                        <p class="mt-1 text-slate-800 bg-slate-100 p-2.5 rounded-lg">PHAN KHÁNH HỘI</p>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">Bắt đầu làm bài</button>
                </form>
            </div>
        </div>
        <div class="container mx-auto p-4 md:p-8 max-w-4xl">
            <header class="mb-10 p-8 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg">
                <div class="flex justify-between items-center flex-wrap gap-4">
                    <div>
                        <h1 class="text-4xl font-bold">ĐỀ THI THỬ</h1>
                        <p class="text-lg text-blue-100 mt-2">Hãy hoàn thành các câu hỏi dưới đây một cách tốt nhất!</p>
                        <p class="text-sm text-blue-200 mt-4">Tác giả: PHAN KHÁNH HỘI</p>
                    </div>
                    <div id="timer-container" class="text-right">
                         <div id="timer-display" class="text-3xl font-bold tracking-wider bg-white/20 px-4 py-2 rounded-lg">--:--</div>
                         <div id="retries-display" class="text-sm mt-1 text-blue-200"></div>
                    </div>
                </div>
            </header>
            <main id="student-quiz-container" class="space-y-8 hidden">
                <!-- Questions will be rendered here by JS -->
            </main>
            <footer class="mt-10 text-center">
                <button id="submit-quiz-btn" class="bg-indigo-600 text-white py-3 px-12 rounded-full font-bold text-lg hover:bg-indigo-700 transition-all duration-300 shadow-lg hover:shadow-xl hidden transform hover:scale-105">Nộp Bài</button>
                <div id="result-container" class="mt-6 hidden"></div>
                <div id="ai-feedback-container" class="mt-8 text-left hidden"></div>
                <div id="post-submit-options" class="hidden mt-6 flex flex-col sm:flex-row items-center justify-center gap-4">
                    <button id="retry-quiz-btn" class="w-full sm:w-auto bg-slate-600 text-white py-2.5 px-6 rounded-lg font-semibold hover:bg-slate-700 transition-transform transform hover:scale-105">Làm Lại Đề Này</button>
                </div>
            </footer>
        </div>

        <div id="proctoring-widget" class="fixed bottom-4 right-4 bg-yellow-100 text-yellow-800 p-3 rounded-lg shadow-lg text-sm z-50 hidden border border-yellow-300" style="max-width: 200px;">
            <h4 class="font-bold mb-2 border-b border-yellow-300 pb-1 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 3.001-1.742 3.001H4.42c-1.53 0-2.493-1.667-1.743-3.001l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                Giám sát
            </h4>
            <p>Thoát màn hình: <span id="tab-switch-count" class="font-bold">0</span></p>
            <p>Sao chép: <span id="copy-count" class="font-bold">0</span></p>
            <p>Dán: <span id="paste-count" class="font-bold">0</span></p>
        </div>

        <script type="module">
            import { GoogleGenAI, Type } from "https://esm.sh/@google/genai@^1.13.0";
            let quizData = [{"type":"multiple-choice","question":"Ngày 19-12-1946, ở Việt Nam diễn ra sự kiện nào sau đây?","questionImage":null,"mappedType":"multiple-choice","options":["Cuộc kháng chiến toàn quốc chống thực dân Pháp bùng nổ.","Cuộc kháng chiến chống thực dân Pháp trở lại xâm lược bùng nổ.","Tổng tuyển cửa bầu Quốc hội khóa I của nước Việt Nam Dân chủ Cộng hòa.","Chủ tịch Hồ Chí Minh công bố bản Tuyên ngôn Độc lập."],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Nguyên nhân trực tiếp dẫn đến việc Đảng và Chính phủ phát động Toàn quốc kháng chiến là ","questionImage":null,"mappedType":"multiple-choice","options":["thực dân Pháp gửi tối hậu thư đòi ta giải tán lực lượng vũ trang và giao quyền kiểm soát Hà Nội.","Việt Nam Dân chủ Cộng hòa không chấp nhận Hiệp định Sơ bộ (6-3-1946).","thực dân Pháp tăng cường các hành động khiêu khích quân sự ở Hải Phòng và Lạng Sơn.","Chính phủ Pháp từ chối đàm phán nghiêm túc tại Hội nghị Phông-ten-nơ-blô (Fontainebleau)."],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Lời kêu gọi toàn quốc kháng chiến vào ngày 19 tháng 12 năm 1946 được ban bố bởi ","questionImage":null,"mappedType":"multiple-choice","options":["Chủ tịch Hồ Chí Minh","Đại tướng Võ Nguyên Giáp","Tổng Bí thư Trường Chinh","Thủ tướng Phạm Văn Đồng"],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Chiến dịch Việt Bắc thu - đông năm 1947 của Pháp có mục tiêu chính là ","questionImage":null,"mappedType":"multiple-choice","options":["tiêu diệt cơ quan đầu não kháng chiến và lực lượng chủ lực của ta.","bao vây và cô lập căn cứ địa Việt Bắc khỏi sự chi viện của Trung Quốc.","bình định vùng tạm chiếm và mở rộng phạm vi kiểm soát.","thực hiện chính sách \"chia để trị\" tại Việt Bắc."],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Đại hội đại biểu toàn quốc lần thứ II của Đảng Cộng sản Đông Dương (tháng 2-1951) đã quyết định đưa Đảng ra hoạt động công khai với tên mới là  ","questionImage":null,"mappedType":"multiple-choice","options":["Đảng Lao động Việt Nam","Đảng Cộng sản Việt Nam","Đảng Dân chủ Việt Nam","Mặt trận Việt Minh"],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Chiến dịch Biên giới thu - đông năm 1950 của quân dân Việt Nam nhằm mục đích chủ yếu nào sau đây?","questionImage":null,"mappedType":"multiple-choice","options":["Phá vỡ vòng vây của Pháp ở Việt Bắc, mở rộng căn cứ địa và khai thông biên giới với Trung Quốc.","Tiêu diệt tập đoàn cứ điểm then chốt của Pháp ở đồng bằng Bắc Bộ.","Đánh bại âm mưu của Pháp lập \"xứ Thái tự trị\" ở Tây Bắc.","Giải phóng hoàn toàn các tỉnh biên giới phía Bắc."],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Kế hoạch quân sự Nava của thực dân Pháp được đề ra vào thời điểm ","questionImage":null,"mappedType":"multiple-choice","options":["quân Pháp đang lâm vào thế bị động, phòng ngự trên chiến trường.","quân Pháp  đang giành được quyền chủ động trên chiến trường.","tương quan so sánh lực lượng thay đổi có lợi cho Pháp.","Mĩ bắt đầu dính líu, can thiệp vào cuộc chiến tranh xâm lược Đông Dương."],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Tháng 12-1953,  Bộ Chính trị Ban Chấp hành Trung ương Đảng Lao động Việt Nam quyết định mở chiến dịch","questionImage":null,"mappedType":"multiple-choice","options":["Điện Biên Phủ.","Biên giới.","Việt Bắc.","Tây Bắc."],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Trong thu-đông 1953 và Xuân 1954, Kế hoạch Na-va tập trung vào ","questionImage":null,"mappedType":"multiple-choice","options":["tập trung binh lực để xây dựng lực lượng cơ động chiến lược.","tiến công chiến lược ở Bắc Bộ và Trung Bộ để giành thắng lợi quyết định.","phòng ngự chiến lược ở Trung Bộ và Nam Đông Dương.","tiến công căn cứ địa Việt Bắc để tiêu diệt cơ quan đầu não kháng chiến."],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Trong thời kì kháng chiến chống Pháp (1945 – 1954), mục tiêu cao nhất của Đảng và Chính phủ Việt Nam khi mở các chiến dịch là đều ","questionImage":null,"mappedType":"multiple-choice","options":["thay đổi tình thế trên chiến trường để đưa cuộc kháng chiến tiến lên. ","ép thực dân Pháp phải ngồi vào bàn đàm phán, kết thúc chiến tranh.","phá âm mưu đánh nhanh, thắng nhanh của giặc Pháp.","củng cố và mở rộng căn cứ địa kháng chiến Việt Bắc."],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Nguyên nhân quan trọng nhất, quyết định nhất dẫn đến thắng lợi của cuộc kháng chiến chống Pháp (1945-1954) là ","questionImage":null,"mappedType":"multiple-choice","options":["sự lãnh đạo đúng đắn của Đảng Cộng sản Đông Dương (sau là Đảng Lao động Việt Nam) và Chủ tịch Hồ Chí Minh.","tinh thần yêu nước và đoàn kết của toàn dân Việt Nam.","sự ủng hộ, giúp đỡ của các nước xã hội chủ nghĩa và bè bạn quốc tế.","lực lượng vũ trang ba thứ quân không ngừng lớn mạnh và chiến đấu kiên cường."],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Ý nghĩa lịch sử quan trọng nhất của cuộc kháng chiến chống Pháp (1945-1954) đối với cách mạng Việt Nam là","questionImage":null,"mappedType":"multiple-choice","options":["chấm dứt hoàn toàn ách thống trị của chủ nghĩa thực dân cũ ở Việt Nam, giải phóng miền Bắc, tạo điều kiện xây dựng chủ nghĩa xã hội.","hoàn thành triệt để cuộc cách mạng dân tộc dân chủ nhân dân trên cả nước.","mở ra kỷ nguyên độc lập, tự do và thống nhất đất nước.","giáng đòn nặng nề vào âm mưu can thiệp của đế quốc Mỹ vào Đông Dương."],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Một điểm tương đồng của Cách mạng tháng Tám năm 1945 và cuộc kháng chiến chống pháp (1945 - 1954) ở Việt Nam là ","questionImage":null,"mappedType":"multiple-choice","options":["luôn sáng tạo trong phương thức sử dụng lực lượng.","có sự giúp đỡ to lớn của các nước xã hội chủ nghĩa.","lực lượng vũ trang giữ vai trò quyết định thắng lợi.","lực lượng chính trị giữ vai trò quyết định thắng lợi. "],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Việc kí kết Hiệp định Sơ bộ (6/3/1946) và Tạm ước Việt - Pháp (14/9/1946) của Chính phủ Việt Nam Dân chủ Cộng hòa có mục đích chủ yếu là","questionImage":null,"mappedType":"multiple-choice","options":["kéo dài thời gian hòa bình để củng cố và chuẩn bị lực lượng cho cuộc kháng chiến lâu dài.","tranh thủ sự ủng hộ của các nước lớn đối với nền độc lập của Việt Nam.","buộc Pháp phải công nhận hoàn toàn độc lập của Việt Nam trên trường quốc tế.","giải quyết mâu thuẫn giữa Việt Minh và các đảng phái đối lập trong nước."],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Trong thời kì 1945 – 1954, kế sách quân sự “đánh điểm, đánh diệt viện, đánh truy kích” được quân dân Việt Nam thực hiện trong ","questionImage":null,"mappedType":"multiple-choice","options":["chiến dịch Điện Biên Phủ năm 1954.","chiến dịch Biên giới thu - đông năm 1950.","cuộc Tiến công chiến lược Đông - Xuân 1953 - 1954.","chiến dịch Việt Bắc thu - đông năm 1947."],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Đường lối kháng chiến chống Pháp của Đảng Cộng sản Đông Dương (sau là Đảng Lao động Việt Nam) được thể hiện rõ nét qua nội dung nào sau đây?","questionImage":null,"mappedType":"multiple-choice","options":["Toàn dân, toàn diện, trường kì, tự lực cánh sinh và tranh thủ sự ủng hộ quốc tế.","Dựa chủ yếu vào sức mạnh quân sự của các nước xã hội chủ nghĩa anh em.","Tập trung lực lượng quân sự đánh nhanh, thắng nhanh vào các đô thị lớn của địch.","Kêu gọi sự can thiệp trực tiếp của Liên hợp quốc để giải quyết xung đột."],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Mục tiêu chiến lược chủ yếu của ta khi mở Chiến dịch Biên giới thu - đông năm 1950 là ","questionImage":null,"mappedType":"multiple-choice","options":["khai thông biên giới Việt - Trung, mở rộng đường liên lạc quốc tế với các nước xã hội chủ nghĩa.","tiêu diệt một bộ phận quan trọng sinh lực địch, làm thay đổi cục diện chiến trường.","củng cố và mở rộng căn cứ địa Việt Bắc, chuẩn bị cho các chiến dịch lớn hơn.","làm phá sản hoàn toàn kế hoạch Rơve của thực dân Pháp ở Đông Dương."],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Thắng lợi của Chiến dịch Điện Biên Phủ (1954) đã buộc thực dân Pháp phải ","questionImage":null,"mappedType":"multiple-choice","options":["chấp nhận đàm phán tại Hội nghị Giơ-ne-vơ và kí kết Hiệp định chấm dứt chiến tranh ở Đông Dương.","rút quân hoàn toàn khỏi Việt Nam và Đông Dương ngay lập tức.","công nhận Việt Nam là một quốc gia độc lập, tự do.","đề ra kế hoạch quân sự mới thay thế Kế hoạch Na-va."],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Trong những năm 1945 - 1946, Chính phủ Việt Nam Dân chủ Cộng hòa đã thực hiện một trong những biện pháp nào sau đây nhằm bảo vệ chế độ mới?","questionImage":null,"mappedType":"multiple-choice","options":["Xây dựng thế trận lòng dân làm nền tảng sức mạnh kháng chiến, kiến quốc.","Kiên quyết không nhân nhượng với kẻ thù để giữ vững thành quả cách mạng. ","Kết hợp xây dựng thực lực toàn diện với tận dụng nguồn viện trợ từ bên ngoài. ","Tạm gác nhiệm vụ chống nội phản để tập trung tối đa đối phó với ngoại xâm. "],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Chiến dịch tiến công quy mô lớn đầu tiên của quân đội Việt Nam trong cuộc kháng chiến chống thực dân Pháp (1945-1954) là ","questionImage":null,"mappedType":"multiple-choice","options":["chiến dịch Biên giới. ","chiến dịch Tây Bắc.","chiến dịch Điện Biên Phủ.","chiến dịch Việt Bắc. "],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Trong bối cảnh thực dân Pháp tăng cường các hoạt động gây hấn ở miền Nam và từng bước mở rộng chiến tranh ra miền Bắc, đỉnh điểm là việc tấn công Hà Nội (19/12/1946), việc Đảng và Chính phủ Việt Nam phát động Toàn quốc kháng chiến (19/12/1946) có ý nghĩa chiến lược quan trọng nào sau đây?","questionImage":null,"mappedType":"multiple-choice","options":["Đánh dấu sự chuyển mình từ chiến tranh du kích cục bộ sang chiến tranh tổng lực.","Buộc Pháp phải từ bỏ âm mưu đánh nhanh thắng nhanh, chuyển sang đánh lâu dài.","Khẳng định quyết tâm sắt đá bảo vệ độc lập dân tộc.","Đập tan âm mưu tiêu diệt cơ quan đầu não kháng chiến và xóa bỏ căn cứ địa Việt Bắc."],"optionsImage":[null,null,null,null],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Để tăng cường xây dựng hậu phương kháng chiến, trong những năm 1951 - 1953, nhân dân Việt Nam thực hiện nhiệm vụ","questionImage":null,"mappedType":"multiple-choice","options":["bài trừ mê tín dị đoan.","phát triển kinh tế thị trường.","điện khí hóa nông nghiệp.","điện khí hóa nông thôn."],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Chiến thắng Điện Biên Phủ năm 1954 là thắng lợi quân sự lớn nhất của nhân dân Việt Nam trong cuộc kháng chiến chống Pháp (1945 - 1954), vì đã ","questionImage":null,"mappedType":"multiple-choice","options":["làm thất bại âm mưu của Mĩ muốn quốc tế hóa cuộc chiến tranh ở Đông Dương.","làm phá sản bước đầu Kế hoạch Nava của tư bản Pháp có Mĩ giúp đỡ. ","tác động trực tiếp buộc Pháp phải kí Hiệp định Giơ-ne-vơ (1954) về Đông Dương. ","dẫn tới sup đổ hoàn toàn chủ nghĩa thực dân kiểu cũ trên toàn thế giới. "],"optionsImage":[null,null,null,null],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Bài hcoj nào sau đây của cuộc kháng chiến chống thực dân Pháp (1945-1954) được xem là có ý nghĩa xuyên suốt, mang tính quyết định đến khả năng phát huy sức mạnh tổng hợp của toàn dân tộc, đưa cuộc kháng chiến đến thắng lợi?","questionImage":null,"mappedType":"multiple-choice","options":["Sự kết hợp linh hoạt giữa đấu tranh quân sự, chính trị và ngoại giao trong từng giai đoạn.","Xây dựng khối đại đoàn kết toàn dân vững chắc, dựa trên liên minh công – nông dưới sự lãnh đạo đúng đắn của Đảng.","Tận dụng và phát huy tối đa sự ủng hộ, giúp đỡ từ Liên Xô, Trung Quốc và phong trào cách mạng thế giới.","Ưu tiên xây dựng một quân đội nhân dân hùng mạnh, chính quy, có khả năng đánh bại mọi âm mưu quân sự của kẻ thù."],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"true-false","main_question":"Cho đoạn tư liệu sau đây:\n“Lần đầu tiên trong lịch sử, một nước thuộc địa nhỏ yếu đã đánh thắng một nước thực dân hùng mạnh. Đó là một thắng lợi vẻ vang của nhân dân Việt Nam, đồng thời cũng là một thắng lợi của các lực lượng hoà bình, dân chủ và xã hội chủ nghĩa trên thế giới”.\n                (Hồ Chí Minh: Toàn tập, Tập 12, NXB Chính trị quốc gia, 2011, tr. 410)\n","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Đoạn tư liệu đề cập đến nguyên nhân thắng lợi của cuộc  kháng chiến chống thực dân Pháp (1945-1954) của nhân dân Việt Nam.","is_correct":true},{"statement":"Thắng lợi của cuộc kháng chiến chống thực dân Pháp (1945-1954) của nhân dân Việt Nam đã làm sụp đổ hoàn toàn hệ thống thuộc địa của chủ nghĩa thực dân trên thế giới.","is_correct":false},{"statement":"Thắng lợi của cuộc kháng chiến chống thực dân Pháp  (1945-1954) của nhân dân Việt Nam là thắng lợi duy nhất của một nước thuộc địa trước một nước thực dân.","is_correct":false},{"statement":"Thắng lợi của cuộc kháng chiến chống thực dân Pháp (1945-1954) đã cổ vũ mạnh mẽ phong trào giải phóng dân tộc trên thế giới.","is_correct":true}]},{"type":"true-false","main_question":"Cho thông tin về một số thắng lợi tiêu biểu trong những năm 1946-1950 của qân dân Việt Nam\nCuộc chiến đấu ở các đô thị Bắc vĩ tuyến 16 (19 – 12 – 1946 đến 17 – 2 – 1947): ở các đô thị như: Nam Định, Vinh,... Đặc biệt, ở Hà Nội, các trận đánh ác liệt đã diễn ra tại khu vực Bắc Bộ Phủ, Bưu điện Bờ Hồ, ga Hàng Cỏ, phố Khâm Thiên,..\nChiến dịch Việt Bắc (1947):\tDiễn ra từ tháng 10 đến tháng 12 – 1947 khi thực dân Pháp mở cuộc tấn công lên Việt Bắc. Quân đội Việt Nam chủ động bao vây, tiến công đẩy lùi quân Pháp khỏi một số vị trí quan trọng: Chợ Đồn, Chợ Rã, Đoan Hùng...\nChiến dịch Biên Giới (1950):\tDiễn ra từ tháng 9 đến tháng 10 – 1950 ở khu vực biên giới Việt – Trung. Quân đội Việt Nam tấn công cứ điểm Đông Khê, mai phục, chặn đánh quân Pháp ở nhiều nơi trên Đường số 4, buộc chúng phải rút chạy.\n","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Cuộc chiến đấu ở các độ thị Bắc vĩ tuyến 16 làm kế hoạch “đánh nhanh, thắng nhanh” của thực dân Pháp bị thất bại hoàn toàn.","is_correct":false},{"statement":"Các chiến dịch của ta trong những năm 1946-1950 đều nhằm tiêu diệt một bộ phận sinh lực địch.","is_correct":true},{"statement":"Bảng dữ kiện thể hiện bước phát triển của cuộc chiến tranh xâm lược Đông Dương của thực dân Pháp.","is_correct":false},{"statement":"Đông Khê là trận đánh có ý nghĩa quyết định đến thắng lợi của ta quân dân ta trong chiến dịch Biên giới thu - đông năm 1950","is_correct":true}]},{"type":"true-false","main_question":"Cho đoạn tư liệu sau đây:\n\t“…Chúng ta muốn hòa bình, chúng ta phải nhân nhượng. Nhưng chúng ta càng nhân nhượng, thực dân Pháp càng lấn tới, vì chúng quyết tâm cướp nước ta lần nữa…Không! Chúng ta thà hi sinh tất cả, chứ không chịu mất nước, nhất định không chịu làm nô lệ…Bất kỳ đàn ông, đàn bà, bất kỳ người già, người trẻ, không phân chia tôn giáo, đảng phái, dân tộc. Hễ là người Việt Nam thì phải đứng lên đánh đánh Pháp để cứu Tổ Quốc…”.\n(Trích Lời kêu gọi toàn quốc kháng chiến trong Hồ Chí Minh: Toàn tập, Tập 4, \nNXB chính trị quốc gia, 2011, tr.534)\n","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Đoạn tư liệu thể hiện quyết tâm bảo vệ nền độc lập dân tộc của nhân dân Việt Nam trước cuộc chiến tranh xâm lược của thực dân Pháp.","is_correct":true},{"statement":"Cuộc kháng chiến toàn quốc chống thực dân Pháp xâm lược của nhân dân Việt Nam được tiến hành trong bối cảnh vẫn còn điều kiện để đàm phán hòa bình.","is_correct":false},{"statement":"Lời kêu gọi toàn quốc kháng chiến  của Chủ tịch Hồ Chí Minh cho thấy sự bị động của quân và dân ta  trước những âm mưu và thủ đoạn của thực dân Pháp.","is_correct":false},{"statement":"Lời kêu gọi toàn quốc kháng chiến của Chủ tịch Hồ Chí Minh cho thấy tinh thần yêu chuộng hòa bình của nhân dân Việt Nam.","is_correct":true}]},{"type":"true-false","main_question":"Cho đoạn tư liệu sau đây:\n\"Chiến dịch Việt Bắc là chiến dịch phản công lớn đầu tiên của lực lượng vũ trang\ncách mạng. Chiến thắng Việt Bắc cùng với thắng lợi trên các chiến trường khác trong thu đông năm 1947 đã đưa cuộc kháng chiến chống thực dân Pháp của nhân dân ta sang giai đoạn lịch sử mới\".\n(Nguyễn Quang Ngọc (Chủ biên), Tiến trình lịch sử Việt Nam, Nxb Giáo dục, Hà Nội, 2007, tr.313)\n","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Đoạn tư liệu đề cập đến chiến dịch quy mô lớn đầu tiên của quân đội Việt Nam trong cuộc kháng chiến chống thực dân Pháp (1945-1954).","is_correct":true},{"statement":"Chiến dịch Việt Bắc thu - đông năm 1947 của quân dân Việt Nam là chiến dịch tiến công quy mô lớn. ","is_correct":false},{"statement":"Chiến dịch Việt Bắc thu - đông năm 1947 của quân dân Việt Nam giành thắng lợi đã bước đầu làm phá sản kế hoạch \"đánh nhanh thắng nhanh\" của thực dân Pháp.","is_correct":false},{"statement":"Điểm tương đồng giữa chiến dịch Việt Bắc (1947) với chiến dịch Biên giới (1950) là đều mở ra bước phát triển mới của cuộc kháng chiến chống thực dân Pháp.","is_correct":true}]}];
            const quizOptions = {"timeLimit":50,"retriesAllowed":3,"showAnswers":true,"showExplanation":true,"aiAssessment":true,"scoring":{"mc":6,"tf":4,"sa":0,"essay":0,"tfMethod":"progressive"}};
            const googleScriptUrl = "https://script.google.com/macros/s/AKfycbx5cCrukwgBC19GOU0RL4kBhTPV9jIU1quCER6ZThvJyOM6_TB0cJZnwwVtSG1biDMb/exec";
            const correctExamCode = "PH7SJH";
            const teacherApiKey = "AIzaSyBMR8tE9QG0c398qSxgTZ7xygpjmbz91yE";
            let studentInfo = {};
            let isSubmitted = false;
            let timerInterval;
            let retriesLeft = quizOptions.retriesAllowed;
            let studentApiKey = "";
            let ai = null;

            let proctoringLog = {
                thoatManHinh: 0,
                saoChep: 0,
                dan: 0,
                suKien: []
            };

            const studentQuizContainer = document.getElementById('student-quiz-container');
            const submitBtn = document.getElementById('submit-quiz-btn');
            const resultContainer = document.getElementById('result-container');
            const postSubmitOptions = document.getElementById('post-submit-options');
            const retryBtn = document.getElementById('retry-quiz-btn');
            const loginModal = document.getElementById('login-modal');
            const studentInfoForm = document.getElementById('student-info-form');
            const timerDisplay = document.getElementById('timer-display');
            const retriesDisplay = document.getElementById('retries-display');
            function shuffleQuiz() {
                // Shuffle options/statements within each question first
                quizData.forEach(item => {
                    // Shuffle multiple-choice options and their corresponding images
                    if (item.mappedType === 'multiple-choice' && item.options && item.options.length > 0) {
                        const correctAnswerText = item.options[item.correctAnswerIndex];
                        let optionsWithImages = item.options.map((opt, index) => ({
                            text: opt,
                            image: (item.optionsImage && item.optionsImage[index]) ? item.optionsImage[index] : null
                        }));
                        // Fisher-Yates shuffle
                        for (let i = optionsWithImages.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [optionsWithImages[i], optionsWithImages[j]] = [optionsWithImages[j], optionsWithImages[i]];
                        }
                        // Update the item with shuffled data
                        item.options = optionsWithImages.map(opt => opt.text);
                        item.optionsImage = optionsWithImages.map(opt => opt.image);
                        item.correctAnswerIndex = item.options.indexOf(correctAnswerText);
                    }
                    // Shuffle true-false statements
                    if (item.mappedType === 'true-false' && item.statements && item.statements.length > 0) {
                         for (let i = item.statements.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [item.statements[i], item.statements[j]] = [item.statements[j], item.statements[i]];
                        }
                    }
                });
                // Then, group questions by type and shuffle within each group
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});
                let shuffledQuizData = [];
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    if (grouped[partType]) {
                        const partQuestions = grouped[partType];
                        for (let i = partQuestions.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [partQuestions[i], partQuestions[j]] = [partQuestions[j], partQuestions[i]];
                        }
                        shuffledQuizData = shuffledQuizData.concat(partQuestions);
                    }
                });
               
                quizData = shuffledQuizData;
            }
            // --- Timer Function ---
            function startTimer(duration, display) {
                let timer = duration, minutes, seconds;
                clearInterval(timerInterval); // Clear any existing timer
                if(duration <= 0) {
                     display.textContent = "∞";
                     return;
                }
                timerInterval = setInterval(function () {
                    minutes = parseInt(timer / 60, 10);
                    seconds = parseInt(timer % 60, 10);
                    minutes = minutes < 10 ? "0" + minutes : minutes;
                    seconds = seconds < 10 ? "0" + seconds : seconds;
                    display.textContent = minutes + ":" + seconds;
                    if (--timer < 0) {
                        clearInterval(timerInterval);
                        alert("Hết giờ làm bài!");
                        handleSubmit();
                    }
                }, 1000);
            }
            
            async function showExplanation(index, button) {
                const item = quizData[index];
                const questionCard = document.getElementById(`student-q-${index}`);
                const feedbackDiv = document.getElementById(`q-${index}-feedback`);
                if (!questionCard || !feedbackDiv) return;

                const existingExplanation = feedbackDiv.querySelector('.ai-explanation');
                if (existingExplanation) {
                    existingExplanation.remove();
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Xem giải thích
                    `;
                    return;
                }

                button.disabled = true;
                button.innerHTML = '<div class="loader mr-2"></div> Đang tải...';

                if (item.explanation) {
                    displayExplanation(item.explanation, feedbackDiv, button);
                    return;
                }

                if (!ai) {
                    alert("Tính năng giải thích yêu cầu API Key, nhưng chưa được cấu hình bởi giáo viên.");
                    button.disabled = false;
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Xem giải thích
                    `;
                    return;
                }

                const questionText = item.question || item.main_question;
                let prompt = `Bạn là một trợ lý giáo viên AI, am hiểu sâu sắc Chương trình GDPT 2018. Hãy cung cấp một lời giải chi tiết, từng bước một cho câu hỏi sau đây. Lời giải phải chính xác, dễ hiểu và phù hợp với phương pháp giảng dạy của chương trình học, TUYỆT ĐỐI KHÔNG sử dụng kiến thức của lớp cao hơn để giải thích.\n\n--- CÂU HỎI ---\n${questionText}\n\n`;
                if (item.mappedType === 'multiple-choice') {
                    prompt += `--- CÁC LỰA CHỌN ---\n${item.options.map((opt, i) => `${String.fromCharCode(65 + i)}. ${opt}`).join('\n')}\n\n`;
                    prompt += `--- ĐÁP ÁN ĐÚNG ---\n${String.fromCharCode(65 + item.correctAnswerIndex)}. ${item.options[item.correctAnswerIndex]}`;
                } else if (item.mappedType === 'true-false') {
                    prompt += `--- CÁC MỆNH ĐỀ & ĐÁP ÁN ---\n${item.statements.map(s => ` - ${s.statement} -> ${s.is_correct ? 'Đúng' : 'Sai'}`).join('\n')}`;
                } else {
                    prompt += `--- ĐÁP ÁN / GỢI Ý ---\n${item.answer}`;
                }
                prompt += `\n\n--- YÊU CẦU ---\nGiải thích rõ ràng tại sao đáp án lại đúng, từng bước một. Định dạng tất cả các công thức toán học bằng LaTeX.`;

                try {
                    const response = await ai.models.generateContent({ model: "gemini-2.5-flash", contents: prompt });
                    const explanationText = response.text.replace(/\n/g, '<br>');
                    item.explanation = explanationText; // Cache it
                    displayExplanation(explanationText, feedbackDiv, button);
                } catch (error) {
                    console.error("Lỗi khi tạo giải thích:", error);
                    feedbackDiv.insertAdjacentHTML('beforeend', '<div class="ai-explanation text-red-600">Lỗi: Không thể tạo giải thích.</div>');
                    button.disabled = false;
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Thử lại
                    `;
                }
            }

            function displayExplanation(explanationText, container, button) {
                container.insertAdjacentHTML('beforeend', `<div class="ai-explanation prose prose-sm">${explanationText}</div>`);
                if (window.MathJax) MathJax.typesetPromise([container]);
                button.disabled = false;
                button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    Ẩn giải thích
                `;
            }
           
            function renderStudentQuiz() {
                studentQuizContainer.innerHTML = '';
               
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});
                const groupInfo = {
                    'multiple-choice': { title: 'PHẦN I. TRẮC NGHIỆM KHÁCH QUAN', subtitle: 'Chọn đáp án đúng nhất trong các lựa chọn sau.' },
                    'true-false': { title: 'PHẦN II. CÂU HỎI ĐÚNG - SAI', subtitle: 'Xác định tính đúng hoặc sai cho mỗi mệnh đề dưới đây.' },
                    'short-answer': { title: 'PHẦN III. CÂU HỎI TRẢ LỜI NGẮN', subtitle: 'Điền đáp án ngắn gọn vào phần trả lời.' },
                    'essay': { title: 'PHẦN IV. CÂU HỎI TỰ LUẬN', subtitle: 'Trình bày chi tiết bài giải của bạn.' }
                };
               
                let questionCounter = 0;
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    const questions = grouped[partType];
                    if (!questions || questions.length === 0) return;
                   
                    let groupHTML = `<div class="group-container space-y-8 mb-12">`;
                    const info = groupInfo[partType];
                    groupHTML += `
                        <div class="group-header pb-3 border-b-2 border-slate-300 mb-6">
                            <h2 class="text-2xl font-bold text-slate-800">${info.title}</h2>
                            ${info.subtitle ? `<p class="text-md text-slate-600 italic mt-1">${info.subtitle}</p>` : ''}
                        </div>
                    `;
                    questions.forEach((item, localIndex) => {
                        const globalIndex = quizData.indexOf(item);
                        questionCounter++;
                        groupHTML += `<div class="question-card" id="student-q-${globalIndex}">`;
                        let questionText = (item.question || item.main_question || '').replace(/\n/g, '<br>');
                       
                        groupHTML += `<div class="flex items-start">
                                     <div class="flex-grow">
                                         <div class="flex items-center mb-2">
                                             <span class="font-bold text-lg mr-3 text-indigo-600">Câu ${questionCounter}:</span>
                                             <div id="q-${globalIndex}-feedback-icon"></div>
                                         </div>
                                         <div class="question-content mt-2 text-lg text-slate-700">${questionText}</div>
                                         ${item.questionImage ? `<img src="${item.questionImage}" class="mt-4 rounded-lg max-w-full md:max-w-md border shadow-sm">` : ''}
                                     </div>
                                 </div>`;
                       
                        groupHTML += `<div class="mt-6">`;
                        switch(item.mappedType) {
                            case 'multiple-choice':
                                groupHTML += `<div class="options-grid grid grid-cols-1 md:grid-cols-2 gap-4">`;
                                item.options.forEach((opt, i) => {
                                    groupHTML += `<label for="q${globalIndex}-opt${i}" id="q${globalIndex}-opt-label${i}" class="option-label flex items-start p-4 border-2 rounded-xl cursor-pointer hover:bg-indigo-50 hover:border-indigo-400">
                                                     <input type="radio" name="q${globalIndex}" id="q${globalIndex}-opt${i}" value="${i}" class="flex-shrink-0 mt-1 h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                                     <div class="ml-3 flex-grow">
                                                         <span class="font-semibold text-slate-800">${String.fromCharCode(65 + i)}.</span>
                                                         <span class="option-content text-slate-700">${opt || ''}</span>
                                                         ${(item.optionsImage && item.optionsImage[i]) ? `<img src="${item.optionsImage[i]}" class="mt-2 rounded-lg max-w-xs border shadow-sm">` : ''}
                                                     </div>
                                                 </label>`;
                                });
                                groupHTML += `</div>`;
                                break;
                            case 'true-false':
                                 groupHTML += `<div class="space-y-4">`;
                                 item.statements.forEach((s, i) => {
                                     groupHTML += `<div class="statement-item border-t pt-4">
                                                  <p class="mb-3 text-slate-700">${String.fromCharCode(97 + i)}) ${s.statement || ''}</p>
                                                  <div class="flex gap-x-6">
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="true" class="mr-2 h-4 w-4"> Đúng</label>
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="false" class="mr-2 h-4 w-4"> Sai</label>
                                                  </div>
                                              </div>`;
                                 });
                                 groupHTML += `</div>`;
                                 break;
                            case 'short-answer':
                                groupHTML += `<input type="text" name="q${globalIndex}" class="mt-1 block w-full md:w-1/2 border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Nhập đáp án của bạn...">`;
                                break;
                            case 'essay':
                                groupHTML += `<textarea name="q${globalIndex}" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" rows="5" placeholder="Nhập câu trả lời tự luận của bạn..."></textarea>`;
                                break;
                        }
                        groupHTML += `</div><div id="q-${globalIndex}-feedback" class="mt-4"></div></div>`;
                    });
                    groupHTML += `</div>`;
                    studentQuizContainer.innerHTML += groupHTML;
                });
               
                if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                    MathJax.typesetPromise([studentQuizContainer]);
                }
            }
           
            async function generatePerformanceReview(allAnswersData) {
                const feedbackContainer = document.getElementById('ai-feedback-container');
                if (!feedbackContainer || !ai) return null;
                feedbackContainer.classList.remove('hidden');
                feedbackContainer.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-slate-800 mb-4">📝 Phân Tích & Gợi Ý Từ Trợ Lý AI</h3>
                        <div id="ai-feedback-loader" class="text-center py-6">
                            <svg class="animate-spin mx-auto h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p class="mt-3 text-slate-600">AI đang phân tích bài làm của bạn...</p>
                        </div>
                        <div id="ai-feedback-summary" class="hidden prose prose-sm max-w-none"></div>
                        <div id="ai-feedback-details" class="hidden mt-4 space-y-2"></div>
                    </div>
                `;
               
                const loader = document.getElementById('ai-feedback-loader');
                const summaryDiv = document.getElementById('ai-feedback-summary');
                const detailsDiv = document.getElementById('ai-feedback-details');
                const incorrectAnswers = allAnswersData.filter(a => !a.isCorrect);
                if (incorrectAnswers.length === 0) {
                    feedbackContainer.innerHTML = `
                        <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                            <h3 class="text-xl font-bold text-green-600">🎉 Chúc mừng!</h3>
                            <p class="mt-2 text-slate-700">Bạn đã trả lời đúng tất cả các câu hỏi. Làm tốt lắm!</p>
                        </div>
                    `;
                    return { overallFeedback: { summary: "Xuất sắc! Học sinh đã đã trả lời đúng tất cả các câu hỏi." } };
                }
                const summaryPrompt = `Bạn là một trợ lý giáo viên, nói tiếng Việt. Dựa vào tóm tắt các câu trả lời sai của học sinh, hãy đưa ra một nhận xét tổng quan ngắn gọn (khoảng 3-4 câu) về năng lực của học sinh, bao gồm điểm mạnh (suy luận từ các câu làm đúng), điểm yếu (dựa trên các câu sai) và một vài gợi ý ôn tập chung. Lời văn phải khích lệ, rõ ràng.
                Tóm tắt lỗi sai:
                ${JSON.stringify(incorrectAnswers.map(a => ({ cau: a.questionNumber, loai: a.type, cauHoi: a.question.substring(0, 50) + '...' })), null, 2)}`;
                try {
                    const summaryResponse = await ai.models.generateContent({
                        model: "gemini-2.5-flash",
                        contents: summaryPrompt
                    });
                    summaryDiv.innerHTML = summaryResponse.text.replace(/\n/g, '<br>');
                    loader.classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                    detailsDiv.classList.remove('hidden'); 
                } catch (e) {
                    console.error("Lỗi khi lấy nhận xét tổng quan:", e);
                    summaryDiv.innerHTML = '<p class="text-red-600">Lỗi khi tạo nhận xét tổng quan.</p>';
                    loader.classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                }
               
                const summaryForSheet = summaryDiv.innerText.substring(0, 200) + "...";
                return { overallFeedback: { summary: summaryForSheet } };
            }
            async function handleSubmit() {
                if (isSubmitted) return;
                isSubmitted = true;
                clearInterval(timerInterval);
                
                document.querySelectorAll('input, textarea').forEach(input => input.disabled = true);
                submitBtn.classList.add('hidden');
                postSubmitOptions.classList.remove('hidden');
                if (retriesLeft > 0) {
                    retryBtn.classList.remove('hidden');
                } else {
                    retryBtn.classList.add('hidden');
                }

                const proctoringDataString = JSON.stringify(proctoringLog);

                let totalStudentScore = 0;
                let totalCorrectAnswers = 0;
                let allAnswersData = [];
                const questionCounts = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    acc[type] = (acc[type] || 0) + 1;
                    return acc;
                }, {});
                
                quizData.forEach((item, index) => {
                    let questionNumber = index + 1;
                    let answerData = { questionNumber, type: item.type };
                    switch (item.mappedType) {
                        case 'multiple-choice':
                            const selectedOption = document.querySelector(`input[name="q${index}"]:checked`);
                            const isCorrectMC = selectedOption ? parseInt(selectedOption.value) === item.correctAnswerIndex : false;
                            if (isCorrectMC) {
                                totalCorrectAnswers++;
                                if (questionCounts['multiple-choice'] > 0) {
                                   totalStudentScore += quizOptions.scoring.mc / questionCounts['multiple-choice'];
                                }
                            }
                            answerData.question = item.question;
                            answerData.options = item.options;
                            answerData.yourAnswer = selectedOption ? String.fromCharCode(65 + parseInt(selectedOption.value)) : "Không trả lời";
                            answerData.correctAnswer = String.fromCharCode(65 + item.correctAnswerIndex);
                            answerData.isCorrect = isCorrectMC;
                            break;
                        case 'true-false':
                            let correctStatementsCount = 0;
                            let yourAnswerPattern = [];
                            let correctAnswerPattern = [];
                            let details = [];
                            item.statements.forEach((s, i) => {
                                const selectedTF = document.querySelector(`input[name="q${index}-s${i}"]:checked`);
                                const studentChoice = selectedTF ? selectedTF.value === 'true' : null;
                                const isStatementCorrect = studentChoice === s.is_correct;
                               
                                if (isStatementCorrect) correctStatementsCount++;
                               
                                yourAnswerPattern.push(studentChoice === null ? '?' : (studentChoice ? 'Đ' : 'S'));
                                correctAnswerPattern.push(s.is_correct ? 'Đ' : 'S');
                                details.push({ statement: s.statement, yourChoice: studentChoice === null ? 'Không trả lời' : (studentChoice ? 'Đúng' : 'Sai'), correctChoice: s.is_correct ? 'Đúng' : 'Sai', isCorrect: isStatementCorrect });
                            });
                            
                            let scorePerTfQuestion = 0;
                            if (questionCounts['true-false'] > 0) {
                                scorePerTfQuestion = quizOptions.scoring.tf / questionCounts['true-false'];
                            }
                            let questionPoints = 0;
                            if (quizOptions.scoring.tfMethod === 'progressive') {
                                const progressivePoints = { 0: 0, 1: 0.1, 2: 0.25, 3: 0.5, 4: 1.0 };
                                questionPoints = progressivePoints[correctStatementsCount] * scorePerTfQuestion;
                            } else { // even
                                questionPoints = (correctStatementsCount / 4) * scorePerTfQuestion;
                            }
                            totalStudentScore += questionPoints;

                            if(correctStatementsCount === 4) totalCorrectAnswers++;
                            answerData.question = item.main_question;
                            answerData.yourAnswer = yourAnswerPattern.join('-');
                            answerData.correctAnswer = correctAnswerPattern.join('-');
                            answerData.isCorrect = correctStatementsCount === 4;
                            answerData.details = details;
                            break;
                       
                        case 'short-answer':
                            const saInput = document.querySelector(`input[name="q${index}"]`);
                            const studentAnswerRaw = saInput ? (saInput.value ?? '').trim() : "";
                            const correctAnswerRaw = (item.answer ?? '').toString().trim().replace(/\$/g, '');
                            let isCorrectSA = false;
                            const studentAnswerNormalized = studentAnswerRaw.replace(',', '.');
                            const correctAnswerNormalized = correctAnswerRaw.replace(',', '.');
                            if (studentAnswerNormalized.toLowerCase() === correctAnswerNormalized.toLowerCase()) {
                                isCorrectSA = true;
                            }
                             if (isCorrectSA) {
                                totalCorrectAnswers++;
                                if (questionCounts['short-answer'] > 0) {
                                   totalStudentScore += quizOptions.scoring.sa / questionCounts['short-answer'];
                                }
                            }
                            answerData.question = item.question;
                            answerData.yourAnswer = studentAnswerRaw || "Không trả lời";
                            answerData.correctAnswer = correctAnswerRaw;
                            answerData.isCorrect = isCorrectSA;
                            break;
                           
                        case 'essay':
                             const essayInput = document.querySelector(`textarea[name="q${index}"]`);
                             answerData.question = item.question;
                             answerData.yourAnswer = essayInput.value || "Không trả lời";
                             answerData.correctAnswer = item.answer;
                             answerData.isCorrect = null; // Needs manual grading
                             break;
                    }
                    allAnswersData.push(answerData);
                });
                
                const finalScore = totalStudentScore;
                
                let competencyAssessment = "Giáo viên không yêu cầu AI phân tích bài làm.";
                if (quizOptions.aiAssessment) {
                    const feedbackData = await generatePerformanceReview(allAnswersData);
                    if (feedbackData && feedbackData.overallFeedback && feedbackData.overallFeedback.summary) {
                        competencyAssessment = feedbackData.overallFeedback.summary;
                    } else {
                        competencyAssessment = "Có lỗi xảy ra trong quá trình AI phân tích bài làm.";
                    }
                }
                
                if (quizOptions.showAnswers) {
                    const totalQuestions = quizData.length;
                    resultContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg text-center">
                        <h3 class="text-2xl font-bold text-slate-800">KẾT QUẢ BÀI LÀM</h3>
                        <p class="mt-4 text-lg">Số câu đúng hoàn toàn: <span class="font-bold text-green-600">${totalCorrectAnswers}/${totalQuestions}</span></p>
                        <p class="text-2xl mt-2">Điểm (thang 10): <span class="font-bold text-blue-600">${finalScore.toFixed(2)}</span></p>
                        ${questionCounts['essay'] > 0 ? `<p class="text-sm text-gray-600 italic mt-1">Lưu ý: Điểm trên chưa bao gồm ${quizOptions.scoring.essay} điểm của phần Tự luận.</p>` : ''}
                    </div>`;
                    resultContainer.classList.remove('hidden');

                    allAnswersData.forEach((ans, index) => {
                        const questionCard = document.getElementById(`student-q-${index}`);
                        const feedbackIconDiv = document.getElementById(`q-${index}-feedback-icon`);
                        const feedbackDiv = document.getElementById(`q-${index}-feedback`);
                        if (!questionCard || !feedbackIconDiv || !feedbackDiv) return;

                        const iconHTML = ans.isCorrect === true
                            ? '<svg class="feedback-icon text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>'
                            : (ans.isCorrect === false ? '<svg class="feedback-icon text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>' : '');
                        feedbackIconDiv.innerHTML = iconHTML;

                        if (ans.type.includes('multiple-choice')) {
                            const studentChoice = ans.yourAnswer === "Không trả lời" ? -1 : ans.yourAnswer.charCodeAt(0) - 65;
                            const correctChoice = ans.correctAnswer.charCodeAt(0) - 65;
                            document.getElementById(`q-${index}-opt-label${correctChoice}`)?.classList.add('correct');
                            if (studentChoice !== -1 && studentChoice !== correctChoice) {
                                document.getElementById(`q-${index}-opt-label${studentChoice}`)?.classList.add('incorrect');
                            }
                        } else if (ans.type === 'true-false') {
                            const statementItems = questionCard.querySelectorAll('.statement-item');
                            ans.details.forEach((detail, i) => { if(statementItems[i]) { statementItems[i].classList.add(detail.isCorrect ? 'correct' : 'incorrect'); }});
                        }

                        if (quizOptions.showExplanation) {
                            feedbackDiv.innerHTML = `<button data-explain-index="${index}" class="explain-btn mt-4 flex items-center px-4 py-2 bg-blue-100 text-blue-800 text-sm font-semibold rounded-lg hover:bg-blue-200 transition-colors">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Xem giải thích
                            </button>`;
                        }
                    });
                    
                    document.querySelectorAll('.explain-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const button = e.currentTarget;
                            const index = parseInt(button.dataset.explainIndex, 10);
                            showExplanation(index, button);
                        });
                    });

                    if (window.MathJax) await window.MathJax.typesetPromise([studentQuizContainer]);
                } else {
                     resultContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg text-center"><h3 class="text-xl font-bold text-green-600">Nộp bài thành công!</h3><p class="mt-2 text-slate-700">Bạn đã hoàn thành bài làm. Kết quả sẽ được giáo viên công bố sau.</p></div>`;
                    resultContainer.classList.remove('hidden');
                }
                
                const formData = new FormData();
                formData.append('name', studentInfo.name);
                formData.append('class', studentInfo.class);
                formData.append('score', `${finalScore.toFixed(2)}/10`);
                formData.append('assessment', competencyAssessment);
                formData.append('timestamp', new Date().toLocaleString('vi-VN'));
                formData.append('examCode', correctExamCode);
                formData.append('monitoringLog', proctoringDataString);
                formData.append('answerDetails', JSON.stringify(allAnswersData));
               
                fetch(googleScriptUrl, { method: 'POST', body: formData})
                    .then(res => console.log("Successfully submitted to Google Sheet"))
                    .catch(err => console.error("Error submitting to Google Sheet:", err));
            }
           
            function startNewAttempt() {
                isSubmitted = false;
                proctoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0, suKien: [] };
                const proctoringWidget = document.getElementById('proctoring-widget');
                if (proctoringWidget) {
                    proctoringWidget.classList.add('hidden');
                    document.getElementById('tab-switch-count').textContent = '0';
                    document.getElementById('copy-count').textContent = '0';
                    document.getElementById('paste-count').textContent = '0';
                }

                renderStudentQuiz();
                resultContainer.classList.add('hidden');
                document.getElementById('ai-feedback-container').classList.add('hidden');
                postSubmitOptions.classList.add('hidden');
                submitBtn.classList.remove('hidden');
                 if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                }
                retriesLeft--;
                retriesDisplay.textContent = `Lượt làm lại còn: ${retriesLeft}`;
                window.scrollTo(0, 0);
            }
            studentInfoForm.addEventListener('submit', (e) => {
                e.preventDefault();
               
                const enteredCode = document.getElementById('exam-code').value.trim().toUpperCase();
                if (enteredCode !== correctExamCode) {
                    alert('Mã đề không chính xác. Vui lòng kiểm tra lại!');
                    return;
                }
               
                studentApiKey = teacherApiKey;
                if (!studentApiKey) {
                    console.warn('Cảnh báo: Giáo viên chưa cấu hình API Key. Các tính năng AI sẽ không hoạt động.');
                }
       
                try {
                    if (studentApiKey) {
                       ai = new GoogleGenAI({ apiKey: studentApiKey });
                    }
                } catch(e) {
                    console.error("Lỗi khởi tạo Gemini API với key của giáo viên.", e);
                    alert("Cảnh báo: API Key của giáo viên không hợp lệ. Vui lòng báo cho giáo viên. Các tính năng AI sẽ không hoạt động.");
                    ai = null;
                }
                shuffleQuiz();
               
                studentInfo.name = document.getElementById('student-name').value;
                studentInfo.class = document.getElementById('student-class').value;
                loginModal.classList.add('hidden');
                studentQuizContainer.classList.remove('hidden');
                submitBtn.classList.remove('hidden');
               
                if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                } else {
                    timerDisplay.textContent = "Không giới hạn";
                }
                retriesDisplay.textContent = `Lượt làm lại còn: ${retriesLeft}`;
                renderStudentQuiz();

                const proctoringWidget = document.getElementById('proctoring-widget');
                const tabSwitchCountEl = document.getElementById('tab-switch-count');
                const copyCountEl = document.getElementById('copy-count');
                const pasteCountEl = document.getElementById('paste-count');

                function updateProctoringUI() {
                    if (proctoringLog.thoatManHinh > 0 || proctoringLog.saoChep > 0 || proctoringLog.dan > 0) {
                        proctoringWidget.classList.remove('hidden');
                    }
                    tabSwitchCountEl.textContent = proctoringLog.thoatManHinh;
                    copyCountEl.textContent = proctoringLog.saoChep;
                    pasteCountEl.textContent = proctoringLog.dan;
                }

                // Disable Right Click
                document.addEventListener('contextmenu', e => e.preventDefault());

                // Track Tab Switching
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && !isSubmitted) {
                        proctoringLog.thoatManHinh++;
                        proctoringLog.suKien.push({ loai: 'chuyen_tab', thoiGian: new Date().toISOString() });
                        updateProctoringUI();
                    }
                });

                // Track Copying
                document.addEventListener('copy', () => {
                    if (isSubmitted) return;
                    proctoringLog.saoChep++;
                    proctoringLog.suKien.push({ loai: 'sao_chep', thoiGian: new Date().toISOString() });
                    updateProctoringUI();
                });

                // Track Pasting
                document.addEventListener('paste', () => {
                    if (isSubmitted) return;
                    proctoringLog.dan++;
                    proctoringLog.suKien.push({ loai: 'dan', thoiGian: new Date().toISOString() });
                    updateProctoringUI();
                });
            });
            
            submitBtn.addEventListener('click', handleSubmit);
            retryBtn.addEventListener('click', () => {
                shuffleQuiz();
                startNewAttempt();
            });
        </script>
    </body>
    </html>
    