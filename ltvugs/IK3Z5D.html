
    <!DOCTYPE html>
    <html lang="vi">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Kiểm tra thường xuyên lần 1</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
        <script>
            window.MathJax = {
                tex: {
                    packages: {'[+]': ['ams']},
                    inlineMath: [['$', '$'], ['\\(', '\\)']],
                    displayMath: [['$$', '$$'], ['\\[', '\\]']]
                },
                chtml: {
                    fontCache: 'global',
                    linebreaks: {
                        automatic: true
                    }
                }
            };
        </script>
        <script type="text/javascript" id="MathJax-script" async
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
        </script>
        <style>
            body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #f0f4f8; }
            .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
            @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
            .question-card {
                background-color: white;
                border-radius: 1rem;
                padding: 1.5rem 2rem;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                border-left: 5px solid transparent;
                transition: all 0.3s ease;
            }
            .ai-explanation {
                background-color: #f0f9ff;
                color: #0c4a6e;
                padding: 1rem;
                border-radius: 0.75rem;
                font-size: 0.9rem;
                margin-top: 1rem;
                border-left: 4px solid #38bdf8;
            }
            .feedback-icon { width: 1.5rem; height: 1.5rem; }
            .option-label {
                transition: all 0.2s ease-in-out;
                border: 2px solid #e5e7eb;
            }
            .option-label:hover {
                border-color: #6366f1;
                background-color: #eef2ff;
            }
            .option-label.correct {
                border-color: #10b981 !important;
                background-color: #ecfdf5 !important;
                color: #065f46;
            }
            .option-label.incorrect {
                border-color: #ef4444 !important;
                background-color: #fef2f2 !important;
                color: #991b1b;
            }
            .statement-item.correct { background-color: #ecfdf5; border-color: #10b981; }
            .statement-item.incorrect { background-color: #fef2f2; border-color: #ef4444; }
            .prose { max-width: 100%; }
            .prose h1, .prose h2, .prose h3 { font-weight: 600; }
            .prose p { margin-top: 0.5em; margin-bottom: 0.5em; }
            .prose ul, .prose ol { margin-top: 1em; margin-bottom: 1em; padding-left: 1.5em; }
            .prose li > p { margin-top: 0; margin-bottom: 0; }
            .prose code { background-color: #e5e7eb; padding: 0.2em 0.4em; margin: 0; font-size: 85%; border-radius: 3px; }
            .prose pre { background-color: #e5e7eb; padding: 1em; border-radius: 0.5em; overflow-x: auto; }
            .prose pre code { background-color: transparent; padding: 0; }
            details[open] > summary .details-arrow {
                transform: rotate(180deg);
            }
        </style>
    </head>
    <body class="bg-slate-100 text-slate-800">
        <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md transform transition-all" style="animation: fadeIn 0.3s ease-out;">
                <h2 class="text-2xl font-bold mb-2 text-center text-slate-800">Thông Tin Học Sinh</h2>
                <p class="text-center text-slate-500 mb-6">Vui lòng nhập để bắt đầu làm bài.</p>
                <form id="student-info-form">
                    <div class="mb-4">
                        <label for="student-name" class="block text-sm font-medium text-slate-700 mb-1">Họ và tên</label>
                        <input type="text" id="student-name" required class="mt-1 block w-full block border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="student-class" class="block text-sm font-medium text-slate-700 mb-1">Lớp</label>
                        <input type="text" id="student-class" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="exam-code" class="block text-sm font-medium text-slate-700 mb-1">Mã đề</label>
                        <input type="text" id="exam-code" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Nhập mã đề giáo viên cung cấp">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Giáo viên:</label>
                        <p class="mt-1 text-slate-800 bg-slate-100 p-2.5 rounded-lg">Lê Thanh Vũ</p>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">Bắt đầu làm bài</button>
                </form>
            </div>
        </div>
        <div class="container mx-auto p-4 md:p-8 max-w-4xl">
            <header class="mb-10 p-8 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg">
                <div class="flex justify-between items-center flex-wrap gap-4">
                    <div>
                        <h1 class="text-4xl font-bold">Kiểm tra thường xuyên lần 1</h1>
                        <p class="text-lg text-blue-100 mt-2">Hãy hoàn thành các câu hỏi dưới đây một cách tốt nhất!</p>
                        <p class="text-sm text-blue-200 mt-4">Tác giả: Lê Thanh Vũ</p>
                    </div>
                    <div id="timer-container" class="text-right">
                         <div id="timer-display" class="text-3xl font-bold tracking-wider bg-white/20 px-4 py-2 rounded-lg">--:--</div>
                         <div id="retries-display" class="text-sm mt-1 text-blue-200"></div>
                    </div>
                </div>
            </header>
            <main id="student-quiz-container" class="space-y-8 hidden">
                <!-- Questions will be rendered here by JS -->
            </main>
            <footer class="mt-10 text-center">
                <button id="submit-quiz-btn" class="bg-indigo-600 text-white py-3 px-12 rounded-full font-bold text-lg hover:bg-indigo-700 transition-all duration-300 shadow-lg hover:shadow-xl hidden transform hover:scale-105">Nộp Bài</button>
                <div id="result-container" class="mt-6 hidden"></div>
                <div id="ai-feedback-container" class="mt-8 text-left hidden"></div>
                <div id="post-submit-options" class="hidden mt-6 flex flex-col sm:flex-row items-center justify-center gap-4">
                    <button id="retry-quiz-btn" class="w-full sm:w-auto bg-slate-600 text-white py-2.5 px-6 rounded-lg font-semibold hover:bg-slate-700 transition-transform transform hover:scale-105">Làm Lại Đề Này</button>
                </div>
            </footer>
        </div>

        <div id="proctoring-widget" class="fixed bottom-4 right-4 bg-yellow-100 text-yellow-800 p-3 rounded-lg shadow-lg text-sm z-50 hidden border border-yellow-300" style="max-width: 200px;">
            <h4 class="font-bold mb-2 border-b border-yellow-300 pb-1 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 3.001-1.742 3.001H4.42c-1.53 0-2.493-1.667-1.743-3.001l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                Giám sát
            </h4>
            <p>Thoát màn hình: <span id="tab-switch-count" class="font-bold">0</span></p>
            <p>Sao chép: <span id="copy-count" class="font-bold">0</span></p>
            <p>Dán: <span id="paste-count" class="font-bold">0</span></p>
        </div>

        <script type="module">
            import { GoogleGenAI, Type } from "https://esm.sh/@google/genai@^1.13.0";
            let quizData = [{"type":"true-false","main_question":"Đâu là nhận định đúng về sự hiện diện và tác động của các thiết bị số trong thế giới kĩ thuật số hiện nay?","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Máy tính và các thiết bị số chỉ có mặt trong các lĩnh vực chuyên biệt như y tế và ngân hàng, không phổ biến trong đời sống hằng ngày.","is_correct":false},{"statement":"Smartphone và máy tính bảng là những ví dụ điển hình của thiết bị có gắn bộ xử lí thông tin, giúp người dùng thực hiện nhiều tác vụ khác nhau.","is_correct":true},{"statement":"Việc sử dụng công nghệ thông tin trong giáo dục giúp học sinh tiếp cận nguồn tài liệu đa dạng hơn và học tập mọi lúc, mọi nơi.","is_correct":true},{"statement":"Sự phát triển của công nghệ thông tin đã khiến vai trò của con người trong các ngành nghề hoàn toàn bị thay thế bởi máy móc tự động.","is_correct":false}]},{"type":"true-false","main_question":"Hãy đánh giá các phát biểu sau về khả năng và ứng dụng của máy tính trong đời sống và khoa học kĩ thuật.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Máy tính chỉ có thể thực hiện các phép tính đơn giản và không thể xử lí dữ liệu phức tạp.","is_correct":false},{"statement":"Khả năng lưu trữ và xử lí một lượng lớn dữ liệu là một trong những ưu điểm vượt trội của máy tính so với các phương pháp thủ công truyền thống.","is_correct":true},{"statement":"Trong y tế, máy tính được ứng dụng để hỗ trợ chẩn đoán bệnh, thực hiện phẫu thuật robot và quản lí hồ sơ bệnh án điện tử, nâng cao hiệu quả điều trị.","is_correct":true},{"statement":"Máy tính có khả năng tự động đưa ra các quyết định đạo đức hoặc cảm xúc mà không cần sự can thiệp của con người.","is_correct":false}]},{"type":"true-false","main_question":"Phát biểu nào sau đây thể hiện đúng tác động của công nghệ thông tin đến lĩnh vực giáo dục?","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Công nghệ thông tin không có vai trò đáng kể trong việc cải thiện chất lượng giáo dục hiện nay.","is_correct":false},{"statement":"Các nền tảng học trực tuyến và phần mềm mô phỏng giúp học sinh tiếp cận kiến thức một cách trực quan và tương tác hơn so với sách giáo khoa truyền thống.","is_correct":true},{"statement":"Nhờ công nghệ thông tin, việc học tập tại nhà hoặc từ xa trở nên khả thi, cho phép học sinh ở mọi nơi có cơ hội tiếp cận giáo dục chất lượng.","is_correct":true},{"statement":"Công nghệ thông tin đã loại bỏ hoàn toàn nhu cầu về giáo viên và trường học vật lí, chuyển đổi toàn bộ quá trình giáo dục sang môi trường ảo.","is_correct":false}]},{"type":"true-false","main_question":"Nhận định nào sau đây mô tả chính xác tác động của công nghệ thông tin lên xã hội?","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Công nghệ thông tin chỉ ảnh hưởng đến những người làm việc trong ngành công nghệ và không có tác động đến đa số người dân.","is_correct":false},{"statement":"Các giao dịch ngân hàng trực tuyến và thanh toán không tiền mặt là ví dụ về cách công nghệ thông tin thay đổi thói quen tiêu dùng và quản lí tài chính của xã hội.","is_correct":true},{"statement":"Công nghệ thông tin góp phần tạo ra các cộng đồng trực tuyến, nơi mọi người có thể kết nối, chia sẻ thông tin và hợp tác từ xa, vượt qua rào cản địa lí.","is_correct":true},{"statement":"Sự phát triển của công nghệ thông tin luôn đảm bảo sự bình đẳng về cơ hội và tiếp cận thông tin cho tất cả mọi người trong xã hội, không có bất kì khoảng cách số nào.","is_correct":false}]},{"type":"true-false","main_question":"Trong bối cảnh thế giới kĩ thuật số, hãy xác định các phát biểu đúng về sự nhận biết và tác động của nó.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Chỉ có các thiết bị lớn và phức tạp mới được coi là thiết bị số có gắn bộ xử lí thông tin.","is_correct":false},{"statement":"Đồng hồ thông minh và thiết bị định vị GPS trong ô tô đều là những ví dụ về thiết bị số hiện diện trong đời sống hàng ngày của chúng ta.","is_correct":true},{"statement":"Khả năng tính toán siêu tốc và mô phỏng thực tế ảo là hai trong số những khả năng nổi bật của máy tính, mở ra nhiều ứng dụng trong khoa học và giải trí.","is_correct":true},{"statement":"Công nghệ thông tin tự động giải quyết mọi vấn đề xã hội phức tạp như thất nghiệp hay biến đổi khí hậu mà không cần sự can thiệp của chính sách hoặc hành động của con người.","is_correct":false}]},{"type":"true-false","main_question":"Khi giải quyết một vấn đề, việc quan tâm đến thông tin đóng vai trò quan trọng. Hãy cho biết các phát biểu sau đây về thông tin và chất lượng thông tin là Đúng hay Sai.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Thông tin là yếu tố không cần thiết trong quá trình giải quyết vấn đề vì chúng ta có thể dựa vào kinh nghiệm cá nhân.","is_correct":false},{"statement":"Chất lượng thông tin chỉ là một yếu tố nhỏ, không ảnh hưởng đáng kể đến hiệu quả của việc giải quyết vấn đề.","is_correct":false},{"statement":"Để giải quyết hiệu quả các vấn đề trong học tập và đời sống, chúng ta cần tìm kiếm, tiếp nhận và trao đổi thông tin một cách có chọn lọc, ưu tiên các thông tin có chất lượng cao.","is_correct":true},{"statement":"Việc bỏ qua chất lượng thông tin khi đưa ra quyết định có thể dẫn đến hậu quả nghiêm trọng hơn so với việc không có đủ thông tin ngay từ đầu.","is_correct":true}]},{"type":"true-false","main_question":"Tính chính xác là một trong những tiêu chí quan trọng của chất lượng thông tin. Hãy đánh giá các phát biểu sau về tính chính xác của thông tin là Đúng hay Sai.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Thông tin được gọi là chính xác nếu nội dung của nó phản ánh đúng sự thật khách quan.","is_correct":true},{"statement":"Nếu thông tin không chính xác, nó có thể dẫn đến những quyết định sai lầm và gây ra tổn thất không mong muốn.","is_correct":true},{"statement":"Khi tìm kiếm thông tin về dịch bệnh, việc tham khảo các bài viết trên mạng xã hội không rõ nguồn gốc là một cách đảm bảo tính chính xác của thông tin.","is_correct":false},{"statement":"Để kiểm tra tính chính xác của thông tin, chỉ cần so sánh với một nguồn tin khác bất kỳ là đủ, không cần đánh giá độ tin cậy của nguồn.","is_correct":false}]},{"type":"true-false","main_question":"Thông tin đầy đủ giúp chúng ta có cái nhìn toàn diện về vấn đề. Hãy cho biết các phát biểu sau đây về tính đầy đủ của thông tin là Đúng hay Sai.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Thông tin đầy đủ có nghĩa là thông tin cung cấp tất cả các khía cạnh cần thiết của vấn đề đang được quan tâm.","is_correct":true},{"statement":"Một thông tin được coi là đầy đủ không có nghĩa là nó phải chứa mọi chi tiết nhỏ nhất, mà là phải có đủ thông tin cốt lõi để đưa ra quyết định hợp lý.","is_correct":true},{"statement":"Trong tình huống khẩn cấp, việc ưu tiên tính đầy đủ của thông tin hơn tính kịp thời là điều nên làm để đảm bảo an toàn.","is_correct":false},{"statement":"Để đảm bảo tính đầy đủ của thông tin khi nghiên cứu một chủ đề phức tạp, việc chỉ tìm hiểu từ một góc nhìn hoặc một nguồn duy nhất thường không đủ.","is_correct":true}]},{"type":"true-false","main_question":"Tính mới (hay tính cập nhật) của thông tin có vai trò quan trọng trong nhiều lĩnh vực. Hãy xác định các phát biểu sau đây là Đúng hay Sai.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Tính mới của thông tin thể hiện ở việc thông tin đó được tạo ra hoặc cập nhật trong thời gian gần đây nhất.","is_correct":true},{"statement":"Trong mọi trường hợp, thông tin càng mới thì càng có giá trị và hữu ích cho việc giải quyết vấn đề.","is_correct":false},{"statement":"Khi cần đưa ra quyết định về dự báo thời tiết cho ngày mai, việc sử dụng dữ liệu thời tiết của một tuần trước có thể đảm bảo tính mới của thông tin.","is_correct":false},{"statement":"Mức độ yêu cầu về tính mới của thông tin phụ thuộc vào bản chất của vấn đề cần giải quyết; một số vấn đề cần thông tin cực kì mới, trong khi các vấn đề khác có thể chấp nhận thông tin cũ hơn.","is_correct":true}]},{"type":"true-false","main_question":"Tính sử dụng được (phù hợp) của thông tin là yếu tố quyết định thông tin có thực sự hữu ích hay không. Hãy cho biết các phát biểu sau đây là Đúng hay Sai.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Thông tin phù hợp là thông tin có liên quan trực tiếp đến vấn đề đang được giải quyết và đối tượng sử dụng.","is_correct":true},{"statement":"Một thông tin có thể rất chính xác và đầy đủ, nhưng nếu nó không phù hợp với mục đích sử dụng hoặc đối tượng tiếp nhận, nó sẽ không có nhiều giá trị.","is_correct":true},{"statement":"Để lựa chọn thông tin phù hợp, chỉ cần tìm kiếm thông tin về chủ đề chính là đủ, không cần xem xét đến các yếu tố như ngôn ngữ hoặc định dạng.","is_correct":false},{"statement":"Khi nghiên cứu về lịch sử văn hóa Việt Nam, một cuốn sách viết về lịch sử các triều đại Châu Âu vẫn được xem là thông tin phù hợp nếu nó cung cấp kiến thức nền tảng về lịch sử nói chung.","is_correct":false}]},{"type":"true-false","main_question":"Phân tích và đánh giá chất lượng các mệnh đề sau liên quan đến việc đánh giá thông tin.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Thông tin có chất lượng là thông tin đúng sự thật.","is_correct":true},{"statement":"Yếu tố cập nhật không quan trọng bằng độ chính xác khi đánh giá chất lượng thông tin.","is_correct":false},{"statement":"Để đánh giá tính khách quan của thông tin, cần xem xét thông tin đó có được trình bày từ nhiều góc độ hay chỉ từ một phía.","is_correct":true},{"statement":"Khi tìm kiếm thông tin về một vấn đề phức tạp, việc chỉ tập trung vào một tiêu chí như độ tin cậy mà bỏ qua các tiêu chí khác như tính đầy đủ và phù hợp có thể dẫn đến quyết định sai lầm.","is_correct":true}]},{"type":"true-false","main_question":"Xác định tính đúng/sai của các phát biểu về nguồn thông tin và độ tin cậy.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Mọi thông tin tìm được trên Internet đều có thể được tin cậy hoàn toàn.","is_correct":false},{"statement":"Các bài báo khoa học đã được bình duyệt (peer-reviewed) thường có độ tin cậy cao hơn các bài viết blog cá nhân.","is_correct":true},{"statement":"Để xác định độ tin cậy của một thông tin trên mạng xã hội, một trong những cách hiệu quả là kiểm tra xem thông tin đó có được các tổ chức báo chí uy tín hoặc trang tin chính thống xác nhận hay không.","is_correct":true},{"statement":"Khi cần thông tin chính xác về một chính sách của nhà nước, việc tham khảo từ một trang tin tổng hợp không rõ nguồn gốc sẽ tin cậy hơn việc truy cập trực tiếp website của cơ quan ban hành chính sách đó.","is_correct":false}]},{"type":"true-false","main_question":"Đánh giá các kỹ năng và phương pháp tìm kiếm thông tin hiệu quả.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Sử dụng từ khóa càng ngắn gọn và chung chung thì kết quả tìm kiếm sẽ càng chính xác.","is_correct":false},{"statement":"Khi muốn tìm kiếm hình ảnh về một chủ đề, việc sử dụng chức năng tìm kiếm hình ảnh trên công cụ tìm kiếm là một phương pháp hiệu quả.","is_correct":true},{"statement":"Để giới hạn kết quả tìm kiếm chỉ trong một website cụ thể (ví dụ: `moet.gov.vn`), ta có thể sử dụng cú pháp `site:tên_website` cùng với từ khóa.","is_correct":true},{"statement":"Khi kết quả tìm kiếm có quá nhiều quảng cáo hoặc thông tin không liên quan, việc thay đổi công cụ tìm kiếm hoặc sử dụng các bộ lọc nâng cao thường không mang lại hiệu quả đáng kể.","is_correct":false}]},{"type":"true-false","main_question":"Xác định các tác hại của thông tin không chất lượng và cách ứng phó.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Thông tin sai lệch là thông tin không phản ánh đúng sự thật.","is_correct":true},{"statement":"Việc tiếp nhận thông tin sai lệch về sức khỏe có thể dẫn đến những hành động gây hại cho bản thân.","is_correct":true},{"statement":"Trong môi trường kinh doanh, nếu doanh nghiệp đưa ra quyết định dựa trên thông tin thị trường không chính xác, họ có thể gặp phải tổn thất lớn.","is_correct":true},{"statement":"Khi phát hiện một thông tin có dấu hiệu giả mạo, hành động tốt nhất là ngay lập tức chia sẻ để cảnh báo mọi người.","is_correct":false}]},{"type":"true-false","main_question":"Đánh giá vai trò của thông tin trong việc giải quyết vấn đề thực tiễn.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Quá trình đánh giá chất lượng thông tin chỉ cần thực hiện khi thông tin đó liên quan đến các vấn đề xã hội.","is_correct":false},{"statement":"Thông tin được cho là chất lượng khi nó đầy đủ, chính xác, khách quan và phù hợp với vấn đề đang cần giải quyết.","is_correct":true},{"statement":"Để giải quyết vấn đề \"lựa chọn trường đại học phù hợp\", việc tham khảo ý kiến từ cựu sinh viên và các diễn đàn giáo dục trực tuyến là nguồn thông tin đáng tin cậy hơn so với việc đọc duy nhất cuốn giới thiệu của trường.","is_correct":true},{"statement":"Khi đối mặt với một vấn đề cần ra quyết định khẩn cấp, việc bỏ qua bước đánh giá chất lượng thông tin để tiết kiệm thời gian là một cách hiệu quả để đưa ra quyết định nhanh chóng.","is_correct":false}]},{"type":"true-false","main_question":"Các nhận định sau về tác động tiêu cực của công nghệ số và việc sử dụng Internet là đúng hay sai?","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Sử dụng thiết bị số liên tục trong thời gian dài có thể gây hại cho thị lực và cột sống.","is_correct":true},{"statement":"Tương tác trực tuyến quá mức có thể làm suy giảm khả năng giao tiếp xã hội trực tiếp, dẫn đến cảm giác cô lập ở một số người.","is_correct":true},{"statement":"Mọi thông tin lan truyền trên mạng Internet đều được kiểm duyệt chặt chẽ bởi các cơ quan chức năng, đảm bảo độ chính xác tuyệt đối.","is_correct":false},{"statement":"Việc thường xuyên chia sẻ các thông tin cá nhân như địa chỉ nhà, số điện thoại công khai trên mạng xã hội là một cách hiệu quả để tăng cường sự gắn kết cộng đồng và không tiềm ẩn rủi ro về an ninh mạng.","is_correct":false}]},{"type":"true-false","main_question":"Các nhận định sau về các quy định pháp luật liên quan đến việc sử dụng dịch vụ Internet ở Việt Nam là đúng hay sai?","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Việt Nam có các luật và nghị định quy định về việc sử dụng Internet nhằm bảo vệ quyền lợi của người dùng và quản lý môi trường mạng.","is_correct":true},{"statement":"Luật Công nghệ thông tin và các nghị định liên quan chỉ áp dụng cho các nhà cung cấp dịch vụ Internet mà không áp dụng cho người dùng cá nhân.","is_correct":false},{"statement":"Việc tải và sử dụng các phần mềm, phim ảnh có bản quyền mà không có sự cho phép của chủ sở hữu là hành vi vi phạm pháp luật về sở hữu trí tuệ.","is_correct":true},{"statement":"Theo pháp luật Việt Nam, bất kỳ thông tin nào được đăng tải trên các nền tảng mạng xã hội đều không còn được coi là tài sản cá nhân và có thể được sử dụng tự do bởi bất kỳ ai mà không cần xin phép.","is_correct":false}]},{"type":"true-false","main_question":"Các nhận định sau về những hành vi vi phạm pháp luật, trái đạo đức, thiếu văn hóa khi hoạt động trong môi trường số là đúng hay sai?","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Hành vi lăng mạ, xúc phạm danh dự, nhân phẩm người khác trên mạng xã hội là vi phạm pháp luật.","is_correct":true},{"statement":"Tạo ra và phát tán thông tin giả mạo, sai sự thật gây hoang mang dư luận trên Internet là hành vi thiếu văn hóa nhưng không bị xử lý theo pháp luật.","is_correct":false},{"statement":"Việc bí mật thu thập thông tin cá nhân của người khác và sử dụng chúng để trục lợi mà không có sự đồng ý là hành vi vi phạm nghiêm trọng quyền riêng tư và có thể bị truy cứu trách nhiệm hình sự.","is_correct":true},{"statement":"Sử dụng hình ảnh hoặc nội dung do người khác tạo ra để chỉnh sửa, biến đổi hoặc xuyên tạc nhằm mục đích bôi nhọ, hạ thấp uy tín của họ được coi là quyền tự do ngôn luận tuyệt đối trên không gian mạng và không phải chịu bất kỳ trách nhiệm pháp lí nào.","is_correct":false}]},{"type":"true-false","main_question":"Các nhận định sau về việc sở hữu và trao đổi thông tin trong môi trường số là đúng hay sai?","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Thông tin cá nhân của một người, bao gồm tên, ngày sinh, địa chỉ, vẫn thuộc quyền sở hữu của người đó dù đã được đăng tải trên các nền tảng trực tuyến.","is_correct":true},{"statement":"Việc trao đổi thông tin nhạy cảm qua các kênh không bảo mật (ví dụ: email không mã hóa) không tiềm ẩn rủi ro bị đánh cắp hay lạm dụng.","is_correct":false},{"statement":"Khi chia sẻ thông tin cá nhân của người khác lên mạng xã hội, người chia sẻ cần được sự đồng ý của người có thông tin, nếu không có thể vi phạm quyền riêng tư.","is_correct":true},{"statement":"Một doanh nghiệp thu thập dữ liệu khách hàng thông qua các ứng dụng mà không công bố rõ ràng về mục đích sử dụng và các bên thứ ba có thể tiếp cận dữ liệu đó là hoàn toàn hợp pháp, miễn là dữ liệu đó không phải là mật khẩu ngân hàng.","is_correct":false}]},{"type":"true-false","main_question":"Các nhận định sau về các biện pháp bảo vệ thông tin và an toàn trên không gian mạng là đúng hay sai?","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Để bảo vệ thông tin cá nhân, người dùng nên thường xuyên thay đổi mật khẩu mạnh và duy nhất cho từng tài khoản trực tuyến.","is_correct":true},{"statement":"Chỉ những chuyên gia công nghệ thông tin mới cần quan tâm đến các quy định pháp luật về an ninh mạng; người dùng thông thường không cần hiểu biết các quy định này.","is_correct":false},{"statement":"Khi phát hiện tài khoản cá nhân bị xâm nhập hoặc thông tin cá nhân bị lộ, người dùng nên báo cáo ngay cho các nhà cung cấp dịch vụ và cơ quan chức năng có thẩm quyền để được hỗ trợ giải quyết.","is_correct":true},{"statement":"Việc chia sẻ tài khoản và mật khẩu của mình cho bạn bè hoặc người thân để họ tiện sử dụng các dịch vụ trực tuyến là một hành động vô hại, không làm tăng nguy cơ bị lộ thông tin hay mất an toàn dữ liệu.","is_correct":false}]}];
            const quizOptions = {"timeLimit":45,"retriesAllowed":0,"showAnswers":true,"showExplanation":true,"aiAssessment":true,"scoring":{"mc":5,"tf":2,"sa":2,"essay":1,"tfMethod":"even"}};
            const googleScriptUrl = "https://script.google.com/macros/s/AKfycbw0Gzr3a1ZDng_g7nJd-pIQPtwm4ROA25Y0mTfJX1VGLKVUSDzG-HPk3y5XG-T2QDtkdQ/exec";
            const correctExamCode = "IK3Z5D";
            const teacherApiKey = "AIzaSyDZx6aOXwW-csxBUIrhVSRcjzsxu0SqGsw";
            let studentInfo = {};
            let isSubmitted = false;
            let timerInterval;
            let retriesLeft = quizOptions.retriesAllowed;
            let studentApiKey = "";
            let ai = null;

            let proctoringLog = {
                thoatManHinh: 0,
                saoChep: 0,
                dan: 0,
                suKien: []
            };

            const studentQuizContainer = document.getElementById('student-quiz-container');
            const submitBtn = document.getElementById('submit-quiz-btn');
            const resultContainer = document.getElementById('result-container');
            const postSubmitOptions = document.getElementById('post-submit-options');
            const retryBtn = document.getElementById('retry-quiz-btn');
            const loginModal = document.getElementById('login-modal');
            const studentInfoForm = document.getElementById('student-info-form');
            const timerDisplay = document.getElementById('timer-display');
            const retriesDisplay = document.getElementById('retries-display');
            function shuffleQuiz() {
                // Shuffle options/statements within each question first
                quizData.forEach(item => {
                    // Shuffle multiple-choice options and their corresponding images
                    if (item.mappedType === 'multiple-choice' && item.options && item.options.length > 0) {
                        const correctAnswerText = item.options[item.correctAnswerIndex];
                        let optionsWithImages = item.options.map((opt, index) => ({
                            text: opt,
                            image: (item.optionsImage && item.optionsImage[index]) ? item.optionsImage[index] : null
                        }));
                        // Fisher-Yates shuffle
                        for (let i = optionsWithImages.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [optionsWithImages[i], optionsWithImages[j]] = [optionsWithImages[j], optionsWithImages[i]];
                        }
                        // Update the item with shuffled data
                        item.options = optionsWithImages.map(opt => opt.text);
                        item.optionsImage = optionsWithImages.map(opt => opt.image);
                        item.correctAnswerIndex = item.options.indexOf(correctAnswerText);
                    }
                    // Shuffle true-false statements
                    if (item.mappedType === 'true-false' && item.statements && item.statements.length > 0) {
                         for (let i = item.statements.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [item.statements[i], item.statements[j]] = [item.statements[j], item.statements[i]];
                        }
                    }
                });
                // Then, group questions by type and shuffle within each group
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});
                let shuffledQuizData = [];
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    if (grouped[partType]) {
                        const partQuestions = grouped[partType];
                        for (let i = partQuestions.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [partQuestions[i], partQuestions[j]] = [partQuestions[j], partQuestions[i]];
                        }
                        shuffledQuizData = shuffledQuizData.concat(partQuestions);
                    }
                });
               
                quizData = shuffledQuizData;
            }
            // --- Timer Function ---
            function startTimer(duration, display) {
                let timer = duration, minutes, seconds;
                clearInterval(timerInterval); // Clear any existing timer
                if(duration <= 0) {
                     display.textContent = "∞";
                     return;
                }
                timerInterval = setInterval(function () {
                    minutes = parseInt(timer / 60, 10);
                    seconds = parseInt(timer % 60, 10);
                    minutes = minutes < 10 ? "0" + minutes : minutes;
                    seconds = seconds < 10 ? "0" + seconds : seconds;
                    display.textContent = minutes + ":" + seconds;
                    if (--timer < 0) {
                        clearInterval(timerInterval);
                        alert("Hết giờ làm bài!");
                        handleSubmit();
                    }
                }, 1000);
            }
            
            async function showExplanation(index, button) {
                const item = quizData[index];
                const questionCard = document.getElementById(`student-q-${index}`);
                const feedbackDiv = document.getElementById(`q-${index}-feedback`);
                if (!questionCard || !feedbackDiv) return;

                const existingExplanation = feedbackDiv.querySelector('.ai-explanation');
                if (existingExplanation) {
                    existingExplanation.remove();
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Xem giải thích
                    `;
                    return;
                }

                button.disabled = true;
                button.innerHTML = '<div class="loader mr-2"></div> Đang tải...';

                if (item.explanation) {
                    displayExplanation(item.explanation, feedbackDiv, button);
                    return;
                }

                if (!ai) {
                    alert("Tính năng giải thích yêu cầu API Key, nhưng chưa được cấu hình bởi giáo viên.");
                    button.disabled = false;
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Xem giải thích
                    `;
                    return;
                }

                const questionText = item.question || item.main_question;
                let prompt = `Bạn là một trợ lý giáo viên AI, am hiểu sâu sắc Chương trình GDPT 2018. Hãy cung cấp một lời giải chi tiết, từng bước một cho câu hỏi sau đây. Lời giải phải chính xác, dễ hiểu và phù hợp với phương pháp giảng dạy của chương trình học, TUYỆT ĐỐI KHÔNG sử dụng kiến thức của lớp cao hơn để giải thích.\n\n--- CÂU HỎI ---\n${questionText}\n\n`;
                if (item.mappedType === 'multiple-choice') {
                    prompt += `--- CÁC LỰA CHỌN ---\n${item.options.map((opt, i) => `${String.fromCharCode(65 + i)}. ${opt}`).join('\n')}\n\n`;
                    prompt += `--- ĐÁP ÁN ĐÚNG ---\n${String.fromCharCode(65 + item.correctAnswerIndex)}. ${item.options[item.correctAnswerIndex]}`;
                } else if (item.mappedType === 'true-false') {
                    prompt += `--- CÁC MỆNH ĐỀ & ĐÁP ÁN ---\n${item.statements.map(s => ` - ${s.statement} -> ${s.is_correct ? 'Đúng' : 'Sai'}`).join('\n')}`;
                } else {
                    prompt += `--- ĐÁP ÁN / GỢI Ý ---\n${item.answer}`;
                }
                prompt += `\n\n--- YÊU CẦU ---\nGiải thích rõ ràng tại sao đáp án lại đúng, từng bước một. Định dạng tất cả các công thức toán học bằng LaTeX.`;

                try {
                    const response = await ai.models.generateContent({ model: "gemini-2.5-flash", contents: prompt });
                    const explanationText = response.text.replace(/\n/g, '<br>');
                    item.explanation = explanationText; // Cache it
                    displayExplanation(explanationText, feedbackDiv, button);
                } catch (error) {
                    console.error("Lỗi khi tạo giải thích:", error);
                    feedbackDiv.insertAdjacentHTML('beforeend', '<div class="ai-explanation text-red-600">Lỗi: Không thể tạo giải thích.</div>');
                    button.disabled = false;
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Thử lại
                    `;
                }
            }

            function displayExplanation(explanationText, container, button) {
                container.insertAdjacentHTML('beforeend', `<div class="ai-explanation prose prose-sm">${explanationText}</div>`);
                if (window.MathJax) MathJax.typesetPromise([container]);
                button.disabled = false;
                button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    Ẩn giải thích
                `;
            }
           
            function renderStudentQuiz() {
                studentQuizContainer.innerHTML = '';
               
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});
                const groupInfo = {
                    'multiple-choice': { title: 'PHẦN I. TRẮC NGHIỆM KHÁCH QUAN', subtitle: 'Chọn đáp án đúng nhất trong các lựa chọn sau.' },
                    'true-false': { title: 'PHẦN II. CÂU HỎI ĐÚNG - SAI', subtitle: 'Xác định tính đúng hoặc sai cho mỗi mệnh đề dưới đây.' },
                    'short-answer': { title: 'PHẦN III. CÂU HỎI TRẢ LỜI NGẮN', subtitle: 'Điền đáp án ngắn gọn vào phần trả lời.' },
                    'essay': { title: 'PHẦN IV. CÂU HỎI TỰ LUẬN', subtitle: 'Trình bày chi tiết bài giải của bạn.' }
                };
               
                let questionCounter = 0;
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    const questions = grouped[partType];
                    if (!questions || questions.length === 0) return;
                   
                    let groupHTML = `<div class="group-container space-y-8 mb-12">`;
                    const info = groupInfo[partType];
                    groupHTML += `
                        <div class="group-header pb-3 border-b-2 border-slate-300 mb-6">
                            <h2 class="text-2xl font-bold text-slate-800">${info.title}</h2>
                            ${info.subtitle ? `<p class="text-md text-slate-600 italic mt-1">${info.subtitle}</p>` : ''}
                        </div>
                    `;
                    questions.forEach((item, localIndex) => {
                        const globalIndex = quizData.indexOf(item);
                        questionCounter++;
                        groupHTML += `<div class="question-card" id="student-q-${globalIndex}">`;
                        let questionText = (item.question || item.main_question || '').replace(/\n/g, '<br>');
                       
                        groupHTML += `<div class="flex items-start">
                                     <div class="flex-grow">
                                         <div class="flex items-center mb-2">
                                             <span class="font-bold text-lg mr-3 text-indigo-600">Câu ${questionCounter}:</span>
                                             <div id="q-${globalIndex}-feedback-icon"></div>
                                         </div>
                                         <div class="question-content mt-2 text-lg text-slate-700">${questionText}</div>
                                         ${item.questionImage ? `<img src="${item.questionImage}" class="mt-4 rounded-lg max-w-full md:max-w-md border shadow-sm">` : ''}
                                     </div>
                                 </div>`;
                       
                        groupHTML += `<div class="mt-6">`;
                        switch(item.mappedType) {
                            case 'multiple-choice':
                                groupHTML += `<div class="options-grid grid grid-cols-1 md:grid-cols-2 gap-4">`;
                                item.options.forEach((opt, i) => {
                                    groupHTML += `<label for="q${globalIndex}-opt${i}" id="q${globalIndex}-opt-label${i}" class="option-label flex items-start p-4 border-2 rounded-xl cursor-pointer hover:bg-indigo-50 hover:border-indigo-400">
                                                     <input type="radio" name="q${globalIndex}" id="q${globalIndex}-opt${i}" value="${i}" class="flex-shrink-0 mt-1 h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                                     <div class="ml-3 flex-grow">
                                                         <span class="font-semibold text-slate-800">${String.fromCharCode(65 + i)}.</span>
                                                         <span class="option-content text-slate-700">${opt || ''}</span>
                                                         ${(item.optionsImage && item.optionsImage[i]) ? `<img src="${item.optionsImage[i]}" class="mt-2 rounded-lg max-w-xs border shadow-sm">` : ''}
                                                     </div>
                                                 </label>`;
                                });
                                groupHTML += `</div>`;
                                break;
                            case 'true-false':
                                 groupHTML += `<div class="space-y-4">`;
                                 item.statements.forEach((s, i) => {
                                     groupHTML += `<div class="statement-item border-t pt-4">
                                                  <p class="mb-3 text-slate-700">${String.fromCharCode(97 + i)}) ${s.statement || ''}</p>
                                                  <div class="flex gap-x-6">
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="true" class="mr-2 h-4 w-4"> Đúng</label>
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="false" class="mr-2 h-4 w-4"> Sai</label>
                                                  </div>
                                              </div>`;
                                 });
                                 groupHTML += `</div>`;
                                 break;
                            case 'short-answer':
                                groupHTML += `<input type="text" name="q${globalIndex}" class="mt-1 block w-full md:w-1/2 border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Nhập đáp án của bạn...">`;
                                break;
                            case 'essay':
                                groupHTML += `<textarea name="q${globalIndex}" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" rows="5" placeholder="Nhập câu trả lời tự luận của bạn..."></textarea>`;
                                break;
                        }
                        groupHTML += `</div><div id="q-${globalIndex}-feedback" class="mt-4"></div></div>`;
                    });
                    groupHTML += `</div>`;
                    studentQuizContainer.innerHTML += groupHTML;
                });
               
                if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                    MathJax.typesetPromise([studentQuizContainer]);
                }
            }
           
            async function generatePerformanceReview(allAnswersData) {
                const feedbackContainer = document.getElementById('ai-feedback-container');
                if (!feedbackContainer || !ai) return null;
                feedbackContainer.classList.remove('hidden');
                feedbackContainer.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-slate-800 mb-4">📝 Phân Tích & Gợi Ý Từ Trợ Lý AI</h3>
                        <div id="ai-feedback-loader" class="text-center py-6">
                            <svg class="animate-spin mx-auto h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p class="mt-3 text-slate-600">AI đang phân tích bài làm của bạn...</p>
                        </div>
                        <div id="ai-feedback-summary" class="hidden prose prose-sm max-w-none"></div>
                        <div id="ai-feedback-details" class="hidden mt-4 space-y-2"></div>
                    </div>
                `;
               
                const loader = document.getElementById('ai-feedback-loader');
                const summaryDiv = document.getElementById('ai-feedback-summary');
                const detailsDiv = document.getElementById('ai-feedback-details');
                const incorrectAnswers = allAnswersData.filter(a => !a.isCorrect);
                if (incorrectAnswers.length === 0) {
                    feedbackContainer.innerHTML = `
                        <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                            <h3 class="text-xl font-bold text-green-600">🎉 Chúc mừng!</h3>
                            <p class="mt-2 text-slate-700">Bạn đã trả lời đúng tất cả các câu hỏi. Làm tốt lắm!</p>
                        </div>
                    `;
                    return { overallFeedback: { summary: "Xuất sắc! Học sinh đã đã trả lời đúng tất cả các câu hỏi." } };
                }
                const summaryPrompt = `Bạn là một trợ lý giáo viên, nói tiếng Việt. Dựa vào tóm tắt các câu trả lời sai của học sinh, hãy đưa ra một nhận xét tổng quan ngắn gọn (khoảng 3-4 câu) về năng lực của học sinh, bao gồm điểm mạnh (suy luận từ các câu làm đúng), điểm yếu (dựa trên các câu sai) và một vài gợi ý ôn tập chung. Lời văn phải khích lệ, rõ ràng.
                Tóm tắt lỗi sai:
                ${JSON.stringify(incorrectAnswers.map(a => ({ cau: a.questionNumber, loai: a.type, cauHoi: a.question.substring(0, 50) + '...' })), null, 2)}`;
                try {
                    const summaryResponse = await ai.models.generateContent({
                        model: "gemini-2.5-flash",
                        contents: summaryPrompt
                    });
                    summaryDiv.innerHTML = summaryResponse.text.replace(/\n/g, '<br>');
                    loader.classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                    detailsDiv.classList.remove('hidden'); 
                } catch (e) {
                    console.error("Lỗi khi lấy nhận xét tổng quan:", e);
                    summaryDiv.innerHTML = '<p class="text-red-600">Lỗi khi tạo nhận xét tổng quan.</p>';
                    loader.classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                }
               
                const summaryForSheet = summaryDiv.innerText.substring(0, 200) + "...";
                return { overallFeedback: { summary: summaryForSheet } };
            }
            async function handleSubmit() {
                if (isSubmitted) return;
                isSubmitted = true;
                clearInterval(timerInterval);
                
                document.querySelectorAll('input, textarea').forEach(input => input.disabled = true);
                submitBtn.classList.add('hidden');
                postSubmitOptions.classList.remove('hidden');
                if (retriesLeft > 0) {
                    retryBtn.classList.remove('hidden');
                } else {
                    retryBtn.classList.add('hidden');
                }

                const proctoringDataString = JSON.stringify(proctoringLog);

                let totalStudentScore = 0;
                let totalCorrectAnswers = 0;
                let allAnswersData = [];
                const questionCounts = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    acc[type] = (acc[type] || 0) + 1;
                    return acc;
                }, {});
                
                quizData.forEach((item, index) => {
                    let questionNumber = index + 1;
                    let answerData = { questionNumber, type: item.type };
                    switch (item.mappedType) {
                        case 'multiple-choice':
                            const selectedOption = document.querySelector(`input[name="q${index}"]:checked`);
                            const isCorrectMC = selectedOption ? parseInt(selectedOption.value) === item.correctAnswerIndex : false;
                            if (isCorrectMC) {
                                totalCorrectAnswers++;
                                if (questionCounts['multiple-choice'] > 0) {
                                   totalStudentScore += quizOptions.scoring.mc / questionCounts['multiple-choice'];
                                }
                            }
                            answerData.question = item.question;
                            answerData.options = item.options;
                            answerData.yourAnswer = selectedOption ? String.fromCharCode(65 + parseInt(selectedOption.value)) : "Không trả lời";
                            answerData.correctAnswer = String.fromCharCode(65 + item.correctAnswerIndex);
                            answerData.isCorrect = isCorrectMC;
                            break;
                        case 'true-false':
                            let correctStatementsCount = 0;
                            let yourAnswerPattern = [];
                            let correctAnswerPattern = [];
                            let details = [];
                            item.statements.forEach((s, i) => {
                                const selectedTF = document.querySelector(`input[name="q${index}-s${i}"]:checked`);
                                const studentChoice = selectedTF ? selectedTF.value === 'true' : null;
                                const isStatementCorrect = studentChoice === s.is_correct;
                               
                                if (isStatementCorrect) correctStatementsCount++;
                               
                                yourAnswerPattern.push(studentChoice === null ? '?' : (studentChoice ? 'Đ' : 'S'));
                                correctAnswerPattern.push(s.is_correct ? 'Đ' : 'S');
                                details.push({ statement: s.statement, yourChoice: studentChoice === null ? 'Không trả lời' : (studentChoice ? 'Đúng' : 'Sai'), correctChoice: s.is_correct ? 'Đúng' : 'Sai', isCorrect: isStatementCorrect });
                            });
                            
                            let scorePerTfQuestion = 0;
                            if (questionCounts['true-false'] > 0) {
                                scorePerTfQuestion = quizOptions.scoring.tf / questionCounts['true-false'];
                            }
                            let questionPoints = 0;
                            if (quizOptions.scoring.tfMethod === 'progressive') {
                                const progressivePoints = { 0: 0, 1: 0.1, 2: 0.25, 3: 0.5, 4: 1.0 };
                                questionPoints = progressivePoints[correctStatementsCount] * scorePerTfQuestion;
                            } else { // even
                                questionPoints = (correctStatementsCount / 4) * scorePerTfQuestion;
                            }
                            totalStudentScore += questionPoints;

                            if(correctStatementsCount === 4) totalCorrectAnswers++;
                            answerData.question = item.main_question;
                            answerData.yourAnswer = yourAnswerPattern.join('-');
                            answerData.correctAnswer = correctAnswerPattern.join('-');
                            answerData.isCorrect = correctStatementsCount === 4;
                            answerData.details = details;
                            break;
                       
                        case 'short-answer':
                            const saInput = document.querySelector(`input[name="q${index}"]`);
                            const studentAnswerRaw = saInput ? (saInput.value ?? '').trim() : "";
                            const correctAnswerRaw = (item.answer ?? '').toString().trim().replace(/\$/g, '');
                            let isCorrectSA = false;
                            const studentAnswerNormalized = studentAnswerRaw.replace(',', '.');
                            const correctAnswerNormalized = correctAnswerRaw.replace(',', '.');
                            if (studentAnswerNormalized.toLowerCase() === correctAnswerNormalized.toLowerCase()) {
                                isCorrectSA = true;
                            }
                             if (isCorrectSA) {
                                totalCorrectAnswers++;
                                if (questionCounts['short-answer'] > 0) {
                                   totalStudentScore += quizOptions.scoring.sa / questionCounts['short-answer'];
                                }
                            }
                            answerData.question = item.question;
                            answerData.yourAnswer = studentAnswerRaw || "Không trả lời";
                            answerData.correctAnswer = correctAnswerRaw;
                            answerData.isCorrect = isCorrectSA;
                            break;
                           
                        case 'essay':
                             const essayInput = document.querySelector(`textarea[name="q${index}"]`);
                             answerData.question = item.question;
                             answerData.yourAnswer = essayInput.value || "Không trả lời";
                             answerData.correctAnswer = item.answer;
                             answerData.isCorrect = null; // Needs manual grading
                             break;
                    }
                    allAnswersData.push(answerData);
                });
                
                const finalScore = totalStudentScore;
                
                let competencyAssessment = "Giáo viên không yêu cầu AI phân tích bài làm.";
                if (quizOptions.aiAssessment) {
                    const feedbackData = await generatePerformanceReview(allAnswersData);
                    if (feedbackData && feedbackData.overallFeedback && feedbackData.overallFeedback.summary) {
                        competencyAssessment = feedbackData.overallFeedback.summary;
                    } else {
                        competencyAssessment = "Có lỗi xảy ra trong quá trình AI phân tích bài làm.";
                    }
                }
                
                if (quizOptions.showAnswers) {
                    const totalQuestions = quizData.length;
                    resultContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg text-center">
                        <h3 class="text-2xl font-bold text-slate-800">KẾT QUẢ BÀI LÀM</h3>
                        <p class="mt-4 text-lg">Số câu đúng hoàn toàn: <span class="font-bold text-green-600">${totalCorrectAnswers}/${totalQuestions}</span></p>
                        <p class="text-2xl mt-2">Điểm (thang 10): <span class="font-bold text-blue-600">${finalScore.toFixed(2)}</span></p>
                        ${questionCounts['essay'] > 0 ? `<p class="text-sm text-gray-600 italic mt-1">Lưu ý: Điểm trên chưa bao gồm ${quizOptions.scoring.essay} điểm của phần Tự luận.</p>` : ''}
                    </div>`;
                    resultContainer.classList.remove('hidden');

                    allAnswersData.forEach((ans, index) => {
                        const questionCard = document.getElementById(`student-q-${index}`);
                        const feedbackIconDiv = document.getElementById(`q-${index}-feedback-icon`);
                        const feedbackDiv = document.getElementById(`q-${index}-feedback`);
                        if (!questionCard || !feedbackIconDiv || !feedbackDiv) return;

                        const iconHTML = ans.isCorrect === true
                            ? '<svg class="feedback-icon text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>'
                            : (ans.isCorrect === false ? '<svg class="feedback-icon text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>' : '');
                        feedbackIconDiv.innerHTML = iconHTML;

                        if (ans.type.includes('multiple-choice')) {
                            const studentChoice = ans.yourAnswer === "Không trả lời" ? -1 : ans.yourAnswer.charCodeAt(0) - 65;
                            const correctChoice = ans.correctAnswer.charCodeAt(0) - 65;
                            document.getElementById(`q-${index}-opt-label${correctChoice}`)?.classList.add('correct');
                            if (studentChoice !== -1 && studentChoice !== correctChoice) {
                                document.getElementById(`q-${index}-opt-label${studentChoice}`)?.classList.add('incorrect');
                            }
                        } else if (ans.type === 'true-false') {
                            const statementItems = questionCard.querySelectorAll('.statement-item');
                            ans.details.forEach((detail, i) => { if(statementItems[i]) { statementItems[i].classList.add(detail.isCorrect ? 'correct' : 'incorrect'); }});
                        }

                        if (quizOptions.showExplanation) {
                            feedbackDiv.innerHTML = `<button data-explain-index="${index}" class="explain-btn mt-4 flex items-center px-4 py-2 bg-blue-100 text-blue-800 text-sm font-semibold rounded-lg hover:bg-blue-200 transition-colors">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Xem giải thích
                            </button>`;
                        }
                    });
                    
                    document.querySelectorAll('.explain-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const button = e.currentTarget;
                            const index = parseInt(button.dataset.explainIndex, 10);
                            showExplanation(index, button);
                        });
                    });

                    if (window.MathJax) await window.MathJax.typesetPromise([studentQuizContainer]);
                } else {
                     resultContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg text-center"><h3 class="text-xl font-bold text-green-600">Nộp bài thành công!</h3><p class="mt-2 text-slate-700">Bạn đã hoàn thành bài làm. Kết quả sẽ được giáo viên công bố sau.</p></div>`;
                    resultContainer.classList.remove('hidden');
                }
                
                const formData = new FormData();
                formData.append('name', studentInfo.name);
                formData.append('class', studentInfo.class);
                formData.append('score', `${finalScore.toFixed(2)}/10`);
                formData.append('assessment', competencyAssessment);
                formData.append('timestamp', new Date().toLocaleString('vi-VN'));
                formData.append('examCode', correctExamCode);
                formData.append('monitoringLog', proctoringDataString);
                formData.append('answerDetails', JSON.stringify(allAnswersData));
               
                fetch(googleScriptUrl, { method: 'POST', body: formData})
                    .then(res => console.log("Successfully submitted to Google Sheet"))
                    .catch(err => console.error("Error submitting to Google Sheet:", err));
            }
           
            function startNewAttempt() {
                isSubmitted = false;
                proctoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0, suKien: [] };
                const proctoringWidget = document.getElementById('proctoring-widget');
                if (proctoringWidget) {
                    proctoringWidget.classList.add('hidden');
                    document.getElementById('tab-switch-count').textContent = '0';
                    document.getElementById('copy-count').textContent = '0';
                    document.getElementById('paste-count').textContent = '0';
                }

                renderStudentQuiz();
                resultContainer.classList.add('hidden');
                document.getElementById('ai-feedback-container').classList.add('hidden');
                postSubmitOptions.classList.add('hidden');
                submitBtn.classList.remove('hidden');
                 if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                }
                retriesLeft--;
                retriesDisplay.textContent = `Lượt làm lại còn: ${retriesLeft}`;
                window.scrollTo(0, 0);
            }
            studentInfoForm.addEventListener('submit', (e) => {
                e.preventDefault();
               
                const enteredCode = document.getElementById('exam-code').value.trim().toUpperCase();
                if (enteredCode !== correctExamCode) {
                    alert('Mã đề không chính xác. Vui lòng kiểm tra lại!');
                    return;
                }
               
                studentApiKey = teacherApiKey;
                if (!studentApiKey) {
                    console.warn('Cảnh báo: Giáo viên chưa cấu hình API Key. Các tính năng AI sẽ không hoạt động.');
                }
       
                try {
                    if (studentApiKey) {
                       ai = new GoogleGenAI({ apiKey: studentApiKey });
                    }
                } catch(e) {
                    console.error("Lỗi khởi tạo Gemini API với key của giáo viên.", e);
                    alert("Cảnh báo: API Key của giáo viên không hợp lệ. Vui lòng báo cho giáo viên. Các tính năng AI sẽ không hoạt động.");
                    ai = null;
                }
                shuffleQuiz();
               
                studentInfo.name = document.getElementById('student-name').value;
                studentInfo.class = document.getElementById('student-class').value;
                loginModal.classList.add('hidden');
                studentQuizContainer.classList.remove('hidden');
                submitBtn.classList.remove('hidden');
               
                if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                } else {
                    timerDisplay.textContent = "Không giới hạn";
                }
                retriesDisplay.textContent = `Lượt làm lại còn: ${retriesLeft}`;
                renderStudentQuiz();

                const proctoringWidget = document.getElementById('proctoring-widget');
                const tabSwitchCountEl = document.getElementById('tab-switch-count');
                const copyCountEl = document.getElementById('copy-count');
                const pasteCountEl = document.getElementById('paste-count');

                function updateProctoringUI() {
                    if (proctoringLog.thoatManHinh > 0 || proctoringLog.saoChep > 0 || proctoringLog.dan > 0) {
                        proctoringWidget.classList.remove('hidden');
                    }
                    tabSwitchCountEl.textContent = proctoringLog.thoatManHinh;
                    copyCountEl.textContent = proctoringLog.saoChep;
                    pasteCountEl.textContent = proctoringLog.dan;
                }

                // Disable Right Click
                document.addEventListener('contextmenu', e => e.preventDefault());

                // Track Tab Switching
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && !isSubmitted) {
                        proctoringLog.thoatManHinh++;
                        proctoringLog.suKien.push({ loai: 'chuyen_tab', thoiGian: new Date().toISOString() });
                        updateProctoringUI();
                    }
                });

                // Track Copying
                document.addEventListener('copy', () => {
                    if (isSubmitted) return;
                    proctoringLog.saoChep++;
                    proctoringLog.suKien.push({ loai: 'sao_chep', thoiGian: new Date().toISOString() });
                    updateProctoringUI();
                });

                // Track Pasting
                document.addEventListener('paste', () => {
                    if (isSubmitted) return;
                    proctoringLog.dan++;
                    proctoringLog.suKien.push({ loai: 'dan', thoiGian: new Date().toISOString() });
                    updateProctoringUI();
                });
            });
            
            submitBtn.addEventListener('click', handleSubmit);
            retryBtn.addEventListener('click', () => {
                shuffleQuiz();
                startNewAttempt();
            });
        </script>
    </body>
    </html>
    