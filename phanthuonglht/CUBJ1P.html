
    <!DOCTYPE html>
    <html lang="vi">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>DE KIEM TRA BAI 1</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
        <script>
            window.MathJax = {
                tex: {
                    packages: {'[+]': ['ams']},
                    inlineMath: [['$', '$'], ['\\(', '\\)']],
                    displayMath: [['$$', '$$'], ['\\[', '\\]']]
                },
                chtml: {
                    fontCache: 'global',
                    linebreaks: {
                        automatic: true
                    }
                }
            };
        </script>
        <script type="text/javascript" id="MathJax-script" async
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
        </script>
        <style>
            body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #f0f4f8; }
            .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
            @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
            .question-card {
                background-color: white;
                border-radius: 1rem;
                padding: 1.5rem 2rem;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                border-left: 5px solid transparent;
                transition: all 0.3s ease;
            }
            .ai-explanation {
                background-color: #f0f9ff;
                color: #0c4a6e;
                padding: 1rem;
                border-radius: 0.75rem;
                font-size: 0.9rem;
                margin-top: 1rem;
                border-left: 4px solid #38bdf8;
            }
            .feedback-icon { width: 1.5rem; height: 1.5rem; }
            .option-label {
                transition: all 0.2s ease-in-out;
                border: 2px solid #e5e7eb;
            }
            .option-label:hover {
                border-color: #6366f1;
                background-color: #eef2ff;
            }
            .option-label.correct {
                border-color: #10b981 !important;
                background-color: #ecfdf5 !important;
                color: #065f46;
            }
            .option-label.incorrect {
                border-color: #ef4444 !important;
                background-color: #fef2f2 !important;
                color: #991b1b;
            }
            .statement-item.correct { background-color: #ecfdf5; border-color: #10b981; }
            .statement-item.incorrect { background-color: #fef2f2; border-color: #ef4444; }
            .prose { max-width: 100%; }
            .prose h1, .prose h2, .prose h3 { font-weight: 600; }
            .prose p { margin-top: 0.5em; margin-bottom: 0.5em; }
            .prose ul, .prose ol { margin-top: 1em; margin-bottom: 1em; padding-left: 1.5em; }
            .prose li > p { margin-top: 0; margin-bottom: 0; }
            .prose code { background-color: #e5e7eb; padding: 0.2em 0.4em; margin: 0; font-size: 85%; border-radius: 3px; }
            .prose pre { background-color: #e5e7eb; padding: 1em; border-radius: 0.5em; overflow-x: auto; }
            .prose pre code { background-color: transparent; padding: 0; }
            details[open] > summary .details-arrow {
                transform: rotate(180deg);
            }
        </style>
    </head>
    <body class="bg-slate-100 text-slate-800">
        <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md transform transition-all" style="animation: fadeIn 0.3s ease-out;">
                <h2 class="text-2xl font-bold mb-2 text-center text-slate-800">Thông Tin Học Sinh</h2>
                <p class="text-center text-slate-500 mb-6">Vui lòng nhập để bắt đầu làm bài.</p>
                <form id="student-info-form">
                    <div class="mb-4">
                        <label for="student-name" class="block text-sm font-medium text-slate-700 mb-1">Họ và tên</label>
                        <input type="text" id="student-name" required class="mt-1 block w-full block border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="student-class" class="block text-sm font-medium text-slate-700 mb-1">Lớp</label>
                        <input type="text" id="student-class" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="exam-code" class="block text-sm font-medium text-slate-700 mb-1">Mã đề</label>
                        <input type="text" id="exam-code" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Nhập mã đề giáo viên cung cấp">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Giáo viên:</label>
                        <p class="mt-1 text-slate-800 bg-slate-100 p-2.5 rounded-lg">PHAN VĂN THƯƠNG</p>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">Bắt đầu làm bài</button>
                </form>
            </div>
        </div>
        <div class="container mx-auto p-4 md:p-8 max-w-4xl">
            <header class="mb-10 p-8 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg">
                <div class="flex justify-between items-center flex-wrap gap-4">
                    <div>
                        <h1 class="text-4xl font-bold">DE KIEM TRA BAI 1</h1>
                        <p class="text-lg text-blue-100 mt-2">Hãy hoàn thành các câu hỏi dưới đây một cách tốt nhất!</p>
                        <p class="text-sm text-blue-200 mt-4">Tác giả: PHAN VĂN THƯƠNG</p>
                    </div>
                    <div id="timer-container" class="text-right">
                         <div id="timer-display" class="text-3xl font-bold tracking-wider bg-white/20 px-4 py-2 rounded-lg">--:--</div>
                         <div id="retries-display" class="text-sm mt-1 text-blue-200"></div>
                    </div>
                </div>
            </header>
            <main id="student-quiz-container" class="space-y-8 hidden">
                <!-- Questions will be rendered here by JS -->
            </main>
            <footer class="mt-10 text-center">
                <button id="submit-quiz-btn" class="bg-indigo-600 text-white py-3 px-12 rounded-full font-bold text-lg hover:bg-indigo-700 transition-all duration-300 shadow-lg hover:shadow-xl hidden transform hover:scale-105">Nộp Bài</button>
                <div id="result-container" class="mt-6 hidden"></div>
                <div id="ai-feedback-container" class="mt-8 text-left hidden"></div>
                <div id="post-submit-options" class="hidden mt-6 flex flex-col sm:flex-row items-center justify-center gap-4">
                    <button id="retry-quiz-btn" class="w-full sm:w-auto bg-slate-600 text-white py-2.5 px-6 rounded-lg font-semibold hover:bg-slate-700 transition-transform transform hover:scale-105">Làm Lại Đề Này</button>
                </div>
            </footer>
        </div>

        <div id="proctoring-widget" class="fixed bottom-4 right-4 bg-yellow-100 text-yellow-800 p-3 rounded-lg shadow-lg text-sm z-50 hidden border border-yellow-300" style="max-width: 200px;">
            <h4 class="font-bold mb-2 border-b border-yellow-300 pb-1 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 3.001-1.742 3.001H4.42c-1.53 0-2.493-1.667-1.743-3.001l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                Giám sát
            </h4>
            <p>Thoát màn hình: <span id="tab-switch-count" class="font-bold">0</span></p>
            <p>Sao chép: <span id="copy-count" class="font-bold">0</span></p>
            <p>Dán: <span id="paste-count" class="font-bold">0</span></p>
        </div>

        <script type="module">
            import { GoogleGenAI, Type } from "https://esm.sh/@google/genai@^1.13.0";
            let quizData = [{"type":"multiple-choice","question":"Trong bối cảnh thế giới nhận thức rõ sự thất bại của một tổ chức tiền nhiệm trong việc ngăn chặn Chiến tranh thế giới thứ hai, tổ chức nào sau đây được coi là tiền thân của Liên hợp quốc?","questionImage":null,"mappedType":"multiple-choice","options":["Hội Quốc liên","Liên minh châu Âu","Khối Đồng minh","Khối Hiệp ước"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Để hình thành một trật tự thế giới mới và duy trì hoà bình lâu dài sau Chiến tranh thế giới thứ hai, Hội nghị I-an-ta (tháng $2$ năm $1945$) đã đưa ra quyết định quan trọng nào sau đây?","questionImage":null,"mappedType":"multiple-choice","options":["Thành lập Ban Thư kí Liên hợp quốc","Thành lập tổ chức Hội Quốc liên","Thành lập tổ chức Liên hợp quốc","Duy trì và mở rộng Hội Quốc liên"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Trong nỗ lực xây dựng một nền tảng pháp lý vững chắc cho tổ chức quốc tế mới, từ cuối tháng $4$ đến cuối tháng $6$ năm $1945$, đại diện $50$ quốc gia đã họp tại Xan Phran-xi-xcô (Mỹ) để thông qua nội dung nào?","questionImage":null,"mappedType":"multiple-choice","options":["Tiêu diệt tận gốc phát xít Nhật","Xét xử tội phạm chiến tranh thế giới","Kết thúc chiến tranh Triều Tiên","Hiến chương Liên hợp quốc"],"optionsImage":[],"correctAnswerIndex":3},{"type":"multiple-choice","question":"Để chính thức đưa tổ chức quốc tế mới vào hoạt động hiệu quả, ngày $24-10-1945$, sau khi Quốc hội các nước thành viên phê chuẩn, bản Hiến chương của Liên hợp quốc đã có sự kiện nào?","questionImage":null,"mappedType":"multiple-choice","options":["Được bổ sung, hoàn chỉnh","Chính thức được công bố","Chính thức có hiệu lực","Được chính thức thông qua"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Quá trình hình thành Liên hợp quốc, một biểu tượng của sự hợp tác quốc tế sau Chiến tranh thế giới thứ hai, đã gắn liền với vai trò chủ chốt của các quốc gia nào?","questionImage":null,"mappedType":"multiple-choice","options":["Liên Xô, Trung Quốc, Đức","Liên Xô, Mỹ, Anh","Liên Xô, Mỹ, Đức","Mỹ, Anh, Pháp"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Vào giai đoạn đầu của Chiến tranh thế giới thứ hai, nhằm tập hợp lực lượng chống phát xít và đặt nền móng cho một liên minh rộng lớn, ngày $1/1/1942$, tại Oa-sinh-tơn (Mỹ), đại diện của $26$ nước đã ký văn kiện nào?","questionImage":null,"mappedType":"multiple-choice","options":["Tuyên bố Liên hợp quốc","Hiệp ước Maxtrich","Hiệp ước Rôma","Hiệp định Muynich"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Sau các cuộc đàm phán quan trọng về việc xây dựng một trật tự thế giới mới, vào năm $1945$, bản Hiến chương Liên hợp quốc đã được thông qua tại địa điểm nào?","questionImage":null,"mappedType":"multiple-choice","options":["Hội nghị Tam cường I-an-ta","Hội nghị Xan Phran-xi-xcô","Hội nghị Bàn Môn Điếm","Hội nghị Vécxai - Oasinhtơn"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Trong bối cảnh đang dồn sức đánh bại chủ nghĩa phát xít, tại Hội nghị Tê-hê-ran (I-ran), nguyên thủ $3$ nước Liên Xô, Mĩ, Anh đã khẳng định quyết tâm nào?","questionImage":null,"mappedType":"multiple-choice","options":["Quyết tâm thành lập Liên hợp quốc","Nhanh chóng đánh bại phát xít Đức","Nguyên tắc phân chia nước Đức","Thành lập quân đội giữ gìn hòa bình"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Việc thành lập Liên hợp quốc là một phản ứng mạnh mẽ của cộng đồng quốc tế, xuất phát từ ý thức sâu sắc của nhân dân thế giới về hậu quả tàn khốc của sự kiện nào?","questionImage":null,"mappedType":"multiple-choice","options":["Chiến tranh lạnh","Khủng hoảng kinh tế","Phân hóa giàu nghèo","Chiến tranh thế giới"],"optionsImage":[],"correctAnswerIndex":3},{"type":"multiple-choice","question":"Trong nỗ lực định hình lại trật tự thế giới và xây dựng cơ chế duy trì hòa bình, tại Hội nghị I-an-ta (tháng $2$ năm $1945$), nguyên thủ của những quốc gia nào sau đây đã ra quyết định về việc thành lập Liên hợp quốc?","questionImage":null,"mappedType":"multiple-choice","options":["Anh, Pháp, Mĩ","Anh, Pháp, Liên Xô","Anh, Pháp, Đức","Anh, Mĩ, Liên Xô"],"optionsImage":[],"correctAnswerIndex":3},{"type":"multiple-choice","question":"Một trong những nhiệm vụ cấp bách của các nước Đồng minh tại Hội nghị I-an-ta (tháng $2$ năm $1945$) là xây dựng khuôn khổ cho hòa bình lâu dài. Quyết định quan trọng nào sau đây đã được đưa ra?","questionImage":null,"mappedType":"multiple-choice","options":["Phân chia nước Đức thành bốn khu vực chiếm đóng của Đồng minh","Phân công quân đội Đồng minh giải giáp quân Nhật ở Đông Dương","Thành lập tổ chức Liên hợp quốc để duy trì hòa bình, an ninh thế giới","Phân chia phạm vi ảnh hưởng ở châu Phi, châu Úc giữa các nước Đồng minh"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Sau những năm tháng chiến tranh tàn khốc, các nước Đồng minh đã chung tay thành lập tổ chức nào để đáp ứng khát vọng được sống trong hòa bình của nhân dân thế giới?","questionImage":null,"mappedType":"multiple-choice","options":["Hội Quốc Liên","Liên hợp quốc","Liên minh châu Âu","Ngân hàng thế giới"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Khi Chiến tranh thế giới thứ hai sắp kết thúc, một trong những vấn đề cấp bách nhất mà các nước Đồng minh chống phát xít phải đối mặt là gì, nhằm tránh lặp lại sai lầm của thời kỳ trước?","questionImage":null,"mappedType":"multiple-choice","options":["Phân chia lại thuộc địa của các nước","Tổ chức lại thế giới sau chiến tranh","Thiết lập trật tự thế giới mới hai cực","Phục hồi và phát triển kinh tế thế giới"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Khi cuộc Chiến tranh thế giới thứ hai bước vào giai đoạn cuối, để đảm bảo một tương lai hòa bình và ổn định, yêu cầu bức thiết nào sau đây đã được đặt ra cho các nước Đồng minh?","questionImage":null,"mappedType":"multiple-choice","options":["Đẩy mạnh xu thế khu vực hóa và toàn cầu hóa kinh tế","Thành lập tổ chức Hội Quốc liên để ngăn chặn chiến tranh","Tiêu diệt hoàn toàn chủ nghĩa phát xít và tổ chức lại thế giới","Thủ tiêu tất cả các hình thức của chế độ phân biệt chủng tộc"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Trước viễn cảnh kết thúc Chiến tranh thế giới thứ hai, cộng đồng quốc tế nhận thấy sự cần thiết phải có một cơ chế hợp tác mới. Trong giai đoạn cuối của cuộc chiến, vấn đề cấp bách nào đã được đặt ra?","questionImage":null,"mappedType":"multiple-choice","options":["Giúp đỡ các nước Đông Âu xây dựng cơ sở vật chất của chủ nghĩa xã hội","Liên minh giữa Liên Xô và Mĩ để thiết lập trật tự thế giới mới sau chiến tranh","Thành lập một ủy ban giúp đỡ các nước phát xít khắc phục hậu quả chiến tranh","Thành lập một tổ chức quốc tế nhằm duy trì hòa bình và trật tự thế giới mới"],"optionsImage":[],"correctAnswerIndex":3},{"type":"multiple-choice","question":"Để kịp thời thiết lập một khuôn khổ pháp lý mới cho hợp tác quốc tế, bản Hiến chương Liên hợp quốc đã được thông qua vào thời điểm nào của cuộc Chiến tranh thế giới thứ hai?","questionImage":null,"mappedType":"multiple-choice","options":["Bước vào giai đoạn quyết liệt","Bước vào giai đoạn kết thúc","Bắt đầu lan ra khu vực châu Á","Bắt đầu lan ra khu vực châu Phi"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Nhằm ngăn chặn thảm họa chiến tranh và xây dựng một tương lai tốt đẹp hơn, tổ chức Liên hợp quốc được thành lập năm $1945$ để đáp ứng nhu cầu cốt lõi nào của toàn thể nhân loại?","questionImage":null,"mappedType":"multiple-choice","options":["Bảo vệ hòa bình, an ninh toàn thế giới","Chống biến đổi khí hậu trên toàn cầu","Nâng cao đời sống tinh thần con người","Thúc đẩy khoa học công nghệ phát triển"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Sau quá trình xây dựng Hiến chương và được các quốc gia phê chuẩn, sự kiện nào sau đây đã đánh dấu tổ chức Liên hợp quốc chính thức đi vào hoạt động?","questionImage":null,"mappedType":"multiple-choice","options":["Hội nghị Ianta (Liên Xô) quyết định thành lập tổ chức Liên hợp quốc","Bản “Tuyên bố Liên hợp quốc” được đại diện $26$ nước kí kết tại Oa-sinh-tơn (Mĩ)","Đại diện $50$ nước họp ở Xan Phran-xi-xcô (Mĩ) thông qua Hiến chương Liên hợp quốc","Hiến chương Liên hợp quốc được Quốc hội các nước thành viên phê chuẩn"],"optionsImage":[],"correctAnswerIndex":3},{"type":"multiple-choice","question":"Để kỷ niệm thời khắc lịch sử khi Liên hợp quốc chính thức ra đời, ngày $24$ tháng $10$ hàng năm được chọn làm Ngày Liên hợp quốc, gắn liền với sự kiện nào sau đây?","questionImage":null,"mappedType":"multiple-choice","options":["Liên hợp quốc thông qua $17$ mục tiêu Chương trình nghị sự $2030$","Trung Quốc trở thành ủy viên thường trực của Hội đồng bảo an","Hội nghị Thượng đỉnh Thiên niên kỉ Liên hợp quốc được triệu tập","Hiến chương Liên hợp quốc được Quốc hội các nước phê chuẩn"],"optionsImage":[],"correctAnswerIndex":3},{"type":"multiple-choice","question":"Quá trình hình thành Liên hợp quốc trải qua nhiều hội nghị quan trọng. Tuy nhiên, tổ chức này ra đời không phải là kết quả của những quyết định tại hội nghị nào trong các lựa chọn sau đây?","questionImage":null,"mappedType":"multiple-choice","options":["Tê-hê-ran (I-ran, năm $1943$)","I-an-ta (Liên Xô, năm $1945$)","Muy-nich (Đức, năm $1938$)","Xan Phran-xi-xcô (Mĩ, năm $1945$)"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Khi phân tích bối cảnh ra đời của Liên hợp quốc, điều quan trọng là phải hiểu rõ các yếu tố thúc đẩy. Nội dung nào sau đây KHÔNG phản ánh đúng bối cảnh lịch sử hình thành tổ chức Liên hợp quốc?","questionImage":null,"mappedType":"multiple-choice","options":["Nhân dân thế giới có khát vọng được chung sống hòa bình","Chủ nghĩa phát xít xuất hiện và cầm quyền ở nhiều nước","Ý thức của các nước Đồng minh về việc tổ chức thế giới","Nhu cầu thành lập tổ chức quốc tế mới thay thế tổ chức cũ"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Phân tích về quá trình hình thành Liên hợp quốc, nhận xét nào sau đây phản ánh KHÔNG đúng về sự thành lập của tổ chức này, đặc biệt về các yếu tố ảnh hưởng đến quá trình đó?","questionImage":null,"mappedType":"multiple-choice","options":["Phù hợp với khát vọng hòa bình chung của nhân dân thế giới","Quá trình hình thành trải qua nhiều hội nghị quốc tế khác nhau","Các cường quốc Đồng minh giữ vai trò chủ đạo trong việc thành lập","Quá trình thành lập lâu dài và chịu ảnh hưởng của Chiến tranh lạnh"],"optionsImage":[],"correctAnswerIndex":3},{"type":"multiple-choice","question":"Trong bức tranh toàn cảnh về sự ra đời của các tổ chức quốc tế sau Chiến tranh thế giới thứ hai, nhận xét nào sau đây phản ánh ĐÚNG về sự thành lập của tổ chức Liên hợp quốc?","questionImage":null,"mappedType":"multiple-choice","options":["Là kết quả của những thỏa thuận giữa Liên Xô và Anh","Phù hợp với khát vọng hòa bình chung của nhân dân thế giới","Các nước phát xít giữ vai trò chủ đạo trong việc thành lập","Quá trình thành lập lâu dài và chịu ảnh hưởng của Chiến tranh lạnh"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Trong các mục tiêu hoạt động của Liên hợp quốc, mục tiêu nào sau đây được xem là nền tảng cốt lõi, là cơ sở để thực hiện và đạt được tất cả các mục tiêu còn lại?","questionImage":null,"mappedType":"multiple-choice","options":["Duy trì hòa bình an ninh quốc tế","Thúc đẩy quan hệ hữu nghị giữa các dân tộc","Giải quyết các vấn đề về an ninh kinh tế xã hội","Đảm bảo quyền con người, không phân biệt chủng tộc"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Để đảm bảo một thế giới ổn định và thịnh vượng, đâu là một trong những mục tiêu quan trọng hàng đầu mà tổ chức Liên hợp quốc đã đặt ra?","questionImage":null,"mappedType":"multiple-choice","options":["Cân bằng quyền lực các nước","Xoá bỏ chế độ thực dân kiểu cũ","Duy trì hòa bình, an ninh thế giới","Thực hiện quyền tự do hàng hải"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Mọi hoạt động và định hướng của Liên hợp quốc đều dựa trên một bộ quy tắc và mục tiêu rõ ràng. Văn kiện quan trọng nào đã quy định cụ thể mục tiêu và nguyên tắc hoạt động của tổ chức này?","questionImage":null,"mappedType":"multiple-choice","options":["Hiến chương","Hiến pháp","Hiệp định","Tuyên ngôn"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Trong bối cảnh thế giới hiện đại với nhiều thách thức mới, Liên hợp quốc đã mở rộng phạm vi hoạt động của mình. Đâu là một trong những nội dung mục tiêu, hành động mang tính toàn cầu đến nay của Liên hợp quốc, nhằm giải quyết các vấn đề cấp thiết của xã hội?","questionImage":null,"mappedType":"multiple-choice","options":["Chống chiến tranh","Quyền tự do ngôn luận","Chống bạo lực gia đình","Chất lượng giáo dục"],"optionsImage":[],"correctAnswerIndex":3},{"type":"multiple-choice","question":"Đối mặt với các tranh chấp phức tạp như ở Biển Đông, Việt Nam có thể vận dụng hiệu quả nguyên tắc hoạt động nào của Liên hợp quốc để tìm kiếm giải pháp hòa bình và công bằng?","questionImage":null,"mappedType":"multiple-choice","options":["Giải quyết các tranh chấp bằng biện pháp hoà bình","Sự nhất trí của các nước thường trực Hội đồng Bảo an","Quyền bình đẳng giữa các thành viên Liên hợp quốc","Không đe doạ dùng vũ lực tấn công các quốc gia khác"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Nguyên tắc “Giải quyết các tranh chấp quốc tế bằng biện pháp hòa bình” là kim chỉ nam cho hoạt động của Liên hợp quốc. Nội dung nào đã trở thành cơ sở vững chắc để tổ chức này đề ra nguyên tắc đó?","questionImage":null,"mappedType":"multiple-choice","options":["Hòa bình là nguyện vọng, xu thế của các dân tộc trên thế giới","Hòa bình là điều kiện quyết định để duy trì chế độ chính trị","Mục đích của Liên hợp quốc là cân bằng lợi ích của các nước","Tranh chấp, xung đột xảy ra ở hầu hết các khu vực trên thế giới"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Trong cấu trúc của Liên hợp quốc, để đảm bảo phản ứng nhanh chóng và hiệu quả trước các mối đe dọa an ninh toàn cầu, cơ quan nào chịu trách nhiệm chính trong việc duy trì hòa bình và an ninh thế giới?","questionImage":null,"mappedType":"multiple-choice","options":["Đại hội đồng","Ban Thư kí","Hội đồng Bảo an","Tòa án quốc tế"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Dù có nhiều nỗ lực, Liên hợp quốc vẫn phải đối mặt với những thách thức lớn. Hiện nay, một trong những cuộc xung đột kéo dài và phức tạp trên thế giới mà Liên hợp quốc vẫn đang nỗ lực giải quyết là ở khu vực nào?","questionImage":null,"mappedType":"multiple-choice","options":["En Xan-va-do","Trung Đông","Goa-tê-ma-la","Mô-dăm-bich"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Trong Chương trình nghị sự $2030$, Liên hợp quốc đã đặt ra nhiều mục tiêu phát triển bền vững. Đâu là một trong những nội dung của mục tiêu, hành động mang tính toàn cầu đến năm $2030$ của Liên hợp quốc nhằm giải quyết các vấn đề môi trường và xã hội?","questionImage":null,"mappedType":"multiple-choice","options":["Chống nạn thất nghiệp","Quyền tự do, dân sinh, dân chủ","Chống bạo lực gia đình","Năng lượng sạch và bền vững"],"optionsImage":[],"correctAnswerIndex":3},{"type":"multiple-choice","question":"Dù có những khác biệt về quy mô và trọng tâm, Liên hợp quốc vẫn có những điểm tương đồng với nhiều tổ chức quốc tế và khu vực khác. Một trong những điểm giống về mục tiêu là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Tập hợp thành viên vào liên minh quân sự","Đem lại lợi ích cho các nước thành viên","Thực hiện quyền tự do dân chủ, dân quyền","Trao đổi về vốn, khoa học và kinh nghiệm"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Nhìn lại lịch sử các tổ chức quốc tế, cả Liên hợp quốc và Hội Quốc liên đều ra đời với những khát vọng lớn. Một trong những điểm giống về mục đích thành lập của hai tổ chức này là đều hướng tới điều gì?","questionImage":null,"mappedType":"multiple-choice","options":["Duy trì hoà bình và an ninh thế giới","Ngăn chặn âm mưu bá chủ của Mỹ","Thực hiện các quyền tự do dân chủ","Trao đổi công nghệ và kinh nghiệm"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Kể từ khi gia nhập và tham gia tích cực vào các hoạt động của Liên hợp quốc, mối quan hệ hợp tác của tổ chức này với Việt Nam hiện nay được đánh giá như thế nào, thể hiện qua các dự án và sáng kiến chung?","questionImage":null,"mappedType":"multiple-choice","options":["Hợp tác theo hướng ngày càng sâu rộng và hiệu quả","Giúp đỡ giải quyết hậu quả nặng nề của chiến tranh","Viện trợ không hoàn lại để phát triển kinh tế, văn hóa","Thúc đẩy cải cách thực hiện các quyền tự do dân chủ"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Để thực sự trở thành một diễn đàn quốc tế lớn mạnh, vừa hợp tác, vừa đấu tranh nhằm duy trì hòa bình và an ninh thế giới, Liên hợp quốc đã thực hiện nhiều hoạt động. Đâu KHÔNG phải là một trong những việc làm đó?","questionImage":null,"mappedType":"multiple-choice","options":["Mở rộng kết nạp thành viên trên phạm vi toàn thế giới","Giải quyết các vụ tranh chấp và xung đột ở nhiều khu vực","Thúc đẩy mối quan hệ hữu nghị và hợp tác quốc tế","Giúp đỡ các dân tộc về kinh tế, văn hóa, giáo dục, y tế, nhân đạo,…"],"optionsImage":[],"correctAnswerIndex":3},{"type":"multiple-choice","question":"Trong bối cảnh thế giới hiện đại, với những thách thức như biến đổi khí hậu và cạn kiệt tài nguyên, mục tiêu nào sau đây của Liên hợp quốc ngày càng trở nên cấp thiết để duy trì sự phát triển bền vững toàn cầu?","questionImage":null,"mappedType":"multiple-choice","options":["Bảo vệ hòa bình, an ninh toàn thế giới","Chống biến đổi khí hậu trên toàn cầu","Nâng cao đời sống tinh thần con người","Thúc đẩy khoa học công nghệ phát triển"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Nhằm xây dựng một trật tự thế giới ổn định, trong các mục tiêu của mình, mục tiêu nào sau đây được tổ chức Liên hợp quốc đặc biệt chú trọng và coi là cơ sở để thực hiện các mục tiêu còn lại?","questionImage":null,"mappedType":"multiple-choice","options":["Duy trì nền hòa bình và an ninh thế giới","Thúc đẩy quan hệ hữu nghị giữa các dân tộc","Thúc đẩy sự phát triển kinh tế, xã hội thế giới","Trung tâm điều hòa hoạt động của các quốc gia"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Khi xem xét các mục tiêu đã được nêu trong Hiến chương, nội dung nào sau đây KHÔNG phản ánh đúng mục tiêu hoạt động của tổ chức Liên hợp quốc theo quy định của văn kiện này?","questionImage":null,"mappedType":"multiple-choice","options":["Thúc đẩy quan hệ hữu nghị giữa các dân tộc trên thế giới","Giải quyết các tranh chấp quốc tế bằng biện pháp hòa bình","Hợp tác quốc tế để giải quyết các vấn đề kinh tế, xã hội","Trung tâm điều hòa các nỗ lực quốc tế vì mục tiêu chung"],"optionsImage":[],"correctAnswerIndex":3},{"type":"multiple-choice","question":"Để mọi thành viên và cộng đồng quốc tế hiểu rõ về tôn chỉ và cách thức hoạt động, mục tiêu và nguyên tắc hoạt động của tổ chức Liên hợp quốc đều được quy định rõ trong văn kiện pháp lý quan trọng nào sau đây?","questionImage":null,"mappedType":"multiple-choice","options":["Công ước Liên hợp quốc về Luật biển","Tuyên ngôn về thủ tiêu hoàn toàn chủ nghĩa thực dân","Hiến chương Liên hợp quốc","Tuyên ngôn Quốc tế về Nhân quyền"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Đoạn tư liệu về Tuyên ngôn thủ tiêu chủ nghĩa thực dân (năm $1960$) cho thấy Liên hợp quốc đã đóng vai trò tích cực trong việc định hình lại quan hệ quốc tế. Theo đó, đoạn tư liệu này phản ánh vai trò của tổ chức Liên hợp quốc trên lĩnh vực nào sau đây?","questionImage":null,"mappedType":"multiple-choice","options":["Thúc đẩy phát triển kinh tế, tài chính quốc tế","Đảm bảo các quyền cơ bản của con người","Thúc đẩy quá trình phi thực dân hóa trên thế giới","Phát triển văn hóa, xã hội các nước thành viên"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Trong nỗ lực kiểm soát vũ khí và ngăn chặn các mối đe dọa chiến tranh, Liên hợp quốc đã ban hành nhiều văn kiện quan trọng. Một trong số đó nhằm duy trì hòa bình và an ninh thế giới là văn kiện nào?","questionImage":null,"mappedType":"multiple-choice","options":["Tuyên ngôn Quốc tế Nhân quyền","Chương trình nghị sự $2030$","Công ước Liên hợp quốc về quyền trẻ em","Hiệp ước cấm phổ biến vũ khí hạt nhân"],"optionsImage":[],"correctAnswerIndex":3},{"type":"multiple-choice","question":"Với vai trò là một tổ chức toàn cầu, Liên hợp quốc đã có nhiều đóng góp trong việc thúc đẩy kinh tế, tài chính, thương mại quốc tế. Nội dung nào sau đây phản ánh đúng vai trò đó, đặc biệt đối với các nước đang phát triển?","questionImage":null,"mappedType":"multiple-choice","options":["Thúc đẩy quá trình giành độc lập của các nước thuộc địa và phụ thuộc","Giải quyết các cuộc tranh chấp, xung đột ở nhiều quốc gia và khu vực","Tạo môi trường kinh tế bình đẳng, hỗ trợ các nền kinh tế kém phát triển","Hỗ trợ các nước trong quá trình phát triển văn hóa, xã hội, giáo dục, y tế"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Tuyên ngôn về thủ tiêu hoàn toàn chủ nghĩa thực dân (năm $1960$) đã trở thành một cột mốc lịch sử. Văn kiện quan trọng này của Liên hợp quốc nhằm mục đích chính nào, góp phần vào sự ổn định toàn cầu?","questionImage":null,"mappedType":"multiple-choice","options":["Ngăn chặn nguy cơ chiến tranh thế giới mới","Xóa bỏ hoàn toàn vũ khí hóa học và hạt nhân","Duy trì nền hòa bình và an ninh thế giới","Phát triển văn hóa, xã hội các nước thành viên"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Để giải quyết các vấn đề toàn cầu như đói nghèo và bất bình đẳng, hoạt động nào sau đây thể hiện rõ nhất vai trò thúc đẩy phát triển của Liên hợp quốc trong thế kỷ XXI?","questionImage":null,"mappedType":"multiple-choice","options":["Đề ra nhiều chương trình hỗ trợ các nước về vốn, tri thức, kĩ thuật","Đề ra Mục tiêu phát triển Thiên niên kỉ nhằm xóa bỏ đói nghèo","Kí điều ước quốc tế về quyền phụ nữ và trẻ em","Giải quyết tranh chấp quốc tế bằng biện pháp hoà bình"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Nguyên tắc nào sau đây của Liên hợp quốc giúp đảm bảo rằng tiếng nói của các quốc gia nhỏ vẫn được lắng nghe và tôn trọng trong các diễn đàn quốc tế, dù họ không có sức mạnh kinh tế hoặc quân sự tương đương các cường quốc?","questionImage":null,"mappedType":"multiple-choice","options":["Giải quyết các tranh chấp bằng biện pháp hòa bình","Không đe dọa hoặc sử dụng vũ lực chống lại toàn vẹn lãnh thổ của các quốc gia khác","Quyền bình đẳng chủ quyền giữa các quốc gia thành viên","Sự nhất trí của $5$ nước ủy viên thường trực Hội đồng Bảo an"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Ngoài việc duy trì hòa bình, Liên hợp quốc còn đóng vai trò quan trọng trong việc thúc đẩy các giá trị nhân đạo và quyền con người trên phạm vi toàn cầu. Văn kiện nào sau đây thể hiện rõ cam kết này của Liên hợp quốc?","questionImage":null,"mappedType":"multiple-choice","options":["Hiệp ước Bắc Đại Tây Dương (NATO)","Tuyên ngôn Quốc tế Nhân quyền","Hiệp định Genève về chấm dứt chiến tranh ở Việt Nam","Hiệp ước cấm thử hạt nhân một phần"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Mặc dù Liên hợp quốc được thành lập với mục tiêu cao cả là duy trì hòa bình, nhưng trong thực tế, tổ chức này thường xuyên phải đối mặt với những khó khăn trong việc giải quyết triệt để các xung đột. Yếu tố nào sau đây được xem là một rào cản lớn trong hoạt động của Hội đồng Bảo an, đặc biệt khi các cường quốc có lợi ích khác nhau?","questionImage":null,"mappedType":"multiple-choice","options":["Việc các nước lớn thường xuyên rút khỏi tổ chức","Sự tồn tại của quyền phủ quyết của các thành viên thường trực","Thiếu sự hợp tác từ các nước đang phát triển","Ngân sách hoạt động hạn hẹp, không đủ tài trợ"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Ban đầu, trọng tâm chính của Liên hợp quốc là duy trì hòa bình và an ninh quốc tế. Tuy nhiên, qua thời gian, chương trình nghị sự của tổ chức này đã mở rộng đáng kể để bao gồm các vấn đề toàn cầu khác. Sự thay đổi này được thể hiện rõ nhất qua việc Liên hợp quốc gần đây đã nhấn mạnh vào lĩnh vực nào?","questionImage":null,"mappedType":"multiple-choice","options":["Chấm dứt hoàn toàn vũ khí hạt nhân trên toàn cầu","Hợp tác quân sự giữa các nước thành viên","Các mục tiêu phát triển bền vững và ứng phó biến đổi khí hậu","Thúc đẩy cạnh tranh kinh tế giữa các cường quốc"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Khi bản Hiến chương Liên hợp quốc được thông qua tại Hội nghị Xan Phran-xi-xcô vào năm $1945$, đã có bao nhiêu quốc gia ban đầu tham gia kí kết, thể hiện mong muốn chung về một trật tự thế giới hòa bình và hợp tác?","questionImage":null,"mappedType":"multiple-choice","options":["$45$","$50$","$51$","$55$"],"optionsImage":[],"correctAnswerIndex":1}];
            const quizOptions = {"timeLimit":45,"retriesAllowed":11,"showAnswers":true,"showExplanation":true,"aiAssessment":true,"scoring":{"mc":5,"tf":2,"sa":2,"essay":1,"tfMethod":"progressive"}};
            const googleScriptUrl = "https://script.google.com/macros/s/AKfycbxRtfKtmnGdXLj0zc-1wfEubP9FRNGpylhif9NopKKEpz-xwcm4JTLqsMdU2GgC60n1Eg/exec";
            const correctExamCode = "CUBJ1P";
            const teacherApiKey = "from google import genai  client = genai.Client()  response = client.models.generate_content(     model="gemini-2.5-flash",     contents="Explain how AI works in a few words", )  print(response.text)";
            let studentInfo = {};
            let isSubmitted = false;
            let timerInterval;
            let retriesLeft = quizOptions.retriesAllowed;
            let studentApiKey = "";
            let ai = null;

            let proctoringLog = {
                thoatManHinh: 0,
                saoChep: 0,
                dan: 0,
                suKien: []
            };

            const studentQuizContainer = document.getElementById('student-quiz-container');
            const submitBtn = document.getElementById('submit-quiz-btn');
            const resultContainer = document.getElementById('result-container');
            const postSubmitOptions = document.getElementById('post-submit-options');
            const retryBtn = document.getElementById('retry-quiz-btn');
            const loginModal = document.getElementById('login-modal');
            const studentInfoForm = document.getElementById('student-info-form');
            const timerDisplay = document.getElementById('timer-display');
            const retriesDisplay = document.getElementById('retries-display');
            function shuffleQuiz() {
                // Shuffle options/statements within each question first
                quizData.forEach(item => {
                    // Shuffle multiple-choice options and their corresponding images
                    if (item.mappedType === 'multiple-choice' && item.options && item.options.length > 0) {
                        const correctAnswerText = item.options[item.correctAnswerIndex];
                        let optionsWithImages = item.options.map((opt, index) => ({
                            text: opt,
                            image: (item.optionsImage && item.optionsImage[index]) ? item.optionsImage[index] : null
                        }));
                        // Fisher-Yates shuffle
                        for (let i = optionsWithImages.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [optionsWithImages[i], optionsWithImages[j]] = [optionsWithImages[j], optionsWithImages[i]];
                        }
                        // Update the item with shuffled data
                        item.options = optionsWithImages.map(opt => opt.text);
                        item.optionsImage = optionsWithImages.map(opt => opt.image);
                        item.correctAnswerIndex = item.options.indexOf(correctAnswerText);
                    }
                    // Shuffle true-false statements
                    if (item.mappedType === 'true-false' && item.statements && item.statements.length > 0) {
                         for (let i = item.statements.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [item.statements[i], item.statements[j]] = [item.statements[j], item.statements[i]];
                        }
                    }
                });
                // Then, group questions by type and shuffle within each group
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});
                let shuffledQuizData = [];
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    if (grouped[partType]) {
                        const partQuestions = grouped[partType];
                        for (let i = partQuestions.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [partQuestions[i], partQuestions[j]] = [partQuestions[j], partQuestions[i]];
                        }
                        shuffledQuizData = shuffledQuizData.concat(partQuestions);
                    }
                });
               
                quizData = shuffledQuizData;
            }
            // --- Timer Function ---
            function startTimer(duration, display) {
                let timer = duration, minutes, seconds;
                clearInterval(timerInterval); // Clear any existing timer
                if(duration <= 0) {
                     display.textContent = "∞";
                     return;
                }
                timerInterval = setInterval(function () {
                    minutes = parseInt(timer / 60, 10);
                    seconds = parseInt(timer % 60, 10);
                    minutes = minutes < 10 ? "0" + minutes : minutes;
                    seconds = seconds < 10 ? "0" + seconds : seconds;
                    display.textContent = minutes + ":" + seconds;
                    if (--timer < 0) {
                        clearInterval(timerInterval);
                        alert("Hết giờ làm bài!");
                        handleSubmit();
                    }
                }, 1000);
            }
            
            async function showExplanation(index, button) {
                const item = quizData[index];
                const questionCard = document.getElementById(`student-q-${index}`);
                const feedbackDiv = document.getElementById(`q-${index}-feedback`);
                if (!questionCard || !feedbackDiv) return;

                const existingExplanation = feedbackDiv.querySelector('.ai-explanation');
                if (existingExplanation) {
                    existingExplanation.remove();
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Xem giải thích
                    `;
                    return;
                }

                button.disabled = true;
                button.innerHTML = '<div class="loader mr-2"></div> Đang tải...';

                if (item.explanation) {
                    displayExplanation(item.explanation, feedbackDiv, button);
                    return;
                }

                if (!ai) {
                    alert("Tính năng giải thích yêu cầu API Key, nhưng chưa được cấu hình bởi giáo viên.");
                    button.disabled = false;
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Xem giải thích
                    `;
                    return;
                }

                const questionText = item.question || item.main_question;
                let prompt = `Bạn là một trợ lý giáo viên AI, am hiểu sâu sắc Chương trình GDPT 2018. Hãy cung cấp một lời giải chi tiết, từng bước một cho câu hỏi sau đây. Lời giải phải chính xác, dễ hiểu và phù hợp với phương pháp giảng dạy của chương trình học, TUYỆT ĐỐI KHÔNG sử dụng kiến thức của lớp cao hơn để giải thích.\n\n--- CÂU HỎI ---\n${questionText}\n\n`;
                if (item.mappedType === 'multiple-choice') {
                    prompt += `--- CÁC LỰA CHỌN ---\n${item.options.map((opt, i) => `${String.fromCharCode(65 + i)}. ${opt}`).join('\n')}\n\n`;
                    prompt += `--- ĐÁP ÁN ĐÚNG ---\n${String.fromCharCode(65 + item.correctAnswerIndex)}. ${item.options[item.correctAnswerIndex]}`;
                } else if (item.mappedType === 'true-false') {
                    prompt += `--- CÁC MỆNH ĐỀ & ĐÁP ÁN ---\n${item.statements.map(s => ` - ${s.statement} -> ${s.is_correct ? 'Đúng' : 'Sai'}`).join('\n')}`;
                } else {
                    prompt += `--- ĐÁP ÁN / GỢI Ý ---\n${item.answer}`;
                }
                prompt += `\n\n--- YÊU CẦU ---\nGiải thích rõ ràng tại sao đáp án lại đúng, từng bước một. Định dạng tất cả các công thức toán học bằng LaTeX.`;

                try {
                    const response = await ai.models.generateContent({ model: "gemini-2.5-flash", contents: prompt });
                    const explanationText = response.text.replace(/\n/g, '<br>');
                    item.explanation = explanationText; // Cache it
                    displayExplanation(explanationText, feedbackDiv, button);
                } catch (error) {
                    console.error("Lỗi khi tạo giải thích:", error);
                    feedbackDiv.insertAdjacentHTML('beforeend', '<div class="ai-explanation text-red-600">Lỗi: Không thể tạo giải thích.</div>');
                    button.disabled = false;
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Thử lại
                    `;
                }
            }

            function displayExplanation(explanationText, container, button) {
                container.insertAdjacentHTML('beforeend', `<div class="ai-explanation prose prose-sm">${explanationText}</div>`);
                if (window.MathJax) MathJax.typesetPromise([container]);
                button.disabled = false;
                button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    Ẩn giải thích
                `;
            }
           
            function renderStudentQuiz() {
                studentQuizContainer.innerHTML = '';
               
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});
                const groupInfo = {
                    'multiple-choice': { title: 'PHẦN I. TRẮC NGHIỆM KHÁCH QUAN', subtitle: 'Chọn đáp án đúng nhất trong các lựa chọn sau.' },
                    'true-false': { title: 'PHẦN II. CÂU HỎI ĐÚNG - SAI', subtitle: 'Xác định tính đúng hoặc sai cho mỗi mệnh đề dưới đây.' },
                    'short-answer': { title: 'PHẦN III. CÂU HỎI TRẢ LỜI NGẮN', subtitle: 'Điền đáp án ngắn gọn vào phần trả lời.' },
                    'essay': { title: 'PHẦN IV. CÂU HỎI TỰ LUẬN', subtitle: 'Trình bày chi tiết bài giải của bạn.' }
                };
               
                let questionCounter = 0;
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    const questions = grouped[partType];
                    if (!questions || questions.length === 0) return;
                   
                    let groupHTML = `<div class="group-container space-y-8 mb-12">`;
                    const info = groupInfo[partType];
                    groupHTML += `
                        <div class="group-header pb-3 border-b-2 border-slate-300 mb-6">
                            <h2 class="text-2xl font-bold text-slate-800">${info.title}</h2>
                            ${info.subtitle ? `<p class="text-md text-slate-600 italic mt-1">${info.subtitle}</p>` : ''}
                        </div>
                    `;
                    questions.forEach((item, localIndex) => {
                        const globalIndex = quizData.indexOf(item);
                        questionCounter++;
                        groupHTML += `<div class="question-card" id="student-q-${globalIndex}">`;
                        let questionText = (item.question || item.main_question || '').replace(/\n/g, '<br>');
                       
                        groupHTML += `<div class="flex items-start">
                                     <div class="flex-grow">
                                         <div class="flex items-center mb-2">
                                             <span class="font-bold text-lg mr-3 text-indigo-600">Câu ${questionCounter}:</span>
                                             <div id="q-${globalIndex}-feedback-icon"></div>
                                         </div>
                                         <div class="question-content mt-2 text-lg text-slate-700">${questionText}</div>
                                         ${item.questionImage ? `<img src="${item.questionImage}" class="mt-4 rounded-lg max-w-full md:max-w-md border shadow-sm">` : ''}
                                     </div>
                                 </div>`;
                       
                        groupHTML += `<div class="mt-6">`;
                        switch(item.mappedType) {
                            case 'multiple-choice':
                                groupHTML += `<div class="options-grid grid grid-cols-1 md:grid-cols-2 gap-4">`;
                                item.options.forEach((opt, i) => {
                                    groupHTML += `<label for="q${globalIndex}-opt${i}" id="q${globalIndex}-opt-label${i}" class="option-label flex items-start p-4 border-2 rounded-xl cursor-pointer hover:bg-indigo-50 hover:border-indigo-400">
                                                     <input type="radio" name="q${globalIndex}" id="q${globalIndex}-opt${i}" value="${i}" class="flex-shrink-0 mt-1 h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                                     <div class="ml-3 flex-grow">
                                                         <span class="font-semibold text-slate-800">${String.fromCharCode(65 + i)}.</span>
                                                         <span class="option-content text-slate-700">${opt || ''}</span>
                                                         ${(item.optionsImage && item.optionsImage[i]) ? `<img src="${item.optionsImage[i]}" class="mt-2 rounded-lg max-w-xs border shadow-sm">` : ''}
                                                     </div>
                                                 </label>`;
                                });
                                groupHTML += `</div>`;
                                break;
                            case 'true-false':
                                 groupHTML += `<div class="space-y-4">`;
                                 item.statements.forEach((s, i) => {
                                     groupHTML += `<div class="statement-item border-t pt-4">
                                                  <p class="mb-3 text-slate-700">${String.fromCharCode(97 + i)}) ${s.statement || ''}</p>
                                                  <div class="flex gap-x-6">
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="true" class="mr-2 h-4 w-4"> Đúng</label>
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="false" class="mr-2 h-4 w-4"> Sai</label>
                                                  </div>
                                              </div>`;
                                 });
                                 groupHTML += `</div>`;
                                 break;
                            case 'short-answer':
                                groupHTML += `<input type="text" name="q${globalIndex}" class="mt-1 block w-full md:w-1/2 border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Nhập đáp án của bạn...">`;
                                break;
                            case 'essay':
                                groupHTML += `<textarea name="q${globalIndex}" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" rows="5" placeholder="Nhập câu trả lời tự luận của bạn..."></textarea>`;
                                break;
                        }
                        groupHTML += `</div><div id="q-${globalIndex}-feedback" class="mt-4"></div></div>`;
                    });
                    groupHTML += `</div>`;
                    studentQuizContainer.innerHTML += groupHTML;
                });
               
                if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                    MathJax.typesetPromise([studentQuizContainer]);
                }
            }
           
            async function generatePerformanceReview(allAnswersData) {
                const feedbackContainer = document.getElementById('ai-feedback-container');
                if (!feedbackContainer || !ai) return null;
                feedbackContainer.classList.remove('hidden');
                feedbackContainer.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-slate-800 mb-4">📝 Phân Tích & Gợi Ý Từ Trợ Lý AI</h3>
                        <div id="ai-feedback-loader" class="text-center py-6">
                            <svg class="animate-spin mx-auto h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p class="mt-3 text-slate-600">AI đang phân tích bài làm của bạn...</p>
                        </div>
                        <div id="ai-feedback-summary" class="hidden prose prose-sm max-w-none"></div>
                        <div id="ai-feedback-details" class="hidden mt-4 space-y-2"></div>
                    </div>
                `;
               
                const loader = document.getElementById('ai-feedback-loader');
                const summaryDiv = document.getElementById('ai-feedback-summary');
                const detailsDiv = document.getElementById('ai-feedback-details');
                const incorrectAnswers = allAnswersData.filter(a => !a.isCorrect);
                if (incorrectAnswers.length === 0) {
                    feedbackContainer.innerHTML = `
                        <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                            <h3 class="text-xl font-bold text-green-600">🎉 Chúc mừng!</h3>
                            <p class="mt-2 text-slate-700">Bạn đã trả lời đúng tất cả các câu hỏi. Làm tốt lắm!</p>
                        </div>
                    `;
                    return { overallFeedback: { summary: "Xuất sắc! Học sinh đã đã trả lời đúng tất cả các câu hỏi." } };
                }
                const summaryPrompt = `Bạn là một trợ lý giáo viên, nói tiếng Việt. Dựa vào tóm tắt các câu trả lời sai của học sinh, hãy đưa ra một nhận xét tổng quan ngắn gọn (khoảng 3-4 câu) về năng lực của học sinh, bao gồm điểm mạnh (suy luận từ các câu làm đúng), điểm yếu (dựa trên các câu sai) và một vài gợi ý ôn tập chung. Lời văn phải khích lệ, rõ ràng.
                Tóm tắt lỗi sai:
                ${JSON.stringify(incorrectAnswers.map(a => ({ cau: a.questionNumber, loai: a.type, cauHoi: a.question.substring(0, 50) + '...' })), null, 2)}`;
                try {
                    const summaryResponse = await ai.models.generateContent({
                        model: "gemini-2.5-flash",
                        contents: summaryPrompt
                    });
                    summaryDiv.innerHTML = summaryResponse.text.replace(/\n/g, '<br>');
                    loader.classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                    detailsDiv.classList.remove('hidden'); 
                } catch (e) {
                    console.error("Lỗi khi lấy nhận xét tổng quan:", e);
                    summaryDiv.innerHTML = '<p class="text-red-600">Lỗi khi tạo nhận xét tổng quan.</p>';
                    loader.classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                }
               
                const summaryForSheet = summaryDiv.innerText.substring(0, 200) + "...";
                return { overallFeedback: { summary: summaryForSheet } };
            }
            async function handleSubmit() {
                if (isSubmitted) return;
                isSubmitted = true;
                clearInterval(timerInterval);
                
                document.querySelectorAll('input, textarea').forEach(input => input.disabled = true);
                submitBtn.classList.add('hidden');
                postSubmitOptions.classList.remove('hidden');
                if (retriesLeft > 0) {
                    retryBtn.classList.remove('hidden');
                } else {
                    retryBtn.classList.add('hidden');
                }

                const proctoringDataString = JSON.stringify(proctoringLog);

                let totalStudentScore = 0;
                let totalCorrectAnswers = 0;
                let allAnswersData = [];
                const questionCounts = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    acc[type] = (acc[type] || 0) + 1;
                    return acc;
                }, {});
                
                quizData.forEach((item, index) => {
                    let questionNumber = index + 1;
                    let answerData = { questionNumber, type: item.type };
                    switch (item.mappedType) {
                        case 'multiple-choice':
                            const selectedOption = document.querySelector(`input[name="q${index}"]:checked`);
                            const isCorrectMC = selectedOption ? parseInt(selectedOption.value) === item.correctAnswerIndex : false;
                            if (isCorrectMC) {
                                totalCorrectAnswers++;
                                if (questionCounts['multiple-choice'] > 0) {
                                   totalStudentScore += quizOptions.scoring.mc / questionCounts['multiple-choice'];
                                }
                            }
                            answerData.question = item.question;
                            answerData.options = item.options;
                            answerData.yourAnswer = selectedOption ? String.fromCharCode(65 + parseInt(selectedOption.value)) : "Không trả lời";
                            answerData.correctAnswer = String.fromCharCode(65 + item.correctAnswerIndex);
                            answerData.isCorrect = isCorrectMC;
                            break;
                        case 'true-false':
                            let correctStatementsCount = 0;
                            let yourAnswerPattern = [];
                            let correctAnswerPattern = [];
                            let details = [];
                            item.statements.forEach((s, i) => {
                                const selectedTF = document.querySelector(`input[name="q${index}-s${i}"]:checked`);
                                const studentChoice = selectedTF ? selectedTF.value === 'true' : null;
                                const isStatementCorrect = studentChoice === s.is_correct;
                               
                                if (isStatementCorrect) correctStatementsCount++;
                               
                                yourAnswerPattern.push(studentChoice === null ? '?' : (studentChoice ? 'Đ' : 'S'));
                                correctAnswerPattern.push(s.is_correct ? 'Đ' : 'S');
                                details.push({ statement: s.statement, yourChoice: studentChoice === null ? 'Không trả lời' : (studentChoice ? 'Đúng' : 'Sai'), correctChoice: s.is_correct ? 'Đúng' : 'Sai', isCorrect: isStatementCorrect });
                            });
                            
                            let scorePerTfQuestion = 0;
                            if (questionCounts['true-false'] > 0) {
                                scorePerTfQuestion = quizOptions.scoring.tf / questionCounts['true-false'];
                            }
                            let questionPoints = 0;
                            if (quizOptions.scoring.tfMethod === 'progressive') {
                                const progressivePoints = { 0: 0, 1: 0.1, 2: 0.25, 3: 0.5, 4: 1.0 };
                                questionPoints = progressivePoints[correctStatementsCount] * scorePerTfQuestion;
                            } else { // even
                                questionPoints = (correctStatementsCount / 4) * scorePerTfQuestion;
                            }
                            totalStudentScore += questionPoints;

                            if(correctStatementsCount === 4) totalCorrectAnswers++;
                            answerData.question = item.main_question;
                            answerData.yourAnswer = yourAnswerPattern.join('-');
                            answerData.correctAnswer = correctAnswerPattern.join('-');
                            answerData.isCorrect = correctStatementsCount === 4;
                            answerData.details = details;
                            break;
                       
                        case 'short-answer':
                            const saInput = document.querySelector(`input[name="q${index}"]`);
                            const studentAnswerRaw = saInput ? (saInput.value ?? '').trim() : "";
                            const correctAnswerRaw = (item.answer ?? '').toString().trim().replace(/\$/g, '');
                            let isCorrectSA = false;
                            const studentAnswerNormalized = studentAnswerRaw.replace(',', '.');
                            const correctAnswerNormalized = correctAnswerRaw.replace(',', '.');
                            if (studentAnswerNormalized.toLowerCase() === correctAnswerNormalized.toLowerCase()) {
                                isCorrectSA = true;
                            }
                             if (isCorrectSA) {
                                totalCorrectAnswers++;
                                if (questionCounts['short-answer'] > 0) {
                                   totalStudentScore += quizOptions.scoring.sa / questionCounts['short-answer'];
                                }
                            }
                            answerData.question = item.question;
                            answerData.yourAnswer = studentAnswerRaw || "Không trả lời";
                            answerData.correctAnswer = correctAnswerRaw;
                            answerData.isCorrect = isCorrectSA;
                            break;
                           
                        case 'essay':
                             const essayInput = document.querySelector(`textarea[name="q${index}"]`);
                             answerData.question = item.question;
                             answerData.yourAnswer = essayInput.value || "Không trả lời";
                             answerData.correctAnswer = item.answer;
                             answerData.isCorrect = null; // Needs manual grading
                             break;
                    }
                    allAnswersData.push(answerData);
                });
                
                const finalScore = totalStudentScore;
                
                let competencyAssessment = "Giáo viên không yêu cầu AI phân tích bài làm.";
                if (quizOptions.aiAssessment) {
                    const feedbackData = await generatePerformanceReview(allAnswersData);
                    if (feedbackData && feedbackData.overallFeedback && feedbackData.overallFeedback.summary) {
                        competencyAssessment = feedbackData.overallFeedback.summary;
                    } else {
                        competencyAssessment = "Có lỗi xảy ra trong quá trình AI phân tích bài làm.";
                    }
                }
                
                if (quizOptions.showAnswers) {
                    const totalQuestions = quizData.length;
                    resultContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg text-center">
                        <h3 class="text-2xl font-bold text-slate-800">KẾT QUẢ BÀI LÀM</h3>
                        <p class="mt-4 text-lg">Số câu đúng hoàn toàn: <span class="font-bold text-green-600">${totalCorrectAnswers}/${totalQuestions}</span></p>
                        <p class="text-2xl mt-2">Điểm (thang 10): <span class="font-bold text-blue-600">${finalScore.toFixed(2)}</span></p>
                        ${questionCounts['essay'] > 0 ? `<p class="text-sm text-gray-600 italic mt-1">Lưu ý: Điểm trên chưa bao gồm ${quizOptions.scoring.essay} điểm của phần Tự luận.</p>` : ''}
                    </div>`;
                    resultContainer.classList.remove('hidden');

                    allAnswersData.forEach((ans, index) => {
                        const questionCard = document.getElementById(`student-q-${index}`);
                        const feedbackIconDiv = document.getElementById(`q-${index}-feedback-icon`);
                        const feedbackDiv = document.getElementById(`q-${index}-feedback`);
                        if (!questionCard || !feedbackIconDiv || !feedbackDiv) return;

                        const iconHTML = ans.isCorrect === true
                            ? '<svg class="feedback-icon text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>'
                            : (ans.isCorrect === false ? '<svg class="feedback-icon text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>' : '');
                        feedbackIconDiv.innerHTML = iconHTML;

                        if (ans.type.includes('multiple-choice')) {
                            const studentChoice = ans.yourAnswer === "Không trả lời" ? -1 : ans.yourAnswer.charCodeAt(0) - 65;
                            const correctChoice = ans.correctAnswer.charCodeAt(0) - 65;
                            document.getElementById(`q-${index}-opt-label${correctChoice}`)?.classList.add('correct');
                            if (studentChoice !== -1 && studentChoice !== correctChoice) {
                                document.getElementById(`q-${index}-opt-label${studentChoice}`)?.classList.add('incorrect');
                            }
                        } else if (ans.type === 'true-false') {
                            const statementItems = questionCard.querySelectorAll('.statement-item');
                            ans.details.forEach((detail, i) => { if(statementItems[i]) { statementItems[i].classList.add(detail.isCorrect ? 'correct' : 'incorrect'); }});
                        }

                        if (quizOptions.showExplanation) {
                            feedbackDiv.innerHTML = `<button data-explain-index="${index}" class="explain-btn mt-4 flex items-center px-4 py-2 bg-blue-100 text-blue-800 text-sm font-semibold rounded-lg hover:bg-blue-200 transition-colors">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Xem giải thích
                            </button>`;
                        }
                    });
                    
                    document.querySelectorAll('.explain-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const button = e.currentTarget;
                            const index = parseInt(button.dataset.explainIndex, 10);
                            showExplanation(index, button);
                        });
                    });

                    if (window.MathJax) await window.MathJax.typesetPromise([studentQuizContainer]);
                } else {
                     resultContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg text-center"><h3 class="text-xl font-bold text-green-600">Nộp bài thành công!</h3><p class="mt-2 text-slate-700">Bạn đã hoàn thành bài làm. Kết quả sẽ được giáo viên công bố sau.</p></div>`;
                    resultContainer.classList.remove('hidden');
                }
                
                const formData = new FormData();
                formData.append('name', studentInfo.name);
                formData.append('class', studentInfo.class);
                formData.append('score', `${finalScore.toFixed(2)}/10`);
                formData.append('assessment', competencyAssessment);
                formData.append('timestamp', new Date().toLocaleString('vi-VN'));
                formData.append('examCode', correctExamCode);
                formData.append('monitoringLog', proctoringDataString);
                formData.append('answerDetails', JSON.stringify(allAnswersData));
               
                fetch(googleScriptUrl, { method: 'POST', body: formData})
                    .then(res => console.log("Successfully submitted to Google Sheet"))
                    .catch(err => console.error("Error submitting to Google Sheet:", err));
            }
           
            function startNewAttempt() {
                isSubmitted = false;
                proctoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0, suKien: [] };
                const proctoringWidget = document.getElementById('proctoring-widget');
                if (proctoringWidget) {
                    proctoringWidget.classList.add('hidden');
                    document.getElementById('tab-switch-count').textContent = '0';
                    document.getElementById('copy-count').textContent = '0';
                    document.getElementById('paste-count').textContent = '0';
                }

                renderStudentQuiz();
                resultContainer.classList.add('hidden');
                document.getElementById('ai-feedback-container').classList.add('hidden');
                postSubmitOptions.classList.add('hidden');
                submitBtn.classList.remove('hidden');
                 if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                }
                retriesLeft--;
                retriesDisplay.textContent = `Lượt làm lại còn: ${retriesLeft}`;
                window.scrollTo(0, 0);
            }
            studentInfoForm.addEventListener('submit', (e) => {
                e.preventDefault();
               
                const enteredCode = document.getElementById('exam-code').value.trim().toUpperCase();
                if (enteredCode !== correctExamCode) {
                    alert('Mã đề không chính xác. Vui lòng kiểm tra lại!');
                    return;
                }
               
                studentApiKey = teacherApiKey;
                if (!studentApiKey) {
                    console.warn('Cảnh báo: Giáo viên chưa cấu hình API Key. Các tính năng AI sẽ không hoạt động.');
                }
       
                try {
                    if (studentApiKey) {
                       ai = new GoogleGenAI({ apiKey: studentApiKey });
                    }
                } catch(e) {
                    console.error("Lỗi khởi tạo Gemini API với key của giáo viên.", e);
                    alert("Cảnh báo: API Key của giáo viên không hợp lệ. Vui lòng báo cho giáo viên. Các tính năng AI sẽ không hoạt động.");
                    ai = null;
                }
                shuffleQuiz();
               
                studentInfo.name = document.getElementById('student-name').value;
                studentInfo.class = document.getElementById('student-class').value;
                loginModal.classList.add('hidden');
                studentQuizContainer.classList.remove('hidden');
                submitBtn.classList.remove('hidden');
               
                if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                } else {
                    timerDisplay.textContent = "Không giới hạn";
                }
                retriesDisplay.textContent = `Lượt làm lại còn: ${retriesLeft}`;
                renderStudentQuiz();

                const proctoringWidget = document.getElementById('proctoring-widget');
                const tabSwitchCountEl = document.getElementById('tab-switch-count');
                const copyCountEl = document.getElementById('copy-count');
                const pasteCountEl = document.getElementById('paste-count');

                function updateProctoringUI() {
                    if (proctoringLog.thoatManHinh > 0 || proctoringLog.saoChep > 0 || proctoringLog.dan > 0) {
                        proctoringWidget.classList.remove('hidden');
                    }
                    tabSwitchCountEl.textContent = proctoringLog.thoatManHinh;
                    copyCountEl.textContent = proctoringLog.saoChep;
                    pasteCountEl.textContent = proctoringLog.dan;
                }

                // Disable Right Click
                document.addEventListener('contextmenu', e => e.preventDefault());

                // Track Tab Switching
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && !isSubmitted) {
                        proctoringLog.thoatManHinh++;
                        proctoringLog.suKien.push({ loai: 'chuyen_tab', thoiGian: new Date().toISOString() });
                        updateProctoringUI();
                    }
                });

                // Track Copying
                document.addEventListener('copy', () => {
                    if (isSubmitted) return;
                    proctoringLog.saoChep++;
                    proctoringLog.suKien.push({ loai: 'sao_chep', thoiGian: new Date().toISOString() });
                    updateProctoringUI();
                });

                // Track Pasting
                document.addEventListener('paste', () => {
                    if (isSubmitted) return;
                    proctoringLog.dan++;
                    proctoringLog.suKien.push({ loai: 'dan', thoiGian: new Date().toISOString() });
                    updateProctoringUI();
                });
            });
            
            submitBtn.addEventListener('click', handleSubmit);
            retryBtn.addEventListener('click', () => {
                shuffleQuiz();
                startNewAttempt();
            });
        </script>
    </body>
    </html>
    