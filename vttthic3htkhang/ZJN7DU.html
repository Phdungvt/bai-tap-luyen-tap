
    <!DOCTYPE html>
    <html lang="vi">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>SỬ KT THỬ</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
        <script>
            window.MathJax = {
                tex: {
                    packages: {'[+]': ['ams']},
                    inlineMath: [['$', '$'], ['\\(', '\\)']],
                    displayMath: [['$$', '$$'], ['\\[', '\\]']]
                },
                chtml: {
                    fontCache: 'global',
                    linebreaks: {
                        automatic: true
                    }
                }
            };
        </script>
        <script type="text/javascript" id="MathJax-script" async
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
        </script>
        <style>
            body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #f0f4f8; }
            .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
            @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
            .question-card {
                background-color: white;
                border-radius: 1rem;
                padding: 1.5rem 2rem;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                border-left: 5px solid transparent;
                transition: all 0.3s ease;
            }
            .ai-explanation {
                background-color: #f0f9ff;
                color: #0c4a6e;
                padding: 1rem;
                border-radius: 0.75rem;
                font-size: 0.9rem;
                margin-top: 1rem;
                border-left: 4px solid #38bdf8;
            }
            .feedback-icon { width: 1.5rem; height: 1.5rem; }
            .option-label {
                transition: all 0.2s ease-in-out;
                border: 2px solid #e5e7eb;
            }
            .option-label:hover {
                border-color: #6366f1;
                background-color: #eef2ff;
            }
            .option-label.correct {
                border-color: #10b981 !important;
                background-color: #ecfdf5 !important;
                color: #065f46;
            }
            .option-label.incorrect {
                border-color: #ef4444 !important;
                background-color: #fef2f2 !important;
                color: #991b1b;
            }
            .statement-item.correct { background-color: #ecfdf5; border-color: #10b981; }
            .statement-item.incorrect { background-color: #fef2f2; border-color: #ef4444; }
            .prose { max-width: 100%; }
            .prose h1, .prose h2, .prose h3 { font-weight: 600; }
            .prose p { margin-top: 0.5em; margin-bottom: 0.5em; }
            .prose ul, .prose ol { margin-top: 1em; margin-bottom: 1em; padding-left: 1.5em; }
            .prose li > p { margin-top: 0; margin-bottom: 0; }
            .prose code { background-color: #e5e7eb; padding: 0.2em 0.4em; margin: 0; font-size: 85%; border-radius: 3px; }
            .prose pre { background-color: #e5e7eb; padding: 1em; border-radius: 0.5em; overflow-x: auto; }
            .prose pre code { background-color: transparent; padding: 0; }
            details[open] > summary .details-arrow {
                transform: rotate(180deg);
            }
        </style>
    </head>
    <body class="bg-slate-100 text-slate-800">
        <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md transform transition-all" style="animation: fadeIn 0.3s ease-out;">
                <h2 class="text-2xl font-bold mb-2 text-center text-slate-800">Thông Tin Học Sinh</h2>
                <p class="text-center text-slate-500 mb-6">Vui lòng nhập để bắt đầu làm bài.</p>
                <form id="student-info-form">
                    <div class="mb-4">
                        <label for="student-name" class="block text-sm font-medium text-slate-700 mb-1">Họ và tên</label>
                        <input type="text" id="student-name" required class="mt-1 block w-full block border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="student-class" class="block text-sm font-medium text-slate-700 mb-1">Lớp</label>
                        <input type="text" id="student-class" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="exam-code" class="block text-sm font-medium text-slate-700 mb-1">Mã đề</label>
                        <input type="text" id="exam-code" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Nhập mã đề giáo viên cung cấp">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Giáo viên:</label>
                        <p class="mt-1 text-slate-800 bg-slate-100 p-2.5 rounded-lg">Võ Thị Thiên Thi</p>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">Bắt đầu làm bài</button>
                </form>
            </div>
        </div>
        <div class="container mx-auto p-4 md:p-8 max-w-4xl">
            <header class="mb-10 p-8 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg">
                <div class="flex justify-between items-center flex-wrap gap-4">
                    <div>
                        <h1 class="text-4xl font-bold">SỬ KT THỬ</h1>
                        <p class="text-lg text-blue-100 mt-2">Hãy hoàn thành các câu hỏi dưới đây một cách tốt nhất!</p>
                        <p class="text-sm text-blue-200 mt-4">Tác giả: Võ Thị Thiên Thi</p>
                    </div>
                    <div id="timer-container" class="text-right">
                         <div id="timer-display" class="text-3xl font-bold tracking-wider bg-white/20 px-4 py-2 rounded-lg">--:--</div>
                         <div id="retries-display" class="text-sm mt-1 text-blue-200"></div>
                    </div>
                </div>
            </header>
            <main id="student-quiz-container" class="space-y-8 hidden">
                <!-- Questions will be rendered here by JS -->
            </main>
            <footer class="mt-10 text-center">
                <button id="submit-quiz-btn" class="bg-indigo-600 text-white py-3 px-12 rounded-full font-bold text-lg hover:bg-indigo-700 transition-all duration-300 shadow-lg hover:shadow-xl hidden transform hover:scale-105">Nộp Bài</button>
                <div id="result-container" class="mt-6 hidden"></div>
                <div id="ai-feedback-container" class="mt-8 text-left hidden"></div>
                <div id="post-submit-options" class="hidden mt-6 flex flex-col sm:flex-row items-center justify-center gap-4">
                    <button id="retry-quiz-btn" class="w-full sm:w-auto bg-slate-600 text-white py-2.5 px-6 rounded-lg font-semibold hover:bg-slate-700 transition-transform transform hover:scale-105">Làm Lại Đề Này</button>
                </div>
            </footer>
        </div>

        <div id="proctoring-widget" class="fixed bottom-4 right-4 bg-yellow-100 text-yellow-800 p-3 rounded-lg shadow-lg text-sm z-50 hidden border border-yellow-300" style="max-width: 200px;">
            <h4 class="font-bold mb-2 border-b border-yellow-300 pb-1 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 3.001-1.742 3.001H4.42c-1.53 0-2.493-1.667-1.743-3.001l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                Giám sát
            </h4>
            <p>Thoát màn hình: <span id="tab-switch-count" class="font-bold">0</span></p>
            <p>Sao chép: <span id="copy-count" class="font-bold">0</span></p>
            <p>Dán: <span id="paste-count" class="font-bold">0</span></p>
        </div>

        <script type="module">
            import { GoogleGenAI, Type } from "https://esm.sh/@google/genai@^1.13.0";
            let quizData = [{"type":"multiple-choice","question":"Thắng lợi ở Hà Nội, Huế, Sài Gòn trong Tổng khởi nghĩa tháng Tám năm 1945, có ý nghĩa như thế nào?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Đánh dấu Cách mạng tháng Tám giành được thắng lợi hoàn toàn trên cả nước từ Bắc đến Nam.","Tạo thế và lực để chính quyền cách mạng được thiết lập nhanh chóng trên phạm vi cả nước.","Tác động lớn đến các địa phương khác, đưa đến thắng lợi của Cách mạng Tám năm 1945 trên cả nước.","Đánh dấu sự sụp đổ hoàn toàn của chính quyền phong kiến và thực dân ở ba trung tâm lớn của cả nước."],"optionsImage":[null,null,null,null],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Năm 1963, Ma-lai-xi-a, In-đô-nê-xi-a và Phi-lip-pin thành lập","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Hiệp hội Đông Nam Á (ASA).","Hiệp hội các quốc gia Đông Nam Á (ASEAN).","Cộng đồng ASEAN.","tổ chức MAPHILINDO."],"optionsImage":[null,null,null,null],"correctAnswerIndex":3},{"type":"multiple-choice","question":"Hiệp hội các quốc gia Đông Nam Á (ASEAN) được ra đời trong bối cảnh","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["trật tự thế giới đa cực, nhiều trung tâm đã được thiết lập.","Trật tự thế giới hai cực I-an-ta đã sụp đổ hoàn toàn.","cuộc Chiến tranh lạnh đang ảnh hưởng đến nhiều nước.","cuộc chiến tranh xâm lược Việt Nam của Mỹ đã kết thúc."],"optionsImage":[null,null,null,null],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Hội nghị cấp cao ASEAN không chính thức được tổ chức tại Ma-lai-xi-a (1997) đã thông qua văn kiện quan trọng nào sau đây?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Tầm nhìn ASEAN 2025.","Tầm nhìn ASEAN sau 2025.","Hiến chương ASEAN 2007.","Tầm nhìn ASEAN 2020."],"optionsImage":[null,null,null,null],"correctAnswerIndex":3},{"type":"multiple-choice","question":"Nội dung nào dưới đây là điều kiện khách quan thuận lợi cho Cách mạng tháng Tám nổ ra?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Nhật đầu hàng Đồng minh vô điều kiện.","Chiến tranh thế giới thứ hai bùng nổ.","Phát xít Đức đầu hàng Đồng minh.","Mỹ ném bom nguyên tử xuống Nhật Bản."],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Việt Nam có thể vận dụng nguyên tắc hoạt động nào của Liên hợp quốc để giải quyết vấn đề ở Biển Đông?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Giải quyết các tranh chấp bằng biện pháp hoà bình.","Sự nhất trí của các nước thường trực Hội đồng bảo an.","Quyền bình đẳng giữa các thành viên Liên hợp quốc.","Không dùng vũ lực để tấn công các quốc gia khác."],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Nội dung nào sau đây là thách thức của Cộng đồng ASEAN sau năm 2015?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Sự tương đồng về văn hóa.","Tình trạng ô nhiễm môi trường gia tăng.","Một số nước chưa giành được độc lập.","Hợp tác nội khối còn lỏng lẻo."],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Từ sau Chiến tranh lạnh, các nước trên thế giới có sự điều chỉnh quan hệ theo hướng đối thoại, thoả hiệp và tránh xung đột trực tiếp, chủ yếu vì lí do nào sau đây?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Muốn có môi trường thuận lợi để vươn lên xác lập vị thế quốc tế.","Hợp tác địa - chính trị trở thành nội dung căn bản giữa các nước.","Từng bước giảm bớt số lượng vũ khí hạt nhân của các cường quốc.","Cần tập trung vào cuộc đấu tranh chống lại chủ nghĩa khủng bố."],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Nguyên nhân chủ yếu quyết định thắng lợi của Cách mạng tháng Tám năm 1945 là do","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["dân tộc Việt Nam có truyền thống yêu nước, tinh thần đấu tranh kiên cường bất khuất.","đã tập hợp được lực lượng yêu nước ở mọi mặt trận thống nhất.","sự lãnh đạo tài tình của Đảng, đứng đầu là Chủ tịch Hồ Chí Minh.","quân Đồng minh đã đánh bại phát xít Đức- Nhật trong Chiến tranh thế giới thứ hai."],"optionsImage":[null,null,null,null],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Nội dung nào sau đây là triển vọng của Cộng đồng ASEAN?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Cạnh tranh với Trung Quốc về phát triển khoa học vũ trụ.","Giải quyết hết hoàn toàn mâu thuẫn giữa các nước về vấn đề Biển Đông.","Vị thế ngày càng cao trong khu vực và trên thế giới.","Biến đổi khí hậu, ô nhiễm môi trường, dịch bệnh được giải quyết triệt để."],"optionsImage":[null,null,null,null],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Các quốc gia Đông Nam Á tham gia thành lập tổ chức ASEAN là","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Thái lan, Cam-pu-chia, Ma-lai-xi-a, Xin-ga-po và Phi-líp-pin.","Thái lan, Mi-an-ma, Ma-lai-xi-a, Xin-ga-po và Phi-líp-pin.","Thái lan, In-đô-nê-xi-a, Ma-lai-xi-a, Xin-ga-po và Phi-líp-pin.","Thái lan, Bru-nây, Ma-lai-xi-a, Xin-ga-po và Phi-líp-pin."],"optionsImage":[null,null,null,null],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Thắng lợi của nhân dân Việt Nam trong Cách mạng tháng Tám đã có ý nghĩa như thế nào đối với thế giới ?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Góp phần làm đảo lộn và đưa tới thất bại chiến lược toàn cầu của Mỹ.","Góp phần đưa đến sự ra đời của hơn 100 quốc gia độc lập trẻ tuổi.","Cổ vũ các dân tộc thuộc địa và phụ thuộc đấu tranh tự giải phóng.","Xây dựng vững chắc thành trì của phong trào giải phóng dân tộc."],"optionsImage":[null,null,null,null],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Trong bối cảnh quốc tế đang diễn ra theo nhiều xu thế mới với những diễn biến phức tạp, chủ trương nhất quán của Đảng và Nhà nước Việt Nam là","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["tham gia liên minh chính trị với Mỹ và các nước phương Tây.","bằng mọi cách kết nối các cường quốc đế nâng tầm đối tác chiến lược.","hội nhập quốc tế để thu hút vốn đầu tư bên ngoài bằng mọi giá.","chủ động nắm bắt thời cơ, đi tắt đón đầu để vượt qua thách thức."],"optionsImage":[null,null,null,null],"correctAnswerIndex":3},{"type":"multiple-choice","question":"Hiến chương Liên hợp quốc được thông qua tại hội nghị nào?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Hội nghị Ianta (1945).","Hội nghị Xan Phran-xi-xco (1945).","Hội nghị Pari (1973).","Hội nghị Pốtxđam (1946)."],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Hiệp hội các quốc gia Đông Nam Á (ASEAN) được thành lập là biểu hiện rõ nét của xu thế nào?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Liên kết khu vực.","Hòa hoãn Đông-Tây.","Toàn cầu hóa xuất hiện.","Đa cực, nhiều trung tâm."],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Mối quan hệ hợp tác của Liên hợp quốc với Việt Nam hiện nay là","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["hợp tác theo hướng ngày càng sâu rộng và hiệu quả.","giúp đỡ giải quyết hậu quả nặng nề của chiến tranh.","viện trợ không hoàn lại để phát triển kinh tế, văn hóa.","thúc đẩy cải cách đất nước thực hiện các quyền tự do dân chủ."],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Sự kiện nào dưới đây đánh dấu chế độ phong kiến ở Việt Nam đã sụp đổ hoàn toàn?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Giành được chính quyền ở Hà Nội.","Khởi nghĩa thắng lợi trong cả nước.","Hồ Chí Minh đọc Tuyên ngôn Độc lập.","Vua Bảo Đại tuyên bố thoái vị."],"optionsImage":[null,null,null,null],"correctAnswerIndex":3},{"type":"multiple-choice","question":"Ý tưởng về việc xây dựng Cộng đồng ASEAN được khởi nguồn tư khi","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["các nước ASEAN kí kết Hiệp ước Ba-li (1976).","thành lập tổ chức ASEAN (1967).","tổ chức ASEAN có đủ 10 nước thành viên (1999).","“vấn đề Cam-pu-chia” được giải quyết (1991)."],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"<strong> Trật tự thế giới hai cực I-an-ta sụp đổ (1991) có tác động như thế nào đến tình hình quốc tế?</strong>","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Mỹ chuyển sang ủng hộ sự phát triển xu thế đa cực, nhiều trung tâm.</strong>","Tạo điều kiện để giải quyết các tranh chấp bằng biện pháp hòa bình.</strong>","Đưa tới sự ra đời của Hiệp hội các quốc gia Đông Nam Á.</strong>","Trung Quốc đã vươn lên trở thành nền kinh tế số 1 thế giới.</strong>"],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Sự kiện nào sau đây chính thức chấm dứt sự sụp đổ của Trật tự thế giới hai cực I-an-ta?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Cuộc gặp giữa hai nhà lãnh đạo Mỹ và Liên Xô ở đảo Man-ta.","Sự sụp đổ của chủ nghĩa xã hội ở Đông Âu và Liên Xô.","Mỹ và Liên Xô ký Hiệp ước hạn chế vũ khí chiến lược (SALT1).","Mỹ ký Hiệp định Pari về chấm dứt chiến tranh, lập lại hòa bình ở Việt Nam."],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Hội nghị Ianta diễn ra trong bối cảnh Chiến tranh thế giới thứ hai","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["đã hoàn toàn kết thúc.","đang diễn ra vô cùng ác liệt.","bùng nổ và ngày càng lan rộng.","bước vào giai đoạn kết thúc."],"optionsImage":[null,null,null,null],"correctAnswerIndex":3},{"type":"multiple-choice","question":"Hội nghị toàn quốc của Đảng Cộng sản Đông Dương họp ở Tân Trào (14-15/8/1945) đã thông qua kế hoạch","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["thống nhất các lực lượng vũ trang.","quyết định khởi nghĩa ở Hà Nội.","thành lập căn cứ Việt Bắc.","lãnh đạo toàn dân Tổng khởi nghĩa."],"optionsImage":[null,null,null,null],"correctAnswerIndex":3},{"type":"multiple-choice","question":"Nội dung nào sau đây là một trong những quyết định của Hội nghị I-an-ta (2-1945)?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Tiêu diệt tận gốc chủ nghĩa phát xít Đức và chủ nghĩa quân phiệt Nhật Bản.","Xây dựng một trật tự thế giới mới nhằm giải quyểt dứt điểm các vấn đề hậu chiến tranh.","Đồng ý thành lập tổ chức Hội Quốc liên để duy trì hoà bình và an ninh thế giới.","Thoả thuận việc phân chia phạm vi ảnh hưởng của Mỹ và Liên Xô ở châu Phi."],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"<strong> Q</strong>uyết định của hội nghị nào sau đây hình thành trật tự thế giới mới sau Chiến tranh thế giới thứ hai?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Hội nghị Giơ-ne-vơ.","Hội nghị I-an-ta.","Hội nghị Ba-li.","Hội nghị Pa-ri."],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"true-false","question":null,"main_question":"<strong></strong> Cho đoạn tư liệu sau đây:<br><em>“1. Duy trì hoà bình và an ninh quốc tế, và để đạt được mục đích đó: thi hành những biện pháp tập thể có hiệu quả để phòng ngừa và loại trừ các mối đe dọa hoà bình, cấm mọi hành vi xâm lược và phá hoại hoà bình khác; điều chỉnh hoặc giải quyết các vụ tranh chấp hoặc những tình thế có tính chất quốc tế có thể đưa đến sự phá hoại hoà bình, bằng phương pháp hoà bình theo đúng nguyên tắc của công lý và pháp luật quốc tế;</em><br><em>2. Phát triển mối quan hệ hữu nghị giữa các dân tộc trên cơ sở tôn trọng nguyên tắc bình đẳng và tự quyết của các dân tộc và áp dụng những biện pháp phù hợp khác để củng cố hoà bình thế giới;</em><br><em>3. Thực hiện sự hợp tác quốc tế trong việc giải quyết các vấn đề quốc tế về kinh tế, xã hội, văn hoá và nhân đạo và khuyến khích phát triển sự tôn trọng các quyền của con người và các tự do cơ bản cho tất cả mọi người không phân biệt chủng tộc, nam nữ, ngôn ngữ hoặc tôn giáo;</em><br><em>4. Trở thành trung tâm phối hợp mọi hành động của các dân tộc, nhằm đạt được những mục đích chung nói trên.”</em><br>(Trích: Điều 1, <em>Hiến chương Liên hợp quốc</em>, ngày 24-10-1945)","questionImage":null,"mappedType":"true-false","statements":[{"statement":"</strong> Tư liệu trên đã phản ánh rõ các mục tiêu và nguyên tắc hoạt động của tổ chức Liên hợp quốc.","is_correct":false},{"statement":"</strong> Trong số các mục tiêu của Liên hợp quốc, mục tiêu duy trì hoà bình và an ninh quốc tế là mục tiêu hàng đầu, được các nước thành viên chú trọng và coi là cơ sở để thực hiện các mục tiêu khác.","is_correct":true},{"statement":"</strong> Mối quan hệ giữa các nước thành viên của Liên hợp quốc được xây dựng chủ yếu dựa trên nền tảng lấy quyền lợi quốc gia, quyền lợi dân tộc là trên hết.","is_correct":false},{"statement":"</strong> Ngày nay, Liên hợp quốc vẫn tiếp tục thực hiện mục tiêu giải quyết các vụ tranh chấp, xung đột quốc tế bằng biện pháp hoà bình theo đúng nguyên tắc của công lý và pháp luật quốc tế.","is_correct":true}]},{"type":"true-false","question":null,"main_question":"<strong></strong> Cho đoạn tư liệu sau đây:<br><em>“Tháng 3-1947, Tổng thống Mỹ Truman đã đọc diễn văn trước Quốc hội Mỹ, chính thức đưa ra chủ nghĩa Truman. Theo Truman thì các nước Đông Âu vừa mới bị cộng sản thôn tính và những đe dọa tương tự đang diễn ra trên nhiều nước khác ở châu Âu, ở I-ta-li-a, Pháp và cả nước Đức nữa. Vì vậy, Mỹ phải đứng ra đảm nhận sứ mệnh lãnh đạo thế giới tự do, phải giúp đỡ cho các dân tộc trên thế giới chống lại sự đe dọa của chủ nghĩa cộng sản, chống lại sự bành trướng của nước Nga, giúp đỡ bằng mọi biện pháp kinh tế, quân sự. Tổng thống Mỹ Truman đã phát động cuộc chiến tranh lạnh chống Liên Xô và các nước xã hội chủ nghĩa.”</em><br>(Nguyễn Anh Thái, <em>Lịch sử thế giới hiện đại (1917-1995),</em> NXB Giáo dục , tr. 235).","questionImage":null,"mappedType":"true-false","statements":[{"statement":"</strong> Đoạn tư liệu trên đã phản ánh chiến tranh lạnh là cuộc đối đầu trực tiếp giữa Mĩ và các nước trên thế giới.","is_correct":false},{"statement":"</strong> Thông điệp của Tổng thống Mỹ Truman tại Quốc hội Mỹ (1947) được xem là khởi đầu cho cuộc Chiến tranh lạnh.","is_correct":true},{"statement":"</strong> Trong thời kì Chiến tranh lạnh, các cuộc chiến tranh cục bộ trên thế giới đều có sự can thiệp của Mĩ và Liên Xô đã để lại hậu quả nặng nề đối với nhiều quốc gia.","is_correct":true},{"statement":"</strong> Cuộc chiến tranh xâm lược của Pháp và Mĩ ở Việt Nam (1945 – 1975) biến Việt Nam trở thành tâm điểm lớn nhất thế giới trong Chiến tranh lạnh.","is_correct":false}]},{"type":"true-false","question":null,"main_question":"<strong></strong> Cho đoạn tư liệu sau đây:<br><em>“Trật tự thế giới mới này được hình thành như thế nào, còn tuỳ thuộc ở nhiều nhân tố: Sự phát triển về thực lực kinh tế, chính trị, quân sự của các cường quốc Mỹ, Nga, Trung Quốc, Anh, Pháp, Nhật Bản, Đức trong cuộc chạy đua về sức mạnh quốc gia tổng hợp,...; Sự lớn mạnh của lực lượng cách mạng thế giới (sự thành bại của công cuộc cải cách, đổi mới ở các nước xã hội chủ nghĩa,...); Sự phát triển của cách mạng khoa học – kĩ thuật sẽ còn tiếp tục tạo ra những “đột phá” và biến chuyển trên cục diện thế giới”.</em><br>(Nguyễn Anh Thái (Chủ biên), <em>Lịch sử thế giới hiện đại,</em> NXB Giáo dục Việt Nam, Hà Nội, 2021, tr.424)","questionImage":null,"mappedType":"true-false","statements":[{"statement":"</strong> Khái niệm đa cực được dùng chủ yếu để chỉ trật tự thế giới sau Chiến tranh lạnh.","is_correct":true},{"statement":"</strong> Đoạn tư liệu là minh chứng cho thời kỳ Chiến tranh lạnh với xu thế đa cực, nhiều trung tâm trong quan hệ quốc tế diễn ra mạnh mẽ.","is_correct":false},{"statement":"</strong> <em>Sự phát triển về kinh tế, chính trị, quân sự của các cường quốc là một trong những nhân tố quyết định đến việc hình thành trật tự thế giới mới.</em>","is_correct":true},{"statement":"</strong> Sự phát triển của khoa học kĩ thuật, xu thế toàn cầu hóa đã đem tới tất cả cơ hội cho sự phát triển của Việt Nam trong bối cảnh mới của thế giới.","is_correct":false}]},{"type":"true-false","question":null,"main_question":"<strong></strong> Cho đoạn tư liệu sau đây:<br><strong><em>“Thúc đẩy sự tăng trưởng kinh tế, tiến bộ xã hội và phát triển văn hoá trong khu vực thông qua những nỗ lực hợp tác chung trên tinh thần bình đẳng và hợp tác nhằm tăng cường cơ sở cho một cộng đồng các nước Đông Nam Á hoà bình và thịnh vượng.</em></strong><br><strong><em>Thúc đẩy hoà bình ổn định khu vực bằng việc tôn trọng pháp lí và nguyên tắc luật pháp trong quan hệ giữa các nước trong khu vực và tuân thủ các nguyên tắc của Hiến chương Liên hợp quốc.</em></strong><br><strong><em>Thúc đẩy sự cộng tác tích cực và giúp đỡ lẫn nhau trong các vấn đề cùng quan tâm trên các lĩnh vực kinh tế, xã hội, văn hoá, khoa học – kĩ thuật và hành chính”.</em></strong><br><strong>(Nguyễn Anh Thái (Chủ biên), <em>Lịch sử thế giới hiện đại</em>, NXB Giáo dục, Hà Nội, 1998, tr.358)</strong>","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Hiệp hội các quốc gia Đông Nam Á (ASEAN) ra đời năm 1967 là một tổ chức liên minh chính trị – kinh tế của khu vực, nằm trong Cộng đồng ASEAN.</strong>","is_correct":false},{"statement":"Một trong những mục đích thành lập của Hiệp hội các quốc gia Đông Nam Á (ASEAN) là duy trì hoà bình ổn định của khu vực.</strong>","is_correct":true},{"statement":"Nguyên tắc hoạt động của Hiệp hội các quốc gia Đông Nam Á (ASEAN) có những điểm tương đồng với nguyên tắc hoạt động của Liên hợp quốc.</strong>","is_correct":true},{"statement":"Sau khi gia nhập ASEAN (1995), Việt Nam ngay lập tức trở thành quốc gia giữ vai trò trung tâm, dẫn dắt chính các hoạt động của tổ chức.</strong>","is_correct":false}]}];
            const quizOptions = {"timeLimit":30,"retriesAllowed":1,"showAnswers":true,"showExplanation":true,"aiAssessment":true,"scoring":{"mc":6,"tf":4,"sa":0,"essay":0,"tfMethod":"progressive"}};
            const googleScriptUrl = "https://script.google.com/macros/s/AKfycbx9EqsmE1M7CBVcddF6QWeYYryClNv7HMRYHj5sKBCa4gA4n33taQDC-ppVDzwAWo2d/exec";
            const correctExamCode = "ZJN7DU";
            const teacherApiKey = "AIzaSyCc0Ky_zMx7FmbI1_tgCIfMYi_TH9BNBrM";
            let studentInfo = {};
            let isSubmitted = false;
            let timerInterval;
            let retriesLeft = quizOptions.retriesAllowed;
            let studentApiKey = "";
            let ai = null;

            let proctoringLog = {
                thoatManHinh: 0,
                saoChep: 0,
                dan: 0,
                suKien: []
            };

            const studentQuizContainer = document.getElementById('student-quiz-container');
            const submitBtn = document.getElementById('submit-quiz-btn');
            const resultContainer = document.getElementById('result-container');
            const postSubmitOptions = document.getElementById('post-submit-options');
            const retryBtn = document.getElementById('retry-quiz-btn');
            const loginModal = document.getElementById('login-modal');
            const studentInfoForm = document.getElementById('student-info-form');
            const timerDisplay = document.getElementById('timer-display');
            const retriesDisplay = document.getElementById('retries-display');

            function formatAIText(text) {
                if (!text) return '';
                let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                formattedText = formattedText.replace(/\n/g, '<br>');
                return formattedText;
            }

            function shuffleQuiz() {
                // Shuffle options/statements within each question first
                quizData.forEach(item => {
                    // Shuffle multiple-choice options and their corresponding images
                    if (item.mappedType === 'multiple-choice' && item.options && item.options.length > 0) {
                        const correctAnswerText = item.options[item.correctAnswerIndex];
                        let optionsWithImages = item.options.map((opt, index) => ({
                            text: opt,
                            image: (item.optionsImage && item.optionsImage[index]) ? item.optionsImage[index] : null
                        }));
                        // Fisher-Yates shuffle
                        for (let i = optionsWithImages.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [optionsWithImages[i], optionsWithImages[j]] = [optionsWithImages[j], optionsWithImages[i]];
                        }
                        // Update the item with shuffled data
                        item.options = optionsWithImages.map(opt => opt.text);
                        item.optionsImage = optionsWithImages.map(opt => opt.image);
                        item.correctAnswerIndex = item.options.indexOf(correctAnswerText);
                    }
                    // Shuffle true-false statements
                    if (item.mappedType === 'true-false' && item.statements && item.statements.length > 0) {
                         for (let i = item.statements.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [item.statements[i], item.statements[j]] = [item.statements[j], item.statements[i]];
                        }
                    }
                });
                // Then, group questions by type and shuffle within each group
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});
                let shuffledQuizData = [];
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    if (grouped[partType]) {
                        const partQuestions = grouped[partType];
                        for (let i = partQuestions.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [partQuestions[i], partQuestions[j]] = [partQuestions[j], partQuestions[i]];
                        }
                        shuffledQuizData = shuffledQuizData.concat(partQuestions);
                    }
                });
               
                quizData = shuffledQuizData;
            }
            // --- Timer Function ---
            function startTimer(duration, display) {
                let timer = duration, minutes, seconds;
                clearInterval(timerInterval); // Clear any existing timer
                if(duration <= 0) {
                     display.textContent = "∞";
                     return;
                }
                timerInterval = setInterval(function () {
                    minutes = parseInt(timer / 60, 10);
                    seconds = parseInt(timer % 60, 10);
                    minutes = minutes < 10 ? "0" + minutes : minutes;
                    seconds = seconds < 10 ? "0" + seconds : seconds;
                    display.textContent = minutes + ":" + seconds;
                    if (--timer < 0) {
                        clearInterval(timerInterval);
                        alert("Hết giờ làm bài!");
                        handleSubmit();
                    }
                }, 1000);
            }
            
            async function showExplanation(index, button) {
                const item = quizData[index];
                const questionCard = document.getElementById(`student-q-${index}`);
                const feedbackDiv = document.getElementById(`q-${index}-feedback`);
                if (!questionCard || !feedbackDiv) return;

                const existingExplanation = feedbackDiv.querySelector('.ai-explanation');
                if (existingExplanation) {
                    existingExplanation.remove();
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Xem giải thích
                    `;
                    return;
                }

                button.disabled = true;
                button.innerHTML = '<div class="loader mr-2"></div> Đang tải...';

                if (item.explanation) {
                    displayExplanation(item.explanation, feedbackDiv, button);
                    return;
                }

                if (!ai) {
                    alert("Tính năng giải thích yêu cầu API Key, nhưng chưa được cấu hình bởi giáo viên.");
                    button.disabled = false;
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Xem giải thích
                    `;
                    return;
                }

                const questionText = item.question || item.main_question;
                let prompt = `Bạn là một trợ lý giáo viên AI, am hiểu sâu sắc Chương trình GDPT 2018. Hãy cung cấp một lời giải chi tiết, từng bước một cho câu hỏi sau đây. Lời giải phải chính xác, dễ hiểu và phù hợp với phương pháp giảng dạy của chương trình học, TUYỆT ĐỐI KHÔNG sử dụng kiến thức của lớp cao hơn để giải thích.\n\n--- CÂU HỎI ---\n${questionText}\n\n`;
                if (item.mappedType === 'multiple-choice') {
                    prompt += `--- CÁC LỰA CHỌN ---\n${item.options.map((opt, i) => `${String.fromCharCode(65 + i)}. ${opt}`).join('\n')}\n\n`;
                    prompt += `--- ĐÁP ÁN ĐÚNG ---\n${String.fromCharCode(65 + item.correctAnswerIndex)}. ${item.options[item.correctAnswerIndex]}`;
                } else if (item.mappedType === 'true-false') {
                    prompt += `--- CÁC MỆNH ĐỀ & ĐÁP ÁN ---\n${item.statements.map(s => ` - ${s.statement} -> ${s.is_correct ? 'Đúng' : 'Sai'}`).join('\n')}`;
                } else {
                    prompt += `--- ĐÁP ÁN / GỢI Ý ---\n${item.answer}`;
                }
                prompt += `\n\n--- YÊU CẦU ---\nGiải thích rõ ràng tại sao đáp án lại đúng, từng bước một. Dùng **...** để in đậm các thuật ngữ quan trọng. Định dạng tất cả các công thức toán học bằng LaTeX.`;

                try {
                    const response = await ai.models.generateContent({ model: "gemini-2.5-flash", contents: prompt });
                    const explanationText = response.text; // Keep it raw
                    item.explanation = explanationText; // Cache it
                    displayExplanation(explanationText, feedbackDiv, button);
                } catch (error) {
                    console.error("Lỗi khi tạo giải thích:", error);
                    feedbackDiv.insertAdjacentHTML('beforeend', '<div class="ai-explanation text-red-600">Lỗi: Không thể tạo giải thích.</div>');
                    button.disabled = false;
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Thử lại
                    `;
                }
            }

            function displayExplanation(explanationText, container, button) {
                container.insertAdjacentHTML('beforeend', `<div class="ai-explanation prose prose-sm">${formatAIText(explanationText)}</div>`);
                if (window.MathJax) MathJax.typesetPromise([container]);
                button.disabled = false;
                button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    Ẩn giải thích
                `;
            }
           
            function renderStudentQuiz() {
                studentQuizContainer.innerHTML = '';
               
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});
                const groupInfo = {
                    'multiple-choice': { title: 'PHẦN I. TRẮC NGHIỆM KHÁCH QUAN', subtitle: 'Chọn đáp án đúng nhất trong các lựa chọn sau.' },
                    'true-false': { title: 'PHẦN II. CÂU HỎI ĐÚNG - SAI', subtitle: 'Xác định tính đúng hoặc sai cho mỗi mệnh đề dưới đây.' },
                    'short-answer': { title: 'PHẦN III. CÂU HỎI TRẢ LỜI NGẮN', subtitle: 'Điền đáp án ngắn gọn vào phần trả lời.' },
                    'essay': { title: 'PHẦN IV. CÂU HỎI TỰ LUẬN', subtitle: 'Trình bày chi tiết bài giải của bạn.' }
                };
               
                let questionCounter = 0;
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    const questions = grouped[partType];
                    if (!questions || questions.length === 0) return;
                   
                    let groupHTML = `<div class="group-container space-y-8 mb-12">`;
                    const info = groupInfo[partType];
                    groupHTML += `
                        <div class="group-header pb-3 border-b-2 border-slate-300 mb-6">
                            <h2 class="text-2xl font-bold text-slate-800">${info.title}</h2>
                            ${info.subtitle ? `<p class="text-md text-slate-600 italic mt-1">${info.subtitle}</p>` : ''}
                        </div>
                    `;
                    questions.forEach((item, localIndex) => {
                        const globalIndex = quizData.indexOf(item);
                        questionCounter++;
                        groupHTML += `<div class="question-card" id="student-q-${globalIndex}">`;
                        let questionText = (item.question || item.main_question || '').replace(/\n/g, '<br>');
                       
                        groupHTML += `<div class="flex items-start">
                                     <div class="flex-grow">
                                         <div class="flex items-center mb-2">
                                             <span class="font-bold text-lg mr-3 text-indigo-600">Câu ${questionCounter}:</span>
                                             <div id="q-${globalIndex}-feedback-icon"></div>
                                         </div>
                                         <div class="question-content mt-2 text-lg text-slate-700">${questionText}</div>
                                         ${item.questionImage ? `<img src="${item.questionImage}" class="mt-4 rounded-lg max-w-full md:max-w-md border shadow-sm">` : ''}
                                     </div>
                                 </div>`;
                       
                        groupHTML += `<div class="mt-6">`;
                        switch(item.mappedType) {
                            case 'multiple-choice':
                                groupHTML += `<div class="options-grid grid grid-cols-1 md:grid-cols-2 gap-4">`;
                                item.options.forEach((opt, i) => {
                                    groupHTML += `<label for="q${globalIndex}-opt${i}" id="q${globalIndex}-opt-label${i}" class="option-label flex items-start p-4 border-2 rounded-xl cursor-pointer hover:bg-indigo-50 hover:border-indigo-400">
                                                     <input type="radio" name="q${globalIndex}" id="q${globalIndex}-opt${i}" value="${i}" class="flex-shrink-0 mt-1 h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                                     <div class="ml-3 flex-grow">
                                                         <span class="font-semibold text-slate-800">${String.fromCharCode(65 + i)}.</span>
                                                         <span class="option-content text-slate-700">${opt || ''}</span>
                                                         ${(item.optionsImage && item.optionsImage[i]) ? `<img src="${item.optionsImage[i]}" class="mt-2 rounded-lg max-w-xs border shadow-sm">` : ''}
                                                     </div>
                                                 </label>`;
                                });
                                groupHTML += `</div>`;
                                break;
                            case 'true-false':
                                 groupHTML += `<div class="space-y-4">`;
                                 item.statements.forEach((s, i) => {
                                     groupHTML += `<div class="statement-item border-t pt-4">
                                                  <p class="mb-3 text-slate-700">${String.fromCharCode(97 + i)}) ${s.statement || ''}</p>
                                                  <div class="flex gap-x-6">
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="true" class="mr-2 h-4 w-4"> Đúng</label>
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="false" class="mr-2 h-4 w-4"> Sai</label>
                                                  </div>
                                              </div>`;
                                 });
                                 groupHTML += `</div>`;
                                 break;
                            case 'short-answer':
                                groupHTML += `<input type="text" name="q${globalIndex}" class="mt-1 block w-full md:w-1/2 border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Nhập đáp án của bạn...">`;
                                break;
                            case 'essay':
                                groupHTML += `<textarea name="q${globalIndex}" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" rows="5" placeholder="Nhập câu trả lời tự luận của bạn..."></textarea>`;
                                break;
                        }
                        groupHTML += `</div><div id="q-${globalIndex}-feedback" class="mt-4"></div></div>`;
                    });
                    groupHTML += `</div>`;
                    studentQuizContainer.innerHTML += groupHTML;
                });
               
                if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                    MathJax.typesetPromise([studentQuizContainer]);
                }
            }
           
            async function generatePerformanceReview(allAnswersData) {
                const feedbackContainer = document.getElementById('ai-feedback-container');
                if (!feedbackContainer || !ai) return null;
                feedbackContainer.classList.remove('hidden');
                feedbackContainer.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-slate-800 mb-4">📝 Phân Tích & Gợi Ý Từ Trợ Lý AI</h3>
                        <div id="ai-feedback-loader" class="text-center py-6">
                            <svg class="animate-spin mx-auto h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p class="mt-3 text-slate-600">AI đang phân tích bài làm của bạn...</p>
                        </div>
                        <div id="ai-feedback-summary" class="hidden prose prose-sm max-w-none"></div>
                        <div id="ai-feedback-details" class="hidden mt-4 space-y-2"></div>
                    </div>
                `;
               
                const loader = document.getElementById('ai-feedback-loader');
                const summaryDiv = document.getElementById('ai-feedback-summary');
                const detailsDiv = document.getElementById('ai-feedback-details');
                const incorrectAnswers = allAnswersData.filter(a => !a.isCorrect);
                if (incorrectAnswers.length === 0) {
                    feedbackContainer.innerHTML = `
                        <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                            <h3 class="text-xl font-bold text-green-600">🎉 Chúc mừng!</h3>
                            <p class="mt-2 text-slate-700">Bạn đã trả lời đúng tất cả các câu hỏi. Làm tốt lắm!</p>
                        </div>
                    `;
                    return { overallFeedback: { summary: "Xuất sắc! Học sinh đã đã trả lời đúng tất cả các câu hỏi." } };
                }
                const summaryPrompt = `Bạn là một trợ lý giáo viên, nói tiếng Việt. Dựa vào tóm tắt các câu trả lời sai của học sinh, hãy đưa ra một nhận xét tổng quan ngắn gọn (khoảng 3-4 câu) về năng lực của học sinh, bao gồm điểm mạnh (suy luận từ các câu làm đúng), điểm yếu (dựa trên các câu sai) và một vài gợi ý ôn tập chung. Lời văn phải khích lệ, rõ ràng. Dùng **...** để in đậm các thuật ngữ quan trọng.
                Tóm tắt lỗi sai:
                ${JSON.stringify(incorrectAnswers.map(a => ({ cau: a.questionNumber, loai: a.type, cauHoi: a.question.substring(0, 50) + '...' })), null, 2)}`;
                try {
                    const response = await ai.models.generateContent({
                        model: "gemini-2.5-flash",
                        contents: summaryPrompt
                    });
                    summaryDiv.innerHTML = formatAIText(response.text);
                    loader.classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                    detailsDiv.classList.remove('hidden'); 
                } catch (e) {
                    console.error("Lỗi khi lấy nhận xét tổng quan:", e);
                    summaryDiv.innerHTML = '<p class="text-red-600">Lỗi khi tạo nhận xét tổng quan.</p>';
                    loader.classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                }
               
                const summaryForSheet = summaryDiv.innerText.substring(0, 200) + "...";
                return { overallFeedback: { summary: summaryForSheet } };
            }
            async function handleSubmit() {
                if (isSubmitted) return;
                isSubmitted = true;
                clearInterval(timerInterval);
                
                document.querySelectorAll('input, textarea').forEach(input => input.disabled = true);
                submitBtn.classList.add('hidden');
                postSubmitOptions.classList.remove('hidden');
                if (retriesLeft > 0) {
                    retryBtn.classList.remove('hidden');
                } else {
                    retryBtn.classList.add('hidden');
                }

                const proctoringDataString = JSON.stringify(proctoringLog);

                let totalStudentScore = 0;
                let totalCorrectAnswers = 0;
                let allAnswersData = [];
                const questionCounts = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    acc[type] = (acc[type] || 0) + 1;
                    return acc;
                }, {});
                
                quizData.forEach((item, index) => {
                    let questionNumber = index + 1;
                    let answerData = { questionNumber, type: item.type };
                    switch (item.mappedType) {
                        case 'multiple-choice':
                            const selectedOption = document.querySelector(`input[name="q${index}"]:checked`);
                            const isCorrectMC = selectedOption ? parseInt(selectedOption.value) === item.correctAnswerIndex : false;
                            if (isCorrectMC) {
                                totalCorrectAnswers++;
                                if (questionCounts['multiple-choice'] > 0) {
                                   totalStudentScore += quizOptions.scoring.mc / questionCounts['multiple-choice'];
                                }
                            }
                            answerData.question = item.question;
                            answerData.options = item.options;
                            answerData.yourAnswer = selectedOption ? String.fromCharCode(65 + parseInt(selectedOption.value)) : "Không trả lời";
                            answerData.correctAnswer = String.fromCharCode(65 + item.correctAnswerIndex);
                            answerData.isCorrect = isCorrectMC;
                            break;
                        case 'true-false':
                            let correctStatementsCount = 0;
                            let yourAnswerPattern = [];
                            let correctAnswerPattern = [];
                            let details = [];
                            item.statements.forEach((s, i) => {
                                const selectedTF = document.querySelector(`input[name="q${index}-s${i}"]:checked`);
                                const studentChoice = selectedTF ? selectedTF.value === 'true' : null;
                                const isStatementCorrect = studentChoice === s.is_correct;
                               
                                if (isStatementCorrect) correctStatementsCount++;
                               
                                yourAnswerPattern.push(studentChoice === null ? '?' : (studentChoice ? 'Đ' : 'S'));
                                correctAnswerPattern.push(s.is_correct ? 'Đ' : 'S');
                                details.push({ statement: s.statement, yourChoice: studentChoice === null ? 'Không trả lời' : (studentChoice ? 'Đúng' : 'Sai'), correctChoice: s.is_correct ? 'Đúng' : 'Sai', isCorrect: isStatementCorrect });
                            });
                            
                            let scorePerTfQuestion = 0;
                            if (questionCounts['true-false'] > 0) {
                                scorePerTfQuestion = quizOptions.scoring.tf / questionCounts['true-false'];
                            }
                            let questionPoints = 0;
                            if (quizOptions.scoring.tfMethod === 'progressive') {
                                const progressivePoints = { 0: 0, 1: 0.1, 2: 0.25, 3: 0.5, 4: 1.0 };
                                questionPoints = progressivePoints[correctStatementsCount] * scorePerTfQuestion;
                            } else { // even
                                questionPoints = (correctStatementsCount / 4) * scorePerTfQuestion;
                            }
                            totalStudentScore += questionPoints;

                            if(correctStatementsCount === 4) totalCorrectAnswers++;
                            answerData.question = item.main_question;
                            answerData.yourAnswer = yourAnswerPattern.join('-');
                            answerData.correctAnswer = correctAnswerPattern.join('-');
                            answerData.isCorrect = correctStatementsCount === 4;
                            answerData.details = details;
                            break;
                       
                        case 'short-answer':
                            const saInput = document.querySelector(`input[name="q${index}"]`);
                            const studentAnswerRaw = saInput ? (saInput.value ?? '').trim() : "";
                            const correctAnswerRaw = (item.answer ?? '').toString().trim().replace(/\$/g, '');
                            let isCorrectSA = false;
                            const studentAnswerNormalized = studentAnswerRaw.replace(',', '.');
                            const correctAnswerNormalized = correctAnswerRaw.replace(',', '.');
                            if (studentAnswerNormalized.toLowerCase() === correctAnswerNormalized.toLowerCase()) {
                                isCorrectSA = true;
                            }
                             if (isCorrectSA) {
                                totalCorrectAnswers++;
                                if (questionCounts['short-answer'] > 0) {
                                   totalStudentScore += quizOptions.scoring.sa / questionCounts['short-answer'];
                                }
                            }
                            answerData.question = item.question;
                            answerData.yourAnswer = studentAnswerRaw || "Không trả lời";
                            answerData.correctAnswer = correctAnswerRaw;
                            answerData.isCorrect = isCorrectSA;
                            break;
                           
                        case 'essay':
                             const essayInput = document.querySelector(`textarea[name="q${index}"]`);
                             answerData.question = item.question;
                             answerData.yourAnswer = essayInput.value || "Không trả lời";
                             answerData.correctAnswer = item.answer;
                             answerData.isCorrect = null; // Needs manual grading
                             break;
                    }
                    allAnswersData.push(answerData);
                });
                
                const finalScore = totalStudentScore;
                
                let competencyAssessment = "Giáo viên không yêu cầu AI phân tích bài làm.";
                if (quizOptions.aiAssessment) {
                    const feedbackData = await generatePerformanceReview(allAnswersData);
                    if (feedbackData && feedbackData.overallFeedback && feedbackData.overallFeedback.summary) {
                        competencyAssessment = feedbackData.overallFeedback.summary;
                    } else {
                        competencyAssessment = "Có lỗi xảy ra trong quá trình AI phân tích bài làm.";
                    }
                }
                
                if (quizOptions.showAnswers) {
                    const totalQuestions = quizData.length;
                    resultContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg text-center">
                        <h3 class="text-2xl font-bold text-slate-800">KẾT QUẢ BÀI LÀM</h3>
                        <p class="mt-4 text-lg">Số câu đúng hoàn toàn: <span class="font-bold text-green-600">${totalCorrectAnswers}/${totalQuestions}</span></p>
                        <p class="text-2xl mt-2">Điểm (thang 10): <span class="font-bold text-blue-600">${finalScore.toFixed(2)}</span></p>
                        ${questionCounts['essay'] > 0 ? `<p class="text-sm text-gray-600 italic mt-1">Lưu ý: Điểm trên chưa bao gồm ${quizOptions.scoring.essay} điểm của phần Tự luận.</p>` : ''}
                    </div>`;
                    resultContainer.classList.remove('hidden');

                    allAnswersData.forEach((ans, index) => {
                        const questionCard = document.getElementById(`student-q-${index}`);
                        const feedbackIconDiv = document.getElementById(`q-${index}-feedback-icon`);
                        const feedbackDiv = document.getElementById(`q-${index}-feedback`);
                        if (!questionCard || !feedbackIconDiv || !feedbackDiv) return;

                        const iconHTML = ans.isCorrect === true
                            ? '<svg class="feedback-icon text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>'
                            : (ans.isCorrect === false ? '<svg class="feedback-icon text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>' : '');
                        feedbackIconDiv.innerHTML = iconHTML;

                        if (ans.type.includes('multiple-choice')) {
                            const studentChoice = ans.yourAnswer === "Không trả lời" ? -1 : ans.yourAnswer.charCodeAt(0) - 65;
                            const correctChoice = ans.correctAnswer.charCodeAt(0) - 65;
                            document.getElementById(`q-${index}-opt-label${correctChoice}`)?.classList.add('correct');
                            if (studentChoice !== -1 && studentChoice !== correctChoice) {
                                document.getElementById(`q-${index}-opt-label${studentChoice}`)?.classList.add('incorrect');
                            }
                        } else if (ans.type === 'true-false') {
                            const statementItems = questionCard.querySelectorAll('.statement-item');
                            ans.details.forEach((detail, i) => { if(statementItems[i]) { statementItems[i].classList.add(detail.isCorrect ? 'correct' : 'incorrect'); }});
                        }

                        if (quizOptions.showExplanation) {
                            feedbackDiv.innerHTML = `<button data-explain-index="${index}" class="explain-btn mt-4 flex items-center px-4 py-2 bg-blue-100 text-blue-800 text-sm font-semibold rounded-lg hover:bg-blue-200 transition-colors">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Xem giải thích
                            </button>`;
                        }
                    });
                    
                    document.querySelectorAll('.explain-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const button = e.currentTarget;
                            const index = parseInt(button.dataset.explainIndex, 10);
                            showExplanation(index, button);
                        });
                    });

                    if (window.MathJax) await window.MathJax.typesetPromise([studentQuizContainer]);
                } else {
                     resultContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg text-center"><h3 class="text-xl font-bold text-green-600">Nộp bài thành công!</h3><p class="mt-2 text-slate-700">Bạn đã hoàn thành bài làm. Kết quả sẽ được giáo viên công bố sau.</p></div>`;
                    resultContainer.classList.remove('hidden');
                }
                
                const formData = new FormData();
                formData.append('name', studentInfo.name);
                formData.append('class', studentInfo.class);
                formData.append('score', `${finalScore.toFixed(2)}/10`);
                formData.append('assessment', competencyAssessment);
                formData.append('timestamp', new Date().toLocaleString('vi-VN'));
                formData.append('examCode', correctExamCode);
                formData.append('monitoringLog', proctoringDataString);
                formData.append('answerDetails', JSON.stringify(allAnswersData));
               
                fetch(googleScriptUrl, { method: 'POST', body: formData})
                    .then(res => console.log("Successfully submitted to Google Sheet"))
                    .catch(err => console.error("Error submitting to Google Sheet:", err));
            }
           
            function startNewAttempt() {
                isSubmitted = false;
                proctoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0, suKien: [] };
                const proctoringWidget = document.getElementById('proctoring-widget');
                if (proctoringWidget) {
                    proctoringWidget.classList.add('hidden');
                    document.getElementById('tab-switch-count').textContent = '0';
                    document.getElementById('copy-count').textContent = '0';
                    document.getElementById('paste-count').textContent = '0';
                }

                renderStudentQuiz();
                resultContainer.classList.add('hidden');
                document.getElementById('ai-feedback-container').classList.add('hidden');
                postSubmitOptions.classList.add('hidden');
                submitBtn.classList.remove('hidden');
                 if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                }
                retriesLeft--;
                retriesDisplay.textContent = `Lượt làm lại còn: ${retriesLeft}`;
                window.scrollTo(0, 0);
            }
            studentInfoForm.addEventListener('submit', (e) => {
                e.preventDefault();
               
                const enteredCode = document.getElementById('exam-code').value.trim().toUpperCase();
                if (correctExamCode && enteredCode !== correctExamCode) {
                    alert('Mã đề không chính xác. Vui lòng kiểm tra lại!');
                    return;
                }
               
                studentApiKey = teacherApiKey;
                if (!studentApiKey) {
                    console.warn('Cảnh báo: Giáo viên chưa cấu hình API Key. Các tính năng AI sẽ không hoạt động.');
                }
       
                try {
                    if (studentApiKey) {
                       ai = new GoogleGenAI({ apiKey: studentApiKey });
                    }
                } catch(e) {
                    console.error("Lỗi khởi tạo Gemini API với key của giáo viên.", e);
                    alert("Cảnh báo: API Key của giáo viên không hợp lệ. Vui lòng báo cho giáo viên. Các tính năng AI sẽ không hoạt động.");
                    ai = null;
                }
                shuffleQuiz();
               
                studentInfo.name = document.getElementById('student-name').value;
                studentInfo.class = document.getElementById('student-class').value;
                loginModal.classList.add('hidden');
                studentQuizContainer.classList.remove('hidden');
                submitBtn.classList.remove('hidden');
               
                if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                } else {
                    timerDisplay.textContent = "Không giới hạn";
                }
                retriesDisplay.textContent = `Lượt làm lại còn: ${retriesLeft}`;
                renderStudentQuiz();

                const proctoringWidget = document.getElementById('proctoring-widget');
                const tabSwitchCountEl = document.getElementById('tab-switch-count');
                const copyCountEl = document.getElementById('copy-count');
                const pasteCountEl = document.getElementById('paste-count');

                function updateProctoringUI() {
                    if (proctoringLog.thoatManHinh > 0 || proctoringLog.saoChep > 0 || proctoringLog.dan > 0) {
                        proctoringWidget.classList.remove('hidden');
                    }
                    tabSwitchCountEl.textContent = proctoringLog.thoatManHinh;
                    copyCountEl.textContent = proctoringLog.saoChep;
                    pasteCountEl.textContent = proctoringLog.dan;
                }

                // Disable Right Click
                document.addEventListener('contextmenu', e => e.preventDefault());

                // Track Tab Switching
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && !isSubmitted) {
                        proctoringLog.thoatManHinh++;
                        proctoringLog.suKien.push({ loai: 'chuyen_tab', thoiGian: new Date().toISOString() });
                        updateProctoringUI();
                    }
                });

                // Track Copying
                document.addEventListener('copy', () => {
                    if (isSubmitted) return;
                    proctoringLog.saoChep++;
                    proctoringLog.suKien.push({ loai: 'sao_chep', thoiGian: new Date().toISOString() });
                    updateProctoringUI();
                });

                // Track Pasting
                document.addEventListener('paste', () => {
                    if (isSubmitted) return;
                    proctoringLog.dan++;
                    proctoringLog.suKien.push({ loai: 'dan', thoiGian: new Date().toISOString() });
                    updateProctoringUI();
                });
            });
            
            submitBtn.addEventListener('click', handleSubmit);
            retryBtn.addEventListener('click', () => {
                shuffleQuiz();
                startNewAttempt();
            });
        </script>
    </body>
    </html>
    