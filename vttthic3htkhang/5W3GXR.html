
    <!DOCTYPE html>
    <html lang="vi">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ÔN TẬP GIỮA KỲ I</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
        <script>
            window.MathJax = {
                tex: {
                    packages: {'[+]': ['ams']},
                    inlineMath: [['$', '$'], ['\\(', '\\)']],
                    displayMath: [['$$', '$$'], ['\\[', '\\]']]
                },
                chtml: {
                    fontCache: 'global',
                    linebreaks: {
                        automatic: true
                    }
                }
            };
        </script>
        <script type="text/javascript" id="MathJax-script" async
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
        </script>
        <style>
            body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #f0f4f8; }
            .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
            @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
            .question-card {
                background-color: white;
                border-radius: 1rem;
                padding: 1.5rem 2rem;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                border-left: 5px solid transparent;
                transition: all 0.3s ease;
            }
            .ai-explanation {
                background-color: #f0f9ff;
                color: #0c4a6e;
                padding: 1rem;
                border-radius: 0.75rem;
                font-size: 0.9rem;
                margin-top: 1rem;
                border-left: 4px solid #38bdf8;
            }
            .feedback-icon { width: 1.5rem; height: 1.5rem; }
            .option-label {
                transition: all 0.2s ease-in-out;
                border: 2px solid #e5e7eb;
            }
            .option-label:hover {
                border-color: #6366f1;
                background-color: #eef2ff;
            }
            .option-label.correct {
                border-color: #10b981 !important;
                background-color: #ecfdf5 !important;
                color: #065f46;
            }
            .option-label.incorrect {
                border-color: #ef4444 !important;
                background-color: #fef2f2 !important;
                color: #991b1b;
            }
            .statement-item.correct { background-color: #ecfdf5; border-color: #10b981; }
            .statement-item.incorrect { background-color: #fef2f2; border-color: #ef4444; }
            .prose { max-width: 100%; }
            .prose h1, .prose h2, .prose h3 { font-weight: 600; }
            .prose p { margin-top: 0.5em; margin-bottom: 0.5em; }
            .prose ul, .prose ol { margin-top: 1em; margin-bottom: 1em; padding-left: 1.5em; }
            .prose li > p { margin-top: 0; margin-bottom: 0; }
            .prose code { background-color: #e5e7eb; padding: 0.2em 0.4em; margin: 0; font-size: 85%; border-radius: 3px; }
            .prose pre { background-color: #e5e7eb; padding: 1em; border-radius: 0.5em; overflow-x: auto; }
            .prose pre code { background-color: transparent; padding: 0; }
            details[open] > summary .details-arrow {
                transform: rotate(180deg);
            }
        </style>
    </head>
    <body class="bg-slate-100 text-slate-800">
        <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md transform transition-all" style="animation: fadeIn 0.3s ease-out;">
                <h2 class="text-2xl font-bold mb-2 text-center text-slate-800">Thông Tin Học Sinh</h2>
                <p class="text-center text-slate-500 mb-6">Vui lòng nhập để bắt đầu làm bài.</p>
                <form id="student-info-form">
                    <div class="mb-4">
                        <label for="student-name" class="block text-sm font-medium text-slate-700 mb-1">Họ và tên</label>
                        <input type="text" id="student-name" required class="mt-1 block w-full block border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="student-class" class="block text-sm font-medium text-slate-700 mb-1">Lớp</label>
                        <input type="text" id="student-class" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="exam-code" class="block text-sm font-medium text-slate-700 mb-1">Mã đề</label>
                        <input type="text" id="exam-code" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Nhập mã đề giáo viên cung cấp">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Giáo viên:</label>
                        <p class="mt-1 text-slate-800 bg-slate-100 p-2.5 rounded-lg">Võ Thị Thiên Thi</p>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">Bắt đầu làm bài</button>
                </form>
            </div>
        </div>
        <div class="container mx-auto p-4 md:p-8 max-w-4xl">
            <header class="mb-10 p-8 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg">
                <div class="flex justify-between items-center flex-wrap gap-4">
                    <div>
                        <h1 class="text-4xl font-bold">ÔN TẬP GIỮA KỲ I</h1>
                        <p class="text-lg text-blue-100 mt-2">Hãy hoàn thành các câu hỏi dưới đây một cách tốt nhất!</p>
                        <p class="text-sm text-blue-200 mt-4">Tác giả: Võ Thị Thiên Thi</p>
                    </div>
                    <div id="timer-container" class="text-right">
                         <div id="timer-display" class="text-3xl font-bold tracking-wider bg-white/20 px-4 py-2 rounded-lg">--:--</div>
                         <div id="retries-display" class="text-sm mt-1 text-blue-200"></div>
                    </div>
                </div>
            </header>
            <main id="student-quiz-container" class="space-y-8 hidden">
                <!-- Questions will be rendered here by JS -->
            </main>
            <footer class="mt-10 text-center">
                <button id="submit-quiz-btn" class="bg-indigo-600 text-white py-3 px-12 rounded-full font-bold text-lg hover:bg-indigo-700 transition-all duration-300 shadow-lg hover:shadow-xl hidden transform hover:scale-105">Nộp Bài</button>
                <div id="result-container" class="mt-6 hidden"></div>
                <div id="ai-feedback-container" class="mt-8 text-left hidden"></div>
                <div id="post-submit-options" class="hidden mt-6 flex flex-col sm:flex-row items-center justify-center gap-4">
                    <button id="retry-quiz-btn" class="w-full sm:w-auto bg-slate-600 text-white py-2.5 px-6 rounded-lg font-semibold hover:bg-slate-700 transition-transform transform hover:scale-105">Làm Lại Đề Này</button>
                </div>
            </footer>
        </div>

        <div id="proctoring-widget" class="fixed bottom-4 right-4 bg-yellow-100 text-yellow-800 p-3 rounded-lg shadow-lg text-sm z-50 hidden border border-yellow-300" style="max-width: 200px;">
            <h4 class="font-bold mb-2 border-b border-yellow-300 pb-1 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 3.001-1.742 3.001H4.42c-1.53 0-2.493-1.667-1.743-3.001l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                Giám sát
            </h4>
            <p>Thoát màn hình: <span id="tab-switch-count" class="font-bold">0</span></p>
            <p>Sao chép: <span id="copy-count" class="font-bold">0</span></p>
            <p>Dán: <span id="paste-count" class="font-bold">0</span></p>
        </div>

        <script type="module">
            import { GoogleGenAI, Type } from "https://esm.sh/@google/genai@^1.13.0";
            let quizData = [{"type":"multiple-choice","question":"Thông tin là gì?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Là dữ liệu chưa qua xử lý","Là hiểu biết thu nhận được từ dữ liệu","Là ký hiệu được thu nhập vào máy tính","Là phần mềm máy tính"],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Quá trình xử lý thông tin trong máy tính thường gồm:","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Nhập – Xử lý – Xuất","Lưu – Nhập – Xuất","Xử lý – Lưu – Xóa","Nhập – Xóa – Xuất"],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Ví dụ nào thể hiện rõ mối quan hệ giữa dữ liệu và thông tin?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Nhập điểm – Tính trung bình – xếp loại học lực","In báo cáo – lưu tệp – xóa dữ liệu","Soạn thảo văn bản – lưu tệp","Nghe nhạc – xem phim"],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Ví dụ nào sau đây là thiết bị thông minh?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Đồng hồ cơ","Bàn phím máy tính","Điện thoại thông minh","Máy bơm nước cơ học"],"optionsImage":[null,null,null,null],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Kiểu dữ liệu số nguyên được dùng để biểu diễn:","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Các giá trị logic","Các số không có phần thập phân","Các ký tự chữ cái","Các đoạn văn bản dài"],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Dữ liệu và thông tin khác nhau ở điểm nào?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Dữ liệu là thông tin đã được xử lý","Dữ liệu là các giá trị ban đầu, thông tin là kết quả sau xử lý dữ liệu","Dữ liệu và thông tin hoàn toàn giống nhau","Dữ liệu chỉ tồn tại trong máy tính"],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Trong quá trình mua hàng trực tuyến, dữ liệu khách nhập (tên, địa chỉ, sản phẩm chọn) thuộc giai đoạn nào?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Thu nhận thông tin","Xử lý thông tin","Lưu trữ thông tin","Truyền đạt thông tin"],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Dữ liệu số là dữ liệu gồm:","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Các chữ cái","Các giá trị số","Các biểu tượng","Các ký tự logic"],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Dữ liệu “Đúng / sai” trong bài kiểm tra trắc nghiệm được biểu diễn bằng kiểu dữ liệu:","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Ký tự","Văn bản","logic","Số thực"],"optionsImage":[null,null,null,null],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Đề lưu thông tin “Nam” hoặc “Nữ” của học sinh trong một hệ thống quản lý, kiểu dữ liệu nên chọn là:","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Chuỗi ký tự","Số nguyên","Số thực","Logic"],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Máy tính sử dụng hệ đếm nào để biểu diễn dữ liệu?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Hệ thập phân","Hệ nhị phân","Hệ bát phân","hệ thập lục phân"],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Hệ nhị phân có bao nhiêu chữ số?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["2","8","10","16"],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Dữ liệu logic là loại dữ liệu có thể nhận giá trị:","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Số nguyên hoặc số thực","Đúng hoặc sai","Chuỗi ký tự","Ngày – tháng – năm"],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Nếu biểu thức (x&gt;5) là True, điều này có nghĩa:","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["x nhỏ hơn 5","x bằng 5","x lớn hơn 5","x không xác định"],"optionsImage":[null,null,null,null],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Biểu thức NOT(x&gt;10) dùng để:","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Kiểm tra x lớn hơn 10","Kiểm tra x nhỏ hơn hoặc bằng 10","Cộng 10 vào x","Phủ định mọi giá trị"],"optionsImage":[null,null,null,null],"correctAnswerIndex":3},{"type":"multiple-choice","question":"Thiết bị nào dùng để kết nối máy tính với mạng Internet trong gia đình?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Loa","Bộ định tuyến (router)","Webcam","Máy quét"],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Điểm khác biệt chính giữa mạng LAN và mạng WAN là gì?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Tốc độ truyền dữ liệu","Phạm vi địa lý kết nối","Loại máy tính sử dụng","Hệ điều hành cài đặt"],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Một cá nhân sử dụng Google Drive để lưu tài liệu và chia sẻ với bạn bè. Nhược điểm có thể gặp là:","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Không thể truy cập từ nhiều thiết bị","Dễ bị mất dữ liệu nếu nhà cung cấp gặp sự cố","Phải đầu tư phần cứng lớn","Không thể chia sẻ"],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"1KB tương đương với khoảng”","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["1000 byte","1024 byte","100 byte","515 byte"],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Số 1101<sub>2</sub> tương ứng với số thập phân nào?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["12","13","14","15"],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Phép toán logic NOT có tác dụng:","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Giữ nguyên giá trị","Phủ định giá trị","Cộng hai giá trị logic","Nhân hai giá trị logic"],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Nếu A= True, B= False, thì A AND B có giá trị là","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["True","False","Không xác định","0"],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Cho biểu thức (a&gt;b) or (b&gt;c). Nếu a=5, b=7, c=10, giá trị biểu thức là:","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["True","False","Không xác định","0"],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Internet thuộc loại mạng nào?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Mạng cá nhân","Mạng nội bộ","Mạng diện rộng (WAN)","Mạng ngang hang"],"optionsImage":[null,null,null,null],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Điểm khác biệt chính giữa mạng LAN và mạng WAN là gì?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Tốc độ truyền dữ liệu","Phạm vi địa lý kết nối","Loại máy tính sử dụng","Hệ điều hành cài đặt"],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Trong trường hợp Internet bị gián đoạn, dịch vụ đám mây:","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Vẫn hoạt động bình thường","Người dùng có thể không truy cập được dữ liệu hoặc ứng dụng","Tăng tốc kết nối","Tự cài đặt offline"],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Hai chữ số được dùng trong hệ nhị phân là:","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["1 và 2","0 và 1","1 và 10","8 và 9"],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Để biểu diễn địa chỉ email của học sinh, kiểu dữ liệu phù hợp nhất là:","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Số nguyên","Chuỗi ký tự","Lôgic","Ngày – tháng – năm"],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Một câu chào “Xin chào các bạn!” là ví dụ của kiểu dữ liệu:","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Số thực","Văn bản","Logic","Số nguyên"],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Dữ liệu logic chỉ có thể nhận:","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Hai giá trị Đúng hoặc Sai","Các giá trị từ 0 đến 9","Các ký tự chữ cái","Các giá trị ngẫu nhiên"],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Mối quan hệ giữa dữ liệu và thông tin trong thiết bị thông minh là gì?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Thông tin tạo ra dữ liệu","Dữ liệu được thu nhận và xử lý để tạo ra thông tin có ý nghĩa","Dữ liệu và thông tin không liên quan","Dữ liệu là kết quả của xử lý thông tin"],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Dữ liệu văn bản thuộc loại dữ liệu nào?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Số học","Chuỗi ký tự","Dữ liệu logic","Dữ liệu tệp"],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Thiết bị thông minh có khả năng nào?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Tự thu thập và xử lý dữ liệu","Chỉ lưu trữ thông tin","Không thể kết nối mạng","Chỉ làm một chức năng duy nhất"],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Trong máy tính, dữ liệu và thông tin liên hệ với nhau qua:","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Quá trình xử lý","Quá trình in ấn","Phần mềm diệt virus","Cổng mạng"],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Dữ liệu là gì?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Là các con số, ký hiệu, âm thanh, hình ảnh chưa được xử lý","Là thông tin đã được xử lí","Là phần cứng của máy tính","Là chương trình xử lý thông tin"],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Trong quá trình xử lý thông tin, dữ liệu được nhập vào thông qua:","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Thiết bị đầu vào","Thiết bị đầu ra","Bộ xử lý trung tâm","Bộ nhớ ngoài"],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Biểu thức NOT((x&gt;=10) AND (y&lt;5)) với x=12, y=3 có giá trị:","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["True","False","12","3"],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Trong biểu thức NOT(x&gt;y), kết quả True xảy ra khi:","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["x lớn hơn y","x nhỏ hơn hoăc bằng y","x bằng y","Không xác định"],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Phép toán AND chỉ cho kết quả Đúng khi:","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Cả hai giá trị đều Sai","Cả hai giá trị đều Đúng","Môt giá trị Đúng, một giá trị Sai","Bất kỳ giá trị nào"],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Giá trị nào không hợp lệ trong hệ nhị phân?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["11000","1100","1002","11111111"],"optionsImage":[null,null,null,null],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Trong máy tính, dữ liệu kiểu ký tự được lưu trữ dựa trên:","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Bảng mã ký tự (ASCII, Unicode)","Bảng tính Excel","Tệp hình ảnh","Mã màu"],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Dữ liệu kiểu kí tự dùng để biểu diễn:","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Các chữ cái, chữ số, ký hiệu","Các đoạn văn bản dài","Các giá trị logic","Các phép toán toán học"],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Dữ liệu sau khi được xử lí trở thành:","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Thông tin","Ký tự","Số liệu","Tệp tin"],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Khi bạn dung máy tính để tính toán, máy đang thực hiện:","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Xử lí thông tin","Lưu trữ thông tin","Trao đổi thông tin","Nhập thông tin"],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Thông tin có vai trò quan trọng vì:","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Giúp con người hiểu biết và ra quyết định đúng đắn","Làm giảm nhu cầu học tập","Chỉ có ích trong sản xuất","Không cần thiết trong học tập"],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Một byte bằng bao nhiêu bit","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["1","2","8","1024"],"optionsImage":[null,null,null,null],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Hoạt động nào sau đây là xử lí thông tin?","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Nhìn thấy biển báo giao thông","Ghi chép lại kết quả đo nhiệt độ","Tính trung bình cộng điểm kiểm tra","Gửi tin nhắn cho bạn"],"optionsImage":[null,null,null,null],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Trong hệ thống xử lý thông tin, dữ liệu đầu vào là:","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Dữ liệu ban đầu được đưa vào hệ thống","Kết quả xử lí","Lệnh điều khiển","Thiết bị đầu vào"],"optionsImage":[null,null,null,null],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Dữ liệu số thực được dung để lưu trữ","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Số nguyên","Số có phần thập phân","Số nguyên có dấu","Kiểu logic"],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Một hệ thống lưu trữ trạng thái “Đi học bài” hoặc “Đi ngủ”. kiểu dữ liệu phù hợp nhất là:","main_question":null,"questionImage":null,"mappedType":"multiple-choice","options":["Logic","Chuỗi ký tự","Số nguyên","Số thực"],"optionsImage":[null,null,null,null],"correctAnswerIndex":1},{"type":"true-false","question":null,"main_question":"Xử lý thông tin trong máy tính có đặc điểm:","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Thực hiện bằng các phép toán logic và số học","is_correct":true},{"statement":"Luôn do con người trực tiếp thực hiện","is_correct":false},{"statement":"Có thể thực hiện nhanh và chính xác","is_correct":true},{"statement":"Không cần dữ liệu đầu vào","is_correct":false}]},{"type":"true-false","question":null,"main_question":") Thiết bị thông minh là gì?","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Là thiết bị có thể tự động thu thập, xử lý thông tin.","is_correct":false},{"statement":"Là thiết bị chỉ hoạt động khi có người điều khiển","is_correct":false},{"statement":"Có khả năng kết nối và giao tiếp với các thiết bị khác","is_correct":true},{"statement":"Chỉ dùng trong nghiên cứu khoa học","is_correct":false}]},{"type":"true-false","question":null,"main_question":"Mạng máy tính có vai trò quan trọng trong đời sống hiện đại. Em hãy xác định các nhận định sau là đúng hay sai:","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Mạng máy tính giúp chia sẻ tài nguyên và thông tin nhanh chóng giữa các thiết bị.","is_correct":true},{"statement":"Mạng máy tính chỉ được sử dụng trong các cơ quan nhà nước, không có trong gia đình.","is_correct":false},{"statement":"Mạng máy tính giúp con người giao tiếp, học tập và làm việc trực tuyến thuận tiện hơn","is_correct":true},{"statement":"Mạng máy tính không liên quan đến các dịch vụ như thương mại điện tử hay mạng xã hội.","is_correct":false}]},{"type":"true-false","question":null,"main_question":"Mạng máy tính mang lại nhiều lợi ích trong đời sống hằng ngày. Hãy cho biết các phát biểu sau là đúng hay sai:","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Mạng máy tính giúp chia sẻ thông tin nhanh chóng giữa các thiết bị.","is_correct":true},{"statement":"Mạng máy tính chỉ dung trong lĩnh vực quân sự","is_correct":false},{"statement":"Mạng máy tính giúp tiết kiệm thời gian và chi phí liên lạc","is_correct":true},{"statement":"Mạng máy tính làm cho mọi hoạt động của con người đều an toàn tuyệt đối","is_correct":false}]},{"type":"true-false","question":null,"main_question":"Trong hệ thống điều khiển tự động đèn giao thông:","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Cảm biến phát hiện xe là thu thập thông tin","is_correct":false},{"statement":"Bộ điều khiển thay đổi đèn là xử lý thông tin","is_correct":true},{"statement":"Đèn sang đỏ, xanh là xuất thông tin","is_correct":true},{"statement":"Lưu màu đèn vào bộ nhớ là truyền thông tin","is_correct":false}]},{"type":"true-false","question":null,"main_question":"Trong giao thông, thiết bị thông minh giúp:","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Quản lý đèn giao thông tự động","is_correct":true},{"statement":"Tăng tai nạn do lỗi phần mềm","is_correct":false},{"statement":"Ghi hình, phát hiện vi phạm giao thông","is_correct":true},{"statement":"Không ứng dụng được trong thành phố.","is_correct":false}]},{"type":"true-false","question":null,"main_question":"Trong ví dụ “máy tính tính điểm trung bình của học sinh”:","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Điểm từng môn là dữ liệu đầu vào","is_correct":true},{"statement":"Kết quả điểm trung bình là dữ liệu đầu ra","is_correct":true},{"statement":"Quá trình tính toán là xử lí thông tin","is_correct":true},{"statement":"Môn học là phần xuất thông tin","is_correct":false}]},{"type":"true-false","question":null,"main_question":"Trong nhà thông minh:","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Có thể điều khiển thiết bị qua điện thoại hoặc giọng nói","is_correct":true},{"statement":"Chỉ hoạt động khi có người ở nhà","is_correct":false},{"statement":"Có thể tự động bật/ tắt đèn, máy lạnh","is_correct":false},{"statement":"Không cần kết nối internet","is_correct":false}]},{"type":"true-false","question":null,"main_question":"Hoạt động nào sau đây thuộc về “xử lí thông tin”?","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Tính toán trên bảng dữ liệu","is_correct":true},{"statement":"Ghi chép thông tin từ thực tế","is_correct":false},{"statement":"Vẽ biểu đồ dựa trên số liệu","is_correct":true},{"statement":"In báo cáo từ máy tính","is_correct":false}]}];
            const quizOptions = {"timeLimit":50,"retriesAllowed":1,"showAnswers":true,"showExplanation":true,"aiAssessment":true,"scoring":{"mc":6,"tf":4,"sa":0,"essay":0,"tfMethod":"progressive"}};
            const googleScriptUrl = "https://script.google.com/macros/s/AKfycbzgfv8iwIJnabzKaOxDkhJQH9Wlp2WLplkF4pnRbjvyZcaVc8azeqhjsXbaeAQjSc02hg/exec";
            const correctExamCode = "5W3GXR";
            const teacherApiKey = "AIzaSyCc0Ky_zMx7FmbI1_tgCIfMYi_TH9BNBrM";
            let studentInfo = {};
            let isSubmitted = false;
            let timerInterval;
            let retriesLeft = quizOptions.retriesAllowed;
            let studentApiKey = "";
            let ai = null;

            let proctoringLog = {
                thoatManHinh: 0,
                saoChep: 0,
                dan: 0,
                suKien: []
            };

            const studentQuizContainer = document.getElementById('student-quiz-container');
            const submitBtn = document.getElementById('submit-quiz-btn');
            const resultContainer = document.getElementById('result-container');
            const postSubmitOptions = document.getElementById('post-submit-options');
            const retryBtn = document.getElementById('retry-quiz-btn');
            const loginModal = document.getElementById('login-modal');
            const studentInfoForm = document.getElementById('student-info-form');
            const timerDisplay = document.getElementById('timer-display');
            const retriesDisplay = document.getElementById('retries-display');

            function formatAIText(text) {
                if (!text) return '';
                let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                formattedText = formattedText.replace(/\n/g, '<br>');
                return formattedText;
            }

            function shuffleQuiz() {
                // Shuffle options/statements within each question first
                quizData.forEach(item => {
                    // Shuffle multiple-choice options and their corresponding images
                    if (item.mappedType === 'multiple-choice' && item.options && item.options.length > 0) {
                        const correctAnswerText = item.options[item.correctAnswerIndex];
                        let optionsWithImages = item.options.map((opt, index) => ({
                            text: opt,
                            image: (item.optionsImage && item.optionsImage[index]) ? item.optionsImage[index] : null
                        }));
                        // Fisher-Yates shuffle
                        for (let i = optionsWithImages.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [optionsWithImages[i], optionsWithImages[j]] = [optionsWithImages[j], optionsWithImages[i]];
                        }
                        // Update the item with shuffled data
                        item.options = optionsWithImages.map(opt => opt.text);
                        item.optionsImage = optionsWithImages.map(opt => opt.image);
                        item.correctAnswerIndex = item.options.indexOf(correctAnswerText);
                    }
                    // Shuffle true-false statements
                    if (item.mappedType === 'true-false' && item.statements && item.statements.length > 0) {
                         for (let i = item.statements.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [item.statements[i], item.statements[j]] = [item.statements[j], item.statements[i]];
                        }
                    }
                });
                // Then, group questions by type and shuffle within each group
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});
                let shuffledQuizData = [];
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    if (grouped[partType]) {
                        const partQuestions = grouped[partType];
                        for (let i = partQuestions.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [partQuestions[i], partQuestions[j]] = [partQuestions[j], partQuestions[i]];
                        }
                        shuffledQuizData = shuffledQuizData.concat(partQuestions);
                    }
                });
               
                quizData = shuffledQuizData;
            }
            // --- Timer Function ---
            function startTimer(duration, display) {
                let timer = duration, minutes, seconds;
                clearInterval(timerInterval); // Clear any existing timer
                if(duration <= 0) {
                     display.textContent = "∞";
                     return;
                }
                timerInterval = setInterval(function () {
                    minutes = parseInt(timer / 60, 10);
                    seconds = parseInt(timer % 60, 10);
                    minutes = minutes < 10 ? "0" + minutes : minutes;
                    seconds = seconds < 10 ? "0" + seconds : seconds;
                    display.textContent = minutes + ":" + seconds;
                    if (--timer < 0) {
                        clearInterval(timerInterval);
                        alert("Hết giờ làm bài!");
                        handleSubmit();
                    }
                }, 1000);
            }
            
            async function showExplanation(index, button) {
                const item = quizData[index];
                const questionCard = document.getElementById(`student-q-${index}`);
                const feedbackDiv = document.getElementById(`q-${index}-feedback`);
                if (!questionCard || !feedbackDiv) return;

                const existingExplanation = feedbackDiv.querySelector('.ai-explanation');
                if (existingExplanation) {
                    existingExplanation.remove();
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Xem giải thích
                    `;
                    return;
                }

                button.disabled = true;
                button.innerHTML = '<div class="loader mr-2"></div> Đang tải...';

                if (item.explanation) {
                    displayExplanation(item.explanation, feedbackDiv, button);
                    return;
                }

                if (!ai) {
                    alert("Tính năng giải thích yêu cầu API Key, nhưng chưa được cấu hình bởi giáo viên.");
                    button.disabled = false;
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Xem giải thích
                    `;
                    return;
                }

                const questionText = item.question || item.main_question;
                let prompt = `Bạn là một trợ lý giáo viên AI, am hiểu sâu sắc Chương trình GDPT 2018. Hãy cung cấp một lời giải chi tiết, từng bước một cho câu hỏi sau đây. Lời giải phải chính xác, dễ hiểu và phù hợp với phương pháp giảng dạy của chương trình học, TUYỆT ĐỐI KHÔNG sử dụng kiến thức của lớp cao hơn để giải thích.\n\n--- CÂU HỎI ---\n${questionText}\n\n`;
                if (item.mappedType === 'multiple-choice') {
                    prompt += `--- CÁC LỰA CHỌN ---\n${item.options.map((opt, i) => `${String.fromCharCode(65 + i)}. ${opt}`).join('\n')}\n\n`;
                    prompt += `--- ĐÁP ÁN ĐÚNG ---\n${String.fromCharCode(65 + item.correctAnswerIndex)}. ${item.options[item.correctAnswerIndex]}`;
                } else if (item.mappedType === 'true-false') {
                    prompt += `--- CÁC MỆNH ĐỀ & ĐÁP ÁN ---\n${item.statements.map(s => ` - ${s.statement} -> ${s.is_correct ? 'Đúng' : 'Sai'}`).join('\n')}`;
                } else {
                    prompt += `--- ĐÁP ÁN / GỢI Ý ---\n${item.answer}`;
                }
                prompt += `\n\n--- YÊU CẦU ---\nGiải thích rõ ràng tại sao đáp án lại đúng, từng bước một. Dùng **...** để in đậm các thuật ngữ quan trọng. Định dạng tất cả các công thức toán học bằng LaTeX.`;

                try {
                    const response = await ai.models.generateContent({ model: "gemini-2.5-flash", contents: prompt });
                    const explanationText = response.text; // Keep it raw
                    item.explanation = explanationText; // Cache it
                    displayExplanation(explanationText, feedbackDiv, button);
                } catch (error) {
                    console.error("Lỗi khi tạo giải thích:", error);
                    feedbackDiv.insertAdjacentHTML('beforeend', '<div class="ai-explanation text-red-600">Lỗi: Không thể tạo giải thích.</div>');
                    button.disabled = false;
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Thử lại
                    `;
                }
            }

            function displayExplanation(explanationText, container, button) {
                container.insertAdjacentHTML('beforeend', `<div class="ai-explanation prose prose-sm">${formatAIText(explanationText)}</div>`);
                if (window.MathJax) MathJax.typesetPromise([container]);
                button.disabled = false;
                button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    Ẩn giải thích
                `;
            }
           
            function renderStudentQuiz() {
                studentQuizContainer.innerHTML = '';
               
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});
                const groupInfo = {
                    'multiple-choice': { title: 'PHẦN I. TRẮC NGHIỆM KHÁCH QUAN', subtitle: 'Chọn đáp án đúng nhất trong các lựa chọn sau.' },
                    'true-false': { title: 'PHẦN II. CÂU HỎI ĐÚNG - SAI', subtitle: 'Xác định tính đúng hoặc sai cho mỗi mệnh đề dưới đây.' },
                    'short-answer': { title: 'PHẦN III. CÂU HỎI TRẢ LỜI NGẮN', subtitle: 'Điền đáp án ngắn gọn vào phần trả lời.' },
                    'essay': { title: 'PHẦN IV. CÂU HỎI TỰ LUẬN', subtitle: 'Trình bày chi tiết bài giải của bạn.' }
                };
               
                let questionCounter = 0;
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    const questions = grouped[partType];
                    if (!questions || questions.length === 0) return;
                   
                    let groupHTML = `<div class="group-container space-y-8 mb-12">`;
                    const info = groupInfo[partType];
                    groupHTML += `
                        <div class="group-header pb-3 border-b-2 border-slate-300 mb-6">
                            <h2 class="text-2xl font-bold text-slate-800">${info.title}</h2>
                            ${info.subtitle ? `<p class="text-md text-slate-600 italic mt-1">${info.subtitle}</p>` : ''}
                        </div>
                    `;
                    questions.forEach((item, localIndex) => {
                        const globalIndex = quizData.indexOf(item);
                        questionCounter++;
                        groupHTML += `<div class="question-card" id="student-q-${globalIndex}">`;
                        let questionText = (item.question || item.main_question || '').replace(/\n/g, '<br>');
                       
                        groupHTML += `<div class="flex items-start">
                                     <div class="flex-grow">
                                         <div class="flex items-center mb-2">
                                             <span class="font-bold text-lg mr-3 text-indigo-600">Câu ${questionCounter}:</span>
                                             <div id="q-${globalIndex}-feedback-icon"></div>
                                         </div>
                                         <div class="question-content mt-2 text-lg text-slate-700">${questionText}</div>
                                         ${item.questionImage ? `<img src="${item.questionImage}" class="mt-4 rounded-lg max-w-full md:max-w-md border shadow-sm">` : ''}
                                     </div>
                                 </div>`;
                       
                        groupHTML += `<div class="mt-6">`;
                        switch(item.mappedType) {
                            case 'multiple-choice':
                                groupHTML += `<div class="options-grid grid grid-cols-1 md:grid-cols-2 gap-4">`;
                                item.options.forEach((opt, i) => {
                                    groupHTML += `<label for="q${globalIndex}-opt${i}" id="q${globalIndex}-opt-label${i}" class="option-label flex items-start p-4 border-2 rounded-xl cursor-pointer hover:bg-indigo-50 hover:border-indigo-400">
                                                     <input type="radio" name="q${globalIndex}" id="q${globalIndex}-opt${i}" value="${i}" class="flex-shrink-0 mt-1 h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                                     <div class="ml-3 flex-grow">
                                                         <span class="font-semibold text-slate-800">${String.fromCharCode(65 + i)}.</span>
                                                         <span class="option-content text-slate-700">${opt || ''}</span>
                                                         ${(item.optionsImage && item.optionsImage[i]) ? `<img src="${item.optionsImage[i]}" class="mt-2 rounded-lg max-w-xs border shadow-sm">` : ''}
                                                     </div>
                                                 </label>`;
                                });
                                groupHTML += `</div>`;
                                break;
                            case 'true-false':
                                 groupHTML += `<div class="space-y-4">`;
                                 item.statements.forEach((s, i) => {
                                     groupHTML += `<div class="statement-item border-t pt-4">
                                                  <p class="mb-3 text-slate-700">${String.fromCharCode(97 + i)}) ${s.statement || ''}</p>
                                                  <div class="flex gap-x-6">
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="true" class="mr-2 h-4 w-4"> Đúng</label>
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="false" class="mr-2 h-4 w-4"> Sai</label>
                                                  </div>
                                              </div>`;
                                 });
                                 groupHTML += `</div>`;
                                 break;
                            case 'short-answer':
                                groupHTML += `<input type="text" name="q${globalIndex}" class="mt-1 block w-full md:w-1/2 border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Nhập đáp án của bạn...">`;
                                break;
                            case 'essay':
                                groupHTML += `<textarea name="q${globalIndex}" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" rows="5" placeholder="Nhập câu trả lời tự luận của bạn..."></textarea>`;
                                break;
                        }
                        groupHTML += `</div><div id="q-${globalIndex}-feedback" class="mt-4"></div></div>`;
                    });
                    groupHTML += `</div>`;
                    studentQuizContainer.innerHTML += groupHTML;
                });
               
                if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                    MathJax.typesetPromise([studentQuizContainer]);
                }
            }
           
            async function generatePerformanceReview(allAnswersData) {
                const feedbackContainer = document.getElementById('ai-feedback-container');
                if (!feedbackContainer || !ai) return null;
                feedbackContainer.classList.remove('hidden');
                feedbackContainer.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-slate-800 mb-4">📝 Phân Tích & Gợi Ý Từ Trợ Lý AI</h3>
                        <div id="ai-feedback-loader" class="text-center py-6">
                            <svg class="animate-spin mx-auto h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p class="mt-3 text-slate-600">AI đang phân tích bài làm của bạn...</p>
                        </div>
                        <div id="ai-feedback-summary" class="hidden prose prose-sm max-w-none"></div>
                        <div id="ai-feedback-details" class="hidden mt-4 space-y-2"></div>
                    </div>
                `;
               
                const loader = document.getElementById('ai-feedback-loader');
                const summaryDiv = document.getElementById('ai-feedback-summary');
                const detailsDiv = document.getElementById('ai-feedback-details');
                const incorrectAnswers = allAnswersData.filter(a => !a.isCorrect);
                if (incorrectAnswers.length === 0) {
                    feedbackContainer.innerHTML = `
                        <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                            <h3 class="text-xl font-bold text-green-600">🎉 Chúc mừng!</h3>
                            <p class="mt-2 text-slate-700">Bạn đã trả lời đúng tất cả các câu hỏi. Làm tốt lắm!</p>
                        </div>
                    `;
                    return { overallFeedback: { summary: "Xuất sắc! Học sinh đã đã trả lời đúng tất cả các câu hỏi." } };
                }
                const summaryPrompt = `Bạn là một trợ lý giáo viên, nói tiếng Việt. Dựa vào tóm tắt các câu trả lời sai của học sinh, hãy đưa ra một nhận xét tổng quan ngắn gọn (khoảng 3-4 câu) về năng lực của học sinh, bao gồm điểm mạnh (suy luận từ các câu làm đúng), điểm yếu (dựa trên các câu sai) và một vài gợi ý ôn tập chung. Lời văn phải khích lệ, rõ ràng. Dùng **...** để in đậm các thuật ngữ quan trọng.
                Tóm tắt lỗi sai:
                ${JSON.stringify(incorrectAnswers.map(a => ({ cau: a.questionNumber, loai: a.type, cauHoi: a.question.substring(0, 50) + '...' })), null, 2)}`;
                try {
                    const response = await ai.models.generateContent({
                        model: "gemini-2.5-flash",
                        contents: summaryPrompt
                    });
                    summaryDiv.innerHTML = formatAIText(response.text);
                    loader.classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                    detailsDiv.classList.remove('hidden'); 
                } catch (e) {
                    console.error("Lỗi khi lấy nhận xét tổng quan:", e);
                    summaryDiv.innerHTML = '<p class="text-red-600">Lỗi khi tạo nhận xét tổng quan.</p>';
                    loader.classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                }
               
                const summaryForSheet = summaryDiv.innerText.substring(0, 200) + "...";
                return { overallFeedback: { summary: summaryForSheet } };
            }
            async function handleSubmit() {
                if (isSubmitted) return;
                isSubmitted = true;
                clearInterval(timerInterval);
                
                document.querySelectorAll('input, textarea').forEach(input => input.disabled = true);
                submitBtn.classList.add('hidden');
                postSubmitOptions.classList.remove('hidden');
                if (retriesLeft > 0) {
                    retryBtn.classList.remove('hidden');
                } else {
                    retryBtn.classList.add('hidden');
                }

                const proctoringDataString = JSON.stringify(proctoringLog);

                let totalStudentScore = 0;
                let totalCorrectAnswers = 0;
                let allAnswersData = [];
                const questionCounts = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    acc[type] = (acc[type] || 0) + 1;
                    return acc;
                }, {});
                
                quizData.forEach((item, index) => {
                    let questionNumber = index + 1;
                    let answerData = { questionNumber, type: item.type };
                    switch (item.mappedType) {
                        case 'multiple-choice':
                            const selectedOption = document.querySelector(`input[name="q${index}"]:checked`);
                            const isCorrectMC = selectedOption ? parseInt(selectedOption.value) === item.correctAnswerIndex : false;
                            if (isCorrectMC) {
                                totalCorrectAnswers++;
                                if (questionCounts['multiple-choice'] > 0) {
                                   totalStudentScore += quizOptions.scoring.mc / questionCounts['multiple-choice'];
                                }
                            }
                            answerData.question = item.question;
                            answerData.options = item.options;
                            answerData.yourAnswer = selectedOption ? String.fromCharCode(65 + parseInt(selectedOption.value)) : "Không trả lời";
                            answerData.correctAnswer = String.fromCharCode(65 + item.correctAnswerIndex);
                            answerData.isCorrect = isCorrectMC;
                            break;
                        case 'true-false':
                            let correctStatementsCount = 0;
                            let yourAnswerPattern = [];
                            let correctAnswerPattern = [];
                            let details = [];
                            item.statements.forEach((s, i) => {
                                const selectedTF = document.querySelector(`input[name="q${index}-s${i}"]:checked`);
                                const studentChoice = selectedTF ? selectedTF.value === 'true' : null;
                                const isStatementCorrect = studentChoice === s.is_correct;
                               
                                if (isStatementCorrect) correctStatementsCount++;
                               
                                yourAnswerPattern.push(studentChoice === null ? '?' : (studentChoice ? 'Đ' : 'S'));
                                correctAnswerPattern.push(s.is_correct ? 'Đ' : 'S');
                                details.push({ statement: s.statement, yourChoice: studentChoice === null ? 'Không trả lời' : (studentChoice ? 'Đúng' : 'Sai'), correctChoice: s.is_correct ? 'Đúng' : 'Sai', isCorrect: isStatementCorrect });
                            });
                            
                            let scorePerTfQuestion = 0;
                            if (questionCounts['true-false'] > 0) {
                                scorePerTfQuestion = quizOptions.scoring.tf / questionCounts['true-false'];
                            }
                            let questionPoints = 0;
                            if (quizOptions.scoring.tfMethod === 'progressive') {
                                const progressivePoints = { 0: 0, 1: 0.1, 2: 0.25, 3: 0.5, 4: 1.0 };
                                questionPoints = progressivePoints[correctStatementsCount] * scorePerTfQuestion;
                            } else { // even
                                questionPoints = (correctStatementsCount / 4) * scorePerTfQuestion;
                            }
                            totalStudentScore += questionPoints;

                            if(correctStatementsCount === 4) totalCorrectAnswers++;
                            answerData.question = item.main_question;
                            answerData.yourAnswer = yourAnswerPattern.join('-');
                            answerData.correctAnswer = correctAnswerPattern.join('-');
                            answerData.isCorrect = correctStatementsCount === 4;
                            answerData.details = details;
                            break;
                       
                        case 'short-answer':
                            const saInput = document.querySelector(`input[name="q${index}"]`);
                            const studentAnswerRaw = saInput ? (saInput.value ?? '').trim() : "";
                            const correctAnswerRaw = (item.answer ?? '').toString().trim().replace(/\$/g, '');
                            let isCorrectSA = false;
                            const studentAnswerNormalized = studentAnswerRaw.replace(',', '.');
                            const correctAnswerNormalized = correctAnswerRaw.replace(',', '.');
                            if (studentAnswerNormalized.toLowerCase() === correctAnswerNormalized.toLowerCase()) {
                                isCorrectSA = true;
                            }
                             if (isCorrectSA) {
                                totalCorrectAnswers++;
                                if (questionCounts['short-answer'] > 0) {
                                   totalStudentScore += quizOptions.scoring.sa / questionCounts['short-answer'];
                                }
                            }
                            answerData.question = item.question;
                            answerData.yourAnswer = studentAnswerRaw || "Không trả lời";
                            answerData.correctAnswer = correctAnswerRaw;
                            answerData.isCorrect = isCorrectSA;
                            break;
                           
                        case 'essay':
                             const essayInput = document.querySelector(`textarea[name="q${index}"]`);
                             answerData.question = item.question;
                             answerData.yourAnswer = essayInput.value || "Không trả lời";
                             answerData.correctAnswer = item.answer;
                             answerData.isCorrect = null; // Needs manual grading
                             break;
                    }
                    allAnswersData.push(answerData);
                });
                
                const finalScore = totalStudentScore;
                
                let competencyAssessment = "Giáo viên không yêu cầu AI phân tích bài làm.";
                if (quizOptions.aiAssessment) {
                    const feedbackData = await generatePerformanceReview(allAnswersData);
                    if (feedbackData && feedbackData.overallFeedback && feedbackData.overallFeedback.summary) {
                        competencyAssessment = feedbackData.overallFeedback.summary;
                    } else {
                        competencyAssessment = "Có lỗi xảy ra trong quá trình AI phân tích bài làm.";
                    }
                }
                
                if (quizOptions.showAnswers) {
                    const totalQuestions = quizData.length;
                    resultContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg text-center">
                        <h3 class="text-2xl font-bold text-slate-800">KẾT QUẢ BÀI LÀM</h3>
                        <p class="mt-4 text-lg">Số câu đúng hoàn toàn: <span class="font-bold text-green-600">${totalCorrectAnswers}/${totalQuestions}</span></p>
                        <p class="text-2xl mt-2">Điểm (thang 10): <span class="font-bold text-blue-600">${finalScore.toFixed(2)}</span></p>
                        ${questionCounts['essay'] > 0 ? `<p class="text-sm text-gray-600 italic mt-1">Lưu ý: Điểm trên chưa bao gồm ${quizOptions.scoring.essay} điểm của phần Tự luận.</p>` : ''}
                    </div>`;
                    resultContainer.classList.remove('hidden');

                    allAnswersData.forEach((ans, index) => {
                        const questionCard = document.getElementById(`student-q-${index}`);
                        const feedbackIconDiv = document.getElementById(`q-${index}-feedback-icon`);
                        const feedbackDiv = document.getElementById(`q-${index}-feedback`);
                        if (!questionCard || !feedbackIconDiv || !feedbackDiv) return;

                        const iconHTML = ans.isCorrect === true
                            ? '<svg class="feedback-icon text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>'
                            : (ans.isCorrect === false ? '<svg class="feedback-icon text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>' : '');
                        feedbackIconDiv.innerHTML = iconHTML;

                        if (ans.type.includes('multiple-choice')) {
                            const studentChoice = ans.yourAnswer === "Không trả lời" ? -1 : ans.yourAnswer.charCodeAt(0) - 65;
                            const correctChoice = ans.correctAnswer.charCodeAt(0) - 65;
                            document.getElementById(`q-${index}-opt-label${correctChoice}`)?.classList.add('correct');
                            if (studentChoice !== -1 && studentChoice !== correctChoice) {
                                document.getElementById(`q-${index}-opt-label${studentChoice}`)?.classList.add('incorrect');
                            }
                        } else if (ans.type === 'true-false') {
                            const statementItems = questionCard.querySelectorAll('.statement-item');
                            ans.details.forEach((detail, i) => { if(statementItems[i]) { statementItems[i].classList.add(detail.isCorrect ? 'correct' : 'incorrect'); }});
                        }

                        if (quizOptions.showExplanation) {
                            feedbackDiv.innerHTML = `<button data-explain-index="${index}" class="explain-btn mt-4 flex items-center px-4 py-2 bg-blue-100 text-blue-800 text-sm font-semibold rounded-lg hover:bg-blue-200 transition-colors">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Xem giải thích
                            </button>`;
                        }
                    });
                    
                    document.querySelectorAll('.explain-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const button = e.currentTarget;
                            const index = parseInt(button.dataset.explainIndex, 10);
                            showExplanation(index, button);
                        });
                    });

                    if (window.MathJax) await window.MathJax.typesetPromise([studentQuizContainer]);
                } else {
                     resultContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg text-center"><h3 class="text-xl font-bold text-green-600">Nộp bài thành công!</h3><p class="mt-2 text-slate-700">Bạn đã hoàn thành bài làm. Kết quả sẽ được giáo viên công bố sau.</p></div>`;
                    resultContainer.classList.remove('hidden');
                }
                
                const formData = new FormData();
                formData.append('name', studentInfo.name);
                formData.append('class', studentInfo.class);
                formData.append('score', `${finalScore.toFixed(2)}/10`);
                formData.append('assessment', competencyAssessment);
                formData.append('timestamp', new Date().toLocaleString('vi-VN'));
                formData.append('examCode', correctExamCode);
                formData.append('monitoringLog', proctoringDataString);
                formData.append('answerDetails', JSON.stringify(allAnswersData));
               
                fetch(googleScriptUrl, { method: 'POST', body: formData})
                    .then(res => console.log("Successfully submitted to Google Sheet"))
                    .catch(err => console.error("Error submitting to Google Sheet:", err));
            }
           
            function startNewAttempt() {
                isSubmitted = false;
                proctoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0, suKien: [] };
                const proctoringWidget = document.getElementById('proctoring-widget');
                if (proctoringWidget) {
                    proctoringWidget.classList.add('hidden');
                    document.getElementById('tab-switch-count').textContent = '0';
                    document.getElementById('copy-count').textContent = '0';
                    document.getElementById('paste-count').textContent = '0';
                }

                renderStudentQuiz();
                resultContainer.classList.add('hidden');
                document.getElementById('ai-feedback-container').classList.add('hidden');
                postSubmitOptions.classList.add('hidden');
                submitBtn.classList.remove('hidden');
                 if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                }
                retriesLeft--;
                retriesDisplay.textContent = `Lượt làm lại còn: ${retriesLeft}`;
                window.scrollTo(0, 0);
            }
            studentInfoForm.addEventListener('submit', (e) => {
                e.preventDefault();
               
                const enteredCode = document.getElementById('exam-code').value.trim().toUpperCase();
                if (correctExamCode && enteredCode !== correctExamCode) {
                    alert('Mã đề không chính xác. Vui lòng kiểm tra lại!');
                    return;
                }
               
                studentApiKey = teacherApiKey;
                if (!studentApiKey) {
                    console.warn('Cảnh báo: Giáo viên chưa cấu hình API Key. Các tính năng AI sẽ không hoạt động.');
                }
       
                try {
                    if (studentApiKey) {
                       ai = new GoogleGenAI({ apiKey: studentApiKey });
                    }
                } catch(e) {
                    console.error("Lỗi khởi tạo Gemini API với key của giáo viên.", e);
                    alert("Cảnh báo: API Key của giáo viên không hợp lệ. Vui lòng báo cho giáo viên. Các tính năng AI sẽ không hoạt động.");
                    ai = null;
                }
                shuffleQuiz();
               
                studentInfo.name = document.getElementById('student-name').value;
                studentInfo.class = document.getElementById('student-class').value;
                loginModal.classList.add('hidden');
                studentQuizContainer.classList.remove('hidden');
                submitBtn.classList.remove('hidden');
               
                if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                } else {
                    timerDisplay.textContent = "Không giới hạn";
                }
                retriesDisplay.textContent = `Lượt làm lại còn: ${retriesLeft}`;
                renderStudentQuiz();

                const proctoringWidget = document.getElementById('proctoring-widget');
                const tabSwitchCountEl = document.getElementById('tab-switch-count');
                const copyCountEl = document.getElementById('copy-count');
                const pasteCountEl = document.getElementById('paste-count');

                function updateProctoringUI() {
                    if (proctoringLog.thoatManHinh > 0 || proctoringLog.saoChep > 0 || proctoringLog.dan > 0) {
                        proctoringWidget.classList.remove('hidden');
                    }
                    tabSwitchCountEl.textContent = proctoringLog.thoatManHinh;
                    copyCountEl.textContent = proctoringLog.saoChep;
                    pasteCountEl.textContent = proctoringLog.dan;
                }

                // Disable Right Click
                document.addEventListener('contextmenu', e => e.preventDefault());

                // Track Tab Switching
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && !isSubmitted) {
                        proctoringLog.thoatManHinh++;
                        proctoringLog.suKien.push({ loai: 'chuyen_tab', thoiGian: new Date().toISOString() });
                        updateProctoringUI();
                    }
                });

                // Track Copying
                document.addEventListener('copy', () => {
                    if (isSubmitted) return;
                    proctoringLog.saoChep++;
                    proctoringLog.suKien.push({ loai: 'sao_chep', thoiGian: new Date().toISOString() });
                    updateProctoringUI();
                });

                // Track Pasting
                document.addEventListener('paste', () => {
                    if (isSubmitted) return;
                    proctoringLog.dan++;
                    proctoringLog.suKien.push({ loai: 'dan', thoiGian: new Date().toISOString() });
                    updateProctoringUI();
                });
            });
            
            submitBtn.addEventListener('click', handleSubmit);
            retryBtn.addEventListener('click', () => {
                shuffleQuiz();
                startNewAttempt();
            });
        </script>
    </body>
    </html>
    