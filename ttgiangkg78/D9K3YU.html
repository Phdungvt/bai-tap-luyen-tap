
    <!DOCTYPE html>
    <html lang="vi">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ÔN TẬP CHƯƠNG III-MẪU SỐ LIỆU GHÉP NHÓM-KNTT-TOÁN 11</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
        <script>
            window.MathJax = {
                tex: {
                    packages: {'[+]': ['ams']},
                    inlineMath: [['$', '$'], ['\\(', '\\)']],
                    displayMath: [['$$', '$$'], ['\\[', '\\]']]
                },
                chtml: {
                    fontCache: 'global',
                    linebreaks: {
                        automatic: true
                    }
                }
            };
        </script>
        <script type="text/javascript" id="MathJax-script" async
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
        </script>
        <style>
            body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #f0f4f8; }
            .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
            @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
            .question-card {
                background-color: white;
                border-radius: 1rem;
                padding: 1.5rem 2rem;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                border-left: 5px solid transparent;
                transition: all 0.3s ease;
            }
            .ai-explanation {
                background-color: #f0f9ff;
                color: #0c4a6e;
                padding: 1rem;
                border-radius: 0.75rem;
                font-size: 0.9rem;
                margin-top: 1rem;
                border-left: 4px solid #38bdf8;
            }
            .feedback-icon { width: 1.5rem; height: 1.5rem; }
            .option-label {
                transition: all 0.2s ease-in-out;
                border: 2px solid #e5e7eb;
            }
            .option-label:hover {
                border-color: #6366f1;
                background-color: #eef2ff;
            }
            .option-label.correct {
                border-color: #10b981 !important;
                background-color: #ecfdf5 !important;
                color: #065f46;
            }
            .option-label.incorrect {
                border-color: #ef4444 !important;
                background-color: #fef2f2 !important;
                color: #991b1b;
            }
            .statement-item.correct { background-color: #ecfdf5; border-color: #10b981; }
            .statement-item.incorrect { background-color: #fef2f2; border-color: #ef4444; }
            .prose { max-width: 100%; }
            .prose h1, .prose h2, .prose h3 { font-weight: 600; }
            .prose p { margin-top: 0.5em; margin-bottom: 0.5em; }
            .prose ul, .prose ol { margin-top: 1em; margin-bottom: 1em; padding-left: 1.5em; }
            .prose li > p { margin-top: 0; margin-bottom: 0; }
            .prose code { background-color: #e5e7eb; padding: 0.2em 0.4em; margin: 0; font-size: 85%; border-radius: 3px; }
            .prose pre { background-color: #e5e7eb; padding: 1em; border-radius: 0.5em; overflow-x: auto; }
            .prose pre code { background-color: transparent; padding: 0; }
            details[open] > summary .details-arrow {
                transform: rotate(180deg);
            }
        </style>
    </head>
    <body class="bg-slate-100 text-slate-800">
        <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md transform transition-all" style="animation: fadeIn 0.3s ease-out;">
                <h2 class="text-2xl font-bold mb-2 text-center text-slate-800">Thông Tin Học Sinh</h2>
                <p class="text-center text-slate-500 mb-6">Vui lòng nhập để bắt đầu làm bài.</p>
                <form id="student-info-form">
                    <div class="mb-4">
                        <label for="student-name" class="block text-sm font-medium text-slate-700 mb-1">Họ và tên</label>
                        <input type="text" id="student-name" required class="mt-1 block w-full block border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="student-class" class="block text-sm font-medium text-slate-700 mb-1">Lớp</label>
                        <input type="text" id="student-class" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="exam-code" class="block text-sm font-medium text-slate-700 mb-1">Mã đề</label>
                        <input type="text" id="exam-code" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Nhập mã đề giáo viên cung cấp">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Giáo viên:</label>
                        <p class="mt-1 text-slate-800 bg-slate-100 p-2.5 rounded-lg">Giang Trần Thanh</p>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">Bắt đầu làm bài</button>
                </form>
            </div>
        </div>
        <div class="container mx-auto p-4 md:p-8 max-w-4xl">
            <header class="mb-10 p-8 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg">
                <div class="flex justify-between items-center flex-wrap gap-4">
                    <div>
                        <h1 class="text-4xl font-bold">ÔN TẬP CHƯƠNG III-MẪU SỐ LIỆU GHÉP NHÓM-KNTT-TOÁN 11</h1>
                        <p class="text-lg text-blue-100 mt-2">Hãy hoàn thành các câu hỏi dưới đây một cách tốt nhất!</p>
                        <p class="text-sm text-blue-200 mt-4">Tác giả: Giang Trần Thanh</p>
                    </div>
                    <div id="timer-container" class="text-right">
                         <div id="timer-display" class="text-3xl font-bold tracking-wider bg-white/20 px-4 py-2 rounded-lg">--:--</div>
                         <div id="retries-display" class="text-sm mt-1 text-blue-200"></div>
                    </div>
                </div>
            </header>
            <main id="student-quiz-container" class="space-y-8 hidden">
                <!-- Questions will be rendered here by JS -->
            </main>
            <footer class="mt-10 text-center">
                <button id="submit-quiz-btn" class="bg-indigo-600 text-white py-3 px-12 rounded-full font-bold text-lg hover:bg-indigo-700 transition-all duration-300 shadow-lg hover:shadow-xl hidden transform hover:scale-105">Nộp Bài</button>
                <div id="result-container" class="mt-6 hidden"></div>
                <div id="ai-feedback-container" class="mt-8 text-left hidden"></div>
                <div id="post-submit-options" class="hidden mt-6 flex flex-col sm:flex-row items-center justify-center gap-4">
                    <button id="retry-quiz-btn" class="w-full sm:w-auto bg-slate-600 text-white py-2.5 px-6 rounded-lg font-semibold hover:bg-slate-700 transition-transform transform hover:scale-105">Làm Lại Đề Này</button>
                </div>
            </footer>
        </div>

        <div id="proctoring-widget" class="fixed bottom-4 right-4 bg-yellow-100 text-yellow-800 p-3 rounded-lg shadow-lg text-sm z-50 hidden border border-yellow-300" style="max-width: 200px;">
            <h4 class="font-bold mb-2 border-b border-yellow-300 pb-1 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 3.001-1.742 3.001H4.42c-1.53 0-2.493-1.667-1.743-3.001l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                Giám sát
            </h4>
            <p>Thoát màn hình: <span id="tab-switch-count" class="font-bold">0</span></p>
            <p>Sao chép: <span id="copy-count" class="font-bold">0</span></p>
            <p>Dán: <span id="paste-count" class="font-bold">0</span></p>
        </div>

        <script type="module">
            import { GoogleGenAI, Type } from "https://esm.sh/@google/genai@^1.13.0";
            let quizData = [{"type":"multiple-choice","question":"Cho mẫu số liệu ghép nhóm về số cân nặng (đơn vị: $\\text{kg}$) của $25$ học sinh lớp $11$ như sau:$$ \\begin{array}{|c|c|} \\hline \\textbf{Cân nặng (kg)} & \\textbf{Tần số} \\\\ \\hline [40; 45) & 3 \\\\ \\hline [45; 50) & 8 \\\\ \\hline [50; 55) & 7 \\\\ \\hline [55; 60) & 5 \\\\ \\hline [60; 65) & 2 \\\\ \\hline \\textbf{Tổng} & 25 \\\\ \\hline \\end{array} $$Hãy cho biết tần số của lớp $[45; 50)$ là bao nhiêu?","questionImage":null,"mappedType":"multiple-choice","options":["$3$","$8$","$7$","$5$"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Cho mẫu số liệu ghép nhóm về chiều cao (đơn vị: $\\text{cm}$) của $30$ cây như sau:$$ \\begin{array}{|c|c|} \\hline \\textbf{Chiều cao (cm)} & \\textbf{Tần số} \\\\ \\hline [150; 155) & 5 \\\\ \\hline [155; 160) & 10 \\\\ \\hline [160; 165) & 8 \\\\ \\hline [165; 170) & 7 \\\\ \\hline \\textbf{Tổng} & 30 \\\\ \\hline \\end{array} $$Số lượng cây có chiều cao từ $160 \\text{ cm}$ đến dưới $165 \\text{ cm}$ là bao nhiêu?","questionImage":null,"mappedType":"multiple-choice","options":["$5$","$10$","$8$","$7$"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Cho bảng phân bố tần số ghép nhóm về thời gian tự học (đơn vị: phút) của $40$ học sinh trong một ngày:$$ \\begin{array}{|c|c|} \\hline \\textbf{Thời gian (phút)} & \\textbf{Tần số} \\\\ \\hline [30; 45) & 12 \\\\ \\hline [45; 60) & 15 \\\\ \\hline [60; 75) & 9 \\\\ \\hline [75; 90) & 4 \\\\ \\hline \\textbf{Tổng} & 40 \\\\ \\hline \\end{array} $$Kích thước của các lớp ghép nhóm trong bảng trên là bao nhiêu?","questionImage":null,"mappedType":"multiple-choice","options":["$10$","$15$","$20$","$5$"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Quan sát bảng phân bố tần số ghép nhóm về điểm kiểm tra môn Toán của $35$ học sinh:$$ \\begin{array}{|c|c|} \\hline \\textbf{Điểm số} & \\textbf{Tần số} \\\\ \\hline [0; 2) & 2 \\\\ \\hline [2; 4) & 5 \\\\ \\hline [4; 6) & 13 \\\\ \\hline [6; 8) & 10 \\\\ \\hline [8; 10] & 5 \\\\ \\hline \\textbf{Tổng} & 35 \\\\ \\hline \\end{array} $$Lớp nào có tần số lớn nhất?","questionImage":null,"mappedType":"multiple-choice","options":["$[0; 2)$","$[2; 4)$","$[4; 6)$","$[6; 8)$"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Cho bảng tần số ghép nhóm về tuổi của $50$ người tham gia một sự kiện:$$ \\begin{array}{|c|c|} \\hline \\textbf{Tuổi} & \\textbf{Tần số} \\\\ \\hline [18; 25) & 10 \\\\ \\hline [25; 32) & 15 \\\\ \\hline [32; 39) & 12 \\\\ \\hline [39; 46) & 8 \\\\ \\hline [46; 53) & 5 \\\\ \\hline \\textbf{Tổng} & 50 \\\\ \\hline \\end{array} $$Lớp $[39; 46)$ có giá trị đại diện (điểm giữa) là bao nhiêu?","questionImage":null,"mappedType":"multiple-choice","options":["$39,5$","$42,5$","$43$","$46$"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Một mẫu số liệu ghép nhóm gồm các lớp $[10; 20)$, $[20; 30)$, $[30; 40)$, $[40; 50)$. Điểm giữa của lớp $[20; 30)$ là bao nhiêu?","questionImage":null,"mappedType":"multiple-choice","options":["$15$","$25$","$35$","$45$"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Khi lập bảng tần số ghép nhóm, kí hiệu lớp $[a; b)$ có nghĩa là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Giá trị lớn hơn hoặc bằng $a$ và nhỏ hơn $b$.","Giá trị lớn hơn $a$ và nhỏ hơn hoặc bằng $b$.","Giá trị lớn hơn $a$ và nhỏ hơn $b$.","Giá trị lớn hơn hoặc bằng $a$ và nhỏ hơn hoặc bằng $b$."],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Trong bảng tần số ghép nhóm, tần số của một lớp ghép nhóm cho biết điều gì?","questionImage":null,"mappedType":"multiple-choice","options":["Tổng số liệu trong mẫu.","Số lượng các giá trị thuộc lớp đó.","Giá trị trung bình của các giá trị trong lớp.","Giá trị nhỏ nhất của lớp đó."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Cho mẫu số liệu ghép nhóm về số cuộc gọi mỗi ngày đến một tổng đài trong $20$ ngày:$$ \\begin{array}{|c|c|} \\hline \\textbf{Số cuộc gọi} & \\textbf{Tần số} \\\\ \\hline [0; 5) & 2 \\\\ \\hline [5; 10) & 7 \\\\ \\hline [10; 15) & 6 \\\\ \\hline [15; 20) & 3 \\\\ \\hline [20; 25) & 2 \\\\ \\hline \\textbf{Tổng} & 20 \\\\ \\hline \\end{array} $$Có bao nhiêu ngày có số cuộc gọi ít hơn $10$?","questionImage":null,"mappedType":"multiple-choice","options":["$2$","$7$","$9$","$6$"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Một bảng tần số ghép nhóm được tạo ra để tổ chức dữ liệu. Lớp ghép nhóm $[100; 120)$ có tần số là $12$. Giá trị nào sau đây thuộc lớp này?","questionImage":null,"mappedType":"multiple-choice","options":["$99,9$","$120$","$105$","$120,1$"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Khi muốn biểu diễn một mẫu số liệu lớn, có nhiều giá trị khác nhau, cách nào sau đây thường được sử dụng để dễ phân tích và tổng hợp?","questionImage":null,"mappedType":"multiple-choice","options":["Liệt kê tất cả các giá trị.","Vẽ biểu đồ hình quạt.","Lập bảng tần số ghép nhóm.","Tính trung bình cộng của tất cả các giá trị."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Cho bảng tần số ghép nhóm về thời gian hoàn thành một bài kiểm tra (đơn vị: phút) của $22$ học sinh:$$ \\begin{array}{|c|c|} \\hline \\textbf{Thời gian (phút)} & \\textbf{Tần số} \\\\ \\hline [15; 20) & 4 \\\\ \\hline [20; 25) & 9 \\\\ \\hline [25; 30) & 6 \\\\ \\hline [30; 35) & 3 \\\\ \\hline \\textbf{Tổng} & 22 \\\\ \\hline \\end{array} $$Có bao nhiêu học sinh hoàn thành bài kiểm tra trong thời gian từ $25$ phút đến dưới $30$ phút?","questionImage":null,"mappedType":"multiple-choice","options":["$4$","$9$","$6$","$3$"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Cho bảng tần số ghép nhóm về số lượng sản phẩm bán được mỗi ngày của một cửa hàng trong $30$ ngày:$$ \\begin{array}{|c|c|} \\hline \\textbf{Số sản phẩm} & \\textbf{Tần số} \\\\ \\hline [10; 15) & 5 \\\\ \\hline [15; 20) & 12 \\\\ \\hline [20; 25) & 8 \\\\ \\hline [25; 30) & 5 \\\\ \\hline \\textbf{Tổng} & 30 \\\\ \\hline \\end{array} $$Số ngày bán được từ $20$ sản phẩm trở lên là bao nhiêu?","questionImage":null,"mappedType":"multiple-choice","options":["$8$","$5$","$13$","$12$"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Một bảng tần số ghép nhóm có các lớp $[0; 10)$, $[10; 20)$, $[20; 30)$, $[30; 40)$. Giá trị nào sau đây là cận trên của lớp thứ ba?","questionImage":null,"mappedType":"multiple-choice","options":["$10$","$20$","$30$","$40$"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Mục đích chính của việc lập bảng tần số ghép nhóm là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Tìm giá trị trung bình của mẫu số liệu.","Xác định giá trị lớn nhất và nhỏ nhất của mẫu số liệu.","Tổ chức và tóm tắt dữ liệu thành các nhóm để dễ dàng phân tích.","Tính toán độ lệch chuẩn của mẫu số liệu."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Cho mẫu số liệu ghép nhóm. Công thức tính số trung bình cộng $\\bar{x}$ của mẫu số liệu ghép nhóm là gì?","questionImage":null,"mappedType":"multiple-choice","options":["$\\bar{x} = \\frac{1}{n} \\sum_{i=1}^{k} n_i c_i$","$\\bar{x} = \\frac{1}{k} \\sum_{i=1}^{k} n_i c_i$","$\\bar{x} = \\frac{1}{n} \\sum_{i=1}^{k} n_i$","$\\bar{x} = \\frac{1}{k} \\sum_{i=1}^{k} c_i$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Cho mẫu số liệu ghép nhóm. Công thức tính trung vị $M_e$ của mẫu số liệu ghép nhóm là gì?","questionImage":null,"mappedType":"multiple-choice","options":["$M_e = L + \\frac{\\frac{n}{2} - n_{M_e-1}}{n_{M_e}} \\times h$","$M_e = L + \\frac{\\frac{n}{2} - C_{M_e-1}}{n_{M_e}} \\times h$","$M_e = L + \\frac{\\frac{n}{2} - C_{M_e-1}}{C_{M_e}} \\times h$","$M_e = L + \\frac{\\frac{n}{2} + C_{M_e-1}}{n_{M_e}} \\times h$"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Cho mẫu số liệu ghép nhóm. Công thức tính mốt $M_o$ của mẫu số liệu ghép nhóm là gì?","questionImage":null,"mappedType":"multiple-choice","options":["$M_o = L + \\frac{n_{M_o} - n_{M_o-1}}{(n_{M_o} - n_{M_o-1}) + (n_{M_o} - n_{M_o+1})} \\times h$","$M_o = L + \\frac{n_{M_o} - n_{M_o-1}}{n_{M_o} + n_{M_o+1}} \\times h$","$M_o = L + \\frac{n_{M_o} - n_{M_o+1}}{(n_{M_o} - n_{M_o-1}) + (n_{M_o} - n_{M_o+1})} \\times h$","$M_o = L + \\frac{n_{M_o} - n_{M_o-1}}{(n_{M_o} - n_{M_o-1}) - (n_{M_o} - n_{M_o+1})} \\times h$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Cho mẫu số liệu ghép nhóm. Công thức tính tứ phân vị thứ nhất $Q_1$ của mẫu số liệu ghép nhóm là gì?","questionImage":null,"mappedType":"multiple-choice","options":["$Q_1 = L + \\frac{\\frac{n}{4} - C_{Q_1-1}}{n_{Q_1}} \\times h$","$Q_1 = L + \\frac{\\frac{n}{2} - C_{Q_1-1}}{n_{Q_1}} \\times h$","$Q_1 = L + \\frac{\\frac{n}{4} + C_{Q_1-1}}{n_{Q_1}} \\times h$","$Q_1 = L + \\frac{\\frac{3n}{4} - C_{Q_1-1}}{n_{Q_1}} \\times h$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Cho mẫu số liệu ghép nhóm. Công thức tính tứ phân vị thứ ba $Q_3$ của mẫu số liệu ghép nhóm là gì?","questionImage":null,"mappedType":"multiple-choice","options":["$Q_3 = L + \\frac{\\frac{3n}{4} - C_{Q_3-1}}{n_{Q_3}} \\times h$","$Q_3 = L + \\frac{\\frac{n}{4} - C_{Q_3-1}}{n_{Q_3}} \\times h$","$Q_3 = L + \\frac{\\frac{3n}{4} + C_{Q_3-1}}{n_{Q_3}} \\times h$","$Q_3 = L + \\frac{\\frac{n}{2} - C_{Q_3-1}}{n_{Q_3}} \\times h$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Cho bảng phân bố tần số ghép nhóm sau đây:$$ \\begin{array}{|l|c|c|c|c|} \\hline \\text{Nhóm tuổi} & [15; 20) & [20; 25) & [25; 30) & [30; 35) \\\\ \\hline \\text{Tần số} & 5 & 12 & 8 & 3 \\\\ \\hline \\end{array} $$ Nhóm chứa mốt của mẫu số liệu này là gì?","questionImage":null,"mappedType":"multiple-choice","options":["$[20; 25)$","$[15; 20)$","$[25; 30)$","$[30; 35)$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Cho bảng phân bố tần số ghép nhóm sau đây:$$ \\begin{array}{|l|c|c|c|c|} \\hline \\text{Khoảng điểm} & [0; 2) & [2; 4) & [4; 6) & [6; 8) & [8; 10) \\\\ \\hline \\text{Số học sinh} & 3 & 7 & 15 & 10 & 5 \\\\ \\hline \\end{array} $$ Nhóm chứa trung vị của mẫu số liệu này là gì?","questionImage":null,"mappedType":"multiple-choice","options":["$[4; 6)$","$[2; 4)$","$[6; 8)$","$[8; 10)$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Cho bảng phân bố tần số ghép nhóm sau đây:$$ \\begin{array}{|l|c|c|c|c|} \\hline \\text{Mức lương (triệu đồng)} & [5; 7) & [7; 9) & [9; 11) & [11; 13) \\\\ \\hline \\text{Số người} & 10 & 20 & 15 & 5 \\\\ \\hline \\end{array} $$ Nhóm chứa tứ phân vị thứ nhất ($Q_1$) của mẫu số liệu này là gì?","questionImage":null,"mappedType":"multiple-choice","options":["$[7; 9)$","$[5; 7)$","$[9; 11)$","$[11; 13)$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Cho bảng phân bố tần số ghép nhóm sau đây:$$ \\begin{array}{|l|c|c|c|c|c|} \\hline \\text{Thời gian (phút)} & [10; 20) & [20; 30) & [30; 40) & [40; 50) & [50; 60) \\\\ \\hline \\text{Số người} & 6 & 14 & 10 & 8 & 2 \\\\ \\hline \\end{array} $$ Nhóm chứa tứ phân vị thứ ba ($Q_3$) của mẫu số liệu này là gì?","questionImage":null,"mappedType":"multiple-choice","options":["$[30; 40)$","$[20; 30)$","$[40; 50)$","$[50; 60)$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Từ bảng tần số ghép nhóm, để tính số trung bình, giá trị đại diện $c_i$ của mỗi nhóm $[a;b)$ được tính như thế nào?","questionImage":null,"mappedType":"multiple-choice","options":["$c_i = \\frac{a+b}{2}$","$c_i = b-a$","$c_i = \\frac{b-a}{2}$","$c_i = a+b$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Trong công thức tính trung vị của mẫu số liệu ghép nhóm $M_e = L + \\frac{\\frac{n}{2} - C_{M_e-1}}{n_{M_e}} \\times h$, kí hiệu $L$ là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Cận dưới của nhóm chứa trung vị","Cận trên của nhóm chứa trung vị","Độ dài của nhóm chứa trung vị","Tần số của nhóm chứa trung vị"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Trong công thức tính mốt của mẫu số liệu ghép nhóm $M_o = L + \\frac{n_{M_o} - n_{M_o-1}}{(n_{M_o} - n_{M_o-1}) + (n_{M_o} - n_{M_o+1})} \\times h$, kí hiệu $h$ là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Độ dài của nhóm chứa mốt","Tần số của nhóm chứa mốt","Cận dưới của nhóm chứa mốt","Cận trên của nhóm chứa mốt"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Giá trị nào trong các số đặc trưng đo xu thế trung tâm thường được sử dụng khi mẫu số liệu có các giá trị ngoại lai ảnh hưởng đến số trung bình?","questionImage":null,"mappedType":"multiple-choice","options":["Trung vị","Số trung bình","Mốt","Tứ phân vị"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Đối với mẫu số liệu ghép nhóm, mốt là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Giá trị đại diện của nhóm có tần số lớn nhất","Giá trị đại diện của nhóm có tần số nhỏ nhất","Điểm giữa của toàn bộ mẫu số liệu","Giá trị trung bình của các giá trị đại diện"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Số trung bình của mẫu số liệu ghép nhóm biểu thị điều gì?","questionImage":null,"mappedType":"multiple-choice","options":["Giá trị trung tâm, cân bằng của mẫu số liệu","Giá trị xuất hiện nhiều nhất trong mẫu","Giá trị chia mẫu thành hai phần bằng nhau","Độ phân tán của mẫu số liệu"],"optionsImage":[],"correctAnswerIndex":0},{"type":"true-false","main_question":"Khi lập bảng tần số ghép nhóm cho một mẫu số liệu, hãy xét các phát biểu sau:","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Lớp ghép nhóm là các khoảng giá trị dùng để phân chia mẫu số liệu.","is_correct":true},{"statement":"Tần số của một lớp ghép nhóm là số các giá trị của mẫu số liệu thuộc lớp đó.","is_correct":true},{"statement":"Giá trị đại diện của lớp ghép nhóm $[a; b)$ luôn là giá trị nhỏ nhất của lớp đó.","is_correct":false},{"statement":"Tần số tích lũy của một lớp ghép nhóm là tổng tần số của lớp đó và tất cả các lớp đứng trước nó.","is_correct":true}]},{"type":"true-false","main_question":"Khi thực hiện ghép nhóm một mẫu số liệu, các phát biểu nào sau đây là đúng?","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Bước đầu tiên để lập bảng tần số ghép nhóm là sắp xếp mẫu số liệu theo thứ tự không giảm.","is_correct":false},{"statement":"Các lớp ghép nhóm phải rời nhau và phủ hết toàn bộ các giá trị của mẫu số liệu.","is_correct":true},{"statement":"Độ dài của các lớp ghép nhóm luôn phải bằng nhau.","is_correct":false},{"statement":"Với một mẫu số liệu có giá trị nhỏ nhất là $x_{\\min}$ và giá trị lớn nhất là $x_{\\max}$, có thể chọn các lớp ghép nhóm sao cho lớp đầu tiên chứa $x_{\\min}$ và lớp cuối cùng chứa $x_{\\max}$.","is_correct":true}]},{"type":"true-false","main_question":"Cho bảng tần số ghép nhóm về chiều cao của $28$ học sinh như sau:$$ \\begin{array}{|c|c|} \\hline \\textbf{Chiều cao (cm)} & \\textbf{Tần số} \\\\ \\hline [150; 155) & 5 \\\\ \\hline [155; 160) & 12 \\\\ \\hline [160; 165) & 8 \\\\ \\hline [165; 170) & 3 \\\\ \\hline \\textbf{Tổng} & 28 \\\\ \\hline \\end{array} $$Hãy xét các phát biểu sau:","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Có $12$ học sinh có chiều cao từ $150 \\text{ cm}$ đến dưới $155 \\text{ cm}$.","is_correct":false},{"statement":"Số học sinh có chiều cao từ $160 \\text{ cm}$ trở lên là $11$.","is_correct":true},{"statement":"Tần số tương đối của lớp $[155; 160)$ là xấp xỉ $42.86\\%$.","is_correct":true},{"statement":"Có nhiều hơn $15$ học sinh có chiều cao dưới $160 \\text{ cm}$.","is_correct":true}]},{"type":"true-false","main_question":"Khi phân chia các lớp ghép nhóm $[a; b)$, các phát biểu nào sau đây là đúng?","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Giá trị $a$ được gọi là mút trái (cận dưới) của lớp ghép nhóm.","is_correct":true},{"statement":"Giá trị $b$ được gọi là mút phải (cận trên) của lớp ghép nhóm.","is_correct":true},{"statement":"Một giá trị $x$ thỏa mãn $a \\le x < b$ sẽ thuộc lớp $[a; b)$.","is_correct":true},{"statement":"Nếu một giá trị của mẫu số liệu trùng với cận trên $b$ của lớp $[a; b)$, thì giá trị đó vẫn được tính vào lớp này.","is_correct":false}]},{"type":"true-false","main_question":"Về việc tổ chức mẫu số liệu thành bảng tần số ghép nhóm, hãy xét các phát biểu sau:","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Lập bảng tần số ghép nhóm giúp tóm tắt dữ liệu và dễ dàng quan sát phân bố của mẫu số liệu.","is_correct":true},{"statement":"Việc chọn quá ít lớp ghép nhóm có thể làm mất đi nhiều thông tin chi tiết của mẫu số liệu.","is_correct":true},{"statement":"Nếu các lớp ghép nhóm không có cùng độ dài, việc so sánh phân bố dữ liệu giữa các lớp sẽ trở nên khó khăn hơn.","is_correct":true},{"statement":"Mẫu số liệu ghép nhóm không thể được dùng để tính toán các số đặc trưng như số trung bình hay trung vị.","is_correct":false}]},{"type":"true-false","main_question":"Cho mẫu số liệu ghép nhóm. Hãy xác định các phát biểu sau đây là đúng hay sai về số trung bình của mẫu số liệu ghép nhóm.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Số trung bình của mẫu số liệu ghép nhóm được tính bằng cách lấy tổng của các tích \"tần số nhóm $\\times$ giá trị đại diện nhóm\" chia cho tổng các tần số.","is_correct":true},{"statement":"Giá trị đại diện của một nhóm $[a; b)$ là trung điểm của khoảng, tức là $\\dfrac{a+b}{2}$.","is_correct":true},{"statement":"Nếu một mẫu số liệu ghép nhóm có các nhóm $[10; 20)$, $[20; 30)$, $[30; 40)$ với tần số tương ứng là $f_1=5$, $f_2=10$, $f_3=5$, thì giá trị đại diện của nhóm thứ nhất là $15$.","is_correct":true},{"statement":"Nếu tất cả các tần số của các nhóm trong một mẫu số liệu ghép nhóm đều tăng gấp đôi, số trung bình của mẫu số liệu ghép nhóm sẽ thay đổi.","is_correct":false}]},{"type":"true-false","main_question":"Cho mẫu số liệu ghép nhóm. Hãy xác định các phát biểu sau đây là đúng hay sai về trung vị của mẫu số liệu ghép nhóm.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Trung vị của mẫu số liệu ghép nhóm là giá trị mà tại đó $50\\%$ số liệu nhỏ hơn hoặc bằng nó và $50\\%$ số liệu lớn hơn hoặc bằng nó.","is_correct":true},{"statement":"Để tìm trung vị của mẫu số liệu ghép nhóm, bước đầu tiên là xác định nhóm chứa trung vị.","is_correct":true},{"statement":"Công thức xác định trung vị $M_e$ của mẫu số liệu ghép nhóm là $M_e = L + \\dfrac{\\frac{n}{2} - C}{f} \\times h$, trong đó $L$ là cận dưới của nhóm chứa trung vị, $n$ là cỡ mẫu, $C$ là tần số tích lũy của nhóm ngay trước nhóm chứa trung vị, $f$ là tần số của nhóm chứa trung vị và $h$ là độ dài của nhóm chứa trung vị.","is_correct":true},{"statement":"Nếu tất cả các tần số của các nhóm trong mẫu số liệu ghép nhóm đều tăng gấp ba, thì giá trị trung vị của mẫu số liệu ghép nhóm sẽ thay đổi.","is_correct":false}]},{"type":"true-false","main_question":"Cho mẫu số liệu ghép nhóm. Hãy xác định các phát biểu sau đây là đúng hay sai về mốt của mẫu số liệu ghép nhóm.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Mốt của mẫu số liệu ghép nhóm là giá trị có tần số xuất hiện lớn nhất.","is_correct":true},{"statement":"Nhóm chứa mốt là nhóm có tần số lớn nhất.","is_correct":true},{"statement":"Một mẫu số liệu ghép nhóm chỉ có thể có duy nhất một mốt.","is_correct":false},{"statement":"Nếu một mẫu số liệu ghép nhóm có các nhóm $[5; 10)$, $[10; 15)$, $[15; 20)$ với tần số tương ứng là $6$, $10$, $8$, thì nhóm chứa mốt là $[10; 15)$.","is_correct":true}]},{"type":"true-false","main_question":"Cho mẫu số liệu ghép nhóm. Hãy xác định các phát biểu sau đây là đúng hay sai về tứ phân vị của mẫu số liệu ghép nhóm.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Tứ phân vị $Q_1$ chia mẫu số liệu thành hai phần, với $25\\%$ số liệu nhỏ hơn hoặc bằng $Q_1$ và $75\\%$ số liệu lớn hơn hoặc bằng $Q_1$.","is_correct":true},{"statement":"Tứ phân vị $Q_2$ chính là trung vị của mẫu số liệu.","is_correct":true},{"statement":"Công thức tính tứ phân vị $Q_k$ tương tự như công thức tính trung vị, nhưng với $k \\times \\dfrac{n}{4}$ thay vì $\\dfrac{n}{2}$ để xác định vị trí nhóm chứa tứ phân vị.","is_correct":true},{"statement":"Nếu nhóm chứa tứ phân vị $Q_3$ có cận dưới là $L=50$, tần số là $f=12$ và độ dài nhóm là $h=5$, tần số tích lũy của nhóm liền trước $Q_3$ là $C=30$, và cỡ mẫu $n=100$, thì $Q_3 = 50 + \\dfrac{75 - 30}{12} \\times 5 = 50 + \\dfrac{45}{12} \\times 5 = 50 + 18.75 = 68.75$.","is_correct":true}]},{"type":"true-false","main_question":"Về các số đặc trưng đo xu thế trung tâm cho mẫu số liệu ghép nhóm, các phát biểu sau là đúng hay sai?","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Các số đo xu thế trung tâm bao gồm số trung bình, trung vị và mốt.","is_correct":true},{"statement":"Số trung bình thường bị ảnh hưởng bởi các giá trị quá lớn hoặc quá nhỏ trong mẫu số liệu hơn so với trung vị.","is_correct":true},{"statement":"Trung vị là số đặc trưng luôn tồn tại và duy nhất trong mọi trường hợp mẫu số liệu ghép nhóm.","is_correct":true},{"statement":"Khi so sánh hai mẫu số liệu ghép nhóm có cùng số lượng quan sát nhưng phân bố khác nhau, chỉ cần so sánh giá trị số trung bình là đủ để đưa ra kết luận chính xác nhất về sự khác biệt giữa hai mẫu.","is_correct":false}]},{"type":"short-answer","question":"Cho mẫu số liệu về chiều cao (đơn vị: $\\text{cm}$) của $20$ cây con như sau: $15, 18, 16, 20, 17, 19, 15, 21, 18, 17, 16, 22, 19, 20, 17, 15, 18, 16, 20, 19$. Khi lập bảng tần số ghép nhóm với các lớp $[15; 17)$, $[17; 19)$, $[19; 21)$, $[21; 23)$, có bao nhiêu cây có chiều cao trong lớp $[17; 19)$?","questionImage":null,"mappedType":"short-answer","answer":"$6$"},{"type":"short-answer","question":"Dựa vào bảng tần số ghép nhóm về cân nặng của $55$ người trưởng thành như sau, hãy cho biết có bao nhiêu người có cân nặng từ $50 \\text{ kg}$ đến dưới $60 \\text{ kg}$?$$ \\begin{array}{|c|c|} \\hline \\textbf{Nhóm cân nặng (kg)} & \\textbf{Tần số} \\\\ \\hline [40; 50) & 12 \\\\ \\hline [50; 60) & 20 \\\\ \\hline [60; 70) & 15 \\\\ \\hline [70; 80) & 8 \\\\ \\hline \\textbf{Tổng} & 55 \\\\ \\hline \\end{array} $$","questionImage":null,"mappedType":"short-answer","answer":"$20$"},{"type":"short-answer","question":"Nêu ý nghĩa của số trung bình cho mẫu số liệu ghép nhóm trong thống kê.","questionImage":null,"mappedType":"short-answer","answer":"Số trung bình của mẫu số liệu ghép nhóm là một ước lượng của giá trị trung bình của dữ liệu, nó phản ánh giá trị đại diện trung tâm và cung cấp thông tin về xu thế chung của mẫu số liệu."},{"type":"short-answer","question":"Mốt của mẫu số liệu ghép nhóm được định nghĩa như thế nào?","questionImage":null,"mappedType":"short-answer","answer":"Mốt của mẫu số liệu ghép nhóm là giá trị gần đúng của mốt thực tế, được xác định bởi giá trị đại diện của nhóm có tần số lớn nhất (tức là nhóm chứa mốt)."}];
            const quizOptions = {"timeLimit":90,"retriesAllowed":0,"showAnswers":true,"showExplanation":true,"aiAssessment":true,"scoring":{"mc":5,"tf":2,"sa":2,"essay":1,"tfMethod":"even"}};
            const googleScriptUrl = "https://script.google.com/macros/s/AKfycbzQehZao83-cv5N93t9i0HQgNfCSFasdn7CKMno0hu3vepRHEPjGbZanlF7Ylwd4cHI/exec";
            const correctExamCode = "D9K3YU";
            const teacherApiKey = "gen-lang-client-0875055545";
            let studentInfo = {};
            let isSubmitted = false;
            let timerInterval;
            let retriesLeft = quizOptions.retriesAllowed;
            let studentApiKey = "";
            let ai = null;

            let proctoringLog = {
                thoatManHinh: 0,
                saoChep: 0,
                dan: 0,
                suKien: []
            };

            const studentQuizContainer = document.getElementById('student-quiz-container');
            const submitBtn = document.getElementById('submit-quiz-btn');
            const resultContainer = document.getElementById('result-container');
            const postSubmitOptions = document.getElementById('post-submit-options');
            const retryBtn = document.getElementById('retry-quiz-btn');
            const loginModal = document.getElementById('login-modal');
            const studentInfoForm = document.getElementById('student-info-form');
            const timerDisplay = document.getElementById('timer-display');
            const retriesDisplay = document.getElementById('retries-display');
            function shuffleQuiz() {
                // Shuffle options/statements within each question first
                quizData.forEach(item => {
                    // Shuffle multiple-choice options and their corresponding images
                    if (item.mappedType === 'multiple-choice' && item.options && item.options.length > 0) {
                        const correctAnswerText = item.options[item.correctAnswerIndex];
                        let optionsWithImages = item.options.map((opt, index) => ({
                            text: opt,
                            image: (item.optionsImage && item.optionsImage[index]) ? item.optionsImage[index] : null
                        }));
                        // Fisher-Yates shuffle
                        for (let i = optionsWithImages.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [optionsWithImages[i], optionsWithImages[j]] = [optionsWithImages[j], optionsWithImages[i]];
                        }
                        // Update the item with shuffled data
                        item.options = optionsWithImages.map(opt => opt.text);
                        item.optionsImage = optionsWithImages.map(opt => opt.image);
                        item.correctAnswerIndex = item.options.indexOf(correctAnswerText);
                    }
                    // Shuffle true-false statements
                    if (item.mappedType === 'true-false' && item.statements && item.statements.length > 0) {
                         for (let i = item.statements.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [item.statements[i], item.statements[j]] = [item.statements[j], item.statements[i]];
                        }
                    }
                });
                // Then, group questions by type and shuffle within each group
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});
                let shuffledQuizData = [];
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    if (grouped[partType]) {
                        const partQuestions = grouped[partType];
                        for (let i = partQuestions.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [partQuestions[i], partQuestions[j]] = [partQuestions[j], partQuestions[i]];
                        }
                        shuffledQuizData = shuffledQuizData.concat(partQuestions);
                    }
                });
               
                quizData = shuffledQuizData;
            }
            // --- Timer Function ---
            function startTimer(duration, display) {
                let timer = duration, minutes, seconds;
                clearInterval(timerInterval); // Clear any existing timer
                if(duration <= 0) {
                     display.textContent = "∞";
                     return;
                }
                timerInterval = setInterval(function () {
                    minutes = parseInt(timer / 60, 10);
                    seconds = parseInt(timer % 60, 10);
                    minutes = minutes < 10 ? "0" + minutes : minutes;
                    seconds = seconds < 10 ? "0" + seconds : seconds;
                    display.textContent = minutes + ":" + seconds;
                    if (--timer < 0) {
                        clearInterval(timerInterval);
                        alert("Hết giờ làm bài!");
                        handleSubmit();
                    }
                }, 1000);
            }
            
            async function showExplanation(index, button) {
                const item = quizData[index];
                const questionCard = document.getElementById(`student-q-${index}`);
                const feedbackDiv = document.getElementById(`q-${index}-feedback`);
                if (!questionCard || !feedbackDiv) return;

                const existingExplanation = feedbackDiv.querySelector('.ai-explanation');
                if (existingExplanation) {
                    existingExplanation.remove();
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Xem giải thích
                    `;
                    return;
                }

                button.disabled = true;
                button.innerHTML = '<div class="loader mr-2"></div> Đang tải...';

                if (item.explanation) {
                    displayExplanation(item.explanation, feedbackDiv, button);
                    return;
                }

                if (!ai) {
                    alert("Tính năng giải thích yêu cầu API Key, nhưng chưa được cấu hình bởi giáo viên.");
                    button.disabled = false;
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Xem giải thích
                    `;
                    return;
                }

                const questionText = item.question || item.main_question;
                let prompt = `Bạn là một trợ lý giáo viên AI, am hiểu sâu sắc Chương trình GDPT 2018. Hãy cung cấp một lời giải chi tiết, từng bước một cho câu hỏi sau đây. Lời giải phải chính xác, dễ hiểu và phù hợp với phương pháp giảng dạy của chương trình học, TUYỆT ĐỐI KHÔNG sử dụng kiến thức của lớp cao hơn để giải thích.\n\n--- CÂU HỎI ---\n${questionText}\n\n`;
                if (item.mappedType === 'multiple-choice') {
                    prompt += `--- CÁC LỰA CHỌN ---\n${item.options.map((opt, i) => `${String.fromCharCode(65 + i)}. ${opt}`).join('\n')}\n\n`;
                    prompt += `--- ĐÁP ÁN ĐÚNG ---\n${String.fromCharCode(65 + item.correctAnswerIndex)}. ${item.options[item.correctAnswerIndex]}`;
                } else if (item.mappedType === 'true-false') {
                    prompt += `--- CÁC MỆNH ĐỀ & ĐÁP ÁN ---\n${item.statements.map(s => ` - ${s.statement} -> ${s.is_correct ? 'Đúng' : 'Sai'}`).join('\n')}`;
                } else {
                    prompt += `--- ĐÁP ÁN / GỢI Ý ---\n${item.answer}`;
                }
                prompt += `\n\n--- YÊU CẦU ---\nGiải thích rõ ràng tại sao đáp án lại đúng, từng bước một. Định dạng tất cả các công thức toán học bằng LaTeX.`;

                try {
                    const response = await ai.models.generateContent({ model: "gemini-2.5-flash", contents: prompt });
                    const explanationText = response.text.replace(/\n/g, '<br>');
                    item.explanation = explanationText; // Cache it
                    displayExplanation(explanationText, feedbackDiv, button);
                } catch (error) {
                    console.error("Lỗi khi tạo giải thích:", error);
                    feedbackDiv.insertAdjacentHTML('beforeend', '<div class="ai-explanation text-red-600">Lỗi: Không thể tạo giải thích.</div>');
                    button.disabled = false;
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Thử lại
                    `;
                }
            }

            function displayExplanation(explanationText, container, button) {
                container.insertAdjacentHTML('beforeend', `<div class="ai-explanation prose prose-sm">${explanationText}</div>`);
                if (window.MathJax) MathJax.typesetPromise([container]);
                button.disabled = false;
                button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    Ẩn giải thích
                `;
            }
           
            function renderStudentQuiz() {
                studentQuizContainer.innerHTML = '';
               
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});
                const groupInfo = {
                    'multiple-choice': { title: 'PHẦN I. TRẮC NGHIỆM KHÁCH QUAN', subtitle: 'Chọn đáp án đúng nhất trong các lựa chọn sau.' },
                    'true-false': { title: 'PHẦN II. CÂU HỎI ĐÚNG - SAI', subtitle: 'Xác định tính đúng hoặc sai cho mỗi mệnh đề dưới đây.' },
                    'short-answer': { title: 'PHẦN III. CÂU HỎI TRẢ LỜI NGẮN', subtitle: 'Điền đáp án ngắn gọn vào phần trả lời.' },
                    'essay': { title: 'PHẦN IV. CÂU HỎI TỰ LUẬN', subtitle: 'Trình bày chi tiết bài giải của bạn.' }
                };
               
                let questionCounter = 0;
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    const questions = grouped[partType];
                    if (!questions || questions.length === 0) return;
                   
                    let groupHTML = `<div class="group-container space-y-8 mb-12">`;
                    const info = groupInfo[partType];
                    groupHTML += `
                        <div class="group-header pb-3 border-b-2 border-slate-300 mb-6">
                            <h2 class="text-2xl font-bold text-slate-800">${info.title}</h2>
                            ${info.subtitle ? `<p class="text-md text-slate-600 italic mt-1">${info.subtitle}</p>` : ''}
                        </div>
                    `;
                    questions.forEach((item, localIndex) => {
                        const globalIndex = quizData.indexOf(item);
                        questionCounter++;
                        groupHTML += `<div class="question-card" id="student-q-${globalIndex}">`;
                        let questionText = (item.question || item.main_question || '').replace(/\n/g, '<br>');
                       
                        groupHTML += `<div class="flex items-start">
                                     <div class="flex-grow">
                                         <div class="flex items-center mb-2">
                                             <span class="font-bold text-lg mr-3 text-indigo-600">Câu ${questionCounter}:</span>
                                             <div id="q-${globalIndex}-feedback-icon"></div>
                                         </div>
                                         <div class="question-content mt-2 text-lg text-slate-700">${questionText}</div>
                                         ${item.questionImage ? `<img src="${item.questionImage}" class="mt-4 rounded-lg max-w-full md:max-w-md border shadow-sm">` : ''}
                                     </div>
                                 </div>`;
                       
                        groupHTML += `<div class="mt-6">`;
                        switch(item.mappedType) {
                            case 'multiple-choice':
                                groupHTML += `<div class="options-grid grid grid-cols-1 md:grid-cols-2 gap-4">`;
                                item.options.forEach((opt, i) => {
                                    groupHTML += `<label for="q${globalIndex}-opt${i}" id="q${globalIndex}-opt-label${i}" class="option-label flex items-start p-4 border-2 rounded-xl cursor-pointer hover:bg-indigo-50 hover:border-indigo-400">
                                                     <input type="radio" name="q${globalIndex}" id="q${globalIndex}-opt${i}" value="${i}" class="flex-shrink-0 mt-1 h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                                     <div class="ml-3 flex-grow">
                                                         <span class="font-semibold text-slate-800">${String.fromCharCode(65 + i)}.</span>
                                                         <span class="option-content text-slate-700">${opt || ''}</span>
                                                         ${(item.optionsImage && item.optionsImage[i]) ? `<img src="${item.optionsImage[i]}" class="mt-2 rounded-lg max-w-xs border shadow-sm">` : ''}
                                                     </div>
                                                 </label>`;
                                });
                                groupHTML += `</div>`;
                                break;
                            case 'true-false':
                                 groupHTML += `<div class="space-y-4">`;
                                 item.statements.forEach((s, i) => {
                                     groupHTML += `<div class="statement-item border-t pt-4">
                                                  <p class="mb-3 text-slate-700">${String.fromCharCode(97 + i)}) ${s.statement || ''}</p>
                                                  <div class="flex gap-x-6">
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="true" class="mr-2 h-4 w-4"> Đúng</label>
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="false" class="mr-2 h-4 w-4"> Sai</label>
                                                  </div>
                                              </div>`;
                                 });
                                 groupHTML += `</div>`;
                                 break;
                            case 'short-answer':
                                groupHTML += `<input type="text" name="q${globalIndex}" class="mt-1 block w-full md:w-1/2 border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Nhập đáp án của bạn...">`;
                                break;
                            case 'essay':
                                groupHTML += `<textarea name="q${globalIndex}" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" rows="5" placeholder="Nhập câu trả lời tự luận của bạn..."></textarea>`;
                                break;
                        }
                        groupHTML += `</div><div id="q-${globalIndex}-feedback" class="mt-4"></div></div>`;
                    });
                    groupHTML += `</div>`;
                    studentQuizContainer.innerHTML += groupHTML;
                });
               
                if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                    MathJax.typesetPromise([studentQuizContainer]);
                }
            }
           
            async function generatePerformanceReview(allAnswersData) {
                const feedbackContainer = document.getElementById('ai-feedback-container');
                if (!feedbackContainer || !ai) return null;
                feedbackContainer.classList.remove('hidden');
                feedbackContainer.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-slate-800 mb-4">📝 Phân Tích & Gợi Ý Từ Trợ Lý AI</h3>
                        <div id="ai-feedback-loader" class="text-center py-6">
                            <svg class="animate-spin mx-auto h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p class="mt-3 text-slate-600">AI đang phân tích bài làm của bạn...</p>
                        </div>
                        <div id="ai-feedback-summary" class="hidden prose prose-sm max-w-none"></div>
                        <div id="ai-feedback-details" class="hidden mt-4 space-y-2"></div>
                    </div>
                `;
               
                const loader = document.getElementById('ai-feedback-loader');
                const summaryDiv = document.getElementById('ai-feedback-summary');
                const detailsDiv = document.getElementById('ai-feedback-details');
                const incorrectAnswers = allAnswersData.filter(a => !a.isCorrect);
                if (incorrectAnswers.length === 0) {
                    feedbackContainer.innerHTML = `
                        <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                            <h3 class="text-xl font-bold text-green-600">🎉 Chúc mừng!</h3>
                            <p class="mt-2 text-slate-700">Bạn đã trả lời đúng tất cả các câu hỏi. Làm tốt lắm!</p>
                        </div>
                    `;
                    return { overallFeedback: { summary: "Xuất sắc! Học sinh đã đã trả lời đúng tất cả các câu hỏi." } };
                }
                const summaryPrompt = `Bạn là một trợ lý giáo viên, nói tiếng Việt. Dựa vào tóm tắt các câu trả lời sai của học sinh, hãy đưa ra một nhận xét tổng quan ngắn gọn (khoảng 3-4 câu) về năng lực của học sinh, bao gồm điểm mạnh (suy luận từ các câu làm đúng), điểm yếu (dựa trên các câu sai) và một vài gợi ý ôn tập chung. Lời văn phải khích lệ, rõ ràng.
                Tóm tắt lỗi sai:
                ${JSON.stringify(incorrectAnswers.map(a => ({ cau: a.questionNumber, loai: a.type, cauHoi: a.question.substring(0, 50) + '...' })), null, 2)}`;
                try {
                    const summaryResponse = await ai.models.generateContent({
                        model: "gemini-2.5-flash",
                        contents: summaryPrompt
                    });
                    summaryDiv.innerHTML = summaryResponse.text.replace(/\n/g, '<br>');
                    loader.classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                    detailsDiv.classList.remove('hidden'); 
                } catch (e) {
                    console.error("Lỗi khi lấy nhận xét tổng quan:", e);
                    summaryDiv.innerHTML = '<p class="text-red-600">Lỗi khi tạo nhận xét tổng quan.</p>';
                    loader.classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                }
               
                const summaryForSheet = summaryDiv.innerText.substring(0, 200) + "...";
                return { overallFeedback: { summary: summaryForSheet } };
            }
            async function handleSubmit() {
                if (isSubmitted) return;
                isSubmitted = true;
                clearInterval(timerInterval);
                
                document.querySelectorAll('input, textarea').forEach(input => input.disabled = true);
                submitBtn.classList.add('hidden');
                postSubmitOptions.classList.remove('hidden');
                if (retriesLeft > 0) {
                    retryBtn.classList.remove('hidden');
                } else {
                    retryBtn.classList.add('hidden');
                }

                const proctoringDataString = JSON.stringify(proctoringLog);

                let totalStudentScore = 0;
                let totalCorrectAnswers = 0;
                let allAnswersData = [];
                const questionCounts = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    acc[type] = (acc[type] || 0) + 1;
                    return acc;
                }, {});
                
                quizData.forEach((item, index) => {
                    let questionNumber = index + 1;
                    let answerData = { questionNumber, type: item.type };
                    switch (item.mappedType) {
                        case 'multiple-choice':
                            const selectedOption = document.querySelector(`input[name="q${index}"]:checked`);
                            const isCorrectMC = selectedOption ? parseInt(selectedOption.value) === item.correctAnswerIndex : false;
                            if (isCorrectMC) {
                                totalCorrectAnswers++;
                                if (questionCounts['multiple-choice'] > 0) {
                                   totalStudentScore += quizOptions.scoring.mc / questionCounts['multiple-choice'];
                                }
                            }
                            answerData.question = item.question;
                            answerData.options = item.options;
                            answerData.yourAnswer = selectedOption ? String.fromCharCode(65 + parseInt(selectedOption.value)) : "Không trả lời";
                            answerData.correctAnswer = String.fromCharCode(65 + item.correctAnswerIndex);
                            answerData.isCorrect = isCorrectMC;
                            break;
                        case 'true-false':
                            let correctStatementsCount = 0;
                            let yourAnswerPattern = [];
                            let correctAnswerPattern = [];
                            let details = [];
                            item.statements.forEach((s, i) => {
                                const selectedTF = document.querySelector(`input[name="q${index}-s${i}"]:checked`);
                                const studentChoice = selectedTF ? selectedTF.value === 'true' : null;
                                const isStatementCorrect = studentChoice === s.is_correct;
                               
                                if (isStatementCorrect) correctStatementsCount++;
                               
                                yourAnswerPattern.push(studentChoice === null ? '?' : (studentChoice ? 'Đ' : 'S'));
                                correctAnswerPattern.push(s.is_correct ? 'Đ' : 'S');
                                details.push({ statement: s.statement, yourChoice: studentChoice === null ? 'Không trả lời' : (studentChoice ? 'Đúng' : 'Sai'), correctChoice: s.is_correct ? 'Đúng' : 'Sai', isCorrect: isStatementCorrect });
                            });
                            
                            let scorePerTfQuestion = 0;
                            if (questionCounts['true-false'] > 0) {
                                scorePerTfQuestion = quizOptions.scoring.tf / questionCounts['true-false'];
                            }
                            let questionPoints = 0;
                            if (quizOptions.scoring.tfMethod === 'progressive') {
                                const progressivePoints = { 0: 0, 1: 0.1, 2: 0.25, 3: 0.5, 4: 1.0 };
                                questionPoints = progressivePoints[correctStatementsCount] * scorePerTfQuestion;
                            } else { // even
                                questionPoints = (correctStatementsCount / 4) * scorePerTfQuestion;
                            }
                            totalStudentScore += questionPoints;

                            if(correctStatementsCount === 4) totalCorrectAnswers++;
                            answerData.question = item.main_question;
                            answerData.yourAnswer = yourAnswerPattern.join('-');
                            answerData.correctAnswer = correctAnswerPattern.join('-');
                            answerData.isCorrect = correctStatementsCount === 4;
                            answerData.details = details;
                            break;
                       
                        case 'short-answer':
                            const saInput = document.querySelector(`input[name="q${index}"]`);
                            const studentAnswerRaw = saInput ? (saInput.value ?? '').trim() : "";
                            const correctAnswerRaw = (item.answer ?? '').toString().trim().replace(/\$/g, '');
                            let isCorrectSA = false;
                            const studentAnswerNormalized = studentAnswerRaw.replace(',', '.');
                            const correctAnswerNormalized = correctAnswerRaw.replace(',', '.');
                            if (studentAnswerNormalized.toLowerCase() === correctAnswerNormalized.toLowerCase()) {
                                isCorrectSA = true;
                            }
                             if (isCorrectSA) {
                                totalCorrectAnswers++;
                                if (questionCounts['short-answer'] > 0) {
                                   totalStudentScore += quizOptions.scoring.sa / questionCounts['short-answer'];
                                }
                            }
                            answerData.question = item.question;
                            answerData.yourAnswer = studentAnswerRaw || "Không trả lời";
                            answerData.correctAnswer = correctAnswerRaw;
                            answerData.isCorrect = isCorrectSA;
                            break;
                           
                        case 'essay':
                             const essayInput = document.querySelector(`textarea[name="q${index}"]`);
                             answerData.question = item.question;
                             answerData.yourAnswer = essayInput.value || "Không trả lời";
                             answerData.correctAnswer = item.answer;
                             answerData.isCorrect = null; // Needs manual grading
                             break;
                    }
                    allAnswersData.push(answerData);
                });
                
                const finalScore = totalStudentScore;
                
                let competencyAssessment = "Giáo viên không yêu cầu AI phân tích bài làm.";
                if (quizOptions.aiAssessment) {
                    const feedbackData = await generatePerformanceReview(allAnswersData);
                    if (feedbackData && feedbackData.overallFeedback && feedbackData.overallFeedback.summary) {
                        competencyAssessment = feedbackData.overallFeedback.summary;
                    } else {
                        competencyAssessment = "Có lỗi xảy ra trong quá trình AI phân tích bài làm.";
                    }
                }
                
                if (quizOptions.showAnswers) {
                    const totalQuestions = quizData.length;
                    resultContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg text-center">
                        <h3 class="text-2xl font-bold text-slate-800">KẾT QUẢ BÀI LÀM</h3>
                        <p class="mt-4 text-lg">Số câu đúng hoàn toàn: <span class="font-bold text-green-600">${totalCorrectAnswers}/${totalQuestions}</span></p>
                        <p class="text-2xl mt-2">Điểm (thang 10): <span class="font-bold text-blue-600">${finalScore.toFixed(2)}</span></p>
                        ${questionCounts['essay'] > 0 ? `<p class="text-sm text-gray-600 italic mt-1">Lưu ý: Điểm trên chưa bao gồm ${quizOptions.scoring.essay} điểm của phần Tự luận.</p>` : ''}
                    </div>`;
                    resultContainer.classList.remove('hidden');

                    allAnswersData.forEach((ans, index) => {
                        const questionCard = document.getElementById(`student-q-${index}`);
                        const feedbackIconDiv = document.getElementById(`q-${index}-feedback-icon`);
                        const feedbackDiv = document.getElementById(`q-${index}-feedback`);
                        if (!questionCard || !feedbackIconDiv || !feedbackDiv) return;

                        const iconHTML = ans.isCorrect === true
                            ? '<svg class="feedback-icon text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>'
                            : (ans.isCorrect === false ? '<svg class="feedback-icon text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>' : '');
                        feedbackIconDiv.innerHTML = iconHTML;

                        if (ans.type.includes('multiple-choice')) {
                            const studentChoice = ans.yourAnswer === "Không trả lời" ? -1 : ans.yourAnswer.charCodeAt(0) - 65;
                            const correctChoice = ans.correctAnswer.charCodeAt(0) - 65;
                            document.getElementById(`q-${index}-opt-label${correctChoice}`)?.classList.add('correct');
                            if (studentChoice !== -1 && studentChoice !== correctChoice) {
                                document.getElementById(`q-${index}-opt-label${studentChoice}`)?.classList.add('incorrect');
                            }
                        } else if (ans.type === 'true-false') {
                            const statementItems = questionCard.querySelectorAll('.statement-item');
                            ans.details.forEach((detail, i) => { if(statementItems[i]) { statementItems[i].classList.add(detail.isCorrect ? 'correct' : 'incorrect'); }});
                        }

                        if (quizOptions.showExplanation) {
                            feedbackDiv.innerHTML = `<button data-explain-index="${index}" class="explain-btn mt-4 flex items-center px-4 py-2 bg-blue-100 text-blue-800 text-sm font-semibold rounded-lg hover:bg-blue-200 transition-colors">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Xem giải thích
                            </button>`;
                        }
                    });
                    
                    document.querySelectorAll('.explain-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const button = e.currentTarget;
                            const index = parseInt(button.dataset.explainIndex, 10);
                            showExplanation(index, button);
                        });
                    });

                    if (window.MathJax) await window.MathJax.typesetPromise([studentQuizContainer]);
                } else {
                     resultContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg text-center"><h3 class="text-xl font-bold text-green-600">Nộp bài thành công!</h3><p class="mt-2 text-slate-700">Bạn đã hoàn thành bài làm. Kết quả sẽ được giáo viên công bố sau.</p></div>`;
                    resultContainer.classList.remove('hidden');
                }
                
                const formData = new FormData();
                formData.append('name', studentInfo.name);
                formData.append('class', studentInfo.class);
                formData.append('score', `${finalScore.toFixed(2)}/10`);
                formData.append('assessment', competencyAssessment);
                formData.append('timestamp', new Date().toLocaleString('vi-VN'));
                formData.append('examCode', correctExamCode);
                formData.append('monitoringLog', proctoringDataString);
                formData.append('answerDetails', JSON.stringify(allAnswersData));
               
                fetch(googleScriptUrl, { method: 'POST', body: formData})
                    .then(res => console.log("Successfully submitted to Google Sheet"))
                    .catch(err => console.error("Error submitting to Google Sheet:", err));
            }
           
            function startNewAttempt() {
                isSubmitted = false;
                proctoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0, suKien: [] };
                const proctoringWidget = document.getElementById('proctoring-widget');
                if (proctoringWidget) {
                    proctoringWidget.classList.add('hidden');
                    document.getElementById('tab-switch-count').textContent = '0';
                    document.getElementById('copy-count').textContent = '0';
                    document.getElementById('paste-count').textContent = '0';
                }

                renderStudentQuiz();
                resultContainer.classList.add('hidden');
                document.getElementById('ai-feedback-container').classList.add('hidden');
                postSubmitOptions.classList.add('hidden');
                submitBtn.classList.remove('hidden');
                 if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                }
                retriesLeft--;
                retriesDisplay.textContent = `Lượt làm lại còn: ${retriesLeft}`;
                window.scrollTo(0, 0);
            }
            studentInfoForm.addEventListener('submit', (e) => {
                e.preventDefault();
               
                const enteredCode = document.getElementById('exam-code').value.trim().toUpperCase();
                if (enteredCode !== correctExamCode) {
                    alert('Mã đề không chính xác. Vui lòng kiểm tra lại!');
                    return;
                }
               
                studentApiKey = teacherApiKey;
                if (!studentApiKey) {
                    console.warn('Cảnh báo: Giáo viên chưa cấu hình API Key. Các tính năng AI sẽ không hoạt động.');
                }
       
                try {
                    if (studentApiKey) {
                       ai = new GoogleGenAI({ apiKey: studentApiKey });
                    }
                } catch(e) {
                    console.error("Lỗi khởi tạo Gemini API với key của giáo viên.", e);
                    alert("Cảnh báo: API Key của giáo viên không hợp lệ. Vui lòng báo cho giáo viên. Các tính năng AI sẽ không hoạt động.");
                    ai = null;
                }
                shuffleQuiz();
               
                studentInfo.name = document.getElementById('student-name').value;
                studentInfo.class = document.getElementById('student-class').value;
                loginModal.classList.add('hidden');
                studentQuizContainer.classList.remove('hidden');
                submitBtn.classList.remove('hidden');
               
                if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                } else {
                    timerDisplay.textContent = "Không giới hạn";
                }
                retriesDisplay.textContent = `Lượt làm lại còn: ${retriesLeft}`;
                renderStudentQuiz();

                const proctoringWidget = document.getElementById('proctoring-widget');
                const tabSwitchCountEl = document.getElementById('tab-switch-count');
                const copyCountEl = document.getElementById('copy-count');
                const pasteCountEl = document.getElementById('paste-count');

                function updateProctoringUI() {
                    if (proctoringLog.thoatManHinh > 0 || proctoringLog.saoChep > 0 || proctoringLog.dan > 0) {
                        proctoringWidget.classList.remove('hidden');
                    }
                    tabSwitchCountEl.textContent = proctoringLog.thoatManHinh;
                    copyCountEl.textContent = proctoringLog.saoChep;
                    pasteCountEl.textContent = proctoringLog.dan;
                }

                // Disable Right Click
                document.addEventListener('contextmenu', e => e.preventDefault());

                // Track Tab Switching
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && !isSubmitted) {
                        proctoringLog.thoatManHinh++;
                        proctoringLog.suKien.push({ loai: 'chuyen_tab', thoiGian: new Date().toISOString() });
                        updateProctoringUI();
                    }
                });

                // Track Copying
                document.addEventListener('copy', () => {
                    if (isSubmitted) return;
                    proctoringLog.saoChep++;
                    proctoringLog.suKien.push({ loai: 'sao_chep', thoiGian: new Date().toISOString() });
                    updateProctoringUI();
                });

                // Track Pasting
                document.addEventListener('paste', () => {
                    if (isSubmitted) return;
                    proctoringLog.dan++;
                    proctoringLog.suKien.push({ loai: 'dan', thoiGian: new Date().toISOString() });
                    updateProctoringUI();
                });
            });
            
            submitBtn.addEventListener('click', handleSubmit);
            retryBtn.addEventListener('click', () => {
                shuffleQuiz();
                startNewAttempt();
            });
        </script>
    </body>
    </html>
    