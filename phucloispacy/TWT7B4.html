
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ĐỀ KIỂM TRA 10 PHÚT - TWT7B4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- MathJax -->
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #f3f4f6; }
        .latex-image { vertical-align: middle; max-width: 100%; height: auto; }
        /* Custom scrollbar for nav panel */
        #nav-grid::-webkit-scrollbar { width: 6px; }
        #nav-grid::-webkit-scrollbar-track { background: #f1f1f1; }
        #nav-grid::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        #nav-grid::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-20">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white p-2 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-gray-800 line-clamp-1">ĐỀ KIỂM TRA 10 PHÚT</h1>
                    <p class="text-xs text-gray-500">Mã đề: TWT7B4 | GV: Thầy Phúc Lợi</p>
                </div>
            </div>
            <div id="student-info-display" class="hidden md:block text-right">
                <p id="student-name-display" class="font-medium text-gray-900"></p>
            </div>
            <button id="toggle-nav-btn" class="md:hidden p-2 text-gray-600 hover:bg-gray-100 rounded-md">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
            </button>
        </div>
        <!-- Progress Bar -->
        <div id="progress-container" class="h-1 w-full bg-gray-200 hidden">
            <div id="progress-bar" class="h-1 bg-blue-600 transition-all duration-300" style="width: 0%"></div>
        </div>
    </header>

    <!-- Welcome Screen -->
    <div id="welcome-screen" class="flex-grow flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full text-center">
            <div class="mb-6">
                <img src="https://cdn-icons-png.flaticon.com/512/3407/3407038.png" alt="Exam Icon" class="w-20 h-20 mx-auto animate-bounce">
            </div>
            <h2 class="text-2xl font-bold mb-2 text-gray-800">Chào mừng bạn!</h2>
            <p class="text-gray-500 mb-6">Vui lòng nhập thông tin để bắt đầu bài thi.</p>
            
            <div class="space-y-4 text-left">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Họ và tên</label>
                    <input type="text" id="name" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-2.5" placeholder="Nguyễn Văn A">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Lớp</label>
                    <input type="text" id="class" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-2.5" placeholder="12A1">
                </div>
                
                <div id="api-key-input-container">
                    <label class="block text-sm font-medium text-gray-700 mb-1 flex items-center justify-between">
                        <span>Gemini API Key (Tùy chọn)</span>
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-blue-500 hover:underline">Lấy key</a>
                    </label>
                    <input type="password" id="student-api-key" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-2.5" placeholder="Dán API Key vào đây để xem giải thích AI">
                    <p class="text-xs text-gray-400 mt-1 italic">Nếu giáo viên đã tích hợp sẵn, bạn có thể bỏ qua.</p>
                </div>
            </div>
            
            <p id="time-status-msg" class="text-sm text-red-600 mt-4 hidden font-medium"></p>

            <button id="start-btn" class="w-full mt-8 bg-blue-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-blue-700 transition transform hover:scale-105 shadow-lg">
                BẮT ĐẦU LÀM BÀI
            </button>
        </div>
    </div>

    <!-- Quiz Screen -->
    <div id="quiz-screen" class="flex-grow flex hidden relative overflow-hidden">
        <!-- Questions Area -->
        <div class="flex-grow h-full overflow-y-auto p-4 md:p-8 md:pr-80"> <!-- Padding right to make space for fixed nav -->
            <div class="max-w-3xl mx-auto">
                 <!-- Timer Sticky Header for Mobile -->
                <div class="md:hidden sticky top-0 z-10 bg-white/90 backdrop-blur-sm p-2 mb-4 rounded-lg shadow-sm border border-gray-200 flex justify-between items-center">
                     <span class="text-sm font-semibold text-gray-600">Thời gian còn lại:</span>
                     <span id="timer-mobile" class="text-xl font-bold text-blue-600 font-mono">--:--</span>
                </div>

                <div id="questions-container" class="pb-24">
                    <!-- Questions injected here -->
                </div>
            </div>
        </div>

        <!-- Navigation Panel (Fixed Sidebar) -->
        <div id="nav-panel" class="fixed top-[64px] right-0 bottom-0 w-72 bg-white shadow-xl border-l border-gray-200 transform translate-x-full transition-transform duration-300 z-30 flex flex-col">
            <div class="p-4 border-b border-gray-200 bg-gray-50">
                <div class="text-center mb-4">
                    <p class="text-sm text-gray-500 uppercase tracking-wide">Thời gian còn lại</p>
                    <div id="timer" class="text-3xl font-bold text-blue-600 font-mono mt-1">--:--</div>
                </div>
                <div class="grid grid-cols-2 gap-2 text-center text-xs text-gray-500">
                    <div class="flex items-center justify-center gap-1"><span class="w-3 h-3 bg-gray-200 rounded-full block"></span> Chưa làm</div>
                    <div class="flex items-center justify-center gap-1"><span class="w-3 h-3 bg-green-600 rounded-full block"></span> Đã làm</div>
                </div>
            </div>
            
            <div class="flex-grow overflow-y-auto p-4">
                <div id="nav-grid" class="grid grid-cols-5 gap-2 justify-items-center">
                    <!-- Nav buttons injected here -->
                </div>
            </div>

            <div class="p-4 border-t border-gray-200 bg-gray-50">
                <button id="submit-btn" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 shadow-md transition">
                    NỘP BÀI
                </button>
            </div>
        </div>
    </div>

    <!-- Result Screen -->
    <div id="result-screen" class="flex-grow hidden p-4 overflow-y-auto">
        <div class="max-w-2xl mx-auto bg-white p-8 rounded-2xl shadow-xl">
            <div class="text-center mb-8">
                <div class="inline-block p-4 rounded-full bg-green-100 mb-4">
                    <svg class="w-12 h-12 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <h2 class="text-3xl font-bold text-gray-800">Hoàn thành bài thi!</h2>
                <p class="text-gray-500 mt-2">Cảm ơn bạn đã nỗ lực hết mình.</p>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <p class="text-sm text-blue-600 font-semibold uppercase">Họ và tên</p>
                    <p class="text-lg font-bold text-gray-800" id="result-name">---</p>
                </div>
                <div class="bg-purple-50 p-4 rounded-xl border border-purple-100">
                    <p class="text-sm text-purple-600 font-semibold uppercase">Lớp</p>
                    <p class="text-lg font-bold text-gray-800" id="result-class">---</p>
                </div>
                <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-100">
                    <p class="text-sm text-yellow-600 font-semibold uppercase">Thời gian làm bài</p>
                    <p class="text-lg font-bold text-gray-800" id="result-time">--:--</p>
                </div>
                 <div class="bg-red-50 p-4 rounded-xl border border-red-100">
                    <p class="text-sm text-red-600 font-semibold uppercase">Điểm số</p>
                    <p class="text-3xl font-bold text-red-600" id="score-display">0.00</p>
                </div>
            </div>

            <!-- AI Assessment -->
            <div id="ai-assessment-container" class="mb-8 hidden">
                <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                    <svg class="w-5 h-5 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                    Nhận xét của Trợ lý AI
                </h3>
                <div id="ai-assessment-content" class="bg-indigo-50 p-5 rounded-xl text-indigo-900 text-sm leading-relaxed border border-indigo-100 prose prose-sm max-w-none">
                    <!-- AI content here -->
                </div>
            </div>

            <div class="text-center">
                 <button id="view-answers-btn" class="text-blue-600 hover:text-blue-800 font-medium hover:underline hidden mb-6">
                    Xem đáp án chi tiết
                </button>
            </div>
            
            <div id="detailed-answers" class="hidden space-y-4 border-t pt-6">
                <!-- Details here -->
            </div>
        </div>
    </div>

    <script type="module">
        
    import { GoogleGenAI } from "https://esm.sh/@google/genai@^1.13.0";
    import confetti from "https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/+esm";

    const dom = {
        startBtn: document.getElementById('start-btn'),
        welcomeScreen: document.getElementById('welcome-screen'),
        quizScreen: document.getElementById('quiz-screen'),
        resultScreen: document.getElementById('result-screen'),
        studentNameInput: document.getElementById('name'),
        studentClassInput: document.getElementById('class'),
        studentApiKeyInput: document.getElementById('student-api-key'),
        apiKeyInputContainer: document.getElementById('api-key-input-container'),
        studentNameDisplay: document.getElementById('student-name-display'),
        questionsContainer: document.getElementById('questions-container'),
        timerDisplay: document.getElementById('timer'),
        submitBtn: document.getElementById('submit-btn'),
        scoreDisplay: document.getElementById('score-display'),
        resultName: document.getElementById('result-name'),
        resultClass: document.getElementById('result-class'),
        resultTime: document.getElementById('result-time'),
        resultCorrectCount: document.getElementById('result-correct-count'),
        detailedAnswers: document.getElementById('detailed-answers'),
        viewAnswersBtn: document.getElementById('view-answers-btn'),
        aiAssessmentContainer: document.getElementById('ai-assessment-container'),
        aiAssessmentContent: document.getElementById('ai-assessment-content'),
        navGrid: document.getElementById('nav-grid'),
        toggleNavBtn: document.getElementById('toggle-nav-btn'),
        navPanel: document.getElementById('nav-panel'),
        progressBar: document.getElementById('progress-bar'),
        progressContainer: document.getElementById('progress-container'),
        timeStatusMsg: document.getElementById('time-status-msg'),
    };

    // --- GIẢI MÃ DỮ LIU TỪ BASE64 ---
    // Điều này đảm bảo an toàn tuyệt đối cho các ký tự đặc biệt trong LaTeX và hình ảnh
    const quizData = JSON.parse(decodeURIComponent(escape(atob("W3sicXVlc3Rpb24iOiJUw6xtIG3hu5l0IG5ndXnDqm4gaMOgbSBj4bunYSBow6BtIHPhu5EgJGYoeCkgPSA0eF4zIC0gMnggKyA1JC4iLCJvcHRpb25zIjpbIiR4XjQgLSB4XjIgKyA1eCQiLCIkMTJ4XjIgLSAyJCIsIiR4XjQgLSB4XjIgKyA1eCArIEMkIiwiJHheNCAtIDJ4XjIgKyA1eCArIEMkIl0sImNvcnJlY3RBbnN3ZXJJbmRleCI6MiwidHlwZSI6Im11bHRpcGxlLWNob2ljZSIsImlzRGlydHkiOmZhbHNlLCJleHBsYW5hdGlvbiI6bnVsbCwic2h1ZmZsZU9wdGlvbnMiOnsic3RlbSI6dHJ1ZSwiYW5zd2VycyI6dHJ1ZX0sInF1ZXN0aW9uTnVtYmVyIjoxLCJpZCI6InFfMTgxNzc4NzIxMiIsInF1ZXN0aW9uU25pcHBldCI6IlTDrG0gbeG7mXQgbmd1ecOqbiBow6BtIGPhu6dhIGjDoG0gc+G7kSAkZih4KSA9IDR4XjMgLSAyeCArIDUkLiIsInJlbmRlcmVkX3F1ZXN0aW9uIjoiVMOsbSBt4buZdCBuZ3V5w6puIGjDoG0gY+G7p2EgaMOgbSBz4buRICRmKHgpID0gNHheMyAtIDJ4ICsgNSQuIiwicmVuZGVyZWRfb3B0aW9ucyI6WyIkeF40IC0geF4yICsgNXgkIiwiJDEyeF4yIC0gMiQiLCIkeF40IC0geF4yICsgNXggKyBDJCIsIiR4XjQgLSAyeF4yICsgNXggKyBDJCJdfSx7InF1ZXN0aW9uIjoiVMOsbSBt4buZdCBuZ3V5w6puIGjDoG0gY+G7p2EgaMOgbSBz4buRICRmKHgpID0gXFxkZnJhY3s0fXtcXGNvc14yIHh9ICsgNWVeeCQuIiwib3B0aW9ucyI6WyIkNFxcdGFuIHggKyA1ZV54ICsgQyQiLCIkLTRcXHRhbiB4ICsgNWVeeCArIEMkIiwiJDRcXHRhbiB4IC0gNWVeeCArIEMkIiwiJC00XFxjb3QgeCArIDVlXnggKyBDJCJdLCJjb3JyZWN0QW5zd2VySW5kZXgiOjAsInR5cGUiOiJtdWx0aXBsZS1jaG9pY2UiLCJxdWVzdGlvbk51bWJlciI6Miwic2h1ZmZsZU9wdGlvbnMiOnsic3RlbSI6dHJ1ZSwiYW5zd2VycyI6dHJ1ZX0sImlkIjoicV81MTc2MjU5NzUiLCJxdWVzdGlvblNuaXBwZXQiOiJUw6xtIG3hu5l0IG5ndXnDqm4gaMOgbSBj4bunYSBow6BtIHPhu5EgJGYoeCkgPSBcXGRmcmFjezR9e1xcY29zXjIgeH0gKyA1ZV54JC4iLCJyZW5kZXJlZF9xdWVzdGlvbiI6IlTDrG0gbeG7mXQgbmd1ecOqbiBow6BtIGPhu6dhIGjDoG0gc+G7kSAkZih4KSA9IFxcZGZyYWN7NH17XFxjb3NeMiB4fSArIDVlXngkLiIsInJlbmRlcmVkX29wdGlvbnMiOlsiJDRcXHRhbiB4ICsgNWVeeCArIEMkIiwiJC00XFx0YW4geCArIDVlXnggKyBDJCIsIiQ0XFx0YW4geCAtIDVlXnggKyBDJCIsIiQtNFxcY290IHggKyA1ZV54ICsgQyQiXX0seyJxdWVzdGlvbiI6IkNobyBow6BtIHPhu5EgJEYoeCkkIHRo4buPYSBtw6NuICRGJyh4KSA9IHheMiAtIDJ4ICsgMSQuIFTDrG0gJEYoeCkkLiIsIm9wdGlvbnMiOlsiJFxcZGZyYWN7eF4zfXszfSAtIHheMiArIHggKyBDJCIsIiQyeCAtIDIgKyBDJCIsIiR4XjMgLSAyeF4yICsgeCArIEMkIiwiJFxcZGZyYWN7eF4zfXszfSAtIHheMiArIEMkIl0sImNvcnJlY3RBbnN3ZXJJbmRleCI6MCwidHlwZSI6Im11bHRpcGxlLWNob2ljZSIsImlzRGlydHkiOmZhbHNlLCJleHBsYW5hdGlvbiI6bnVsbCwic2h1ZmZsZU9wdGlvbnMiOnsic3RlbSI6dHJ1ZSwiYW5zd2VycyI6dHJ1ZX0sInF1ZXN0aW9uTnVtYmVyIjozLCJpZCI6InFfNDgxNzg2MDY2IiwicXVlc3Rpb25TbmlwcGV0IjoiQ2hvIGjDoG0gc+G7kSAkRih4KSQgdGjhu49hIG3Do24gJEYnKHgpID0geF4yIC0gMnggKyAxJC4gVMOsbSAkRih4KSQuIiwicmVuZGVyZWRfcXVlc3Rpb24iOiJDaG8gaMOgbSBz4buRICRGKHgpJCB0aOG7j2EgbcOjbiAkRicoeCkgPSB4XjIgLSAyeCArIDEkLiBUw6xtICRGKHgpJC4iLCJyZW5kZXJlZF9vcHRpb25zIjpbIiRcXGRmcmFje3heM317M30gLSB4XjIgKyB4ICsgQyQiLCIkMnggLSAyICsgQyQiLCIkeF4zIC0gMnheMiArIHggKyBDJCIsIiRcXGRmcmFje3heM317M30gLSB4XjIgKyBDJCJdfSx7InF1ZXN0aW9uIjoiQ2hvICRGKHgpID0gM3heMyAtIDJ4XjIgKyA5JCBsw6AgbeG7mXQgbmd1ecOqbiBow6BtIGPhu6dhIGjDoG0gc+G7kSAkZih4KSQuIFTDrG0gJGYoeCkkLiIsIm9wdGlvbnMiOlsiJDl4XjIgLSA0eCQiLCIkOXheMiAtIDR4ICsgQyQiLCIkM3heNC80IC0gMnheMy8zICsgOXgkIiwiJDl4IC0gNCQiXSwiY29ycmVjdEFuc3dlckluZGV4IjowLCJ0eXBlIjoibXVsdGlwbGUtY2hvaWNlIiwiaXNEaXJ0eSI6ZmFsc2UsImV4cGxhbmF0aW9uIjpudWxsLCJzaHVmZmxlT3B0aW9ucyI6eyJzdGVtIjp0cnVlLCJhbnN3ZXJzIjp0cnVlfSwicXVlc3Rpb25OdW1iZXIiOjQsImlkIjoicV84NzYyNjg4MTEiLCJxdWVzdGlvblNuaXBwZXQiOiJDaG8gJEYoeCkgPSAzeF4zIC0gMnheMiArIDkkIGzDoCBt4buZdCBuZ3V5w6puIGjDoG0gY+G7p2EgaMOgbSBz4buRICRmKHgpJC4gVMOsbSAuLi4iLCJyZW5kZXJlZF9xdWVzdGlvbiI6IkNobyAkRih4KSA9IDN4XjMgLSAyeF4yICsgOSQgbMOgIG3hu5l0IG5ndXnDqm4gaMOgbSBj4bunYSBow6BtIHPhu5EgJGYoeCkkLiBUw6xtICRmKHgpJC4iLCJyZW5kZXJlZF9vcHRpb25zIjpbIiQ5eF4yIC0gNHgkIiwiJDl4XjIgLSA0eCArIEMkIiwiJDN4XjQvNCAtIDJ4XjMvMyArIDl4JCIsIiQ5eCAtIDQkIl19LHsicXVlc3Rpb24iOiJUw6xtIG3hu5l0IG5ndXnDqm4gaMOgbSBj4bunYSBow6BtIHPhu5EgJGYoeCkgPSA1eF40IC0gXFxmcmFjezF9e1xcc2luXjIgeH0kLiIsIm9wdGlvbnMiOlsiJHheNSArIFxcY290IHggKyBDJCIsIiQyMHheMyAtIFxcY290IHggKyBDJCIsIiR4XjUgLSBcXHRhbiB4ICsgQyQiLCIkeF41IC0gXFxjb3QgeCArIEMkIl0sImNvcnJlY3RBbnN3ZXJJbmRleCI6MCwidHlwZSI6Im11bHRpcGxlLWNob2ljZSIsImlzRGlydHkiOmZhbHNlLCJleHBsYW5hdGlvbiI6bnVsbCwic2h1ZmZsZU9wdGlvbnMiOnsic3RlbSI6dHJ1ZSwiYW5zd2VycyI6dHJ1ZX0sInF1ZXN0aW9uTnVtYmVyIjo1LCJpZCI6InFfMTEzNTYxODgxNiIsInF1ZXN0aW9uU25pcHBldCI6IlTDrG0gbeG7mXQgbmd1ecOqbiBow6BtIGPhu6dhIGjDoG0gc+G7kSAkZih4KSA9IDV4XjQgLSBcXGZyYWN7MX17XFxzaW5eMiB4fSQuIiwicmVuZGVyZWRfcXVlc3Rpb24iOiJUw6xtIG3hu5l0IG5ndXnDqm4gaMOgbSBj4bunYSBow6BtIHPhu5EgJGYoeCkgPSA1eF40IC0gXFxmcmFjezF9e1xcc2luXjIgeH0kLiIsInJlbmRlcmVkX29wdGlvbnMiOlsiJHheNSArIFxcY290IHggKyBDJCIsIiQyMHheMyAtIFxcY290IHggKyBDJCIsIiR4XjUgLSBcXHRhbiB4ICsgQyQiLCIkeF41IC0gXFxjb3QgeCArIEMkIl19LHsicXVlc3Rpb24iOiJUw6xtIG5ndXnDqm4gaMOgbSBj4bunYSBow6BtIHPhu5EgJGYoeCkgPSAzeF4yIC0gNHggKyAyJC4iLCJvcHRpb25zIjpbIiRGKHgpID0geF4zIC0gMnheMiArIDJ4ICsgQyQiLCIkRih4KSA9IHheMyAtIDR4XjIgKyAyeCArIEMkIiwiJEYoeCkgPSA2eCAtIDQgKyBDJCIsIiRGKHgpID0geF4zIC0gMnheMiArIEMkIl0sImNvcnJlY3RBbnN3ZXJJbmRleCI6MCwidHlwZSI6Im11bHRpcGxlLWNob2ljZSIsImlzRGlydHkiOmZhbHNlLCJleHBsYW5hdGlvbiI6bnVsbCwic2h1ZmZsZU9wdGlvbnMiOnsic3RlbSI6dHJ1ZSwiYW5zd2VycyI6dHJ1ZX0sInF1ZXN0aW9uTnVtYmVyIjo2LCJpZCI6InFfMTI5MzQ0NTM4IiwicXVlc3Rpb25TbmlwcGV0IjoiVMOsbSBuZ3V5w6puIGjDoG0gY+G7p2EgaMOgbSBz4buRICRmKHgpID0gM3heMiAtIDR4ICsgMiQuIiwicmVuZGVyZWRfcXVlc3Rpb24iOiJUw6xtIG5ndXnDqm4gaMOgbSBj4bunYSBow6BtIHPhu5EgJGYoeCkgPSAzeF4yIC0gNHggKyAyJC4iLCJyZW5kZXJlZF9vcHRpb25zIjpbIiRGKHgpID0geF4zIC0gMnheMiArIDJ4ICsgQyQiLCIkRih4KSA9IHheMyAtIDR4XjIgKyAyeCArIEMkIiwiJEYoeCkgPSA2eCAtIDQgKyBDJCIsIiRGKHgpID0geF4zIC0gMnheMiArIEMkIl19LHsicXVlc3Rpb24iOiJUw6xtIG5ndXnDqm4gaMOgbSBj4bunYSBow6BtIHPhu5EgJGYoeCkgPSA1XFxzaW4geCAtIDJcXGNvcyB4JC4iLCJvcHRpb25zIjpbIiRGKHgpID0gNVxcY29zIHggKyAyXFxzaW4geCArIEMkIiwiJEYoeCkgPSAtNVxcY29zIHggLSAyXFxzaW4geCArIEMkIiwiJEYoeCkgPSAtNVxcY29zIHggKyAyXFxzaW4geCArIEMkIiwiJEYoeCkgPSA1XFxjb3MgeCAtIDJcXHNpbiB4ICsgQyQiXSwiY29ycmVjdEFuc3dlckluZGV4IjoxLCJ0eXBlIjoibXVsdGlwbGUtY2hvaWNlIiwiaXNEaXJ0eSI6ZmFsc2UsImV4cGxhbmF0aW9uIjpudWxsLCJzaHVmZmxlT3B0aW9ucyI6eyJzdGVtIjp0cnVlLCJhbnN3ZXJzIjp0cnVlfSwicXVlc3Rpb25OdW1iZXIiOjcsImlkIjoicV81OTE2MjIyOTEiLCJxdWVzdGlvblNuaXBwZXQiOiJUw6xtIG5ndXnDqm4gaMOgbSBj4bunYSBow6BtIHPhu5EgJGYoeCkgPSA1XFxzaW4geCAtIDJcXGNvcyB4JC4iLCJyZW5kZXJlZF9xdWVzdGlvbiI6IlTDrG0gbmd1ecOqbiBow6BtIGPhu6dhIGjDoG0gc+G7kSAkZih4KSA9IDVcXHNpbiB4IC0gMlxcY29zIHgkLiIsInJlbmRlcmVkX29wdGlvbnMiOlsiJEYoeCkgPSA1XFxjb3MgeCArIDJcXHNpbiB4ICsgQyQiLCIkRih4KSA9IC01XFxjb3MgeCAtIDJcXHNpbiB4ICsgQyQiLCIkRih4KSA9IC01XFxjb3MgeCArIDJcXHNpbiB4ICsgQyQiLCIkRih4KSA9IDVcXGNvcyB4IC0gMlxcc2luIHggKyBDJCJdfSx7InF1ZXN0aW9uIjoiVMOsbSBuZ3V5w6puIGjDoG0gY+G7p2EgaMOgbSBz4buRICRmKHgpID0gMmVeeCArIFxcZGZyYWN7M317eH0kLiIsIm9wdGlvbnMiOlsiJEYoeCkgPSAyZV54ICsgM1xcbG4geCArIEMkIiwiJEYoeCkgPSAyZV54ICsgM1xcbG5cXGxlZnR8eFxccmlnaHR8ICsgQyQiLCIkRih4KSA9IGVeeCArIDNcXGxuXFxsZWZ0fHhcXHJpZ2h0fCArIEMkIiwiJEYoeCkgPSAyZV54IC0gXFxkZnJhY3szfXt4XjJ9ICsgQyQiXSwiY29ycmVjdEFuc3dlckluZGV4IjoxLCJ0eXBlIjoibXVsdGlwbGUtY2hvaWNlIiwiaXNEaXJ0eSI6ZmFsc2UsImV4cGxhbmF0aW9uIjpudWxsLCJzaHVmZmxlT3B0aW9ucyI6eyJzdGVtIjp0cnVlLCJhbnN3ZXJzIjp0cnVlfSwicXVlc3Rpb25OdW1iZXIiOjgsImlkIjoicV8zNDY2NzgwNzEiLCJxdWVzdGlvblNuaXBwZXQiOiJUw6xtIG5ndXnDqm4gaMOgbSBj4bunYSBow6BtIHPhu5EgJGYoeCkgPSAyZV54ICsgXFxkZnJhY3szfXt4fSQuIiwicmVuZGVyZWRfcXVlc3Rpb24iOiJUw6xtIG5ndXnDqm4gaMOgbSBj4bunYSBow6BtIHPhu5EgJGYoeCkgPSAyZV54ICsgXFxkZnJhY3szfXt4fSQuIiwicmVuZGVyZWRfb3B0aW9ucyI6WyIkRih4KSA9IDJlXnggKyAzXFxsbiB4ICsgQyQiLCIkRih4KSA9IDJlXnggKyAzXFxsblxcbGVmdHx4XFxyaWdodHwgKyBDJCIsIiRGKHgpID0gZV54ICsgM1xcbG5cXGxlZnR8eFxccmlnaHR8ICsgQyQiLCIkRih4KSA9IDJlXnggLSBcXGRmcmFjezN9e3heMn0gKyBDJCJdfSx7InF1ZXN0aW9uIjoiVMOsbSBuZ3V5w6puIGjDoG0gY+G7p2EgaMOgbSBz4buRICRmKHgpID0gNlxcc3FydHt4fSAtIFxcZGZyYWN7NH17eF4zfSQuIiwib3B0aW9ucyI6WyIkRih4KSA9IDR4XFxzcXJ0e3h9ICsgXFxkZnJhY3syfXt4XjJ9ICsgQyQiLCIkRih4KSA9IDl4XFxzcXJ0e3h9ICsgXFxkZnJhY3syfXt4XjJ9ICsgQyQiLCIkRih4KSA9IDR4XFxzcXJ0e3h9IC0gXFxkZnJhY3syfXt4XjJ9ICsgQyQiLCIkRih4KSA9IDZ4XntcXGZyYWN7M317Mn19IC0gXFxkZnJhY3sxfXt4XjR9ICsgQyQiXSwiY29ycmVjdEFuc3dlckluZGV4IjowLCJ0eXBlIjoibXVsdGlwbGUtY2hvaWNlIiwiaXNEaXJ0eSI6ZmFsc2UsImV4cGxhbmF0aW9uIjpudWxsLCJzaHVmZmxlT3B0aW9ucyI6eyJzdGVtIjp0cnVlLCJhbnN3ZXJzIjp0cnVlfSwicXVlc3Rpb25OdW1iZXIiOjksImlkIjoicV8xMzEzOTE2NTQwIiwicXVlc3Rpb25TbmlwcGV0IjoiVMOsbSBuZ3V5w6puIGjDoG0gY+G7p2EgaMOgbSBz4buRICRmKHgpID0gNlxcc3FydHt4fSAtIFxcZGZyYWN7NH17eF4zfSQuIiwicmVuZGVyZWRfcXVlc3Rpb24iOiJUw6xtIG5ndXnDqm4gaMOgbSBj4bunYSBow6BtIHPhu5EgJGYoeCkgPSA2XFxzcXJ0e3h9IC0gXFxkZnJhY3s0fXt4XjN9JC4iLCJyZW5kZXJlZF9vcHRpb25zIjpbIiRGKHgpID0gNHhcXHNxcnR7eH0gKyBcXGRmcmFjezJ9e3heMn0gKyBDJCIsIiRGKHgpID0gOXhcXHNxcnR7eH0gKyBcXGRmcmFjezJ9e3heMn0gKyBDJCIsIiRGKHgpID0gNHhcXHNxcnR7eH0gLSBcXGRmcmFjezJ9e3heMn0gKyBDJCIsIiRGKHgpID0gNnhee1xcZnJhY3szfXsyfX0gLSBcXGRmcmFjezF9e3heNH0gKyBDJCJdfSx7InF1ZXN0aW9uIjoiQmnhur90ICRGKHgpJCBsw6AgbeG7mXQgbmd1ecOqbiBow6BtIGPhu6dhIGjDoG0gc+G7kSAkZih4KSA9IDN4XjIgKyA0eCQgdsOgICRGKDEpID0gNiQuIFTDrG0gJEYoeCkkLiIsIm9wdGlvbnMiOlsiJEYoeCkgPSB4XjMgKyAyeF4yICsgMyQiLCIkRih4KSA9IHheMyArIDJ4XjIgLSAzJCIsIiRGKHgpID0geF4zICsgMnheMiArIDYkIiwiJEYoeCkgPSB4XjMgKyAyeF4yICsgQyQiXSwiY29ycmVjdEFuc3dlckluZGV4IjowLCJ0eXBlIjoibXVsdGlwbGUtY2hvaWNlIiwiaXNEaXJ0eSI6ZmFsc2UsImV4cGxhbmF0aW9uIjpudWxsLCJzaHVmZmxlT3B0aW9ucyI6eyJzdGVtIjp0cnVlLCJhbnN3ZXJzIjp0cnVlfSwicXVlc3Rpb25OdW1iZXIiOjEwLCJpZCI6InFfMTUwMDkzMDM4MyIsInF1ZXN0aW9uU25pcHBldCI6IkJp4bq/dCAkRih4KSQgbMOgIG3hu5l0IG5ndXnDqm4gaMOgbSBj4bunYSBow6BtIHPhu5EgJGYoeCkgPSAzeF4yICsgNHgkIHbDoCAkRigxKSA9Li4uIiwicmVuZGVyZWRfcXVlc3Rpb24iOiJCaeG6v3QgJEYoeCkkIGzDoCBt4buZdCBuZ3V5w6puIGjDoG0gY+G7p2EgaMOgbSBz4buRICRmKHgpID0gM3heMiArIDR4JCB2w6AgJEYoMSkgPSA2JC4gVMOsbSAkRih4KSQuIiwicmVuZGVyZWRfb3B0aW9ucyI6WyIkRih4KSA9IHheMyArIDJ4XjIgKyAzJCIsIiRGKHgpID0geF4zICsgMnheMiAtIDMkIiwiJEYoeCkgPSB4XjMgKyAyeF4yICsgNiQiLCIkRih4KSA9IHheMyArIDJ4XjIgKyBDJCJdfV0="))));
    const options = JSON.parse(decodeURIComponent(escape(atob("eyJ0aW1lTGltaXQiOjEwLCJyZXRyaWVzIjoxLCJzaG93QW5zd2VycyI6dHJ1ZSwic2hvd0V4cGxhbmF0aW9uIjp0cnVlLCJhaUFzc2Vzc21lbnQiOnRydWUsInN0YXJ0VGltZSI6IjIwMjYtMDEtMDdUMDA6MTA6MDAuMDAwWiIsImVuZFRpbWUiOm51bGwsInNob3J0QW5zd2VyRm9ybWF0IjoiZnJlZWZvcm0iLCJwb2ludHNNQyI6NSwicG9pbnRzVEYiOjIsInBvaW50c1NBIjoyLCJwb2ludHNFc3NheSI6MSwicG9pbnRzVEZNZXRob2QiOiJwcm9ncmVzc2l2ZSIsInRlYWNoZXJOYW1lIjoiVGjhuqd5IFBow7pjIEzhu6NpIn0="))));
    const encodedApiKeys = JSON.parse(decodeURIComponent(escape(atob("eyJnZW1pbmkiOiJaMlZ1TFd4aGJtY3RZMnhwWlc1MExUQTVNREExTWpZME5EYz0iLCJvcGVuYWkiOiIiLCJkZWVwc2VlayI6IiJ9"))));
    
    const googleScriptUrl = "https://script.google.com/macros/s/AKfycbxbKXO4ozh28NRzbLgEwbvCGaI2UNHF6Y1MkSjCie2GG20WUA9c2hCxVKShGPuzQC3A/exec";

    let timerInterval;
    let startTime;
    let studentAnswers = {}; 
    let monitoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0 };
    let aiClient = null;

    // --- Utility ---
    const formatTime = (seconds) => {
        const m = Math.floor(seconds / 60).toString().padStart(2, '0');
        const s = (seconds % 60).toString().padStart(2, '0');
        return `${m}:${s}`;
    };

    const mapEnglishType = (type) => {
        if (!type) return 'multiple-choice';
        if (type.startsWith('mc-') || type === 'cloze-test' || type === 'sentence-ordering' || type === 'paragraph-sentence-ordering') return 'multiple-choice';
        if (type.startsWith('tf-')) return 'true-false';
        if (type === 'sentence-transformation') return 'short-answer';
        if (type === 'paragraph-writing') return 'essay';
        return type;
    };

    function initAI() {
        let key = dom.studentApiKeyInput ? dom.studentApiKeyInput.value.trim() : '';
        if(!key && encodedApiKeys.gemini) {
             try { key = atob(encodedApiKeys.gemini); } catch(e){}
        }
        if (key) {
             try {
                aiClient = new GoogleGenAI({ apiKey: key });
             } catch(e) { console.error("AI Init Failed", e); }
        }
    }

    // --- Hàm gọi AI giải thích chi tiết ---
    window.explainQuestionWithAI = async (index) => {
        if (!aiClient) {
            alert("Chưa cấu hình API Key hoặc lỗi khởi tạo AI.");
            return;
        }
        const container = document.getElementById(`ai-explain-box-${index}`);
        if (!container) return;
        
        // Toggle visibility
        if (!container.classList.contains('hidden')) {
             container.classList.add('hidden');
             return;
        }
        
        container.classList.remove('hidden');
        container.innerHTML = '<span class="text-gray-500 italic">AI đang suy nghĩ...</span>';
        
        const q = quizData[index];
        const type = mapEnglishType(q.type);
        const questionText = (type === 'true-false') ? q.main_question : q.question;
        
        let prompt = `Bạn là một gia sư tận tâm. Hãy giải thích chi tiết, từng bước một cách dễ hiểu cho học sinh về câu hỏi sau đây:\n\nCÂU HỎI:\n${questionText}\n`;
        
        if (type === 'multiple-choice') {
            prompt += `\nCÁC LỰA CHỌN:\n`;
            q.options.forEach((opt, i) => prompt += `${String.fromCharCode(65+i)}. ${opt}\n`);
            prompt += `\nĐÁP ÁN ĐÚNG LÀ: ${String.fromCharCode(65+q.correctAnswerIndex)}`;
        } else if (type === 'true-false') {
             prompt += `\nCÁC MỆNH ĐỀ VÀ ĐÁP ÁN:\n`;
             q.statements.forEach((s, i) => prompt += `${String.fromCharCode(97+i)}) ${s.statement} -> ${s.is_correct ? 'Đúng' : 'Sai'}\n`);
        } else {
             prompt += `\nĐÁP ÁN THAM KHẢO: ${q.answer}`;
        }
        
        prompt += `\n\nHãy giải thích tại sao đáp án đó lại đúng (và tại sao các phương án khác sai nếu là trắc nghiệm). Sử dụng ngôn ngữ thân thiện, khuyến khích học tập.`;
        
        try {
            const result = await aiClient.models.generateContent({
                model: 'gemini-2.5-flash',
                contents: prompt,
            });
            const text = result.response.text;
            container.innerHTML = marked.parse(text);
            if (window.MathJax) {
                 window.MathJax.typesetPromise([container]);
            }
        } catch (e) {
            container.innerHTML = '<span class="text-red-500">Lỗi khi gọi AI: ' + e.message + '</span>';
        }
    };

    function renderQuestions() {
        dom.questionsContainer.innerHTML = '';
        dom.navGrid.innerHTML = ''; 

        // Group questions by type
        const groupedQuestions = quizData.reduce((acc, q) => {
            const type = mapEnglishType(q.type);
            if (!acc[type]) acc[type] = [];
            acc[type].push(q);
            return acc;
        }, {});

        const partTitles = {
            'multiple-choice': 'PHẦN I. TRẮC NGHIỆM',
            'true-false': 'PHẦN II. ĐÚNG/SAI',
            'short-answer': 'PHẦN III. TRẢ LỜI NGẮN',
            'essay': 'PHẦN IV. TỰ LUẬN'
        };

        const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
        let globalIndex = 0;

        partOrder.forEach(type => {
            if (groupedQuestions[type] && groupedQuestions[type].length > 0) {
                const partHeader = document.createElement('h2');
                partHeader.className = "text-xl font-bold text-gray-800 mt-6 mb-4 border-b-2 border-blue-500 pb-2";
                partHeader.textContent = partTitles[type];
                dom.questionsContainer.appendChild(partHeader);

                groupedQuestions[type].forEach((item) => {
                    globalIndex++;
                    const qIndex = quizData.indexOf(item); // Use original index
                    const div = document.createElement('div');
                    div.className = 'mb-6 p-4 bg-gray-50 rounded-lg shadow-sm border border-gray-200 relative';
                    div.id = `question-${qIndex}`;
                    
                    // --- Navigation Button ---
                    const navBtn = document.createElement('button');
                    navBtn.className = "w-8 h-8 rounded-full bg-gray-200 text-xs font-semibold text-gray-600 hover:bg-gray-300 transition-colors flex items-center justify-center";
                    navBtn.textContent = globalIndex;
                    navBtn.id = `nav-btn-${qIndex}`; // Add ID for easier selection
                    navBtn.onclick = () => {
                        document.getElementById(`question-${qIndex}`).scrollIntoView({ behavior: 'smooth', block: 'center' });
                         // Close nav on mobile if needed
                         if (window.innerWidth < 768) dom.navPanel.classList.add('translate-x-full');
                    };
                    dom.navGrid.appendChild(navBtn);
                    // --- End Nav Button ---

                    let html = `<p class="font-semibold text-gray-800 mb-3"><span class="text-blue-600">Câu ${globalIndex}:</span> ${item.rendered_question}</p>`;

                    if (type === 'multiple-choice') {
                         html += `<div class="grid grid-cols-1 md:grid-cols-2 gap-3">`;
                         item.rendered_options.forEach((opt, i) => {
                             const char = String.fromCharCode(65 + i);
                             html += `
                                <label class="flex items-start p-3 bg-white border border-gray-300 rounded-md cursor-pointer hover:bg-blue-50 transition-colors">
                                    <input type="radio" name="q${qIndex}" value="${i}" class="mt-1 mr-3 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" onchange="updateAnswer(${qIndex}, ${i}, 'multiple-choice')">
                                    <span class="font-bold mr-1 text-gray-700">${char}.</span>
                                    <span class="text-gray-600">${opt}</span>
                                </label>`;
                         });
                         html += `</div>`;
                    } else if (type === 'true-false') {
                         html += `<div class="space-y-2">`;
                         item.statements.forEach((stmt, i) => {
                             const char = String.fromCharCode(97 + i);
                             html += `
                                <div class="flex items-center justify-between p-3 bg-white border border-gray-300 rounded-md">
                                    <div class="flex items-center gap-2 flex-grow mr-4">
                                         <span class="font-bold text-gray-700">${char})</span>
                                         <span class="text-gray-600">${stmt.rendered_statement}</span>
                                    </div>
                                    <div class="flex gap-4 flex-shrink-0">
                                        <label class="inline-flex items-center cursor-pointer"><input type="radio" name="q${qIndex}_s${i}" value="true" class="form-radio text-green-600 h-4 w-4" onchange="updateAnswer(${qIndex}, {subIndex: ${i}, val: true}, 'true-false')"><span class="ml-1 text-sm font-medium text-gray-700">Đúng</span></label>
                                        <label class="inline-flex items-center cursor-pointer"><input type="radio" name="q${qIndex}_s${i}" value="false" class="form-radio text-red-600 h-4 w-4" onchange="updateAnswer(${qIndex}, {subIndex: ${i}, val: false}, 'true-false')"><span class="ml-1 text-sm font-medium text-gray-700">Sai</span></label>
                                    </div>
                                </div>`;
                         });
                         html += `</div>`;
                    } else if (type === 'short-answer' || type === 'essay') {
                         const inputType = options.shortAnswerFormat === 'form' ? 'form' : 'freeform';
                         
                         if (inputType === 'form') {
                             html += `<div class="mt-3 p-3 bg-white border border-gray-300 rounded-md">
                                <p class="text-sm text-gray-500 mb-2 italic">Điền đáp án vào các ô trống tương ứng:</p>
                                <div class="grid grid-cols-1 sm:grid-cols-4 gap-3">
                                    <div class="flex items-center gap-2"><span class="font-bold text-gray-600">a)</span> <input type="text" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-1.5" placeholder="Đáp án a" oninput="updateAnswer(${qIndex}, {subPart: 'a', val: this.value}, 'short-answer-form')"></div>
                                    <div class="flex items-center gap-2"><span class="font-bold text-gray-600">b)</span> <input type="text" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-1.5" placeholder="Đáp án b" oninput="updateAnswer(${qIndex}, {subPart: 'b', val: this.value}, 'short-answer-form')"></div>
                                    <div class="flex items-center gap-2"><span class="font-bold text-gray-600">c)</span> <input type="text" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-1.5" placeholder="Đáp án c" oninput="updateAnswer(${qIndex}, {subPart: 'c', val: this.value}, 'short-answer-form')"></div>
                                    <div class="flex items-center gap-2"><span class="font-bold text-gray-600">d)</span> <input type="text" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-1.5" placeholder="Đáp án d" oninput="updateAnswer(${qIndex}, {subPart: 'd', val: this.value}, 'short-answer-form')"></div>
                                </div>
                             </div>`;
                         } else {
                              // FIX: escape the template literal variable
                              html += `<textarea class="w-full mt-2 p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" rows="3" placeholder="Nhập câu trả lời của bạn..." oninput="updateAnswer(${qIndex}, this.value, '${type}')"></textarea>`;
                         }
                    }

                    div.innerHTML = html;
                    dom.questionsContainer.appendChild(div);
                });
                
                // --- Trigger MathJax for Questions ---
                if (window.MathJax) {
                    window.MathJax.typesetPromise([dom.questionsContainer]).catch((err) => console.error('MathJax typeset failed: ' + err.message));
                }
            }
        });
    }

    // --- Global Function for Inline Event Handlers ---
    window.updateAnswer = (qIndex, value, type) => {
        if (type === 'true-false') {
            if (!studentAnswers[qIndex]) studentAnswers[qIndex] = {};
            studentAnswers[qIndex][value.subIndex] = value.val;
        } else if (type === 'short-answer-form') {
            if (!studentAnswers[qIndex]) studentAnswers[qIndex] = {};
            studentAnswers[qIndex][value.subPart] = value.val;
        } else {
            studentAnswers[qIndex] = value;
        }
        
        // Update Nav Button State
        // Check if answered based on type
        let isAnswered = false;
        if (type === 'true-false') {
             // Considered answered if at least one sub-part is answered
             isAnswered = Object.keys(studentAnswers[qIndex] || {}).length > 0;
        } else if (type === 'short-answer-form') {
             isAnswered = Object.values(studentAnswers[qIndex] || {}).some(v => v.trim() !== '');
        } else {
             isAnswered = value !== undefined && value !== '' && value !== null;
        }

        const btn = document.getElementById(`nav-btn-${qIndex}`);
        if (btn) {
            if (isAnswered) {
                // Remove default gray styles
                btn.classList.remove('bg-gray-200', 'text-gray-600');
                // Add answered green styles
                btn.classList.add('bg-green-600', 'text-white');
            } else {
                // Revert to default
                btn.classList.add('bg-gray-200', 'text-gray-600');
                btn.classList.remove('bg-green-600', 'text-white');
            }
        }
        
        // Update Progress Bar
        const totalQ = quizData.length;
        const answeredCount = Object.keys(studentAnswers).filter(k => {
             const ans = studentAnswers[k];
             if (typeof ans === 'object') return Object.keys(ans).length > 0; 
             return ans !== undefined && ans !== '';
        }).length;
        const percent = (answeredCount / totalQ) * 100;
        dom.progressBar.style.width = `${percent}%`;
    };

    function startTimer() {
        let timeLeft = options.timeLimit * 60;
        
        // Time restriction check
        const now = new Date();
        const start = options.startTime ? new Date(options.startTime) : null;
        const end = options.endTime ? new Date(options.endTime) : null;

        if (start && now < start) {
            alert(`Bài thi chưa mở. Vui lòng quay lại vào ${start.toLocaleString()}.`);
            location.reload();
            return;
        }
        if (end && now > end) {
             alert(`Bài thi đã kết thúc vào ${end.toLocaleString()}.`);
             return;
        }
        
        // Adjust time limit if end time is near
        if (end) {
            const secondsUntilEnd = Math.floor((end - now) / 1000);
            if (options.timeLimit === 0 || secondsUntilEnd < timeLeft) {
                timeLeft = secondsUntilEnd;
            }
        }
        
        if (options.timeLimit === 0 && !end) {
             dom.timerDisplay.textContent = "∞";
             return;
        }

        timerInterval = setInterval(() => {
            timeLeft--;
            dom.timerDisplay.textContent = formatTime(timeLeft);
            
            if (timeLeft <= 300) { // 5 mins left
                 dom.timerDisplay.classList.add('text-red-600', 'animate-pulse');
            }

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                alert("Hết giờ làm bài!");
                submitExam(true);
            }
        }, 1000);
    }

    async function submitExam(autoSubmit = false) {
        if (!autoSubmit && !confirm("Bạn có chắc chắn muốn nộp bài không?")) return;
        
        clearInterval(timerInterval);
        const endTime = new Date();
        const timeSpent = Math.floor((endTime - startTime) / 1000);
        
        // Scoring
        let score = 0;
        let correctCount = 0;
        let totalMaxScore = 0;
        
        // Scoring weights (default if not provided)
        const weights = {
            'multiple-choice': options.pointsMC || 0,
            'true-false': options.pointsTF || 0,
            'short-answer': options.pointsSA || 0,
            'essay': options.pointsEssay || 0
        };
        
        const answerDetailsForSheet = []; // To store simplified details for Google Sheet

        quizData.forEach((q, index) => {
            const type = mapEnglishType(q.type);
            const studentAns = studentAnswers[index];
            const maxPoints = weights[type]; // Points for the whole question
            
            let isCorrect = false;
            let qScore = 0;

            if (type === 'multiple-choice') {
                totalMaxScore += maxPoints;
                if (studentAns == q.correctAnswerIndex) { // Loose equality for string/number
                    isCorrect = true;
                    qScore = maxPoints;
                    correctCount++;
                }
                answerDetailsForSheet.push({
                    questionNumber: q.questionNumber,
                    questionId: q.id,
                    questionSnippet: q.questionSnippet,
                    isCorrect: isCorrect,
                    type: type
                });

            } else if (type === 'true-false') {
                totalMaxScore += maxPoints;
                // TF scoring: Progressive or Even
                const method = options.pointsTFMethod || 'even';
                let correctSubCount = 0;
                const totalSub = q.statements.length;
                const subDetails = [];

                q.statements.forEach((stmt, sIdx) => {
                     const ans = studentAns ? studentAns[sIdx] : undefined;
                     // Convert string 'true'/'false' to boolean if needed, though radio value is string
                     const boolAns = ans === 'true' || ans === true; 
                     // Check if answered
                     if (ans !== undefined && boolAns === stmt.is_correct) {
                         correctSubCount++;
                         subDetails.push({id: sIdx, isCorrect: true});
                     } else {
                         subDetails.push({id: sIdx, isCorrect: false});
                     }
                });

                if (method === 'even') {
                    qScore = (correctSubCount / totalSub) * maxPoints;
                } else { // Progressive: 1->0.1, 2->0.25, 3->0.5, 4->1.0 (approx scaled)
                     // Scaling standard 4-item TF question to maxPoints
                     // Standard: 0.1, 0.25, 0.5, 1.0 points for 1, 2, 3, 4 correct.
                     // We scale this ratio to maxPoints.
                     const ratios = [0, 0.1, 0.25, 0.5, 1.0];
                     const ratio = ratios[correctSubCount] || 0;
                     qScore = ratio * maxPoints;
                }
                
                // For overall stats, considered 'correct' if full marks? Or just tracking score?
                // Let's mark as correct if score > 0 for now in simple counter
                if (qScore > 0) correctCount += (qScore/maxPoints); // Fractional correct count
                
                answerDetailsForSheet.push({
                    questionNumber: q.questionNumber,
                    questionId: q.id,
                    questionSnippet: q.questionSnippet,
                    type: type,
                    details: subDetails, // Array of {isCorrect}
                    score: qScore
                });

            } else if (type === 'short-answer') {
                 totalMaxScore += maxPoints;
                 // Simple exact match ignoring case/spaces
                 
                 let textAns = "";
                 if (typeof studentAns === 'object') {
                     textAns = Object.values(studentAns).join(', ');
                 } else {
                     textAns = studentAns || "";
                 }
                 
                 const correctText = q.answer || "";
                 // Clean both
                 const cleanStudent = String(textAns).toLowerCase().replace(/\s+/g, '').trim();
                 const cleanCorrect = String(correctText).toLowerCase().replace(/\s+/g, '').trim();
                 
                 if (cleanStudent && cleanCorrect.includes(cleanStudent)) {
                      isCorrect = true;
                      qScore = maxPoints;
                      correctCount++;
                 }
                 
                 answerDetailsForSheet.push({
                    questionNumber: q.questionNumber,
                    questionId: q.id,
                    questionSnippet: q.questionSnippet,
                    isCorrect: isCorrect,
                    type: type
                });

            } else { // Essay
                 // Manual grading usually.
                 // Score 0 for auto-grade.
                 answerDetailsForSheet.push({
                    questionNumber: q.questionNumber,
                    questionId: q.id,
                    questionSnippet: q.questionSnippet,
                    type: type,
                    isCorrect: 'manual'
                });
            }

            score += qScore;
        });
        
        // Scale score to 10
        // If totalMaxScore is set in config (e.g. sum of points per section), use it.
        // The config points are "Total points for Section".
        // Calculate theoretical max:
        // Theoretical Max = (PointsMC) + (PointsTF) + (PointsSA) + (PointsEssay)
        // Ensure not divide by zero
        if (totalMaxScore === 0) totalMaxScore = 10; 
        const finalScore = (score / totalMaxScore) * 10;

        // --- Render Result Screen ---
        dom.quizScreen.classList.add('hidden');
        dom.resultScreen.classList.remove('hidden');
        
        dom.resultName.textContent = dom.studentNameInput.value;
        dom.resultClass.textContent = dom.studentClassInput.value;
        dom.resultTime.textContent = formatTime(timeSpent);
        dom.scoreDisplay.textContent = finalScore.toFixed(2);
        
        // --- Detailed Answers ---
        if (options.showAnswers) {
            dom.viewAnswersBtn.classList.remove('hidden');
            let detailsHTML = '';
            quizData.forEach((q, index) => {
                 const type = mapEnglishType(q.type);
                 const studentAns = studentAnswers[index];
                 
                 let statusHtml = '';
                 let studentAnsDisplay = '';
                 let correctAnsDisplay = '';

                 if (type === 'multiple-choice') {
                      const isCorrect = studentAns == q.correctAnswerIndex;
                      statusHtml = isCorrect ? '<span class="text-green-600 font-bold">Đúng</span>' : '<span class="text-red-600 font-bold">Sai</span>';
                      studentAnsDisplay = studentAns !== undefined ? String.fromCharCode(65 + parseInt(studentAns)) : 'Chưa chọn';
                      correctAnsDisplay = String.fromCharCode(65 + q.correctAnswerIndex);
                 } else if (type === 'true-false') {
                      // Show detail table
                      statusHtml = '<span class="text-blue-600 font-bold">Chi tiết bên dưới</span>';
                      studentAnsDisplay = 'Xem bảng';
                      correctAnsDisplay = 'Xem bảng';
                 } else {
                      studentAnsDisplay = typeof studentAns === 'object' ? JSON.stringify(studentAns) : (studentAns || 'Chưa trả lời');
                      correctAnsDisplay = q.answer || 'Đang cập nhật';
                      statusHtml = '<span class="text-gray-500">Tự chấm</span>';
                 }

                 detailsHTML += `
                    <div class="mb-4 p-4 border rounded-lg bg-gray-50">
                        <p class="font-bold text-gray-800">Câu ${index + 1}: ${statusHtml}</p>
                        <div class="ml-4 mt-2 text-sm">
                             ${q.rendered_question}
                             <div class="mt-2 grid grid-cols-2 gap-4">
                                 <div><span class="font-semibold">Bạn chọn:</span> ${studentAnsDisplay}</div>
                                 <div><span class="font-semibold">Đáp án:</span> ${correctAnsDisplay}</div>
                             </div>`;
                 
                 if (type === 'true-false') {
                     detailsHTML += `<table class="w-full mt-2 text-sm border-collapse border border-gray-300">
                        <tr class="bg-gray-200"><th class="border p-1">Ý</th><th class="border p-1">Bạn chọn</th><th class="border p-1">Đáp án</th></tr>`;
                     q.statements.forEach((s, i) => {
                         const char = String.fromCharCode(97 + i);
                         const sAns = studentAnswers[index] ? studentAnswers[index][i] : undefined;
                         const sBool = sAns === 'true' || sAns === true;
                         const isS_Correct = sAns !== undefined && sBool === s.is_correct;
                         const color = isS_Correct ? 'text-green-600' : 'text-red-600';
                         detailsHTML += `<tr>
                            <td class="border p-1 text-center">${char}</td>
                            <td class="border p-1 text-center ${color}">${sAns === undefined ? '-' : (sBool ? 'Đ' : 'S')}</td>
                            <td class="border p-1 text-center font-bold">${s.is_correct ? 'Đ' : 'S'}</td>
                         </tr>`;
                     });
                     detailsHTML += `</table>`;
                 }

                 if (options.showExplanation) {
                      if (q.rendered_answer) {
                          detailsHTML += `<div class="mt-2 p-2 bg-blue-50 text-blue-800 rounded text-sm"><strong>Giải thích:</strong> ${q.rendered_answer}</div>`;
                      }
                      // Thêm nút hỏi AI
                      if (aiClient) {
                         detailsHTML += `<button onclick="explainQuestionWithAI(${index})" class="mt-2 text-xs bg-purple-100 text-purple-700 px-3 py-1.5 rounded-md hover:bg-purple-200 transition-colors flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                                🤖 AI Hướng dẫn giải chi tiết
                             </button>
                             <div id="ai-explain-box-${index}" class="hidden mt-2 p-3 bg-purple-50 border border-purple-100 rounded text-sm text-gray-800 leading-relaxed"></div>`;
                      }
                 }

                 detailsHTML += `</div></div>`;
            });
            dom.detailedAnswers.innerHTML = detailsHTML;
            // --- Trigger MathJax for Detailed Answers ---
            if (window.MathJax) {
                window.MathJax.typesetPromise([dom.detailedAnswers]).catch((err) => console.error('MathJax typeset failed: ' + err.message));
            }
        }

        // --- AI Assessment ---
        let aiAssessmentText = "Chưa có đánh giá.";
        if (options.aiAssessment && aiClient) {
            dom.aiAssessmentContainer.classList.remove('hidden');
            dom.aiAssessmentContent.textContent = "AI đang phân tích bài làm của bạn...";
            
            const prompt = `Bạn là một giáo viên tận tâm. Hãy nhận xét ngắn gọn, súc tích và khích lệ về bài làm của học sinh dựa trên kết quả sau:
            - Điểm số: ${finalScore.toFixed(2)}/10.
            - Thời gian làm bài: ${formatTime(timeSpent)}.
            - Số câu đúng (ước lượng): ${correctCount} (Lưu ý: câu Đ/S tính theo tỉ lệ).
            - Hành vi làm bài (nếu có gian lận): Thoát màn hình ${monitoringLog.thoatManHinh} lần.
            
            Hãy đưa ra lời khuyên cụ thể để em ấy tiến bộ hơn.`;

            try {
                const result = await aiClient.models.generateContent({
                    model: 'gemini-2.5-flash',
                    contents: prompt,
                });
                aiAssessmentText = result.text; // CORRECTED from result.response.text()
                dom.aiAssessmentContent.innerHTML = marked.parse(aiAssessmentText); // Use marked if available, or simple text
                // --- Trigger MathJax for AI Assessment ---
                if (window.MathJax) {
                    window.MathJax.typesetPromise([dom.aiAssessmentContent]).catch((err) => console.error('MathJax typeset failed: ' + err.message));
                }
            } catch (error) {
                console.error("AI Error:", error);
                dom.aiAssessmentContent.textContent = "Không thể tải nhận xét từ AI lúc này.";
                aiAssessmentText = "Lỗi kết nối AI.";
            }
        }
        
        // --- Send Data to Google Sheet ---
        if (googleScriptUrl) {
            const payload = {
                timestamp: new Date().toISOString(),
                name: dom.studentNameInput.value,
                class: dom.studentClassInput.value,
                score: finalScore.toFixed(2),
                assessment: aiAssessmentText,
                examCode: "TWT7B4",
                monitoringLog: JSON.stringify(monitoringLog),
                answerDetails: JSON.stringify(answerDetailsForSheet)
            };
            
            // Use no-cors mode for Google Script Web App usually, but fetch might fail silently.
            // Best practice is redirect or image pixel if CORS is an issue, but standard fetch works with correct GAS setup.
            try {
                await fetch(googleScriptUrl, {
                    method: 'POST',
                    mode: 'no-cors', // Important for GAS
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                console.log("Data sent to sheet");
            } catch (e) {
                console.error("Sheet Error:", e);
            }
        }
        
        if (finalScore >= 5) {
             confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        }
    }

    // --- Monitoring ---
    document.addEventListener("visibilitychange", () => {
        if (document.hidden && !dom.quizScreen.classList.contains('hidden')) {
            monitoringLog.thoatManHinh++;
        }
    });
    window.addEventListener("blur", () => {
         if (!dom.quizScreen.classList.contains('hidden')) {
            monitoringLog.thoatManHinh++;
        }
    });
    document.addEventListener("copy", () => { if (!dom.quizScreen.classList.contains('hidden')) monitoringLog.saoChep++; });
    document.addEventListener("paste", () => { if (!dom.quizScreen.classList.contains('hidden')) monitoringLog.dan++; });

    // --- Init ---
    dom.startBtn.addEventListener('click', () => {
        if (!dom.studentNameInput.value || !dom.studentClassInput.value) {
            alert("Vui lòng nhập họ tên và lớp!");
            return;
        }
        // Check start/end time again strictly
        const now = new Date();
        if (options.startTime && now < new Date(options.startTime)) {
            alert("Chưa đến giờ làm bài.");
            return;
        }
        if (options.endTime && now > new Date(options.endTime)) {
             alert("Đã hết giờ làm bài.");
             return;
        }

        initAI();
        dom.studentNameDisplay.textContent = `${dom.studentNameInput.value} - ${dom.studentClassInput.value}`;
        dom.welcomeScreen.classList.add('hidden');
        dom.quizScreen.classList.remove('hidden');
        
        // Show/Hide Nav Panel based on screen size
        if (window.innerWidth >= 768) {
            dom.navPanel.classList.remove('translate-x-full');
        }

        renderQuestions();
        startTime = new Date();
        startTimer();
    });

    dom.submitBtn.addEventListener('click', () => submitExam(false));
    
    dom.toggleNavBtn.addEventListener('click', () => {
        dom.navPanel.classList.toggle('translate-x-full');
    });

    dom.viewAnswersBtn.addEventListener('click', () => {
        dom.detailedAnswers.classList.toggle('hidden');
        dom.viewAnswersBtn.textContent = dom.detailedAnswers.classList.contains('hidden') ? 'Xem đáp án chi tiết' : 'Ẩn đáp án';
    });
    
    // Check time on load
    if (options.startTime) {
        const start = new Date(options.startTime);
        if (new Date() < start) {
            dom.timeStatusMsg.textContent = `Bài thi sẽ mở lúc: ${start.toLocaleString()}`;
            dom.timeStatusMsg.classList.remove('hidden');
            dom.startBtn.disabled = true;
            dom.startBtn.classList.add('opacity-50', 'cursor-not-allowed');
            
            // Auto-enable button when time comes
            const timeToWait = start - new Date();
            if (timeToWait < 86400000) { // Only set timeout if less than 24h
                setTimeout(() => {
                    dom.timeStatusMsg.textContent = "Đã đến giờ làm bài!";
                    dom.timeStatusMsg.classList.replace('text-red-600', 'text-green-600');
                    dom.startBtn.disabled = false;
                    dom.startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }, timeToWait);
            }
        }
    }
    
    </script>
</body>
</html>