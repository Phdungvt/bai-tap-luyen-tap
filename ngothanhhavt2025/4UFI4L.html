
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bài kiểm tra - 24/11/2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f5f7; }
        .option.selected { border-color: #3b82f6; background-color: #eff6ff; }
        .option.correct { border-color: #22c55e; background-color: #f0fdf4; }
        .option.incorrect { border-color: #ef4444; background-color: #fef2f2; }
        .disabled { pointer-events: none; opacity: 0.7; }
        .monitoring-warning { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background-color: #ef4444; color: white; padding: 10px 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; display: none; animation: fade-in-out 5s ease-in-out; }
        @keyframes fade-in-out { 0%, 100% { opacity: 0; transform: translate(-50%, -20px); } 10%, 90% { opacity: 1; transform: translate(-50%, 0); } }
        /* MathJax basic styling */
        mjx-container { display: inline-block !important; }
        .prose img.latex-image { display: inline-block; vertical-align: middle; }
        
        /* Progress Bar */
        .progress-container { position: fixed; top: 0; left: 0; width: 100%; height: 4px; background: #e5e7eb; z-index: 50; }
        .progress-bar { height: 100%; background: #2563eb; transition: width 0.3s; width: 0%; }

        /* Navigation Panel */
        .nav-panel {
            position: fixed; right: 0; top: 0; bottom: 0; width: 260px;
            background: white; box-shadow: -2px 0 8px rgba(0,0,0,0.1);
            z-index: 40; overflow-y: auto; padding-top: 60px;
            transform: translateX(100%); transition: transform 0.3s ease-in-out;
        }
        .nav-panel.open { transform: translateX(0); }
        .nav-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; padding: 16px; }
        .nav-btn {
            width: 36px; height: 36px; border-radius: 6px; border: 1px solid #d1d5db;
            background: white; color: #374151; font-size: 14px; font-weight: 600;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .nav-btn:hover { border-color: #3b82f6; color: #3b82f6; }
        .nav-btn.answered { background-color: #3b82f6; color: white; border-color: #3b82f6; }
        .nav-btn.current { border-color: #f59e0b; color: #f59e0b; border-width: 2px; }

        /* Layout Adjustment for Nav Panel */
        #app { transition: margin-right 0.3s ease-in-out; }
        body.nav-open #app { margin-right: 260px; }
        
        @media (max-width: 1024px) {
            body.nav-open #app { margin-right: 0; } /* On mobile, nav covers content */
        }

        #toggle-nav-btn {
            position: fixed; right: 20px; bottom: 20px; width: 50px; height: 50px;
            background: #3b82f6; color: white; border-radius: 50%;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.4);
            display: flex; align-items: center; justify-content: center;
            z-index: 50; cursor: pointer; transition: transform 0.2s;
        }
        #toggle-nav-btn:hover { transform: scale(1.1); }
    </style>
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$']], displayMath: [['$$', '$$']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    <script type="importmap">
    { "imports": { "@google/genai": "https://esm.sh/@google/genai@^1.13.0" } }
    </script>
</head>
<body class="p-4 md:p-8">
    <div id="progress-container" class="progress-container hidden"><div id="progress-bar" class="progress-bar"></div></div>
    
    <button id="toggle-nav-btn" class="hidden">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" />
        </svg>
    </button>

    <div id="nav-panel" class="nav-panel">
        <div class="px-4 py-2 border-b bg-gray-50">
            <h3 class="font-bold text-gray-700">Danh sách câu hỏi</h3>
            <div class="flex items-center gap-4 mt-2 text-xs text-gray-500">
                <div class="flex items-center gap-1"><div class="w-3 h-3 border rounded bg-white"></div> Chưa làm</div>
                <div class="flex items-center gap-1"><div class="w-3 h-3 rounded bg-blue-500"></div> Đã làm</div>
            </div>
        </div>
        <div id="nav-grid" class="nav-grid"></div>
    </div>

    <div id="app" class="max-w-4xl mx-auto bg-white p-6 rounded-2xl shadow-lg">
        
        <div id="welcome-screen">
            <h1 class="text-3xl font-bold text-gray-800">Bài kiểm tra - 24/11/2025</h1>
            <p class="mt-2 text-gray-600">Mã đề: <span class="font-bold text-indigo-600">4UFI4L</span></p>
            <hr class="my-6">
            <div class="space-y-4">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">Họ và tên</label>
                    <input type="text" id="name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="class" class="block text-sm font-medium text-gray-700">Lớp</label>
                    <input type="text" id="class" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>
             <p class="mt-4 text-sm text-red-600"><strong>Lưu ý:</strong> Hệ thống sẽ giám sát việc chuyển tab, sao chép/dán. Các hành vi này sẽ được ghi lại và báo cáo cho giáo viên.</p>
            <button id="start-btn" class="mt-6 w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-indigo-700">Bắt đầu làm bài</button>
        </div>

        <div id="quiz-screen" class="hidden">
             <div class="flex justify-between items-center mb-4 sticky top-0 bg-white py-4 z-10 border-b -mx-6 px-6 shadow-sm">
                <h2 class="text-2xl font-bold text-gray-800 truncate max-w-[60%]">Bài kiểm tra - 24/11/2025</h2>
                <div id="timer" class="text-xl font-bold text-red-500 bg-red-100 px-4 py-2 rounded-lg whitespace-nowrap"></div>
            </div>
            <div id="all-questions-container" class="mt-6"></div>
            <div class="mt-8 flex justify-end">
                <button id="submit-btn" class="bg-green-600 text-white py-3 px-8 rounded-lg font-semibold hover:bg-green-700 text-lg">Nộp bài</button>
            </div>
        </div>

        <div id="results-screen" class="hidden">
            <h2 class="text-3xl font-bold text-center text-gray-800">Kết quả bài làm</h2>
            <div id="score-display" class="hidden text-center text-5xl font-bold text-blue-600 my-6"></div>
            <div id="assessment-display" class="hidden mt-4 p-4 bg-gray-100 rounded-lg text-gray-700"></div>
            <div id="review-container" class="mt-8"></div>
            <div class="mt-8 text-center space-x-4">
                <button id="retry-btn" class="hidden bg-indigo-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-indigo-700">Làm lại bài</button>
                <button id="restart-btn" class="bg-gray-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-gray-600">Về trang chủ</button>
            </div>
        </div>
        
        <div id="monitoring-warning" class="monitoring-warning">⚠️ Đã phát hiện hành vi không hợp lệ!</div>
    </div>

    <script type="module">
        import { GoogleGenAI } from "@google/genai";

        const API_KEY = "AIzaSyAh0vTRtwim78hSNczxmy2HWNy9R_rRZtU";
        const quizData = [{"question":"Cho mẫu số liệu ghép nhóm về chiều cao của 100 học sinh (đơn vị: cm) như sau:\n\n$$ \n\\begin{array}{|c|c|}\n\\hline\n\\text{Chiều cao} & \\text{Số học sinh} \\\\\n\\hline\n[150; 155) & 10 \\\\\n\\hline\n[155; 160) & 25 \\\\\n\\hline\n[160; 165) & 40 \\\\\n\\hline\n[165; 170) & 15 \\\\\n\\hline\n[170; 175) & 10 \\\\\n\\hline\n\\end{array}\n$$\n\nTính phương sai của mẫu số liệu trên (làm tròn đến chữ số thập phân thứ hai).","options":["30.25","36.50","42.75","49.00"],"correctAnswerIndex":3,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Cho mẫu số liệu ghép nhóm về chiều cao của 100 học sinh (đơn vị: cm) như sau:<br><br>$$ <br>\\begin{array}{|c|c|}<br>\\hline<br>\\text{Chiều cao} & \\text{Số học sinh} \\\\<br>\\hline<br>[150; 155) & 10 \\\\<br>\\hline<br>[155; 160) & 25 \\\\<br>\\hline<br>[160; 165) & 40 \\\\<br>\\hline<br>[165; 170) & 15 \\\\<br>\\hline<br>[170; 175) & 10 \\\\<br>\\hline<br>\\end{array}<br>$$<br><br>Tính phương sai của mẫu số liệu trên (làm tròn đến chữ số thập phân thứ hai).","rendered_options":["30.25","36.50","42.75","49.00"]},{"question":"Điểm kiểm tra môn Toán của một nhóm học sinh được cho dưới dạng mẫu số liệu ghép nhóm sau:\n\n$$ \n\\begin{array}{|c|c|}\n\\hline\n\\text{Điểm số} & \\text{Số học sinh} \\\\\n\\hline\n[4; 5) & 5 \\\\\n\\hline\n[5; 6) & 10 \\\\\n\\hline\n[6; 7) & 15 \\\\\n\\hline\n[7; 8) & 8 \\\\\n\\hline\n[8; 9) & 2 \\\\\n\\hline\n\\end{array}\n$$\n\nTính độ lệch chuẩn của mẫu số liệu trên (làm tròn đến chữ số thập phân thứ hai).","options":["1.05","1.15","1.25","1.35"],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Điểm kiểm tra môn Toán của một nhóm học sinh được cho dưới dạng mẫu số liệu ghép nhóm sau:<br><br>$$ <br>\\begin{array}{|c|c|}<br>\\hline<br>\\text{Điểm số} & \\text{Số học sinh} \\\\<br>\\hline<br>[4; 5) & 5 \\\\<br>\\hline<br>[5; 6) & 10 \\\\<br>\\hline<br>[6; 7) & 15 \\\\<br>\\hline<br>[7; 8) & 8 \\\\<br>\\hline<br>[8; 9) & 2 \\\\<br>\\hline<br>\\end{array}<br>$$<br><br>Tính độ lệch chuẩn của mẫu số liệu trên (làm tròn đến chữ số thập phân thứ hai).","rendered_options":["1.05","1.15","1.25","1.35"]},{"question":"Thời gian (phút) hoàn thành một bài kiểm tra của một nhóm học sinh được cho như sau:\n\n$$ \n\\begin{array}{|c|c|}\n\\hline\n\\text{Thời gian} & \\text{Số học sinh} \\\\\n\\hline\n[20; 25) & 8 \\\\\n\\hline\n[25; 30) & 12 \\\\\n\\hline\n[30; 35) & 15 \\\\\n\\hline\n[35; 40) & 5 \\\\\n\\hline\n\\end{array}\n$$\n\nTìm phương sai của mẫu số liệu ghép nhóm trên (làm tròn đến chữ số thập phân thứ hai).","options":["20.25","22.50","24.75","27.00"],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Thời gian (phút) hoàn thành một bài kiểm tra của một nhóm học sinh được cho như sau:<br><br>$$ <br>\\begin{array}{|c|c|}<br>\\hline<br>\\text{Thời gian} & \\text{Số học sinh} \\\\<br>\\hline<br>[20; 25) & 8 \\\\<br>\\hline<br>[25; 30) & 12 \\\\<br>\\hline<br>[30; 35) & 15 \\\\<br>\\hline<br>[35; 40) & 5 \\\\<br>\\hline<br>\\end{array}<br>$$<br><br>Tìm phương sai của mẫu số liệu ghép nhóm trên (làm tròn đến chữ số thập phân thứ hai).","rendered_options":["20.25","22.50","24.75","27.00"]},{"question":"Số lượng sản phẩm bán được hàng ngày của một cửa hàng trong một tháng được thống kê như sau:\n\n$$ \n\\begin{array}{|c|c|}\n\\hline\n\\text{Số lượng sản phẩm} & \\text{Số ngày} \\\\\n\\hline\n[10; 20) & 5 \\\\\n\\hline\n[20; 30) & 10 \\\\\n\\hline\n[30; 40) & 8 \\\\\n\\hline\n[40; 50) & 7 \\\\\n\\hline\n\\end{array}\n$$\n\nTính độ lệch chuẩn của mẫu số liệu ghép nhóm này (làm tròn đến chữ số thập phân thứ hai).","options":["9.86","10.24","10.58","10.92"],"correctAnswerIndex":3,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Số lượng sản phẩm bán được hàng ngày của một cửa hàng trong một tháng được thống kê như sau:<br><br>$$ <br>\\begin{array}{|c|c|}<br>\\hline<br>\\text{Số lượng sản phẩm} & \\text{Số ngày} \\\\<br>\\hline<br>[10; 20) & 5 \\\\<br>\\hline<br>[20; 30) & 10 \\\\<br>\\hline<br>[30; 40) & 8 \\\\<br>\\hline<br>[40; 50) & 7 \\\\<br>\\hline<br>\\end{array}<br>$$<br><br>Tính độ lệch chuẩn của mẫu số liệu ghép nhóm này (làm tròn đến chữ số thập phân thứ hai).","rendered_options":["9.86","10.24","10.58","10.92"]},{"question":"Cho bảng số liệu về cân nặng (kg) của một nhóm trẻ em như sau:\n\n$$ \n\\begin{array}{|c|c|}\n\\hline\n\\text{Cân nặng} & \\text{Số trẻ} \\\\\n\\hline\n[15; 18) & 6 \\\\\n\\hline\n[18; 21) & 10 \\\\\n\\hline\n[21; 24) & 8 \\\\\n\\hline\n[24; 27) & 6 \\\\\n\\hline\n\\end{array}\n$$\n\nTính phương sai của mẫu số liệu ghép nhóm trên (làm tròn đến chữ số thập phân thứ hai).","options":["6.50","7.25","8.00","8.75"],"correctAnswerIndex":0,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Cho bảng số liệu về cân nặng (kg) của một nhóm trẻ em như sau:<br><br>$$ <br>\\begin{array}{|c|c|}<br>\\hline<br>\\text{Cân nặng} & \\text{Số trẻ} \\\\<br>\\hline<br>[15; 18) & 6 \\\\<br>\\hline<br>[18; 21) & 10 \\\\<br>\\hline<br>[21; 24) & 8 \\\\<br>\\hline<br>[24; 27) & 6 \\\\<br>\\hline<br>\\end{array}<br>$$<br><br>Tính phương sai của mẫu số liệu ghép nhóm trên (làm tròn đến chữ số thập phân thứ hai).","rendered_options":["6.50","7.25","8.00","8.75"]},{"question":"Một công ty sản xuất hai loại sản phẩm A và B. Để đánh giá chất lượng sản phẩm, người ta lấy ngẫu nhiên hai mẫu sản phẩm từ mỗi loại và thu được bảng số liệu về thời gian sản xuất (phút) như sau:\n\nSản phẩm A: $$ \\begin{array}{|c|c|c|c|c|}\n\\hline\n\\text{Thời gian (phút)} & [10;15) & [15;20) & [20;25) & [25;30) \\\\\n\\hline\n\\text{Số sản phẩm} & 5 & 10 & 8 & 2 \\\\\n\\hline\n\\end{array} $$\n\nSản phẩm B: $$ \\begin{array}{|c|c|c|c|c|}\n\\hline\n\\text{Thời gian (phút)} & [10;14) & [14;18) & [18;22) & [22;26) \\\\\n\\hline\n\\text{Số sản phẩm} & 6 & 9 & 7 & 3 \\\\\n\\hline\n\\end{array} $$\n\nLoại sản phẩm nào có thời gian sản xuất ổn định hơn?","options":["Sản phẩm A","Sản phẩm B","Cả hai loại sản phẩm có độ ổn định như nhau","Không thể kết luận"],"correctAnswerIndex":0,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Một công ty sản xuất hai loại sản phẩm A và B. Để đánh giá chất lượng sản phẩm, người ta lấy ngẫu nhiên hai mẫu sản phẩm từ mỗi loại và thu được bảng số liệu về thời gian sản xuất (phút) như sau:<br><br>Sản phẩm A: $$ \\begin{array}{|c|c|c|c|c|}<br>\\hline<br>\\text{Thời gian (phút)} & [10;15) & [15;20) & [20;25) & [25;30) \\\\<br>\\hline<br>\\text{Số sản phẩm} & 5 & 10 & 8 & 2 \\\\<br>\\hline<br>\\end{array} $$<br><br>Sản phẩm B: $$ \\begin{array}{|c|c|c|c|c|}<br>\\hline<br>\\text{Thời gian (phút)} & [10;14) & [14;18) & [18;22) & [22;26) \\\\<br>\\hline<br>\\text{Số sản phẩm} & 6 & 9 & 7 & 3 \\\\<br>\\hline<br>\\end{array} $$<br><br>Loại sản phẩm nào có thời gian sản xuất ổn định hơn?","rendered_options":["Sản phẩm A","Sản phẩm B","Cả hai loại sản phẩm có độ ổn định như nhau","Không thể kết luận"]},{"question":"Hai đội bóng đá X và Y thực hiện một loạt các trận đá luân lưu. Số bàn thắng mà mỗi đội ghi được trong mỗi trận đấu được ghi lại trong bảng sau:\n\nĐội X: $$ \\begin{array}{|c|c|c|c|c|}\n\\hline\n\\text{Số bàn thắng} & [0;1) & [1;2) & [2;3) & [3;4) \\\\\n\\hline\n\\text{Số trận} & 3 & 7 & 5 & 2 \\\\\n\\hline\n\\end{array} $$\n\nĐội Y: $$ \\begin{array}{|c|c|c|c|c|}\n\\hline\n\\text{Số bàn thắng} & [0;1) & [1;2) & [2;3) & [3;4) \\\\\n\\hline\n\\text{Số trận} & 5 & 6 & 4 & 2 \\\\\n\\hline\n\\end{array} $$\n\nĐội nào có sự ổn định về số lượng bàn thắng hơn?","options":["Đội X","Đội Y","Cả hai đội có độ ổn định như nhau","Không thể kết luận"],"correctAnswerIndex":0,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Hai đội bóng đá X và Y thực hiện một loạt các trận đá luân lưu. Số bàn thắng mà mỗi đội ghi được trong mỗi trận đấu được ghi lại trong bảng sau:<br><br>Đội X: $$ \\begin{array}{|c|c|c|c|c|}<br>\\hline<br>\\text{Số bàn thắng} & [0;1) & [1;2) & [2;3) & [3;4) \\\\<br>\\hline<br>\\text{Số trận} & 3 & 7 & 5 & 2 \\\\<br>\\hline<br>\\end{array} $$<br><br>Đội Y: $$ \\begin{array}{|c|c|c|c|c|}<br>\\hline<br>\\text{Số bàn thắng} & [0;1) & [1;2) & [2;3) & [3;4) \\\\<br>\\hline<br>\\text{Số trận} & 5 & 6 & 4 & 2 \\\\<br>\\hline<br>\\end{array} $$<br><br>Đội nào có sự ổn định về số lượng bàn thắng hơn?","rendered_options":["Đội X","Đội Y","Cả hai đội có độ ổn định như nhau","Không thể kết luận"]},{"question":"Hai xưởng sản xuất cùng một loại sản phẩm. Số lượng sản phẩm lỗi trong mỗi lô hàng được ghi lại như sau:\n\nXưởng A: $$ \\begin{array}{|c|c|c|c|c|}\n\\hline\n\\text{Số sản phẩm lỗi} & [0;2) & [2;4) & [4;6) & [6;8) \\\\\n\\hline\n\\text{Số lô hàng} & 12 & 15 & 8 & 5 \\\\\n\\hline\n\\end{array} $$\n\nXưởng B: $$ \\begin{array}{|c|c|c|c|c|}\n\\hline\n\\text{Số sản phẩm lỗi} & [0;1) & [1;2) & [2;3) & [3;4) \\\\\n\\hline\n\\text{Số lô hàng} & 10 & 18 & 7 & 5 \\\\\n\\hline\n\\end{array} $$\n\nXưởng nào có quy trình sản xuất ổn định hơn (ít sản phẩm lỗi hơn)?","options":["Xưởng A","Xưởng B","Cả hai xưởng có độ ổn định như nhau","Không thể kết luận"],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Hai xưởng sản xuất cùng một loại sản phẩm. Số lượng sản phẩm lỗi trong mỗi lô hàng được ghi lại như sau:<br><br>Xưởng A: $$ \\begin{array}{|c|c|c|c|c|}<br>\\hline<br>\\text{Số sản phẩm lỗi} & [0;2) & [2;4) & [4;6) & [6;8) \\\\<br>\\hline<br>\\text{Số lô hàng} & 12 & 15 & 8 & 5 \\\\<br>\\hline<br>\\end{array} $$<br><br>Xưởng B: $$ \\begin{array}{|c|c|c|c|c|}<br>\\hline<br>\\text{Số sản phẩm lỗi} & [0;1) & [1;2) & [2;3) & [3;4) \\\\<br>\\hline<br>\\text{Số lô hàng} & 10 & 18 & 7 & 5 \\\\<br>\\hline<br>\\end{array} $$<br><br>Xưởng nào có quy trình sản xuất ổn định hơn (ít sản phẩm lỗi hơn)?","rendered_options":["Xưởng A","Xưởng B","Cả hai xưởng có độ ổn định như nhau","Không thể kết luận"]},{"question":"Để so sánh hiệu quả học tập của học sinh hai lớp 12A và 12B, người ta thống kê điểm kiểm tra môn Toán như sau:\n\nLớp 12A: $$ \\begin{array}{|c|c|c|c|c|}\n\\hline\n\\text{Điểm} & [5;6) & [6;7) & [7;8) & [8;9) \\\\\n\\hline\n\\text{Số học sinh} & 3 & 8 & 10 & 4 \\\\\n\\hline\n\\end{array} $$\n\nLớp 12B: $$ \\begin{array}{|c|c|c|c|c|}\n\\hline\n\\text{Điểm} & [5;6) & [6;7) & [7;8) & [8;9) \\\\\n\\hline\n\\text{Số học sinh} & 5 & 7 & 9 & 5 \\\\\n\\hline\n\\end{array} $$\n\nHãy cho biết lớp nào có điểm số phân tán ít hơn?","options":["Lớp 12A","Lớp 12B","Cả hai lớp có độ phân tán như nhau","Không thể kết luận"],"correctAnswerIndex":0,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Để so sánh hiệu quả học tập của học sinh hai lớp 12A và 12B, người ta thống kê điểm kiểm tra môn Toán như sau:<br><br>Lớp 12A: $$ \\begin{array}{|c|c|c|c|c|}<br>\\hline<br>\\text{Điểm} & [5;6) & [6;7) & [7;8) & [8;9) \\\\<br>\\hline<br>\\text{Số học sinh} & 3 & 8 & 10 & 4 \\\\<br>\\hline<br>\\end{array} $$<br><br>Lớp 12B: $$ \\begin{array}{|c|c|c|c|c|}<br>\\hline<br>\\text{Điểm} & [5;6) & [6;7) & [7;8) & [8;9) \\\\<br>\\hline<br>\\text{Số học sinh} & 5 & 7 & 9 & 5 \\\\<br>\\hline<br>\\end{array} $$<br><br>Hãy cho biết lớp nào có điểm số phân tán ít hơn?","rendered_options":["Lớp 12A","Lớp 12B","Cả hai lớp có độ phân tán như nhau","Không thể kết luận"]},{"question":"Hai giống lúa mới A và B được trồng thử nghiệm trên các cánh đồng khác nhau. Năng suất (tạ/ha) thu được được ghi lại như sau:\n\nGiống lúa A: $$ \\begin{array}{|c|c|c|c|c|}\n\\hline\n\\text{Năng suất (tạ/ha)} & [40;45) & [45;50) & [50;55) & [55;60) \\\\\n\\hline\n\\text{Số cánh đồng} & 6 & 12 & 9 & 3 \\\\\n\\hline\n\\end{array} $$\n\nGiống lúa B: $$ \\begin{array}{|c|c|c|c|c|}\n\\hline\n\\text{Năng suất (tạ/ha)} & [40;44) & [44;48) & [48;52) & [52;56) \\\\\n\\hline\n\\text{Số cánh đồng} & 5 & 14 & 8 & 4 \\\\\n\\hline\n\\end{array} $$\n\nGiống lúa nào cho năng suất ổn định hơn?","options":["Giống lúa A","Giống lúa B","Cả hai giống lúa có độ ổn định như nhau","Không thể kết luận"],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Hai giống lúa mới A và B được trồng thử nghiệm trên các cánh đồng khác nhau. Năng suất (tạ/ha) thu được được ghi lại như sau:<br><br>Giống lúa A: $$ \\begin{array}{|c|c|c|c|c|}<br>\\hline<br>\\text{Năng suất (tạ/ha)} & [40;45) & [45;50) & [50;55) & [55;60) \\\\<br>\\hline<br>\\text{Số cánh đồng} & 6 & 12 & 9 & 3 \\\\<br>\\hline<br>\\end{array} $$<br><br>Giống lúa B: $$ \\begin{array}{|c|c|c|c|c|}<br>\\hline<br>\\text{Năng suất (tạ/ha)} & [40;44) & [44;48) & [48;52) & [52;56) \\\\<br>\\hline<br>\\text{Số cánh đồng} & 5 & 14 & 8 & 4 \\\\<br>\\hline<br>\\end{array} $$<br><br>Giống lúa nào cho năng suất ổn định hơn?","rendered_options":["Giống lúa A","Giống lúa B","Cả hai giống lúa có độ ổn định như nhau","Không thể kết luận"]},{"question":"Một công ty sản xuất bóng đèn tiến hành kiểm tra tuổi thọ (giờ) của một lô bóng đèn mới. Kết quả được ghi lại ở bảng sau:\n\n$$ \n\\begin{array}{|c|c|}\n\\hline\n\\text{Tuổi thọ (giờ)} & \\text{Số lượng bóng đèn} \\\\ \n\\hline\n[800; 900) & 10 \\\\ \n\\hline\n[900; 1000) & 25 \\\\ \n\\hline\n[1000; 1100) & 40 \\\\ \n\\hline\n[1100; 1200) & 15 \\\\ \n\\hline\n[1200; 1300) & 10 \\\\ \n\\hline\n\\end{array}\n$$\n\nTính phương sai của mẫu số liệu ghép nhóm này (làm tròn đến hàng đơn vị).","options":["9521","10526","10525","9520"],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Một công ty sản xuất bóng đèn tiến hành kiểm tra tuổi thọ (giờ) của một lô bóng đèn mới. Kết quả được ghi lại ở bảng sau:<br><br>$$ <br>\\begin{array}{|c|c|}<br>\\hline<br>\\text{Tuổi thọ (giờ)} & \\text{Số lượng bóng đèn} \\\\ <br>\\hline<br>[800; 900) & 10 \\\\ <br>\\hline<br>[900; 1000) & 25 \\\\ <br>\\hline<br>[1000; 1100) & 40 \\\\ <br>\\hline<br>[1100; 1200) & 15 \\\\ <br>\\hline<br>[1200; 1300) & 10 \\\\ <br>\\hline<br>\\end{array}<br>$$<br><br>Tính phương sai của mẫu số liệu ghép nhóm này (làm tròn đến hàng đơn vị).","rendered_options":["9521","10526","10525","9520"]},{"question":"Một cửa hàng ghi lại số lượng khách hàng mỗi ngày trong một tháng (30 ngày) và có bảng số liệu sau:\n\n$$ \n\\begin{array}{|c|c|}\n\\hline\n\\text{Số lượng khách hàng} & \\text{Số ngày} \\\\ \n\\hline\n[20; 30) & 5 \\\\ \n\\hline\n[30; 40) & 8 \\\\ \n\\hline\n[40; 50) & 10 \\\\ \n\\hline\n[50; 60) & 7 \\\\ \n\\hline\n\\end{array}\n$$\n\nTính độ lệch chuẩn của mẫu số liệu ghép nhóm này (làm tròn đến chữ số thập phân thứ nhất).","options":["9.8","10.2","10.1","9.9"],"correctAnswerIndex":0,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Một cửa hàng ghi lại số lượng khách hàng mỗi ngày trong một tháng (30 ngày) và có bảng số liệu sau:<br><br>$$ <br>\\begin{array}{|c|c|}<br>\\hline<br>\\text{Số lượng khách hàng} & \\text{Số ngày} \\\\ <br>\\hline<br>[20; 30) & 5 \\\\ <br>\\hline<br>[30; 40) & 8 \\\\ <br>\\hline<br>[40; 50) & 10 \\\\ <br>\\hline<br>[50; 60) & 7 \\\\ <br>\\hline<br>\\end{array}<br>$$<br><br>Tính độ lệch chuẩn của mẫu số liệu ghép nhóm này (làm tròn đến chữ số thập phân thứ nhất).","rendered_options":["9.8","10.2","10.1","9.9"]},{"question":"Để đánh giá chất lượng sản phẩm của hai nhà máy A và B, người ta lấy mẫu và đo kích thước sản phẩm (mm). Kết quả được trình bày ở bảng sau:\n\nNhà máy A:\n$$ \n\\begin{array}{|c|c|}\n\\hline\n\\text{Kích thước (mm)} & \\text{Số lượng sản phẩm} \\\\ \n\\hline\n[10; 12) & 15 \\\\ \n\\hline\n[12; 14) & 25 \\\\ \n\\hline\n[14; 16) & 30 \\\\ \n\\hline\n[16; 18) & 20 \\\\ \n\\hline\n\\end{array}\n$$\nNhà máy B:\n$$ \n\\begin{array}{|c|c|}\n\\hline\n\\text{Kích thước (mm)} & \\text{Số lượng sản phẩm} \\\\ \n\\hline\n[10; 12) & 20 \\\\ \n\\hline\n[12; 14) & 20 \\\\ \n\\hline\n[14; 16) & 20 \\\\ \n\\hline\n[16; 18) & 20 \\\\ \n\\hline\n\\end{array}\n$$\n\nNhận xét nào sau đây đúng về mức độ phân tán của kích thước sản phẩm giữa hai nhà máy?","options":["Nhà máy A có độ phân tán lớn hơn nhà máy B.","Nhà máy B có độ phân tán lớn hơn nhà máy A.","Độ phân tán của hai nhà máy là như nhau.","Không thể so sánh độ phân tán dựa trên thông tin đã cho."],"correctAnswerIndex":0,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Để đánh giá chất lượng sản phẩm của hai nhà máy A và B, người ta lấy mẫu và đo kích thước sản phẩm (mm). Kết quả được trình bày ở bảng sau:<br><br>Nhà máy A:<br>$$ <br>\\begin{array}{|c|c|}<br>\\hline<br>\\text{Kích thước (mm)} & \\text{Số lượng sản phẩm} \\\\ <br>\\hline<br>[10; 12) & 15 \\\\ <br>\\hline<br>[12; 14) & 25 \\\\ <br>\\hline<br>[14; 16) & 30 \\\\ <br>\\hline<br>[16; 18) & 20 \\\\ <br>\\hline<br>\\end{array}<br>$$<br>Nhà máy B:<br>$$ <br>\\begin{array}{|c|c|}<br>\\hline<br>\\text{Kích thước (mm)} & \\text{Số lượng sản phẩm} \\\\ <br>\\hline<br>[10; 12) & 20 \\\\ <br>\\hline<br>[12; 14) & 20 \\\\ <br>\\hline<br>[14; 16) & 20 \\\\ <br>\\hline<br>[16; 18) & 20 \\\\ <br>\\hline<br>\\end{array}<br>$$<br><br>Nhận xét nào sau đây đúng về mức độ phân tán của kích thước sản phẩm giữa hai nhà máy?","rendered_options":["Nhà máy A có độ phân tán lớn hơn nhà máy B.","Nhà máy B có độ phân tán lớn hơn nhà máy A.","Độ phân tán của hai nhà máy là như nhau.","Không thể so sánh độ phân tán dựa trên thông tin đã cho."]},{"question":"Một nhóm nghiên cứu thống kê chiều cao của học sinh lớp 12 trong một trường THPT và thu được bảng số liệu sau:\n\n$$ \n\\begin{array}{|c|c|}\n\\hline\n\\text{Chiều cao (cm)} & \\text{Số lượng học sinh} \\\\ \n\\hline\n[150; 155) & 10 \\\\ \n\\hline\n[155; 160) & 20 \\\\ \n\\hline\n[160; 165) & 40 \\\\ \n\\hline\n[165; 170) & 20 \\\\ \n\\hline\n[170; 175) & 10 \\\\ \n\\hline\n\\end{array}\n$$\n\nTính độ lệch chuẩn của chiều cao học sinh trong trường (làm tròn đến chữ số thập phân thứ hai).","options":["6.21 cm","6.20 cm","6.22 cm","6.23 cm"],"correctAnswerIndex":0,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Một nhóm nghiên cứu thống kê chiều cao của học sinh lớp 12 trong một trường THPT và thu được bảng số liệu sau:<br><br>$$ <br>\\begin{array}{|c|c|}<br>\\hline<br>\\text{Chiều cao (cm)} & \\text{Số lượng học sinh} \\\\ <br>\\hline<br>[150; 155) & 10 \\\\ <br>\\hline<br>[155; 160) & 20 \\\\ <br>\\hline<br>[160; 165) & 40 \\\\ <br>\\hline<br>[165; 170) & 20 \\\\ <br>\\hline<br>[170; 175) & 10 \\\\ <br>\\hline<br>\\end{array}<br>$$<br><br>Tính độ lệch chuẩn của chiều cao học sinh trong trường (làm tròn đến chữ số thập phân thứ hai).","rendered_options":["6.21 cm","6.20 cm","6.22 cm","6.23 cm"]},{"question":"Một nhà đầu tư theo dõi lợi nhuận hàng tháng (triệu đồng) từ một dự án kinh doanh trong một năm và có bảng số liệu sau:\n\n$$ \n\\begin{array}{|c|c|}\n\\hline\n\\text{Lợi nhuận (triệu đồng)} & \\text{Số tháng} \\\\ \n\\hline\n[5; 10) & 2 \\\\ \n\\hline\n[10; 15) & 4 \\\\ \n\\hline\n[15; 20) & 3 \\\\ \n\\hline\n[20; 25) & 2 \\\\ \n\\hline\n[25; 30) & 1 \\\\ \n\\hline\n\\end{array}\n$$\n\nTính phương sai của lợi nhuận hàng tháng từ dự án này (làm tròn đến hàng đơn vị).","options":["35","36","34","37"],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Một nhà đầu tư theo dõi lợi nhuận hàng tháng (triệu đồng) từ một dự án kinh doanh trong một năm và có bảng số liệu sau:<br><br>$$ <br>\\begin{array}{|c|c|}<br>\\hline<br>\\text{Lợi nhuận (triệu đồng)} & \\text{Số tháng} \\\\ <br>\\hline<br>[5; 10) & 2 \\\\ <br>\\hline<br>[10; 15) & 4 \\\\ <br>\\hline<br>[15; 20) & 3 \\\\ <br>\\hline<br>[20; 25) & 2 \\\\ <br>\\hline<br>[25; 30) & 1 \\\\ <br>\\hline<br>\\end{array}<br>$$<br><br>Tính phương sai của lợi nhuận hàng tháng từ dự án này (làm tròn đến hàng đơn vị).","rendered_options":["35","36","34","37"]},{"question":"Một cửa hàng bán xe đạp thống kê số lượng xe bán được trong một tháng như sau: \n$$ \n\\begin{array}{|c|c|} \n\\hline \n\\textbf{Giá (triệu đồng)} & \\textbf{Số lượng xe} \\\\ \n\\hline \n[2; 3) & 10 \\\\ \n\\hline \n[3; 4) & 15 \\\\ \n\\hline \n[4; 5) & 20 \\\\ \n\\hline \n[5; 6) & 5 \\\\ \n\\hline \n\\end{array} \n$$ \nGiá trị đại diện của lớp $[3; 4)$ là bao nhiêu?","options":["3","3.5","4","5"],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Một cửa hàng bán xe đạp thống kê số lượng xe bán được trong một tháng như sau: <br>$$ <br>\\begin{array}{|c|c|} <br>\\hline <br>\\textbf{Giá (triệu đồng)} & \\textbf{Số lượng xe} \\\\ <br>\\hline <br>[2; 3) & 10 \\\\ <br>\\hline <br>[3; 4) & 15 \\\\ <br>\\hline <br>[4; 5) & 20 \\\\ <br>\\hline <br>[5; 6) & 5 \\\\ <br>\\hline <br>\\end{array} <br>$$ <br>Giá trị đại diện của lớp $[3; 4)$ là bao nhiêu?","rendered_options":["3","3.5","4","5"]},{"question":"Điểm kiểm tra môn Toán của một nhóm học sinh được cho như sau:\n$$ \n\\begin{array}{|c|c|} \n\\hline \n\\textbf{Điểm} & \\textbf{Số học sinh} \\\\ \n\\hline \n[5; 6) & 5 \\\\ \n\\hline \n[6; 7) & 8 \\\\ \n\\hline \n[7; 8) & 12 \\\\ \n\\hline \n[8; 9) & 5 \\\\ \n\\hline \n\\end{array} \n$$ \nTìm tần số của lớp $[7; 8)$.","options":["5","8","12","5"],"correctAnswerIndex":2,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Điểm kiểm tra môn Toán của một nhóm học sinh được cho như sau:<br>$$ <br>\\begin{array}{|c|c|} <br>\\hline <br>\\textbf{Điểm} & \\textbf{Số học sinh} \\\\ <br>\\hline <br>[5; 6) & 5 \\\\ <br>\\hline <br>[6; 7) & 8 \\\\ <br>\\hline <br>[7; 8) & 12 \\\\ <br>\\hline <br>[8; 9) & 5 \\\\ <br>\\hline <br>\\end{array} <br>$$ <br>Tìm tần số của lớp $[7; 8)$.","rendered_options":["5","8","12","5"]},{"question":"Thời gian (phút) hoàn thành một bài kiểm tra của một số học sinh được thống kê như sau: \n$$ \n\\begin{array}{|l|c|c|c|c|} \n\\hline \n\\text{Thời gian (phút)} & [25;30) & [30;35) & [35;40) & [40;45) \\\\ \n\\hline \n\\text{Số học sinh} & 8 & 16 & 4 & 2 \\\\ \n\\hline \n\\end{array} \n$$ \nTìm mốt của mẫu số liệu ghép nhóm trên.","options":["30","32.5","35","37.5"],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Thời gian (phút) hoàn thành một bài kiểm tra của một số học sinh được thống kê như sau: <br>$$ <br>\\begin{array}{|l|c|c|c|c|} <br>\\hline <br>\\text{Thời gian (phút)} & [25;30) & [30;35) & [35;40) & [40;45) \\\\ <br>\\hline <br>\\text{Số học sinh} & 8 & 16 & 4 & 2 \\\\ <br>\\hline <br>\\end{array} <br>$$ <br>Tìm mốt của mẫu số liệu ghép nhóm trên.","rendered_options":["30","32.5","35","37.5"]},{"question":"Số lượng khách hàng mua sản phẩm tại một cửa hàng trong một tuần được thống kê như sau: \n$$ \n\\begin{array}{|c|c|} \n\\hline \n\\textbf{Số lượng khách} & \\textbf{Số ngày} \\\\ \n\\hline \n[10; 20) & 2 \\\\ \n\\hline \n[20; 30) & 3 \\\\ \n\\hline \n[30; 40) & 1 \\\\ \n\\hline \n[40; 50) & 1 \\\\ \n\\hline \n\\end{array} \n$$ \nSố trung bình của mẫu số liệu ghép nhóm trên gần nhất với giá trị nào?","options":["25","26","27","28"],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Số lượng khách hàng mua sản phẩm tại một cửa hàng trong một tuần được thống kê như sau: <br>$$ <br>\\begin{array}{|c|c|} <br>\\hline <br>\\textbf{Số lượng khách} & \\textbf{Số ngày} \\\\ <br>\\hline <br>[10; 20) & 2 \\\\ <br>\\hline <br>[20; 30) & 3 \\\\ <br>\\hline <br>[30; 40) & 1 \\\\ <br>\\hline <br>[40; 50) & 1 \\\\ <br>\\hline <br>\\end{array} <br>$$ <br>Số trung bình của mẫu số liệu ghép nhóm trên gần nhất với giá trị nào?","rendered_options":["25","26","27","28"]},{"question":"Chiều cao của một nhóm cây (đơn vị: cm) được thống kê như sau: \n$$ \n\\begin{array}{|c|c|} \n\\hline \n\\textbf{Chiều cao} & \\textbf{Số cây} \\\\ \n\\hline \n[10; 20) & 5 \\\\ \n\\hline \n[20; 30) & 10 \\\\ \n\\hline \n[30; 40) & 8 \\\\ \n\\hline \n[40; 50) & 2 \\\\ \n\\hline \n\\end{array} \n$$ \nTìm trung vị của mẫu số liệu ghép nhóm trên.","options":["25","26","27","28"],"correctAnswerIndex":0,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Chiều cao của một nhóm cây (đơn vị: cm) được thống kê như sau: <br>$$ <br>\\begin{array}{|c|c|} <br>\\hline <br>\\textbf{Chiều cao} & \\textbf{Số cây} \\\\ <br>\\hline <br>[10; 20) & 5 \\\\ <br>\\hline <br>[20; 30) & 10 \\\\ <br>\\hline <br>[30; 40) & 8 \\\\ <br>\\hline <br>[40; 50) & 2 \\\\ <br>\\hline <br>\\end{array} <br>$$ <br>Tìm trung vị của mẫu số liệu ghép nhóm trên.","rendered_options":["25","26","27","28"]}];
        const options = {"title":"Bài kiểm tra - 24/11/2025","timeLimit":90,"retriesAllowed":1,"showAnswers":true,"showExplanation":true,"aiAssessment":true,"shortAnswerFormat":"freeform","examCode":"4UFI4L","teacherName":"NGO THANH HA","scoring":{"mc":10,"tf":0,"sa":0,"essay":0,"tfMethod":"progressive"}};
        const googleScriptUrl = "https://script.google.com/macros/s/AKfycbwySChC78GoE29SaqLvHl0TvvY5fJQhdbsEw5zQxB7s3nO60swLHa9BCKqIgvhzdgq-0w/exec";
        const examCode = "4UFI4L";
        
        let userAnswers = new Array(quizData.length).fill(null);
        let studentName = '';
        let studentClass = '';
        let timerInterval;
        let timeRemaining = options.timeLimit * 60;
        let retriesCount = 0;
        let submissionStatus = 'pending';
        let monitoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0 };
        let lastScore, lastAnswerDetails; // For retrying AI assessment
        
        // --- FALLBACK MODELS CONFIGURATION ---
        const GEMINI_MODELS_FALLBACK = [
          "gemini-2.0-flash",          // Nhanh, mới nhất
          "gemini-2.0-flash-lite-preview-02-05", // Bản nhẹ tối ưu
          "gemini-2.0-pro-exp-02-05",  // Bản Pro mạnh mẽ
          "gemini-1.5-flash",          // Bản ổn định cũ
          "gemini-1.5-flash-8b",       // Bản siêu nhẹ
          "gemini-1.5-pro",            // Bản mạnh mẽ cũ
          // Các mô hình mới/dự phòng theo yêu cầu
          "gemini-3.0-pro-preview",
          "gemini-3.0-preview"
        ];

        // --- FALLBACK API FUNCTION ---
        async function generateContentWithFallback(ai, contents, preferredModel = "gemini-2.0-flash") {
            if (!ai) throw new Error("AI instance not provided.");
            
            const uniqueModels = [...new Set([preferredModel, ...GEMINI_MODELS_FALLBACK])];
            let lastError;
            
            for (const model of uniqueModels) {
                try {
                    // console.log('Trying model:', model);
                    const response = await ai.models.generateContent({
                        model: model,
                        contents: contents
                    });
                    return response;
                } catch (error) {
                    console.warn('Model failed:', model, error);
                    lastError = error;
                    const errStr = error.toString().toLowerCase();
                    // Check for quota or server errors to trigger fallback
                    if (errStr.includes("429") || errStr.includes("quota") || errStr.includes("exhausted") || 
                        errStr.includes("503") || errStr.includes("overloaded") || errStr.includes("500") || 
                        errStr.includes("internal") || errStr.includes("resource") || errStr.includes("not found")) {
                        continue;
                    }
                    // For other errors, also try next model just in case
                    continue;
                }
            }
            throw lastError || new Error("All AI models are busy or quota exhausted.");
        }

        const welcomeScreen = document.getElementById('welcome-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const resultsScreen = document.getElementById('results-screen');
        const startBtn = document.getElementById('start-btn');
        const nameInput = document.getElementById('name');
        const classInput = document.getElementById('class');
        const timerEl = document.getElementById('timer');
        const submitBtn = document.getElementById('submit-btn');
        const scoreDisplay = document.getElementById('score-display');
        const assessmentDisplay = document.getElementById('assessment-display');
        const reviewContainer = document.getElementById('review-container');
        const retryBtn = document.getElementById('retry-btn');
        const restartBtn = document.getElementById('restart-btn');
        const warningEl = document.getElementById('monitoring-warning');
        const progressBar = document.getElementById('progress-bar');
        const progressContainer = document.getElementById('progress-container');
        const toggleNavBtn = document.getElementById('toggle-nav-btn');
        const navPanel = document.getElementById('nav-panel');
        const navGrid = document.getElementById('nav-grid');

        // Make functions globally accessible for inline onclick handlers
        window.selectOption = selectOption;
        window.selectTFOption = selectTFOption;
        window.saveTextAnswer = saveTextAnswer;
        window.toggleExplanation = toggleExplanation;
        window.fetchAndRenderExplanation = fetchAndRenderExplanation;
        window.retryAIAssessment = retryAIAssessment;
        window.setupFormInputs = setupFormInputs;
        window.saveFormAnswer = saveFormAnswer;
        window.scrollToQuestion = scrollToQuestion;

        startBtn.addEventListener('click', startQuiz);
        submitBtn.addEventListener('click', confirmSubmit);
        retryBtn.addEventListener('click', retryQuiz);
        restartBtn.addEventListener('click', () => window.location.reload());
        
        // Toggle Navigation
        toggleNavBtn.addEventListener('click', () => {
            navPanel.classList.toggle('open');
            document.body.classList.toggle('nav-open');
        });

        nameInput.value = localStorage.getItem('studentName') || '';
        classInput.value = localStorage.getItem('studentClass') || '';
        
        function safeTypeset(elements) {
            if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                window.MathJax.typesetPromise(elements).catch(function (err) {
                    console.error('MathJax error: ' + err.message);
                });
            }
        }
        
        function startQuiz() {
            studentName = nameInput.value.trim();
            studentClass = classInput.value.trim();
            if (!studentName || !studentClass) {
                alert('Vui lòng nhập đầy đủ Họ và tên và Lớp.');
                return;
            }
            localStorage.setItem('studentName', studentName);
            localStorage.setItem('studentClass', studentClass);
            
            welcomeScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            resultsScreen.classList.add('hidden');
            progressContainer.classList.remove('hidden');
            toggleNavBtn.classList.remove('hidden');
            
            // Open nav panel by default on desktop
            if (window.innerWidth > 1024) {
                navPanel.classList.add('open');
                document.body.classList.add('nav-open');
            }

            userAnswers.fill(null);
            submissionStatus = 'pending';
            
            renderAllQuestions();
            renderNavPanel();
            updateProgress();
            
            if (options.timeLimit > 0) {
                timeRemaining = options.timeLimit * 60;
                startTimer();
            } else {
                timerEl.textContent = 'Không giới hạn';
            }
            startMonitoring();
        }

        function renderNavPanel() {
            navGrid.innerHTML = '';
            quizData.forEach((_, index) => {
                const btn = document.createElement('button');
                btn.className = 'nav-btn';
                btn.id = `nav-btn-${index}`;
                btn.textContent = index + 1;
                btn.onclick = () => scrollToQuestion(index);
                navGrid.appendChild(btn);
            });
        }

        function scrollToQuestion(index) {
            const el = document.getElementById(`q-${index}`);
            if (el) {
                const offset = 80; // header height
                const elementPosition = el.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - offset;
                window.scrollTo({ top: offsetPosition, behavior: "smooth" });
                
                // Highlight current
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('current'));
                document.getElementById(`nav-btn-${index}`)?.classList.add('current');
            }
            // On mobile, close nav after selecting
            if (window.innerWidth <= 1024) {
                navPanel.classList.remove('open');
                document.body.classList.remove('nav-open');
            }
        }

        function updateProgress() {
            let answeredCount = 0;
            quizData.forEach((item, index) => {
                const answer = userAnswers[index];
                const type = mapType(item.type);
                let isAnswered = false;

                if (type === 'multiple-choice') {
                    isAnswered = answer !== null;
                } else if (type === 'true-false') {
                    // Mark as answered only if ALL statements are answered
                    isAnswered = Array.isArray(answer) && answer.filter(x => x !== null).length === item.statements.length;
                } else { // short-answer, essay
                    isAnswered = answer && String(answer).trim().length > 0;
                }

                const btn = document.getElementById(`nav-btn-${index}`);
                if (isAnswered) {
                    answeredCount++;
                    btn?.classList.add('answered');
                } else {
                    btn?.classList.remove('answered');
                }
            });

            const percent = Math.round((answeredCount / quizData.length) * 100);
            progressBar.style.width = `${percent}%`;
        }

        function mapType(typeStr) {
             if (!typeStr) return 'multiple-choice';
             if (typeStr.startsWith('mc-') || ['cloze-test', 'sentence-ordering', 'multiple-choice', 'paragraph-sentence-ordering'].includes(typeStr)) return 'multiple-choice';
             if (typeStr.startsWith('tf-') || typeStr === 'true-false') return 'true-false';
             if (typeStr === 'short-answer' || typeStr === 'sentence-transformation') return 'short-answer';
             return 'essay';
        }
        
        function renderAllQuestions() {
            const container = document.getElementById('all-questions-container');
            let allHTML = '';

            const groupedQuestions = quizData.reduce((acc, q) => {
                const type = mapType(q.type);
                if (!acc[type]) acc[type] = [];
                acc[type].push(q);
                return acc;
            }, {});

            const groupInfo = {
                'multiple-choice': { title: 'PHẦN I. TRẮC NGHIỆM KHÁCH QUAN' },
                'true-false': { title: 'PHẦN II. CÂU HỎI ĐÚNG - SAI' },
                'short-answer': { title: 'PHẦN III. CÂU HỎI TRẢ LỜI NGẮN' },
                'essay': { title: 'PHẦN IV. CÂU HỎI TỰ LUẬN' },
            };
            
            let questionCounter = 0;
            const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];

            partOrder.forEach(partType => {
                const questions = groupedQuestions[partType];
                if (!questions || questions.length === 0) return;

                const info = groupInfo[partType];
                allHTML += `<div class="group-header mb-6 pb-3 border-b-2 border-gray-300"><h2 class="text-2xl font-bold text-gray-800">${info.title}</h2></div>`;
                
                questions.forEach((item) => {
                    const index = quizData.indexOf(item);
                    questionCounter++;
                    
                    let contentHTML = `<div class="question-card mb-8 p-6 border rounded-xl shadow-sm scroll-mt-24" id="q-${index}">`;
                    contentHTML += `<p class="font-semibold text-lg text-gray-800 mb-4">Câu ${questionCounter}:</p>`;
                    contentHTML += `<div class="prose max-w-none text-gray-700 mb-4">${item.rendered_question || ''}</div>`;

                    let answerHTML = '';
                    const savedAnswer = userAnswers[index];
                    const type = mapType(item.type);
                    
                    if (type === 'multiple-choice') {
                        answerHTML = `<div class="space-y-3">`;
                        (item.rendered_options || []).forEach((opt, i) => {
                            const isSelected = savedAnswer === i;
                            answerHTML += `<div class="option ${isSelected ? 'selected' : ''} p-3 border-2 rounded-lg cursor-pointer transition flex items-start" data-q-index="${index}" data-opt-index="${i}" onclick="selectOption(this, ${index}, ${i})">
                                                <span class="font-bold mr-2">${String.fromCharCode(65 + i)}.</span>
                                                <div class="flex-grow">${opt}</div>
                                            </div>`;
                        });
                        answerHTML += `</div>`;
                    } else if (type === 'true-false') {
                         answerHTML = `<div class="space-y-3">`;
                         (item.statements || []).forEach((stmt, i) => {
                            const savedStmtAnswer = savedAnswer ? savedAnswer[i] : null;
                            const isTrueSelected = savedStmtAnswer === true;
                            const isFalseSelected = savedStmtAnswer === false;
                            answerHTML += `<div class="p-3 border-2 rounded-lg flex items-center justify-between gap-4">
                                                <div class="flex-grow prose max-w-none">${stmt.rendered_statement}</div>
                                                <div class="flex-shrink-0 flex gap-2">
                                                    <button class="${isTrueSelected ? 'bg-blue-500 text-white' : 'bg-gray-200'} px-4 py-2 rounded-md font-semibold" onclick="selectTFOption(this, ${index}, ${i}, true)">Đúng</button>
                                                    <button class="${isFalseSelected ? 'bg-red-500 text-white' : 'bg-gray-200'} px-4 py-2 rounded-md font-semibold" onclick="selectTFOption(this, ${index}, ${i}, false)">Sai</button>
                                                </div>
                                            </div>`;
                        });
                        answerHTML += `</div>`;
                    } else if (type === 'short-answer') {
                        const savedAnswerStr = userAnswers[index] || '';
                        if (options.shortAnswerFormat === 'form') {
                             answerHTML = `<div id="sa-form-${index}" class="flex items-center gap-2">`;
                            for (let i = 0; i < 4; i++) {
                                answerHTML += `<input type="text" maxlength="1" data-q-index="${index}" class="w-12 h-12 text-center text-2xl font-bold border-2 border-gray-400 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" value="">`;
                            }
                            answerHTML += `</div>`;
                        } else {
                            answerHTML = `<input type="text" class="w-full border border-gray-300 rounded-md p-2" value="${savedAnswerStr}" onchange="saveTextAnswer(this, ${index})">`;
                        }
                    } else if (type === 'essay') {
                        answerHTML = `<textarea class="w-full border border-gray-300 rounded-md p-2" rows="5" onchange="saveTextAnswer(this, ${index})">${savedAnswer || ''}</textarea>`;
                    }

                    contentHTML += answerHTML + '</div>'; // close question-card
                    allHTML += contentHTML;
                });
            });
            container.innerHTML = allHTML;

            // Add event listeners for the 4-box forms after rendering
            document.querySelectorAll('[id^="sa-form-"]').forEach(formContainer => {
                const inputs = formContainer.querySelectorAll('input');
                if (inputs.length > 0) {
                    setupFormInputs(inputs);
                }
            });

            safeTypeset([container]);
        }

        function setupFormInputs(inputs) {
            const qIndex = inputs[0].dataset.qIndex;
            inputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    if (e.target.value && index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }
                    saveFormAnswer(qIndex, inputs);
                });

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        inputs[index - 1].focus();
                    }
                     saveFormAnswer(qIndex, inputs);
                });
                 input.addEventListener('change', () => saveFormAnswer(qIndex, inputs));
            });
        }

        function saveFormAnswer(qIndex, inputs) {
            let combinedValue = '';
            inputs.forEach(inp => { combinedValue += inp.value; });
            userAnswers[qIndex] = combinedValue;
            updateProgress();
        }

        function selectOption(element, qIndex, optIndex) {
            userAnswers[qIndex] = optIndex;
            const questionCard = document.getElementById(`q-${qIndex}`);
            questionCard.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            updateProgress();
        }
        
        function selectTFOption(button, qIndex, stmtIndex, answer) {
            if (!userAnswers[qIndex] || !Array.isArray(userAnswers[qIndex])) {
                userAnswers[qIndex] = new Array(quizData[qIndex].statements.length).fill(null);
            }
            userAnswers[qIndex][stmtIndex] = answer;
            const parent = button.parentElement;
            Array.from(parent.children).forEach(btn => btn.classList.remove('bg-blue-500', 'text-white', 'bg-red-500'));
            button.classList.add(answer ? 'bg-blue-500' : 'bg-red-500', 'text-white');
            updateProgress();
        }
        
        function saveTextAnswer(element, qIndex) {
            userAnswers[qIndex] = element.value;
            updateProgress();
        }

        function confirmSubmit() {
            const unansweredQuestions = userAnswers.map((answer, index) => ({ answer, index }))
                                                .filter(item => item.answer === null || 
                                                                (Array.isArray(item.answer) && item.answer.some(a => a === null)));

            let message = "Bạn có chắc chắn muốn nộp bài không?";
            if (unansweredQuestions.length > 0) {
                message = `Bạn còn ${unansweredQuestions.length} câu chưa hoàn thành. Bạn có chắc chắn muốn nộp bài không?`;
            }

            if (confirm(message)) {
                submitQuiz();
            }
        }

        async function submitQuiz() {
            if (submissionStatus !== 'pending') return;
            submissionStatus = 'submitting';
            stopTimer();
            stopMonitoring();
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="animate-pulse">Đang nộp bài...</span>';
            
            // Hide nav elements
            progressContainer.classList.add('hidden');
            toggleNavBtn.classList.add('hidden');
            navPanel.classList.remove('open');
            document.body.classList.remove('nav-open');

            const { score, totalPossibleScore, answerDetails } = calculateScore();
            lastScore = score;
            lastAnswerDetails = answerDetails;
            const finalScore = (totalPossibleScore > 0 ? (score / totalPossibleScore * 10) : 0).toFixed(2);
            let aiAssessment = 'Không có';

            if (options.aiAssessment) {
                aiAssessment = await getAIAssessment(finalScore, answerDetails);
            }
            
            const submissionData = new FormData();
            submissionData.append('timestamp', new Date().toLocaleString('vi-VN'));
            submissionData.append('name', studentName);
            submissionData.append('class', studentClass);
            submissionData.append('score', finalScore);
            submissionData.append('assessment', aiAssessment);
            submissionData.append('examCode', examCode);
            submissionData.append('monitoringLog', JSON.stringify(monitoringLog));
            submissionData.append('answerDetails', JSON.stringify(answerDetails));
            
            if (googleScriptUrl) {
                try {
                    await fetch(googleScriptUrl, { method: 'POST', body: new URLSearchParams(submissionData) });
                } catch (error) {
                    console.error('Error submitting to Google Script:', error);
                    alert('Lỗi: Không thể nộp kết quả lên hệ thống. Vui lòng kiểm tra lại kết nối mạng và thử lại.');
                }
            }
            submissionStatus = 'submitted';
            showResults(finalScore, aiAssessment, answerDetails);
        }
        
        function showResults(score, assessment, answerDetails) {
            quizScreen.classList.add('hidden');
            resultsScreen.classList.remove('hidden');
            
            if (options.showAnswers) {
                scoreDisplay.textContent = `${score} / 10`;
                scoreDisplay.classList.remove('hidden');
            } else {
                scoreDisplay.innerHTML = '<p class="text-3xl text-center text-green-600">Nộp bài thành công!</p>';
                scoreDisplay.classList.remove('hidden');
            }
            
            if (options.aiAssessment) {
                // The getAIAssessment function now handles rendering directly.
                // This call ensures the initial result is displayed.
                if (assessment.startsWith("Lỗi")) {
                    // If there was an error, getAIAssessment already rendered the error message.
                } else {
                     assessmentDisplay.innerHTML = `<strong>Nhận xét từ AI:</strong> <br> ${assessment.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>')}`;
                     assessmentDisplay.classList.remove('hidden');
                }
            } else {
                assessmentDisplay.classList.add('hidden');
            }
            
            if (options.showAnswers) {
                renderReview(answerDetails);
            } else {
                reviewContainer.innerHTML = '<p class="text-center text-gray-600">Giáo viên đã chọn không hiển thị đáp án và giải thích chi tiết.</p>';
            }
            
            if (retriesCount < options.retriesAllowed) retryBtn.classList.remove('hidden');
        }

        function calculateScore() {
            let score = 0;
            let totalPossibleScore = 0;
            const answerDetails = [];
            
            const mcCount = quizData.filter(q => mapType(q.type) === 'multiple-choice').length;
            const tfCount = quizData.filter(q => mapType(q.type) === 'true-false').length;
            const saCount = quizData.filter(q => mapType(q.type) === 'short-answer').length;

            const pointsPerMc = mcCount > 0 ? options.scoring.mc / mcCount : 0;
            const pointsPerTf = tfCount > 0 ? options.scoring.tf / tfCount : 0;
            const pointsPerSa = saCount > 0 ? options.scoring.sa / saCount : 0;
            
            totalPossibleScore = (options.scoring.mc || 0) + (options.scoring.tf || 0) + (options.scoring.sa || 0) + (options.scoring.essay || 0);
            if (totalPossibleScore === 0 && (mcCount + tfCount + saCount > 0)) {
                 totalPossibleScore = (pointsPerMc * mcCount) + (pointsPerTf * tfCount) + (pointsPerSa * saCount);
            }
            if (totalPossibleScore === 0 && quizData.length > 0) totalPossibleScore = 10; 

            quizData.forEach((item, index) => {
                const userAnswer = userAnswers[index];
                let isCorrect = false;
                let detail = null;
                const type = mapType(item.type);

                if (type === 'multiple-choice') {
                    isCorrect = userAnswer === item.correctAnswerIndex;
                    if(isCorrect) score += pointsPerMc;
                } else if (type === 'true-false') {
                    let correctStatements = 0;
                    detail = [];
                    (item.statements || []).forEach((stmt, i) => {
                        const isStmtCorrect = (userAnswer && userAnswer[i] === stmt.is_correct);
                        if(isStmtCorrect) correctStatements++;
                        detail.push({isCorrect: isStmtCorrect});
                    });

                    if (options.scoring.tfMethod === 'even') {
                        score += (correctStatements / 4) * pointsPerTf;
                    } else { // progressive
                        if (correctStatements === 4) score += pointsPerTf;
                        else if (correctStatements === 3) score += 0.5 * pointsPerTf;
                        else if (correctStatements === 2) score += 0.25 * pointsPerTf;
                        else if (correctStatements === 1) score += 0.1 * pointsPerTf;
                    }
                    isCorrect = correctStatements === 4;
                } else if (type === 'short-answer') {
                    // Normalize answers for comparison: trim whitespace and convert to lowercase
                    const correctAnswer = (item.answer || '').toString().trim().toLowerCase();
                    const studentAnswer = (userAnswer || '').toString().trim().toLowerCase();
                    isCorrect = studentAnswer === correctAnswer;
                    if (isCorrect) {
                        score += pointsPerSa;
                    }
                } else {
                    isCorrect = null; // For 'essay' type
                }
                answerDetails.push({ questionNumber: index + 1, isCorrect, type, details: detail });
            });
            return { score, totalPossibleScore, answerDetails };
        }
        
        function renderReview(answerDetails) {
            let reviewHTML = '<h3 class="text-2xl font-bold mb-6">Xem lại bài làm</h3>';
            quizData.forEach((item, index) => {
                reviewHTML += `<div class="mb-6 p-4 border rounded-lg">`;
                reviewHTML += `<p class="font-semibold mb-2">Câu ${index + 1}:</p><div class="prose max-w-none">${item.rendered_question}</div>`;
                const type = mapType(item.type);
                const detail = answerDetails.find(d => d.questionNumber === index + 1);

                if (type === 'multiple-choice') {
                     reviewHTML += '<div class="mt-4 space-y-2">';
                     (item.rendered_options || []).forEach((opt, i) => {
                        let classes = 'option p-3 border-2 rounded-lg flex items-start';
                        if (i === item.correctAnswerIndex) classes += ' correct';
                        if (userAnswers[index] === i && i !== item.correctAnswerIndex) classes += ' incorrect';
                        reviewHTML += `<div class="${classes}"><span class="font-bold mr-2">${String.fromCharCode(65 + i)}.</span> <div>${opt}</div></div>`;
                     });
                     reviewHTML += '</div>';
                } else if (type === 'true-false') {
                     reviewHTML += '<div class="mt-4 space-y-2">';
                     (item.statements || []).forEach((stmt, i) => {
                         let classes = 'p-3 border-2 rounded-lg flex items-center justify-between gap-4';
                         const userChoice = userAnswers[index] ? userAnswers[index][i] : null;
                         const isCorrect = userChoice === stmt.is_correct;
                         if (isCorrect) classes += ' bg-green-50 border-green-300';
                         else if (userChoice !== null) classes += ' bg-red-50 border-red-300';
                         else classes += ' bg-gray-50 border-gray-200';

                         reviewHTML += `<div class="${classes}">
                                         <div class="prose max-w-none">${stmt.rendered_statement}</div>
                                         <div class="flex-shrink-0 font-bold text-sm text-right">
                                             <span>Đáp án: ${stmt.is_correct ? 'Đ' : 'S'}</span><br>
                                             <span>Bạn chọn: ${userChoice === true ? 'Đ' : userChoice === false ? 'S' : '...'}</span>
                                         </div>
                                     </div>`;
                     });
                     reviewHTML += '</div>';
                } else {
                    reviewHTML += `<div class="mt-4 p-3 bg-gray-100 rounded-lg"><strong>Câu trả lời của bạn:</strong><br>${userAnswers[index] || '<em>Chưa trả lời</em>'}</div>`;
                    if (item.rendered_answer) {
                        reviewHTML += `<div class="mt-2 p-3 bg-blue-50 rounded-lg"><strong>Đáp án gợi ý:</strong><br><div class="prose max-w-none">${item.rendered_answer}</div></div>`;
                    }
                }
                
                if (options.showExplanation) {
                     reviewHTML += `<div class="mt-4">
                                      <button class="text-sm text-blue-600 hover:underline" onclick="toggleExplanation(${index}, this)">Xem giải thích từ AI</button>
                                      <div id="explanation-${index}" class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg hidden"></div>
                                   </div>`;
                }
                reviewHTML += '</div>';
            });
            reviewContainer.innerHTML = reviewHTML;
            safeTypeset([reviewContainer]);
        }

        function retryQuiz() {
            retriesCount++;
            startQuiz();
        }
        
        function startTimer() {
            stopTimer();
            timerInterval = setInterval(() => {
                timeRemaining--;
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                if (timeRemaining <= 0) {
                    stopTimer();
                    alert('Đã hết thời gian làm bài!');
                    submitQuiz();
                }
            }, 1000);
        }

        function stopTimer() { clearInterval(timerInterval); }
        
        function showWarning(message) {
            warningEl.textContent = message;
            warningEl.style.display = 'block';
            warningEl.style.animation = 'none';
            warningEl.offsetHeight; 
            warningEl.style.animation = 'fade-in-out 5s ease-in-out';
        }

        function handleVisibilityChange() {
            if (document.hidden) {
                monitoringLog.thoatManHinh++;
                showWarning('⚠️ Đã phát hiện chuyển tab hoặc thu nhỏ cửa sổ!');
            }
        }
        function handleCopy() { monitoringLog.saoChep++; showWarning('⚠️ Đã phát hiện hành vi sao chép!'); }
        function handlePaste() { monitoringLog.dan++; showWarning('⚠️ Đã phát hiện hành vi dán!'); }
        function startMonitoring() {
            monitoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0 };
            document.addEventListener('visibilitychange', handleVisibilityChange);
            document.addEventListener('copy', handleCopy);
            document.addEventListener('paste', handlePaste);
        }
        function stopMonitoring() {
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            document.removeEventListener('copy', handleCopy);
            document.removeEventListener('paste', handlePaste);
        }

        async function toggleExplanation(index, button) {
            const explanationContainer = document.getElementById(`explanation-${index}`);
            if (!explanationContainer) return;

            const isHidden = explanationContainer.classList.toggle('hidden');
            button.textContent = isHidden ? 'Xem giải thích từ AI' : 'Ẩn giải thích';

            const hasLoaded = explanationContainer.hasAttribute('data-loaded');
            const hadError = explanationContainer.getAttribute('data-loaded') === 'error';

            if (!isHidden && (!hasLoaded || hadError)) {
                await fetchAndRenderExplanation(index);
            }
        }

        async function fetchAndRenderExplanation(index) {
            const explanationContainer = document.getElementById(`explanation-${index}`);
            explanationContainer.innerHTML = '<div class="animate-pulse">AI đang suy nghĩ...</div>';
            explanationContainer.setAttribute('data-loaded', 'loading');

            if (!API_KEY) {
                explanationContainer.innerHTML = '<p class="text-red-600">Lỗi: API Key của giáo viên chưa được cấu hình.</p>';
                explanationContainer.setAttribute('data-loaded', 'error');
                return;
            }
            
            try {
                const ai = new GoogleGenAI({ apiKey: API_KEY });
                const item = quizData[index];
                const questionText = (mapType(item.type) === 'true-false') ? (item.main_question || '') : (item.question || '');
                let prompt = `Bạn là một trợ lý giáo viên AI, am hiểu sâu sắc Chương trình GDPT 2018 của Việt Nam. Hãy cung cấp một lời giải chi tiết, từng bước một cho câu hỏi sau đây.\n---**CÂU HỎI:**\n${questionText}\n---`;
                
                if (mapType(item.type) === 'multiple-choice') {
                    prompt += `\n**ĐÁP ÁN ĐÚNG:** ${String.fromCharCode(65 + item.correctAnswerIndex)}. ${item.options[item.correctAnswerIndex] || ''}`;
                } else if (mapType(item.type) === 'true-false') {
                    prompt += `\n**CÁC MỆNH ĐỀ VÀ ĐÁP ÁN:**\n${item.statements.map((s, i) => `${String.fromCharCode(97 + i)}) ${s.statement || ''} -> ${s.is_correct ? 'Đúng' : 'Sai'}`).join('\n')}`;
                } else {
                    prompt += `---\n**ĐÁP ÁN / GỢI Ý:** ${item.answer || ''}`;
                }
                prompt += `\n---\n**YÊU CẦU:** Giải thích chi tiết, từng bước. Định dạng công thức toán bằng LaTeX. Dùng **...** để in đậm.`;
                
                // Use fallback function here
                const response = await generateContentWithFallback(ai, prompt);
                const explanationText = response.text || "Không thể tạo giải thích.";
                
                let htmlContent = explanationText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                explanationContainer.innerHTML = htmlContent;
                safeTypeset([explanationContainer]);
                explanationContainer.setAttribute('data-loaded', 'true');

            } catch (error) {
                console.error("AI Explanation Error:", error);
                let errorMessage = "Lỗi khi tạo giải thích.";
                if (error && error.message) {
                    const sanitizedMessage = error.message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    errorMessage += `<br><small class="text-gray-500">Chi tiết: ${sanitizedMessage}</small>`;
                }
                explanationContainer.innerHTML = `<div class="text-red-600">${errorMessage}</div>
                                                  <a href="#" onclick="event.preventDefault(); fetchAndRenderExplanation(${index})" class="text-sm text-blue-600 hover:underline mt-2">Thử lại giải thích</a>`;
                explanationContainer.setAttribute('data-loaded', 'error');
            }
        }

        async function getAIAssessment(score, answerDetails) {
            if (!API_KEY) {
                const errorMsg = "Không thể tạo nhận xét do API Key của giáo viên chưa được cấu hình.";
                assessmentDisplay.innerHTML = `<strong>Nhận xét từ AI:</strong> <br> <p class="text-red-600">${errorMsg}</p>`;
                assessmentDisplay.classList.remove('hidden');
                return errorMsg;
            }
            
            assessmentDisplay.innerHTML = '<strong>Nhận xét từ AI:</strong> <span class="animate-pulse">AI đang phân tích bài làm...</span>';
            assessmentDisplay.classList.remove('hidden');

            try {
                const ai = new GoogleGenAI({ apiKey: API_KEY });
                const wrongAnswers = answerDetails.filter(d => d.isCorrect === false || (d.type === 'true-false' && d.details && d.details.some(sub => !sub.isCorrect)));
                if (wrongAnswers.length === 0) {
                    const congrats = "Chúc mừng em đã hoàn thành bài làm rất tốt và không sai câu nào! Em đã nắm vững kiến thức. Hãy tiếp tục phát huy nhé!";
                    assessmentDisplay.innerHTML = `<strong>Nhận xét từ AI:</strong> <br> ${congrats}`;
                    return congrats;
                }
                const wrongQuestionsSummary = wrongAnswers.map(d => {
                    const item = quizData[d.questionNumber - 1];
                    const questionText = item.question || item.main_question || '';
                    return `- Câu ${d.questionNumber}: ${questionText}`;
                }).join('\n');
                
                const prompt = `Bạn là một giáo viên AI tận tâm. Dựa vào kết quả bài làm sau, hãy đưa ra một nhận xét chi tiết (4-5 câu) về năng lực của học sinh.\n**Kết quả:**\n- Điểm số: ${score} / 10\n- Các câu sai:\n${wrongQuestionsSummary}\n**YÊU CẦU:**\n1. Bắt đầu bằng lời động viên.\n2. Phân tích nội dung các câu sai để **xác định cụ thể các mảng kiến thức học sinh còn yếu.**\n3. Đưa ra gợi ý cụ thể để khắc phục.\n4. Kết thúc bằng lời khích lệ.\n5. Giọng văn thân thiện, tích cực.`;

                // Use fallback function here
                const response = await generateContentWithFallback(ai, prompt);
                const assessmentText = response.text || "Không thể tạo nhận xét.";
                
                assessmentDisplay.innerHTML = `<strong>Nhận xét từ AI:</strong> <br> ${assessmentText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>')}`;
                return assessmentText;

            } catch (error) {
                console.error("AI Assessment Error:", error);
                let errorMessage = "Đã có lỗi xảy ra trong quá trình AI tạo nhận xét.";
                if (error && error.message) {
                    const sanitizedMessage = error.message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    errorMessage += `<br><small class="text-gray-500">Chi tiết: ${sanitizedMessage}</small>`;
                }
                assessmentDisplay.innerHTML = `<strong>Nhận xét từ AI:</strong> <br> <div class="text-red-600">${errorMessage}</div>
                                               <button onclick="retryAIAssessment()" class="text-sm text-blue-600 hover:underline mt-2">Thử lại</button>`;
                return "Lỗi khi tạo nhận xét AI.";
            }
        }
        
        async function retryAIAssessment() {
            if (lastAnswerDetails) {
                const finalScore = (lastScore / (quizData.length > 0 ? 10 : 1) * 10).toFixed(2);
                await getAIAssessment(finalScore, lastAnswerDetails);
            }
        }
    </script>
</body>
</html>
    