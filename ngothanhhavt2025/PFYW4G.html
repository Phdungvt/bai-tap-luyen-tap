
    <!DOCTYPE html>
    <html lang="vi">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Bài Tập Luyện Tập</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
        <script>
            window.MathJax = {
                tex: {
                    packages: {'[+]': ['ams']},
                    inlineMath: [['$', '$'], ['\\(', '\\)']],
                    displayMath: [['$$', '$$'], ['\\[', '\\]']]
                },
                chtml: {
                    fontCache: 'global',
                    linebreaks: {
                        automatic: true
                    }
                }
            };
        </script>
        <script type="text/javascript" id="MathJax-script" async
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
        </script>
        <style>
            body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #f0f4f8; }
            .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
            @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
            .question-card {
                background-color: white;
                border-radius: 1rem;
                padding: 1.5rem 2rem;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                border-left: 5px solid transparent;
                transition: all 0.3s ease;
            }
            .ai-explanation {
                background-color: #f0f9ff;
                color: #0c4a6e;
                padding: 1rem;
                border-radius: 0.75rem;
                font-size: 0.9rem;
                margin-top: 1rem;
                border-left: 4px solid #38bdf8;
            }
            .feedback-icon { width: 1.5rem; height: 1.5rem; }
            .option-label {
                transition: all 0.2s ease-in-out;
                border: 2px solid #e5e7eb;
            }
            .option-label:hover {
                border-color: #6366f1;
                background-color: #eef2ff;
            }
            .option-label.correct {
                border-color: #10b981 !important;
                background-color: #ecfdf5 !important;
                color: #065f46;
            }
            .option-label.incorrect {
                border-color: #ef4444 !important;
                background-color: #fef2f2 !important;
                color: #991b1b;
            }
            .statement-item.correct { background-color: #ecfdf5; border-color: #10b981; }
            .statement-item.incorrect { background-color: #fef2f2; border-color: #ef4444; }
            .tts-btn { transition: all 0.2s ease; }
            .tts-btn:hover { background-color: #e0e7ff; }
            .tts-btn.playing { color: #4f46e5; }
            .prose { max-width: 100%; }
            .prose h1, .prose h2, .prose h3 { font-weight: 600; }
            .prose p { margin-top: 0.5em; margin-bottom: 0.5em; }
            .prose ul, .prose ol { margin-top: 1em; margin-bottom: 1em; padding-left: 1.5em; }
            .prose li > p { margin-top: 0; margin-bottom: 0; }
            .prose code { background-color: #e5e7eb; padding: 0.2em 0.4em; margin: 0; font-size: 85%; border-radius: 3px; }
            .prose pre { background-color: #e5e7eb; padding: 1em; border-radius: 0.5em; overflow-x: auto; }
            .prose pre code { background-color: transparent; padding: 0; }
            details[open] > summary .details-arrow {
                transform: rotate(180deg);
            }
        </style>
    </head>
    <body class="bg-slate-100 text-slate-800">
        <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md transform transition-all" style="animation: fadeIn 0.3s ease-out;">
                <h2 class="text-2xl font-bold mb-2 text-center text-slate-800">Thông Tin Học Sinh</h2>
                <p class="text-center text-slate-500 mb-6">Vui lòng nhập để bắt đầu làm bài.</p>
                <form id="student-info-form">
                    <div class="mb-4">
                        <label for="student-name" class="block text-sm font-medium text-slate-700 mb-1">Họ và tên</label>
                        <input type="text" id="student-name" required class="mt-1 block w-full block border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="student-class" class="block text-sm font-medium text-slate-700 mb-1">Lớp</label>
                        <input type="text" id="student-class" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="exam-code" class="block text-sm font-medium text-slate-700 mb-1">Mã đề</label>
                        <input type="text" id="exam-code" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Nhập mã đề giáo viên cung cấp">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Giáo viên:</label>
                        <p class="mt-1 text-slate-800 bg-slate-100 p-2.5 rounded-lg">NGO THANH HA</p>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">Bắt đầu làm bài</button>
                </form>
            </div>
        </div>
        <div class="container mx-auto p-4 md:p-8 max-w-4xl">
            <header class="mb-10 p-8 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg">
                <div class="flex justify-between items-center flex-wrap gap-4">
                    <div>
                        <h1 class="text-4xl font-bold">Bài Tập Luyện Tập</h1>
                        <p class="text-lg text-blue-100 mt-2">Hãy hoàn thành các câu hỏi dưới đây một cách tốt nhất!</p>
                        <p class="text-sm text-blue-200 mt-4">Tác giả: NGO THANH HA</p>
                    </div>
                    <div id="timer-container" class="text-right">
                         <div id="timer-display" class="text-3xl font-bold tracking-wider bg-white/20 px-4 py-2 rounded-lg">--:--</div>
                         <div id="retries-display" class="text-sm mt-1 text-blue-200"></div>
                    </div>
                </div>
            </header>
            <main id="student-quiz-container" class="space-y-8 hidden">
                <!-- Questions will be rendered here by JS -->
            </main>
            <footer class="mt-10 text-center">
                <button id="submit-quiz-btn" class="bg-indigo-600 text-white py-3 px-12 rounded-full font-bold text-lg hover:bg-indigo-700 transition-all duration-300 shadow-lg hover:shadow-xl hidden transform hover:scale-105">Nộp Bài</button>
                <div id="result-container" class="mt-6 hidden"></div>
                <div id="ai-feedback-container" class="mt-8 text-left hidden"></div>
                <div id="post-submit-options" class="hidden mt-6 flex flex-col sm:flex-row items-center justify-center gap-4">
                    <button id="retry-quiz-btn" class="w-full sm:w-auto bg-slate-600 text-white py-2.5 px-6 rounded-lg font-semibold hover:bg-slate-700 transition-transform transform hover:scale-105">Làm Lại Đề Này</button>
                </div>
            </footer>
        </div>

        <div id="proctoring-widget" class="fixed bottom-4 right-4 bg-yellow-100 text-yellow-800 p-3 rounded-lg shadow-lg text-sm z-50 hidden border border-yellow-300" style="max-width: 200px;">
            <h4 class="font-bold mb-2 border-b border-yellow-300 pb-1 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 3.001-1.742 3.001H4.42c-1.53 0-2.493-1.667-1.743-3.001l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                Giám sát
            </h4>
            <p>Thoát màn hình: <span id="tab-switch-count" class="font-bold">0</span></p>
            <p>Sao chép: <span id="copy-count" class="font-bold">0</span></p>
            <p>Dán: <span id="paste-count" class="font-bold">0</span></p>
        </div>

        <script type="module">
            import { GoogleGenAI, Type } from "https://esm.sh/@google/genai@^1.13.0";
            let quizData = [{"type":"multiple-choice","question":"Đồ thị sau đây [Lỗi render hình ảnh] là của hàm số nào?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["$y = \\dfrac{x+1}{x-2}$","$y = \\dfrac{x-1}{x+2}$","$y = \\dfrac{x+1}{2-x}$","$y = \\dfrac{2x+1}{x-2}$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Đồ thị hàm số được cho bên dưới [Lỗi render hình ảnh] là của hàm số nào?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["$y = \\dfrac{x-1}{x+2}$","$y = \\dfrac{2x-1}{x+1}$","$y = \\dfrac{x+1}{2x-1}$","$y = \\dfrac{2x+1}{x-1}$"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Cho đồ thị hàm số [Lỗi render hình ảnh] như hình vẽ. Hỏi đây là đồ thị của hàm số nào?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["$y = \\dfrac{x+3}{x-1}$","$y = \\dfrac{-x+3}{x+1}$","$y = \\dfrac{-x+3}{x-1}$","$y = \\dfrac{x-3}{x-1}$"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Đồ thị sau đây là của hàm số nào?[Lỗi render hình ảnh]","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["$y = x^3 - 3x + 2$","$y = -x^3 + 3x + 2$","$y = x^3 + 3x + 2$","$y = x^4 - 3x^2 + 2$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Đồ thị sau đây là của hàm số nào?[Lỗi render hình ảnh]","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["$y = -x^3 + 3x^2 - 1$","$y = x^3 - 3x^2 - 1$","$y = -x^3 - 3x^2 - 1$","$y = -x^4 + 3x^2 - 1$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Đồ thị sau đây là của hàm số nào?[Lỗi render hình ảnh]","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["$y = \\dfrac{x-1}{x+2}$","$y = \\dfrac{x+1}{x-2}$","$y = \\dfrac{-x+1}{x+2}$","$y = \\dfrac{x^2-1}{x+2}$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Hàm số nào dưới đây có đồ thị như hình vẽ bên?[Lỗi render hình ảnh]","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["$y = \\dfrac{2x-1}{x-1}$","$y = \\dfrac{x-2}{x-1}$","$y = \\dfrac{2x+1}{x-1}$","$y = \\dfrac{x+2}{x-1}$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Hàm số nào dưới đây có đồ thị như hình vẽ bên?[Lỗi render hình ảnh]","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["$y = x^3 - 3x^2 + 2$","$y = -x^3 + 3x^2 + 2$","$y = x^3 + 3x^2 + 2$","$y = -x^3 - 3x^2 + 2$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Hàm số nào dưới đây có đồ thị như hình vẽ bên?[Lỗi render hình ảnh]","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["$y = \\dfrac{x+1}{2x-2}$","$y = \\dfrac{x-1}{2x+2}$","$y = \\dfrac{2x+1}{x-2}$","$y = \\dfrac{x-2}{2x+1}$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Đồ thị dưới đây là của hàm số nào?[Lỗi render hình ảnh]","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["$y = \\dfrac{x-1}{x+1}$","$y = \\dfrac{x+1}{x-1}$","$y = \\dfrac{x-1}{-x+1}$","$y = \\dfrac{2x-1}{x+1}$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Đồ thị dưới đây là của hàm số nào?[Lỗi render hình ảnh]","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["$y = x^3 - 3x^2 + 2$","$y = x^3 - 3x + 2$","$y = -x^3 + 3x^2 + 2$","$y = x^3 + 3x^2 + 2$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Đồ thị nào sau đây là của hàm số $y = -x^3 + 3x - 2$?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["[Lỗi render hình ảnh]","[Lỗi render hình ảnh]","[Lỗi render hình ảnh]","[Lỗi render hình ảnh]"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Quan sát đồ thị của hàm số $y=f(x)$ dưới đây. Hãy chọn phương án đúng về hàm số đã cho.[Lỗi render hình ảnh]","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["$y = x^3 - 3x^2 + 2$","$y = x^3 + 3x^2 + 2$","$y = -x^3 - 3x^2 + 2$","$y = -x^3 + 3x^2 + 2$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Đồ thị của hàm số $y = x^3 - 6x^2 + 9x - 1$ có tâm đối xứng là điểm nào sau đây?[Lỗi render hình ảnh]","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["$(2; 1)$","$(1; 3)$","$(2; -1)$","$(1; 1)$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Quan sát đồ thị của hàm số sau: [Lỗi render hình ảnh]Hàm số nào dưới đây có đồ thị như hình vẽ bên?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["$y = x^3 - 3x^2$","$y = -x^3 + 3x^2$","$y = x^3 - x^2$","$y = x^3 + 3x^2$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Quan sát đồ thị của hàm số sau: [Lỗi render hình ảnh]Đồ thị trên là của hàm số nào dưới đây?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["$y = \\dfrac{x+1}{x-2}$","$y = \\dfrac{x-1}{x-2}$","$y = \\dfrac{-x+1}{x-2}$","$y = \\dfrac{x+1}{x+2}$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Quan sát đồ thị của hàm số sau: [Lỗi render hình ảnh]Tọa độ tâm đối xứng của đồ thị hàm số $y = x^3 - 3x^2 - 9x + 2$ là điểm nào dưới đây?","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["$(1; -9)$","$(-1; 9)$","$(1; 9)$","$(-1; -9)$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Đồ thị sau đây là của hàm số nào?[Lỗi render hình ảnh]","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["$y = \\dfrac{x}{x-1}$","$y = \\dfrac{x+1}{x-1}$","$y = \\dfrac{x}{1-x}$","$y = \\dfrac{x-1}{x}$"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Đồ thị sau đây là của hàm số nào?[Lỗi render hình ảnh]","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["$y = x^3 - 3x$","$y = -x^3 + 3x$","$y = x^3 - x$","$y = -x^3 + x$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Tìm tọa độ tâm đối xứng của đồ thị hàm số $y = x^3 - 3x^2 + 2x - 1$.","questionImage":null,"explanation":null,"mappedType":"multiple-choice","options":["$(1; -1)$","$(1; 0)$","$(-1; 1)$","$(0; -1)$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"true-false","main_question":"Cho đồ thị của hàm số $y = f(x)$ như hình vẽ sau: [Lỗi render hình ảnh]. Phát biểu nào sau đây là đúng hoặc sai?","questionImage":null,"explanation":null,"mappedType":"true-false","statements":[{"statement":"(a) Hàm số có hai điểm cực trị.","is_correct":true},{"statement":"(b) Hàm số đồng biến trên khoảng $(-\\infty; 0)$ và $(2; +\\infty)$.","is_correct":true},{"statement":"(c) Tâm đối xứng của đồ thị hàm số là điểm $I(1; 0)$.","is_correct":true},{"statement":"(d) Phương trình $f(x) = 1$ có đúng ba nghiệm thực phân biệt.","is_correct":false}]},{"type":"true-false","main_question":"Cho đồ thị hàm số $y = \\dfrac{x+1}{x-1}$ như hình vẽ sau: [Lỗi render hình ảnh]. Phát biểu nào sau đây là đúng hoặc sai?","questionImage":null,"explanation":null,"mappedType":"true-false","statements":[{"statement":"(a) Đồ thị hàm số có tiệm cận đứng là đường thẳng $x=1$.","is_correct":true},{"statement":"(b) Hàm số nghịch biến trên từng khoảng xác định của nó.","is_correct":true},{"statement":"(c) Đồ thị hàm số cắt trục hoành tại điểm có hoành độ bằng $0$.","is_correct":false},{"statement":"(d) Tâm đối xứng của đồ thị hàm số có tọa độ là $(1; 1)$.","is_correct":true}]},{"type":"true-false","main_question":"Cho bảng biến thiên của hàm số $y=f(x)$ như sau: [Lỗi render hình ảnh]. Phát biểu nào sau đây là đúng hoặc sai?","questionImage":null,"explanation":null,"mappedType":"true-false","statements":[{"statement":"(a) Hàm số đạt cực tiểu tại điểm $x=1$.","is_correct":true},{"statement":"(b) Hàm số nghịch biến trên khoảng $(-1; 1)$.","is_correct":true},{"statement":"(c) Đồ thị hàm số cắt trục hoành tại đúng ba điểm phân biệt.","is_correct":true},{"statement":"(d) Phương trình $f(x) = 2$ có đúng hai nghiệm thực phân biệt.","is_correct":false}]},{"type":"true-false","main_question":"Cho đồ thị hàm số $y=x^3-3x^2+2$ như hình vẽ bên. Hãy cho biết các mệnh đề sau là đúng hay sai: [Lỗi render hình ảnh]","questionImage":null,"explanation":null,"mappedType":"true-false","statements":[{"statement":"Hàm số $y=x^3-3x^2+2$ đồng biến trên khoảng $(0; 2)$.","is_correct":false},{"statement":"Đồ thị hàm số có đúng $2$ điểm cực trị.","is_correct":true},{"statement":"Tâm đối xứng của đồ thị hàm số là điểm có tọa độ $(1; 0)$.","is_correct":true},{"statement":"Đồ thị hàm số cắt trục hoành tại $2$ điểm phân biệt.","is_correct":false}]},{"type":"true-false","main_question":"Cho đồ thị hàm số $y=\\dfrac{2x+1}{x-1}$ như hình vẽ bên. Hãy cho biết các mệnh đề sau là đúng hay sai: [Lỗi render hình ảnh]","questionImage":null,"explanation":null,"mappedType":"true-false","statements":[{"statement":"Đường thẳng $x=1$ là tiệm cận đứng của đồ thị hàm số.","is_correct":true},{"statement":"Hàm số đồng biến trên khoảng $(1; +\\infty)$.","is_correct":false},{"statement":"Đồ thị hàm số cắt trục tung tại điểm có tung độ bằng $1$.","is_correct":false},{"statement":"Giao điểm của hai đường tiệm cận là tâm đối xứng của đồ thị hàm số và có tọa độ $(1; 2)$.","is_correct":true}]},{"type":"true-false","main_question":"Cho bảng biến thiên của hàm số $y=-x^3+3x-1$ như hình vẽ bên. Hãy cho biết các mệnh đề sau là đúng hay sai: [Lỗi render hình ảnh]","questionImage":null,"explanation":null,"mappedType":"true-false","statements":[{"statement":"Giá trị cực đại của hàm số là $1$.","is_correct":true},{"statement":"Hàm số nghịch biến trên khoảng $(0; +\\infty)$.","is_correct":false},{"statement":"Phương trình $-x^3+3x-1=0$ có đúng $3$ nghiệm thực phân biệt.","is_correct":true},{"statement":"Đồ thị hàm số có tâm đối xứng là gốc tọa độ $O(0;0)$.","is_correct":false}]},{"type":"true-false","main_question":"Cho đồ thị hàm số $y = x^3 - 3x^2 + 2$ như hình vẽ bên. [Lỗi render hình ảnh] Hãy cho biết các mệnh đề sau là đúng hay sai:","questionImage":null,"explanation":null,"mappedType":"true-false","statements":[{"statement":"a) Đồ thị đã cho là đồ thị của một hàm số bậc ba.","is_correct":true},{"statement":"b) Hàm số đã cho có hai điểm cực trị.","is_correct":true},{"statement":"c) Đồ thị hàm số cắt trục hoành tại ba điểm phân biệt.","is_correct":true},{"statement":"d) Tâm đối xứng của đồ thị hàm số có tọa độ là $(1; -2)$.","is_correct":false}]},{"type":"true-false","main_question":"Cho đồ thị hàm số $y = \\dfrac{2x+1}{x-1}$ như hình vẽ bên. [Lỗi render hình ảnh] Hãy cho biết các mệnh đề sau là đúng hay sai:","questionImage":null,"explanation":null,"mappedType":"true-false","statements":[{"statement":"a) Đồ thị hàm số có tiệm cận đứng là đường thẳng $x=1$.","is_correct":true},{"statement":"b) Hàm số nghịch biến trên các khoảng $(-\\infty; 1)$ và $(1; +\\infty)$.","is_correct":true},{"statement":"c) Đồ thị hàm số cắt trục hoành tại điểm có hoành độ bằng $1$.","is_correct":false},{"statement":"d) Tâm đối xứng của đồ thị hàm số có tọa độ là $(1; 2)$.","is_correct":true}]},{"type":"true-false","main_question":"Cho bảng biến thiên của hàm số $y = -x^3 + 3x + 1$ như sau. [Lỗi render hình ảnh] Hãy cho biết các mệnh đề sau là đúng hay sai:","questionImage":null,"explanation":null,"mappedType":"true-false","statements":[{"statement":"a) Hàm số đã cho là hàm số bậc ba.","is_correct":true},{"statement":"b) Giá trị cực đại của hàm số là $3$.","is_correct":true},{"statement":"c) Phương trình $y=2$ có ba nghiệm phân biệt.","is_correct":true},{"statement":"d) Phương trình $-x^3 + 3x + 1 = 4$ có đúng một nghiệm.","is_correct":true}]},{"type":"true-false","main_question":"Cho hàm số $y=f(x)$ có đồ thị như hình vẽ sau: [Lỗi render hình ảnh]. Hãy cho biết các mệnh đề sau là đúng hay sai:","questionImage":null,"explanation":null,"mappedType":"true-false","statements":[{"statement":"(a) Hàm số có hệ số của $x^3$ là dương.","is_correct":true},{"statement":"(b) Hàm số đồng biến trên khoảng $(-\\infty; -1)$.","is_correct":true},{"statement":"(c) Đồ thị hàm số cắt trục hoành tại $3$ điểm phân biệt.","is_correct":false},{"statement":"(d) Phương trình $f(x) = 4$ có $2$ nghiệm thực phân biệt.","is_correct":true}]},{"type":"true-false","main_question":"Cho hàm số $y=f(x)$ có bảng biến thiên như sau: [Lỗi render hình ảnh]. Hãy cho biết các mệnh đề sau là đúng hay sai:","questionImage":null,"explanation":null,"mappedType":"true-false","statements":[{"statement":"(a) Hàm số đã cho nghịch biến trên từng khoảng xác định.","is_correct":true},{"statement":"(b) Tập xác định của hàm số là $D = \\mathbb{R} \\setminus \\{1\\}$.","is_correct":true},{"statement":"(c) Đồ thị hàm số có tiệm cận đứng là $x=1$ và tiệm cận ngang là $y=2$.","is_correct":true},{"statement":"(d) Đồ thị hàm số không cắt trục tung.","is_correct":false}]},{"type":"true-false","main_question":"Cho hàm số $y=f(x)$ có đồ thị như hình vẽ sau: [Lỗi render hình ảnh]. Hãy cho biết các mệnh đề sau là đúng hay sai:","questionImage":null,"explanation":null,"mappedType":"true-false","statements":[{"statement":"(a) Hàm số có hai điểm cực trị.","is_correct":true},{"statement":"(b) Hàm số đồng biến trên khoảng $(-\\infty; -1)$.","is_correct":false},{"statement":"(c) Giá trị nhỏ nhất của hàm số trên đoạn $[-2; 0]$ là $-1$.","is_correct":true},{"statement":"(d) Phương trình $f(x)=0$ có đúng một nghiệm thực.","is_correct":false}]},{"type":"true-false","main_question":"Cho hàm số $y=f(x)$ có đồ thị như hình vẽ. [Lỗi render hình ảnh] Hãy chọn các phát biểu đúng hoặc sai.","questionImage":null,"explanation":null,"mappedType":"true-false","statements":[{"statement":"Hàm số đã cho là hàm số bậc ba.","is_correct":true},{"statement":"Hàm số có ba điểm cực trị.","is_correct":false},{"statement":"Hàm số đồng biến trên các khoảng $(-\\infty; 0)$ và $(2; +\\infty)$.","is_correct":true},{"statement":"Giá trị cực tiểu của hàm số là $2$.","is_correct":false}]},{"type":"true-false","main_question":"Cho hàm số $y=f(x)$ có bảng biến thiên như sau. [Lỗi render hình ảnh] Hãy chọn các phát biểu đúng hoặc sai.","questionImage":null,"explanation":null,"mappedType":"true-false","statements":[{"statement":"Hàm số đã cho là hàm số nhất biến.","is_correct":true},{"statement":"Đồ thị hàm số có tiệm cận ngang là đường thẳng $y=-1$.","is_correct":false},{"statement":"Hàm số nghịch biến trên khoảng $(-\\infty; -2)$.","is_correct":false},{"statement":"Đồ thị hàm số cắt trục tung tại điểm có tung độ $y = -\\frac{1}{2}$.","is_correct":true}]},{"type":"true-false","main_question":"Cho hàm số $y=f(x)$ có bảng biến thiên như sau. [Lỗi render hình ảnh] Hãy chọn các phát biểu đúng hoặc sai.","questionImage":null,"explanation":null,"mappedType":"true-false","statements":[{"statement":"Hàm số đạt cực đại tại $x=2$.","is_correct":true},{"statement":"Đồ thị hàm số nhận điểm $I(1; 3)$ làm tâm đối xứng.","is_correct":true},{"statement":"Phương trình $f(x)=0$ có đúng một nghiệm.","is_correct":false},{"statement":"Hàm số đạt giá trị lớn nhất trên đoạn $[-1; 1]$ tại $x=-1$.","is_correct":false}]},{"type":"true-false","main_question":"Cho đồ thị hàm số $y = x^3 - 3x^2 + 1$ như hình vẽ bên. Hãy cho biết các mệnh đề sau đúng hay sai: [Lỗi render hình ảnh]","questionImage":null,"explanation":null,"mappedType":"true-false","statements":[{"statement":"Hàm số đồng biến trên khoảng $(-\\infty; 0)$.","is_correct":true},{"statement":"Đồ thị hàm số đạt cực đại tại $x = 2$.","is_correct":false},{"statement":"Phương trình $f(x) = -4$ có ba nghiệm phân biệt.","is_correct":false},{"statement":"Đồ thị hàm số cắt trục hoành tại đúng ba điểm phân biệt.","is_correct":true}]},{"type":"true-false","main_question":"Cho đồ thị hàm số $y = \\dfrac{x+1}{x-2}$ như hình vẽ bên. Hãy cho biết các mệnh đề sau đúng hay sai: [Lỗi render hình ảnh]","questionImage":null,"explanation":null,"mappedType":"true-false","statements":[{"statement":"Hàm số đồng biến trên khoảng $(-\\infty; 2)$.","is_correct":false},{"statement":"Đồ thị hàm số có đường tiệm cận ngang là $y = 1$.","is_correct":true},{"statement":"Giao điểm của đồ thị hàm số với trục hoành là $(-1; 0)$.","is_correct":true},{"statement":"Tâm đối xứng của đồ thị hàm số có tọa độ là $(-2; 1)$.","is_correct":false}]},{"type":"true-false","main_question":"Cho đồ thị hàm số $y = -x^4 + 2x^2 + 1$ như hình vẽ bên. Hãy cho biết các mệnh đề sau đúng hay sai: [Lỗi render hình ảnh]","questionImage":null,"explanation":null,"mappedType":"true-false","statements":[{"statement":"Hàm số đồng biến trên khoảng $(-\\infty; -1)$.","is_correct":true},{"statement":"Đồ thị hàm số có ba điểm cực trị.","is_correct":true},{"statement":"Phương trình $f(x) = 2.5$ có bốn nghiệm phân biệt.","is_correct":false},{"statement":"Phương trình $f(x) = 1$ có đúng hai nghiệm phân biệt.","is_correct":false}]},{"type":"true-false","main_question":"Cho hàm số $y = x^3 - 3x^2 + 2$. Khẳng định nào sau đây là đúng?","questionImage":null,"explanation":null,"mappedType":"true-false","statements":[{"statement":"Hàm số đã cho là một hàm số bậc ba có hệ số của $x^3$ dương.","is_correct":true},{"statement":"Hàm số đồng biến trên khoảng $(0; 2)$.","is_correct":false},{"statement":"Đồ thị hàm số cắt trục hoành tại đúng ba điểm phân biệt.","is_correct":true},{"statement":"Điểm cực đại của đồ thị hàm số có tung độ bằng $-2$.","is_correct":false}]},{"type":"true-false","main_question":"Cho hàm số $y = \\dfrac{2x+1}{x-1}$. Khẳng định nào sau đây là đúng?","questionImage":null,"explanation":null,"mappedType":"true-false","statements":[{"statement":"Hàm số đã cho có tập xác định là $D = \\mathbb{R} \\setminus \\{1\\}$.","is_correct":true},{"statement":"Hàm số đồng biến trên khoảng $(1; +\\infty)$.","is_correct":false},{"statement":"Tâm đối xứng của đồ thị hàm số là điểm $(1; 2)$.","is_correct":true},{"statement":"Đồ thị hàm số không cắt trục hoành.","is_correct":false}]},{"type":"true-false","main_question":"Cho hàm số $y = -x^3 + 3x - 1$. Khẳng định nào sau đây là đúng?","questionImage":null,"explanation":null,"mappedType":"true-false","statements":[{"statement":"Hàm số đã cho là một hàm số bậc ba.","is_correct":true},{"statement":"Hàm số đồng biến trên khoảng $(-\\infty; -1)$.","is_correct":false},{"statement":"Phương trình $-x^3 + 3x - 1 = 1$ có đúng hai nghiệm thực phân biệt.","is_correct":true},{"statement":"Đồ thị hàm số không cắt trục tung.","is_correct":false}]},{"type":"true-false","main_question":"Cho hàm số $y = f(x)$ có đồ thị như hình vẽ. [Lỗi render hình ảnh] Phát biểu nào sau đây là đúng?","questionImage":null,"explanation":null,"mappedType":"true-false","statements":[{"statement":"Hàm số đã cho có hai điểm cực trị.","is_correct":true},{"statement":"Hàm số đồng biến trên khoảng $(0; +\\infty)$.","is_correct":false},{"statement":"Đồ thị hàm số cắt trục hoành tại $3$ điểm phân biệt.","is_correct":true},{"statement":"Tâm đối xứng của đồ thị hàm số là điểm $(1;-2)$.","is_correct":false}]},{"type":"true-false","main_question":"Cho hàm số $y = f(x)$ có đồ thị như hình vẽ. [Lỗi render hình ảnh] Phát biểu nào sau đây là đúng?","questionImage":null,"explanation":null,"mappedType":"true-false","statements":[{"statement":"Hàm số có tiệm cận đứng là đường thẳng $x=-2$.","is_correct":false},{"statement":"Hàm số nghịch biến trên khoảng $(-\\infty; 2)$ và $(2; +\\infty)$.","is_correct":true},{"statement":"Đồ thị hàm số cắt trục tung tại điểm có tung độ $y = -\\frac{1}{2}$.","is_correct":true},{"statement":"Đồ thị hàm số không có tâm đối xứng.","is_correct":false}]},{"type":"true-false","main_question":"Cho hàm số $y = f(x)$ có bảng biến thiên như sau: [Lỗi render hình ảnh] Hỏi mệnh đề nào sau đây là đúng?","questionImage":null,"explanation":null,"mappedType":"true-false","statements":[{"statement":"Hàm số có ba điểm cực trị.","is_correct":true},{"statement":"Giá trị cực đại của hàm số bằng $1$.","is_correct":false},{"statement":"Phương trình $f(x) = 0$ có đúng bốn nghiệm thực phân biệt.","is_correct":false},{"statement":"Phương trình $f(x) = m$ có bốn nghiệm thực phân biệt khi và chỉ khi $m \\in (1; 2)$.","is_correct":true}]},{"type":"true-false","main_question":"Cho hàm số $y = x^3 - 3x^2 + 2$ có đồ thị như sau: [Lỗi render hình ảnh] Khẳng định nào sau đây là đúng hoặc sai?","questionImage":null,"explanation":null,"mappedType":"true-false","statements":[{"statement":"Đồ thị hàm số có hai điểm cực trị.","is_correct":true},{"statement":"Hàm số nghịch biến trên khoảng $(0; 2)$.","is_correct":true},{"statement":"Phương trình $x^3 - 3x^2 + 2 = 3$ có đúng một nghiệm thực.","is_correct":true},{"statement":"Tâm đối xứng của đồ thị hàm số trùng với gốc tọa độ $O(0;0)$.","is_correct":false}]},{"type":"true-false","main_question":"Cho hàm số $y = \\dfrac{2x+1}{x-1}$ có bảng biến thiên như sau: [Lỗi render hình ảnh] Khẳng định nào sau đây là đúng hoặc sai?","questionImage":null,"explanation":null,"mappedType":"true-false","statements":[{"statement":"Hàm số có tập xác định là $D = \\mathbb{R} \\setminus \\{1\\}$.","is_correct":true},{"statement":"Đồ thị hàm số có tiệm cận ngang là đường thẳng $y = 1$.","is_correct":false},{"statement":"Hàm số đồng biến trên khoảng $(-\\infty; 1)$.","is_correct":false},{"statement":"Đồ thị hàm số cắt trục hoành tại điểm có hoành độ $x = -0.5$.","is_correct":true}]},{"type":"true-false","main_question":"Cho hàm số $y = -x^3 + 3x + 1$ có bảng biến thiên như sau: [Lỗi render hình ảnh] Khẳng định nào sau đây là đúng hoặc sai?","questionImage":null,"explanation":null,"mappedType":"true-false","statements":[{"statement":"Hàm số đạt cực tiểu tại $x = -1$.","is_correct":true},{"statement":"Giá trị cực tiểu của hàm số là $3$.","is_correct":false},{"statement":"Phương trình $-x^3 + 3x + 1 = 2$ có đúng ba nghiệm thực phân biệt.","is_correct":true},{"statement":"Phương trình $-x^3 + 3x + 1 = 5$ có đúng hai nghiệm thực phân biệt.","is_correct":false}]},{"type":"short-answer","question":"Một công ty sản xuất sản phẩm $X$. Lợi nhuận $L(x)$ (triệu đồng) thu được khi sản xuất $x$ nghìn sản phẩm được mô tả bởi hàm số $L(x) = -x^3 + 9x^2 - 15x + 10$. Dựa vào đồ thị của hàm số, hãy cho biết công ty cần sản xuất bao nhiêu nghìn sản phẩm để đạt được lợi nhuận tối đa? [Lỗi render hình ảnh]","questionImage":null,"explanation":null,"mappedType":"short-answer","answer":"5"},{"type":"short-answer","question":"Nồng độ thuốc trong máu của một bệnh nhân (đơn vị $\\text{mg/L}$) sau khi tiêm $t$ giờ được mô tả bởi hàm số $C(t) = \\dfrac{4t}{t^2+2t+2}$. Dựa vào đồ thị của hàm số, hãy xác định nồng độ thuốc tối đa trong máu mà bệnh nhân đạt được. Làm tròn kết quả đến hai chữ số thập phân. [Lỗi render hình ảnh]","questionImage":null,"explanation":null,"mappedType":"short-answer","answer":"0.83"},{"type":"short-answer","question":"Một nhà khoa học nghiên cứu sự phát triển của một loại cây trồng. Chiều cao $h(t)$ của cây (đơn vị $\\text{cm}$) sau $t$ tuần được mô tả bởi hàm số $h(t) = -t^4 + 10t^2 + 5$ với $t \\in [0; 3]$. Dựa vào đồ thị của hàm số trên đoạn này, hãy cho biết chiều cao tối đa mà cây đạt được. [Lỗi render hình ảnh]","questionImage":null,"explanation":null,"mappedType":"short-answer","answer":"30"},{"type":"short-answer","question":"Cho bảng biến thiên của hàm số $y=x^3-6x^2+9x+1$ như sau: [Lỗi render hình ảnh]. Tìm tất cả các giá trị nguyên của tham số $m$ để phương trình $x^3-6x^2+9x+1 = m$ có đúng $3$ nghiệm phân biệt.","questionImage":null,"explanation":null,"mappedType":"short-answer","answer":"3"},{"type":"short-answer","question":"Cho đồ thị hàm số $y = \\dfrac{3x+2}{x-1}$ như hình vẽ: [Lỗi render hình ảnh]. Xác định tổng hoành độ và tung độ của tâm đối xứng của đồ thị hàm số này.","questionImage":null,"explanation":null,"mappedType":"short-answer","answer":"4"},{"type":"short-answer","question":"Một nhà máy sản xuất linh kiện điện tử. Chi phí sản xuất $x$ nghìn sản phẩm (với $x$ được tính bằng đơn vị nghìn sản phẩm và $x \\ge 1$) được cho bởi hàm số $C(x) = x^3 - 9x^2 + 24x + 20$ (đơn vị: triệu đồng). Dựa vào đồ thị hàm số chi phí $C(x)$ như sau: [Lỗi render hình ảnh]. Hãy tìm chi phí sản xuất tối thiểu (tính bằng triệu đồng) nếu nhà máy bắt buộc phải sản xuất ít nhất $1$ nghìn sản phẩm.","questionImage":null,"explanation":null,"mappedType":"short-answer","answer":"36"},{"type":"short-answer","question":"Một công ty sản xuất đồ chơi ước tính lợi nhuận $P(x)$ (triệu đồng) thu được khi bán $x$ nghìn sản phẩm được mô tả bởi hàm số $P(x) = -x^3 + 6x^2 - 9x + 12$, với $x \\in [0; 5]$.[Lỗi render hình ảnh]Dựa vào đồ thị của hàm số $P(x)$ đã cho, giá trị lợi nhuận tối đa mà công ty có thể đạt được là bao nhiêu? (Làm tròn đến hàng đơn vị).","questionImage":null,"explanation":null,"mappedType":"short-answer","answer":"12"},{"type":"short-answer","question":"Một vật thể chuyển động có vận tốc $v(t)$ (m/s) tại thời điểm $t$ (giây) được mô tả bởi hàm số $v(t) = \\dfrac{2t+3}{t+1}$, với $t \\ge 0$.[Lỗi render hình ảnh]Dựa vào bảng biến thiên của hàm số $v(t)$ đã cho, khi thời gian $t$ rất lớn, vận tốc của vật thể sẽ tiến gần đến giá trị nào? (Làm tròn đến hàng đơn vị).","questionImage":null,"explanation":null,"mappedType":"short-answer","answer":"2"},{"type":"short-answer","question":"Cho hàm số $y = x^4 - 2x^2 + 3$ có đồ thị như hình vẽ.[Lỗi render hình ảnh]Tìm số giao điểm của đồ thị hàm số đã cho với đường thẳng $y=2$.","questionImage":null,"explanation":null,"mappedType":"short-answer","answer":"2"},{"type":"short-answer","question":"Lợi nhuận $P(x)$ của một công ty sản xuất $x$ nghìn sản phẩm được mô tả bởi hàm số $P(x) = -x^3 + 9x^2 - 15x - 7$ (đơn vị: nghìn USD). Dựa vào đồ thị hàm số lợi nhuận $P(x)$ (với $x$ là số sản phẩm sản xuất ra, $0 < x < 7$) bên dưới, hãy cho biết số sản phẩm (làm tròn đến hàng đơn vị) mà công ty cần sản xuất để đạt được lợi nhuận cao nhất. [Lỗi render hình ảnh]","questionImage":null,"explanation":null,"mappedType":"short-answer","answer":"5"},{"type":"short-answer","question":"Vận tốc $v(t)$ (đơn vị m/s) của một vật chuyển động được cho bởi hàm số $v(t) = -t^4 + 8t^2 + 5$ trong khoảng thời gian $t \\in [0; 3]$ giây. Dựa vào đồ thị vận tốc của vật chuyển động bên dưới, hãy xác định vận tốc lớn nhất (làm tròn đến hàng đơn vị) mà vật đạt được trong khoảng thời gian $t \\in [0; 3]$ giây. [Lỗi render hình ảnh]","questionImage":null,"explanation":null,"mappedType":"short-answer","answer":"21"},{"type":"short-answer","question":"Nồng độ thuốc $C(t)$ (đơn vị mg/L) trong máu của bệnh nhân sau $t$ giờ kể từ khi tiêm được cho bởi hàm số $C(t) = \\dfrac{2t+3}{t+1}$ với $t \\ge 0$. Dựa vào đồ thị nồng độ thuốc trong máu bên dưới, hãy cho biết nồng độ thuốc lớn nhất (làm tròn đến một chữ số thập phân) mà bệnh nhân có thể đạt được trong khoảng thời gian $t \\in [0; 5]$ giờ. [Lỗi render hình ảnh]","questionImage":null,"explanation":null,"mappedType":"short-answer","answer":"3.0"},{"type":"short-answer","question":"Một công ty dự kiến doanh thu $R(t)$ (đơn vị: nghìn đô la) từ quảng cáo phụ thuộc vào số tiền chi cho quảng cáo $t$ (đơn vị: nghìn đô la) theo công thức $R(t) = -0.01t^3 + 0.6t^2 + 2t + 10$. Chi phí quảng cáo là $t$. Lợi nhuận ròng của công ty được tính bằng $P(t) = R(t) - t$. Để tối đa hóa lợi nhuận, công ty nên chi bao nhiêu nghìn đô la cho quảng cáo? (Làm tròn kết quả đến hai chữ số thập phân)","questionImage":null,"explanation":null,"mappedType":"short-answer","answer":"40.81"},{"type":"short-answer","question":"Cho đồ thị hàm số $y = x^3 - 3x + 1$ như hình vẽ bên. Hỏi phương trình $x^3 - 3x + 1 = 2$ có bao nhiêu nghiệm thực?[Lỗi render hình ảnh]","questionImage":null,"explanation":null,"mappedType":"short-answer","answer":"3"},{"type":"short-answer","question":"Đồ thị hàm số $y = 2x^3 - 6x^2 + 5x - 7$ có tâm đối xứng là điểm $I(x_0; y_0)$. Tính giá trị của biểu thức $S = x_0 + 2y_0$.","questionImage":null,"explanation":null,"mappedType":"short-answer","answer":"-11"},{"type":"short-answer","question":"Một công ty sản xuất sản phẩm. Lợi nhuận $P(x)$ (đơn vị: nghìn đô la) từ việc sản xuất $x$ (đơn vị: trăm sản phẩm) được mô tả bởi bảng biến thiên của hàm số $P(x) = -x^3 + 12x^2 - 21x - 30$ như sau: [Lỗi render hình ảnh] Hỏi lợi nhuận tối đa mà công ty có thể đạt được là bao nhiêu? (Làm tròn đến hàng đơn vị).","questionImage":null,"explanation":null,"mappedType":"short-answer","answer":"68"},{"type":"short-answer","question":"Chiều cao $h(t)$ (đơn vị: mét) của một tên lửa mô hình sau $t$ giây kể từ khi phóng được cho bởi đồ thị của hàm số $h(t) = -t^4 + 10t^2 + 15$ như sau: [Lỗi render hình ảnh] (chỉ xét $t \\ge 0$). Hỏi chiều cao tối đa mà tên lửa đạt được là bao nhiêu? (Làm tròn đến hàng đơn vị).","questionImage":null,"explanation":null,"mappedType":"short-answer","answer":"40"},{"type":"short-answer","question":"Nồng độ $C(t)$ (đơn vị: mg/L) của một loại thuốc trong máu của bệnh nhân sau $t$ giờ kể từ khi sử dụng được mô tả bởi bảng biến thiên của hàm số $C(t) = \\dfrac{t^2 - 6t + 13}{t - 2}$ với $t > 2$ như sau: [Lỗi render hình ảnh] Hỏi nồng độ tối thiểu của thuốc trong máu là bao nhiêu? (Làm tròn đến hai chữ số thập phân).","questionImage":null,"explanation":null,"mappedType":"short-answer","answer":"2.47"},{"type":"short-answer","question":"Một công ty sản xuất đồ chơi ước tính lợi nhuận hàng ngày (tính bằng nghìn đô la) từ việc sản xuất $x$ trăm bộ đồ chơi được cho bởi hàm số $P(x) = -x^3 + 9x^2 - 15x + 30$, với $x \\in [0; 6]$. Quan sát đồ thị hàm số $P(x)$ sau để xác định lợi nhuận tối đa mà công ty có thể đạt được trong một ngày. [Lỗi render hình ảnh]","questionImage":null,"explanation":null,"mappedType":"short-answer","answer":"55"},{"type":"short-answer","question":"Vận tốc của một ô tô trên một đoạn đường được mô tả bởi hàm số $v(t) = t^3 - 6t^2 + 9t + 10$ (km/h) trong khoảng thời gian $t \\in [0; 4]$ giờ. Quan sát bảng biến thiên của hàm số $v(t)$ dưới đây để tìm vận tốc nhỏ nhất của ô tô trên đoạn đường này. [Lỗi render hình ảnh]","questionImage":null,"explanation":null,"mappedType":"short-answer","answer":"10"},{"type":"short-answer","question":"Để làm một chiếc hộp không nắp từ một tấm bìa hình vuông cạnh $20 \\text{ cm}$, người ta cắt bốn hình vuông nhỏ bằng nhau ở bốn góc rồi gập các cạnh lên. Gọi $x \\text{ (cm)}$ là độ dài cạnh hình vuông bị cắt. Thể tích của hộp là $V(x) = 4x^3 - 80x^2 + 400x$. Quan sát đồ thị hàm số $V(x)$ sau, hãy xác định độ dài cạnh của hình vuông cần cắt để thể tích chiếc hộp là lớn nhất. (Làm tròn kết quả đến hai chữ số thập phân). [Lỗi render hình ảnh]","questionImage":null,"explanation":null,"mappedType":"short-answer","answer":"3.33"}];
            const quizOptions = {"timeLimit":150,"retriesAllowed":1,"showAnswers":true,"showExplanation":true,"aiAssessment":true,"scoring":{"mc":2,"tf":3,"sa":5,"essay":0,"tfMethod":"progressive"}};
            const googleScriptUrl = "https://script.google.com/macros/s/AKfycbwySChC78GoE29SaqLvHl0TvvY5fJQhdbsEw5zQxB7s3nO60swLHa9BCKqIgvhzdgq-0w/exec";
            const correctExamCode = "PFYW4G";
            const teacherApiKey = "AIzaSyAh0vTRtwim78hSNczxmy2HWNy9R_rRZtU";
            let studentInfo = {};
            let isSubmitted = false;
            let timerInterval;
            let retriesLeft = quizOptions.retriesAllowed;
            let currentAudio = null; // To manage audio playback
            let studentApiKey = "";
            let ai = null;

            let proctoringLog = {
                thoatManHinh: 0,
                saoChep: 0,
                dan: 0,
                suKien: []
            };

            const studentQuizContainer = document.getElementById('student-quiz-container');
            const submitBtn = document.getElementById('submit-quiz-btn');
            const resultContainer = document.getElementById('result-container');
            const postSubmitOptions = document.getElementById('post-submit-options');
            const retryBtn = document.getElementById('retry-quiz-btn');
            const loginModal = document.getElementById('login-modal');
            const studentInfoForm = document.getElementById('student-info-form');
            const timerDisplay = document.getElementById('timer-display');
            const retriesDisplay = document.getElementById('retries-display');
            function shuffleQuiz() {
                // Shuffle options/statements within each question first
                quizData.forEach(item => {
                    // Shuffle multiple-choice options and their corresponding images
                    if (item.mappedType === 'multiple-choice' && item.options && item.options.length > 0) {
                        const correctAnswerText = item.options[item.correctAnswerIndex];
                        let optionsWithImages = item.options.map((opt, index) => ({
                            text: opt,
                            image: (item.optionsImage && item.optionsImage[index]) ? item.optionsImage[index] : null
                        }));
                        // Fisher-Yates shuffle
                        for (let i = optionsWithImages.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [optionsWithImages[i], optionsWithImages[j]] = [optionsWithImages[j], optionsWithImages[i]];
                        }
                        // Update the item with shuffled data
                        item.options = optionsWithImages.map(opt => opt.text);
                        item.optionsImage = optionsWithImages.map(opt => opt.image);
                        item.correctAnswerIndex = item.options.indexOf(correctAnswerText);
                    }
                    // Shuffle true-false statements
                    if (item.mappedType === 'true-false' && item.statements && item.statements.length > 0) {
                         for (let i = item.statements.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [item.statements[i], item.statements[j]] = [item.statements[j], item.statements[i]];
                        }
                    }
                });
                // Then, group questions by type and shuffle within each group
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});
                let shuffledQuizData = [];
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    if (grouped[partType]) {
                        const partQuestions = grouped[partType];
                        for (let i = partQuestions.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [partQuestions[i], partQuestions[j]] = [partQuestions[j], partQuestions[i]];
                        }
                        shuffledQuizData = shuffledQuizData.concat(partQuestions);
                    }
                });
               
                quizData = shuffledQuizData;
            }
            // --- Timer Function ---
            function startTimer(duration, display) {
                let timer = duration, minutes, seconds;
                clearInterval(timerInterval); // Clear any existing timer
                if(duration <= 0) {
                     display.textContent = "∞";
                     return;
                }
                timerInterval = setInterval(function () {
                    minutes = parseInt(timer / 60, 10);
                    seconds = parseInt(timer % 60, 10);
                    minutes = minutes < 10 ? "0" + minutes : minutes;
                    seconds = seconds < 10 ? "0" + seconds : seconds;
                    display.textContent = minutes + ":" + seconds;
                    if (--timer < 0) {
                        clearInterval(timerInterval);
                        alert("Hết giờ làm bài!");
                        handleSubmit();
                    }
                }, 1000);
            }
            // --- Gemini API Caller (for TTS) ---
            async function callGeminiAPI(payload, model = 'gemini-2.5-flash-preview-tts') {
                 if (!studentApiKey) {
                    alert("API Key không hợp lệ. Không thể thực hiện yêu cầu.");
                    return null;
                }
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${studentApiKey}`;
               
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`API Error: ${errorBody.error?.message || response.status}`);
                    }
                    const result = await response.json();
                    const candidate = result.candidates && result.candidates[0];
                    if (candidate && candidate.content && candidate.content.parts && candidate.content.parts[0]) {
                        return candidate.content.parts[0]; // Return the whole part
                    } else {
                         if (result.promptFeedback && result.promptFeedback.blockReason) {
                               throw new Error(`API call blocked: ${result.promptFeedback.blockReason}`);
                         }
                        return null;
                    }
                } catch (error) {
                    console.error("Lỗi khi gọi Gemini API:", error);
                    return null;
                }
            }
           
            // --- TTS Feature Functions ---
            function base64ToArrayBuffer(base64) {
                const binaryString = window.atob(base64);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return bytes.buffer;
            }
            function pcmToWav(pcmData, sampleRate) {
                const numChannels = 1;
                const bytesPerSample = 2; // 16-bit
                const blockAlign = numChannels * bytesPerSample;
                const byteRate = sampleRate * blockAlign;
                const dataSize = pcmData.byteLength;
                const buffer = new ArrayBuffer(44 + dataSize);
                const view = new DataView(buffer);
                /* RIFF identifier */
                writeString(view, 0, 'RIFF');
                /* file length */
                view.setUint32(4, 36 + dataSize, true);
                /* RIFF type */
                writeString(view, 8, 'WAVE');
                /* format chunk identifier */
                writeString(view, 12, 'fmt ');
                /* format chunk length */
                view.setUint32(16, 16, true);
                /* sample format (raw) */
                view.setUint16(20, 1, true);
                /* channel count */
                view.setUint16(22, numChannels, true);
                /* sample rate */
                view.setUint32(24, sampleRate, true);
                /* byte rate (sample rate * block align) */
                view.setUint32(28, byteRate, true);
                /* block align (channel count * bytes per sample) */
                view.setUint16(32, blockAlign, true);
                /* bits per sample */
                view.setUint16(34, 16, true);
                /* data chunk identifier */
                writeString(view, 36, 'data');
                /* data chunk length */
                view.setUint32(40, dataSize, true);
                // Write PCM data
                const pcm16 = new Int16Array(pcmData);
                for (let i = 0; i < pcm16.length; i++) {
                    view.setInt16(44 + i * 2, pcm16[i], true);
                }
                function writeString(view, offset, string) {
                    for (let i = 0; i < string.length; i++) {
                        view.setUint8(offset + i, string.charCodeAt(i));
                    }
                }
                return new Blob([view], { type: 'audio/wav' });
            }
            async function playTTS(text, button) {
                if (currentAudio && !currentAudio.paused) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                    document.querySelectorAll('.tts-btn.playing').forEach(b => b.classList.remove('playing'));
                    if (currentAudio.src.startsWith('blob:')) {
                        URL.revokeObjectURL(currentAudio.src);
                    }
                    if (currentAudio.dataset.text === text) {
                        currentAudio = null;
                        return; // Stop if the same button is clicked again
                    }
                }
                button.classList.add('playing');
                const originalIcon = button.innerHTML; // A bit tricky, but let's try
                button.innerHTML = '<div class="small-loader"></div>';
                button.disabled = true;
                try {
                    const payload = {
                        contents: [{ parts: [{ text: `Nói một cách rõ ràng, tự nhiên: ${text}` }] }],
                        generationConfig: { responseModalities: ["AUDIO"] },
                    };
                    const resultPart = await callGeminiAPI(payload, 'gemini-2.5-flash-preview-tts');
                    if (resultPart && resultPart.inlineData) {
                        const audioData = resultPart.inlineData.data;
                        const mimeType = resultPart.inlineData.mimeType;
                        const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                        const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;
                        const pcmData = base64ToArrayBuffer(audioData);
                        const wavBlob = pcmToWav(pcmData, sampleRate);
                        const audioUrl = URL.createObjectURL(wavBlob);
                        currentAudio = new Audio(audioUrl);
                        currentAudio.dataset.text = text;
                        currentAudio.play();
                        currentAudio.onended = () => {
                            button.classList.remove('playing');
                            URL.revokeObjectURL(audioUrl);
                            currentAudio = null;
                        };
                    } else {
                        throw new Error("Không nhận được dữ liệu âm thanh.");
                    }
                } catch (error) {
                    console.error("Lỗi TTS:", error);
                    alert("Không thể phát âm thanh. Vui lòng thử lại.");
                     button.classList.remove('playing');
                } finally {
                    button.innerHTML = originalIcon;
                    button.disabled = false;
                }
            }
            function getTextForTTS(item) {
                let text = item.question || item.main_question || '';
                text = text.replace(/\$/g, ''); // Remove LaTeX delimiters for cleaner speech
                if (item.mappedType === 'multiple-choice' && item.options) {
                    const optionsText = item.options.map((opt, i) => `${String.fromCharCode(65 + i)}. ${opt}`).join(' ');
                    text += ' ' + optionsText.replace(/\$/g, '');
                } else if (item.mappedType === 'true-false' && item.statements) {
                    const statementsText = item.statements.map((s, i) => `${String.fromCharCode(97 + i)}. ${s.statement}`).join(' ');
                    text += ' ' + statementsText.replace(/\$/g, '');
                }
                return text;
            }
            function renderStudentQuiz() {
                studentQuizContainer.innerHTML = '';
               
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});
                const groupInfo = {
                    'multiple-choice': { title: 'PHẦN I. TRẮC NGHIỆM KHÁCH QUAN', subtitle: 'Chọn đáp án đúng nhất trong các lựa chọn sau.' },
                    'true-false': { title: 'PHẦN II. CÂU HỎI ĐÚNG - SAI', subtitle: 'Xác định tính đúng hoặc sai cho mỗi mệnh đề dưới đây.' },
                    'short-answer': { title: 'PHẦN III. CÂU HỎI TRẢ LỜI NGẮN', subtitle: 'Điền đáp án ngắn gọn vào phần trả lời.' },
                    'essay': { title: 'PHẦN IV. CÂU HỎI TỰ LUẬN', subtitle: 'Trình bày chi tiết bài giải của bạn.' }
                };
               
                let questionCounter = 0;
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    const questions = grouped[partType];
                    if (!questions || questions.length === 0) return;
                   
                    let groupHTML = `<div class="group-container space-y-8 mb-12">`;
                    const info = groupInfo[partType];
                    groupHTML += `
                        <div class="group-header pb-3 border-b-2 border-slate-300 mb-6">
                            <h2 class="text-2xl font-bold text-slate-800">${info.title}</h2>
                            ${info.subtitle ? `<p class="text-md text-slate-600 italic mt-1">${info.subtitle}</p>` : ''}
                        </div>
                    `;
                    questions.forEach((item, localIndex) => {
                        const globalIndex = quizData.indexOf(item);
                        questionCounter++;
                        groupHTML += `<div class="question-card" id="student-q-${globalIndex}">`;
                        let questionText = (item.question || item.main_question || '').replace(/\n/g, '<br>');
                       
                        const textToSpeak = getTextForTTS(item);
                       
                        groupHTML += `<div class="flex items-start">
                                     <div class="flex-grow">
                                         <div class="flex items-center mb-2">
                                             <span class="font-bold text-lg mr-3 text-indigo-600">Câu ${questionCounter}:</span>
                                             <div id="q-${globalIndex}-feedback-icon"></div>
                                         </div>
                                         <div class="question-content mt-2 text-lg text-slate-700">${questionText}</div>
                                         ${item.questionImage ? `<img src="${item.questionImage}" class="mt-4 rounded-lg max-w-full md:max-w-md border shadow-sm">` : ''}
                                     </div>
                                     <button class="tts-btn ml-4 p-2 rounded-full text-gray-500 hover:text-indigo-600" data-text-to-speak="${textToSpeak.replace(/"/g, '&quot;')}">
                                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                             <path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.858 5.858a3 3 0 014.243 0L12 7.757l1.9-1.9a3 3 0 014.242 0 3 3 0 010 4.242L12 16.242l-6.042-6.042a3 3 0 010-4.242z" />
                                         </svg>
                                     </button>
                                 </div>`;
                       
                        groupHTML += `<div class="mt-6">`;
                        switch(item.mappedType) {
                            case 'multiple-choice':
                                groupHTML += `<div class="options-grid grid grid-cols-1 md:grid-cols-2 gap-4">`;
                                item.options.forEach((opt, i) => {
                                    groupHTML += `<label for="q${globalIndex}-opt${i}" id="q${globalIndex}-opt-label${i}" class="option-label flex items-start p-4 border-2 rounded-xl cursor-pointer hover:bg-indigo-50 hover:border-indigo-400">
                                                     <input type="radio" name="q${globalIndex}" id="q${globalIndex}-opt${i}" value="${i}" class="flex-shrink-0 mt-1 h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                                     <div class="ml-3 flex-grow">
                                                         <span class="font-semibold text-slate-800">${String.fromCharCode(65 + i)}.</span>
                                                         <span class="option-content text-slate-700">${opt || ''}</span>
                                                         ${(item.optionsImage && item.optionsImage[i]) ? `<img src="${item.optionsImage[i]}" class="mt-2 rounded-lg max-w-xs border shadow-sm">` : ''}
                                                     </div>
                                                 </label>`;
                                });
                                groupHTML += `</div>`;
                                break;
                            case 'true-false':
                                 groupHTML += `<div class="space-y-4">`;
                                 item.statements.forEach((s, i) => {
                                     groupHTML += `<div class="statement-item border-t pt-4">
                                                  <p class="mb-3 text-slate-700">${String.fromCharCode(97 + i)}) ${s.statement || ''}</p>
                                                  <div class="flex gap-x-6">
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="true" class="mr-2 h-4 w-4"> Đúng</label>
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="false" class="mr-2 h-4 w-4"> Sai</label>
                                                  </div>
                                              </div>`;
                                 });
                                 groupHTML += `</div>`;
                                 break;
                            case 'short-answer':
                                groupHTML += `<input type="text" name="q${globalIndex}" class="mt-1 block w-full md:w-1/2 border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Nhập đáp án của bạn...">`;
                                break;
                            case 'essay':
                                groupHTML += `<textarea name="q${globalIndex}" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" rows="5" placeholder="Nhập câu trả lời tự luận của bạn..."></textarea>`;
                                break;
                        }
                        groupHTML += `</div><div id="q-${globalIndex}-feedback" class="mt-4"></div></div>`;
                    });
                    groupHTML += `</div>`;
                    studentQuizContainer.innerHTML += groupHTML;
                });
               
                if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                    MathJax.typesetPromise([studentQuizContainer]);
                }
               
                document.querySelectorAll('.tts-btn').forEach(btn => {
                    btn.addEventListener('click', () => playTTS(btn.dataset.textToSpeak, btn));
                });
            }
           
            async function generatePerformanceReview(allAnswersData) {
                const feedbackContainer = document.getElementById('ai-feedback-container');
                if (!feedbackContainer || !ai) return null;
                feedbackContainer.classList.remove('hidden');
                feedbackContainer.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-slate-800 mb-4">📝 Phân Tích & Gợi Ý Từ Trợ Lý AI</h3>
                        <div id="ai-feedback-loader" class="text-center py-6">
                            <svg class="animate-spin mx-auto h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p class="mt-3 text-slate-600">AI đang phân tích bài làm của bạn...</p>
                        </div>
                        <div id="ai-feedback-summary" class="hidden prose prose-sm max-w-none"></div>
                        <div id="ai-feedback-details" class="hidden mt-4 space-y-2"></div>
                    </div>
                `;
               
                const loader = document.getElementById('ai-feedback-loader');
                const summaryDiv = document.getElementById('ai-feedback-summary');
                const detailsDiv = document.getElementById('ai-feedback-details');
                const incorrectAnswers = allAnswersData.filter(a => !a.isCorrect);
                if (incorrectAnswers.length === 0) {
                    feedbackContainer.innerHTML = `
                        <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                            <h3 class="text-xl font-bold text-green-600">🎉 Chúc mừng!</h3>
                            <p class="mt-2 text-slate-700">Bạn đã trả lời đúng tất cả các câu hỏi. Làm tốt lắm!</p>
                        </div>
                    `;
                    return { overallFeedback: { summary: "Xuất sắc! Học sinh đã đã trả lời đúng tất cả các câu hỏi." } };
                }
                const summaryPrompt = `Bạn là một trợ lý giáo viên, nói tiếng Việt. Dựa vào tóm tắt các câu trả lời sai của học sinh, hãy đưa ra một nhận xét tổng quan ngắn gọn (khoảng 3-4 câu) về năng lực của học sinh, bao gồm điểm mạnh (suy luận từ các câu làm đúng), điểm yếu (dựa trên các câu sai) và một vài gợi ý ôn tập chung. Lời văn phải khích lệ, rõ ràng.
                Tóm tắt lỗi sai:
                ${JSON.stringify(incorrectAnswers.map(a => ({ cau: a.questionNumber, loai: a.type, cauHoi: a.question.substring(0, 50) + '...' })), null, 2)}`;
                try {
                    const summaryResponse = await ai.models.generateContent({
                        model: "gemini-2.5-flash",
                        contents: summaryPrompt
                    });
                    summaryDiv.innerHTML = summaryResponse.text.replace(/\n/g, '<br>');
                    loader.classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                    detailsDiv.classList.remove('hidden'); 
                } catch (e) {
                    console.error("Lỗi khi lấy nhận xét tổng quan:", e);
                    summaryDiv.innerHTML = '<p class="text-red-600">Lỗi khi tạo nhận xét tổng quan.</p>';
                    loader.classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                }
               
                const summaryForSheet = summaryDiv.innerText.substring(0, 200) + "...";
                return { overallFeedback: { summary: summaryForSheet } };
            }
            async function handleSubmit() {
                if (isSubmitted) return;
                isSubmitted = true;
                clearInterval(timerInterval);
                
                document.querySelectorAll('input, textarea').forEach(input => input.disabled = true);
                submitBtn.classList.add('hidden');
                postSubmitOptions.classList.remove('hidden');
                if (retriesLeft > 0) {
                    retryBtn.classList.remove('hidden');
                } else {
                    retryBtn.classList.add('hidden');
                }

                const proctoringDataString = JSON.stringify(proctoringLog);

                let totalStudentScore = 0;
                let totalCorrectAnswers = 0;
                let allAnswersData = [];
                const questionCounts = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    acc[type] = (acc[type] || 0) + 1;
                    return acc;
                }, {});
                
                // --- GRADING LOGIC (runs for all cases now) ---
                quizData.forEach((item, index) => {
                    let questionNumber = index + 1;
                    let answerData = { questionNumber, type: item.type };
                    switch (item.mappedType) {
                        case 'multiple-choice':
                            const selectedOption = document.querySelector(`input[name="q${index}"]:checked`);
                            const isCorrectMC = selectedOption ? parseInt(selectedOption.value) === item.correctAnswerIndex : false;
                            if (isCorrectMC) {
                                totalCorrectAnswers++;
                                if (questionCounts['multiple-choice'] > 0) {
                                   totalStudentScore += quizOptions.scoring.mc / questionCounts['multiple-choice'];
                                }
                            }
                            answerData.question = item.question;
                            answerData.options = item.options;
                            answerData.yourAnswer = selectedOption ? String.fromCharCode(65 + parseInt(selectedOption.value)) : "Không trả lời";
                            answerData.correctAnswer = String.fromCharCode(65 + item.correctAnswerIndex);
                            answerData.isCorrect = isCorrectMC;
                            break;
                        case 'true-false':
                            let correctStatementsCount = 0;
                            let yourAnswerPattern = [];
                            let correctAnswerPattern = [];
                            let details = [];
                            item.statements.forEach((s, i) => {
                                const selectedTF = document.querySelector(`input[name="q${index}-s${i}"]:checked`);
                                const studentChoice = selectedTF ? selectedTF.value === 'true' : null;
                                const isStatementCorrect = studentChoice === s.is_correct;
                               
                                if (isStatementCorrect) correctStatementsCount++;
                               
                                yourAnswerPattern.push(studentChoice === null ? '?' : (studentChoice ? 'Đ' : 'S'));
                                correctAnswerPattern.push(s.is_correct ? 'Đ' : 'S');
                                details.push({ statement: s.statement, yourChoice: studentChoice === null ? 'Không trả lời' : (studentChoice ? 'Đúng' : 'Sai'), correctChoice: s.is_correct ? 'Đúng' : 'Sai', isCorrect: isStatementCorrect });
                            });
                            
                            let scorePerTfQuestion = 0;
                            if (questionCounts['true-false'] > 0) {
                                scorePerTfQuestion = quizOptions.scoring.tf / questionCounts['true-false'];
                            }
                            let questionPoints = 0;
                            if (quizOptions.scoring.tfMethod === 'progressive') {
                                const progressivePoints = { 0: 0, 1: 0.1, 2: 0.25, 3: 0.5, 4: 1.0 };
                                questionPoints = progressivePoints[correctStatementsCount] * scorePerTfQuestion;
                            } else { // even
                                questionPoints = (correctStatementsCount / 4) * scorePerTfQuestion;
                            }
                            totalStudentScore += questionPoints;

                            if(correctStatementsCount === 4) totalCorrectAnswers++;
                            answerData.question = item.main_question;
                            answerData.yourAnswer = yourAnswerPattern.join('-');
                            answerData.correctAnswer = correctAnswerPattern.join('-');
                            answerData.isCorrect = correctStatementsCount === 4;
                            answerData.details = details;
                            break;
                       
                        case 'short-answer':
                            const saInput = document.querySelector(`input[name="q${index}"]`);
                            const studentAnswerRaw = saInput ? (saInput.value ?? '').trim() : "";
                            const correctAnswerRaw = (item.answer ?? '').toString().trim().replace(/\$/g, '');
                            let isCorrectSA = false;

                            // Normalize both to use '.' as decimal separator for comparison
                            const studentAnswerNormalized = studentAnswerRaw.replace(',', '.');
                            const correctAnswerNormalized = correctAnswerRaw.replace(',', '.');
                            
                            // Perform a single, case-insensitive string comparison.
                            // This is strict about decimal places but allows for different separators (',' vs '.').
                            if (studentAnswerNormalized.toLowerCase() === correctAnswerNormalized.toLowerCase()) {
                                isCorrectSA = true;
                            }
                             
                             if (isCorrectSA) {
                                totalCorrectAnswers++;
                                if (questionCounts['short-answer'] > 0) {
                                   totalStudentScore += quizOptions.scoring.sa / questionCounts['short-answer'];
                                }
                            }
                            answerData.question = item.question;
                            answerData.yourAnswer = studentAnswerRaw || "Không trả lời";
                            answerData.correctAnswer = correctAnswerRaw;
                            answerData.isCorrect = isCorrectSA;
                            break;
                           
                        case 'essay':
                             const essayInput = document.querySelector(`textarea[name="q${index}"]`);
                             answerData.question = item.question;
                             answerData.yourAnswer = essayInput.value || "Không trả lời";
                             answerData.correctAnswer = item.answer;
                             answerData.isCorrect = null; // Needs manual grading
                             break;
                    }
                    allAnswersData.push(answerData);
                });
                
                const finalScore = totalStudentScore;
                
                let competencyAssessment = "Giáo viên không yêu cầu AI phân tích bài làm.";
                if (quizOptions.aiAssessment) {
                    const feedbackData = await generatePerformanceReview(allAnswersData);
                    if (feedbackData && feedbackData.overallFeedback && feedbackData.overallFeedback.summary) {
                        competencyAssessment = feedbackData.overallFeedback.summary;
                    } else {
                        competencyAssessment = "Có lỗi xảy ra trong quá trình AI phân tích bài làm.";
                    }
                }
                
                // --- UI DISPLAY LOGIC ---
                if (quizOptions.showAnswers) {
                    const totalQuestions = quizData.length;
                    let summaryTableHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                        <h3 class="text-xl font-bold text-slate-800 mb-4">🎯 TỔNG KẾT:</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-center text-slate-600">
                                <thead class="text-xs text-slate-700 uppercase bg-slate-100 rounded-t-lg">
                                    <tr>
                                        <th scope="col" class="px-4 py-3 font-semibold">Câu</th>
                                        <th scope="col" class="px-4 py-3 font-semibold">Đáp án của bạn</th>
                                        <th scope="col" class="px-4 py-3 font-semibold">Đáp án đúng</th>
                                        <th scope="col" class="px-4 py-3 font-semibold">Kết quả</th>
                                    </tr>
                                </thead>
                                <tbody>`;
                   
                    allAnswersData.forEach(ans => {
                        let yourAnswerDisplay;
                        let tdClass = 'px-4 py-3';

                        if (ans.type === 'true-false') {
                            const yourParts = (ans.yourAnswer || '').split('-');
                            const correctParts = (ans.correctAnswer || '').split('-');
                            yourAnswerDisplay = yourParts.map((part, i) => {
                                if (part === correctParts[i]) {
                                    return `<span class="text-green-600 font-bold">${part}</span>`;
                                } else {
                                    return `<span class="text-red-600 font-bold">${part}</span>`;
                                }
                            }).join('');
                        } else {
                            yourAnswerDisplay = ans.yourAnswer;
                            if (ans.isCorrect === false) {
                                tdClass += ' text-red-500 font-bold';
                            }
                        }

                        summaryTableHTML += `
                            <tr class="bg-white border-b">
                                <td class="px-4 py-3 font-medium">${ans.questionNumber}</td>
                                <td class="${tdClass}">${yourAnswerDisplay}</td>
                                <td class="px-4 py-3">${ans.correctAnswer}</td>
                                <td class="px-4 py-3 flex justify-center">${ans.isCorrect === true ?
                                    '<svg class="w-6 h-6 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>' :
                                    (ans.isCorrect === false ? '<svg class="w-6 h-6 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>' : '<span>-</span>')
                                }</td>
                            </tr>`;
                    });
                    summaryTableHTML += `
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-4 space-y-1 text-left">
                            <p class="font-semibold text-green-600">✅ Số câu đúng hoàn toàn: ${totalCorrectAnswers}/${totalQuestions}</p>
                             <p class="font-semibold text-blue-600">📊 Điểm (thang 10): ${finalScore.toFixed(2)}/10</p>
                             ${questionCounts['essay'] > 0 ? `<p class="text-sm text-gray-600 italic">Lưu ý: Điểm trên chưa bao gồm ${quizOptions.scoring.essay} điểm của phần Tự luận cần giáo viên chấm.</p>` : ''}
                        </div>
                    </div>`;
                   
                    resultContainer.innerHTML = summaryTableHTML;
                    resultContainer.classList.remove('hidden');
                    
                    if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                        await window.MathJax.typesetPromise([resultContainer]);
                    }
                } else {
                     resultContainer.innerHTML = `
                        <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                            <h3 class="text-xl font-bold text-green-600">Nộp bài thành công!</h3>
                            <p class="mt-2 text-slate-700">Bạn đã hoàn thành bài làm. Kết quả sẽ được giáo viên công bố sau.</p>
                        </div>
                    `;
                    resultContainer.classList.remove('hidden');
                }
                
                // --- DATA SUBMISSION LOGIC (runs for all cases) ---
                const formData = new FormData();
                formData.append('name', studentInfo.name);
                formData.append('class', studentInfo.class);
                formData.append('score', `${finalScore.toFixed(2)}/10`);
                formData.append('assessment', competencyAssessment);
                formData.append('timestamp', new Date().toLocaleString('vi-VN'));
                formData.append('examCode', correctExamCode);
                formData.append('monitoringLog', proctoringDataString);
                formData.append('answerDetails', JSON.stringify(allAnswersData));
               
                fetch(googleScriptUrl, { method: 'POST', body: formData})
                    .then(res => console.log("Successfully submitted to Google Sheet"))
                    .catch(err => console.error("Error submitting to Google Sheet:", err));
            }
           
            function startNewAttempt() {
                isSubmitted = false;
                proctoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0, suKien: [] };
                const proctoringWidget = document.getElementById('proctoring-widget');
                if (proctoringWidget) {
                    proctoringWidget.classList.add('hidden');
                    document.getElementById('tab-switch-count').textContent = '0';
                    document.getElementById('copy-count').textContent = '0';
                    document.getElementById('paste-count').textContent = '0';
                }

                renderStudentQuiz();
                resultContainer.classList.add('hidden');
                document.getElementById('ai-feedback-container').classList.add('hidden');
                postSubmitOptions.classList.add('hidden');
                submitBtn.classList.remove('hidden');
                 if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                }
                retriesLeft--;
                retriesDisplay.textContent = `Lượt làm lại còn: ${retriesLeft}`;
                window.scrollTo(0, 0);
            }
            studentInfoForm.addEventListener('submit', (e) => {
                e.preventDefault();
               
                const enteredCode = document.getElementById('exam-code').value.trim().toUpperCase();
                if (enteredCode !== correctExamCode) {
                    alert('Mã đề không chính xác. Vui lòng kiểm tra lại!');
                    return;
                }
               
                studentApiKey = teacherApiKey;
                if (!studentApiKey) {
                    alert('Cảnh báo: Giáo viên chưa cấu hình API Key. Các tính năng AI sẽ không hoạt động.');
                }
       
                try {
                    if (studentApiKey) {
                       ai = new GoogleGenAI({ apiKey: studentApiKey });
                    }
                } catch(e) {
                    console.error("Lỗi khởi tạo Gemini API với key của giáo viên.", e);
                    alert("Cảnh báo: API Key của giáo viên không hợp lệ. Vui lòng báo cho giáo viên. Các tính năng AI sẽ không hoạt động.");
                    ai = null;
                }
                shuffleQuiz();
               
                studentInfo.name = document.getElementById('student-name').value;
                studentInfo.class = document.getElementById('student-class').value;
                loginModal.classList.add('hidden');
                studentQuizContainer.classList.remove('hidden');
                submitBtn.classList.remove('hidden');
               
                if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                } else {
                    timerDisplay.textContent = "Không giới hạn";
                }
                retriesDisplay.textContent = `Lượt làm lại còn: ${retriesLeft}`;
                renderStudentQuiz();

                const proctoringWidget = document.getElementById('proctoring-widget');
                const tabSwitchCountEl = document.getElementById('tab-switch-count');
                const copyCountEl = document.getElementById('copy-count');
                const pasteCountEl = document.getElementById('paste-count');

                function updateProctoringUI() {
                    if (proctoringLog.thoatManHinh > 0 || proctoringLog.saoChep > 0 || proctoringLog.dan > 0) {
                        proctoringWidget.classList.remove('hidden');
                    }
                    tabSwitchCountEl.textContent = proctoringLog.thoatManHinh;
                    copyCountEl.textContent = proctoringLog.saoChep;
                    pasteCountEl.textContent = proctoringLog.dan;
                }

                // Disable Right Click
                document.addEventListener('contextmenu', e => e.preventDefault());

                // Track Tab Switching
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && !isSubmitted) {
                        proctoringLog.thoatManHinh++;
                        proctoringLog.suKien.push({ loai: 'chuyen_tab', thoiGian: new Date().toISOString() });
                        updateProctoringUI();
                    }
                });

                // Track Copying
                document.addEventListener('copy', () => {
                    if (isSubmitted) return;
                    proctoringLog.saoChep++;
                    proctoringLog.suKien.push({ loai: 'sao_chep', thoiGian: new Date().toISOString() });
                    updateProctoringUI();
                });

                // Track Pasting
                document.addEventListener('paste', () => {
                    if (isSubmitted) return;
                    proctoringLog.dan++;
                    proctoringLog.suKien.push({ loai: 'dan', thoiGian: new Date().toISOString() });
                    updateProctoringUI();
                });
            });
            
            submitBtn.addEventListener('click', handleSubmit);
            retryBtn.addEventListener('click', () => {
                shuffleQuiz();
                startNewAttempt();
            });
        </script>
    </body>
    </html>
    