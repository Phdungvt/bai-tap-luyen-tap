
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bài kiểm tra - 18/11/2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f5f7; }
        .option.selected { border-color: #3b82f6; background-color: #eff6ff; }
        .option.correct { border-color: #22c55e; background-color: #f0fdf4; }
        .option.incorrect { border-color: #ef4444; background-color: #fef2f2; }
        .disabled { pointer-events: none; opacity: 0.7; }
        .monitoring-warning { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background-color: #ef4444; color: white; padding: 10px 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; display: none; animation: fade-in-out 5s ease-in-out; }
        @keyframes fade-in-out { 0%, 100% { opacity: 0; transform: translate(-50%, -20px); } 10%, 90% { opacity: 1; transform: translate(-50%, 0); } }
        /* MathJax basic styling */
        mjx-container { display: inline-block !important; }
        .prose img.latex-image { display: inline-block; vertical-align: middle; }
    </style>
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$']], displayMath: [['$$', '$$']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    <script type="importmap">
    { "imports": { "@google/genai": "https://esm.sh/@google/genai@^1.13.0" } }
    </script>
</head>
<body class="p-4 md:p-8">
    <div id="app" class="max-w-4xl mx-auto bg-white p-6 rounded-2xl shadow-lg">
        
        <div id="welcome-screen">
            <h1 class="text-3xl font-bold text-gray-800">Bài kiểm tra - 18/11/2025</h1>
            <p class="mt-2 text-gray-600">Mã đề: <span class="font-bold text-indigo-600">UBW452</span></p>
            <hr class="my-6">
            <div class="space-y-4">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">Họ và tên</label>
                    <input type="text" id="name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="class" class="block text-sm font-medium text-gray-700">Lớp</label>
                    <input type="text" id="class" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>
             <p class="mt-4 text-sm text-red-600"><strong>Lưu ý:</strong> Hệ thống sẽ giám sát việc chuyển tab, sao chép/dán. Các hành vi này sẽ được ghi lại và báo cáo cho giáo viên.</p>
            <button id="start-btn" class="mt-6 w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-indigo-700">Bắt đầu làm bài</button>
        </div>

        <div id="quiz-screen" class="hidden">
             <div class="flex justify-between items-center mb-4 sticky top-0 bg-white py-4 z-10 border-b -mx-6 px-6">
                <h2 class="text-2xl font-bold text-gray-800">Bài kiểm tra - 18/11/2025</h2>
                <div id="timer" class="text-xl font-bold text-red-500 bg-red-100 px-4 py-2 rounded-lg"></div>
            </div>
            <div id="all-questions-container" class="mt-6"></div>
            <div class="mt-8 flex justify-end">
                <button id="submit-btn" class="bg-green-600 text-white py-3 px-8 rounded-lg font-semibold hover:bg-green-700 text-lg">Nộp bài</button>
            </div>
        </div>

        <div id="results-screen" class="hidden">
            <h2 class="text-3xl font-bold text-center text-gray-800">Kết quả bài làm</h2>
            <div id="score-display" class="hidden text-center text-5xl font-bold text-blue-600 my-6"></div>
            <div id="assessment-display" class="hidden mt-4 p-4 bg-gray-100 rounded-lg text-gray-700"></div>
            <div id="review-container" class="mt-8"></div>
            <div class="mt-8 text-center space-x-4">
                <button id="retry-btn" class="hidden bg-indigo-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-indigo-700">Làm lại bài</button>
                <button id="restart-btn" class="bg-gray-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-gray-600">Về trang chủ</button>
            </div>
        </div>
        
        <div id="monitoring-warning" class="monitoring-warning">⚠️ Đã phát hiện hành vi không hợp lệ!</div>
    </div>

    <script type="module">
        import { GoogleGenAI } from "@google/genai";

        const API_KEY = "AIzaSyBQn3frig01PLmaKLe1ZQz09pOuAeqOkxQ";
        const quizData = [{"question":"Cho dãy số $(u_n)$ với công thức số hạng tổng quát $u_n = 3n - 2$. Ba số hạng đầu tiên của dãy số là:","options":["1, 4, 7","3, 6, 9","2, 5, 8","0, 1, 2"],"correctAnswerIndex":0,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Cho dãy số $(u_n)$ với công thức số hạng tổng quát $u_n = 3n - 2$. Ba số hạng đầu tiên của dãy số là:","rendered_options":["1, 4, 7","3, 6, 9","2, 5, 8","0, 1, 2"]},{"question":"Cho dãy số $u_n = \\dfrac{n}{n+1}$. Dãy số này là dãy số tăng hay dãy số giảm?","options":["Dãy số tăng.","Dãy số giảm.","Dãy số không tăng không giảm.","Dãy số vừa tăng vừa giảm."],"correctAnswerIndex":0,"type":"multiple-choice","isDirty":true,"explanation":"Để xác định dãy số $(u_n)$ xác định bởi $u_n = \\dfrac{n}{n+1}$ là dãy số tăng hay giảm, chúng ta sẽ sử dụng phương pháp xét hiệu giữa số hạng thứ $n+1$ và số hạng thứ $n$, tức là xét dấu của $u_{n+1} - u_n$.\n\n**Mục tiêu:**\n*   Nếu $u_{n+1} - u_n > 0$ với mọi $n \\in \\mathbb{N}^*$ (tức là $n \\ge 1$), thì dãy số là dãy số tăng.\n*   Nếu $u_{n+1} - u_n < 0$ với mọi $n \\in \\mathbb{N}^*$, thì dãy số là dãy số giảm.\n\n**Các bước thực hiện:**\n\n**Bước 1: Xác định công thức của $u_n$ và $u_{n+1}$**\nDãy số $(u_n)$ được cho bởi công thức tổng quát:\n$$ u_n = \\dfrac{n}{n+1} $$\nĐể tìm $u_{n+1}$, ta thay $n$ bằng $n+1$ vào công thức của $u_n$:\n$$ u_{n+1} = \\dfrac{n+1}{(n+1)+1} = \\dfrac{n+1}{n+2} $$\n\n**Bước 2: Tính hiệu $u_{n+1} - u_n$**\nTa xét hiệu $u_{n+1} - u_n$:\n$$ u_{n+1} - u_n = \\dfrac{n+1}{n+2} - \\dfrac{n}{n+1} $$\nĐể thực hiện phép trừ hai phân thức, ta cần quy đồng mẫu số. Mẫu số chung nhỏ nhất của $(n+2)$ và $(n+1)$ là $(n+1)(n+2)$.\n$$\n\\begin{align*} u_{n+1} - u_n &= \\dfrac{(n+1) \\times (n+1)}{(n+2) \\times (n+1)} - \\dfrac{n \\times (n+2)}{(n+1) \\times (n+2)} \\\\ &= \\dfrac{(n+1)^2 - n(n+2)}{(n+1)(n+2)} \\end{align*}\n$$\n\n**Bước 3: Rút gọn biểu thức của hiệu**\nKhai triển tử số:\n*   $(n+1)^2 = n^2 + 2n + 1$\n*   $n(n+2) = n^2 + 2n$\nThay vào biểu thức hiệu:\n$$\n\\begin{align*} u_{n+1} - u_n &= \\dfrac{(n^2 + 2n + 1) - (n^2 + 2n)}{(n+1)(n+2)} \\\\ &= \\dfrac{n^2 + 2n + 1 - n^2 - 2n}{(n+1)(n+2)} \\\\ &= \\dfrac{1}{(n+1)(n+2)} \\end{align*}\n$$\n\n**Bước 4: Xét dấu của hiệu $u_{n+1} - u_n$**\nDãy số $(u_n)$ được xác định với $n \\in \\mathbb{N}^*$, tức là $n = 1, 2, 3, \\ldots$.\nVới mọi $n \\ge 1$:\n*   $n+1 > 0$\n*   $n+2 > 0$\nDo đó, tích $(n+1)(n+2)$ luôn dương: $(n+1)(n+2) > 0$.\nTử số của phân thức là $1$, một số dương.\nVậy, $\\dfrac{1}{(n+1)(n+2)} > 0$ với mọi $n \\in \\mathbb{N}^*$.\nĐiều này có nghĩa là $u_{n+1} - u_n > 0$, hay $u_{n+1} > u_n$.\n\n**Bước 5: Kết luận**\nVì $u_{n+1} > u_n$ với mọi $n \\in \\mathbb{N}^*$, theo định nghĩa, dãy số $(u_n)$ là một dãy số tăng.\n\nĐáp án đúng là **A. Dãy số tăng.**","shuffleOptions":{"stem":true,"answers":true},"questionImage":null,"optionsImage":[null,null,null,null],"rendered_question":"Cho dãy số $u_n = \\dfrac{n}{n+1}$. Dãy số này là dãy số tăng hay dãy số giảm?","rendered_options":["Dãy số tăng.","Dãy số giảm.","Dãy số không tăng không giảm.","Dãy số vừa tăng vừa giảm."]},{"question":"Cho dãy số $(u_n)$ xác định bởi công thức số hạng tổng quát $u_n = \\dfrac{2n^2 - 3}{n+1}$ với $n \\in \\mathbb{N}^*$. Hãy tính số hạng $u_4$ của dãy số đó.","options":["$\\dfrac{29}{5}$","$\\dfrac{13}{5}$","$\\dfrac{20}{5}$","$\\dfrac{29}{4}$"],"correctAnswerIndex":0,"type":"multiple-choice","isDirty":true,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"questionImage":null,"optionsImage":[null,null,null,null],"rendered_question":"Cho dãy số $(u_n)$ xác định bởi công thức số hạng tổng quát $u_n = \\dfrac{2n^2 - 3}{n+1}$ với $n \\in \\mathbb{N}^*$. Hãy tính số hạng $u_4$ của dãy số đó.","rendered_options":["$\\dfrac{29}{5}$","$\\dfrac{13}{5}$","$\\dfrac{20}{5}$","$\\dfrac{29}{4}$"]},{"question":"Cho dãy số $(u_n)$ với số hạng tổng quát $u_n = \\dfrac{4n-2}{n+3}$. Mệnh đề nào sau đây đúng về tính đơn điệu của dãy số $(u_n)$?","options":["Dãy số $(u_n)$ là dãy số tăng.","Dãy số $(u_n)$ là dãy số giảm.","Dãy số $(u_n)$ không tăng không giảm.","Dãy số $(u_n)$ là dãy số hằng."],"correctAnswerIndex":0,"type":"multiple-choice","isDirty":true,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"questionImage":null,"optionsImage":[null,null,null,null],"rendered_question":"Cho dãy số $(u_n)$ với số hạng tổng quát $u_n = \\dfrac{4n-2}{n+3}$. Mệnh đề nào sau đây đúng về tính đơn điệu của dãy số $(u_n)$?","rendered_options":["Dãy số $(u_n)$ là dãy số tăng.","Dãy số $(u_n)$ là dãy số giảm.","Dãy số $(u_n)$ không tăng không giảm.","Dãy số $(u_n)$ là dãy số hằng."]},{"question":"Cho dãy số $(u_n)$ có số hạng tổng quát $u_n = \\dfrac{n+1}{2n-1}$. Ba số hạng đầu tiên của dãy số là","options":["$2; 1; \\dfrac{4}{5}$","$1; \\dfrac{2}{3}; \\dfrac{3}{5}$","$2; \\dfrac{3}{5}; \\dfrac{4}{7}$","$1; 2; \\dfrac{4}{5}$"],"correctAnswerIndex":0,"type":"multiple-choice","isDirty":true,"explanation":"Để tìm ba số hạng đầu tiên của dãy số $(u_n)$ với số hạng tổng quát $u_n = \\dfrac{n+1}{2n-1}$, chúng ta lần lượt thay các giá trị $n=1, 2, 3$ vào công thức đã cho.\n\n**Bước 1: Tính số hạng đầu tiên ($u_1$)**\nThay $n=1$ vào công thức $u_n = \\dfrac{n+1}{2n-1}$:\n$$u_1 = \\dfrac{1+1}{2 \\times 1 - 1} = \\dfrac{2}{2 - 1} = \\dfrac{2}{1} = 2$$\n\n**Bước 2: Tính số hạng thứ hai ($u_2$)**\nThay $n=2$ vào công thức $u_n = \\dfrac{n+1}{2n-1}$:\n$$u_2 = \\dfrac{2+1}{2 \\times 2 - 1} = \\dfrac{3}{4 - 1} = \\dfrac{3}{3} = 1$$\n\n**Bước 3: Tính số hạng thứ ba ($u_3$)**\nThay $n=3$ vào công thức $u_n = \\dfrac{n+1}{2n-1}$:\n$$u_3 = \\dfrac{3+1}{2 \\times 3 - 1} = \\dfrac{4}{6 - 1} = \\dfrac{4}{5}$$\n\nVậy, ba số hạng đầu tiên của dãy số là $2; 1; \\dfrac{4}{5}$.\n\nSo sánh với các phương án đã cho, ta thấy đáp án A là chính xác.\n\nThe final answer is $\\boxed{A}$","shuffleOptions":{"stem":true,"answers":true},"questionImage":null,"optionsImage":[null,null,null,null],"rendered_question":"Cho dãy số $(u_n)$ có số hạng tổng quát $u_n = \\dfrac{n+1}{2n-1}$. Ba số hạng đầu tiên của dãy số là","rendered_options":["$2; 1; \\dfrac{4}{5}$","$1; \\dfrac{2}{3}; \\dfrac{3}{5}$","$2; \\dfrac{3}{5}; \\dfrac{4}{7}$","$1; 2; \\dfrac{4}{5}$"]},{"question":"Cho dãy số $(u_n)$ xác định bởi công thức tổng quát $u_n = \\dfrac{n^2 + 1}{n+1}$. Ba số hạng đầu tiên của dãy số đó là:","options":["$1, \\dfrac{5}{3}, \\dfrac{5}{2}$","$2, \\dfrac{5}{2}, \\dfrac{10}{3}$","$\\dfrac{1}{2}, \\dfrac{4}{3}, \\dfrac{9}{4}$","$1, \\dfrac{5}{3}, \\dfrac{10}{3}$"],"correctAnswerIndex":0,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Cho dãy số $(u_n)$ xác định bởi công thức tổng quát $u_n = \\dfrac{n^2 + 1}{n+1}$. Ba số hạng đầu tiên của dãy số đó là:","rendered_options":["$1, \\dfrac{5}{3}, \\dfrac{5}{2}$","$2, \\dfrac{5}{2}, \\dfrac{10}{3}$","$\\dfrac{1}{2}, \\dfrac{4}{3}, \\dfrac{9}{4}$","$1, \\dfrac{5}{3}, \\dfrac{10}{3}$"]},{"question":"Cho dãy số $(u_n)$ xác định bởi công thức số hạng tổng quát $u_n = 2n + 1$ với $n \\in \\mathbb{N}^*$. Ba số hạng đầu tiên của dãy số đó là:","options":["$1, 3, 5$","$3, 5, 7$","$2, 4, 6$","$0, 1, 3$"],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Cho dãy số $(u_n)$ xác định bởi công thức số hạng tổng quát $u_n = 2n + 1$ với $n \\in \\mathbb{N}^*$. Ba số hạng đầu tiên của dãy số đó là:","rendered_options":["$1, 3, 5$","$3, 5, 7$","$2, 4, 6$","$0, 1, 3$"]},{"main_question":"Cho dãy số $(u_n)$ xác định bởi công thức số hạng tổng quát $u_n = \\dfrac{n}{n+1}$ với $n \\in \\mathbb{N}^*$. Hãy xác định tính đúng/sai của các mệnh đề sau:","statements":[{"statement":"Số hạng đầu tiên của dãy số là $\\dfrac{1}{2}$.","is_correct":true,"rendered_statement":"Số hạng đầu tiên của dãy số là $\\dfrac{1}{2}$."},{"statement":"Số hạng thứ $n$ của dãy số có thể bằng $1$.","is_correct":false,"rendered_statement":"Số hạng thứ $n$ của dãy số có thể bằng $1$."},{"statement":"Dãy số $(u_n)$ là một dãy số giảm.","is_correct":false,"rendered_statement":"Dãy số $(u_n)$ là một dãy số giảm."},{"statement":"Dãy số $(u_n)$ bị chặn trên bởi $1$ và bị chặn dưới bởi $\\dfrac{1}{2}$.","is_correct":true,"rendered_statement":"Dãy số $(u_n)$ bị chặn trên bởi $1$ và bị chặn dưới bởi $\\dfrac{1}{2}$."}],"type":"true-false","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Cho dãy số $(u_n)$ xác định bởi công thức số hạng tổng quát $u_n = \\dfrac{n}{n+1}$ với $n \\in \\mathbb{N}^*$. Hãy xác định tính đúng/sai của các mệnh đề sau:"},{"question":"Cho cấp số cộng $({u_n})$ có số hạng đầu ${u_1} = 3$ và công sai $d = 2$. Tính tổng của $10$ số hạng đầu tiên của cấp số cộng đó.","options":["$S_{10} = 100$","$S_{10} = 120$","$S_{10} = 130$","$S_{10} = 140$"],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Cho cấp số cộng $({u_n})$ có số hạng đầu ${u_1} = 3$ và công sai $d = 2$. Tính tổng của $10$ số hạng đầu tiên của cấp số cộng đó.","rendered_options":["$S_{10} = 100$","$S_{10} = 120$","$S_{10} = 130$","$S_{10} = 140$"]},{"question":"Cho cấp số cộng $2, 5, 8, 11, \\ldots$. Tìm công sai $d$ của cấp số cộng đó.","options":["$d = 2$","$d = 3$","$d = -3$","$d = 5$"],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Cho cấp số cộng $2, 5, 8, 11, \\ldots$. Tìm công sai $d$ của cấp số cộng đó.","rendered_options":["$d = 2$","$d = 3$","$d = -3$","$d = 5$"]},{"question":"Cho cấp số cộng $(u_n)$ với số hạng đầu $u_1$ và công sai $d$. Công thức số hạng tổng quát $u_n$ là:","options":["$u_n = u_1 + (n+1)d$","$u_n = u_1 + nd$","$u_n = u_1 + (n-1)d$","$u_n = u_1 - (n-1)d$"],"correctAnswerIndex":2,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Cho cấp số cộng $(u_n)$ với số hạng đầu $u_1$ và công sai $d$. Công thức số hạng tổng quát $u_n$ là:","rendered_options":["$u_n = u_1 + (n+1)d$","$u_n = u_1 + nd$","$u_n = u_1 + (n-1)d$","$u_n = u_1 - (n-1)d$"]},{"question":"Cho dãy số $(u_n)$ được xác định bởi công thức $u_n = 3n - 2$ với $n \\in \\mathbb{N}^*$. Khẳng định nào sau đây là đúng?","options":["$(u_n)$ là cấp số cộng có công sai $d = 3$.","$(u_n)$ là cấp số cộng có công sai $d = -2$.","$(u_n)$ là cấp số nhân có công bội $q = 3$.","$(u_n)$ không phải là cấp số cộng cũng không phải cấp số nhân."],"correctAnswerIndex":0,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Cho dãy số $(u_n)$ được xác định bởi công thức $u_n = 3n - 2$ với $n \\in \\mathbb{N}^*$. Khẳng định nào sau đây là đúng?","rendered_options":["$(u_n)$ là cấp số cộng có công sai $d = 3$.","$(u_n)$ là cấp số cộng có công sai $d = -2$.","$(u_n)$ là cấp số nhân có công bội $q = 3$.","$(u_n)$ không phải là cấp số cộng cũng không phải cấp số nhân."]},{"main_question":"Cho cấp số cộng $(u_n)$ có số hạng đầu $u_1 = 3$ và công sai $d = 2$. Hãy xác định tính đúng/sai của các mệnh đề sau:","statements":[{"statement":"Số hạng thứ hai của cấp số cộng là $u_2 = 5$.","is_correct":true,"rendered_statement":"Số hạng thứ hai của cấp số cộng là $u_2 = 5$."},{"statement":"Số hạng tổng quát của cấp số cộng là $u_n = 2n + 3$.","is_correct":false,"rendered_statement":"Số hạng tổng quát của cấp số cộng là $u_n = 2n + 3$."},{"statement":"Tổng của 10 số hạng đầu tiên của cấp số cộng là $S_{10} = 120$.","is_correct":true,"rendered_statement":"Tổng của 10 số hạng đầu tiên của cấp số cộng là $S_{10} = 120$."},{"statement":"Nếu $u_k = 101$ thì $k = 49$.","is_correct":false,"rendered_statement":"Nếu $u_k = 101$ thì $k = 49$."}],"type":"true-false","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Cho cấp số cộng $(u_n)$ có số hạng đầu $u_1 = 3$ và công sai $d = 2$. Hãy xác định tính đúng/sai của các mệnh đề sau:"},{"question":"Cho một cấp số cộng $(u_n)$ có số hạng đầu $u_1 = 5$ và công sai $d = 3$. Hãy tính số hạng thứ $u_{10}$ của cấp số cộng đó.","answer":"$32$","type":"short-answer","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Cho một cấp số cộng $(u_n)$ có số hạng đầu $u_1 = 5$ và công sai $d = 3$. Hãy tính số hạng thứ $u_{10}$ của cấp số cộng đó.","rendered_answer":"$32$"},{"question":"Cho một cấp số cộng có số hạng đầu $u_1 = 4$ và công sai $d = -3$. Số hạng thứ $6$ của cấp số cộng đó là:","options":["-14","-11","-8","-5"],"correctAnswerIndex":2,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Cho một cấp số cộng có số hạng đầu $u_1 = 4$ và công sai $d = -3$. Số hạng thứ $6$ của cấp số cộng đó là:","rendered_options":["-14","-11","-8","-5"]},{"question":"Một cấp số cộng có số hạng đầu $u_1 = 5$ và công sai $d = 2$. Tổng của $8$ số hạng đầu tiên của cấp số cộng đó là:","options":["88","96","104","112"],"correctAnswerIndex":2,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Một cấp số cộng có số hạng đầu $u_1 = 5$ và công sai $d = 2$. Tổng của $8$ số hạng đầu tiên của cấp số cộng đó là:","rendered_options":["88","96","104","112"]},{"question":"Dãy số nào sau đây là cấp số cộng?","options":["$1, 2, 4, 8, \\dots$","$1, 3, 5, 7, \\dots$","$1, \\dfrac{1}{2}, \\dfrac{1}{4}, \\dfrac{1}{8}, \\dots$","$1, -1, 1, -1, \\dots$"],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Dãy số nào sau đây là cấp số cộng?","rendered_options":["$1, 2, 4, 8, \\dots$","$1, 3, 5, 7, \\dots$","$1, \\dfrac{1}{2}, \\dfrac{1}{4}, \\dfrac{1}{8}, \\dots$","$1, -1, 1, -1, \\dots$"]},{"question":"Cho cấp số cộng có số hạng đầu $u_1 = 5$ và công sai $d = 3$. Số hạng thứ $u_4$ của cấp số cộng đó là bao nhiêu?","options":["$u_4 = 11$","$u_4 = 14$","$u_4 = 17$","$u_4 = 20$"],"correctAnswerIndex":2,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Cho cấp số cộng có số hạng đầu $u_1 = 5$ và công sai $d = 3$. Số hạng thứ $u_4$ của cấp số cộng đó là bao nhiêu?","rendered_options":["$u_4 = 11$","$u_4 = 14$","$u_4 = 17$","$u_4 = 20$"]},{"question":"Cho cấp số cộng $(u_n)$ có số hạng đầu $u_1 = 3$ và số hạng thứ hai $u_2 = 7$. Tìm công sai $d$ của cấp số cộng đó.","answer":"$4$","type":"short-answer","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Cho cấp số cộng $(u_n)$ có số hạng đầu $u_1 = 3$ và số hạng thứ hai $u_2 = 7$. Tìm công sai $d$ của cấp số cộng đó.","rendered_answer":"$4$"},{"main_question":"Cho cấp số cộng $(u_n)$ có số hạng đầu $u_1 = 3$ và công sai $d = 2$.","statements":[{"statement":"Dãy số $(u_n)$ là một cấp số cộng khi hiệu giữa hai số hạng liên tiếp là một hằng số.","is_correct":true,"rendered_statement":"Dãy số $(u_n)$ là một cấp số cộng khi hiệu giữa hai số hạng liên tiếp là một hằng số."},{"statement":"Số hạng thứ $5$ của cấp số cộng $(u_n)$ là $u_5 = 11$.","is_correct":true,"rendered_statement":"Số hạng thứ $5$ của cấp số cộng $(u_n)$ là $u_5 = 11$."},{"statement":"Tổng của $10$ số hạng đầu tiên của cấp số cộng $(u_n)$ là $S_{10} = 120$.","is_correct":true,"rendered_statement":"Tổng của $10$ số hạng đầu tiên của cấp số cộng $(u_n)$ là $S_{10} = 120$."},{"statement":"Số $2024$ là một số hạng của cấp số cộng $(u_n)$.","is_correct":false,"rendered_statement":"Số $2024$ là một số hạng của cấp số cộng $(u_n)$."}],"type":"true-false","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Cho cấp số cộng $(u_n)$ có số hạng đầu $u_1 = 3$ và công sai $d = 2$."},{"main_question":"Cho một cấp số cộng $(u_n)$ với $u_2 = 7$ và $u_5 = 19$.","statements":[{"statement":"Ba số $a, b, c$ theo thứ tự đó lập thành cấp số cộng khi và chỉ khi $a+c = 2b$.","is_correct":true,"rendered_statement":"Ba số $a, b, c$ theo thứ tự đó lập thành cấp số cộng khi và chỉ khi $a+c = 2b$."},{"statement":"Công sai của cấp số cộng $(u_n)$ là $d = 4$.","is_correct":true,"rendered_statement":"Công sai của cấp số cộng $(u_n)$ là $d = 4$."},{"statement":"Số hạng đầu tiên của cấp số cộng $(u_n)$ là $u_1 = 3$.","is_correct":true,"rendered_statement":"Số hạng đầu tiên của cấp số cộng $(u_n)$ là $u_1 = 3$."},{"statement":"Tổng của $15$ số hạng đầu tiên của cấp số cộng $(u_n)$ là $S_{15} = 495$.","is_correct":false,"rendered_statement":"Tổng của $15$ số hạng đầu tiên của cấp số cộng $(u_n)$ là $S_{15} = 495$."}],"type":"true-false","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Cho một cấp số cộng $(u_n)$ với $u_2 = 7$ và $u_5 = 19$."}];
        const options = {"title":"Bài kiểm tra - 18/11/2025","timeLimit":45,"retriesAllowed":1,"showAnswers":true,"showExplanation":true,"aiAssessment":true,"shortAnswerFormat":"freeform","examCode":"UBW452","teacherName":"Trần Văn Điệp","scoring":{"mc":5,"tf":4,"sa":1,"essay":0,"tfMethod":"progressive"}};
        const googleScriptUrl = "https://script.google.com/macros/s/AKfycbxEADHtrNjuJbbtJ8unmCajvSKKQdmYDHnfvJk3GDC3micp-G7btEVnEXLT6HLOUMC2uQ/exec";
        const examCode = "UBW452";
        
        let userAnswers = new Array(quizData.length).fill(null);
        let studentName = '';
        let studentClass = '';
        let timerInterval;
        let timeRemaining = options.timeLimit * 60;
        let retriesCount = 0;
        let submissionStatus = 'pending';
        let monitoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0 };
        let lastScore, lastAnswerDetails; // For retrying AI assessment
        
        const welcomeScreen = document.getElementById('welcome-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const resultsScreen = document.getElementById('results-screen');
        const startBtn = document.getElementById('start-btn');
        const nameInput = document.getElementById('name');
        const classInput = document.getElementById('class');
        const timerEl = document.getElementById('timer');
        const submitBtn = document.getElementById('submit-btn');
        const scoreDisplay = document.getElementById('score-display');
        const assessmentDisplay = document.getElementById('assessment-display');
        const reviewContainer = document.getElementById('review-container');
        const retryBtn = document.getElementById('retry-btn');
        const restartBtn = document.getElementById('restart-btn');
        const warningEl = document.getElementById('monitoring-warning');

        // Make functions globally accessible for inline onclick handlers
        window.selectOption = selectOption;
        window.selectTFOption = selectTFOption;
        window.saveTextAnswer = saveTextAnswer;
        window.toggleExplanation = toggleExplanation;
        window.fetchAndRenderExplanation = fetchAndRenderExplanation;
        window.retryAIAssessment = retryAIAssessment;
        window.setupFormInputs = setupFormInputs;
        window.saveFormAnswer = saveFormAnswer;

        startBtn.addEventListener('click', startQuiz);
        submitBtn.addEventListener('click', confirmSubmit);
        retryBtn.addEventListener('click', retryQuiz);
        restartBtn.addEventListener('click', () => window.location.reload());
        
        nameInput.value = localStorage.getItem('studentName') || '';
        classInput.value = localStorage.getItem('studentClass') || '';
        
        function safeTypeset(elements) {
            if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                window.MathJax.typesetPromise(elements).catch(function (err) {
                    console.error('MathJax error: ' + err.message);
                });
            }
        }
        
        function startQuiz() {
            studentName = nameInput.value.trim();
            studentClass = classInput.value.trim();
            if (!studentName || !studentClass) {
                alert('Vui lòng nhập đầy đủ Họ và tên và Lớp.');
                return;
            }
            localStorage.setItem('studentName', studentName);
            localStorage.setItem('studentClass', studentClass);
            
            welcomeScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            resultsScreen.classList.add('hidden');
            
            userAnswers.fill(null);
            submissionStatus = 'pending';
            
            renderAllQuestions();
            
            if (options.timeLimit > 0) {
                timeRemaining = options.timeLimit * 60;
                startTimer();
            } else {
                timerEl.textContent = 'Không giới hạn';
            }
            startMonitoring();
        }

        function mapType(typeStr) {
             if (!typeStr) return 'multiple-choice';
             if (typeStr.startsWith('mc-') || ['cloze-test', 'sentence-ordering', 'multiple-choice', 'paragraph-sentence-ordering'].includes(typeStr)) return 'multiple-choice';
             if (typeStr.startsWith('tf-') || typeStr === 'true-false') return 'true-false';
             if (typeStr === 'short-answer' || typeStr === 'sentence-transformation') return 'short-answer';
             return 'essay';
        }
        
        function renderAllQuestions() {
            const container = document.getElementById('all-questions-container');
            let allHTML = '';

            const groupedQuestions = quizData.reduce((acc, q) => {
                const type = mapType(q.type);
                if (!acc[type]) acc[type] = [];
                acc[type].push(q);
                return acc;
            }, {});

            const groupInfo = {
                'multiple-choice': { title: 'PHẦN I. TRẮC NGHIỆM KHÁCH QUAN' },
                'true-false': { title: 'PHẦN II. CÂU HỎI ĐÚNG - SAI' },
                'short-answer': { title: 'PHẦN III. CÂU HỎI TRẢ LỜI NGẮN' },
                'essay': { title: 'PHẦN IV. CÂU HỎI TỰ LUẬN' },
            };
            
            let questionCounter = 0;
            const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];

            partOrder.forEach(partType => {
                const questions = groupedQuestions[partType];
                if (!questions || questions.length === 0) return;

                const info = groupInfo[partType];
                allHTML += `<div class="group-header mb-6 pb-3 border-b-2 border-gray-300"><h2 class="text-2xl font-bold text-gray-800">${info.title}</h2></div>`;
                
                questions.forEach((item) => {
                    const index = quizData.indexOf(item);
                    questionCounter++;
                    
                    let contentHTML = `<div class="question-card mb-8 p-6 border rounded-xl shadow-sm" id="q-${index}">`;
                    contentHTML += `<p class="font-semibold text-lg text-gray-800 mb-4">Câu ${questionCounter}:</p>`;
                    contentHTML += `<div class="prose max-w-none text-gray-700 mb-4">${item.rendered_question || ''}</div>`;

                    let answerHTML = '';
                    const savedAnswer = userAnswers[index];
                    const type = mapType(item.type);
                    
                    if (type === 'multiple-choice') {
                        answerHTML = `<div class="space-y-3">`;
                        (item.rendered_options || []).forEach((opt, i) => {
                            const isSelected = savedAnswer === i;
                            answerHTML += `<div class="option ${isSelected ? 'selected' : ''} p-3 border-2 rounded-lg cursor-pointer transition flex items-start" data-q-index="${index}" data-opt-index="${i}" onclick="selectOption(this, ${index}, ${i})">
                                                <span class="font-bold mr-2">${String.fromCharCode(65 + i)}.</span>
                                                <div class="flex-grow">${opt}</div>
                                            </div>`;
                        });
                        answerHTML += `</div>`;
                    } else if (type === 'true-false') {
                         answerHTML = `<div class="space-y-3">`;
                         (item.statements || []).forEach((stmt, i) => {
                            const savedStmtAnswer = savedAnswer ? savedAnswer[i] : null;
                            const isTrueSelected = savedStmtAnswer === true;
                            const isFalseSelected = savedStmtAnswer === false;
                            answerHTML += `<div class="p-3 border-2 rounded-lg flex items-center justify-between gap-4">
                                                <div class="flex-grow prose max-w-none">${stmt.rendered_statement}</div>
                                                <div class="flex-shrink-0 flex gap-2">
                                                    <button class="${isTrueSelected ? 'bg-blue-500 text-white' : 'bg-gray-200'} px-4 py-2 rounded-md font-semibold" onclick="selectTFOption(this, ${index}, ${i}, true)">Đúng</button>
                                                    <button class="${isFalseSelected ? 'bg-red-500 text-white' : 'bg-gray-200'} px-4 py-2 rounded-md font-semibold" onclick="selectTFOption(this, ${index}, ${i}, false)">Sai</button>
                                                </div>
                                            </div>`;
                        });
                        answerHTML += `</div>`;
                    } else if (type === 'short-answer') {
                        const savedAnswerStr = userAnswers[index] || '';
                        if (options.shortAnswerFormat === 'form') {
                             answerHTML = `<div id="sa-form-${index}" class="flex items-center gap-2">`;
                            for (let i = 0; i < 4; i++) {
                                answerHTML += `<input type="text" maxlength="1" data-q-index="${index}" class="w-12 h-12 text-center text-2xl font-bold border-2 border-gray-400 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" value="">`;
                            }
                            answerHTML += `</div>`;
                        } else {
                            answerHTML = `<input type="text" class="w-full border border-gray-300 rounded-md p-2" value="${savedAnswerStr}" onchange="saveTextAnswer(this, ${index})">`;
                        }
                    } else if (type === 'essay') {
                        answerHTML = `<textarea class="w-full border border-gray-300 rounded-md p-2" rows="5" onchange="saveTextAnswer(this, ${index})">${savedAnswer || ''}</textarea>`;
                    }

                    contentHTML += answerHTML + '</div>'; // close question-card
                    allHTML += contentHTML;
                });
            });
            container.innerHTML = allHTML;

            // Add event listeners for the 4-box forms after rendering
            document.querySelectorAll('[id^="sa-form-"]').forEach(formContainer => {
                const inputs = formContainer.querySelectorAll('input');
                if (inputs.length > 0) {
                    setupFormInputs(inputs);
                }
            });

            safeTypeset([container]);
        }

        function setupFormInputs(inputs) {
            const qIndex = inputs[0].dataset.qIndex;
            inputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    if (e.target.value && index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }
                    saveFormAnswer(qIndex, inputs);
                });

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        inputs[index - 1].focus();
                    }
                     saveFormAnswer(qIndex, inputs);
                });
                 input.addEventListener('change', () => saveFormAnswer(qIndex, inputs));
            });
        }

        function saveFormAnswer(qIndex, inputs) {
            let combinedValue = '';
            inputs.forEach(inp => { combinedValue += inp.value; });
            userAnswers[qIndex] = combinedValue;
        }

        function selectOption(element, qIndex, optIndex) {
            userAnswers[qIndex] = optIndex;
            const questionCard = document.getElementById(`q-${qIndex}`);
            questionCard.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
        }
        
        function selectTFOption(button, qIndex, stmtIndex, answer) {
            if (!userAnswers[qIndex] || !Array.isArray(userAnswers[qIndex])) {
                userAnswers[qIndex] = new Array(quizData[qIndex].statements.length).fill(null);
            }
            userAnswers[qIndex][stmtIndex] = answer;
            const parent = button.parentElement;
            Array.from(parent.children).forEach(btn => btn.classList.remove('bg-blue-500', 'text-white', 'bg-red-500'));
            button.classList.add(answer ? 'bg-blue-500' : 'bg-red-500', 'text-white');
        }
        
        function saveTextAnswer(element, qIndex) {
            userAnswers[qIndex] = element.value;
        }

        function confirmSubmit() {
            const unansweredQuestions = userAnswers.map((answer, index) => ({ answer, index }))
                                                .filter(item => item.answer === null || 
                                                                (Array.isArray(item.answer) && item.answer.some(a => a === null)));

            let message = "Bạn có chắc chắn muốn nộp bài không?";
            if (unansweredQuestions.length > 0) {
                message = `Bạn còn ${unansweredQuestions.length} câu chưa hoàn thành. Bạn có chắc chắn muốn nộp bài không?`;
            }

            if (confirm(message)) {
                submitQuiz();
            }
        }

        async function submitQuiz() {
            if (submissionStatus !== 'pending') return;
            submissionStatus = 'submitting';
            stopTimer();
            stopMonitoring();
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="animate-pulse">Đang nộp bài...</span>';

            const { score, totalPossibleScore, answerDetails } = calculateScore();
            lastScore = score;
            lastAnswerDetails = answerDetails;
            const finalScore = (totalPossibleScore > 0 ? (score / totalPossibleScore * 10) : 0).toFixed(2);
            let aiAssessment = 'Không có';

            if (options.aiAssessment) {
                aiAssessment = await getAIAssessment(finalScore, answerDetails);
            }
            
            const submissionData = new FormData();
            submissionData.append('timestamp', new Date().toLocaleString('vi-VN'));
            submissionData.append('name', studentName);
            submissionData.append('class', studentClass);
            submissionData.append('score', finalScore);
            submissionData.append('assessment', aiAssessment);
            submissionData.append('examCode', examCode);
            submissionData.append('monitoringLog', JSON.stringify(monitoringLog));
            submissionData.append('answerDetails', JSON.stringify(answerDetails));
            
            if (googleScriptUrl) {
                try {
                    await fetch(googleScriptUrl, { method: 'POST', body: new URLSearchParams(submissionData) });
                } catch (error) {
                    console.error('Error submitting to Google Script:', error);
                    alert('Lỗi: Không thể nộp kết quả lên hệ thống. Vui lòng kiểm tra lại kết nối mạng và thử lại.');
                }
            }
            submissionStatus = 'submitted';
            showResults(finalScore, aiAssessment, answerDetails);
        }
        
        function showResults(score, assessment, answerDetails) {
            quizScreen.classList.add('hidden');
            resultsScreen.classList.remove('hidden');
            
            if (options.showAnswers) {
                scoreDisplay.textContent = `${score} / 10`;
                scoreDisplay.classList.remove('hidden');
            } else {
                scoreDisplay.innerHTML = '<p class="text-3xl text-center text-green-600">Nộp bài thành công!</p>';
                scoreDisplay.classList.remove('hidden');
            }
            
            if (options.aiAssessment) {
                // The getAIAssessment function now handles rendering directly.
                // This call ensures the initial result is displayed.
                if (assessment.startsWith("Lỗi")) {
                    // If there was an error, getAIAssessment already rendered the error message.
                } else {
                     assessmentDisplay.innerHTML = `<strong>Nhận xét từ AI:</strong> <br> ${assessment.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>')}`;
                     assessmentDisplay.classList.remove('hidden');
                }
            } else {
                assessmentDisplay.classList.add('hidden');
            }
            
            if (options.showAnswers) {
                renderReview(answerDetails);
            } else {
                reviewContainer.innerHTML = '<p class="text-center text-gray-600">Giáo viên đã chọn không hiển thị đáp án và giải thích chi tiết.</p>';
            }
            
            if (retriesCount < options.retriesAllowed) retryBtn.classList.remove('hidden');
        }

        function calculateScore() {
            let score = 0;
            let totalPossibleScore = 0;
            const answerDetails = [];
            
            const mcCount = quizData.filter(q => mapType(q.type) === 'multiple-choice').length;
            const tfCount = quizData.filter(q => mapType(q.type) === 'true-false').length;
            const saCount = quizData.filter(q => mapType(q.type) === 'short-answer').length;

            const pointsPerMc = mcCount > 0 ? options.scoring.mc / mcCount : 0;
            const pointsPerTf = tfCount > 0 ? options.scoring.tf / tfCount : 0;
            const pointsPerSa = saCount > 0 ? options.scoring.sa / saCount : 0;
            
            totalPossibleScore = (options.scoring.mc || 0) + (options.scoring.tf || 0) + (options.scoring.sa || 0) + (options.scoring.essay || 0);
            if (totalPossibleScore === 0 && (mcCount + tfCount + saCount > 0)) {
                 totalPossibleScore = (pointsPerMc * mcCount) + (pointsPerTf * tfCount) + (pointsPerSa * saCount);
            }
            if (totalPossibleScore === 0 && quizData.length > 0) totalPossibleScore = 10; 

            quizData.forEach((item, index) => {
                const userAnswer = userAnswers[index];
                let isCorrect = false;
                let detail = null;
                const type = mapType(item.type);

                if (type === 'multiple-choice') {
                    isCorrect = userAnswer === item.correctAnswerIndex;
                    if(isCorrect) score += pointsPerMc;
                } else if (type === 'true-false') {
                    let correctStatements = 0;
                    detail = [];
                    (item.statements || []).forEach((stmt, i) => {
                        const isStmtCorrect = (userAnswer && userAnswer[i] === stmt.is_correct);
                        if(isStmtCorrect) correctStatements++;
                        detail.push({isCorrect: isStmtCorrect});
                    });

                    if (options.scoring.tfMethod === 'even') {
                        score += (correctStatements / 4) * pointsPerTf;
                    } else { // progressive
                        if (correctStatements === 4) score += pointsPerTf;
                        else if (correctStatements === 3) score += 0.5 * pointsPerTf;
                        else if (correctStatements === 2) score += 0.25 * pointsPerTf;
                        else if (correctStatements === 1) score += 0.1 * pointsPerTf;
                    }
                    isCorrect = correctStatements === 4;
                } else if (type === 'short-answer') {
                    // Normalize answers for comparison: trim whitespace and convert to lowercase
                    const correctAnswer = (item.answer || '').toString().trim().toLowerCase();
                    const studentAnswer = (userAnswer || '').toString().trim().toLowerCase();
                    isCorrect = studentAnswer === correctAnswer;
                    if (isCorrect) {
                        score += pointsPerSa;
                    }
                } else {
                    isCorrect = null; // For 'essay' type
                }
                answerDetails.push({ questionNumber: index + 1, isCorrect, type, details: detail });
            });
            return { score, totalPossibleScore, answerDetails };
        }
        
        function renderReview(answerDetails) {
            let reviewHTML = '<h3 class="text-2xl font-bold mb-6">Xem lại bài làm</h3>';
            quizData.forEach((item, index) => {
                reviewHTML += `<div class="mb-6 p-4 border rounded-lg">`;
                reviewHTML += `<p class="font-semibold mb-2">Câu ${index + 1}:</p><div class="prose max-w-none">${item.rendered_question}</div>`;
                const type = mapType(item.type);
                const detail = answerDetails.find(d => d.questionNumber === index + 1);

                if (type === 'multiple-choice') {
                     reviewHTML += '<div class="mt-4 space-y-2">';
                     (item.rendered_options || []).forEach((opt, i) => {
                        let classes = 'option p-3 border-2 rounded-lg flex items-start';
                        if (i === item.correctAnswerIndex) classes += ' correct';
                        if (userAnswers[index] === i && i !== item.correctAnswerIndex) classes += ' incorrect';
                        reviewHTML += `<div class="${classes}"><span class="font-bold mr-2">${String.fromCharCode(65 + i)}.</span> <div>${opt}</div></div>`;
                     });
                     reviewHTML += '</div>';
                } else if (type === 'true-false') {
                     reviewHTML += '<div class="mt-4 space-y-2">';
                     (item.statements || []).forEach((stmt, i) => {
                         let classes = 'p-3 border-2 rounded-lg flex items-center justify-between gap-4';
                         const userChoice = userAnswers[index] ? userAnswers[index][i] : null;
                         const isCorrect = userChoice === stmt.is_correct;
                         if (isCorrect) classes += ' bg-green-50 border-green-300';
                         else if (userChoice !== null) classes += ' bg-red-50 border-red-300';
                         else classes += ' bg-gray-50 border-gray-200';

                         reviewHTML += `<div class="${classes}">
                                         <div class="prose max-w-none">${stmt.rendered_statement}</div>
                                         <div class="flex-shrink-0 font-bold text-sm text-right">
                                             <span>Đáp án: ${stmt.is_correct ? 'Đ' : 'S'}</span><br>
                                             <span>Bạn chọn: ${userChoice === true ? 'Đ' : userChoice === false ? 'S' : '...'}</span>
                                         </div>
                                     </div>`;
                     });
                     reviewHTML += '</div>';
                } else {
                    reviewHTML += `<div class="mt-4 p-3 bg-gray-100 rounded-lg"><strong>Câu trả lời của bạn:</strong><br>${userAnswers[index] || '<em>Chưa trả lời</em>'}</div>`;
                    if (item.rendered_answer) {
                        reviewHTML += `<div class="mt-2 p-3 bg-blue-50 rounded-lg"><strong>Đáp án gợi ý:</strong><br><div class="prose max-w-none">${item.rendered_answer}</div></div>`;
                    }
                }
                
                if (options.showExplanation) {
                     reviewHTML += `<div class="mt-4">
                                      <button class="text-sm text-blue-600 hover:underline" onclick="toggleExplanation(${index}, this)">Xem giải thích từ AI</button>
                                      <div id="explanation-${index}" class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg hidden"></div>
                                   </div>`;
                }
                reviewHTML += '</div>';
            });
            reviewContainer.innerHTML = reviewHTML;
            safeTypeset([reviewContainer]);
        }

        function retryQuiz() {
            retriesCount++;
            startQuiz();
        }
        
        function startTimer() {
            stopTimer();
            timerInterval = setInterval(() => {
                timeRemaining--;
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                if (timeRemaining <= 0) {
                    stopTimer();
                    alert('Đã hết thời gian làm bài!');
                    submitQuiz();
                }
            }, 1000);
        }

        function stopTimer() { clearInterval(timerInterval); }
        
        function showWarning(message) {
            warningEl.textContent = message;
            warningEl.style.display = 'block';
            warningEl.style.animation = 'none';
            warningEl.offsetHeight; 
            warningEl.style.animation = 'fade-in-out 5s ease-in-out';
        }

        function handleVisibilityChange() {
            if (document.hidden) {
                monitoringLog.thoatManHinh++;
                showWarning('⚠️ Đã phát hiện chuyển tab hoặc thu nhỏ cửa sổ!');
            }
        }
        function handleCopy() { monitoringLog.saoChep++; showWarning('⚠️ Đã phát hiện hành vi sao chép!'); }
        function handlePaste() { monitoringLog.dan++; showWarning('⚠️ Đã phát hiện hành vi dán!'); }
        function startMonitoring() {
            monitoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0 };
            document.addEventListener('visibilitychange', handleVisibilityChange);
            document.addEventListener('copy', handleCopy);
            document.addEventListener('paste', handlePaste);
        }
        function stopMonitoring() {
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            document.removeEventListener('copy', handleCopy);
            document.removeEventListener('paste', handlePaste);
        }

        async function toggleExplanation(index, button) {
            const explanationContainer = document.getElementById(`explanation-${index}`);
            if (!explanationContainer) return;

            const isHidden = explanationContainer.classList.toggle('hidden');
            button.textContent = isHidden ? 'Xem giải thích từ AI' : 'Ẩn giải thích';

            const hasLoaded = explanationContainer.hasAttribute('data-loaded');
            const hadError = explanationContainer.getAttribute('data-loaded') === 'error';

            if (!isHidden && (!hasLoaded || hadError)) {
                await fetchAndRenderExplanation(index);
            }
        }

        async function fetchAndRenderExplanation(index) {
            const explanationContainer = document.getElementById(`explanation-${index}`);
            explanationContainer.innerHTML = '<div class="animate-pulse">AI đang suy nghĩ...</div>';
            explanationContainer.setAttribute('data-loaded', 'loading');

            if (!API_KEY) {
                explanationContainer.innerHTML = '<p class="text-red-600">Lỗi: API Key của giáo viên chưa được cấu hình.</p>';
                explanationContainer.setAttribute('data-loaded', 'error');
                return;
            }
            
            try {
                const ai = new GoogleGenAI({ apiKey: API_KEY });
                const item = quizData[index];
                const questionText = (mapType(item.type) === 'true-false') ? (item.main_question || '') : (item.question || '');
                let prompt = `Bạn là một trợ lý giáo viên AI, am hiểu sâu sắc Chương trình GDPT 2018 của Việt Nam. Hãy cung cấp một lời giải chi tiết, từng bước một cho câu hỏi sau đây.\n---**CÂU HỎI:**\n${questionText}\n---`;
                
                if (mapType(item.type) === 'multiple-choice') {
                    prompt += `\n**ĐÁP ÁN ĐÚNG:** ${String.fromCharCode(65 + item.correctAnswerIndex)}. ${item.options[item.correctAnswerIndex] || ''}`;
                } else if (mapType(item.type) === 'true-false') {
                    prompt += `\n**CÁC MỆNH ĐỀ VÀ ĐÁP ÁN:**\n${item.statements.map((s, i) => `${String.fromCharCode(97 + i)}) ${s.statement || ''} -> ${s.is_correct ? 'Đúng' : 'Sai'}`).join('\n')}`;
                } else {
                    prompt += `---\n**ĐÁP ÁN / GỢI Ý:** ${item.answer || ''}`;
                }
                prompt += `\n---\n**YÊU CẦU:** Giải thích chi tiết, từng bước. Định dạng công thức toán bằng LaTeX. Dùng **...** để in đậm.`;
                
                const response = await ai.models.generateContent({ model: "gemini-2.5-flash", contents: prompt });
                const explanationText = response.text || "Không thể tạo giải thích.";
                
                let htmlContent = explanationText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                explanationContainer.innerHTML = htmlContent;
                safeTypeset([explanationContainer]);
                explanationContainer.setAttribute('data-loaded', 'true');

            } catch (error) {
                console.error("AI Explanation Error:", error);
                let errorMessage = "Lỗi khi tạo giải thích.";
                if (error && error.message) {
                    const sanitizedMessage = error.message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    errorMessage += `<br><small class="text-gray-500">Chi tiết: ${sanitizedMessage}</small>`;
                }
                explanationContainer.innerHTML = `<div class="text-red-600">${errorMessage}</div>
                                                  <a href="#" onclick="event.preventDefault(); fetchAndRenderExplanation(${index})" class="text-sm text-blue-600 hover:underline mt-2">Thử lại giải thích</a>`;
                explanationContainer.setAttribute('data-loaded', 'error');
            }
        }

        async function getAIAssessment(score, answerDetails) {
            if (!API_KEY) {
                const errorMsg = "Không thể tạo nhận xét do API Key của giáo viên chưa được cấu hình.";
                assessmentDisplay.innerHTML = `<strong>Nhận xét từ AI:</strong> <br> <p class="text-red-600">${errorMsg}</p>`;
                assessmentDisplay.classList.remove('hidden');
                return errorMsg;
            }
            
            assessmentDisplay.innerHTML = '<strong>Nhận xét từ AI:</strong> <span class="animate-pulse">AI đang phân tích bài làm...</span>';
            assessmentDisplay.classList.remove('hidden');

            try {
                const ai = new GoogleGenAI({ apiKey: API_KEY });
                const wrongAnswers = answerDetails.filter(d => d.isCorrect === false || (d.type === 'true-false' && d.details && d.details.some(sub => !sub.isCorrect)));
                if (wrongAnswers.length === 0) {
                    const congrats = "Chúc mừng em đã hoàn thành bài làm rất tốt và không sai câu nào! Em đã nắm vững kiến thức. Hãy tiếp tục phát huy nhé!";
                    assessmentDisplay.innerHTML = `<strong>Nhận xét từ AI:</strong> <br> ${congrats}`;
                    return congrats;
                }
                const wrongQuestionsSummary = wrongAnswers.map(d => {
                    const item = quizData[d.questionNumber - 1];
                    const questionText = item.question || item.main_question || '';
                    return `- Câu ${d.questionNumber}: ${questionText}`;
                }).join('\n');
                
                const prompt = `Bạn là một giáo viên AI tận tâm. Dựa vào kết quả bài làm sau, hãy đưa ra một nhận xét chi tiết (4-5 câu) về năng lực của học sinh.\n**Kết quả:**\n- Điểm số: ${score} / 10\n- Các câu sai:\n${wrongQuestionsSummary}\n**YÊU CẦU:**\n1. Bắt đầu bằng lời động viên.\n2. Phân tích nội dung các câu sai để **xác định cụ thể các mảng kiến thức học sinh còn yếu.**\n3. Đưa ra gợi ý cụ thể để khắc phục.\n4. Kết thúc bằng lời khích lệ.\n5. Giọng văn thân thiện, tích cực.`;

                const response = await ai.models.generateContent({ model: "gemini-2.5-flash", contents: prompt });
                const assessmentText = response.text || "Không thể tạo nhận xét.";
                
                assessmentDisplay.innerHTML = `<strong>Nhận xét từ AI:</strong> <br> ${assessmentText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>')}`;
                return assessmentText;

            } catch (error) {
                console.error("AI Assessment Error:", error);
                let errorMessage = "Đã có lỗi xảy ra trong quá trình AI tạo nhận xét.";
                if (error && error.message) {
                    const sanitizedMessage = error.message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    errorMessage += `<br><small class="text-gray-500">Chi tiết: ${sanitizedMessage}</small>`;
                }
                assessmentDisplay.innerHTML = `<strong>Nhận xét từ AI:</strong> <br> <div class="text-red-600">${errorMessage}</div>
                                               <button onclick="retryAIAssessment()" class="text-sm text-blue-600 hover:underline mt-2">Thử lại</button>`;
                return "Lỗi khi tạo nhận xét AI.";
            }
        }
        
        async function retryAIAssessment() {
            if (lastAnswerDetails) {
                const finalScore = (lastScore / (quizData.length > 0 ? 10 : 1) * 10).toFixed(2);
                await getAIAssessment(finalScore, lastAnswerDetails);
            }
        }
    </script>
</body>
</html>
    