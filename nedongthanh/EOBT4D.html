
    <!DOCTYPE html>
    <html lang="vi">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Bài Tập Luyện Tập</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
        <script>
            window.MathJax = {
                tex: {
                    packages: {'[+]': ['ams']},
                    inlineMath: [['$', '$'], ['\\(', '\\)']],
                    displayMath: [['$$', '$$'], ['\\[', '\\]']]
                },
                chtml: {
                    fontCache: 'global',
                    linebreaks: {
                        automatic: true
                    }
                }
            };
        </script>
        <script type="text/javascript" id="MathJax-script" async
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
        </script>
        <style>
            body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #f0f4f8; }
            .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
            @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
            .question-card {
                background-color: white;
                border-radius: 1rem;
                padding: 1.5rem 2rem;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                border-left: 5px solid transparent;
                transition: all 0.3s ease;
            }
            .ai-explanation {
                background-color: #f0f9ff;
                color: #0c4a6e;
                padding: 1rem;
                border-radius: 0.75rem;
                font-size: 0.9rem;
                margin-top: 1rem;
                border-left: 4px solid #38bdf8;
            }
            .feedback-icon { width: 1.5rem; height: 1.5rem; }
            .option-label {
                transition: all 0.2s ease-in-out;
                border: 2px solid #e5e7eb;
            }
            .option-label:hover {
                border-color: #6366f1;
                background-color: #eef2ff;
            }
            .option-label.correct {
                border-color: #10b981 !important;
                background-color: #ecfdf5 !important;
                color: #065f46;
            }
            .option-label.incorrect {
                border-color: #ef4444 !important;
                background-color: #fef2f2 !important;
                color: #991b1b;
            }
            .statement-item.correct { background-color: #ecfdf5; border-color: #10b981; }
            .statement-item.incorrect { background-color: #fef2f2; border-color: #ef4444; }
            .prose { max-width: 100%; }
            .prose h1, .prose h2, .prose h3 { font-weight: 600; }
            .prose p { margin-top: 0.5em; margin-bottom: 0.5em; }
            .prose ul, .prose ol { margin-top: 1em; margin-bottom: 1em; padding-left: 1.5em; }
            .prose li > p { margin-top: 0; margin-bottom: 0; }
            .prose code { background-color: #e5e7eb; padding: 0.2em 0.4em; margin: 0; font-size: 85%; border-radius: 3px; }
            .prose pre { background-color: #e5e7eb; padding: 1em; border-radius: 0.5em; overflow-x: auto; }
            .prose pre code { background-color: transparent; padding: 0; }
            details[open] > summary .details-arrow {
                transform: rotate(180deg);
            }
        </style>
    </head>
    <body class="bg-slate-100 text-slate-800">
        <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md transform transition-all" style="animation: fadeIn 0.3s ease-out;">
                <h2 class="text-2xl font-bold mb-2 text-center text-slate-800">Thông Tin Học Sinh</h2>
                <p class="text-center text-slate-500 mb-6">Vui lòng nhập để bắt đầu làm bài.</p>
                <form id="student-info-form">
                    <div class="mb-4">
                        <label for="student-name" class="block text-sm font-medium text-slate-700 mb-1">Họ và tên</label>
                        <input type="text" id="student-name" required class="mt-1 block w-full block border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="student-class" class="block text-sm font-medium text-slate-700 mb-1">Lớp</label>
                        <input type="text" id="student-class" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="exam-code" class="block text-sm font-medium text-slate-700 mb-1">Mã đề</label>
                        <input type="text" id="exam-code" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Nhập mã đề giáo viên cung cấp">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Giáo viên:</label>
                        <p class="mt-1 text-slate-800 bg-slate-100 p-2.5 rounded-lg">Thạch Nê</p>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">Bắt đầu làm bài</button>
                </form>
            </div>
        </div>
        <div class="container mx-auto p-4 md:p-8 max-w-4xl">
            <header class="mb-10 p-8 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg">
                <div class="flex justify-between items-center flex-wrap gap-4">
                    <div>
                        <h1 class="text-4xl font-bold">Bài Tập Luyện Tập</h1>
                        <p class="text-lg text-blue-100 mt-2">Hãy hoàn thành các câu hỏi dưới đây một cách tốt nhất!</p>
                        <p class="text-sm text-blue-200 mt-4">Tác giả: Thạch Nê</p>
                    </div>
                    <div id="timer-container" class="text-right">
                         <div id="timer-display" class="text-3xl font-bold tracking-wider bg-white/20 px-4 py-2 rounded-lg">--:--</div>
                         <div id="retries-display" class="text-sm mt-1 text-blue-200"></div>
                    </div>
                </div>
            </header>
            <main id="student-quiz-container" class="space-y-8 hidden">
                <!-- Questions will be rendered here by JS -->
            </main>
            <footer class="mt-10 text-center">
                <button id="submit-quiz-btn" class="bg-indigo-600 text-white py-3 px-12 rounded-full font-bold text-lg hover:bg-indigo-700 transition-all duration-300 shadow-lg hover:shadow-xl hidden transform hover:scale-105">Nộp Bài</button>
                <div id="result-container" class="mt-6 hidden"></div>
                <div id="ai-feedback-container" class="mt-8 text-left hidden"></div>
                <div id="post-submit-options" class="hidden mt-6 flex flex-col sm:flex-row items-center justify-center gap-4">
                    <button id="retry-quiz-btn" class="w-full sm:w-auto bg-slate-600 text-white py-2.5 px-6 rounded-lg font-semibold hover:bg-slate-700 transition-transform transform hover:scale-105">Làm Lại Đề Này</button>
                </div>
            </footer>
        </div>

        <div id="proctoring-widget" class="fixed bottom-4 right-4 bg-yellow-100 text-yellow-800 p-3 rounded-lg shadow-lg text-sm z-50 hidden border border-yellow-300" style="max-width: 200px;">
            <h4 class="font-bold mb-2 border-b border-yellow-300 pb-1 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 3.001-1.742 3.001H4.42c-1.53 0-2.493-1.667-1.743-3.001l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                Giám sát
            </h4>
            <p>Thoát màn hình: <span id="tab-switch-count" class="font-bold">0</span></p>
            <p>Sao chép: <span id="copy-count" class="font-bold">0</span></p>
            <p>Dán: <span id="paste-count" class="font-bold">0</span></p>
        </div>

        <script type="module">
            import { GoogleGenAI, Type } from "https://esm.sh/@google/genai@^1.13.0";
            let quizData = [{"type":"multiple-choice","question":"Thiết bị nào sau đây được xem là một thiết bị số có gắn bộ xử lí thông tin và hiện diện phổ biến trong hầu hết các gia đình hiện nay?","questionImage":null,"mappedType":"multiple-choice","options":["Tủ lạnh cơ","Quạt điện","Điện thoại thông minh","Bàn là"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Trong lĩnh vực y tế, thiết bị số có gắn bộ xử lí thông tin giúp ích như thế nào?","questionImage":null,"mappedType":"multiple-choice","options":["Chỉ dùng để ghi chép hồ sơ bệnh án thủ công.","Hỗ trợ chẩn đoán hình ảnh, quản lí thông tin bệnh nhân và vận hành thiết bị y tế hiện đại.","Chỉ để phát nhạc giải trí cho bệnh nhân.","Không có vai trò gì đáng kể."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Khả năng nào sau đây là một trong những khả năng cơ bản của máy tính?","questionImage":null,"mappedType":"multiple-choice","options":["Cảm nhận và diễn giải cảm xúc của con người.","Thực hiện phép tính với tốc độ siêu nhanh và lưu trữ dữ liệu lớn.","Tự động tạo ra ý tưởng và sáng tạo nghệ thuật độc lập.","Thay thế hoàn toàn vai trò của giáo viên trong lớp học."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Ứng dụng nào của máy tính minh họa rõ nhất tác động của công nghệ thông tin đến lĩnh vực giáo dục?","questionImage":null,"mappedType":"multiple-choice","options":["In sách giáo khoa truyền thống.","Hệ thống học trực tuyến (E-learning) và bài giảng điện tử.","Sử dụng bảng đen phấn trắng.","Thư viện chỉ có sách giấy."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Công nghệ thông tin tác động đến xã hội như thế nào thông qua việc kết nối con người?","questionImage":null,"mappedType":"multiple-choice","options":["Làm giảm khả năng giao tiếp của con người trong thực tế.","Chỉ tạo ra sự cô lập giữa các cá nhân.","Tạo ra các mạng xã hội và ứng dụng liên lạc giúp mọi người kết nối dễ dàng hơn.","Không ảnh hưởng đến cách con người giao tiếp."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Thiết bị nào sau đây KHÔNG phải là thiết bị số có gắn bộ xử lí thông tin?","questionImage":null,"mappedType":"multiple-choice","options":["Điện thoại thông minh","Máy giặt tự động","Cân đồng hồ cơ học","Hệ thống điều khiển đèn giao thông"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Khả năng vượt trội nào của máy tính giúp nó được ứng dụng rộng rãi trong các lĩnh vực như y tế, tài chính, khoa học?","questionImage":null,"mappedType":"multiple-choice","options":["Khả năng thể hiện cảm xúc phức tạp","Khả năng xử lí lượng lớn thông tin với tốc độ cao","Khả năng tự đưa ra quyết định đạo đức","Khả năng sáng tạo nghệ thuật độc đáo"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Công nghệ thông tin đã góp phần thay đổi phương pháp giảng dạy và học tập trong giáo dục theo hướng nào?","questionImage":null,"mappedType":"multiple-choice","options":["Giảm thiểu tương tác giữa giáo viên và học sinh","Giúp cá nhân hóa việc học, mở rộng tài nguyên và hỗ trợ học từ xa","Chỉ tập trung vào việc học lí thuyết, không cần thực hành","Giới hạn phạm vi kiến thức tiếp cận của học sinh"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Trong lĩnh vực ngân hàng, ứng dụng công nghệ thông tin đã mang lại lợi ích chủ yếu nào cho khách hàng?","questionImage":null,"mappedType":"multiple-choice","options":["Buộc khách hàng phải đến giao dịch trực tiếp tại quầy","Chỉ cho phép giao dịch bằng tiền mặt","Giúp khách hàng thực hiện giao dịch mọi lúc, mọi nơi một cách nhanh chóng và an toàn","Giới hạn số lượng giao dịch mỗi ngày của khách hàng"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Lĩnh vực nào sau đây hiện nay KHÔNG có sự hiện diện và ứng dụng của các thiết bị số và công nghệ thông tin?","questionImage":null,"mappedType":"multiple-choice","options":["Y tế","Nông nghiệp","Nghệ thuật","Tất cả các lĩnh vực trên đều có sự hiện diện của công nghệ thông tin"],"optionsImage":[],"correctAnswerIndex":3},{"type":"true-false","main_question":"Phân tích các mệnh đề sau để đánh giá sự hiện diện và tác động của các thiết bị số trong đời sống:","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Điện thoại thông minh là một ví dụ phổ biến của thiết bị số có mặt trong đời sống hàng ngày.","is_correct":true},{"statement":"Các thiết bị số chỉ có thể thực hiện những tác vụ được lập trình sẵn mà không có khả năng tự học hỏi hay thích nghi.","is_correct":false},{"statement":"Công nghệ thông tin đã thay đổi hoàn toàn cách con người tiếp cận thông tin, nhưng không có tác động đáng kể đến hình thức giao dịch tài chính.","is_correct":false},{"statement":"Sự phụ thuộc vào các thiết bị số và mạng Internet hoàn toàn không gây ra bất kì lo ngại nào về quyền riêng tư cá nhân và an ninh mạng.","is_correct":false}]},{"type":"true-false","main_question":"Đánh giá các mệnh đề dưới đây về khả năng của máy tính và tác động của công nghệ thông tin đến xã hội:","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Thiết bị số chỉ bao gồm máy tính cá nhân và điện thoại thông minh.","is_correct":false},{"statement":"Công nghệ thông tin không đóng vai trò trong việc điều khiển các hệ thống tự động hóa trong nhà máy sản xuất.","is_correct":false},{"statement":"Trong giáo dục, việc sử dụng máy tính và Internet chỉ giới hạn ở việc tìm kiếm thông tin mà không hỗ trợ các hoạt động học tập tương tác hay học trực tuyến.","is_correct":false},{"statement":"Mặc dù có nhiều lợi ích, sự phát triển của công nghệ thông tin cũng tiềm ẩn nguy cơ về phân hóa xã hội và thiếu công bằng trong tiếp cận thông tin đối với các nhóm dân cư khác nhau.","is_correct":true}]},{"type":"true-false","main_question":"Câu lạc bộ Lịch sử của trường bạn đang lên kế hoạch cho chuyến đi dã ngoại đến một di tích lịch sử. Để đảm bảo chuyến đi thành công và an toàn, các thành viên cần thu thập thông tin về địa điểm, phương tiện di chuyển, chi phí và các quy định liên quan. Hãy đánh giá các nhận định sau đây về chất lượng thông tin mà câu lạc bộ cần quan tâm.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Thông tin về địa chỉ và giờ mở cửa của di tích lịch sử là cần thiết để có thể đến đúng nơi và đúng thời gian.","is_correct":true},{"statement":"Việc sử dụng các thông tin đã được đăng tải trên các trang mạng xã hội không chính thống để lập kế hoạch chi phí có thể dẫn đến sai lệch đáng kể.","is_correct":true},{"statement":"Nếu câu lạc bộ chỉ tìm thông tin về di tích được cập nhật từ $5$ năm trước, trong khi có thông tin mới hơn về việc thay đổi quy định tham quan, thì đây là thông tin không đảm bảo tính mới và có thể gây rắc rối cho chuyến đi.","is_correct":true},{"statement":"Để đảm bảo tính đầy đủ và chính xác cho mọi khía cạnh của chuyến đi, câu lạc bộ chỉ cần dựa hoàn toàn vào thông tin trên trang web chính thức của di tích, vì đây là nguồn đáng tin cậy nhất.","is_correct":false}]},{"type":"true-false","main_question":"Một học sinh đang thực hiện dự án khoa học về biến đổi khí hậu. Học sinh đó cần thu thập các dữ liệu và thông tin để phân tích và đưa ra kết luận. Hãy đánh giá các nhận định sau đây về chất lượng thông tin mà học sinh cần xem xét.","questionImage":null,"mappedType":"true-false","statements":[{"statement":"Thông tin về định nghĩa \"biến đổi khí hậu\" là điểm khởi đầu quan trọng để hiểu rõ chủ đề.","is_correct":true},{"statement":"Việc chỉ sử dụng số liệu từ một quốc gia duy nhất trong báo cáo về mức độ tăng nhiệt toàn cầu có thể làm giảm tính đầy đủ và chính xác của dự án.","is_correct":true},{"statement":"Nếu học sinh tham khảo một bài báo khoa học được công bố cách đây $15$ năm về dự báo biến đổi khí hậu mà không tìm kiếm các nghiên cứu mới hơn, thông tin thu được có thể không còn tính mới và dẫn đến những nhận định lỗi thời.","is_correct":true},{"statement":"Để đạt được tính chính xác tuyệt đối, học sinh nên ưu tiên các bài đăng trên blog cá nhân của các nhà khoa học nổi tiếng vì đây là nguồn thông tin trực tiếp từ chuyên gia.","is_correct":false}]},{"type":"multiple-choice","question":"Vai trò chính của thông tin trong quá trình giải quyết vấn đề là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Làm cho vấn đề trở nên phức tạp hơn.","Cung cấp dữ liệu để phân tích và đưa ra quyết định.","Giải trí cho người dùng.","Thay thế cho chính vấn đề đó."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Tiêu chí chất lượng thông tin nào đề cập đến việc thông tin không chứa lỗi và đáng tin cậy?","questionImage":null,"mappedType":"multiple-choice","options":["Tính mới.","Tính đầy đủ.","Tính chính xác.","Tính phù hợp."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Khi thông tin chứa tất cả các dữ kiện và chi tiết cần thiết cho một nhiệm vụ cụ thể, nó sở hữu tiêu chí chất lượng nào?","questionImage":null,"mappedType":"multiple-choice","options":["Tính mới.","Tính đầy đủ.","Tính chính xác.","Tính sử dụng được."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Nếu thông tin phản ánh tình hình hiện tại và chưa bị lỗi thời, nó thỏa mãn tiêu chí nào?","questionImage":null,"mappedType":"multiple-choice","options":["Tính chính xác.","Tính đầy đủ.","Tính mới.","Tính sử dụng được."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Một mẩu thông tin được coi là 'hữu ích' hoặc 'liên quan' nếu nó phục vụ trực tiếp mục đích của vấn đề đang được giải quyết. Điều này mô tả tiêu chí chất lượng nào?","questionImage":null,"mappedType":"multiple-choice","options":["Tính mới.","Tính chính xác.","Tính đầy đủ.","Tính phù hợp (tính sử dụng được)."],"optionsImage":[],"correctAnswerIndex":3},{"type":"multiple-choice","question":"Trong quá trình giải quyết vấn đề, việc thông tin không đảm bảo tính chính xác sẽ dẫn đến hậu quả gì?","questionImage":null,"mappedType":"multiple-choice","options":["Làm chậm quá trình ra quyết định nhưng không ảnh hưởng đến kết quả cuối cùng.","Gây ra những quyết định sai lầm, không hiệu quả hoặc thậm chí gây thiệt hại.","Không ảnh hưởng đáng kể vì có thể điều chỉnh sau này.","Chỉ làm tăng chi phí xử lí thông tin mà không gây hậu quả nghiêm trọng."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Một bạn học sinh đang tìm kiếm thông tin về biến đổi khí hậu để làm bài thuyết trình. Nếu thông tin bạn tìm được chủ yếu là từ các bài báo cũ từ $10$ năm trước và không có số liệu cập nhật, thông tin đó đang thiếu tiêu chí chất lượng nào quan trọng nhất?","questionImage":null,"mappedType":"multiple-choice","options":["Tính đầy đủ.","Tính chính xác.","Tính sử dụng được (phù hợp).","Tính mới."],"optionsImage":[],"correctAnswerIndex":3},{"type":"multiple-choice","question":"Khi chuẩn bị cho một chuyến đi dã ngoại, bạn tìm thông tin về dự báo thời tiết. Bạn nên ưu tiên loại thông tin nào để đảm bảo chuyến đi an toàn và thuận lợi?","questionImage":null,"mappedType":"multiple-choice","options":["Thông tin dự báo thời tiết chung chung cho cả khu vực rộng lớn.","Thông tin thời tiết từ một nguồn không rõ ràng, chưa được kiểm chứng.","Thông tin dự báo thời tiết chi tiết, cập nhật liên tục cho địa điểm cụ thể và thời gian sắp tới.","Thông tin dự báo thời tiết đã cũ từ tuần trước."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Câu hỏi nào sau đây là tiêu chí quan trọng nhất để đánh giá tính tin cậy của một thông tin trên internet?","questionImage":null,"mappedType":"multiple-choice","options":["Thiết kế đẹp của trang web.","Số lượng người truy cập trang web.","Nguồn gốc rõ ràng và có uy tín.","Có nhiều hình ảnh minh họa."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Khi đánh giá chất lượng của một thông tin, yếu tố nào sau đây giúp xác định thông tin đó còn phù hợp với thời điểm hiện tại?","questionImage":null,"mappedType":"multiple-choice","options":["Tên tác giả.","Ngày xuất bản hoặc cập nhật.","Lượng chữ viết trên trang.","Kích thước phông chữ."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Để đảm bảo tính chính xác của thông tin khi tìm kiếm trên internet, em nên làm gì?","questionImage":null,"mappedType":"multiple-choice","options":["Chỉ đọc thông tin từ một nguồn duy nhất.","Luôn tin vào kết quả đầu tiên của công cụ tìm kiếm.","So sánh và kiểm tra thông tin từ nhiều nguồn khác nhau.","Bỏ qua các thông tin có kèm quảng cáo."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Mục đích chính của việc đánh giá chất lượng thông tin là gì?","questionImage":null,"mappedType":"multiple-choice","options":["Để tìm ra trang web có giao diện đẹp nhất.","Để xác định thông tin có phù hợp và đáng tin cậy cho việc giải quyết vấn đề hay không.","Để biết thông tin đó được bao nhiêu người chia sẻ.","Để luyện tập kỹ năng đọc nhanh."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Một thông tin được coi là khách quan khi nào?","questionImage":null,"mappedType":"multiple-choice","options":["Thông tin đó được trình bày với ngôn ngữ cảm xúc mạnh.","Thông tin chỉ đưa ra một quan điểm duy nhất, không có phản biện.","Thông tin đưa ra các sự kiện, số liệu mà không bị ảnh hưởng bởi ý kiến cá nhân.","Thông tin được tìm thấy trên các mạng xã hội phổ biến."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Khi tìm kiếm thông tin trên internet để giải quyết một vấn đề học tập, tiêu chí nào sau đây quan trọng nhất để đánh giá độ tin cậy của một nguồn thông tin?","questionImage":null,"mappedType":"multiple-choice","options":["Trang web có giao diện đẹp mắt và nhiều hình ảnh minh họa.","Thông tin được trình bày rõ ràng, khách quan và có dẫn chứng cụ thể.","Trang web có nhiều lượt truy cập và được chia sẻ rộng rãi trên mạng xã hội.","Người đăng tải thông tin là một cá nhân quen thuộc với bạn."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Để đánh giá tính khách quan của một bài viết trên mạng, học sinh lớp $9$ cần lưu ý điều gì?","questionImage":null,"mappedType":"multiple-choice","options":["Bài viết có chứa nhiều thuật ngữ chuyên ngành.","Tác giả sử dụng giọng điệu mạnh mẽ, chứa nhiều cảm xúc cá nhân, tập trung vào một quan điểm duy nhất và thiếu dẫn chứng.","Bài viết được đăng tải trên một trang báo điện tử lớn.","Thông tin được cập nhật thường xuyên."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Sau khi đã tìm được thông tin từ một nguồn đáng tin cậy, để đảm bảo chất lượng thông tin cho việc giải quyết vấn đề, bạn nên thực hiện bước tiếp theo nào?","questionImage":null,"mappedType":"multiple-choice","options":["Ngay lập tức sử dụng thông tin đó để hoàn thành nhiệm vụ mà không kiểm tra thêm.","Chia sẻ thông tin với bạn bè mà không cần kiểm chứng.","Đối chiếu, so sánh thông tin với các nguồn khác nhau để xác minh tính chính xác và đầy đủ.","Lưu trữ thông tin vào máy tính và quên đi."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Lan đang nghiên cứu để viết báo cáo khoa học về \"Tác động của trí tuệ nhân tạo (AI) đến thị trường lao động trong tương lai của Việt Nam\" cho cuộc thi Sáng tạo Khoa học Kĩ thuật. Cô ấy đã tìm thấy các nguồn thông tin sau trên mạng internet. Để đảm bảo báo cáo của mình có tính khách quan, khoa học và đáng tin cậy nhất, Lan nên ưu tiên đánh giá và sử dụng nguồn thông tin nào sau đây theo tiêu chí chặt chẽ nhất của một nghiên cứu khoa học?","questionImage":null,"mappedType":"multiple-choice","options":["Một bài viết trên diễn đàn công nghệ lớn, nơi các chuyên gia và người dùng thảo luận sôi nổi về tương lai AI và việc làm.","Một bài báo phỏng vấn các doanh nhân công nghệ thành đạt được đăng trên một tờ báo điện tử uy tín.","Một báo cáo phân tích từ Bộ Khoa học và Công nghệ hoặc Viện Hàn lâm Khoa học và Công nghệ Việt Nam, dựa trên dữ liệu khảo sát và mô hình dự báo kinh tế.","Một chuỗi video TikTok của một influencer về công nghệ, tổng hợp các xu hướng AI và đưa ra nhận định cá nhân."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Tác động tiêu cực nào sau đây của công nghệ kĩ thuật số có thể gây tổn hại trực tiếp đến sức khỏe thể chất của người sử dụng?","questionImage":null,"mappedType":"multiple-choice","options":["Giảm sự tương tác xã hội trực tiếp.","Tiếp xúc với thông tin độc hại.","Mỏi mắt, đau vai gáy do sử dụng thiết bị điện tử quá lâu.","Nghiện mạng xã hội."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Theo pháp luật Việt Nam, hành vi nào sau đây là vi phạm quy định về việc sử dụng dịch vụ Internet?","questionImage":null,"mappedType":"multiple-choice","options":["Trao đổi thông tin cá nhân với bạn bè qua mạng xã hội.","Sử dụng Internet để học tập, nghiên cứu tài liệu.","Tải xuống và chia sẻ các tài liệu có bản quyền mà không được phép.","Tham gia các diễn đàn trực tuyến để thảo luận chủ đề lành mạnh."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Hành vi nào sau đây được coi là thiếu văn hóa hoặc vi phạm đạo đức khi tham gia môi trường số?","questionImage":null,"mappedType":"multiple-choice","options":["Bình luận mang tính chất xây dựng trên các bài viết.","Chia sẻ thông tin không đúng sự thật, xuyên tạc, bôi nhọ người khác.","Báo cáo các nội dung vi phạm trên nền tảng.","Sử dụng tên thật khi đăng ký tài khoản mạng xã hội."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Theo pháp luật về sở hữu trí tuệ, việc sử dụng sản phẩm phần mềm, âm nhạc, phim ảnh mà không mua bản quyền hoặc không được sự cho phép của tác giả được gọi là hành vi gì?","questionImage":null,"mappedType":"multiple-choice","options":["Sử dụng hợp pháp.","Vi phạm bản quyền.","Trao đổi thông tin cá nhân.","Quyền sử dụng công bằng."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Người sử dụng Internet có trách nhiệm chính trong việc bảo vệ thông tin cá nhân của mình bằng cách nào sau đây?","questionImage":null,"mappedType":"multiple-choice","options":["Chia sẻ mật khẩu tài khoản cho nhiều người cùng sử dụng.","Sử dụng mật khẩu yếu, dễ đoán cho các tài khoản trực tuyến.","Cài đặt phần mềm diệt virus và thường xuyên cập nhật mật khẩu mạnh.","Truy cập các trang web không rõ nguồn gốc, có thể chứa mã độc."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Hành vi nào sau đây được xem là tác động tiêu cực của công nghệ kĩ thuật số đối với đời sống con người và xã hội?","questionImage":null,"mappedType":"multiple-choice","options":["Khuyến khích học tập và nghiên cứu trực tuyến.","Tăng cường kết nối và giao lưu xã hội.","Gây nghiện và giảm tương tác trực tiếp.","Cung cấp thông tin đa dạng và dễ tiếp cận."],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"Theo quy định pháp luật về sử dụng dịch vụ Internet, người dùng có trách nhiệm chính nào sau đây?","questionImage":null,"mappedType":"multiple-choice","options":["Đăng tải mọi thông tin cá nhân lên mạng xã hội.","Bảo mật thông tin cá nhân và không truy cập vào các trang web độc hại.","Chia sẻ tài khoản cá nhân với bạn bè để tăng cường tương tác.","Tự ý sao chép và phát tán các tác phẩm có bản quyền mà không xin phép."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Hành vi sao chép và phát tán một phần mềm có bản quyền mà không có sự cho phép của chủ sở hữu được xem là vi phạm pháp luật về khía cạnh nào?","questionImage":null,"mappedType":"multiple-choice","options":["Quyền riêng tư cá nhân.","Quyền sở hữu trí tuệ.","Quyền tự do ngôn luận.","Quyền tiếp cận thông tin."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Khi tham gia các hoạt động trên môi trường số, hành vi nào sau đây được coi là thiếu văn hoá và trái đạo đức?","questionImage":null,"mappedType":"multiple-choice","options":["Đóng góp ý kiến mang tính xây dựng cho cộng đồng.","Lăng mạ, xúc phạm người khác qua bình luận trực tuyến.","Chia sẻ kiến thức hữu ích và kinh nghiệm cá nhân.","Tham gia các nhóm học tập trực tuyến để trao đổi bài vở."],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Luật Công nghệ thông tin và các nghị định về sử dụng dịch vụ Internet của Việt Nam được ban hành nhằm mục đích chủ yếu nào sau đây?","questionImage":null,"mappedType":"multiple-choice","options":["Khuyến khích tối đa việc sử dụng Internet không giới hạn.","Đảm bảo an toàn thông tin, bảo vệ quyền lợi người dùng và quản lí các hoạt động trên không gian mạng.","Hạn chế hoàn toàn việc trao đổi thông tin cá nhân trên mạng.","Tăng cường quyền lực của các nhà cung cấp dịch vụ Internet."],"optionsImage":[],"correctAnswerIndex":1},{"type":"essay","question":"Trình bày hai tác động tiêu cực của việc sử dụng công nghệ số và Internet đối với cá nhân.","questionImage":null,"mappedType":"essay","answer":"Gợi ý: Hai tác động tiêu cực đối với cá nhân có thể là: Gây nghiện Internet, giảm tương tác xã hội trực tiếp, ảnh hưởng đến sức khỏe (mắt, cột sống, tinh thần), tiếp xúc với thông tin xấu độc, lừa đảo trực tuyến."},{"type":"essay","question":"Nêu một ví dụ cụ thể về tác động tiêu cực của công nghệ số đối với xã hội.","questionImage":null,"mappedType":"essay","answer":"Gợi ý: Một ví dụ về tác động tiêu cực của công nghệ số đối với xã hội là việc lan truyền tin giả (fake news) trên mạng xã hội, gây hoang mang dư luận, làm mất niềm tin và có thể dẫn đến những bất ổn xã hội. Hoặc việc gia tăng các vụ lừa đảo trực tuyến, làm mất mát tài sản của nhiều người."},{"type":"essay","question":"Theo pháp luật Việt Nam, người sử dụng dịch vụ Internet có những trách nhiệm cơ bản nào? Nêu ít nhất ba trách nhiệm.","questionImage":null,"mappedType":"essay","answer":"Gợi ý: Ba trách nhiệm cơ bản của người sử dụng dịch vụ Internet bao gồm: Không được lợi dụng Internet để chống phá Nhà nước, gây rối an ninh trật tự; không được đăng tải, phát tán thông tin xuyên tạc, xúc phạm uy tín tổ chức, danh dự cá nhân; không được thực hiện các hành vi lừa đảo, đánh bạc hoặc các hành vi vi phạm pháp luật khác. Ngoài ra còn có trách nhiệm bảo vệ thông tin cá nhân và tôn trọng quyền sở hữu trí tuệ."},{"type":"essay","question":"Khái niệm \"quyền sở hữu thông tin\" trong môi trường số được hiểu như thế nào?","questionImage":null,"mappedType":"essay","answer":"Gợi ý: Quyền sở hữu thông tin trong môi trường số được hiểu là quyền của cá nhân, tổ chức đối với các dữ liệu, nội dung số mà họ tạo ra hoặc có quyền sử dụng hợp pháp. Quyền này bao gồm quyền định đoạt (quyết định việc sử dụng, chia sẻ), quyền bảo vệ (không bị sao chép, sử dụng trái phép) và quyền khai thác giá trị từ thông tin đó theo quy định của pháp luật."},{"type":"essay","question":"Hãy kể tên hai hành vi vi phạm đạo đức hoặc pháp luật phổ biến khi hoạt động trong môi trường số (ví dụ: trên mạng xã hội).","questionImage":null,"mappedType":"essay","answer":"Gợi ý: Hai hành vi vi phạm đạo đức hoặc pháp luật phổ biến khi hoạt động trong môi trường số là: Hành vi bắt nạt trực tuyến (cyberbullying), xúc phạm danh dự, nhân phẩm người khác; hành vi phát tán văn hóa phẩm đồi trụy, thông tin độc hại; hành vi sao chép, sử dụng trái phép các sản phẩm có bản quyền (vi phạm quyền sở hữu trí tuệ); hoặc hành vi lừa đảo chiếm đoạt tài sản trên mạng."}];
            const quizOptions = {"timeLimit":45,"retriesAllowed":1,"showAnswers":true,"showExplanation":true,"aiAssessment":true,"scoring":{"mc":5,"tf":2,"sa":2,"essay":1,"tfMethod":"progressive"}};
            const googleScriptUrl = "https://script.google.com/macros/s/AKfycbyXVOPPNSSP5FmrTv_9C3ZOWiBAoMwPyRo7TwMrArLCHPEHFv9FgeBznHiBAR5yIl-4rQ/exec";
            const correctExamCode = "EOBT4D";
            const teacherApiKey = "gen-lang-client-0486158888";
            let studentInfo = {};
            let isSubmitted = false;
            let timerInterval;
            let retriesLeft = quizOptions.retriesAllowed;
            let studentApiKey = "";
            let ai = null;

            let proctoringLog = {
                thoatManHinh: 0,
                saoChep: 0,
                dan: 0,
                suKien: []
            };

            const studentQuizContainer = document.getElementById('student-quiz-container');
            const submitBtn = document.getElementById('submit-quiz-btn');
            const resultContainer = document.getElementById('result-container');
            const postSubmitOptions = document.getElementById('post-submit-options');
            const retryBtn = document.getElementById('retry-quiz-btn');
            const loginModal = document.getElementById('login-modal');
            const studentInfoForm = document.getElementById('student-info-form');
            const timerDisplay = document.getElementById('timer-display');
            const retriesDisplay = document.getElementById('retries-display');
            function shuffleQuiz() {
                // Shuffle options/statements within each question first
                quizData.forEach(item => {
                    // Shuffle multiple-choice options and their corresponding images
                    if (item.mappedType === 'multiple-choice' && item.options && item.options.length > 0) {
                        const correctAnswerText = item.options[item.correctAnswerIndex];
                        let optionsWithImages = item.options.map((opt, index) => ({
                            text: opt,
                            image: (item.optionsImage && item.optionsImage[index]) ? item.optionsImage[index] : null
                        }));
                        // Fisher-Yates shuffle
                        for (let i = optionsWithImages.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [optionsWithImages[i], optionsWithImages[j]] = [optionsWithImages[j], optionsWithImages[i]];
                        }
                        // Update the item with shuffled data
                        item.options = optionsWithImages.map(opt => opt.text);
                        item.optionsImage = optionsWithImages.map(opt => opt.image);
                        item.correctAnswerIndex = item.options.indexOf(correctAnswerText);
                    }
                    // Shuffle true-false statements
                    if (item.mappedType === 'true-false' && item.statements && item.statements.length > 0) {
                         for (let i = item.statements.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [item.statements[i], item.statements[j]] = [item.statements[j], item.statements[i]];
                        }
                    }
                });
                // Then, group questions by type and shuffle within each group
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});
                let shuffledQuizData = [];
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    if (grouped[partType]) {
                        const partQuestions = grouped[partType];
                        for (let i = partQuestions.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [partQuestions[i], partQuestions[j]] = [partQuestions[j], partQuestions[i]];
                        }
                        shuffledQuizData = shuffledQuizData.concat(partQuestions);
                    }
                });
               
                quizData = shuffledQuizData;
            }
            // --- Timer Function ---
            function startTimer(duration, display) {
                let timer = duration, minutes, seconds;
                clearInterval(timerInterval); // Clear any existing timer
                if(duration <= 0) {
                     display.textContent = "∞";
                     return;
                }
                timerInterval = setInterval(function () {
                    minutes = parseInt(timer / 60, 10);
                    seconds = parseInt(timer % 60, 10);
                    minutes = minutes < 10 ? "0" + minutes : minutes;
                    seconds = seconds < 10 ? "0" + seconds : seconds;
                    display.textContent = minutes + ":" + seconds;
                    if (--timer < 0) {
                        clearInterval(timerInterval);
                        alert("Hết giờ làm bài!");
                        handleSubmit();
                    }
                }, 1000);
            }
            
            async function showExplanation(index, button) {
                const item = quizData[index];
                const questionCard = document.getElementById(`student-q-${index}`);
                const feedbackDiv = document.getElementById(`q-${index}-feedback`);
                if (!questionCard || !feedbackDiv) return;

                const existingExplanation = feedbackDiv.querySelector('.ai-explanation');
                if (existingExplanation) {
                    existingExplanation.remove();
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Xem giải thích
                    `;
                    return;
                }

                button.disabled = true;
                button.innerHTML = '<div class="loader mr-2"></div> Đang tải...';

                if (item.explanation) {
                    displayExplanation(item.explanation, feedbackDiv, button);
                    return;
                }

                if (!ai) {
                    alert("Tính năng giải thích yêu cầu API Key, nhưng chưa được cấu hình bởi giáo viên.");
                    button.disabled = false;
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Xem giải thích
                    `;
                    return;
                }

                const questionText = item.question || item.main_question;
                let prompt = `Bạn là một trợ lý giáo viên AI, am hiểu sâu sắc Chương trình GDPT 2018. Hãy cung cấp một lời giải chi tiết, từng bước một cho câu hỏi sau đây. Lời giải phải chính xác, dễ hiểu và phù hợp với phương pháp giảng dạy của chương trình học, TUYỆT ĐỐI KHÔNG sử dụng kiến thức của lớp cao hơn để giải thích.\n\n--- CÂU HỎI ---\n${questionText}\n\n`;
                if (item.mappedType === 'multiple-choice') {
                    prompt += `--- CÁC LỰA CHỌN ---\n${item.options.map((opt, i) => `${String.fromCharCode(65 + i)}. ${opt}`).join('\n')}\n\n`;
                    prompt += `--- ĐÁP ÁN ĐÚNG ---\n${String.fromCharCode(65 + item.correctAnswerIndex)}. ${item.options[item.correctAnswerIndex]}`;
                } else if (item.mappedType === 'true-false') {
                    prompt += `--- CÁC MỆNH ĐỀ & ĐÁP ÁN ---\n${item.statements.map(s => ` - ${s.statement} -> ${s.is_correct ? 'Đúng' : 'Sai'}`).join('\n')}`;
                } else {
                    prompt += `--- ĐÁP ÁN / GỢI Ý ---\n${item.answer}`;
                }
                prompt += `\n\n--- YÊU CẦU ---\nGiải thích rõ ràng tại sao đáp án lại đúng, từng bước một. Định dạng tất cả các công thức toán học bằng LaTeX.`;

                try {
                    const response = await ai.models.generateContent({ model: "gemini-2.5-flash", contents: prompt });
                    const explanationText = response.text.replace(/\n/g, '<br>');
                    item.explanation = explanationText; // Cache it
                    displayExplanation(explanationText, feedbackDiv, button);
                } catch (error) {
                    console.error("Lỗi khi tạo giải thích:", error);
                    feedbackDiv.insertAdjacentHTML('beforeend', '<div class="ai-explanation text-red-600">Lỗi: Không thể tạo giải thích.</div>');
                    button.disabled = false;
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Thử lại
                    `;
                }
            }

            function displayExplanation(explanationText, container, button) {
                container.insertAdjacentHTML('beforeend', `<div class="ai-explanation prose prose-sm">${explanationText}</div>`);
                if (window.MathJax) MathJax.typesetPromise([container]);
                button.disabled = false;
                button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    Ẩn giải thích
                `;
            }
           
            function renderStudentQuiz() {
                studentQuizContainer.innerHTML = '';
               
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});
                const groupInfo = {
                    'multiple-choice': { title: 'PHẦN I. TRẮC NGHIỆM KHÁCH QUAN', subtitle: 'Chọn đáp án đúng nhất trong các lựa chọn sau.' },
                    'true-false': { title: 'PHẦN II. CÂU HỎI ĐÚNG - SAI', subtitle: 'Xác định tính đúng hoặc sai cho mỗi mệnh đề dưới đây.' },
                    'short-answer': { title: 'PHẦN III. CÂU HỎI TRẢ LỜI NGẮN', subtitle: 'Điền đáp án ngắn gọn vào phần trả lời.' },
                    'essay': { title: 'PHẦN IV. CÂU HỎI TỰ LUẬN', subtitle: 'Trình bày chi tiết bài giải của bạn.' }
                };
               
                let questionCounter = 0;
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    const questions = grouped[partType];
                    if (!questions || questions.length === 0) return;
                   
                    let groupHTML = `<div class="group-container space-y-8 mb-12">`;
                    const info = groupInfo[partType];
                    groupHTML += `
                        <div class="group-header pb-3 border-b-2 border-slate-300 mb-6">
                            <h2 class="text-2xl font-bold text-slate-800">${info.title}</h2>
                            ${info.subtitle ? `<p class="text-md text-slate-600 italic mt-1">${info.subtitle}</p>` : ''}
                        </div>
                    `;
                    questions.forEach((item, localIndex) => {
                        const globalIndex = quizData.indexOf(item);
                        questionCounter++;
                        groupHTML += `<div class="question-card" id="student-q-${globalIndex}">`;
                        let questionText = (item.question || item.main_question || '').replace(/\n/g, '<br>');
                       
                        groupHTML += `<div class="flex items-start">
                                     <div class="flex-grow">
                                         <div class="flex items-center mb-2">
                                             <span class="font-bold text-lg mr-3 text-indigo-600">Câu ${questionCounter}:</span>
                                             <div id="q-${globalIndex}-feedback-icon"></div>
                                         </div>
                                         <div class="question-content mt-2 text-lg text-slate-700">${questionText}</div>
                                         ${item.questionImage ? `<img src="${item.questionImage}" class="mt-4 rounded-lg max-w-full md:max-w-md border shadow-sm">` : ''}
                                     </div>
                                 </div>`;
                       
                        groupHTML += `<div class="mt-6">`;
                        switch(item.mappedType) {
                            case 'multiple-choice':
                                groupHTML += `<div class="options-grid grid grid-cols-1 md:grid-cols-2 gap-4">`;
                                item.options.forEach((opt, i) => {
                                    groupHTML += `<label for="q${globalIndex}-opt${i}" id="q${globalIndex}-opt-label${i}" class="option-label flex items-start p-4 border-2 rounded-xl cursor-pointer hover:bg-indigo-50 hover:border-indigo-400">
                                                     <input type="radio" name="q${globalIndex}" id="q${globalIndex}-opt${i}" value="${i}" class="flex-shrink-0 mt-1 h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                                     <div class="ml-3 flex-grow">
                                                         <span class="font-semibold text-slate-800">${String.fromCharCode(65 + i)}.</span>
                                                         <span class="option-content text-slate-700">${opt || ''}</span>
                                                         ${(item.optionsImage && item.optionsImage[i]) ? `<img src="${item.optionsImage[i]}" class="mt-2 rounded-lg max-w-xs border shadow-sm">` : ''}
                                                     </div>
                                                 </label>`;
                                });
                                groupHTML += `</div>`;
                                break;
                            case 'true-false':
                                 groupHTML += `<div class="space-y-4">`;
                                 item.statements.forEach((s, i) => {
                                     groupHTML += `<div class="statement-item border-t pt-4">
                                                  <p class="mb-3 text-slate-700">${String.fromCharCode(97 + i)}) ${s.statement || ''}</p>
                                                  <div class="flex gap-x-6">
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="true" class="mr-2 h-4 w-4"> Đúng</label>
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="false" class="mr-2 h-4 w-4"> Sai</label>
                                                  </div>
                                              </div>`;
                                 });
                                 groupHTML += `</div>`;
                                 break;
                            case 'short-answer':
                                groupHTML += `<input type="text" name="q${globalIndex}" class="mt-1 block w-full md:w-1/2 border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Nhập đáp án của bạn...">`;
                                break;
                            case 'essay':
                                groupHTML += `<textarea name="q${globalIndex}" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" rows="5" placeholder="Nhập câu trả lời tự luận của bạn..."></textarea>`;
                                break;
                        }
                        groupHTML += `</div><div id="q-${globalIndex}-feedback" class="mt-4"></div></div>`;
                    });
                    groupHTML += `</div>`;
                    studentQuizContainer.innerHTML += groupHTML;
                });
               
                if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                    MathJax.typesetPromise([studentQuizContainer]);
                }
            }
           
            async function generatePerformanceReview(allAnswersData) {
                const feedbackContainer = document.getElementById('ai-feedback-container');
                if (!feedbackContainer || !ai) return null;
                feedbackContainer.classList.remove('hidden');
                feedbackContainer.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-slate-800 mb-4">📝 Phân Tích & Gợi Ý Từ Trợ Lý AI</h3>
                        <div id="ai-feedback-loader" class="text-center py-6">
                            <svg class="animate-spin mx-auto h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p class="mt-3 text-slate-600">AI đang phân tích bài làm của bạn...</p>
                        </div>
                        <div id="ai-feedback-summary" class="hidden prose prose-sm max-w-none"></div>
                        <div id="ai-feedback-details" class="hidden mt-4 space-y-2"></div>
                    </div>
                `;
               
                const loader = document.getElementById('ai-feedback-loader');
                const summaryDiv = document.getElementById('ai-feedback-summary');
                const detailsDiv = document.getElementById('ai-feedback-details');
                const incorrectAnswers = allAnswersData.filter(a => !a.isCorrect);
                if (incorrectAnswers.length === 0) {
                    feedbackContainer.innerHTML = `
                        <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                            <h3 class="text-xl font-bold text-green-600">🎉 Chúc mừng!</h3>
                            <p class="mt-2 text-slate-700">Bạn đã trả lời đúng tất cả các câu hỏi. Làm tốt lắm!</p>
                        </div>
                    `;
                    return { overallFeedback: { summary: "Xuất sắc! Học sinh đã đã trả lời đúng tất cả các câu hỏi." } };
                }
                const summaryPrompt = `Bạn là một trợ lý giáo viên, nói tiếng Việt. Dựa vào tóm tắt các câu trả lời sai của học sinh, hãy đưa ra một nhận xét tổng quan ngắn gọn (khoảng 3-4 câu) về năng lực của học sinh, bao gồm điểm mạnh (suy luận từ các câu làm đúng), điểm yếu (dựa trên các câu sai) và một vài gợi ý ôn tập chung. Lời văn phải khích lệ, rõ ràng.
                Tóm tắt lỗi sai:
                ${JSON.stringify(incorrectAnswers.map(a => ({ cau: a.questionNumber, loai: a.type, cauHoi: a.question.substring(0, 50) + '...' })), null, 2)}`;
                try {
                    const summaryResponse = await ai.models.generateContent({
                        model: "gemini-2.5-flash",
                        contents: summaryPrompt
                    });
                    summaryDiv.innerHTML = summaryResponse.text.replace(/\n/g, '<br>');
                    loader.classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                    detailsDiv.classList.remove('hidden'); 
                } catch (e) {
                    console.error("Lỗi khi lấy nhận xét tổng quan:", e);
                    summaryDiv.innerHTML = '<p class="text-red-600">Lỗi khi tạo nhận xét tổng quan.</p>';
                    loader.classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                }
               
                const summaryForSheet = summaryDiv.innerText.substring(0, 200) + "...";
                return { overallFeedback: { summary: summaryForSheet } };
            }
            async function handleSubmit() {
                if (isSubmitted) return;
                isSubmitted = true;
                clearInterval(timerInterval);
                
                document.querySelectorAll('input, textarea').forEach(input => input.disabled = true);
                submitBtn.classList.add('hidden');
                postSubmitOptions.classList.remove('hidden');
                if (retriesLeft > 0) {
                    retryBtn.classList.remove('hidden');
                } else {
                    retryBtn.classList.add('hidden');
                }

                const proctoringDataString = JSON.stringify(proctoringLog);

                let totalStudentScore = 0;
                let totalCorrectAnswers = 0;
                let allAnswersData = [];
                const questionCounts = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    acc[type] = (acc[type] || 0) + 1;
                    return acc;
                }, {});
                
                quizData.forEach((item, index) => {
                    let questionNumber = index + 1;
                    let answerData = { questionNumber, type: item.type };
                    switch (item.mappedType) {
                        case 'multiple-choice':
                            const selectedOption = document.querySelector(`input[name="q${index}"]:checked`);
                            const isCorrectMC = selectedOption ? parseInt(selectedOption.value) === item.correctAnswerIndex : false;
                            if (isCorrectMC) {
                                totalCorrectAnswers++;
                                if (questionCounts['multiple-choice'] > 0) {
                                   totalStudentScore += quizOptions.scoring.mc / questionCounts['multiple-choice'];
                                }
                            }
                            answerData.question = item.question;
                            answerData.options = item.options;
                            answerData.yourAnswer = selectedOption ? String.fromCharCode(65 + parseInt(selectedOption.value)) : "Không trả lời";
                            answerData.correctAnswer = String.fromCharCode(65 + item.correctAnswerIndex);
                            answerData.isCorrect = isCorrectMC;
                            break;
                        case 'true-false':
                            let correctStatementsCount = 0;
                            let yourAnswerPattern = [];
                            let correctAnswerPattern = [];
                            let details = [];
                            item.statements.forEach((s, i) => {
                                const selectedTF = document.querySelector(`input[name="q${index}-s${i}"]:checked`);
                                const studentChoice = selectedTF ? selectedTF.value === 'true' : null;
                                const isStatementCorrect = studentChoice === s.is_correct;
                               
                                if (isStatementCorrect) correctStatementsCount++;
                               
                                yourAnswerPattern.push(studentChoice === null ? '?' : (studentChoice ? 'Đ' : 'S'));
                                correctAnswerPattern.push(s.is_correct ? 'Đ' : 'S');
                                details.push({ statement: s.statement, yourChoice: studentChoice === null ? 'Không trả lời' : (studentChoice ? 'Đúng' : 'Sai'), correctChoice: s.is_correct ? 'Đúng' : 'Sai', isCorrect: isStatementCorrect });
                            });
                            
                            let scorePerTfQuestion = 0;
                            if (questionCounts['true-false'] > 0) {
                                scorePerTfQuestion = quizOptions.scoring.tf / questionCounts['true-false'];
                            }
                            let questionPoints = 0;
                            if (quizOptions.scoring.tfMethod === 'progressive') {
                                const progressivePoints = { 0: 0, 1: 0.1, 2: 0.25, 3: 0.5, 4: 1.0 };
                                questionPoints = progressivePoints[correctStatementsCount] * scorePerTfQuestion;
                            } else { // even
                                questionPoints = (correctStatementsCount / 4) * scorePerTfQuestion;
                            }
                            totalStudentScore += questionPoints;

                            if(correctStatementsCount === 4) totalCorrectAnswers++;
                            answerData.question = item.main_question;
                            answerData.yourAnswer = yourAnswerPattern.join('-');
                            answerData.correctAnswer = correctAnswerPattern.join('-');
                            answerData.isCorrect = correctStatementsCount === 4;
                            answerData.details = details;
                            break;
                       
                        case 'short-answer':
                            const saInput = document.querySelector(`input[name="q${index}"]`);
                            const studentAnswerRaw = saInput ? (saInput.value ?? '').trim() : "";
                            const correctAnswerRaw = (item.answer ?? '').toString().trim().replace(/\$/g, '');
                            let isCorrectSA = false;
                            const studentAnswerNormalized = studentAnswerRaw.replace(',', '.');
                            const correctAnswerNormalized = correctAnswerRaw.replace(',', '.');
                            if (studentAnswerNormalized.toLowerCase() === correctAnswerNormalized.toLowerCase()) {
                                isCorrectSA = true;
                            }
                             if (isCorrectSA) {
                                totalCorrectAnswers++;
                                if (questionCounts['short-answer'] > 0) {
                                   totalStudentScore += quizOptions.scoring.sa / questionCounts['short-answer'];
                                }
                            }
                            answerData.question = item.question;
                            answerData.yourAnswer = studentAnswerRaw || "Không trả lời";
                            answerData.correctAnswer = correctAnswerRaw;
                            answerData.isCorrect = isCorrectSA;
                            break;
                           
                        case 'essay':
                             const essayInput = document.querySelector(`textarea[name="q${index}"]`);
                             answerData.question = item.question;
                             answerData.yourAnswer = essayInput.value || "Không trả lời";
                             answerData.correctAnswer = item.answer;
                             answerData.isCorrect = null; // Needs manual grading
                             break;
                    }
                    allAnswersData.push(answerData);
                });
                
                const finalScore = totalStudentScore;
                
                let competencyAssessment = "Giáo viên không yêu cầu AI phân tích bài làm.";
                if (quizOptions.aiAssessment) {
                    const feedbackData = await generatePerformanceReview(allAnswersData);
                    if (feedbackData && feedbackData.overallFeedback && feedbackData.overallFeedback.summary) {
                        competencyAssessment = feedbackData.overallFeedback.summary;
                    } else {
                        competencyAssessment = "Có lỗi xảy ra trong quá trình AI phân tích bài làm.";
                    }
                }
                
                if (quizOptions.showAnswers) {
                    const totalQuestions = quizData.length;
                    resultContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg text-center">
                        <h3 class="text-2xl font-bold text-slate-800">KẾT QUẢ BÀI LÀM</h3>
                        <p class="mt-4 text-lg">Số câu đúng hoàn toàn: <span class="font-bold text-green-600">${totalCorrectAnswers}/${totalQuestions}</span></p>
                        <p class="text-2xl mt-2">Điểm (thang 10): <span class="font-bold text-blue-600">${finalScore.toFixed(2)}</span></p>
                        ${questionCounts['essay'] > 0 ? `<p class="text-sm text-gray-600 italic mt-1">Lưu ý: Điểm trên chưa bao gồm ${quizOptions.scoring.essay} điểm của phần Tự luận.</p>` : ''}
                    </div>`;
                    resultContainer.classList.remove('hidden');

                    allAnswersData.forEach((ans, index) => {
                        const questionCard = document.getElementById(`student-q-${index}`);
                        const feedbackIconDiv = document.getElementById(`q-${index}-feedback-icon`);
                        const feedbackDiv = document.getElementById(`q-${index}-feedback`);
                        if (!questionCard || !feedbackIconDiv || !feedbackDiv) return;

                        const iconHTML = ans.isCorrect === true
                            ? '<svg class="feedback-icon text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>'
                            : (ans.isCorrect === false ? '<svg class="feedback-icon text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>' : '');
                        feedbackIconDiv.innerHTML = iconHTML;

                        if (ans.type.includes('multiple-choice')) {
                            const studentChoice = ans.yourAnswer === "Không trả lời" ? -1 : ans.yourAnswer.charCodeAt(0) - 65;
                            const correctChoice = ans.correctAnswer.charCodeAt(0) - 65;
                            document.getElementById(`q-${index}-opt-label${correctChoice}`)?.classList.add('correct');
                            if (studentChoice !== -1 && studentChoice !== correctChoice) {
                                document.getElementById(`q-${index}-opt-label${studentChoice}`)?.classList.add('incorrect');
                            }
                        } else if (ans.type === 'true-false') {
                            const statementItems = questionCard.querySelectorAll('.statement-item');
                            ans.details.forEach((detail, i) => { if(statementItems[i]) { statementItems[i].classList.add(detail.isCorrect ? 'correct' : 'incorrect'); }});
                        }

                        if (quizOptions.showExplanation) {
                            feedbackDiv.innerHTML = `<button data-explain-index="${index}" class="explain-btn mt-4 flex items-center px-4 py-2 bg-blue-100 text-blue-800 text-sm font-semibold rounded-lg hover:bg-blue-200 transition-colors">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Xem giải thích
                            </button>`;
                        }
                    });
                    
                    document.querySelectorAll('.explain-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const button = e.currentTarget;
                            const index = parseInt(button.dataset.explainIndex, 10);
                            showExplanation(index, button);
                        });
                    });

                    if (window.MathJax) await window.MathJax.typesetPromise([studentQuizContainer]);
                } else {
                     resultContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg text-center"><h3 class="text-xl font-bold text-green-600">Nộp bài thành công!</h3><p class="mt-2 text-slate-700">Bạn đã hoàn thành bài làm. Kết quả sẽ được giáo viên công bố sau.</p></div>`;
                    resultContainer.classList.remove('hidden');
                }
                
                const formData = new FormData();
                formData.append('name', studentInfo.name);
                formData.append('class', studentInfo.class);
                formData.append('score', `${finalScore.toFixed(2)}/10`);
                formData.append('assessment', competencyAssessment);
                formData.append('timestamp', new Date().toLocaleString('vi-VN'));
                formData.append('examCode', correctExamCode);
                formData.append('monitoringLog', proctoringDataString);
                formData.append('answerDetails', JSON.stringify(allAnswersData));
               
                fetch(googleScriptUrl, { method: 'POST', body: formData})
                    .then(res => console.log("Successfully submitted to Google Sheet"))
                    .catch(err => console.error("Error submitting to Google Sheet:", err));
            }
           
            function startNewAttempt() {
                isSubmitted = false;
                proctoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0, suKien: [] };
                const proctoringWidget = document.getElementById('proctoring-widget');
                if (proctoringWidget) {
                    proctoringWidget.classList.add('hidden');
                    document.getElementById('tab-switch-count').textContent = '0';
                    document.getElementById('copy-count').textContent = '0';
                    document.getElementById('paste-count').textContent = '0';
                }

                renderStudentQuiz();
                resultContainer.classList.add('hidden');
                document.getElementById('ai-feedback-container').classList.add('hidden');
                postSubmitOptions.classList.add('hidden');
                submitBtn.classList.remove('hidden');
                 if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                }
                retriesLeft--;
                retriesDisplay.textContent = `Lượt làm lại còn: ${retriesLeft}`;
                window.scrollTo(0, 0);
            }
            studentInfoForm.addEventListener('submit', (e) => {
                e.preventDefault();
               
                const enteredCode = document.getElementById('exam-code').value.trim().toUpperCase();
                if (enteredCode !== correctExamCode) {
                    alert('Mã đề không chính xác. Vui lòng kiểm tra lại!');
                    return;
                }
               
                studentApiKey = teacherApiKey;
                if (!studentApiKey) {
                    console.warn('Cảnh báo: Giáo viên chưa cấu hình API Key. Các tính năng AI sẽ không hoạt động.');
                }
       
                try {
                    if (studentApiKey) {
                       ai = new GoogleGenAI({ apiKey: studentApiKey });
                    }
                } catch(e) {
                    console.error("Lỗi khởi tạo Gemini API với key của giáo viên.", e);
                    alert("Cảnh báo: API Key của giáo viên không hợp lệ. Vui lòng báo cho giáo viên. Các tính năng AI sẽ không hoạt động.");
                    ai = null;
                }
                shuffleQuiz();
               
                studentInfo.name = document.getElementById('student-name').value;
                studentInfo.class = document.getElementById('student-class').value;
                loginModal.classList.add('hidden');
                studentQuizContainer.classList.remove('hidden');
                submitBtn.classList.remove('hidden');
               
                if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                } else {
                    timerDisplay.textContent = "Không giới hạn";
                }
                retriesDisplay.textContent = `Lượt làm lại còn: ${retriesLeft}`;
                renderStudentQuiz();

                const proctoringWidget = document.getElementById('proctoring-widget');
                const tabSwitchCountEl = document.getElementById('tab-switch-count');
                const copyCountEl = document.getElementById('copy-count');
                const pasteCountEl = document.getElementById('paste-count');

                function updateProctoringUI() {
                    if (proctoringLog.thoatManHinh > 0 || proctoringLog.saoChep > 0 || proctoringLog.dan > 0) {
                        proctoringWidget.classList.remove('hidden');
                    }
                    tabSwitchCountEl.textContent = proctoringLog.thoatManHinh;
                    copyCountEl.textContent = proctoringLog.saoChep;
                    pasteCountEl.textContent = proctoringLog.dan;
                }

                // Disable Right Click
                document.addEventListener('contextmenu', e => e.preventDefault());

                // Track Tab Switching
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && !isSubmitted) {
                        proctoringLog.thoatManHinh++;
                        proctoringLog.suKien.push({ loai: 'chuyen_tab', thoiGian: new Date().toISOString() });
                        updateProctoringUI();
                    }
                });

                // Track Copying
                document.addEventListener('copy', () => {
                    if (isSubmitted) return;
                    proctoringLog.saoChep++;
                    proctoringLog.suKien.push({ loai: 'sao_chep', thoiGian: new Date().toISOString() });
                    updateProctoringUI();
                });

                // Track Pasting
                document.addEventListener('paste', () => {
                    if (isSubmitted) return;
                    proctoringLog.dan++;
                    proctoringLog.suKien.push({ loai: 'dan', thoiGian: new Date().toISOString() });
                    updateProctoringUI();
                });
            });
            
            submitBtn.addEventListener('click', handleSubmit);
            retryBtn.addEventListener('click', () => {
                shuffleQuiz();
                startNewAttempt();
            });
        </script>
    </body>
    </html>
    