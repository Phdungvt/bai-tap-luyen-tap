
    <!DOCTYPE html>
    <html lang="vi">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>MID-TERM TEST</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
        <script>
            window.MathJax = {
                tex: {
                    packages: {'[+]': ['ams']},
                    inlineMath: [['$', '$'], ['\\(', '\\)']],
                    displayMath: [['$$', '$$'], ['\\[', '\\]']]
                },
                chtml: {
                    fontCache: 'global',
                    linebreaks: {
                        automatic: true
                    }
                }
            };
        </script>
        <script type="text/javascript" id="MathJax-script" async
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
        </script>
        <style>
            body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #f0f4f8; }
            .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
            @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
            .question-card {
                background-color: white;
                border-radius: 1rem;
                padding: 1.5rem 2rem;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                border-left: 5px solid transparent;
                transition: all 0.3s ease;
            }
            .ai-explanation {
                background-color: #f0f9ff;
                color: #0c4a6e;
                padding: 1rem;
                border-radius: 0.75rem;
                font-size: 0.9rem;
                margin-top: 1rem;
                border-left: 4px solid #38bdf8;
            }
            .feedback-icon { width: 1.5rem; height: 1.5rem; }
            .option-label {
                transition: all 0.2s ease-in-out;
                border: 2px solid #e5e7eb;
            }
            .option-label:hover {
                border-color: #6366f1;
                background-color: #eef2ff;
            }
            .option-label.correct {
                border-color: #10b981 !important;
                background-color: #ecfdf5 !important;
                color: #065f46;
            }
            .option-label.incorrect {
                border-color: #ef4444 !important;
                background-color: #fef2f2 !important;
                color: #991b1b;
            }
            .statement-item.correct { background-color: #ecfdf5; border-color: #10b981; }
            .statement-item.incorrect { background-color: #fef2f2; border-color: #ef4444; }
            .prose { max-width: 100%; }
            .prose h1, .prose h2, .prose h3 { font-weight: 600; }
            .prose p { margin-top: 0.5em; margin-bottom: 0.5em; }
            .prose ul, .prose ol { margin-top: 1em; margin-bottom: 1em; padding-left: 1.5em; }
            .prose li > p { margin-top: 0; margin-bottom: 0; }
            .prose code { background-color: #e5e7eb; padding: 0.2em 0.4em; margin: 0; font-size: 85%; border-radius: 3px; }
            .prose pre { background-color: #e5e7eb; padding: 1em; border-radius: 0.5em; overflow-x: auto; }
            .prose pre code { background-color: transparent; padding: 0; }
            details[open] > summary .details-arrow {
                transform: rotate(180deg);
            }
        </style>
    </head>
    <body class="bg-slate-100 text-slate-800">
        <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md transform transition-all" style="animation: fadeIn 0.3s ease-out;">
                <h2 class="text-2xl font-bold mb-2 text-center text-slate-800">Thông Tin Học Sinh</h2>
                <p class="text-center text-slate-500 mb-6">Vui lòng nhập để bắt đầu làm bài.</p>
                <form id="student-info-form">
                    <div class="mb-4">
                        <label for="student-name" class="block text-sm font-medium text-slate-700 mb-1">Họ và tên</label>
                        <input type="text" id="student-name" required class="mt-1 block w-full block border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="student-class" class="block text-sm font-medium text-slate-700 mb-1">Lớp</label>
                        <input type="text" id="student-class" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="exam-code" class="block text-sm font-medium text-slate-700 mb-1">Mã đề</label>
                        <input type="text" id="exam-code" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Nhập mã đề giáo viên cung cấp">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Giáo viên:</label>
                        <p class="mt-1 text-slate-800 bg-slate-100 p-2.5 rounded-lg">Võ Thị Mỹ Trang</p>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">Bắt đầu làm bài</button>
                </form>
            </div>
        </div>
        <div class="container mx-auto p-4 md:p-8 max-w-4xl">
            <header class="mb-10 p-8 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg">
                <div class="flex justify-between items-center flex-wrap gap-4">
                    <div>
                        <h1 class="text-4xl font-bold">MID-TERM TEST</h1>
                        <p class="text-lg text-blue-100 mt-2">Hãy hoàn thành các câu hỏi dưới đây một cách tốt nhất!</p>
                        <p class="text-sm text-blue-200 mt-4">Tác giả: Võ Thị Mỹ Trang</p>
                    </div>
                    <div id="timer-container" class="text-right">
                         <div id="timer-display" class="text-3xl font-bold tracking-wider bg-white/20 px-4 py-2 rounded-lg">--:--</div>
                         <div id="retries-display" class="text-sm mt-1 text-blue-200"></div>
                    </div>
                </div>
            </header>
            <main id="student-quiz-container" class="space-y-8 hidden">
                <!-- Questions will be rendered here by JS -->
            </main>
            <footer class="mt-10 text-center">
                <button id="submit-quiz-btn" class="bg-indigo-600 text-white py-3 px-12 rounded-full font-bold text-lg hover:bg-indigo-700 transition-all duration-300 shadow-lg hover:shadow-xl hidden transform hover:scale-105">Nộp Bài</button>
                <div id="result-container" class="mt-6 hidden"></div>
                <div id="ai-feedback-container" class="mt-8 text-left hidden"></div>
                <div id="post-submit-options" class="hidden mt-6 flex flex-col sm:flex-row items-center justify-center gap-4">
                    <button id="retry-quiz-btn" class="w-full sm:w-auto bg-slate-600 text-white py-2.5 px-6 rounded-lg font-semibold hover:bg-slate-700 transition-transform transform hover:scale-105">Làm Lại Đề Này</button>
                </div>
            </footer>
        </div>

        <div id="proctoring-widget" class="fixed bottom-4 right-4 bg-yellow-100 text-yellow-800 p-3 rounded-lg shadow-lg text-sm z-50 hidden border border-yellow-300" style="max-width: 200px;">
            <h4 class="font-bold mb-2 border-b border-yellow-300 pb-1 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 3.001-1.742 3.001H4.42c-1.53 0-2.493-1.667-1.743-3.001l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                Giám sát
            </h4>
            <p>Thoát màn hình: <span id="tab-switch-count" class="font-bold">0</span></p>
            <p>Sao chép: <span id="copy-count" class="font-bold">0</span></p>
            <p>Dán: <span id="paste-count" class="font-bold">0</span></p>
        </div>

        <script type="module">
            import { GoogleGenAI, Type } from "https://esm.sh/@google/genai@^1.13.0";
            let quizData = [{"type":"cloze-test","question":"Welcome to 'Active Life' Sports Center! Before our major renovation last year, we _______ a leading fitness destination for over two decades.","questionImage":null,"mappedType":"multiple-choice","options":["is","has been","had been","was"],"optionsImage":[],"correctAnswerIndex":2},{"type":"cloze-test","question":"We believe that a healthy lifestyle _______ everyone, and we are committed to helping you achieve your fitness goals.","questionImage":null,"mappedType":"multiple-choice","options":["suit","suits","is suiting","suited"],"optionsImage":[],"correctAnswerIndex":1},{"type":"cloze-test","question":"Last year, we significantly _______ our facilities, adding a new swimming pool and advanced gym equipment.","questionImage":null,"mappedType":"multiple-choice","options":["upgrade","upgraded","have upgraded","upgrading"],"optionsImage":[],"correctAnswerIndex":1},{"type":"cloze-test","question":"Many members told us they _______ a more comprehensive space for their workouts.","questionImage":null,"mappedType":"multiple-choice","options":["want","wanted","had wanted","were wanting"],"optionsImage":[],"correctAnswerIndex":2},{"type":"cloze-test","question":"Currently, our team of certified trainers _______ personalized coaching programs to suit all levels.","questionImage":null,"mappedType":"multiple-choice","options":["develop","develops","is developing","developed"],"optionsImage":[],"correctAnswerIndex":2},{"type":"cloze-test","question":"If you _______ ready to transform your health, join 'Active Life' today and start your journey towards a stronger, healthier you!","questionImage":null,"mappedType":"multiple-choice","options":["are","were","have been","will be"],"optionsImage":[],"correctAnswerIndex":0},{"type":"cloze-test","question":"Urbanisation is a global phenomenon with both positive and negative consequences. On the one hand, cities offer numerous ______, such as better job opportunities, improved infrastructure, and access to advanced healthcare and education.","questionImage":null,"mappedType":"multiple-choice","options":["opportunities","disadvantages","challenges","drawbacks"],"optionsImage":[],"correctAnswerIndex":0},{"type":"cloze-test","question":"The ______ developed a city becomes, the more diverse its cultural landscape and job market.","questionImage":null,"mappedType":"multiple-choice","options":["more","less","most","better"],"optionsImage":[],"correctAnswerIndex":0},{"type":"cloze-test","question":"However, rapid urbanisation also poses significant challenges. It often leads to increased ______, traffic congestion, and a higher demand for limited resources.","questionImage":null,"mappedType":"multiple-choice","options":["facilities","green spaces","overcrowding","employment"],"optionsImage":[],"correctAnswerIndex":2},{"type":"cloze-test","question":"______ do pollution levels rise, but also the strain on public services intensifies in rapidly growing urban areas.","questionImage":null,"mappedType":"multiple-choice","options":["Never","Rarely","Not only","Hardly"],"optionsImage":[],"correctAnswerIndex":2},{"type":"cloze-test","question":"______ have authorities fully realised the urgent need for sustainable urban planning until the environmental and social consequences became apparent.","questionImage":null,"mappedType":"multiple-choice","options":["So","Never before","Only","Such"],"optionsImage":[],"correctAnswerIndex":1},{"type":"cloze-test","question":"______ are the social issues in some mega-cities that they sometimes become unmanageable, requiring innovative solutions.","questionImage":null,"mappedType":"multiple-choice","options":["Not only","Never","So great","Hardly ever"],"optionsImage":[],"correctAnswerIndex":2},{"type":"mc-reading","question":"The Green Movement, also known as the environmental movement, is a broad philosophical and social movement that advocates for the protection of the environment, sustainable management of natural resources, and the preservation of global ecosystems. Its roots can be traced back to the late 19th and early 20th centuries, but it gained significant momentum in the 1960s with growing public awareness of pollution and the depletion of natural resources.A core principle of the green movement is sustainability, which means meeting the needs of the present without compromising the ability of future generations to meet their own needs. This involves promoting renewable energy sources like solar and wind power, reducing waste through recycling and composting, conserving water, and supporting eco-friendly products and practices. Many individuals and organizations participate by advocating for policy changes, educating the public, and adopting greener lifestyles.The movement addresses various critical issues, including climate change, deforestation, plastic pollution, and biodiversity loss. Climate change, driven by human activities such as the burning of fossil fuels, leads to rising sea levels and extreme weather events. Deforestation, often for agriculture or logging, destroys habitats and contributes to carbon emissions. Plastic pollution harms marine life and contaminates ecosystems, while biodiversity loss threatens the stability of natural systems.Despite its global reach, the green movement faces challenges. Political resistance, economic interests, and a lack of public engagement in some areas can hinder progress. However, its influence continues to grow, inspiring innovation in green technology and fostering a greater sense of environmental responsibility worldwide. Ultimately, the success of the green movement depends on collective action and a shared commitment to a healthier planet.Source: Adapted from various environmental science and sustainability resources.What is another name for the Green Movement according to the passage?","questionImage":null,"mappedType":"multiple-choice","options":["The sustainability movement","The conservation movement","The environmental movement","The global warming movement"],"optionsImage":[],"correctAnswerIndex":2},{"type":"mc-reading","question":"The Green Movement, also known as the environmental movement, is a broad philosophical and social movement that advocates for the protection of the environment, sustainable management of natural resources, and the preservation of global ecosystems. Its roots can be traced back to the late 19th and early 20th centuries, but it gained significant momentum in the 1960s with growing public awareness of pollution and the depletion of natural resources.A core principle of the green movement is sustainability, which means meeting the needs of the present without compromising the ability of future generations to meet their own needs. This involves promoting renewable energy sources like solar and wind power, reducing waste through recycling and composting, conserving water, and supporting eco-friendly products and practices. Many individuals and organizations participate by advocating for policy changes, educating the public, and adopting greener lifestyles.The movement addresses various critical issues, including climate change, deforestation, plastic pollution, and biodiversity loss. Climate change, driven by human activities such as the burning of fossil fuels, leads to rising sea levels and extreme weather events. Deforestation, often for agriculture or logging, destroys habitats and contributes to carbon emissions. Plastic pollution harms marine life and contaminates ecosystems, while biodiversity loss threatens the stability of natural systems.Despite its global reach, the green movement faces challenges. Political resistance, economic interests, and a lack of public engagement in some areas can hinder progress. However, its influence continues to grow, inspiring innovation in green technology and fostering a greater sense of environmental responsibility worldwide. Ultimately, the success of the green movement depends on collective action and a shared commitment to a healthier planet.Source: Adapted from various environmental science and sustainability resources.When did the Green Movement gain significant momentum?","questionImage":null,"mappedType":"multiple-choice","options":["In the late 19th century","In the early 20th century","In the 1960s","After the year $2000$"],"optionsImage":[],"correctAnswerIndex":2},{"type":"mc-reading","question":"The Green Movement, also known as the environmental movement, is a broad philosophical and social movement that advocates for the protection of the environment, sustainable management of natural resources, and the preservation of global ecosystems. Its roots can be traced back to the late 19th and early 20th centuries, but it gained significant momentum in the 1960s with growing public awareness of pollution and the depletion of natural resources.A core principle of the green movement is sustainability, which means meeting the needs of the present without compromising the ability of future generations to meet their own needs. This involves promoting renewable energy sources like solar and wind power, reducing waste through recycling and composting, conserving water, and supporting eco-friendly products and practices. Many individuals and organizations participate by advocating for policy changes, educating the public, and adopting greener lifestyles.The movement addresses various critical issues, including climate change, deforestation, plastic pollution, and biodiversity loss. Climate change, driven by human activities such as the burning of fossil fuels, leads to rising sea levels and extreme weather events. Deforestation, often for agriculture or logging, destroys habitats and contributes to carbon emissions. Plastic pollution harms marine life and contaminates ecosystems, while biodiversity loss threatens the stability of natural systems.Despite its global reach, the green movement faces challenges. Political resistance, economic interests, and a lack of public engagement in some areas can hinder progress. However, its influence continues to grow, inspiring innovation in green technology and fostering a greater sense of environmental responsibility worldwide. Ultimately, the success of the green movement depends on collective action and a shared commitment to a healthier planet.Source: Adapted from various environmental science and sustainability resources.What is a core principle of the green movement mentioned in the text?","questionImage":null,"mappedType":"multiple-choice","options":["Economic growth","Industrial development","Sustainability","Technological advancement"],"optionsImage":[],"correctAnswerIndex":2},{"type":"mc-reading","question":"The Green Movement, also known as the environmental movement, is a broad philosophical and social movement that advocates for the protection of the environment, sustainable management of natural resources, and the preservation of global ecosystems. Its roots can be traced back to the late 19th and early 20th centuries, but it gained significant momentum in the 1960s with growing public awareness of pollution and the depletion of natural resources.A core principle of the green movement is sustainability, which means meeting the needs of the present without compromising the ability of future generations to meet their own needs. This involves promoting renewable energy sources like solar and wind power, reducing waste through recycling and composting, conserving water, and supporting eco-friendly products and practices. Many individuals and organizations participate by advocating for policy changes, educating the public, and adopting greener lifestyles.The movement addresses various critical issues, including climate change, deforestation, plastic pollution, and biodiversity loss. Climate change, driven by human activities such as the burning of fossil fuels, leads to rising sea levels and extreme weather events. Deforestation, often for agriculture or logging, destroys habitats and contributes to carbon emissions. Plastic pollution harms marine life and contaminates ecosystems, while biodiversity loss threatens the stability of natural systems.Despite its global reach, the green movement faces challenges. Political resistance, economic interests, and a lack of public engagement in some areas can hinder progress. However, its influence continues to grow, inspiring innovation in green technology and fostering a greater sense of environmental responsibility worldwide. Ultimately, the success of the green movement depends on collective action and a shared commitment to a healthier planet.Source: Adapted from various environmental science and sustainability resources.Which of the following is NOT listed as a practice promoted by sustainability?","questionImage":null,"mappedType":"multiple-choice","options":["Promoting renewable energy","Reducing waste","Conserving water","Increasing fossil fuel consumption"],"optionsImage":[],"correctAnswerIndex":3},{"type":"mc-reading","question":"The Green Movement, also known as the environmental movement, is a broad philosophical and social movement that advocates for the protection of the environment, sustainable management of natural resources, and the preservation of global ecosystems. Its roots can be traced back to the late 19th and early 20th centuries, but it gained significant momentum in the 1960s with growing public awareness of pollution and the depletion of natural resources.A core principle of the green movement is sustainability, which means meeting the needs of the present without compromising the ability of future generations to meet their own needs. This involves promoting renewable energy sources like solar and wind power, reducing waste through recycling and composting, conserving water, and supporting eco-friendly products and practices. Many individuals and organizations participate by advocating for policy changes, educating the public, and adopting greener lifestyles.The movement addresses various critical issues, including climate change, deforestation, plastic pollution, and biodiversity loss. Climate change, driven by human activities such as the burning of fossil fuels, leads to rising sea levels and extreme weather events. Deforestation, often for agriculture or logging, destroys habitats and contributes to carbon emissions. Plastic pollution harms marine life and contaminates ecosystems, while biodiversity loss threatens the stability of natural systems.Despite its global reach, the green movement faces challenges. Political resistance, economic interests, and a lack of public engagement in some areas can hinder progress. However, its influence continues to grow, inspiring innovation in green technology and fostering a greater sense of environmental responsibility worldwide. Ultimately, the success of the green movement depends on collective action and a shared commitment to a healthier planet.Source: Adapted from various environmental science and sustainability resources.What drives climate change, according to the passage?","questionImage":null,"mappedType":"multiple-choice","options":["Natural phenomena","Volcanic eruptions","Human activities such as burning fossil fuels","Solar flares"],"optionsImage":[],"correctAnswerIndex":2},{"type":"mc-reading","question":"The Green Movement, also known as the environmental movement, is a broad philosophical and social movement that advocates for the protection of the environment, sustainable management of natural resources, and the preservation of global ecosystems. Its roots can be traced back to the late 19th and early 20th centuries, but it gained significant momentum in the 1960s with growing public awareness of pollution and the depletion of natural resources.A core principle of the green movement is sustainability, which means meeting the needs of the present without compromising the ability of future generations to meet their own needs. This involves promoting renewable energy sources like solar and wind power, reducing waste through recycling and composting, conserving water, and supporting eco-friendly products and practices. Many individuals and organizations participate by advocating for policy changes, educating the public, and adopting greener lifestyles.The movement addresses various critical issues, including climate change, deforestation, plastic pollution, and biodiversity loss. Climate change, driven by human activities such as the burning of fossil fuels, leads to rising sea levels and extreme weather events. Deforestation, often for agriculture or logging, destroys habitats and contributes to carbon emissions. Plastic pollution harms marine life and contaminates ecosystems, while biodiversity loss threatens the stability of natural systems.Despite its global reach, the green movement faces challenges. Political resistance, economic interests, and a lack of public engagement in some areas can hinder progress. However, its influence continues to grow, inspiring innovation in green technology and fostering a greater sense of environmental responsibility worldwide. Ultimately, the success of the green movement depends on collective action and a shared commitment to a healthier planet.Source: Adapted from various environmental science and sustainability resources.What is one consequence of deforestation mentioned in the text?","questionImage":null,"mappedType":"multiple-choice","options":["Increased biodiversity","Habitat destruction","Reduced carbon emissions","Improved air quality"],"optionsImage":[],"correctAnswerIndex":1},{"type":"mc-reading","question":"The Green Movement, also known as the environmental movement, is a broad philosophical and social movement that advocates for the protection of the environment, sustainable management of natural resources, and the preservation of global ecosystems. Its roots can be traced back to the late 19th and early 20th centuries, but it gained significant momentum in the 1960s with growing public awareness of pollution and the depletion of natural resources.A core principle of the green movement is sustainability, which means meeting the needs of the present without compromising the ability of future generations to meet their own needs. This involves promoting renewable energy sources like solar and wind power, reducing waste through recycling and composting, conserving water, and supporting eco-friendly products and practices. Many individuals and organizations participate by advocating for policy changes, educating the public, and adopting greener lifestyles.The movement addresses various critical issues, including climate change, deforestation, plastic pollution, and biodiversity loss. Climate change, driven by human activities such as the burning of fossil fuels, leads to rising sea levels and extreme weather events. Deforestation, often for agriculture or logging, destroys habitats and contributes to carbon emissions. Plastic pollution harms marine life and contaminates ecosystems, while biodiversity loss threatens the stability of natural systems.Despite its global reach, the green movement faces challenges. Political resistance, economic interests, and a lack of public engagement in some areas can hinder progress. However, its influence continues to grow, inspiring innovation in green technology and fostering a greater sense of environmental responsibility worldwide. Ultimately, the success of the green movement depends on collective action and a shared commitment to a healthier planet.Source: Adapted from various environmental science and sustainability resources.What is one challenge the green movement faces?","questionImage":null,"mappedType":"multiple-choice","options":["Too much public engagement","Strong political support","Economic interests","Rapid technological advancement"],"optionsImage":[],"correctAnswerIndex":2},{"type":"mc-reading","question":"The Green Movement, also known as the environmental movement, is a broad philosophical and social movement that advocates for the protection of the environment, sustainable management of natural resources, and the preservation of global ecosystems. Its roots can be traced back to the late 19th and early 20th centuries, but it gained significant momentum in the 1960s with growing public awareness of pollution and the depletion of natural resources.A core principle of the green movement is sustainability, which means meeting the needs of the present without compromising the ability of future generations to meet their own needs. This involves promoting renewable energy sources like solar and wind power, reducing waste through recycling and composting, conserving water, and supporting eco-friendly products and practices. Many individuals and organizations participate by advocating for policy changes, educating the public, and adopting greener lifestyles.The movement addresses various critical issues, including climate change, deforestation, plastic pollution, and biodiversity loss. Climate change, driven by human activities such as the burning of fossil fuels, leads to rising sea levels and extreme weather events. Deforestation, often for agriculture or logging, destroys habitats and contributes to carbon emissions. Plastic pollution harms marine life and contaminates ecosystems, while biodiversity loss threatens the stability of natural systems.Despite its global reach, the green movement faces challenges. Political resistance, economic interests, and a lack of public engagement in some areas can hinder progress. However, its influence continues to grow, inspiring innovation in green technology and fostering a greater sense of environmental responsibility worldwide. Ultimately, the success of the green movement depends on collective action and a shared commitment to a healthier planet.Source: Adapted from various environmental science and sustainability resources.What does the success of the green movement ultimately depend on?","questionImage":null,"mappedType":"multiple-choice","options":["Government policies only","Individual efforts alone","Collective action and shared commitment","Technological solutions exclusively"],"optionsImage":[],"correctAnswerIndex":2},{"type":"mc-reading","question":"Urbanisation, the shift of populations from rural to urban areas, is a defining trend of the 21st century. This phenomenon is driven by various factors, primarily the allure of economic opportunities and improved quality of life in cities. Cities often serve as hubs for innovation, industry, and commerce, attracting individuals seeking better employment prospects and higher wages. Furthermore, urban centers typically offer superior access to education, healthcare, and advanced infrastructure such as public transportation networks and communication technologies. The vibrant cultural scene, diverse entertainment options, and opportunities for social interaction also contribute to the appeal of urban living.However, rapid urbanisation is not without its significant drawbacks. One major challenge is the strain on existing infrastructure. As more people move into cities, demand for housing, water, electricity, and waste management systems often outstrips supply, leading to shortages and overburdened services. Traffic congestion becomes a prevalent issue, exacerbating air pollution and prolonging commute times. Moreover, the influx of people can lead to increased competition for jobs, potentially creating unemployment among less skilled workers and widening the gap between the rich and the poor. Affordable housing becomes scarce, forcing many to live in informal settlements or overcrowded conditions, which can lead to sanitation problems and public health crises.Environmental degradation is another serious concern associated with urbanisation. The expansion of urban areas often comes at the expense of natural habitats, leading to deforestation and loss of biodiversity. Increased industrial activity and vehicle emissions contribute significantly to air and water pollution, negatively impacting both human health and ecosystems. Waste management poses a colossal challenge, with cities generating vast amounts of refuse that require proper disposal. Effective urban planning and sustainable development strategies are crucial to mitigating these negative impacts.In conclusion, while urbanisation presents numerous opportunities for economic growth and societal advancement, it also brings a complex array of environmental, social, and infrastructural challenges. The key lies in balancing growth with sustainability, ensuring that urban development is inclusive, equitable, and environmentally responsible. The faster cities grow, the more urgent it becomes to address these issues holistically.What is the main idea of the passage?","questionImage":null,"mappedType":"multiple-choice","options":["Urbanisation is a global problem that needs to be stopped.","Urbanisation offers both significant benefits and considerable challenges.","Cities are ideal places for economic development and cultural exchange.","Environmental problems are the most serious consequence of urbanisation."],"optionsImage":[],"correctAnswerIndex":1},{"type":"mc-reading","question":"Urbanisation, the shift of populations from rural to urban areas, is a defining trend of the 21st century. This phenomenon is driven by various factors, primarily the allure of economic opportunities and improved quality of life in cities. Cities often serve as hubs for innovation, industry, and commerce, attracting individuals seeking better employment prospects and higher wages. Furthermore, urban centers typically offer superior access to education, healthcare, and advanced infrastructure such as public transportation networks and communication technologies. The vibrant cultural scene, diverse entertainment options, and opportunities for social interaction also contribute to the appeal of urban living.However, rapid urbanisation is not without its significant drawbacks. One major challenge is the strain on existing infrastructure. As more people move into cities, demand for housing, water, electricity, and waste management systems often outstrips supply, leading to shortages and overburdened services. Traffic congestion becomes a prevalent issue, exacerbating air pollution and prolonging commute times. Moreover, the influx of people can lead to increased competition for jobs, potentially creating unemployment among less skilled workers and widening the gap between the rich and the poor. Affordable housing becomes scarce, forcing many to live in informal settlements or overcrowded conditions, which can lead to sanitation problems and public health crises.Environmental degradation is another serious concern associated with urbanisation. The expansion of urban areas often comes at the expense of natural habitats, leading to deforestation and loss of biodiversity. Increased industrial activity and vehicle emissions contribute significantly to air and water pollution, negatively impacting both human health and ecosystems. Waste management poses a colossal challenge, with cities generating vast amounts of refuse that require proper disposal. Effective urban planning and sustainable development strategies are crucial to mitigating these negative impacts.In conclusion, while urbanisation presents numerous opportunities for economic growth and societal advancement, it also brings a complex array of environmental, social, and infrastructural challenges. The key lies in balancing growth with sustainability, ensuring that urban development is inclusive, equitable, and environmentally responsible. The faster cities grow, the more urgent it becomes to address these issues holistically.According to the first paragraph, which of the following is NOT mentioned as a benefit of urbanisation?","questionImage":null,"mappedType":"multiple-choice","options":["Higher wages.","Better public transportation.","Reduced cost of living.","Diverse entertainment options."],"optionsImage":[],"correctAnswerIndex":2},{"type":"mc-reading","question":"Urbanisation, the shift of populations from rural to urban areas, is a defining trend of the 21st century. This phenomenon is driven by various factors, primarily the allure of economic opportunities and improved quality of life in cities. Cities often serve as hubs for innovation, industry, and commerce, attracting individuals seeking better employment prospects and higher wages. Furthermore, urban centers typically offer superior access to education, healthcare, and advanced infrastructure such as public transportation networks and communication technologies. The vibrant cultural scene, diverse entertainment options, and opportunities for social interaction also contribute to the appeal of urban living.However, rapid urbanisation is not without its significant drawbacks. One major challenge is the strain on existing infrastructure. As more people move into cities, demand for housing, water, electricity, and waste management systems often outstrips supply, leading to shortages and overburdened services. Traffic congestion becomes a prevalent issue, exacerbating air pollution and prolonging commute times. Moreover, the influx of people can lead to increased competition for jobs, potentially creating unemployment among less skilled workers and widening the gap between the rich and the poor. Affordable housing becomes scarce, forcing many to live in informal settlements or overcrowded conditions, which can lead to sanitation problems and public health crises.Environmental degradation is another serious concern associated with urbanisation. The expansion of urban areas often comes at the expense of natural habitats, leading to deforestation and loss of biodiversity. Increased industrial activity and vehicle emissions contribute significantly to air and water pollution, negatively impacting both human health and ecosystems. Waste management poses a colossal challenge, with cities generating vast amounts of refuse that require proper disposal. Effective urban planning and sustainable development strategies are crucial to mitigating these negative impacts.In conclusion, while urbanisation presents numerous opportunities for economic growth and societal advancement, it also brings a complex array of environmental, social, and infrastructural challenges. The key lies in balancing growth with sustainability, ensuring that urban development is inclusive, equitable, and environmentally responsible. The faster cities grow, the more urgent it becomes to address these issues holistically.Which of the following is identified as a major infrastructural challenge due to rapid urbanisation?","questionImage":null,"mappedType":"multiple-choice","options":["Decrease in cultural diversity.","Increased demand for housing and public services.","Decline in educational opportunities.","Reduced social interaction."],"optionsImage":[],"correctAnswerIndex":1},{"type":"mc-reading","question":"Urbanisation, the shift of populations from rural to urban areas, is a defining trend of the 21st century. This phenomenon is driven by various factors, primarily the allure of economic opportunities and improved quality of life in cities. Cities often serve as hubs for innovation, industry, and commerce, attracting individuals seeking better employment prospects and higher wages. Furthermore, urban centers typically offer superior access to education, healthcare, and advanced infrastructure such as public transportation networks and communication technologies. The vibrant cultural scene, diverse entertainment options, and opportunities for social interaction also contribute to the appeal of urban living.However, rapid urbanisation is not without its significant drawbacks. One major challenge is the strain on existing infrastructure. As more people move into cities, demand for housing, water, electricity, and waste management systems often outstrips supply, leading to shortages and overburdened services. Traffic congestion becomes a prevalent issue, exacerbating air pollution and prolonging commute times. Moreover, the influx of people can lead to increased competition for jobs, potentially creating unemployment among less skilled workers and widening the gap between the rich and the poor. Affordable housing becomes scarce, forcing many to live in informal settlements or overcrowded conditions, which can lead to sanitation problems and public health crises.Environmental degradation is another serious concern associated with urbanisation. The expansion of urban areas often comes at the expense of natural habitats, leading to deforestation and loss of biodiversity. Increased industrial activity and vehicle emissions contribute significantly to air and water pollution, negatively impacting both human health and ecosystems. Waste management poses a colossal challenge, with cities generating vast amounts of refuse that require proper disposal. Effective urban planning and sustainable development strategies are crucial to mitigating these negative impacts.In conclusion, while urbanisation presents numerous opportunities for economic growth and societal advancement, it also brings a complex array of environmental, social, and infrastructural challenges. The key lies in balancing growth with sustainability, ensuring that urban development is inclusive, equitable, and environmentally responsible. The faster cities grow, the more urgent it becomes to address these issues holistically.The word \"exacerbating\" in paragraph 2 is closest in meaning to _______.","questionImage":null,"mappedType":"multiple-choice","options":["alleviating","lessening","worsening","improving"],"optionsImage":[],"correctAnswerIndex":2},{"type":"mc-reading","question":"Urbanisation, the shift of populations from rural to urban areas, is a defining trend of the 21st century. This phenomenon is driven by various factors, primarily the allure of economic opportunities and improved quality of life in cities. Cities often serve as hubs for innovation, industry, and commerce, attracting individuals seeking better employment prospects and higher wages. Furthermore, urban centers typically offer superior access to education, healthcare, and advanced infrastructure such as public transportation networks and communication technologies. The vibrant cultural scene, diverse entertainment options, and opportunities for social interaction also contribute to the appeal of urban living.However, rapid urbanisation is not without its significant drawbacks. One major challenge is the strain on existing infrastructure. As more people move into cities, demand for housing, water, electricity, and waste management systems often outstrips supply, leading to shortages and overburdened services. Traffic congestion becomes a prevalent issue, exacerbating air pollution and prolonging commute times. Moreover, the influx of people can lead to increased competition for jobs, potentially creating unemployment among less skilled workers and widening the gap between the rich and the poor. Affordable housing becomes scarce, forcing many to live in informal settlements or overcrowded conditions, which can lead to sanitation problems and public health crises.Environmental degradation is another serious concern associated with urbanisation. The expansion of urban areas often comes at the expense of natural habitats, leading to deforestation and loss of biodiversity. Increased industrial activity and vehicle emissions contribute significantly to air and water pollution, negatively impacting both human health and ecosystems. Waste management poses a colossal challenge, with cities generating vast amounts of refuse that require proper disposal. Effective urban planning and sustainable development strategies are crucial to mitigating these negative impacts.In conclusion, while urbanisation presents numerous opportunities for economic growth and societal advancement, it also brings a complex array of environmental, social, and infrastructural challenges. The key lies in balancing growth with sustainability, ensuring that urban development is inclusive, equitable, and environmentally responsible. The faster cities grow, the more urgent it becomes to address these issues holistically.The word \"colossal\" in paragraph 3 is opposite in meaning to _______.","questionImage":null,"mappedType":"multiple-choice","options":["gigantic","immense","tiny","enormous"],"optionsImage":[],"correctAnswerIndex":2},{"type":"mc-reading","question":"Urbanisation, the shift of populations from rural to urban areas, is a defining trend of the 21st century. This phenomenon is driven by various factors, primarily the allure of economic opportunities and improved quality of life in cities. Cities often serve as hubs for innovation, industry, and commerce, attracting individuals seeking better employment prospects and higher wages. Furthermore, urban centers typically offer superior access to education, healthcare, and advanced infrastructure such as public transportation networks and communication technologies. The vibrant cultural scene, diverse entertainment options, and opportunities for social interaction also contribute to the appeal of urban living.However, rapid urbanisation is not without its significant drawbacks. One major challenge is the strain on existing infrastructure. As more people move into cities, demand for housing, water, electricity, and waste management systems often outstrips supply, leading to shortages and overburdened services. Traffic congestion becomes a prevalent issue, exacerbating air pollution and prolonging commute times. Moreover, the influx of people can lead to increased competition for jobs, potentially creating unemployment among less skilled workers and widening the gap between the rich and the poor. Affordable housing becomes scarce, forcing many to live in informal settlements or overcrowded conditions, which can lead to sanitation problems and public health crises.Environmental degradation is another serious concern associated with urbanisation. The expansion of urban areas often comes at the expense of natural habitats, leading to deforestation and loss of biodiversity. Increased industrial activity and vehicle emissions contribute significantly to air and water pollution, negatively impacting both human health and ecosystems. Waste management poses a colossal challenge, with cities generating vast amounts of refuse that require proper disposal. Effective urban planning and sustainable development strategies are crucial to mitigating these negative impacts.In conclusion, while urbanisation presents numerous opportunities for economic growth and societal advancement, it also brings a complex array of environmental, social, and infrastructural challenges. The key lies in balancing growth with sustainability, ensuring that urban development is inclusive, equitable, and environmentally responsible. The faster cities grow, the more urgent it becomes to address these issues holistically.It can be inferred from the passage that effective urban planning aims to _______.","questionImage":null,"mappedType":"multiple-choice","options":["stop people from moving to cities entirely.","prioritize economic growth over environmental protection.","balance urban development with sustainability.","encourage the growth of informal settlements."],"optionsImage":[],"correctAnswerIndex":2},{"type":"mc-reading","question":"Urbanisation, the shift of populations from rural to urban areas, is a defining trend of the 21st century. This phenomenon is driven by various factors, primarily the allure of economic opportunities and improved quality of life in cities. Cities often serve as hubs for innovation, industry, and commerce, attracting individuals seeking better employment prospects and higher wages. Furthermore, urban centers typically offer superior access to education, healthcare, and advanced infrastructure such as public transportation networks and communication technologies. The vibrant cultural scene, diverse entertainment options, and opportunities for social interaction also contribute to the appeal of urban living.However, rapid urbanisation is not without its significant drawbacks. One major challenge is the strain on existing infrastructure. As more people move into cities, demand for housing, water, electricity, and waste management systems often outstrips supply, leading to shortages and overburdened services. Traffic congestion becomes a prevalent issue, exacerbating air pollution and prolonging commute times. Moreover, the influx of people can lead to increased competition for jobs, potentially creating unemployment among less skilled workers and widening the gap between the rich and the poor. Affordable housing becomes scarce, forcing many to live in informal settlements or overcrowded conditions, which can lead to sanitation problems and public health crises.Environmental degradation is another serious concern associated with urbanisation. The expansion of urban areas often comes at the expense of natural habitats, leading to deforestation and loss of biodiversity. Increased industrial activity and vehicle emissions contribute significantly to air and water pollution, negatively impacting both human health and ecosystems. Waste management poses a colossal challenge, with cities generating vast amounts of refuse that require proper disposal. Effective urban planning and sustainable development strategies are crucial to mitigating these negative impacts.In conclusion, while urbanisation presents numerous opportunities for economic growth and societal advancement, it also brings a complex array of environmental, social, and infrastructural challenges. The key lies in balancing growth with sustainability, ensuring that urban development is inclusive, equitable, and environmentally responsible. The faster cities grow, the more urgent it becomes to address these issues holistically.The following sentence can be added to the passage: \"This pressure often results in overconsumption of resources and insufficient green spaces.\" Where would it best fit?","questionImage":null,"mappedType":"multiple-choice","options":["At the end of paragraph 1.","After the first sentence of paragraph 2.","After the second sentence of paragraph 3.","At the beginning of paragraph 4."],"optionsImage":[],"correctAnswerIndex":2},{"type":"mc-reading","question":"Urbanisation, the shift of populations from rural to urban areas, is a defining trend of the 21st century. This phenomenon is driven by various factors, primarily the allure of economic opportunities and improved quality of life in cities. Cities often serve as hubs for innovation, industry, and commerce, attracting individuals seeking better employment prospects and higher wages. Furthermore, urban centers typically offer superior access to education, healthcare, and advanced infrastructure such as public transportation networks and communication technologies. The vibrant cultural scene, diverse entertainment options, and opportunities for social interaction also contribute to the appeal of urban living.However, rapid urbanisation is not without its significant drawbacks. One major challenge is the strain on existing infrastructure. As more people move into cities, demand for housing, water, electricity, and waste management systems often outstrips supply, leading to shortages and overburdened services. Traffic congestion becomes a prevalent issue, exacerbating air pollution and prolonging commute times. Moreover, the influx of people can lead to increased competition for jobs, potentially creating unemployment among less skilled workers and widening the gap between the rich and the poor. Affordable housing becomes scarce, forcing many to live in informal settlements or overcrowded conditions, which can lead to sanitation problems and public health crises.Environmental degradation is another serious concern associated with urbanisation. The expansion of urban areas often comes at the expense of natural habitats, leading to deforestation and loss of biodiversity. Increased industrial activity and vehicle emissions contribute significantly to air and water pollution, negatively impacting both human health and ecosystems. Waste management poses a colossal challenge, with cities generating vast amounts of refuse that require proper disposal. Effective urban planning and sustainable development strategies are crucial to mitigating these negative impacts.In conclusion, while urbanisation presents numerous opportunities for economic growth and societal advancement, it also brings a complex array of environmental, social, and infrastructural challenges. The key lies in balancing growth with sustainability, ensuring that urban development is inclusive, equitable, and environmentally responsible. The faster cities grow, the more urgent it becomes to address these issues holistically.Which of the following statements is TRUE according to the passage?","questionImage":null,"mappedType":"multiple-choice","options":["Urbanisation only brings negative impacts to society.","Cities are the primary drivers of rural population growth.","Unemployment rates always decrease with urbanisation.","Sustainable development is essential for addressing urbanisation challenges."],"optionsImage":[],"correctAnswerIndex":3},{"type":"mc-reading","question":"Urbanisation, the shift of populations from rural to urban areas, is a defining trend of the 21st century. This phenomenon is driven by various factors, primarily the allure of economic opportunities and improved quality of life in cities. Cities often serve as hubs for innovation, industry, and commerce, attracting individuals seeking better employment prospects and higher wages. Furthermore, urban centers typically offer superior access to education, healthcare, and advanced infrastructure such as public transportation networks and communication technologies. The vibrant cultural scene, diverse entertainment options, and opportunities for social interaction also contribute to the appeal of urban living.However, rapid urbanisation is not without its significant drawbacks. One major challenge is the strain on existing infrastructure. As more people move into cities, demand for housing, water, electricity, and waste management systems often outstrips supply, leading to shortages and overburdened services. Traffic congestion becomes a prevalent issue, exacerbating air pollution and prolonging commute times. Moreover, the influx of people can lead to increased competition for jobs, potentially creating unemployment among less skilled workers and widening the gap between the rich and the poor. Affordable housing becomes scarce, forcing many to live in informal settlements or overcrowded conditions, which can lead to sanitation problems and public health crises.Environmental degradation is another serious concern associated with urbanisation. The expansion of urban areas often comes at the expense of natural habitats, leading to deforestation and loss of biodiversity. Increased industrial activity and vehicle emissions contribute significantly to air and water pollution, negatively impacting both human health and ecosystems. Waste management poses a colossal challenge, with cities generating vast amounts of refuse that require proper disposal. Effective urban planning and sustainable development strategies are crucial to mitigating these negative impacts.In conclusion, while urbanisation presents numerous opportunities for economic growth and societal advancement, it also brings a complex array of environmental, social, and infrastructural challenges. The key lies in balancing growth with sustainability, ensuring that urban development is inclusive, equitable, and environmentally responsible. The faster cities grow, the more urgent it becomes to address these issues holistically.According to the passage, what is a primary factor driving urbanisation?","questionImage":null,"mappedType":"multiple-choice","options":["A decline in cultural activities in rural areas.","The promise of better economic opportunities in cities.","Strict environmental regulations in rural regions.","The availability of more affordable housing in urban centers."],"optionsImage":[],"correctAnswerIndex":1},{"type":"mc-reading","question":"Urbanisation, the shift of populations from rural to urban areas, is a defining trend of the 21st century. This phenomenon is driven by various factors, primarily the allure of economic opportunities and improved quality of life in cities. Cities often serve as hubs for innovation, industry, and commerce, attracting individuals seeking better employment prospects and higher wages. Furthermore, urban centers typically offer superior access to education, healthcare, and advanced infrastructure such as public transportation networks and communication technologies. The vibrant cultural scene, diverse entertainment options, and opportunities for social interaction also contribute to the appeal of urban living.However, rapid urbanisation is not without its significant drawbacks. One major challenge is the strain on existing infrastructure. As more people move into cities, demand for housing, water, electricity, and waste management systems often outstrips supply, leading to shortages and overburdened services. Traffic congestion becomes a prevalent issue, exacerbating air pollution and prolonging commute times. Moreover, the influx of people can lead to increased competition for jobs, potentially creating unemployment among less skilled workers and widening the gap between the rich and the poor. Affordable housing becomes scarce, forcing many to live in informal settlements or overcrowded conditions, which can lead to sanitation problems and public health crises.Environmental degradation is another serious concern associated with urbanisation. The expansion of urban areas often comes at the expense of natural habitats, leading to deforestation and loss of biodiversity. Increased industrial activity and vehicle emissions contribute significantly to air and water pollution, negatively impacting both human health and ecosystems. Waste management poses a colossal challenge, with cities generating vast amounts of refuse that require proper disposal. Effective urban planning and sustainable development strategies are crucial to mitigating these negative impacts.In conclusion, while urbanisation presents numerous opportunities for economic growth and societal advancement, it also brings a complex array of environmental, social, and infrastructural challenges. The key lies in balancing growth with sustainability, ensuring that urban development is inclusive, equitable, and environmentally responsible. The faster cities grow, the more urgent it becomes to address these issues holistically.What is the main focus of paragraph 3?","questionImage":null,"mappedType":"multiple-choice","options":["The cultural benefits of city life.","The economic advantages of urban development.","The environmental challenges linked to urbanisation.","Solutions for improving urban infrastructure."],"optionsImage":[],"correctAnswerIndex":2},{"type":"cloze-test","question":"Nelson Mandela, born in 1918, _____ (1) a pivotal figure in the fight against apartheid in South Africa. After he _____ (2) law, he became deeply involved in anti-apartheid activism. He _____ (3) for 27 years due to his political activities. While he _____ (4) in prison, his resolve never wavered, and he became a global symbol of resistance. Upon his release in 1990, he _____ (5) to unify the nation and was elected President in 1994, marking a new era of democracy.Source: *Adapted from NelsonMandela.org*Chọn từ/cụm từ thích hợp nhất để điền vào chỗ trống (1).","questionImage":null,"mappedType":"multiple-choice","options":["is","was","has been","had been"],"optionsImage":[],"correctAnswerIndex":1},{"type":"cloze-test","question":"Nelson Mandela, born in 1918, _____ (1) a pivotal figure in the fight against apartheid in South Africa. After he _____ (2) law, he became deeply involved in anti-apartheid activism. He _____ (3) for 27 years due to his political activities. While he _____ (4) in prison, his resolve never wavered, and he became a global symbol of resistance. Upon his release in 1990, he _____ (5) to unify the nation and was elected President in 1994, marking a new era of democracy.Source: *Adapted from NelsonMandela.org*Chọn từ/cụm từ thích hợp nhất để điền vào chỗ trống (2).","questionImage":null,"mappedType":"multiple-choice","options":["finished","had finished","was finishing","would finish"],"optionsImage":[],"correctAnswerIndex":1},{"type":"cloze-test","question":"Nelson Mandela, born in 1918, _____ (1) a pivotal figure in the fight against apartheid in South Africa. After he _____ (2) law, he became deeply involved in anti-apartheid activism. He _____ (3) for 27 years due to his political activities. While he _____ (4) in prison, his resolve never wavered, and he became a global symbol of resistance. Upon his release in 1990, he _____ (5) to unify the nation and was elected President in 1994, marking a new era of democracy.Source: *Adapted from NelsonMandela.org*Chọn từ/cụm từ thích hợp nhất để điền vào chỗ trống (3).","questionImage":null,"mappedType":"multiple-choice","options":["was imprisoned","had imprisoned","imprisoned","has been imprisoned"],"optionsImage":[],"correctAnswerIndex":0},{"type":"cloze-test","question":"Nelson Mandela, born in 1918, _____ (1) a pivotal figure in the fight against apartheid in South Africa. After he _____ (2) law, he became deeply involved in anti-apartheid activism. He _____ (3) for 27 years due to his political activities. While he _____ (4) in prison, his resolve never wavered, and he became a global symbol of resistance. Upon his release in 1990, he _____ (5) to unify the nation and was elected President in 1994, marking a new era of democracy.Source: *Adapted from NelsonMandela.org*Chọn từ/cụm từ thích hợp nhất để điền vào chỗ trống (4).","questionImage":null,"mappedType":"multiple-choice","options":["was","had been","had been being","has been"],"optionsImage":[],"correctAnswerIndex":0},{"type":"cloze-test","question":"Nelson Mandela, born in 1918, _____ (1) a pivotal figure in the fight against apartheid in South Africa. After he _____ (2) law, he became deeply involved in anti-apartheid activism. He _____ (3) for 27 years due to his political activities. While he _____ (4) in prison, his resolve never wavered, and he became a global symbol of resistance. Upon his release in 1990, he _____ (5) to unify the nation and was elected President in 1994, marking a new era of democracy.Source: *Adapted from NelsonMandela.org*Chọn từ/cụm từ thích hợp nhất để điền vào chỗ trống (5).","questionImage":null,"mappedType":"multiple-choice","options":["worked","had worked","was working","has worked"],"optionsImage":[],"correctAnswerIndex":0},{"type":"sentence-ordering","question":"Arrange the following sentences to form a coherent dialogue about Marie Curie's life:\na. Exactly. Before she even met Pierre, she had already dedicated herself to scientific research, even under difficult circumstances.\nb. Did you hear about Marie Curie's early life? It was quite challenging.\nc. That's right. Her determination was incredible, especially considering the limited opportunities women had back then.\nd. Oh, yes! She was studying and working as a governess at the same time, wasn't she?","questionImage":null,"mappedType":"multiple-choice","options":["b-d-a-c","b-a-d-c","d-b-a-c","a-d-b-c"],"optionsImage":[],"correctAnswerIndex":0},{"type":"sentence-ordering","question":"Arrange the following sentences to form a coherent dialogue:\na. \"It was quite tiring, but seeing the park so clean afterwards made all the effort worthwhile.\"\nb. \"Hey Anna, do you remember the community park clean-up we joined last Saturday?\"\nc. \"Absolutely, Ben! We picked up so much trash that day, didn't we? I remember feeling really proud of what we accomplished.\"\nd. \"Yes, and the local environmental group provided all the tools and even explained how proper waste segregation worked. We learned a lot.\"\ne. \"I think the best part was when the mayor showed up unexpectedly and thanked everyone for their hard work. That really motivated us.\"","questionImage":null,"mappedType":"multiple-choice","options":["b-c-d-a-e","b-d-c-a-e","c-b-d-a-e","b-c-a-d-e"],"optionsImage":[],"correctAnswerIndex":0},{"type":"sentence-ordering","question":"a. Not only does it accelerate economic growth and improve public services, but it also fosters cultural diversity.b. Urbanisation is a global phenomenon bringing both opportunities and challenges.c. Consequently, addressing issues like pollution and traffic congestion is crucial for sustainable urban development.d. However, the more people flock to urban areas, the greater the pressure on infrastructure and environment becomes.","questionImage":null,"mappedType":"multiple-choice","options":["b-a-d-c","b-d-a-c","a-b-d-c","d-c-b-a"],"optionsImage":[],"correctAnswerIndex":0},{"type":"sentence-ordering","question":"Sắp xếp các câu sau để tạo thành một đoạn văn hoàn chỉnh và hợp lý:\na. Therefore, many individuals and organizations are actively promoting the green movement.\nb. Ultimately, adopting these habits can help protect our planet for future generations.\nc. Climate change is a pressing global issue that demands immediate action.\nd. This movement encourages sustainable practices, such as reducing waste and conserving energy, in daily life.","questionImage":null,"mappedType":"multiple-choice","options":["a-c-d-b","c-a-d-b","c-d-a-b","a-b-c-d"],"optionsImage":[],"correctAnswerIndex":1},{"type":"sentence-ordering","question":"Sắp xếp các câu sau để tạo thành một đoạn văn có nghĩa và mạch lạc về cuộc đời Marie Curie:\na. Their work laid the foundation for modern nuclear physics, although she later died from radiation exposure.\nb. Together, they conducted groundbreaking research on radioactivity and, subsequently, were awarded the Nobel Prize in Physics in 1903.\nc. Marie Curie, a pioneering physicist and chemist, was born in Warsaw, Poland, in 1867.\nd. After she completed her initial studies, she moved to Paris, where she met and married Pierre Curie.","questionImage":null,"mappedType":"multiple-choice","options":["c-d-b-a","a-c-b-d","b-d-a-c","c-b-d-a"],"optionsImage":[],"correctAnswerIndex":0}];
            const quizOptions = {"timeLimit":45,"retriesAllowed":1,"showAnswers":true,"showExplanation":true,"aiAssessment":true,"scoring":{"mc":10,"tf":0,"sa":0,"essay":0,"tfMethod":"progressive"}};
            const googleScriptUrl = "https://script.google.com/macros/s/AKfycbz6zKZsm9PJ90lwGqSM4LeTp-5byEF6jQ0D2tT56hLvgrovcZg8px6E5I4DE89S4Kothw/exec";
            const correctExamCode = "3N16OJ";
            const teacherApiKey = "AIzaSyAXNTFc3AMHxJWIVqt77vO6weexFVrc5rs";
            let studentInfo = {};
            let isSubmitted = false;
            let timerInterval;
            let retriesLeft = quizOptions.retriesAllowed;
            let studentApiKey = "";
            let ai = null;

            let proctoringLog = {
                thoatManHinh: 0,
                saoChep: 0,
                dan: 0,
                suKien: []
            };

            const studentQuizContainer = document.getElementById('student-quiz-container');
            const submitBtn = document.getElementById('submit-quiz-btn');
            const resultContainer = document.getElementById('result-container');
            const postSubmitOptions = document.getElementById('post-submit-options');
            const retryBtn = document.getElementById('retry-quiz-btn');
            const loginModal = document.getElementById('login-modal');
            const studentInfoForm = document.getElementById('student-info-form');
            const timerDisplay = document.getElementById('timer-display');
            const retriesDisplay = document.getElementById('retries-display');
            function shuffleQuiz() {
                // Shuffle options/statements within each question first
                quizData.forEach(item => {
                    // Shuffle multiple-choice options and their corresponding images
                    if (item.mappedType === 'multiple-choice' && item.options && item.options.length > 0) {
                        const correctAnswerText = item.options[item.correctAnswerIndex];
                        let optionsWithImages = item.options.map((opt, index) => ({
                            text: opt,
                            image: (item.optionsImage && item.optionsImage[index]) ? item.optionsImage[index] : null
                        }));
                        // Fisher-Yates shuffle
                        for (let i = optionsWithImages.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [optionsWithImages[i], optionsWithImages[j]] = [optionsWithImages[j], optionsWithImages[i]];
                        }
                        // Update the item with shuffled data
                        item.options = optionsWithImages.map(opt => opt.text);
                        item.optionsImage = optionsWithImages.map(opt => opt.image);
                        item.correctAnswerIndex = item.options.indexOf(correctAnswerText);
                    }
                    // Shuffle true-false statements
                    if (item.mappedType === 'true-false' && item.statements && item.statements.length > 0) {
                         for (let i = item.statements.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [item.statements[i], item.statements[j]] = [item.statements[j], item.statements[i]];
                        }
                    }
                });
                // Then, group questions by type and shuffle within each group
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});
                let shuffledQuizData = [];
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    if (grouped[partType]) {
                        const partQuestions = grouped[partType];
                        for (let i = partQuestions.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [partQuestions[i], partQuestions[j]] = [partQuestions[j], partQuestions[i]];
                        }
                        shuffledQuizData = shuffledQuizData.concat(partQuestions);
                    }
                });
               
                quizData = shuffledQuizData;
            }
            // --- Timer Function ---
            function startTimer(duration, display) {
                let timer = duration, minutes, seconds;
                clearInterval(timerInterval); // Clear any existing timer
                if(duration <= 0) {
                     display.textContent = "∞";
                     return;
                }
                timerInterval = setInterval(function () {
                    minutes = parseInt(timer / 60, 10);
                    seconds = parseInt(timer % 60, 10);
                    minutes = minutes < 10 ? "0" + minutes : minutes;
                    seconds = seconds < 10 ? "0" + seconds : seconds;
                    display.textContent = minutes + ":" + seconds;
                    if (--timer < 0) {
                        clearInterval(timerInterval);
                        alert("Hết giờ làm bài!");
                        handleSubmit();
                    }
                }, 1000);
            }
            
            async function showExplanation(index, button) {
                const item = quizData[index];
                const questionCard = document.getElementById(`student-q-${index}`);
                const feedbackDiv = document.getElementById(`q-${index}-feedback`);
                if (!questionCard || !feedbackDiv) return;

                const existingExplanation = feedbackDiv.querySelector('.ai-explanation');
                if (existingExplanation) {
                    existingExplanation.remove();
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Xem giải thích
                    `;
                    return;
                }

                button.disabled = true;
                button.innerHTML = '<div class="loader mr-2"></div> Đang tải...';

                if (item.explanation) {
                    displayExplanation(item.explanation, feedbackDiv, button);
                    return;
                }

                if (!ai) {
                    alert("Tính năng giải thích yêu cầu API Key, nhưng chưa được cấu hình bởi giáo viên.");
                    button.disabled = false;
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Xem giải thích
                    `;
                    return;
                }

                const questionText = item.question || item.main_question;
                let prompt = `Bạn là một trợ lý giáo viên AI, am hiểu sâu sắc Chương trình GDPT 2018. Hãy cung cấp một lời giải chi tiết, từng bước một cho câu hỏi sau đây. Lời giải phải chính xác, dễ hiểu và phù hợp với phương pháp giảng dạy của chương trình học, TUYỆT ĐỐI KHÔNG sử dụng kiến thức của lớp cao hơn để giải thích.\n\n--- CÂU HỎI ---\n${questionText}\n\n`;
                if (item.mappedType === 'multiple-choice') {
                    prompt += `--- CÁC LỰA CHỌN ---\n${item.options.map((opt, i) => `${String.fromCharCode(65 + i)}. ${opt}`).join('\n')}\n\n`;
                    prompt += `--- ĐÁP ÁN ĐÚNG ---\n${String.fromCharCode(65 + item.correctAnswerIndex)}. ${item.options[item.correctAnswerIndex]}`;
                } else if (item.mappedType === 'true-false') {
                    prompt += `--- CÁC MỆNH ĐỀ & ĐÁP ÁN ---\n${item.statements.map(s => ` - ${s.statement} -> ${s.is_correct ? 'Đúng' : 'Sai'}`).join('\n')}`;
                } else {
                    prompt += `--- ĐÁP ÁN / GỢI Ý ---\n${item.answer}`;
                }
                prompt += `\n\n--- YÊU CẦU ---\nGiải thích rõ ràng tại sao đáp án lại đúng, từng bước một. Định dạng tất cả các công thức toán học bằng LaTeX.`;

                try {
                    const response = await ai.models.generateContent({ model: "gemini-2.5-flash", contents: prompt });
                    const explanationText = response.text.replace(/\n/g, '<br>');
                    item.explanation = explanationText; // Cache it
                    displayExplanation(explanationText, feedbackDiv, button);
                } catch (error) {
                    console.error("Lỗi khi tạo giải thích:", error);
                    feedbackDiv.insertAdjacentHTML('beforeend', '<div class="ai-explanation text-red-600">Lỗi: Không thể tạo giải thích.</div>');
                    button.disabled = false;
                    button.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Thử lại
                    `;
                }
            }

            function displayExplanation(explanationText, container, button) {
                container.insertAdjacentHTML('beforeend', `<div class="ai-explanation prose prose-sm">${explanationText}</div>`);
                if (window.MathJax) MathJax.typesetPromise([container]);
                button.disabled = false;
                button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    Ẩn giải thích
                `;
            }
           
            function renderStudentQuiz() {
                studentQuizContainer.innerHTML = '';
               
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) {
                        acc[type] = [];
                    }
                    acc[type].push(q);
                    return acc;
                }, {});
                const groupInfo = {
                    'multiple-choice': { title: 'PHẦN I. TRẮC NGHIỆM KHÁCH QUAN', subtitle: 'Chọn đáp án đúng nhất trong các lựa chọn sau.' },
                    'true-false': { title: 'PHẦN II. CÂU HỎI ĐÚNG - SAI', subtitle: 'Xác định tính đúng hoặc sai cho mỗi mệnh đề dưới đây.' },
                    'short-answer': { title: 'PHẦN III. CÂU HỎI TRẢ LỜI NGẮN', subtitle: 'Điền đáp án ngắn gọn vào phần trả lời.' },
                    'essay': { title: 'PHẦN IV. CÂU HỎI TỰ LUẬN', subtitle: 'Trình bày chi tiết bài giải của bạn.' }
                };
               
                let questionCounter = 0;
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    const questions = grouped[partType];
                    if (!questions || questions.length === 0) return;
                   
                    let groupHTML = `<div class="group-container space-y-8 mb-12">`;
                    const info = groupInfo[partType];
                    groupHTML += `
                        <div class="group-header pb-3 border-b-2 border-slate-300 mb-6">
                            <h2 class="text-2xl font-bold text-slate-800">${info.title}</h2>
                            ${info.subtitle ? `<p class="text-md text-slate-600 italic mt-1">${info.subtitle}</p>` : ''}
                        </div>
                    `;
                    questions.forEach((item, localIndex) => {
                        const globalIndex = quizData.indexOf(item);
                        questionCounter++;
                        groupHTML += `<div class="question-card" id="student-q-${globalIndex}">`;
                        let questionText = (item.question || item.main_question || '').replace(/\n/g, '<br>');
                       
                        groupHTML += `<div class="flex items-start">
                                     <div class="flex-grow">
                                         <div class="flex items-center mb-2">
                                             <span class="font-bold text-lg mr-3 text-indigo-600">Câu ${questionCounter}:</span>
                                             <div id="q-${globalIndex}-feedback-icon"></div>
                                         </div>
                                         <div class="question-content mt-2 text-lg text-slate-700">${questionText}</div>
                                         ${item.questionImage ? `<img src="${item.questionImage}" class="mt-4 rounded-lg max-w-full md:max-w-md border shadow-sm">` : ''}
                                     </div>
                                 </div>`;
                       
                        groupHTML += `<div class="mt-6">`;
                        switch(item.mappedType) {
                            case 'multiple-choice':
                                groupHTML += `<div class="options-grid grid grid-cols-1 md:grid-cols-2 gap-4">`;
                                item.options.forEach((opt, i) => {
                                    groupHTML += `<label for="q${globalIndex}-opt${i}" id="q${globalIndex}-opt-label${i}" class="option-label flex items-start p-4 border-2 rounded-xl cursor-pointer hover:bg-indigo-50 hover:border-indigo-400">
                                                     <input type="radio" name="q${globalIndex}" id="q${globalIndex}-opt${i}" value="${i}" class="flex-shrink-0 mt-1 h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                                     <div class="ml-3 flex-grow">
                                                         <span class="font-semibold text-slate-800">${String.fromCharCode(65 + i)}.</span>
                                                         <span class="option-content text-slate-700">${opt || ''}</span>
                                                         ${(item.optionsImage && item.optionsImage[i]) ? `<img src="${item.optionsImage[i]}" class="mt-2 rounded-lg max-w-xs border shadow-sm">` : ''}
                                                     </div>
                                                 </label>`;
                                });
                                groupHTML += `</div>`;
                                break;
                            case 'true-false':
                                 groupHTML += `<div class="space-y-4">`;
                                 item.statements.forEach((s, i) => {
                                     groupHTML += `<div class="statement-item border-t pt-4">
                                                  <p class="mb-3 text-slate-700">${String.fromCharCode(97 + i)}) ${s.statement || ''}</p>
                                                  <div class="flex gap-x-6">
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="true" class="mr-2 h-4 w-4"> Đúng</label>
                                                      <label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="false" class="mr-2 h-4 w-4"> Sai</label>
                                                  </div>
                                              </div>`;
                                 });
                                 groupHTML += `</div>`;
                                 break;
                            case 'short-answer':
                                groupHTML += `<input type="text" name="q${globalIndex}" class="mt-1 block w-full md:w-1/2 border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Nhập đáp án của bạn...">`;
                                break;
                            case 'essay':
                                groupHTML += `<textarea name="q${globalIndex}" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" rows="5" placeholder="Nhập câu trả lời tự luận của bạn..."></textarea>`;
                                break;
                        }
                        groupHTML += `</div><div id="q-${globalIndex}-feedback" class="mt-4"></div></div>`;
                    });
                    groupHTML += `</div>`;
                    studentQuizContainer.innerHTML += groupHTML;
                });
               
                if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                    MathJax.typesetPromise([studentQuizContainer]);
                }
            }
           
            async function generatePerformanceReview(allAnswersData) {
                const feedbackContainer = document.getElementById('ai-feedback-container');
                if (!feedbackContainer || !ai) return null;
                feedbackContainer.classList.remove('hidden');
                feedbackContainer.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-slate-800 mb-4">📝 Phân Tích & Gợi Ý Từ Trợ Lý AI</h3>
                        <div id="ai-feedback-loader" class="text-center py-6">
                            <svg class="animate-spin mx-auto h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p class="mt-3 text-slate-600">AI đang phân tích bài làm của bạn...</p>
                        </div>
                        <div id="ai-feedback-summary" class="hidden prose prose-sm max-w-none"></div>
                        <div id="ai-feedback-details" class="hidden mt-4 space-y-2"></div>
                    </div>
                `;
               
                const loader = document.getElementById('ai-feedback-loader');
                const summaryDiv = document.getElementById('ai-feedback-summary');
                const detailsDiv = document.getElementById('ai-feedback-details');
                const incorrectAnswers = allAnswersData.filter(a => !a.isCorrect);
                if (incorrectAnswers.length === 0) {
                    feedbackContainer.innerHTML = `
                        <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                            <h3 class="text-xl font-bold text-green-600">🎉 Chúc mừng!</h3>
                            <p class="mt-2 text-slate-700">Bạn đã trả lời đúng tất cả các câu hỏi. Làm tốt lắm!</p>
                        </div>
                    `;
                    return { overallFeedback: { summary: "Xuất sắc! Học sinh đã đã trả lời đúng tất cả các câu hỏi." } };
                }
                const summaryPrompt = `Bạn là một trợ lý giáo viên, nói tiếng Việt. Dựa vào tóm tắt các câu trả lời sai của học sinh, hãy đưa ra một nhận xét tổng quan ngắn gọn (khoảng 3-4 câu) về năng lực của học sinh, bao gồm điểm mạnh (suy luận từ các câu làm đúng), điểm yếu (dựa trên các câu sai) và một vài gợi ý ôn tập chung. Lời văn phải khích lệ, rõ ràng.
                Tóm tắt lỗi sai:
                ${JSON.stringify(incorrectAnswers.map(a => ({ cau: a.questionNumber, loai: a.type, cauHoi: a.question.substring(0, 50) + '...' })), null, 2)}`;
                try {
                    const response = await ai.models.generateContent({
                        model: "gemini-2.5-flash",
                        contents: summaryPrompt
                    });
                    summaryDiv.innerHTML = response.text.replace(/\n/g, '<br>');
                    loader.classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                    detailsDiv.classList.remove('hidden'); 
                } catch (e) {
                    console.error("Lỗi khi lấy nhận xét tổng quan:", e);
                    summaryDiv.innerHTML = '<p class="text-red-600">Lỗi khi tạo nhận xét tổng quan.</p>';
                    loader.classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                }
               
                const summaryForSheet = summaryDiv.innerText.substring(0, 200) + "...";
                return { overallFeedback: { summary: summaryForSheet } };
            }
            async function handleSubmit() {
                if (isSubmitted) return;
                isSubmitted = true;
                clearInterval(timerInterval);
                
                document.querySelectorAll('input, textarea').forEach(input => input.disabled = true);
                submitBtn.classList.add('hidden');
                postSubmitOptions.classList.remove('hidden');
                if (retriesLeft > 0) {
                    retryBtn.classList.remove('hidden');
                } else {
                    retryBtn.classList.add('hidden');
                }

                const proctoringDataString = JSON.stringify(proctoringLog);

                let totalStudentScore = 0;
                let totalCorrectAnswers = 0;
                let allAnswersData = [];
                const questionCounts = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    acc[type] = (acc[type] || 0) + 1;
                    return acc;
                }, {});
                
                quizData.forEach((item, index) => {
                    let questionNumber = index + 1;
                    let answerData = { questionNumber, type: item.type };
                    switch (item.mappedType) {
                        case 'multiple-choice':
                            const selectedOption = document.querySelector(`input[name="q${index}"]:checked`);
                            const isCorrectMC = selectedOption ? parseInt(selectedOption.value) === item.correctAnswerIndex : false;
                            if (isCorrectMC) {
                                totalCorrectAnswers++;
                                if (questionCounts['multiple-choice'] > 0) {
                                   totalStudentScore += quizOptions.scoring.mc / questionCounts['multiple-choice'];
                                }
                            }
                            answerData.question = item.question;
                            answerData.options = item.options;
                            answerData.yourAnswer = selectedOption ? String.fromCharCode(65 + parseInt(selectedOption.value)) : "Không trả lời";
                            answerData.correctAnswer = String.fromCharCode(65 + item.correctAnswerIndex);
                            answerData.isCorrect = isCorrectMC;
                            break;
                        case 'true-false':
                            let correctStatementsCount = 0;
                            let yourAnswerPattern = [];
                            let correctAnswerPattern = [];
                            let details = [];
                            item.statements.forEach((s, i) => {
                                const selectedTF = document.querySelector(`input[name="q${index}-s${i}"]:checked`);
                                const studentChoice = selectedTF ? selectedTF.value === 'true' : null;
                                const isStatementCorrect = studentChoice === s.is_correct;
                               
                                if (isStatementCorrect) correctStatementsCount++;
                               
                                yourAnswerPattern.push(studentChoice === null ? '?' : (studentChoice ? 'Đ' : 'S'));
                                correctAnswerPattern.push(s.is_correct ? 'Đ' : 'S');
                                details.push({ statement: s.statement, yourChoice: studentChoice === null ? 'Không trả lời' : (studentChoice ? 'Đúng' : 'Sai'), correctChoice: s.is_correct ? 'Đúng' : 'Sai', isCorrect: isStatementCorrect });
                            });
                            
                            let scorePerTfQuestion = 0;
                            if (questionCounts['true-false'] > 0) {
                                scorePerTfQuestion = quizOptions.scoring.tf / questionCounts['true-false'];
                            }
                            let questionPoints = 0;
                            if (quizOptions.scoring.tfMethod === 'progressive') {
                                const progressivePoints = { 0: 0, 1: 0.1, 2: 0.25, 3: 0.5, 4: 1.0 };
                                questionPoints = progressivePoints[correctStatementsCount] * scorePerTfQuestion;
                            } else { // even
                                questionPoints = (correctStatementsCount / 4) * scorePerTfQuestion;
                            }
                            totalStudentScore += questionPoints;

                            if(correctStatementsCount === 4) totalCorrectAnswers++;
                            answerData.question = item.main_question;
                            answerData.yourAnswer = yourAnswerPattern.join('-');
                            answerData.correctAnswer = correctAnswerPattern.join('-');
                            answerData.isCorrect = correctStatementsCount === 4;
                            answerData.details = details;
                            break;
                       
                        case 'short-answer':
                            const saInput = document.querySelector(`input[name="q${index}"]`);
                            const studentAnswerRaw = saInput ? (saInput.value ?? '').trim() : "";
                            const correctAnswerRaw = (item.answer ?? '').toString().trim().replace(/\$/g, '');
                            let isCorrectSA = false;
                            const studentAnswerNormalized = studentAnswerRaw.replace(',', '.');
                            const correctAnswerNormalized = correctAnswerRaw.replace(',', '.');
                            if (studentAnswerNormalized.toLowerCase() === correctAnswerNormalized.toLowerCase()) {
                                isCorrectSA = true;
                            }
                             if (isCorrectSA) {
                                totalCorrectAnswers++;
                                if (questionCounts['short-answer'] > 0) {
                                   totalStudentScore += quizOptions.scoring.sa / questionCounts['short-answer'];
                                }
                            }
                            answerData.question = item.question;
                            answerData.yourAnswer = studentAnswerRaw || "Không trả lời";
                            answerData.correctAnswer = correctAnswerRaw;
                            answerData.isCorrect = isCorrectSA;
                            break;
                           
                        case 'essay':
                             const essayInput = document.querySelector(`textarea[name="q${index}"]`);
                             answerData.question = item.question;
                             answerData.yourAnswer = essayInput.value || "Không trả lời";
                             answerData.correctAnswer = item.answer;
                             answerData.isCorrect = null; // Needs manual grading
                             break;
                    }
                    allAnswersData.push(answerData);
                });
                
                const finalScore = totalStudentScore;
                
                let competencyAssessment = "Giáo viên không yêu cầu AI phân tích bài làm.";
                if (quizOptions.aiAssessment) {
                    const feedbackData = await generatePerformanceReview(allAnswersData);
                    if (feedbackData && feedbackData.overallFeedback && feedbackData.overallFeedback.summary) {
                        competencyAssessment = feedbackData.overallFeedback.summary;
                    } else {
                        competencyAssessment = "Có lỗi xảy ra trong quá trình AI phân tích bài làm.";
                    }
                }
                
                if (quizOptions.showAnswers) {
                    const totalQuestions = quizData.length;
                    resultContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg text-center">
                        <h3 class="text-2xl font-bold text-slate-800">KẾT QUẢ BÀI LÀM</h3>
                        <p class="mt-4 text-lg">Số câu đúng hoàn toàn: <span class="font-bold text-green-600">${totalCorrectAnswers}/${totalQuestions}</span></p>
                        <p class="text-2xl mt-2">Điểm (thang 10): <span class="font-bold text-blue-600">${finalScore.toFixed(2)}</span></p>
                        ${questionCounts['essay'] > 0 ? `<p class="text-sm text-gray-600 italic mt-1">Lưu ý: Điểm trên chưa bao gồm ${quizOptions.scoring.essay} điểm của phần Tự luận.</p>` : ''}
                    </div>`;
                    resultContainer.classList.remove('hidden');

                    allAnswersData.forEach((ans, index) => {
                        const questionCard = document.getElementById(`student-q-${index}`);
                        const feedbackIconDiv = document.getElementById(`q-${index}-feedback-icon`);
                        const feedbackDiv = document.getElementById(`q-${index}-feedback`);
                        if (!questionCard || !feedbackIconDiv || !feedbackDiv) return;

                        const iconHTML = ans.isCorrect === true
                            ? '<svg class="feedback-icon text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>'
                            : (ans.isCorrect === false ? '<svg class="feedback-icon text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>' : '');
                        feedbackIconDiv.innerHTML = iconHTML;

                        if (ans.type.includes('multiple-choice')) {
                            const studentChoice = ans.yourAnswer === "Không trả lời" ? -1 : ans.yourAnswer.charCodeAt(0) - 65;
                            const correctChoice = ans.correctAnswer.charCodeAt(0) - 65;
                            document.getElementById(`q-${index}-opt-label${correctChoice}`)?.classList.add('correct');
                            if (studentChoice !== -1 && studentChoice !== correctChoice) {
                                document.getElementById(`q-${index}-opt-label${studentChoice}`)?.classList.add('incorrect');
                            }
                        } else if (ans.type === 'true-false') {
                            const statementItems = questionCard.querySelectorAll('.statement-item');
                            ans.details.forEach((detail, i) => { if(statementItems[i]) { statementItems[i].classList.add(detail.isCorrect ? 'correct' : 'incorrect'); }});
                        }

                        if (quizOptions.showExplanation) {
                            feedbackDiv.innerHTML = `<button data-explain-index="${index}" class="explain-btn mt-4 flex items-center px-4 py-2 bg-blue-100 text-blue-800 text-sm font-semibold rounded-lg hover:bg-blue-200 transition-colors">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Xem giải thích
                            </button>`;
                        }
                    });
                    
                    document.querySelectorAll('.explain-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const button = e.currentTarget;
                            const index = parseInt(button.dataset.explainIndex, 10);
                            showExplanation(index, button);
                        });
                    });

                    if (window.MathJax) await window.MathJax.typesetPromise([studentQuizContainer]);
                } else {
                     resultContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg text-center"><h3 class="text-xl font-bold text-green-600">Nộp bài thành công!</h3><p class="mt-2 text-slate-700">Bạn đã hoàn thành bài làm. Kết quả sẽ được giáo viên công bố sau.</p></div>`;
                    resultContainer.classList.remove('hidden');
                }
                
                const formData = new FormData();
                formData.append('name', studentInfo.name);
                formData.append('class', studentInfo.class);
                formData.append('score', `${finalScore.toFixed(2)}/10`);
                formData.append('assessment', competencyAssessment);
                formData.append('timestamp', new Date().toLocaleString('vi-VN'));
                formData.append('examCode', correctExamCode);
                formData.append('monitoringLog', proctoringDataString);
                formData.append('answerDetails', JSON.stringify(allAnswersData));
               
                fetch(googleScriptUrl, { method: 'POST', body: formData})
                    .then(res => console.log("Successfully submitted to Google Sheet"))
                    .catch(err => console.error("Error submitting to Google Sheet:", err));
            }
           
            function startNewAttempt() {
                isSubmitted = false;
                proctoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0, suKien: [] };
                const proctoringWidget = document.getElementById('proctoring-widget');
                if (proctoringWidget) {
                    proctoringWidget.classList.add('hidden');
                    document.getElementById('tab-switch-count').textContent = '0';
                    document.getElementById('copy-count').textContent = '0';
                    document.getElementById('paste-count').textContent = '0';
                }

                renderStudentQuiz();
                resultContainer.classList.add('hidden');
                document.getElementById('ai-feedback-container').classList.add('hidden');
                postSubmitOptions.classList.add('hidden');
                submitBtn.classList.remove('hidden');
                 if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                }
                retriesLeft--;
                retriesDisplay.textContent = `Lượt làm lại còn: ${retriesLeft}`;
                window.scrollTo(0, 0);
            }
            studentInfoForm.addEventListener('submit', (e) => {
                e.preventDefault();
               
                const enteredCode = document.getElementById('exam-code').value.trim().toUpperCase();
                if (correctExamCode && enteredCode !== correctExamCode) {
                    alert('Mã đề không chính xác. Vui lòng kiểm tra lại!');
                    return;
                }
               
                studentApiKey = teacherApiKey;
                if (!studentApiKey) {
                    console.warn('Cảnh báo: Giáo viên chưa cấu hình API Key. Các tính năng AI sẽ không hoạt động.');
                }
       
                try {
                    if (studentApiKey) {
                       ai = new GoogleGenAI({ apiKey: studentApiKey });
                    }
                } catch(e) {
                    console.error("Lỗi khởi tạo Gemini API với key của giáo viên.", e);
                    alert("Cảnh báo: API Key của giáo viên không hợp lệ. Vui lòng báo cho giáo viên. Các tính năng AI sẽ không hoạt động.");
                    ai = null;
                }
                shuffleQuiz();
               
                studentInfo.name = document.getElementById('student-name').value;
                studentInfo.class = document.getElementById('student-class').value;
                loginModal.classList.add('hidden');
                studentQuizContainer.classList.remove('hidden');
                submitBtn.classList.remove('hidden');
               
                if (quizOptions.timeLimit > 0) {
                    const timeInSeconds = quizOptions.timeLimit * 60;
                    startTimer(timeInSeconds, timerDisplay);
                } else {
                    timerDisplay.textContent = "Không giới hạn";
                }
                retriesDisplay.textContent = `Lượt làm lại còn: ${retriesLeft}`;
                renderStudentQuiz();

                const proctoringWidget = document.getElementById('proctoring-widget');
                const tabSwitchCountEl = document.getElementById('tab-switch-count');
                const copyCountEl = document.getElementById('copy-count');
                const pasteCountEl = document.getElementById('paste-count');

                function updateProctoringUI() {
                    if (proctoringLog.thoatManHinh > 0 || proctoringLog.saoChep > 0 || proctoringLog.dan > 0) {
                        proctoringWidget.classList.remove('hidden');
                    }
                    tabSwitchCountEl.textContent = proctoringLog.thoatManHinh;
                    copyCountEl.textContent = proctoringLog.saoChep;
                    pasteCountEl.textContent = proctoringLog.dan;
                }

                // Disable Right Click
                document.addEventListener('contextmenu', e => e.preventDefault());

                // Track Tab Switching
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && !isSubmitted) {
                        proctoringLog.thoatManHinh++;
                        proctoringLog.suKien.push({ loai: 'chuyen_tab', thoiGian: new Date().toISOString() });
                        updateProctoringUI();
                    }
                });

                // Track Copying
                document.addEventListener('copy', () => {
                    if (isSubmitted) return;
                    proctoringLog.saoChep++;
                    proctoringLog.suKien.push({ loai: 'sao_chep', thoiGian: new Date().toISOString() });
                    updateProctoringUI();
                });

                // Track Pasting
                document.addEventListener('paste', () => {
                    if (isSubmitted) return;
                    proctoringLog.dan++;
                    proctoringLog.suKien.push({ loai: 'dan', thoiGian: new Date().toISOString() });
                    updateProctoringUI();
                });
            });
            
            submitBtn.addEventListener('click', handleSubmit);
            retryBtn.addEventListener('click', () => {
                shuffleQuiz();
                startNewAttempt();
            });
        </script>
    </body>
    </html>
    