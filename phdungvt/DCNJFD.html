
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bài kiểm tra - 17/11/2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #f8fafc; }
        .option.selected { border-color: #3b82f6; background-color: #eff6ff; box-shadow: 0 0 0 2px #60a5fa; }
        .option.correct { border-color: #16a34a; background-color: #f0fdf4; }
        .option.incorrect { border-color: #dc2626; background-color: #fef2f2; }
        .disabled { pointer-events: none; opacity: 0.6; }
        .monitoring-warning { position: fixed; top: 16px; left: 50%; transform: translateX(-50%); background-color: #ef4444; color: white; padding: 12px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; display: none; animation: fade-in-out 5s ease-in-out; }
        @keyframes fade-in-out { 0%, 100% { opacity: 0; transform: translate(-50%, -20px); } 10%, 90% { opacity: 1; transform: translate(-50%, 0); } }
        mjx-container { display: inline-block !important; }
        .prose img.latex-image { display: inline-block; vertical-align: middle; }
        #progress-bar-fill { transition: width 0.3s ease-in-out; }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
    </style>
    <script>
        window.MathJax = { tex: { inlineMath: [['$', '$']], displayMath: [['$$', '$$']] }, svg: { fontCache: 'global' } };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    <script type="importmap">
    { "imports": { "@google/genai": "https://esm.sh/@google/genai@^1.13.0" } }
    </script>
</head>
<body class="p-4 md:p-8">
    <div id="app" class="max-w-4xl mx-auto bg-white p-6 md:p-8 rounded-2xl shadow-xl border border-slate-200">
        
        <div id="welcome-screen">
            <div class="text-center">
                 <svg class="mx-auto h-12 w-12 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>
                 <h1 class="text-3xl font-bold text-slate-800 mt-4">Bài kiểm tra - 17/11/2025</h1>
                 <p class="mt-2 text-slate-600">Mã đề: <span class="font-bold text-indigo-600">DCNJFD</span></p>
            </div>
            <hr class="my-6">
            <div class="space-y-4 max-w-sm mx-auto">
                <div>
                    <label for="name" class="block text-sm font-medium text-slate-700">Họ và tên</label>
                    <input type="text" id="name" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="class" class="block text-sm font-medium text-slate-700">Lớp</label>
                    <input type="text" id="class" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>
             <div class="mt-6 text-center bg-yellow-50 border border-yellow-200 p-3 rounded-lg text-sm text-yellow-800 max-w-md mx-auto">
                <strong>Lưu ý:</strong> Hệ thống sẽ giám sát việc chuyển tab hoặc sao chép/dán. Các hành vi này sẽ được ghi lại và báo cáo.
             </div>
            <button id="start-btn" class="mt-8 w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-indigo-700 transition-transform transform hover:scale-105">Bắt đầu làm bài</button>
        </div>

        <div id="quiz-screen" class="hidden">
             <div class="sticky top-0 bg-white/80 backdrop-blur-sm z-10 -mx-6 -mt-8 px-6 pt-6 pb-4 border-b border-slate-200">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-slate-800 truncate pr-4">Bài kiểm tra - 17/11/2025</h2>
                    <div id="timer" class="text-lg font-bold text-red-600 bg-red-100 px-4 py-1.5 rounded-full tabular-nums"></div>
                </div>
                <div id="progress-container" class="w-full bg-slate-200 rounded-full h-3">
                    <div id="progress-bar-fill" class="bg-indigo-500 h-3 rounded-full" style="width: 0%"></div>
                </div>
             </div>
            <div id="all-questions-container" class="mt-6"></div>
            <div class="mt-8 flex justify-end">
                <button id="submit-btn" class="bg-green-600 text-white py-3 px-8 rounded-lg font-semibold hover:bg-green-700 text-lg">Nộp bài</button>
            </div>
        </div>

        <div id="results-screen" class="hidden text-center">
            <h2 class="text-3xl font-bold text-slate-800">Kết quả bài làm</h2>
            <div id="score-display" class="hidden text-6xl font-bold text-blue-600 my-6"></div>
            <div id="assessment-display" class="hidden mt-4 p-4 bg-slate-100 rounded-lg text-slate-700 max-w-2xl mx-auto text-left"></div>
            <div id="review-container" class="mt-8 text-left"></div>
            <div class="mt-8 text-center space-x-4">
                <button id="retry-btn" class="hidden bg-indigo-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-indigo-700">Làm lại bài</button>
                <button id="restart-btn" class="bg-slate-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-slate-600">Về trang chủ</button>
            </div>
        </div>
        
        <div id="monitoring-warning" class="monitoring-warning">⚠️ Đã phát hiện hành vi không hợp lệ!</div>
    </div>

    <script type="module">
        import { GoogleGenAI } from "@google/genai";

        const API_KEY = "AIzaSyAzvr2Py2_mr5Z4R3YWXi-dyO1ufA2paas";
        const quizData = [{"question":"Kết quả của phép tính $38 + 25$ là bao nhiêu?","options":["53","63","52","62"],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Kết quả của phép tính $38 + 25$ là bao nhiêu?","rendered_options":["53","63","52","62"]},{"question":"Số thích hợp điền vào ô trống là: $62 - 17 = \text{?}$","options":["45","55","44","54"],"correctAnswerIndex":0,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Số thích hợp điền vào ô trống là: $62 - 17 = \text{?}$","rendered_options":["45","55","44","54"]},{"question":"Chọn phép tính có kết quả đúng:","options":["$29 + 34 = 53$","$45 + 18 = 63$","$57 + 26 = 73$","$36 + 47 = 73$"],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Chọn phép tính có kết quả đúng:","rendered_options":["$29 + 34 = 53$","$45 + 18 = 63$","$57 + 26 = 73$","$36 + 47 = 73$"]},{"question":"Điền số thích hợp vào chỗ trống: $? - 29 = 45$","options":["74","64","75","65"],"correctAnswerIndex":0,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Điền số thích hợp vào chỗ trống: $? - 29 = 45$","rendered_options":["74","64","75","65"]},{"question":"Một cửa hàng có $56$ quả cam. Cửa hàng bán được $28$ quả. Hỏi cửa hàng còn lại bao nhiêu quả cam?","options":["$27$ quả cam","$28$ quả cam","$38$ quả cam","$37$ quả cam"],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Một cửa hàng có $56$ quả cam. Cửa hàng bán được $28$ quả. Hỏi cửa hàng còn lại bao nhiêu quả cam?","rendered_options":["$27$ quả cam","$28$ quả cam","$38$ quả cam","$37$ quả cam"]}];
        const options = {"title":"Bài kiểm tra - 17/11/2025","timeLimit":45,"retriesAllowed":1,"showAnswers":true,"showExplanation":true,"aiAssessment":true,"shortAnswerFormat":"freeform","examCode":"DCNJFD","teacherName":"aaa","scoring":{"mc":5,"tf":2,"sa":2,"essay":1,"tfMethod":"progressive"}};
        const googleScriptUrl = "https://script.google.com/macros/s/AKfycbwgJhIWfkt1elmKGDDUovaawDgkNzJEFd1oUI_ZiQ65wz49CPEBx9BEWEsomQhb2bUbCw/exec";
        const examCode = "DCNJFD";
        
        let userAnswers = new Array(quizData.length).fill(null);
        let studentName = '', studentClass = '', timerInterval;
        let timeRemaining = options.timeLimit * 60;
        let retriesCount = 0;
        let submissionStatus = 'pending';
        let monitoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0 };
        let lastScore, lastAnswerDetails;
        
        const welcomeScreen = document.getElementById('welcome-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const resultsScreen = document.getElementById('results-screen');
        const startBtn = document.getElementById('start-btn');
        const nameInput = document.getElementById('name');
        const classInput = document.getElementById('class');
        const timerEl = document.getElementById('timer');
        const submitBtn = document.getElementById('submit-btn');
        const scoreDisplay = document.getElementById('score-display');
        const assessmentDisplay = document.getElementById('assessment-display');
        const reviewContainer = document.getElementById('review-container');
        const retryBtn = document.getElementById('retry-btn');
        const restartBtn = document.getElementById('restart-btn');
        const warningEl = document.getElementById('monitoring-warning');
        const progressBarFill = document.getElementById('progress-bar-fill');

        window.selectOption = selectOption;
        window.selectTFOption = selectTFOption;
        window.saveTextAnswer = saveTextAnswer;
        window.retryAIAssessment = retryAIAssessment;
        window.setupFormInputs = setupFormInputs;
        window.saveFormAnswer = saveFormAnswer;

        startBtn.addEventListener('click', startQuiz);
        submitBtn.addEventListener('click', confirmSubmit);
        retryBtn.addEventListener('click', retryQuiz);
        restartBtn.addEventListener('click', () => window.location.reload());
        
        nameInput.value = localStorage.getItem('studentName') || '';
        classInput.value = localStorage.getItem('studentClass') || '';
        
        function safeTypeset(elements) {
            if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                window.MathJax.typesetPromise(elements).catch(err => console.error('MathJax error: ' + err.message));
            }
        }
        
        function updateProgressBar() {
            const answeredCount = userAnswers.filter(answer => {
                if (Array.isArray(answer)) return answer.every(a => a !== null);
                return answer !== null;
            }).length;
            const progress = (answeredCount / quizData.length) * 100;
            progressBarFill.style.width = `${progress}%`;
        }

        function startQuiz() {
            studentName = nameInput.value.trim();
            studentClass = classInput.value.trim();
            if (!studentName || !studentClass) {
                alert('Vui lòng nhập đầy đủ Họ và tên và Lớp.'); return;
            }
            localStorage.setItem('studentName', studentName);
            localStorage.setItem('studentClass', studentClass);
            
            welcomeScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            resultsScreen.classList.add('hidden');
            
            userAnswers.fill(null);
            submissionStatus = 'pending';
            updateProgressBar();
            
            renderAllQuestions();
            
            if (options.timeLimit > 0) {
                timeRemaining = options.timeLimit * 60;
                startTimer();
            } else {
                timerEl.textContent = 'Không giới hạn';
            }
            startMonitoring();
        }

        function mapType(typeStr) {
             if (!typeStr) return 'multiple-choice';
             if (typeStr.startsWith('mc-') || ['cloze-test', 'sentence-ordering', 'multiple-choice', 'paragraph-sentence-ordering'].includes(typeStr)) return 'multiple-choice';
             if (typeStr.startsWith('tf-') || typeStr === 'true-false') return 'true-false';
             if (typeStr === 'short-answer' || typeStr === 'sentence-transformation') return 'short-answer';
             return 'essay';
        }
        
        function renderAllQuestions() {
            const container = document.getElementById('all-questions-container');
            let allHTML = '';
            const groupedQuestions = quizData.reduce((acc, q) => {
                const type = mapType(q.type);
                if (!acc[type]) acc[type] = [];
                acc[type].push(q);
                return acc;
            }, {});

            const groupInfo = { 'multiple-choice': 'PHẦN I. TRẮC NGHIỆM', 'true-false': 'PHẦN II. ĐÚNG - SAI', 'short-answer': 'PHẦN III. TRẢ LỜI NGẮN', 'essay': 'PHẦN IV. TỰ LUẬN' };
            
            let questionCounter = 0;
            ['multiple-choice', 'true-false', 'short-answer', 'essay'].forEach(partType => {
                const questions = groupedQuestions[partType];
                if (!questions || questions.length === 0) return;

                allHTML += `<div class="mb-6 pb-3 border-b-2 border-slate-200"><h2 class="text-xl font-bold text-slate-800">${groupInfo[partType]}</h2></div>`;
                
                questions.forEach(item => {
                    const index = quizData.indexOf(item);
                    questionCounter++;
                    
                    let contentHTML = `<div class="question-card mb-8 p-6 border rounded-xl shadow-sm bg-slate-50" id="q-${index}">`;
                    contentHTML += `<p class="font-semibold text-lg text-slate-800 mb-4">Câu ${questionCounter}:</p>`;
                    contentHTML += `<div class="prose max-w-none text-slate-700 mb-4">${item.rendered_question || ''}</div>`;

                    let answerHTML = '';
                    const savedAnswer = userAnswers[index];
                    const type = mapType(item.type);
                    
                    if (type === 'multiple-choice') {
                        answerHTML = `<div class="space-y-3">`;
                        (item.rendered_options || []).forEach((opt, i) => {
                            answerHTML += `<div class="option ${savedAnswer === i ? 'selected' : ''} p-3 border-2 rounded-lg cursor-pointer transition flex items-start bg-white" onclick="selectOption(this, ${index}, ${i})">
                                                <span class="font-bold mr-3">${String.fromCharCode(65 + i)}.</span>
                                                <div class="flex-grow">${opt}</div>
                                            </div>`;
                        });
                        answerHTML += `</div>`;
                    } else if (type === 'true-false') {
                         answerHTML = `<div class="space-y-3">`;
                         (item.statements || []).forEach((stmt, i) => {
                            const savedStmtAnswer = savedAnswer ? savedAnswer[i] : null;
                            answerHTML += `<div class="p-3 border-2 rounded-lg flex items-center justify-between gap-4 bg-white">
                                                <div class="flex-grow prose max-w-none">${stmt.rendered_statement}</div>
                                                <div class="flex-shrink-0 flex gap-2">
                                                    <button class="${savedStmtAnswer === true ? 'bg-blue-600 text-white' : 'bg-slate-200'} px-4 py-2 rounded-md font-semibold" onclick="selectTFOption(this, ${index}, ${i}, true)">Đúng</button>
                                                    <button class="${savedStmtAnswer === false ? 'bg-red-600 text-white' : 'bg-slate-200'} px-4 py-2 rounded-md font-semibold" onclick="selectTFOption(this, ${index}, ${i}, false)">Sai</button>
                                                </div>
                                            </div>`;
                        });
                        answerHTML += `</div>`;
                    } else if (type === 'short-answer') {
                        if (options.shortAnswerFormat === 'form') {
                             answerHTML = `<div id="sa-form-${index}" class="flex items-center gap-2">${Array(4).fill('').map(() => `<input type="text" maxlength="1" data-q-index="${index}" class="w-12 h-12 text-center text-2xl font-bold border-2 border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">`).join('')}</div>`;
                        } else {
                            answerHTML = `<input type="text" class="w-full border border-slate-300 rounded-md p-2" value="${userAnswers[index] || ''}" onchange="saveTextAnswer(this, ${index})">`;
                        }
                    } else if (type === 'essay') {
                        answerHTML = `<textarea class="w-full border border-slate-300 rounded-md p-2" rows="5" onchange="saveTextAnswer(this, ${index})">${userAnswers[index] || ''}</textarea>`;
                    }

                    contentHTML += answerHTML + '</div>';
                    allHTML += contentHTML;
                });
            });
            container.innerHTML = allHTML;
            document.querySelectorAll('[id^="sa-form-"]').forEach(form => setupFormInputs(form.querySelectorAll('input')));
            safeTypeset([container]);
        }

        function setupFormInputs(inputs) {
            const qIndex = inputs[0].dataset.qIndex;
            inputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    if (e.target.value && index < inputs.length - 1) inputs[index + 1].focus();
                    saveFormAnswer(qIndex, inputs);
                });
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value && index > 0) inputs[index - 1].focus();
                    saveFormAnswer(qIndex, inputs);
                });
                input.addEventListener('change', () => saveFormAnswer(qIndex, inputs));
            });
        }
        
        function saveFormAnswer(qIndex, inputs) { userAnswers[qIndex] = Array.from(inputs).map(i => i.value).join(''); updateProgressBar(); }
        function selectOption(el, qIndex, optIndex) { userAnswers[qIndex] = optIndex; document.getElementById(`q-${qIndex}`).querySelectorAll('.option').forEach(opt => opt.classList.remove('selected')); el.classList.add('selected'); updateProgressBar(); }
        function selectTFOption(btn, qIndex, stmtIndex, answer) { if (!userAnswers[qIndex] || !Array.isArray(userAnswers[qIndex])) userAnswers[qIndex] = new Array(quizData[qIndex].statements.length).fill(null); userAnswers[qIndex][stmtIndex] = answer; Array.from(btn.parentElement.children).forEach(b => b.classList.remove('bg-blue-600', 'text-white', 'bg-red-600')); btn.classList.add(answer ? 'bg-blue-600' : 'bg-red-600', 'text-white'); updateProgressBar(); }
        function saveTextAnswer(el, qIndex) { userAnswers[qIndex] = el.value; updateProgressBar(); }

        function confirmSubmit() {
            const unanswered = userAnswers.filter(a => a === null || (Array.isArray(a) && a.some(sub => sub === null))).length;
            if (confirm(`Bạn còn ${unanswered} câu chưa trả lời. Bạn có chắc chắn muốn nộp bài không?`)) {
                submitQuiz();
            }
        }

        async function submitQuiz() {
            if (submissionStatus !== 'pending') return;
            submissionStatus = 'submitting';
            stopTimer();
            stopMonitoring();
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="animate-pulse">Đang nộp bài...</span>';

            const { score, totalPossibleScore, answerDetails } = calculateScore();
            lastScore = score;
            lastAnswerDetails = answerDetails;
            const finalScore = (totalPossibleScore > 0 ? (score / totalPossibleScore * 10) : 0).toFixed(2);
            let aiAssessment = 'Không có';

            if (options.aiAssessment) {
                aiAssessment = await getAIAssessment(finalScore, answerDetails);
            }
            
            const submissionData = new FormData();
            Object.entries({ timestamp: new Date().toLocaleString('vi-VN'), name: studentName, class: studentClass, score: finalScore, assessment: aiAssessment, examCode: examCode, monitoringLog: JSON.stringify(monitoringLog), answerDetails: JSON.stringify(answerDetails) }).forEach(([key, value]) => submissionData.append(key, value));
            
            if (googleScriptUrl) {
                try {
                    await fetch(googleScriptUrl, { method: 'POST', body: new URLSearchParams(submissionData), mode: 'no-cors' });
                } catch (error) {
                    console.error('Error submitting to Google Script:', error);
                    alert('Lỗi: Không thể nộp kết quả. Vui lòng kiểm tra kết nối mạng.');
                }
            }
            submissionStatus = 'submitted';
            showResults(finalScore, aiAssessment, answerDetails);
        }
        
        function showResults(score, assessment, answerDetails) {
            quizScreen.classList.add('hidden');
            resultsScreen.classList.remove('hidden');
            
            if (options.showAnswers) {
                scoreDisplay.textContent = `${score} / 10`;
            } else {
                scoreDisplay.innerHTML = '<p class="text-3xl text-center text-green-600">Nộp bài thành công!</p>';
            }
            scoreDisplay.classList.remove('hidden');

            if (options.aiAssessment && !assessment.startsWith("Lỗi")) {
                assessmentDisplay.innerHTML = `<strong>Nhận xét từ AI:</strong> <br> ${assessment.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>')}`;
                assessmentDisplay.classList.remove('hidden');
            }
            
            if (options.showAnswers) renderReview(answerDetails);
            else reviewContainer.innerHTML = '<p class="text-center text-slate-600">Giáo viên đã chọn không hiển thị đáp án và giải thích chi tiết.</p>';
            
            if (retriesCount < options.retriesAllowed) retryBtn.classList.remove('hidden');
        }

        function calculateScore() {
            let score = 0, totalPossibleScore = 0;
            const answerDetails = [];
            const counts = quizData.reduce((acc, q) => { acc[mapType(q.type)] = (acc[mapType(q.type)] || 0) + 1; return acc; }, {});
            const points = {
                mc: (counts['multiple-choice'] || 0) > 0 ? options.scoring.mc / counts['multiple-choice'] : 0,
                tf: (counts['true-false'] || 0) > 0 ? options.scoring.tf / counts['true-false'] : 0,
                sa: (counts['short-answer'] || 0) > 0 ? options.scoring.sa / counts['short-answer'] : 0,
            };
            totalPossibleScore = Object.values(options.scoring).reduce((sum, val) => sum + (parseFloat(val) || 0), 0);
            if (totalPossibleScore === 0) totalPossibleScore = 10;

            quizData.forEach((item, index) => {
                const userAnswer = userAnswers[index]; let isCorrect = false, detail = null;
                const type = mapType(item.type);
                if (type === 'multiple-choice') { isCorrect = userAnswer === item.correctAnswerIndex; if(isCorrect) score += points.mc; }
                else if (type === 'true-false') {
                    let correctStatements = 0; detail = [];
                    (item.statements || []).forEach((stmt, i) => { const isStmtCorrect = userAnswer?.[i] === stmt.is_correct; if(isStmtCorrect) correctStatements++; detail.push({isCorrect: isStmtCorrect}); });
                    if (options.scoring.tfMethod === 'even') score += (correctStatements / (item.statements.length || 1)) * points.tf;
                    else if(correctStatements === 4) score += points.tf; else if(correctStatements === 3) score += 0.5 * points.tf; else if(correctStatements === 2) score += 0.25 * points.tf; else if(correctStatements === 1) score += 0.1 * points.tf;
                    isCorrect = correctStatements === (item.statements.length || 4);
                } else if (type === 'short-answer') { isCorrect = (userAnswer || '').toString().trim().toLowerCase() === (item.answer || '').toString().trim().toLowerCase(); if(isCorrect) score += points.sa; }
                else { isCorrect = null; }
                answerDetails.push({ questionNumber: index + 1, isCorrect, type, details: detail });
            });
            return { score, totalPossibleScore, answerDetails };
        }
        
        function renderReview(answerDetails) {
            reviewContainer.innerHTML = '<h3 class="text-2xl font-bold mb-6 text-slate-800">Xem lại bài làm</h3>';
            quizData.forEach((item, index) => {
                let reviewHTML = `<div class="mb-6 p-4 border rounded-lg bg-slate-50">`;
                reviewHTML += `<p class="font-semibold mb-2">Câu ${index + 1}:</p><div class="prose max-w-none">${item.rendered_question}</div>`;
                const type = mapType(item.type);

                if (type === 'multiple-choice') {
                     reviewHTML += '<div class="mt-4 space-y-2">';
                     (item.rendered_options || []).forEach((opt, i) => {
                        let classes = 'option p-3 border-2 rounded-lg flex items-start bg-white';
                        if (i === item.correctAnswerIndex) classes += ' correct';
                        if (userAnswers[index] === i && i !== item.correctAnswerIndex) classes += ' incorrect';
                        reviewHTML += `<div class="${classes}"><span class="font-bold mr-2">${String.fromCharCode(65 + i)}.</span> <div>${opt}</div></div>`;
                     });
                     reviewHTML += '</div>';
                } else if (type === 'true-false') {
                     reviewHTML += '<div class="mt-4 space-y-2">';
                     (item.statements || []).forEach((stmt, i) => {
                         let classes = 'p-3 border-2 rounded-lg flex items-center justify-between gap-4 bg-white';
                         if ((userAnswers[index]?.[i]) === stmt.is_correct) classes += ' bg-green-50 border-green-300';
                         else if (userAnswers[index]?.[i] !== null) classes += ' bg-red-50 border-red-300';
                         reviewHTML += `<div class="${classes}"><div class="prose max-w-none">${stmt.rendered_statement}</div><div class="flex-shrink-0 font-bold text-sm text-right"><span>Đáp án: ${stmt.is_correct ? 'Đ' : 'S'}</span><br><span>Bạn chọn: ${userAnswers[index]?.[i] === true ? 'Đ' : userAnswers[index]?.[i] === false ? 'S' : '...'}</span></div></div>`;
                     });
                     reviewHTML += '</div>';
                } else {
                    reviewHTML += `<div class="mt-4 p-3 bg-slate-100 rounded-lg"><strong>Câu trả lời của bạn:</strong><br>${userAnswers[index] || '<em>Chưa trả lời</em>'}</div>`;
                    if (item.rendered_answer) reviewHTML += `<div class="mt-2 p-3 bg-blue-50 rounded-lg"><strong>Đáp án gợi ý:</strong><br><div class="prose max-w-none">${item.rendered_answer}</div></div>`;
                }
                
                if (options.showExplanation) {
                     reviewHTML += `<details class="mt-4 group"><summary class="text-sm font-medium text-blue-600 hover:underline cursor-pointer group-open:mb-2">Xem giải thích từ AI</summary><div id="explanation-${index}" class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg"></div></details>`;
                }
                reviewHTML += '</div>';
                reviewContainer.innerHTML += reviewHTML;
            });
            safeTypeset([reviewContainer]);
        }

        function retryQuiz() { retriesCount++; startQuiz(); }
        function startTimer() { stopTimer(); timerInterval = setInterval(() => { timeRemaining--; const minutes = Math.floor(timeRemaining / 60); const seconds = timeRemaining % 60; timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`; if (timeRemaining <= 0) { stopTimer(); alert('Đã hết thời gian!'); submitQuiz(); } }, 1000); }
        function stopTimer() { clearInterval(timerInterval); }
        function showWarning(msg) { warningEl.textContent = msg; warningEl.style.display = 'block'; warningEl.style.animation = 'none'; warningEl.offsetHeight; warningEl.style.animation = 'fade-in-out 5s ease-in-out';}
        function handleVisibilityChange() { if (document.hidden) { monitoringLog.thoatManHinh++; showWarning('⚠️ Đã phát hiện chuyển tab!'); } }
        function handleCopy() { monitoringLog.saoChep++; showWarning('⚠️ Đã phát hiện sao chép!'); }
        function handlePaste() { monitoringLog.dan++; showWarning('⚠️ Đã phát hiện dán!'); }
        function startMonitoring() { monitoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0 }; document.addEventListener('visibilitychange', handleVisibilityChange); document.addEventListener('copy', handleCopy); document.addEventListener('paste', handlePaste); }
        function stopMonitoring() { document.removeEventListener('visibilitychange', handleVisibilityChange); document.removeEventListener('copy', handleCopy); document.removeEventListener('paste', handlePaste); }

        reviewContainer.addEventListener('toggle', async (event) => {
            if (event.target.tagName === 'DETAILS' && event.target.open) {
                const explanationContainer = event.target.querySelector('[id^="explanation-"]');
                if (explanationContainer) {
                    const hasLoaded = explanationContainer.hasAttribute('data-loaded');
                    if (!hasLoaded || explanationContainer.getAttribute('data-loaded') === 'error') {
                        const index = parseInt(explanationContainer.id.split('-')[1], 10);
                        await fetchAndRenderExplanation(index);
                    }
                }
            }
        }, true);

        async function fetchAndRenderExplanation(index) {
            const el = document.getElementById(`explanation-${index}`);
            el.innerHTML = '<div class="animate-pulse text-sm text-slate-500">AI đang suy nghĩ...</div>';
            el.setAttribute('data-loaded', 'loading');
            if (!API_KEY) { el.innerHTML = '<p class="text-red-600">Lỗi: API Key chưa được cấu hình.</p>'; el.setAttribute('data-loaded', 'error'); return; }
            try {
                const ai = new GoogleGenAI({ apiKey: API_KEY });
                const item = quizData[index];
                const qText = (mapType(item.type) === 'true-false') ? (item.main_question || '') : (item.question || '');
                let prompt = `Giải thích chi tiết, từng bước cho câu hỏi sau:\n**CÂU HỎI:**\n${qText}\n---`;
                if (mapType(item.type) === 'multiple-choice') prompt += `\n**ĐÁP ÁN ĐÚNG:** ${String.fromCharCode(65 + item.correctAnswerIndex)}. ${item.options[item.correctAnswerIndex] || ''}`;
                else if (mapType(item.type) === 'true-false') prompt += `\n**CÁC MỆNH ĐỀ VÀ ĐÁP ÁN:**\n${item.statements.map((s, i) => `${String.fromCharCode(97 + i)}) ${s.statement || ''} -> ${s.is_correct ? 'Đúng' : 'Sai'}`).join('\n')}`;
                else prompt += `---\n**ĐÁP ÁN GỢI Ý:** ${item.answer || ''}`;
                prompt += `\n---\nYÊU CẦU: Dùng LaTeX cho công thức. Dùng **...** để in đậm.`;
                
                const response = await ai.models.generateContent({ model: "gemini-2.5-flash", contents: prompt });
                el.innerHTML = (response.text || "Không thể tạo giải thích.").replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                safeTypeset([el]);
                el.setAttribute('data-loaded', 'true');
            } catch (error) {
                console.error("AI Explanation Error:", error);
                let msg = "Lỗi khi tạo giải thích: " + error.message.replace(/</g, "&lt;");
                el.innerHTML = `<div class="text-red-600">${msg}</div><a href="#" onclick="event.preventDefault(); fetchAndRenderExplanation(${index})" class="text-sm text-blue-600 hover:underline mt-2">Thử lại</a>`;
                el.setAttribute('data-loaded', 'error');
            }
        }

        async function getAIAssessment(score, answerDetails) {
            if (!API_KEY) { assessmentDisplay.innerHTML = `<strong class="text-red-600">Lỗi: API Key chưa được cấu hình.</strong>`; assessmentDisplay.classList.remove('hidden'); return "Lỗi API Key"; }
            assessmentDisplay.innerHTML = '<strong>Nhận xét từ AI:</strong> <span class="animate-pulse">AI đang phân tích...</span>';
            assessmentDisplay.classList.remove('hidden');
            try {
                const ai = new GoogleGenAI({ apiKey: API_KEY });
                const wrongAnswers = answerDetails.filter(d => d.isCorrect === false);
                if (wrongAnswers.length === 0) return "Chúc mừng em đã hoàn thành xuất sắc! Em đã nắm vững kiến thức.";
                const wrongSummary = wrongAnswers.map(d => `- Câu ${d.questionNumber}: ${(quizData[d.questionNumber - 1].question || quizData[d.questionNumber - 1].main_question).substring(0, 50)}...`).join('\n');
                const prompt = `Bạn là một giáo viên AI. Dựa vào kết quả sau, hãy nhận xét (4-5 câu) về năng lực của học sinh.\n- Điểm số: ${score}/10\n- Các câu sai:\n${wrongSummary}\nYÊU CẦU: 1. Động viên. 2. Xác định mảng kiến thức còn yếu. 3. Gợi ý cách khắc phục. 4. Khích lệ. Giọng văn thân thiện.`;
                const response = await ai.models.generateContent({ model: "gemini-2.5-flash", contents: prompt });
                const assessmentText = response.text || "Không thể tạo nhận xét.";
                assessmentDisplay.innerHTML = `<strong>Nhận xét từ AI:</strong> <br> ${assessmentText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>')}`;
                return assessmentText;
            } catch (error) {
                console.error("AI Assessment Error:", error);
                let msg = "Lỗi khi AI tạo nhận xét: " + error.message.replace(/</g, "&lt;");
                assessmentDisplay.innerHTML = `<strong>Nhận xét từ AI:</strong> <br> <div class="text-red-600">${msg}</div><button onclick="retryAIAssessment()" class="text-sm text-blue-600 hover:underline mt-2">Thử lại</button>`;
                return "Lỗi khi tạo nhận xét AI.";
            }
        }
        
        async function retryAIAssessment() { if (lastAnswerDetails) await getAIAssessment(lastScore, lastAnswerDetails); }
    </script>
</body>
</html>
    