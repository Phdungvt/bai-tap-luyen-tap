<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đề kiểm tra toan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        window.MathJax = {
            tex: { packages: {'[+]': ['ams']}, inlineMath: [['$', '$']], displayMath: [['$$', '$$']] },
            chtml: { fontCache: 'global' }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    <style>
        body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #f3f4f6; }
        .question-card { background: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 1.5rem; }
        .option-label { font-weight: 600; margin-right: 0.5rem; }
        .correct-answer { color: #16a34a; font-weight: bold; }
        .wrong-answer { color: #dc2626; font-weight: bold; text-decoration: line-through; }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <div class="bg-indigo-600 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-lg font-bold">Đề kiểm tra toan</h1>
                <p class="text-xs opacity-90">Giáo viên: Giáo viên | Mã đề: 0HFDY9</p>
            </div>
            <div id="timer-display" class="text-xl font-mono font-bold bg-white/20 px-3 py-1 rounded">--:--</div>
        </div>
    </div>

    <div class="container mx-auto p-4 flex-grow max-w-3xl">
        <!-- Form nhập thông tin -->
        <div id="info-screen" class="bg-white p-6 rounded-xl shadow-md mb-6">
            <h2 class="text-xl font-bold mb-4 text-gray-800">Thông tin học sinh</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Họ và tên</label>
                    <input type="text" id="student-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Lớp</label>
                    <input type="text" id="student-class" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                </div>
                <button onclick="startExam()" class="w-full bg-indigo-600 text-white py-2 rounded-lg font-bold hover:bg-indigo-700 transition">BẮT ĐẦU LÀM BÀI</button>
            </div>
        </div>

        <!-- Khu vực làm bài -->
        <div id="exam-screen" class="hidden">
            <div id="questions-container"></div>
            <button onclick="submitExam()" id="submit-btn" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition mt-4 shadow-lg text-lg">NỘP BÀI</button>
        </div>

        <!-- Khu vực kết quả -->
        <div id="result-screen" class="hidden text-center bg-white p-8 rounded-xl shadow-md">
            <div class="mb-4">
                <svg class="w-16 h-16 text-green-500 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Đã nộp bài thành công!</h2>
            <p class="text-gray-600 mb-6">Cảm ơn em đã hoàn thành bài kiểm tra.</p>
            <div id="score-display" class="hidden mb-6">
                <p class="text-sm text-gray-500 uppercase">Điểm số của bạn</p>
                <p class="text-4xl font-black text-indigo-600" id="final-score">0.00</p>
            </div>
            <div id="ai-assessment" class="hidden text-left bg-blue-50 p-4 rounded-lg border border-blue-100 text-sm"></div>
        </div>
    </div>

    <script>
        const quizData = JSON.parse('[{"question":"Cho hàm số $y = x^3 - 3x^2 + 1$. Quan sát đồ thị hàm số sau: DT[B3][1][-3][0][1] Số điểm cực trị của hàm số đã cho là:","options":["1","2","3","0"],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"questionNumber":1},{"question":"Cho hàm số $y = -x^4 + 2x^2 + 3$. Quan sát bảng biến thiên sau: BBT[B4][-1][2][0][3] Hàm số đã cho đồng biến trên khoảng nào dưới đây?","options":["$(-1; 0)$ và $(1; +\\text{inf})$","$(-\\text{inf}; -1)$ và $(0; 1)$","$(-\\text{inf}; -1)$ và $(1; +\\text{inf})$","$(0; +\\text{inf})$"],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"questionNumber":2},{"question":"Giá trị cực tiểu của hàm số $y = -x^3 + 3x - 2$ là:","options":["0","-4","1","-2"],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"questionNumber":3},{"question":"Hàm số $y = \\\\dfrac{2x+1}{x-1}$ nghịch biến trên các khoảng nào?","options":["$(1; +\\text{inf})$","$(-\\text{inf}; 1)$ và $(1; +\\text{inf})$","$(-\\text{inf}; 1)$","$\\text{R} \\\\setminus \\\\{1\\\\}$"],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"questionNumber":4},{"question":"Cho hàm số $y = f(x)$ có đạo hàm $f\'(x) = x^2 - 2x - 3$. Quan sát đồ thị hàm số $y = f\'(x)$ sau: DT[B2][1][-2][-3] Hàm số $y = f(x)$ đồng biến trên khoảng nào dưới đây?","options":["$(-1; 3)$","$(-\\text{inf}; -1)$ và $(3; +\\text{inf})$","$(-\\text{inf}; 1)$","$(1; +\\text{inf})$"],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"questionNumber":5}]');
        const config = {"title":"Đề kiểm tra toan","timeLimit":45,"examCode":"0HFDY9","googleScriptUrl":"https://script.google.com/macros/s/AKfycbzuY4eIahyu7rl9BvXtMgtr5l3wDv1L0SBUX61_o8VLwMDDPddaEQrITr3Oj5h-6bvt/exec","teacherName":"Giáo viên","showAnswers":true,"showExplanation":true,"enableAiAssessment":true,"pointsConfig":{"mc":5,"tf":2,"sa":2,"essay":1,"tfMethod":"progressive"}};
        let studentAnswers = {};
        let timeRemaining = config.timeLimit * 60;
        let timerInterval;

        function startExam() {
            const name = document.getElementById('student-name').value.trim();
            const className = document.getElementById('student-class').value.trim();
            if (!name || !className) {
                alert("Vui lòng điền đầy đủ Họ tên và Lớp.");
                return;
            }
            document.getElementById('info-screen').classList.add('hidden');
            document.getElementById('exam-screen').classList.remove('hidden');
            renderQuestions();
            if (config.timeLimit > 0) {
                startTimer();
            } else {
                document.getElementById('timer-display').textContent = "∞";
            }
        }

        function startTimer() {
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    alert("Hết giờ làm bài!");
                    submitExam();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const m = Math.floor(timeRemaining / 60);
            const s = timeRemaining % 60;
            document.getElementById('timer-display').textContent = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function renderQuestions() {
            const container = document.getElementById('questions-container');
            quizData.forEach((q, index) => {
                const card = document.createElement('div');
                card.className = 'question-card';
                let html = `<div class="mb-3 font-medium text-gray-800"><span class="font-bold text-indigo-600">Câu ${index + 1}:</span> ${q.question || q.main_question}</div>`;
                
                if (q.questionImage) {
                    html += `<img src="${q.questionImage}" class="max-h-48 my-2 rounded border mx-auto block">`;
                }

                if (q.type === 'multiple-choice') {
                    html += '<div class="space-y-2">';
                    q.options.forEach((opt, i) => {
                         const imgHtml = (q.optionsImage && q.optionsImage[i]) ? `<br><img src="${q.optionsImage[i]}" class="h-20 mt-1 rounded border">` : '';
                        html += `
                            <label class="flex items-start p-2 rounded hover:bg-gray-50 cursor-pointer border border-transparent hover:border-gray-200">
                                <input type="radio" name="q${index}" value="${i}" class="mt-1 mr-3" onchange="saveAnswer(${index}, ${i})">
                                <span><span class="option-label">${String.fromCharCode(65+i)}.</span>${opt}${imgHtml}</span>
                            </label>`;
                    });
                    html += '</div>';
                } else if (q.type === 'true-false') {
                    html += `
                        <table class="w-full text-sm mt-3 border-collapse">
                            <thead class="bg-gray-100"><tr><th class="border p-2 text-left">Mệnh đề</th><th class="border p-2 w-16 text-center">Đúng</th><th class="border p-2 w-16 text-center">Sai</th></tr></thead>
                            <tbody>
                                ${q.statements.map((stmt, i) => `
                                    <tr>
                                        <td class="border p-2">${String.fromCharCode(97+i)}) ${stmt.statement}</td>
                                        <td class="border p-2 text-center"><input type="radio" name="q${index}_s${i}" value="true" onchange="saveTFAnswer(${index}, ${i}, true)"></td>
                                        <td class="border p-2 text-center"><input type="radio" name="q${index}_s${i}" value="false" onchange="saveTFAnswer(${index}, ${i}, false)"></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else if (q.type === 'short-answer') {
                    html += `<input type="text" class="w-full border border-gray-300 rounded p-2 mt-2 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Nhập câu trả lời của bạn..." onchange="saveAnswer(${index}, this.value)">`;
                } else {
                     html += `<textarea class="w-full border border-gray-300 rounded p-2 mt-2 focus:ring-2 focus:ring-indigo-500 outline-none" rows="4" placeholder="Nhập câu trả lời tự luận..." onchange="saveAnswer(${index}, this.value)"></textarea>`;
                }
                
                card.innerHTML = html;
                container.appendChild(card);
            });
            if(window.MathJax) window.MathJax.typesetPromise();
        }

        function saveAnswer(qIndex, value) {
            studentAnswers[qIndex] = value;
        }

        function saveTFAnswer(qIndex, sIndex, value) {
            if (!studentAnswers[qIndex]) studentAnswers[qIndex] = {};
            studentAnswers[qIndex][sIndex] = value;
        }

        async function submitExam() {
            clearInterval(timerInterval);
            document.getElementById('submit-btn').disabled = true;
            document.getElementById('submit-btn').textContent = "Đang nộp bài...";

            // Tính điểm sơ bộ (client-side grading for immediate feedback if enabled)
            let score = 0;
            let totalPoints = 0;
            let detailedResult = [];

            // Logic tính điểm chi tiết (giống export-manager.js cũ nhưng rút gọn)
            quizData.forEach((q, idx) => {
                let qScore = 0;
                let qMaxScore = 0;
                let isCorrect = false;
                
                if (q.type === 'multiple-choice') {
                    qMaxScore = config.pointsConfig.mc / (quizData.filter(x=>x.type==='multiple-choice').length || 1); 
                    if (studentAnswers[idx] == q.correctAnswerIndex) {
                        qScore = qMaxScore;
                        isCorrect = true;
                    }
                    detailedResult.push({ questionNumber: idx+1, type: 'mc', isCorrect, score: qScore });
                } else if (q.type === 'true-false') {
                     // Logic tính điểm Đ/S lũy tiến
                     const totalTF = quizData.filter(x=>x.type==='true-false').length || 1;
                     qMaxScore = config.pointsConfig.tf / totalTF;
                     let correctCount = 0;
                     let userAns = studentAnswers[idx] || {};
                     let details = [];
                     q.statements.forEach((stmt, sIdx) => {
                         const uA = userAns[sIdx];
                         const correct = (uA === stmt.is_correct);
                         if(correct) correctCount++;
                         details.push({id: sIdx, isCorrect: correct});
                     });
                     
                     if(config.pointsConfig.tfMethod === 'progressive') {
                         if(correctCount === 1) qScore = 0.1;
                         else if(correctCount === 2) qScore = 0.25;
                         else if(correctCount === 3) qScore = 0.5;
                         else if(correctCount === 4) qScore = qMaxScore; // thường là 1 điểm
                     } else {
                         qScore = (correctCount / 4) * qMaxScore;
                     }
                     detailedResult.push({ questionNumber: idx+1, type: 'true-false', score: qScore, details: details });
                }
                 // ... (Logic for other types can be added here)
                 
                 score += qScore;
            });

            // Gửi kết quả về Google Script
            try {
                await fetch(config.googleScriptUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'submit_result',
                        timestamp: new Date().toLocaleString('vi-VN'),
                        name: document.getElementById('student-name').value,
                        class: document.getElementById('student-class').value,
                        score: score.toFixed(2),
                        answerDetails: JSON.stringify(detailedResult),
                        examCode: config.examCode
                    })
                });
            } catch (e) {
                console.error("Lỗi gửi kết quả:", e);
            }

            // Hiển thị kết quả
            document.getElementById('exam-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            
            if (config.showAnswers) {
                document.getElementById('score-display').classList.remove('hidden');
                document.getElementById('final-score').textContent = score.toFixed(2);
            }
        }
    </script>
</body>
</html>