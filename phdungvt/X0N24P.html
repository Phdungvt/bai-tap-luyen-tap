
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bài kiểm tra - 14/11/2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f5f7; }
        .option.selected { border-color: #3b82f6; background-color: #eff6ff; }
        .option.correct { border-color: #22c55e; background-color: #f0fdf4; }
        .option.incorrect { border-color: #ef4444; background-color: #fef2f2; }
        .disabled { pointer-events: none; opacity: 0.7; }
        .monitoring-warning { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background-color: #ef4444; color: white; padding: 10px 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; display: none; animation: fade-in-out 5s ease-in-out; }
        @keyframes fade-in-out { 0%, 100% { opacity: 0; transform: translate(-50%, -20px); } 10%, 90% { opacity: 1; transform: translate(-50%, 0); } }
        /* MathJax basic styling */
        mjx-container { display: inline-block !important; }
        .prose img.latex-image { display: inline-block; vertical-align: middle; }
    </style>
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\(', '\)']], displayMath: [['$$', '$$'], ['\[', '\]']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    <script type="importmap">
    { "imports": { "@google/genai": "https://esm.sh/@google/genai" } }
    </script>
</head>
<body class="p-4 md:p-8">
    <div id="app" class="max-w-4xl mx-auto bg-white p-6 rounded-2xl shadow-lg">
        
        <div id="welcome-screen">
            <h1 class="text-3xl font-bold text-gray-800">Bài kiểm tra - 14/11/2025</h1>
            <p class="mt-2 text-gray-600">Mã đề: <span class="font-bold text-indigo-600">X0N24P</span></p>
            <hr class="my-6">
            <div class="space-y-4">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">Họ và tên</label>
                    <input type="text" id="name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="class" class="block text-sm font-medium text-gray-700">Lớp</label>
                    <input type="text" id="class" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>
             <p class="mt-4 text-sm text-red-600"><strong>Lưu ý:</strong> Hệ thống sẽ giám sát việc chuyển tab, sao chép/dán. Các hành vi này sẽ được ghi lại và báo cáo cho giáo viên.</p>
            <button id="start-btn" class="mt-6 w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-indigo-700">Bắt đầu làm bài</button>
        </div>

        <div id="quiz-screen" class="hidden">
             <div class="flex justify-between items-center mb-4 sticky top-0 bg-white py-4 z-10 border-b -mx-6 px-6">
                <h2 class="text-2xl font-bold text-gray-800">Bài kiểm tra - 14/11/2025</h2>
                <div id="timer" class="text-xl font-bold text-red-500 bg-red-100 px-4 py-2 rounded-lg"></div>
            </div>
            <div id="all-questions-container" class="mt-6"></div>
            <div class="mt-8 flex justify-end">
                <button id="submit-btn" class="bg-green-600 text-white py-3 px-8 rounded-lg font-semibold hover:bg-green-700 text-lg">Nộp bài</button>
            </div>
        </div>

        <div id="results-screen" class="hidden">
            <h2 class="text-3xl font-bold text-center text-gray-800">Kết quả bài làm</h2>
            <div id="score-display" class="hidden text-center text-5xl font-bold text-blue-600 my-6"></div>
            <div id="assessment-display" class="hidden mt-4 p-4 bg-gray-100 rounded-lg text-gray-700"></div>
            <div id="review-container" class="mt-8"></div>
            <div class="mt-8 text-center space-x-4">
                <button id="retry-btn" class="hidden bg-indigo-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-indigo-700">Làm lại bài</button>
                <button id="restart-btn" class="bg-gray-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-gray-600">Về trang chủ</button>
            </div>
        </div>
        
        <div id="monitoring-warning" class="monitoring-warning">⚠️ Đã phát hiện hành vi không hợp lệ!</div>
    </div>

    <script type="module">
        import { GoogleGenAI } from "@google/genai";

        const API_KEY = "AIzaSyAzvr2Py2_mr5Z4R3YWXi-dyO1ufA2paas";
        const quizData = [{"question":"Đổi số đo góc $150^{\\circ}$ sang radian.","options":["$\\dfrac{2\\pi}{3}$","$\\dfrac{5\\pi}{6}$","$\\dfrac{3\\pi}{4}$","$\\dfrac{7\\pi}{12}$"],"correctAnswerIndex":1,"type":"multiple-choice","questionNumber":1,"isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Đổi số đo góc $150^{\\circ}$ sang radian.","rendered_options":["$\\dfrac{2\\pi}{3}$","$\\dfrac{5\\pi}{6}$","$\\dfrac{3\\pi}{4}$","$\\dfrac{7\\pi}{12}$"]},{"question":"Một cung tròn có bán kính $R = 9 \\text{ cm}$ và có số đo $90^{\\circ}$. Tính độ dài của cung tròn đó.","options":["$\\dfrac{9\\pi}{2} \\text{ cm}$ ","$","$","$"],"correctAnswerIndex":0,"type":"multiple-choice","questionNumber":2,"isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Một cung tròn có bán kính $R = 9 \\text{ cm}$ và có số đo $90^{\\circ}$. Tính độ dài của cung tròn đó.","rendered_options":["$\\dfrac{9\\pi}{2} \\text{ cm}$ ","$","$","$"]},{"question":"Công thức nào sau đây biểu diễn định lí Pytago cho tam giác vuông có hai cạnh góc vuông là $a$, $b$ và cạnh huyền là $c$?","options":["$a^2 + b^2 = c^2$","$(a + b)^2 = c^2$","$a^2 - b^2 = c^2$","$(a - b)^2 = c^2$"],"correctAnswerIndex":0,"type":"multiple-choice","questionNumber":3,"isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Công thức nào sau đây biểu diễn định lí Pytago cho tam giác vuông có hai cạnh góc vuông là $a$, $b$ và cạnh huyền là $c$?","rendered_options":["$a^2 + b^2 = c^2$","$(a + b)^2 = c^2$","$a^2 - b^2 = c^2$","$(a - b)^2 = c^2$"]},{"question":"Công thức nghiệm tổng quát của phương trình $\\cos x = -\\dfrac{\\sqrt{3}}{2}$ là:","options":["$x = \\dfrac{5\\pi}{6} + k2\\pi$ và $x = -\\dfrac{5\\pi}{6} + k2\\pi$ ($k \\in \\mathbb{Z}$)","$x = \\dfrac{\\pi}{6} + k2\\pi$ và $x = -\\dfrac{\\pi}{6} + k2\\pi$ ($k \\in \\mathbb{Z}$)","$x = \\dfrac{5\\pi}{6} + k\\pi$ và $x = -\\dfrac{5\\pi}{6} + k\\pi$ ($k \\in \\mathbb{Z}$)","$x = \\dfrac{2\\pi}{3} + k2\\pi$ và $x = -\\dfrac{2\\pi}{3} + k2\\pi$ ($k \\in \\mathbb{Z}$)"],"correctAnswerIndex":0,"type":"multiple-choice","questionNumber":4,"isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Công thức nghiệm tổng quát của phương trình $\\cos x = -\\dfrac{\\sqrt{3}}{2}$ là:","rendered_options":["$x = \\dfrac{5\\pi}{6} + k2\\pi$ và $x = -\\dfrac{5\\pi}{6} + k2\\pi$ ($k \\in \\mathbb{Z}$)","$x = \\dfrac{\\pi}{6} + k2\\pi$ và $x = -\\dfrac{\\pi}{6} + k2\\pi$ ($k \\in \\mathbb{Z}$)","$x = \\dfrac{5\\pi}{6} + k\\pi$ và $x = -\\dfrac{5\\pi}{6} + k\\pi$ ($k \\in \\mathbb{Z}$)","$x = \\dfrac{2\\pi}{3} + k2\\pi$ và $x = -\\dfrac{2\\pi}{3} + k2\\pi$ ($k \\in \\mathbb{Z}$)"]},{"question":"Cho dãy số $\\left( u_{n} \\right)$ với công thức số hạng tổng quát là $u_{n} = 3n - 2$. Bốn số hạng đầu tiên của dãy số đó là:","options":["$1, 4, 7, 10$","$-1, 2, 5, 8$","$-2, 1, 4, 7$","$-1, 0, 1, 2$"],"correctAnswerIndex":0,"type":"multiple-choice","questionNumber":5,"isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Cho dãy số $\\left( u_{n} \\right)$ với công thức số hạng tổng quát là $u_{n} = 3n - 2$. Bốn số hạng đầu tiên của dãy số đó là:","rendered_options":["$1, 4, 7, 10$","$-1, 2, 5, 8$","$-2, 1, 4, 7$","$-1, 0, 1, 2$"]},{"question":"Dãy số nào sau đây là cấp số cộng?","options":["$2, 6, 18, 54, \\ldots$","$1, 3, 7, 13, \\ldots$","$5, 9, 13, 17, \\ldots$","$10, 8, 5, 1, \\ldots$"],"correctAnswerIndex":2,"type":"multiple-choice","questionNumber":6,"isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Dãy số nào sau đây là cấp số cộng?","rendered_options":["$2, 6, 18, 54, \\ldots$","$1, 3, 7, 13, \\ldots$","$5, 9, 13, 17, \\ldots$","$10, 8, 5, 1, \\ldots$"]},{"question":"Cho cấp số nhân $u_n$ có số hạng đầu $u_1 = 5$ và công bội $q = 3$. Tìm số hạng thứ $u_4$.","options":["45","135","120","150"],"correctAnswerIndex":1,"type":"multiple-choice","questionNumber":7,"isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Cho cấp số nhân $u_n$ có số hạng đầu $u_1 = 5$ và công bội $q = 3$. Tìm số hạng thứ $u_4$.","rendered_options":["45","135","120","150"]},{"question":"Cho bảng tần số ghép nhóm sau. Nhóm nào chứa Mốt của mẫu số liệu?$$ \\begin{array}{|c|c|} \\hline \\textbf{Lớp ghép nhóm} & \\textbf{Tần số} \\\\ \\hline [1; 2) & 6 \\\\ \\hline [2; 3) & 10 \\\\ \\hline [3; 4) & 15 \\\\ \\hline [4; 5) & 9 \\\\ \\hline [5; 6) & 4 \\\\ \\hline \\end{array} $$","options":["$[1; 2)$","$[2; 3)$","$[3; 4)$","$[4; 5)$"],"correctAnswerIndex":2,"type":"multiple-choice","questionNumber":8,"isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Cho bảng tần số ghép nhóm sau. Nhóm nào chứa Mốt của mẫu số liệu?$$ \\begin{array}{|c|c|} \\hline \\textbf{Lớp ghép nhóm} & \\textbf{Tần số} \\\\ \\hline [1; 2) & 6 \\\\ \\hline [2; 3) & 10 \\\\ \\hline [3; 4) & 15 \\\\ \\hline [4; 5) & 9 \\\\ \\hline [5; 6) & 4 \\\\ \\hline \\end{array} $$","rendered_options":["$[1; 2)$","$[2; 3)$","$[3; 4)$","$[4; 5)$"]},{"question":"Tập xác định của hàm số $y = \text{cot } x$ là gì?","options":["$D = \\mathbb{R} \\setminus \\left\\{ k\\pi \\mid k \\in \\mathbb{Z} \\right\\}$","$(\\pi; 2\\pi)$","$(0; \\pi)$","$(-\\infty; +\\infty)$"],"correctAnswerIndex":0,"type":"multiple-choice","questionNumber":9,"isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Tập xác định của hàm số $y = \text{cot } x$ là gì?","rendered_options":["$D = \\mathbb{R} \\setminus \\left\\{ k\\pi \\mid k \\in \\mathbb{Z} \\right\\}$","$(\\pi; 2\\pi)$","$(0; \\pi)$","$(-\\infty; +\\infty)$"]},{"question":"Điểm cuối của góc lượng giác có số đo $\\pi$ trên đường tròn lượng giác là điểm nào?","options":["$(1; 0)$","$(0; 1)$","$(0; -1)$","$( -1; 0)$"],"correctAnswerIndex":3,"type":"multiple-choice","questionNumber":10,"isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Điểm cuối của góc lượng giác có số đo $\\pi$ trên đường tròn lượng giác là điểm nào?","rendered_options":["$(1; 0)$","$(0; 1)$","$(0; -1)$","$( -1; 0)$"]},{"question":"Cho cấp số nhân $(u_n)$ có $u_2 = 5$ và $u_4 = 45$. Công bội của cấp số nhân đã cho là","options":["$q = 3$","Tôi $q = 5$","Tôi $q = 9$","Tôi $q = 2$"],"correctAnswerIndex":0,"type":"multiple-choice","questionNumber":11,"isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Cho cấp số nhân $(u_n)$ có $u_2 = 5$ và $u_4 = 45$. Công bội của cấp số nhân đã cho là","rendered_options":["$q = 3$","Tôi $q = 5$","Tôi $q = 9$","Tôi $q = 2$"]},{"question":"Cho mẫu số liệu ghép nhóm về số tiền (đơn vị: nghìn đồng) mà một nhóm học sinh chi tiêu trong một tháng như sau:$$ \\begin{array}{|c|c|} \\hline \\text{Số tiền (nghìn đồng)} & \\text{Số học sinh} \\\\ \\hline [50; 100) & 10 \\\\ \\hline [100; 150) & 15 \\\\ \\hline [150; 200) & 12 \\\\ \\hline [200; 250) & 8 \\\\ \\hline \\end{array} $$Số trung bình của mẫu số liệu ghép nhóm này là","options":["140","145","150","155"],"correctAnswerIndex":1,"type":"multiple-choice","questionNumber":12,"isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Cho mẫu số liệu ghép nhóm về số tiền (đơn vị: nghìn đồng) mà một nhóm học sinh chi tiêu trong một tháng như sau:$$ \\begin{array}{|c|c|} \\hline \\text{Số tiền (nghìn đồng)} & \\text{Số học sinh} \\\\ \\hline [50; 100) & 10 \\\\ \\hline [100; 150) & 15 \\\\ \\hline [150; 200) & 12 \\\\ \\hline [200; 250) & 8 \\\\ \\hline \\end{array} $$Số trung bình của mẫu số liệu ghép nhóm này là","rendered_options":["140","145","150","155"]},{"main_question":"Cho hàm số $y = \\cos x$. Hãy xác định các mệnh đề sau là đúng hay sai.","statements":[{"statement":"Tập xác định của hàm số $y = \\cos x$ là $D = \\mathbb{R}$.","is_correct":true,"rendered_statement":"Tập xác định của hàm số $y = \\cos x$ là $D = \\mathbb{R}$."},{"statement":"Tập giá trị của hàm số $y = \\cos x$ là $\\left[-1; 1\\right]$.","is_correct":true,"rendered_statement":"Tập giá trị của hàm số $y = \\cos x$ là $\\left[-1; 1\\right]$."},{"statement":"Hàm số $y = \\cos x$ là hàm số chẵn.","is_correct":true,"rendered_statement":"Hàm số $y = \\cos x$ là hàm số chẵn."},{"statement":"Hàm số $y = \\cos x$ là hàm số tuần hoàn với chu kì $T = \\pi$.","is_correct":false,"rendered_statement":"Hàm số $y = \\cos x$ là hàm số tuần hoàn với chu kì $T = \\pi$."}],"type":"true-false","questionNumber":13,"isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Cho hàm số $y = \\cos x$. Hãy xác định các mệnh đề sau là đúng hay sai."},{"main_question":"Cho cấp số cộng có các số hạng là ${u_n}$.","statements":[{"statement":"Nếu cấp số cộng có số hạng đầu $u_1 = 3$ và công sai $d = 4$, thì số hạng thứ hai là $u_2 = 7$.","is_correct":true,"rendered_statement":"Nếu cấp số cộng có số hạng đầu $u_1 = 3$ và công sai $d = 4$, thì số hạng thứ hai là $u_2 = 7$."},{"statement":"Nếu cấp số cộng có số hạng đầu $u_1 = 2$ và công sai $d = 3$, thì số hạng thứ $4$ là $u_4 = 11$.","is_correct":true,"rendered_statement":"Nếu cấp số cộng có số hạng đầu $u_1 = 2$ và công sai $d = 3$, thì số hạng thứ $4$ là $u_4 = 11$."},{"statement":"Nếu cấp số cộng có số hạng đầu $u_1 = 5$ và công sai $d = -1$, thì tổng của $3$ số hạng đầu tiên là $S_3 = 10$.","is_correct":false,"rendered_statement":"Nếu cấp số cộng có số hạng đầu $u_1 = 5$ và công sai $d = -1$, thì tổng của $3$ số hạng đầu tiên là $S_3 = 10$."},{"statement":"Trong một cấp số cộng, nếu $u_2 = 6$ và $u_4 = 10$, thì số hạng $u_3 = 8$.","is_correct":true,"rendered_statement":"Trong một cấp số cộng, nếu $u_2 = 6$ và $u_4 = 10$, thì số hạng $u_3 = 8$."}],"type":"true-false","questionNumber":14,"isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Cho cấp số cộng có các số hạng là ${u_n}$."},{"question":"Đầu kim phút của một chiếc đồng hồ có chiều dài $15 \\text{ cm}$. Khi kim phút quay một góc $45^{\\circ}$ quanh tâm, tính quãng đường mà đầu kim phút đó đã di chuyển (làm tròn kết quả đến hai chữ số thập phân).","answer":"Để tính quãng đường mà đầu kim phút đã di chuyển, ta sử dụng công thức độ dài cung $L = R\\alpha$, trong đó $R$ là chiều dài kim phút (bán kính) và $\\alpha$ là góc ở tâm tính bằng radian. Bước 1: Chuyển đổi góc từ độ sang radian. Ta có $\\alpha = 45^{\\circ}$. Đổi sang radian: $\\alpha = 45 \\cdot \\dfrac{\\pi}{180} = \\dfrac{\\pi}{4} \\text{ (rad)}$. Bước 2: Áp dụng công thức tính độ dài cung. Với $R = 15 \\text{ cm}$ và $\\alpha = \\dfrac{\\pi}{4} \\text{ rad}$, ta có: $L = R\\alpha = 15 \\cdot \\dfrac{\\pi}{4} = \\dfrac{15\\pi}{4} \\text{ (cm)}$. Bước 3: Làm tròn kết quả đến hai chữ số thập phân. $L \\approx 11,78097... \\approx 11,78 \\text{ (cm)}$. Vậy quãng đường mà đầu kim phút đó đã di chuyển là $11,78 \\text{ cm}$.","type":"short-answer","questionNumber":15,"isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Đầu kim phút của một chiếc đồng hồ có chiều dài $15 \\text{ cm}$. Khi kim phút quay một góc $45^{\\circ}$ quanh tâm, tính quãng đường mà đầu kim phút đó đã di chuyển (làm tròn kết quả đến hai chữ số thập phân).","rendered_answer":"Để tính quãng đường mà đầu kim phút đã di chuyển, ta sử dụng công thức độ dài cung $L = R\\alpha$, trong đó $R$ là chiều dài kim phút (bán kính) và $\\alpha$ là góc ở tâm tính bằng radian. Bước 1: Chuyển đổi góc từ độ sang radian. Ta có $\\alpha = 45^{\\circ}$. Đổi sang radian: $\\alpha = 45 \\cdot \\dfrac{\\pi}{180} = \\dfrac{\\pi}{4} \\text{ (rad)}$. Bước 2: Áp dụng công thức tính độ dài cung. Với $R = 15 \\text{ cm}$ và $\\alpha = \\dfrac{\\pi}{4} \\text{ rad}$, ta có: $L = R\\alpha = 15 \\cdot \\dfrac{\\pi}{4} = \\dfrac{15\\pi}{4} \\text{ (cm)}$. Bước 3: Làm tròn kết quả đến hai chữ số thập phân. $L \\approx 11,78097... \\approx 11,78 \\text{ (cm)}$. Vậy quãng đường mà đầu kim phút đó đã di chuyển là $11,78 \\text{ cm}$."},{"question":"Kết quả khảo sát điểm kiểm tra giữa kì môn Toán (thang điểm 10) của một nhóm học sinh được cho trong bảng tần số ghép nhóm sau:$$ \\begin{array}{|l|c|c|c|c|c|c|} \\hline \\text{Điểm} & [0;2) & [2;4) & [4;6) & [6;8) & [8;10) & \\text{Tổng} \\\\ \\hline \\text{Số học sinh} & 5 & 10 & 20 & 15 & 10 & 60 \\\\ \\hline \\end{array} $$Hãy xác định lớp chứa tứ phân vị thứ hai ($Q_2$) của mẫu số liệu trên.","answer":"Lớp chứa tứ phân vị thứ hai ($Q_2$) là lớp $[4; 6).","type":"short-answer","questionNumber":16,"isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Kết quả khảo sát điểm kiểm tra giữa kì môn Toán (thang điểm 10) của một nhóm học sinh được cho trong bảng tần số ghép nhóm sau:$$ \\begin{array}{|l|c|c|c|c|c|c|} \\hline \\text{Điểm} & [0;2) & [2;4) & [4;6) & [6;8) & [8;10) & \\text{Tổng} \\\\ \\hline \\text{Số học sinh} & 5 & 10 & 20 & 15 & 10 & 60 \\\\ \\hline \\end{array} $$Hãy xác định lớp chứa tứ phân vị thứ hai ($Q_2$) của mẫu số liệu trên.","rendered_answer":"Lớp chứa tứ phân vị thứ hai ($Q_2$) là lớp $[4; 6)."},{"question":"Giải phương trình lượng giác $\\sin x = -\\dfrac{\\sqrt{2}}{2}$.","answer":"Để giải phương trình $\\sin x = -\\dfrac{\\sqrt{2}}{2}$, ta thực hiện các bước sau:Bước 1: Tìm góc đặc biệt.Ta biết rằng $\\sin \\left(-\\dfrac{\\pi}{4}\\right) = -\\dfrac{\\sqrt{2}}{2}$.Bước 2: Áp dụng công thức nghiệm tổng quát của phương trình $\\sin x = \\sin \\alpha$.Công thức nghiệm tổng quát là $x = \\alpha + k2\\pi$ và $x = \\pi - \\alpha + k2\\pi$, với $k \\in \\mathbb{Z}$.Bước 3: Thay giá trị góc vào công thức nghiệm.Từ đó, phương trình đã cho có các nghiệm là:$x = -\\dfrac{\\pi}{4} + k2\\pi$, $k \\in \\mathbb{Z}$hoặc$x = \\pi - \\left(-\\dfrac{\\pi}{4}\\right) + k2\\pi = \\dfrac{5\\pi}{4} + k2\\pi$, $k \\in \\mathbb{Z}$Vậy, tập nghiệm của phương trình là $\\left\\{ -\\dfrac{\\pi}{4} + k2\\pi, \\dfrac{5\\pi}{4} + k2\\pi \\mid k \\in \\mathbb{Z} \\right\\}$.","type":"essay","questionNumber":17,"isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Giải phương trình lượng giác $\\sin x = -\\dfrac{\\sqrt{2}}{2}$.","rendered_answer":"Để giải phương trình $\\sin x = -\\dfrac{\\sqrt{2}}{2}$, ta thực hiện các bước sau:Bước 1: Tìm góc đặc biệt.Ta biết rằng $\\sin \\left(-\\dfrac{\\pi}{4}\\right) = -\\dfrac{\\sqrt{2}}{2}$.Bước 2: Áp dụng công thức nghiệm tổng quát của phương trình $\\sin x = \\sin \\alpha$.Công thức nghiệm tổng quát là $x = \\alpha + k2\\pi$ và $x = \\pi - \\alpha + k2\\pi$, với $k \\in \\mathbb{Z}$.Bước 3: Thay giá trị góc vào công thức nghiệm.Từ đó, phương trình đã cho có các nghiệm là:$x = -\\dfrac{\\pi}{4} + k2\\pi$, $k \\in \\mathbb{Z}$hoặc$x = \\pi - \\left(-\\dfrac{\\pi}{4}\\right) + k2\\pi = \\dfrac{5\\pi}{4} + k2\\pi$, $k \\in \\mathbb{Z}$Vậy, tập nghiệm của phương trình là $\\left\\{ -\\dfrac{\\pi}{4} + k2\\pi, \\dfrac{5\\pi}{4} + k2\\pi \\mid k \\in \\mathbb{Z} \\right\\}$."},{"question":"Cho một cấp số cộng có số hạng thứ $3$ là $u_3 = 8$ và số hạng thứ $7$ là $u_{7} = 20$. Hãy tìm công sai $d$ và số hạng đầu $u_1$ của cấp số cộng đó.","answer":"Theo công thức số hạng tổng quát của cấp số cộng, ta có: $u_n = u_1 + (n-1)d$.\n\nÁp dụng công thức này cho $u_3$ và $u_{7}$, ta được hệ phương trình:\n$$\\begin{cases} u_3 = u_1 + (3-1)d \\\\ u_{7} = u_1 + (7-1)d \\end{cases} \\Leftrightarrow \\begin{cases} u_1 + 2d = 8 \\quad (1) \\\\ u_1 + 6d = 20 \\quad (2) \\end{cases}$$\n\nTrừ phương trình $(1)$ cho phương trình $(2)$ vế theo vế, ta được:\n$(u_1 + 6d) - (u_1 + 2d) = 20 - 8$\n$4d = 12$\n$d = \\dfrac{12}{4}$\n$d = 3$\n\nThay $d = 3$ vào phương trình $(1)$, ta có:\n$u_1 + 2 \\cdot 3 = 8$\n$u_1 + 6 = 8$\n$u_1 = 8 - 6$\n$u_1 = 2$\n\nVậy công sai của cấp số cộng là $d = 3$ và số hạng đầu là $u_1 = 2$.","type":"essay","questionNumber":18,"isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Cho một cấp số cộng có số hạng thứ $3$ là $u_3 = 8$ và số hạng thứ $7$ là $u_{7} = 20$. Hãy tìm công sai $d$ và số hạng đầu $u_1$ của cấp số cộng đó.","rendered_answer":"Theo công thức số hạng tổng quát của cấp số cộng, ta có: $u_n = u_1 + (n-1)d$.<br><br>Áp dụng công thức này cho $u_3$ và $u_{7}$, ta được hệ phương trình:<br>$$\\begin{cases} u_3 = u_1 + (3-1)d \\\\ u_{7} = u_1 + (7-1)d \\end{cases} \\Leftrightarrow \\begin{cases} u_1 + 2d = 8 \\quad (1) \\\\ u_1 + 6d = 20 \\quad (2) \\end{cases}$$<br><br>Trừ phương trình $(1)$ cho phương trình $(2)$ vế theo vế, ta được:<br>$(u_1 + 6d) - (u_1 + 2d) = 20 - 8$<br>$4d = 12$<br>$d = \\dfrac{12}{4}$<br>$d = 3$<br><br>Thay $d = 3$ vào phương trình $(1)$, ta có:<br>$u_1 + 2 \\cdot 3 = 8$<br>$u_1 + 6 = 8$<br>$u_1 = 8 - 6$<br>$u_1 = 2$<br><br>Vậy công sai của cấp số cộng là $d = 3$ và số hạng đầu là $u_1 = 2$."},{"question":"Giải phương trình lượng giác $2\\cos^2 x + \\cos x - 1 = 0$.","answer":"Để giải phương trình $2\\cos^2 x + \\cos x - 1 = 0$, ta thực hiện các bước sau:\n\nBước 1: Đặt ẩn phụ.\nĐặt $t = \\cos x$. Vì $-1 \\le \\cos x \\le 1$ nên điều kiện của $t$ là $-1 \\le t \\le 1$.\nPhương trình đã cho trở thành phương trình bậc hai theo $t$: $2t^2 + t - 1 = 0$.\n\nBước 2: Giải phương trình bậc hai theo $t$.\nTa tính delta: $\\Delta = 1^2 - 4 \\cdot 2 \\cdot (-1) = 1 + 8 = 9$. \nVì $\\Delta > 0$, phương trình có hai nghiệm phân biệt:\n$t_1 = \\dfrac{-1 + \\sqrt{9}}{2 \\cdot 2} = \\dfrac{-1+3}{4} = \\dfrac{2}{4} = \\dfrac{1}{2}$.\n$t_2 = \\dfrac{-1 - \\sqrt{9}}{2 \\cdot 2} = \\dfrac{-1-3}{4} = \\dfrac{-4}{4} = -1$.\nCả hai nghiệm $t=\\dfrac{1}{2}$ và $t=-1$ đều thỏa mãn điều kiện $-1 \\le t \\le 1$.\n\nBước 3: Giải các phương trình lượng giác cơ bản.\nTrường hợp 1: $t = \\dfrac{1}{2} \\Rightarrow \\cos x = \\dfrac{1}{2}$.\nNghiệm của phương trình này là $x = \\pm \\dfrac{\\pi}{3} + k2\\pi$ với $k \\in \\mathbb{Z}$.\n\nTrường hợp 2: $t = -1 \\Rightarrow \\cos x = -1$.\nNghiệm của phương trình này là $x = \\pi + k2\\pi$ với $k \\in \\mathbb{Z}$.\n\nKết luận:\nVậy, các nghiệm của phương trình đã cho là $x = \\pm \\dfrac{\\pi}{3} + k2\\pi$ và $x = \\pi + k2\\pi$ với $k \\in \\mathbb{Z}$.","type":"essay","questionNumber":19,"isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Giải phương trình lượng giác $2\\cos^2 x + \\cos x - 1 = 0$.","rendered_answer":"Để giải phương trình $2\\cos^2 x + \\cos x - 1 = 0$, ta thực hiện các bước sau:<br><br>Bước 1: Đặt ẩn phụ.<br>Đặt $t = \\cos x$. Vì $-1 \\le \\cos x \\le 1$ nên điều kiện của $t$ là $-1 \\le t \\le 1$.<br>Phương trình đã cho trở thành phương trình bậc hai theo $t$: $2t^2 + t - 1 = 0$.<br><br>Bước 2: Giải phương trình bậc hai theo $t$.<br>Ta tính delta: $\\Delta = 1^2 - 4 \\cdot 2 \\cdot (-1) = 1 + 8 = 9$. <br>Vì $\\Delta > 0$, phương trình có hai nghiệm phân biệt:<br>$t_1 = \\dfrac{-1 + \\sqrt{9}}{2 \\cdot 2} = \\dfrac{-1+3}{4} = \\dfrac{2}{4} = \\dfrac{1}{2}$.<br>$t_2 = \\dfrac{-1 - \\sqrt{9}}{2 \\cdot 2} = \\dfrac{-1-3}{4} = \\dfrac{-4}{4} = -1$.<br>Cả hai nghiệm $t=\\dfrac{1}{2}$ và $t=-1$ đều thỏa mãn điều kiện $-1 \\le t \\le 1$.<br><br>Bước 3: Giải các phương trình lượng giác cơ bản.<br>Trường hợp 1: $t = \\dfrac{1}{2} \\Rightarrow \\cos x = \\dfrac{1}{2}$.<br>Nghiệm của phương trình này là $x = \\pm \\dfrac{\\pi}{3} + k2\\pi$ với $k \\in \\mathbb{Z}$.<br><br>Trường hợp 2: $t = -1 \\Rightarrow \\cos x = -1$.<br>Nghiệm của phương trình này là $x = \\pi + k2\\pi$ với $k \\in \\mathbb{Z}$.<br><br>Kết luận:<br>Vậy, các nghiệm của phương trình đã cho là $x = \\pm \\dfrac{\\pi}{3} + k2\\pi$ và $x = \\pi + k2\\pi$ với $k \\in \\mathbb{Z}$."}];
        const options = {"title":"Bài kiểm tra - 14/11/2025","timeLimit":45,"retries":1,"showAnswers":true,"showExplanation":true,"aiAssessment":true,"examCode":"X0N24P","teacherName":"PHẠM ANH DŨNG","scoring":{"mc":5,"tf":2,"sa":2,"essay":1,"tfMethod":"progressive"}};
        const googleScriptUrl = "https://script.google.com/macros/s/AKfycbxV_S0rNHbOQx-hnjjlQGqdvLBN5GlTog0q8erd1XMpPX7XkuGjIxJnDEPPDJQnpGnf9g/exec";
        const examCode = "X0N24P";

        let userAnswers = new Array(quizData.length).fill(null);
        let studentName = '';
        let studentClass = '';
        let timerInterval;
        let timeRemaining = options.timeLimit * 60;
        let retriesCount = 0;
        let submissionStatus = 'pending';
        let monitoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0 };
        
        const welcomeScreen = document.getElementById('welcome-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const resultsScreen = document.getElementById('results-screen');
        const startBtn = document.getElementById('start-btn');
        const nameInput = document.getElementById('name');
        const classInput = document.getElementById('class');
        const timerEl = document.getElementById('timer');
        const submitBtn = document.getElementById('submit-btn');
        const scoreDisplay = document.getElementById('score-display');
        const assessmentDisplay = document.getElementById('assessment-display');
        const reviewContainer = document.getElementById('review-container');
        const retryBtn = document.getElementById('retry-btn');
        const restartBtn = document.getElementById('restart-btn');
        const warningEl = document.getElementById('monitoring-warning');

        // Make functions globally accessible for inline onclick handlers
        window.selectOption = selectOption;
        window.selectTFOption = selectTFOption;
        window.saveTextAnswer = saveTextAnswer;
        window.getAIExplanation = getAIExplanation;

        startBtn.addEventListener('click', startQuiz);
        submitBtn.addEventListener('click', confirmSubmit);
        retryBtn.addEventListener('click', retryQuiz);
        restartBtn.addEventListener('click', () => window.location.reload());
        
        nameInput.value = localStorage.getItem('studentName') || '';
        classInput.value = localStorage.getItem('studentClass') || '';
        
        function safeTypeset(elements) {
            if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                window.MathJax.typesetPromise(elements).catch(function (err) {
                    console.error('MathJax error: ' + err.message);
                });
            }
        }
        
        function startQuiz() {
            studentName = nameInput.value.trim();
            studentClass = classInput.value.trim();
            if (!studentName || !studentClass) {
                alert('Vui lòng nhập đầy đủ Họ và tên và Lớp.');
                return;
            }
            localStorage.setItem('studentName', studentName);
            localStorage.setItem('studentClass', studentClass);
            
            welcomeScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            resultsScreen.classList.add('hidden');
            
            userAnswers.fill(null);
            submissionStatus = 'pending';
            
            renderAllQuestions();
            
            if (options.timeLimit > 0) {
                timeRemaining = options.timeLimit * 60;
                startTimer();
            } else {
                timerEl.textContent = 'Không giới hạn';
            }
            startMonitoring();
        }

        function mapType(typeStr) {
             if (!typeStr) return 'multiple-choice';
             if (typeStr.startsWith('mc-') || ['cloze-test', 'sentence-ordering', 'multiple-choice', 'paragraph-sentence-ordering'].includes(typeStr)) return 'multiple-choice';
             if (typeStr.startsWith('tf-') || typeStr === 'true-false') return 'true-false';
             if (typeStr === 'short-answer' || typeStr === 'sentence-transformation') return 'short-answer';
             return 'essay';
        }
        
        function renderAllQuestions() {
            const container = document.getElementById('all-questions-container');
            let allHTML = '';

            const groupedQuestions = quizData.reduce((acc, q) => {
                const type = mapType(q.type);
                if (!acc[type]) acc[type] = [];
                acc[type].push(q);
                return acc;
            }, {});

            const groupInfo = {
                'multiple-choice': { title: 'PHẦN I. TRẮC NGHIỆM KHÁCH QUAN' },
                'true-false': { title: 'PHẦN II. CÂU HỎI ĐÚNG - SAI' },
                'short-answer': { title: 'PHẦN III. CÂU HỎI TRẢ LỜI NGẮN' },
                'essay': { title: 'PHẦN IV. CÂU HỎI TỰ LUẬN' },
            };
            
            let questionCounter = 0;
            const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];

            partOrder.forEach(partType => {
                const questions = groupedQuestions[partType];
                if (!questions || questions.length === 0) return;

                const info = groupInfo[partType];
                allHTML += `<div class="group-header mb-6 pb-3 border-b-2 border-gray-300"><h2 class="text-2xl font-bold text-gray-800">${info.title}</h2></div>`;
                
                questions.forEach((item) => {
                    const index = quizData.indexOf(item);
                    questionCounter++;
                    
                    let contentHTML = `<div class="question-card mb-8 p-6 border rounded-xl shadow-sm" id="q-${index}">`;
                    contentHTML += `<p class="font-semibold text-lg text-gray-800 mb-4">Câu ${questionCounter}:</p>`;
                    contentHTML += `<div class="prose max-w-none text-gray-700 mb-4">${item.rendered_question || ''}</div>`;

                    let answerHTML = '';
                    const savedAnswer = userAnswers[index];
                    const type = mapType(item.type);
                    
                    if (type === 'multiple-choice') {
                        answerHTML = `<div class="space-y-3">`;
                        (item.rendered_options || []).forEach((opt, i) => {
                            const isSelected = savedAnswer === i;
                            answerHTML += `<div class="option ${isSelected ? 'selected' : ''} p-3 border-2 rounded-lg cursor-pointer transition flex items-start" data-q-index="${index}" data-opt-index="${i}" onclick="selectOption(this, ${index}, ${i})">
                                                <span class="font-bold mr-2">${String.fromCharCode(65 + i)}.</span>
                                                <div class="flex-grow">${opt}</div>
                                            </div>`;
                        });
                        answerHTML += `</div>`;
                    } else if (type === 'true-false') {
                         answerHTML = `<div class="space-y-3">`;
                         (item.statements || []).forEach((stmt, i) => {
                            const savedStmtAnswer = savedAnswer ? savedAnswer[i] : null;
                            const isTrueSelected = savedStmtAnswer === true;
                            const isFalseSelected = savedStmtAnswer === false;
                            answerHTML += `<div class="p-3 border-2 rounded-lg flex items-center justify-between gap-4">
                                                <div class="flex-grow prose max-w-none">${stmt.rendered_statement}</div>
                                                <div class="flex-shrink-0 flex gap-2">
                                                    <button class="${isTrueSelected ? 'bg-blue-500 text-white' : 'bg-gray-200'} px-4 py-2 rounded-md font-semibold" onclick="selectTFOption(this, ${index}, ${i}, true)">Đúng</button>
                                                    <button class="${isFalseSelected ? 'bg-red-500 text-white' : 'bg-gray-200'} px-4 py-2 rounded-md font-semibold" onclick="selectTFOption(this, ${index}, ${i}, false)">Sai</button>
                                                </div>
                                            </div>`;
                        });
                        answerHTML += `</div>`;
                    } else if (type === 'short-answer') {
                        answerHTML = `<input type="text" class="w-full border border-gray-300 rounded-md p-2" value="${savedAnswer || ''}" onchange="saveTextAnswer(this, ${index})">`;
                    } else if (type === 'essay') {
                        answerHTML = `<textarea class="w-full border border-gray-300 rounded-md p-2" rows="5" onchange="saveTextAnswer(this, ${index})">${savedAnswer || ''}</textarea>`;
                    }

                    contentHTML += answerHTML + '</div>'; // close question-card
                    allHTML += contentHTML;
                });
            });
            container.innerHTML = allHTML;
            safeTypeset([container]);
        }

        function selectOption(element, qIndex, optIndex) {
            userAnswers[qIndex] = optIndex;
            const questionCard = document.getElementById(`q-${qIndex}`);
            questionCard.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
        }
        
        function selectTFOption(button, qIndex, stmtIndex, answer) {
            if (!userAnswers[qIndex] || !Array.isArray(userAnswers[qIndex])) {
                userAnswers[qIndex] = new Array(quizData[qIndex].statements.length).fill(null);
            }
            userAnswers[qIndex][stmtIndex] = answer;
            const parent = button.parentElement;
            Array.from(parent.children).forEach(btn => btn.classList.remove('bg-blue-500', 'text-white', 'bg-red-500'));
            button.classList.add(answer ? 'bg-blue-500' : 'bg-red-500', 'text-white');
        }
        
        function saveTextAnswer(element, qIndex) {
            userAnswers[qIndex] = element.value;
        }

        function confirmSubmit() {
            const unansweredQuestions = userAnswers.map((answer, index) => ({ answer, index }))
                                                .filter(item => item.answer === null || 
                                                                (Array.isArray(item.answer) && item.answer.some(a => a === null)));

            let message = "Bạn có chắc chắn muốn nộp bài không?";
            if (unansweredQuestions.length > 0) {
                message = `Bạn còn ${unansweredQuestions.length} câu chưa hoàn thành. Bạn có chắc chắn muốn nộp bài không?`;
            }

            if (confirm(message)) {
                submitQuiz();
            }
        }

        async function submitQuiz() {
            if (submissionStatus !== 'pending') return;
            submissionStatus = 'submitting';
            stopTimer();
            stopMonitoring();
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="animate-pulse">Đang nộp bài...</span>';

            const { score, totalPossibleScore, answerDetails } = calculateScore();
            const finalScore = (totalPossibleScore > 0 ? (score / totalPossibleScore * 10) : 0).toFixed(2);
            let aiAssessment = 'Không có';

            if (options.aiAssessment && API_KEY) {
                assessmentDisplay.innerHTML = '<strong>Nhận xét từ AI:</strong> <span class="animate-pulse">AI đang phân tích bài làm...</span>';
                assessmentDisplay.classList.remove('hidden');
                try {
                    aiAssessment = await getAIAssessment(finalScore, answerDetails);
                } catch (e) {
                    console.error("Error getting AI assessment:", e);
                    aiAssessment = "Đã xảy ra lỗi khi AI tạo nhận xét.";
                }
            }
            
            const submissionData = new FormData();
            submissionData.append('timestamp', new Date().toLocaleString('vi-VN'));
            submissionData.append('name', studentName);
            submissionData.append('class', studentClass);
            submissionData.append('score', finalScore);
            submissionData.append('assessment', aiAssessment);
            submissionData.append('examCode', examCode);
            submissionData.append('monitoringLog', JSON.stringify(monitoringLog));
            submissionData.append('answerDetails', JSON.stringify(answerDetails));
            
            if (googleScriptUrl) {
                try {
                    await fetch(googleScriptUrl, { method: 'POST', body: new URLSearchParams(submissionData) });
                } catch (error) {
                    console.error('Error submitting to Google Script:', error);
                    alert('Lỗi: Không thể nộp kết quả lên hệ thống. Vui lòng kiểm tra lại kết nối mạng và thử lại.');
                }
            }
            submissionStatus = 'submitted';
            showResults(finalScore, aiAssessment, answerDetails);
        }
        
        function showResults(score, assessment, answerDetails) {
            quizScreen.classList.add('hidden');
            resultsScreen.classList.remove('hidden');
            
            if (options.showAnswers) {
                scoreDisplay.textContent = `${score} / 10`;
                scoreDisplay.classList.remove('hidden');
            } else {
                scoreDisplay.innerHTML = '<p class="text-3xl text-center text-green-600">Nộp bài thành công!</p>';
                scoreDisplay.classList.remove('hidden');
            }
            
            if (options.aiAssessment) {
                assessmentDisplay.innerHTML = `<strong>Nhận xét từ AI:</strong> <br> ${assessment.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>')}`;
                assessmentDisplay.classList.remove('hidden');
            } else {
                assessmentDisplay.classList.add('hidden');
            }
            
            if (options.showAnswers) {
                renderReview(answerDetails);
            } else {
                reviewContainer.innerHTML = '<p class="text-center text-gray-600">Giáo viên đã chọn không hiển thị đáp án và giải thích chi tiết.</p>';
            }
            
            if (retriesCount < options.retriesAllowed) retryBtn.classList.remove('hidden');
        }

        function calculateScore() {
            let score = 0;
            let totalPossibleScore = 0;
            const answerDetails = [];
            
            const mcCount = quizData.filter(q => mapType(q.type) === 'multiple-choice').length;
            const tfCount = quizData.filter(q => mapType(q.type) === 'true-false').length;
            const saCount = quizData.filter(q => mapType(q.type) === 'short-answer').length;

            const pointsPerMc = mcCount > 0 ? options.scoring.mc / mcCount : 0;
            const pointsPerTf = tfCount > 0 ? options.scoring.tf / tfCount : 0;
            const pointsPerSa = saCount > 0 ? options.scoring.sa / saCount : 0;
            
            totalPossibleScore = (options.scoring.mc || 0) + (options.scoring.tf || 0) + (options.scoring.sa || 0) + (options.scoring.essay || 0);
            if (totalPossibleScore === 0 && (mcCount + tfCount + saCount > 0)) {
                 totalPossibleScore = (pointsPerMc * mcCount) + (pointsPerTf * tfCount) + (pointsPerSa * saCount);
            }
            if (totalPossibleScore === 0 && quizData.length > 0) totalPossibleScore = 10; 

            quizData.forEach((item, index) => {
                const userAnswer = userAnswers[index];
                let isCorrect = false;
                let detail = null;
                const type = mapType(item.type);

                if (type === 'multiple-choice') {
                    isCorrect = userAnswer === item.correctAnswerIndex;
                    if(isCorrect) score += pointsPerMc;
                } else if (type === 'true-false') {
                    let correctStatements = 0;
                    detail = [];
                    (item.statements || []).forEach((stmt, i) => {
                        const isStmtCorrect = (userAnswer && userAnswer[i] === stmt.is_correct);
                        if(isStmtCorrect) correctStatements++;
                        detail.push({isCorrect: isStmtCorrect});
                    });

                    if (options.scoring.tfMethod === 'even') {
                        score += (correctStatements / 4) * pointsPerTf;
                    } else { // progressive
                        if (correctStatements === 4) score += pointsPerTf;
                        else if (correctStatements === 3) score += 0.5 * pointsPerTf;
                        else if (correctStatements === 2) score += 0.25 * pointsPerTf;
                        else if (correctStatements === 1) score += 0.1 * pointsPerTf;
                    }
                    isCorrect = correctStatements === 4;
                } else {
                    isCorrect = null;
                }
                answerDetails.push({ questionNumber: index + 1, isCorrect, type, details: detail });
            });
            return { score, totalPossibleScore, answerDetails };
        }
        
        function renderReview(answerDetails) {
            let reviewHTML = '<h3 class="text-2xl font-bold mb-6">Xem lại bài làm</h3>';
            quizData.forEach((item, index) => {
                reviewHTML += `<div class="mb-6 p-4 border rounded-lg">`;
                reviewHTML += `<p class="font-semibold mb-2">Câu ${index + 1}:</p><div class="prose max-w-none">${item.rendered_question}</div>`;
                const type = mapType(item.type);
                const detail = answerDetails.find(d => d.questionNumber === index + 1);

                if (type === 'multiple-choice') {
                     reviewHTML += '<div class="mt-4 space-y-2">';
                     (item.rendered_options || []).forEach((opt, i) => {
                        let classes = 'option p-3 border-2 rounded-lg flex items-start';
                        if (i === item.correctAnswerIndex) classes += ' correct';
                        if (userAnswers[index] === i && i !== item.correctAnswerIndex) classes += ' incorrect';
                        reviewHTML += `<div class="${classes}"><span class="font-bold mr-2">${String.fromCharCode(65 + i)}.</span> <div>${opt}</div></div>`;
                     });
                     reviewHTML += '</div>';
                } else if (type === 'true-false') {
                     reviewHTML += '<div class="mt-4 space-y-2">';
                     (item.statements || []).forEach((stmt, i) => {
                         let classes = 'p-3 border-2 rounded-lg flex items-center justify-between gap-4';
                         const userChoice = userAnswers[index] ? userAnswers[index][i] : null;
                         const isCorrect = userChoice === stmt.is_correct;
                         if (isCorrect) classes += ' bg-green-50 border-green-300';
                         else if (userChoice !== null) classes += ' bg-red-50 border-red-300';
                         else classes += ' bg-gray-50 border-gray-200';

                         reviewHTML += `<div class="${classes}">
                                         <div class="prose max-w-none">${stmt.rendered_statement}</div>
                                         <div class="flex-shrink-0 font-bold text-sm text-right">
                                             <span>Đáp án: ${stmt.is_correct ? 'Đ' : 'S'}</span><br>
                                             <span>Bạn chọn: ${userChoice === true ? 'Đ' : userChoice === false ? 'S' : '...'}</span>
                                         </div>
                                     </div>`;
                     });
                     reviewHTML += '</div>';
                } else {
                    reviewHTML += `<div class="mt-4 p-3 bg-gray-100 rounded-lg"><strong>Câu trả lời của bạn:</strong><br>${userAnswers[index] || '<em>Chưa trả lời</em>'}</div>`;
                    if (item.rendered_answer) {
                        reviewHTML += `<div class="mt-2 p-3 bg-blue-50 rounded-lg"><strong>Đáp án gợi ý:</strong><br><div class="prose max-w-none">${item.rendered_answer}</div></div>`;
                    }
                }
                
                if (options.showExplanation && API_KEY) {
                     reviewHTML += `<div class="mt-4">
                                      <button class="text-sm text-blue-600 hover:underline" onclick="getAIExplanation(${index}, this)">Xem giải thích từ AI</button>
                                      <div id="explanation-${index}" class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg hidden"></div>
                                   </div>`;
                }
                reviewHTML += '</div>';
            });
            reviewContainer.innerHTML = reviewHTML;
            safeTypeset([reviewContainer]);
        }

        function retryQuiz() {
            retriesCount++;
            startQuiz();
        }
        
        function startTimer() {
            stopTimer();
            timerInterval = setInterval(() => {
                timeRemaining--;
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                if (timeRemaining <= 0) {
                    stopTimer();
                    alert('Đã hết thời gian làm bài!');
                    submitQuiz();
                }
            }, 1000);
        }

        function stopTimer() { clearInterval(timerInterval); }
        
        function showWarning(message) {
            warningEl.textContent = message;
            warningEl.style.display = 'block';
            warningEl.style.animation = 'none';
            warningEl.offsetHeight; 
            warningEl.style.animation = 'fade-in-out 5s ease-in-out';
        }

        function handleVisibilityChange() {
            if (document.hidden) {
                monitoringLog.thoatManHinh++;
                showWarning('⚠️ Đã phát hiện chuyển tab hoặc thu nhỏ cửa sổ!');
            }
        }
        function handleCopy() { monitoringLog.saoChep++; showWarning('⚠️ Đã phát hiện hành vi sao chép!'); }
        function handlePaste() { monitoringLog.dan++; showWarning('⚠️ Đã phát hiện hành vi dán!'); }
        function startMonitoring() {
            monitoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0 };
            document.addEventListener('visibilitychange', handleVisibilityChange);
            document.addEventListener('copy', handleCopy);
            document.addEventListener('paste', handlePaste);
        }
        function stopMonitoring() {
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            document.removeEventListener('copy', handleCopy);
            document.removeEventListener('paste', handlePaste);
        }

        function stripHtml(html) {
            if (!html) return "";
            let doc = new DOMParser().parseFromString(html, 'text/html');
            return doc.body.textContent || "";
        }

        async function getAIExplanation(index, button) {
            if (!API_KEY) return;
            const explanationContainer = document.getElementById(`explanation-${index}`);
            if (!explanationContainer) return;
            
            const isHidden = explanationContainer.classList.contains('hidden');

            if (!isHidden && quizData[index].explanation) {
                explanationContainer.classList.add('hidden');
                button.textContent = 'Xem giải thích từ AI';
                return;
            }
            
            explanationContainer.classList.remove('hidden');

            if (quizData[index].explanation) {
                explanationContainer.innerHTML = quizData[index].rendered_explanation;
                safeTypeset([explanationContainer]);
                button.textContent = 'Ẩn giải thích';
                return;
            }

            button.disabled = true;
            button.textContent = 'AI đang giải thích...';
            explanationContainer.innerHTML = '<div class="animate-pulse">Đang tải...</div>';
            
            try {
                const ai = new GoogleGenAI({apiKey: API_KEY});
                
                const item = quizData[index];
                const questionText = (mapType(item.type) === 'true-false') ? item.main_question : item.question;
                let prompt = `Bạn là một trợ lý giáo viên AI, am hiểu sâu sắc Chương trình GDPT 2018 của Việt Nam. Hãy cung cấp một lời giải chi tiết, từng bước một cho câu hỏi sau đây. Lời giải phải chính xác, dễ hiểu và phù hợp với phương pháp giảng dạy của chương trình GDPT 2018.\n---**CÂU HỎI:**\n${stripHtml(item.rendered_question)}\n---`;

                if (mapType(item.type) === 'multiple-choice') {
                    prompt += `\n**CÁC LỰA CHỌN:**\n`;
                    item.options.forEach((opt, i) => { prompt += `${String.fromCharCode(65 + i)}. ${stripHtml(item.rendered_options[i])}\n`; });
                    prompt += `---\n**ĐÁP ÁN ĐÚNG:** ${String.fromCharCode(65 + item.correctAnswerIndex)}. ${stripHtml(item.rendered_options[item.correctAnswerIndex])}`;
                } else if (mapType(item.type) === 'true-false') {
                    prompt += `\n**CÁC MỆNH ĐỀ VÀ ĐÁP ÁN:**\n`;
                    item.statements.forEach((s, i) => { prompt += `${String.fromCharCode(97 + i)}) ${stripHtml(s.rendered_statement)} -> ${s.is_correct ? 'Đúng' : 'Sai'}\n`; });
                } else {
                    prompt += `---\n**ĐÁP ÁN / GỢI Ý:** ${stripHtml(item.rendered_answer)}`;
                }
                
                prompt += `\n---\n**YÊU CẦU:** Hãy giải thích chi tiết từng bước để đi đến đáp án đúng. Định dạng tất cả các công thức toán học bằng LaTeX. Dùng **...** để in đậm các thuật ngữ quan trọng.`;
                
                const response = await ai.models.generateContent({ model: "gemini-2.5-flash", contents: prompt });
                const explanationText = response.text || "Không thể tạo giải thích.";
                
                quizData[index].explanation = explanationText;
                
                let htmlContent = explanationText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                quizData[index].rendered_explanation = htmlContent;
                
                explanationContainer.innerHTML = htmlContent;
                safeTypeset([explanationContainer]);

            } catch (error) {
                console.error("Error getting AI explanation:", error);
                explanationContainer.innerHTML = '<p class="text-red-600">Lỗi khi tạo giải thích.</p>';
            } finally {
                button.disabled = false;
                button.textContent = 'Ẩn giải thích';
            }
        }

        async function getAIAssessment(score, answerDetails) {
            if (!API_KEY) return "Không thể tạo nhận xét do thiếu API key.";
            
            try {
                const ai = new GoogleGenAI({apiKey: API_KEY});
                
                const wrongAnswers = answerDetails.filter(d => d.isCorrect === false || (d.type === 'true-false' && d.details && d.details.some(sub => !sub.isCorrect)));

                if (wrongAnswers.length === 0) {
                    return "Chúc mừng em đã hoàn thành bài làm rất tốt và không sai câu nào! Em đã nắm vững kiến thức. Hãy tiếp tục phát huy nhé!";
                }

                const wrongQuestionsSummary = wrongAnswers.map(d => {
                    const q = quizData[d.questionNumber - 1];
                    const questionContent = stripHtml(q.rendered_question || q.question || q.main_question);
                    return `- Câu ${d.questionNumber}: ${questionContent}`;
                }).join('\n');
                
                const prompt = `Bạn là một giáo viên AI tận tâm và giàu kinh nghiệm, chuyên đưa ra những nhận xét mang tính xây dựng. Dựa vào kết quả bài làm của một học sinh, hãy đưa ra một nhận xét chi tiết (khoảng 4-5 câu) về năng lực của học sinh.
                
                **Kết quả bài làm:**
                - **Điểm số:** ${score} / 10
                - **Các câu học sinh đã trả lời sai:**
                ${wrongQuestionsSummary}
                
                **YÊU CẦU NHẬN XÉT (RẤT QUAN TRỌNG):**
                1.  Bắt đầu bằng một lời động viên, ghi nhận sự cố gắng của học sinh.
                2.  **Phân tích nội dung các câu sai:** Đọc và hiểu nội dung của từng câu học sinh làm sai. Từ đó, **xác định cụ thể các mảng kiến thức hoặc kỹ năng mà học sinh còn yếu.**
                    *   **VÍ DỤ TỐT (Nên làm):** "Qua các câu sai, cô/thầy nhận thấy em có vẻ chưa vững kiến thức về 'tính đơn điệu của hàm số bậc ba' (câu 5) và còn nhầm lẫn khi áp dụng 'định lý Viète' (câu 12)."
                    *   **VÍ DỤ KÉM (Không làm):** "Em đã làm sai một số câu. Em cần cẩn thận hơn." (Quá chung chung).
                3.  **Đưa ra gợi ý cụ thể:** Dựa trên phân tích ở bước 2, hãy đưa ra lời khuyên cụ thể, mang tính hành động. Ví dụ: "Em nên xem lại bài giảng về..., làm thêm các bài tập dạng..., hoặc chú ý hơn đến các trường hợp đặc biệt của...".
                4.  Kết thúc bằng một lời khích lệ, tạo động lực cho học sinh cố gắng hơn trong lần sau.
                5.  Giọng văn phải thật sự thân thiện, tích cực, như một giáo viên đang trực tiếp nhận xét cho học trò của mình.
                `;

                const response = await ai.models.generateContent({ model: "gemini-2.5-flash", contents: prompt });
                return response.text || "Không thể tạo nhận xét.";

            } catch (error) {
                console.error("Error generating AI assessment:", error);
                return "Đã có lỗi xảy ra trong quá trình AI tạo nhận xét.";
            }
        }
    </script>
</body>
</html>
    