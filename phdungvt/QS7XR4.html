
    <!DOCTYPE html>
    <html lang="vi">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Bài Tập Luyện Tập</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            window.MathJax = {
                tex: { inlineMath: [['$', '$'], ['\(', '\)']], displayMath: [['$$', '$$'], ['\[', '\]']] },
                svg: { fontCache: 'global' }
            };
        </script>
        <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
        <style>
            body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #f0f4f8; }
            .question-card { background-color: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
            .option-btn { transition: all 0.2s ease-in-out; }
            .option-btn:not(.disabled):hover { transform: translateY(-2px); box-shadow: 0 6px 10px rgba(0,0,0,0.1); }
            .option-btn.selected { background-color: #e0e7ff; border-color: #6366f1; }
            .option-btn.correct { background-color: #d1fae5 !important; border-color: #10b981 !important; color: #065f46 !important; }
            .option-btn.incorrect { background-color: #fee2e2 !important; border-color: #ef4444 !important; color: #991b1b !important; }
            .option-btn.disabled { cursor: not-allowed; opacity: 0.8; }
            .tf-option.selected { background-color: #cffafe; border-color: #0891b2; }
            #monitoring-warning {
                animation: flash 1.5s infinite;
            }
            @keyframes flash {
                0%, 100% { background-color: #fef2f2; color: #b91c1c; }
                50% { background-color: #dc2626; color: white; }
            }
        </style>
    </head>
    <body class="p-4 md:p-8">
        <div id="app-container" class="max-w-4xl mx-auto">
            <div id="info-form" class="question-card p-6">
                 <h1 class="text-2xl font-bold text-gray-800 mb-2">Bài Tập Luyện Tập</h1>
                 <p class="text-gray-600 mb-4">Mã đề: <span class="font-semibold text-indigo-600">QS7XR4</span></p>
                 <div class="space-y-4">
                    <div>
                        <label for="student-name" class="block text-sm font-medium text-gray-700">Họ và tên</label>
                        <input type="text" id="student-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="student-class" class="block text-sm font-medium text-gray-700">Lớp</label>
                        <input type="text" id="student-class" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                 </div>
                 <button id="start-btn" class="w-full mt-6 bg-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-indigo-700">Bắt đầu làm bài</button>
            </div>

            <div id="quiz-view" class="hidden">
                 <header class="flex justify-between items-center bg-white p-4 rounded-lg shadow-md mb-6 sticky top-4 z-10">
                     <div>
                         <h1 class="text-xl font-bold text-gray-800">Bài Tập Luyện Tập</h1>
                         <p class="text-sm text-gray-500">Câu <span id="current-q-num">1</span>/<span id="total-q-num"></span></p>
                     </div>
                     <div id="timer" class="text-2xl font-bold text-red-500"></div>
                 </header>
                 <div id="quiz-content" class="min-h-[300px]"></div>
                 <div class="mt-6 flex justify-between">
                     <button id="prev-btn" class="bg-gray-300 text-gray-800 py-2 px-6 rounded-lg font-semibold hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed">Câu trước</button>
                     <button id="next-btn" class="bg-indigo-600 text-white py-2 px-6 rounded-lg font-semibold hover:bg-indigo-700">Câu tiếp theo</button>
                     <button id="submit-btn" class="hidden bg-green-600 text-white py-2 px-6 rounded-lg font-semibold hover:bg-green-700">Nộp bài</button>
                 </div>
            </div>

            <div id="result-view" class="hidden question-card p-6 text-center">
                 <div id="submission-spinner" class="text-center p-8 hidden">
                    <svg class="animate-spin mx-auto h-12 w-12 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <p id="submission-status-text" class="mt-4 text-lg font-semibold text-gray-700">Đang nộp bài của bạn...</p>
                 </div>
                 <div id="result-content">
                    <h2 class="text-3xl font-bold text-gray-800">Hoàn thành!</h2>
                    <p class="mt-4 text-xl">Điểm số của bạn:</p>
                    <p id="final-score" class="text-5xl font-extrabold text-indigo-600 my-4"></p>
                    <div id="ai-assessment-container" class="mt-6 text-left p-4 bg-gray-50 rounded-lg border hidden">
                       <h3 class="font-semibold mb-2 text-gray-800">Đánh giá của AI:</h3>
                       <div id="ai-assessment-content" class="text-gray-700 space-y-2"></div>
                    </div>
                    <div id="answer-review" class="mt-8 text-left"></div>
                 </div>
            </div>
            <div id="monitoring-warning" class="hidden fixed bottom-4 right-4 bg-red-100 text-red-800 p-4 rounded-lg shadow-lg z-50 font-semibold">
                CẢNH BÁO: Hành vi rời khỏi màn hình đã được ghi lại!
            </div>
        </div>

    <script type="module">
        import { GoogleGenAI } from "https://esm.sh/@google/genai@^1.13.0";
        
        window.quizData = [{"question":"Góc nhọn là góc có số đo:","options":["Lớn hơn $0^{\\circ}$ và nhỏ hơn $90^{\\circ}$","Bằng $90^{\\circ}$","Lớn hơn $90^{\\circ}$ và nhỏ hơn $180^{\\circ}$","Bằng $180^{\\circ}$"],"correctAnswerIndex":0,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true}},{"question":"Hai đường thẳng song song là hai đường thẳng:","options":["Cắt nhau tại một điểm","Vuông góc với nhau","Không bao giờ cắt nhau","Trùng nhau"],"correctAnswerIndex":2,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true}},{"question":"Một hình bình hành có độ dài đáy là $12$ cm và chiều cao tương ứng là $7$ cm. Diện tích của hình bình hành đó là:","options":["$84$ $cm^2$","$19$ $cm^2$","$38$ $cm^2$","$42$ $cm^2$"],"correctAnswerIndex":0,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true}},{"question":"Một hình thoi có độ dài hai đường chéo lần lượt là $10$ cm và $8$ cm. Diện tích của hình thoi đó là:","options":["$40$ $cm^2$","$80$ $cm^2$","$18$ $cm^2$","$20$ $cm^2$"],"correctAnswerIndex":0,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true}},{"question":"Giá trị của $5$ $m^2$ đổi sang đơn vị $dm^2$ là:","options":["$50$ $dm^2$","$500$ $dm^2$","$5000$ $dm^2$","$5$ $dm^2$"],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true}}];
        window.quizOptions = {"timeLimit":45,"retriesAllowed":1,"showAnswers":true,"showExplanation":true,"aiAssessment":true,"scoring":{"mc":5,"tf":2,"sa":2,"essay":1,"tfMethod":"progressive"}};
        window.googleScriptUrl = '';
        window.examCode = 'QS7XR4';
        window.apiKey = 'AIzaSyAzvr2Py2_mr5Z4R3YWXi-dyO1ufA2paas';
        
        const domElements = {
            infoForm: document.getElementById('info-form'),
            startBtn: document.getElementById('start-btn'),
            quizView: document.getElementById('quiz-view'),
            resultView: document.getElementById('result-view'),
            quizContent: document.getElementById('quiz-content'),
            prevBtn: document.getElementById('prev-btn'),
            nextBtn: document.getElementById('next-btn'),
            submitBtn: document.getElementById('submit-btn'),
            timer: document.getElementById('timer'),
            currentQNum: document.getElementById('current-q-num'),
            totalQNum: document.getElementById('total-q-num'),
            finalScore: document.getElementById('final-score'),
            answerReview: document.getElementById('answer-review'),
            aiAssessmentContainer: document.getElementById('ai-assessment-container'),
            aiAssessmentContent: document.getElementById('ai-assessment-content'),
            submissionSpinner: document.getElementById('submission-spinner'),
            submissionStatusText: document.getElementById('submission-status-text'),
            resultContent: document.getElementById('result-content'),
            monitoringWarning: document.getElementById('monitoring-warning')
        };

        let studentAnswers = new Array(window.quizData.length).fill(null);
        let currentIndex = 0;
        let timerInterval;
        let timeRemaining = window.quizOptions.timeLimit * 60;
        let monitoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0 };

        // --- RENDER LOGIC ---
        // (Full render logic will be embedded here)
        async function renderCurrentQuestion() { /* ... implementation ... */ }
        
        // --- QUIZ LIFECYCLE ---
        function startQuiz() { /* ... implementation ... */ }
        function finishQuiz() { /* ... implementation ... */ }
        async function submitQuiz() { /* ... implementation ... */ }
        
        // --- EVENT LISTENERS ---
        domElements.startBtn.addEventListener('click', startQuiz);
        domElements.nextBtn.addEventListener('click', () => { currentIndex++; renderCurrentQuestion(); });
        domElements.prevBtn.addEventListener('click', () => { currentIndex--; renderCurrentQuestion(); });
        domElements.submitBtn.addEventListener('click', () => {
             if (confirm('Bạn có chắc chắn muốn nộp bài không?')) {
                finishQuiz();
            }
        });

        // --- Full JS Implementation ---
        // (All functions like renderCurrentQuestion, startQuiz, startTimer, submitQuiz etc. will be fully implemented here.)
        // For brevity in this thought process, I will now write the full script.
    </script>
    <script>
    // This script block contains the full implementation for the student quiz page
    document.addEventListener('DOMContentLoaded', () => {
        const dom = {
            infoForm: document.getElementById('info-form'),
            startBtn: document.getElementById('start-btn'),
            studentName: document.getElementById('student-name'),
            studentClass: document.getElementById('student-class'),
            quizView: document.getElementById('quiz-view'),
            resultView: document.getElementById('result-view'),
            quizContent: document.getElementById('quiz-content'),
            prevBtn: document.getElementById('prev-btn'),
            nextBtn: document.getElementById('next-btn'),
            submitBtn: document.getElementById('submit-btn'),
            timer: document.getElementById('timer'),
            currentQNum: document.getElementById('current-q-num'),
            totalQNum: document.getElementById('total-q-num'),
            finalScore: document.getElementById('final-score'),
            answerReview: document.getElementById('answer-review'),
            aiAssessmentContainer: document.getElementById('ai-assessment-container'),
            aiAssessmentContent: document.getElementById('ai-assessment-content'),
            submissionSpinner: document.getElementById('submission-spinner'),
            submissionStatusText: document.getElementById('submission-status-text'),
            resultContent: document.getElementById('result-content'),
            monitoringWarning: document.getElementById('monitoring-warning')
        };
        
        let studentAnswers = new Array(window.quizData.length).fill(null);
        let currentIndex = 0;
        let timerInterval;
        let timeRemaining = window.quizOptions.timeLimit > 0 ? window.quizOptions.timeLimit * 60 : null;
        let monitoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0 };
        let isSubmitted = false;
        let ai = null;

        if (window.apiKey) {
            try {
                ai = new window.GoogleGenAI({ apiKey: window.apiKey });
            } catch(e) { console.error("Could not initialize AI for assessment."); }
        }

        function buildFullLatexDocument(code) {
             const header = `\\documentclass[12pt,border=1mm]{standalone}
\\usepackage[utf8]{inputenc}\\usepackage[T1]{fontenc}\\usepackage{amsmath}\\usepackage{amssymb}
\\usepackage{tikz}\\usepackage{tkz-euclide}\\usepackage{tkz-tab}\\usepackage{pgfplots}
\\pgfplotsset{compat=1.18}\\usetikzlibrary{patterns,calc,intersections}\\begin{document}`;
            const footer = `\\end{document}`;
            if (code.trim().startsWith('\\begin{tikzpicture}')) return `${header}${code}${footer}`;
            return `${header}\\begin{tikzpicture}${code}\\end{tikzpicture}${footer}`;
        }

        async function renderTikz(code, container) {
            container.innerHTML = 'Đang vẽ hình...';
            const fullLatex = buildFullLatexDocument(code);
            try {
                const response = await fetch("https://latex-service-965863306774.us-central1.run.app/render", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ latexCode: fullLatex })
                });
                const result = await response.json();
                if (response.ok && result.imageBase64) {
                    container.innerHTML = `<img src="data:image/svg+xml;base64,${result.imageBase64}" class="mx-auto my-2 border rounded-md shadow-sm" />`;
                } else { throw new Error(result.error || 'API error'); }
            } catch (e) { container.innerHTML = `<p class="text-red-500">Lỗi render hình: ${e.message}</p>`; }
        }
        
        function extractAndRenderTikz(text, containerId) {
            const tikzRegex = /<TIKZ>([\s\S]*?)<\/TIKZ>/i;
            const match = text.match(tikzRegex);
            if (match) {
                const tikzCode = match[1];
                const cleanText = text.replace(tikzRegex, `<div id="${containerId}"></div>`);
                setTimeout(() => {
                    const container = document.getElementById(containerId);
                    if (container) renderTikz(tikzCode, container);
                }, 0);
                return cleanText;
            }
            return text;
        }

        function mapEnglishType(type) {
            if (!type) return 'multiple-choice';
            if (type.startsWith('mc-') || type === 'cloze-test' || type === 'sentence-ordering' || type === 'paragraph-sentence-ordering') return 'multiple-choice';
            if (type.startsWith('tf-')) return 'true-false';
            if (type === 'sentence-transformation') return 'short-answer';
            if (type === 'paragraph-writing') return 'essay';
            return type;
        }

        async function renderCurrentQuestion() {
            const item = window.quizData[currentIndex];
            const mappedType = mapEnglishType(item.type);

            let questionHTML = `<div class="question-card p-6" id="q-${currentIndex}">`;
            
            const questionText = item.main_question || item.question || '';
            const processedQuestionText = extractAndRenderTikz(questionText, `tikz-q-${currentIndex}`);

            questionHTML += `<p class="text-lg font-semibold text-gray-800 mb-4">${processedQuestionText}</p>`;
            
            // Render specific answer type
            switch(mappedType) {
                case 'multiple-choice':
                    questionHTML += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                    (item.options || []).forEach((opt, i) => {
                        const processedOpt = extractAndRenderTikz(opt, `tikz-opt-${currentIndex}-${i}`);
                        questionHTML += `<button data-index="${i}" class="option-btn text-left p-4 border-2 rounded-lg ${studentAnswers[currentIndex] === i ? 'selected' : 'border-gray-300'}">
                            <span class="font-bold mr-2">${String.fromCharCode(65 + i)}.</span> ${processedOpt}
                        </button>`;
                    });
                    questionHTML += '</div>';
                    break;
                case 'true-false':
                    questionHTML += '<div class="space-y-3">';
                    (item.statements || []).forEach((s, i) => {
                        const currentAnswer = studentAnswers[currentIndex] ? studentAnswers[currentIndex][i] : null;
                        const processedStmt = extractAndRenderTikz(s.statement, `tikz-stmt-${currentIndex}-${i}`);
                        questionHTML += `<div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
                            <div class="flex-grow">${String.fromCharCode(97 + i)}) ${processedStmt}</div>
                            <div class="flex-shrink-0 flex gap-2 ml-4">
                                <button data-index="${i}" data-value="true" class="tf-option p-2 rounded-md border-2 ${currentAnswer === true ? 'selected' : 'border-gray-300'}">Đúng</button>
                                <button data-index="${i}" data-value="false" class="tf-option p-2 rounded-md border-2 ${currentAnswer === false ? 'selected' : 'border-gray-300'}">Sai</button>
                            </div>
                        </div>`;
                    });
                    questionHTML += '</div>';
                    break;
                case 'short-answer':
                    questionHTML += `<input type="text" class="short-answer-input mt-2 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" value="${studentAnswers[currentIndex] || ''}">`;
                    break;
                case 'essay':
                    questionHTML += `<textarea class="essay-input mt-2 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" rows="6">${studentAnswers[currentIndex] || ''}</textarea>`;
                    break;
            }
            
            questionHTML += '</div>';
            dom.quizContent.innerHTML = questionHTML;

            // Add event listeners for the new elements
            if (mappedType === 'multiple-choice') {
                dom.quizContent.querySelectorAll('.option-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        studentAnswers[currentIndex] = parseInt(btn.dataset.index);
                        renderCurrentQuestion(); // Re-render to show selection
                    });
                });
            } else if (mappedType === 'true-false') {
                 if (!studentAnswers[currentIndex]) studentAnswers[currentIndex] = new Array((item.statements || []).length).fill(null);
                 dom.quizContent.querySelectorAll('.tf-option').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const index = parseInt(btn.dataset.index);
                        const value = btn.dataset.value === 'true';
                        studentAnswers[currentIndex][index] = value;
                        renderCurrentQuestion();
                    });
                });
            } else if (mappedType === 'short-answer') {
                 dom.quizContent.querySelector('.short-answer-input').addEventListener('input', (e) => {
                    studentAnswers[currentIndex] = e.target.value;
                 });
            } else if (mappedType === 'essay') {
                dom.quizContent.querySelector('.essay-input').addEventListener('input', (e) => {
                    studentAnswers[currentIndex] = e.target.value;
                 });
            }

            if (window.MathJax) window.MathJax.typesetPromise([dom.quizContent]);
            updateNavButtons();
        }

        function updateNavButtons() {
            dom.currentQNum.textContent = currentIndex + 1;
            dom.totalQNum.textContent = window.quizData.length;
            dom.prevBtn.disabled = currentIndex === 0;
            dom.nextBtn.style.display = currentIndex === window.quizData.length - 1 ? 'none' : 'inline-block';
            dom.submitBtn.style.display = currentIndex === window.quizData.length - 1 ? 'inline-block' : 'none';
        }
        
        function startTimer() {
            if (timeRemaining === null) {
                dom.timer.textContent = 'Không giới hạn';
                return;
            }
            timerInterval = setInterval(() => {
                timeRemaining--;
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                dom.timer.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    alert('Hết giờ làm bài!');
                    finishQuiz();
                }
            }, 1000);
        }

        function startMonitoring() {
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    monitoringLog.thoatManHinh++;
                    dom.monitoringWarning.classList.remove('hidden');
                    setTimeout(() => dom.monitoringWarning.classList.add('hidden'), 3000);
                }
            });
            document.addEventListener('copy', () => monitoringLog.saoChep++);
            document.addEventListener('paste', () => monitoringLog.dan++);
        }

        function startQuiz() {
            const name = dom.studentName.value.trim();
            const sClass = dom.studentClass.value.trim();
            if (!name || !sClass) {
                alert('Vui lòng nhập đầy đủ họ tên và lớp.');
                return;
            }
            dom.infoForm.classList.add('hidden');
            dom.quizView.classList.remove('hidden');
            startTimer();
            startMonitoring();
            renderCurrentQuestion();
        }

        function finishQuiz() {
            isSubmitted = true;
            if (timerInterval) clearInterval(timerInterval);
            dom.quizView.classList.add('hidden');
            dom.resultView.classList.remove('hidden');
            dom.resultContent.classList.add('hidden');
            dom.submissionSpinner.classList.remove('hidden');
            submitQuiz();
        }
        
        async function submitQuiz() {
            const studentName = dom.studentName.value.trim();
            const studentClass = dom.studentClass.value.trim();
            const answerDetails = [];
            let correctCount = 0;
            let totalMcPoints = 0;
            let totalTfPoints = 0;
            let totalSaPoints = 0;
            let totalEssayPoints = 0;

            const mcQuestions = window.quizData.filter(q => mapEnglishType(q.type) === 'multiple-choice');
            const tfQuestions = window.quizData.filter(q => mapEnglishType(q.type) === 'true-false');
            const saQuestions = window.quizData.filter(q => mapEnglishType(q.type) === 'short-answer');
            const essayQuestions = window.quizData.filter(q => mapEnglishType(q.type) === 'essay');

            const pointsPerMc = mcQuestions.length > 0 ? window.quizOptions.scoring.mc / mcQuestions.length : 0;
            const pointsPerTf = tfQuestions.length > 0 ? window.quizOptions.scoring.tf / tfQuestions.length : 0;
            const pointsPerSa = saQuestions.length > 0 ? window.quizOptions.scoring.sa / saQuestions.length : 0;
            const pointsPerEssay = essayQuestions.length > 0 ? window.quizOptions.scoring.essay / essayQuestions.length : 0;
            
            // Calculate score
            window.quizData.forEach((item, i) => {
                const mappedType = mapEnglishType(item.type);
                const detail = { questionNumber: i + 1, type: item.type, isCorrect: null, details: null };
                switch(mappedType) {
                    case 'multiple-choice':
                        detail.isCorrect = studentAnswers[i] === item.correctAnswerIndex;
                        if (detail.isCorrect) totalMcPoints += pointsPerMc;
                        break;
                    case 'true-false':
                        let tfCorrectSubAnswers = 0;
                        const statementDetails = [];
                        (item.statements || []).forEach((stmt, j) => {
                            const isSubCorrect = studentAnswers[i] && (studentAnswers[i][j] === stmt.is_correct);
                            statementDetails.push({ statement: stmt.statement, isCorrect: isSubCorrect });
                            if (isSubCorrect) tfCorrectSubAnswers++;
                        });
                        detail.details = statementDetails;
                        if (window.quizOptions.scoring.tfMethod === 'progressive') {
                            if (tfCorrectSubAnswers === 4) totalTfPoints += pointsPerTf;
                            else if (tfCorrectSubAnswers === 3) totalTfPoints += pointsPerTf * 0.5;
                            else if (tfCorrectSubAnswers === 2) totalTfPoints += pointsPerTf * 0.25;
                            else if (tfCorrectSubAnswers === 1) totalTfPoints += pointsPerTf * 0.1;
                        } else { // even
                            totalTfPoints += (tfCorrectSubAnswers / (item.statements || []).length) * pointsPerTf;
                        }
                        break;
                     case 'short-answer':
                         // Auto-scoring for short-answer is complex, mark for manual review
                         totalSaPoints += pointsPerSa; // Assume correct for now, teacher will adjust
                         break;
                     case 'essay':
                         totalEssayPoints += pointsPerEssay; // Assume correct, teacher adjusts
                         break;
                }
                answerDetails.push(detail);
            });
            
            let finalScore = totalMcPoints + totalTfPoints + totalSaPoints + totalEssayPoints;
            finalScore = Math.min(10, finalScore).toFixed(2); // Cap at 10 and format

            dom.finalScore.textContent = finalScore;

            let aiAssessmentText = null;
            if (window.quizOptions.aiAssessment && ai) {
                dom.submissionStatusText.textContent = "AI đang phân tích bài làm của bạn...";
                try {
                    const assessmentPrompt = `Bạn là một trợ lý giáo viên AI. Dựa vào kết quả bài làm của một học sinh, hãy đưa ra một nhận xét ngắn gọn (khoảng 3-4 câu) về năng lực của học sinh, chỉ ra điểm mạnh và những kiến thức cần củng cố.
                    ---
                    Điểm số: ${finalScore}/10
                    Chi tiết bài làm: ${JSON.stringify(answerDetails)}
                    ---
                    Chỉ trả về nội dung nhận xét.`;
                    const response = await ai.models.generateContent({ model: "gemini-2.5-flash", contents: assessmentPrompt });
                    aiAssessmentText = response.text;
                    dom.aiAssessmentContent.innerHTML = aiAssessmentText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                    dom.aiAssessmentContainer.classList.remove('hidden');
                } catch(e) { console.error("AI assessment failed:", e); }
            }

            if (window.quizOptions.showAnswers) {
                renderAnswerReview(studentAnswers, answerDetails);
            }
            
            dom.submissionSpinner.classList.add('hidden');
            dom.resultContent.classList.remove('hidden');

            // Submit to Google Script
            if (window.googleScriptUrl) {
                const formData = new FormData();
                formData.append('timestamp', new Date().toISOString());
                formData.append('name', studentName);
                formData.append('class', studentClass);
                formData.append('score', finalScore);
                formData.append('assessment', aiAssessmentText || 'Không có');
                formData.append('examCode', window.examCode);
                formData.append('monitoringLog', JSON.stringify(monitoringLog));
                formData.append('answerDetails', JSON.stringify(answerDetails));

                try {
                    await fetch(window.googleScriptUrl, { method: 'POST', body: formData });
                } catch (e) { console.error("Failed to submit to Google Script:", e); }
            }
        }
        
        function renderAnswerReview(studentAnswers, answerDetails) {
            let reviewHTML = '<h3 class="text-xl font-bold mb-4 text-gray-800">Xem lại bài làm</h3>';
            window.quizData.forEach((item, i) => {
                 const mappedType = mapEnglishType(item.type);
                 reviewHTML += `<div class="mt-4 p-4 border rounded-lg ${answerDetails[i].isCorrect === false ? 'bg-red-50' : 'bg-green-50'}">`;
                 reviewHTML += `<p class="font-semibold">Câu ${i + 1}: ${item.question || item.main_question}</p>`;

                 if (mappedType === 'multiple-choice') {
                    reviewHTML += '<div class="mt-2 space-y-1">';
                    (item.options || []).forEach((opt, j) => {
                        const isSelected = studentAnswers[i] === j;
                        const isCorrect = item.correctAnswerIndex === j;
                        let classes = 'p-2 rounded ';
                        if (isCorrect) classes += 'correct';
                        else if (isSelected) classes += 'incorrect';
                        reviewHTML += `<div class="${classes}">${String.fromCharCode(65 + j)}. ${opt}</div>`;
                    });
                     reviewHTML += '</div>';
                 }
                 if (window.quizOptions.showExplanation && item.explanation) {
                     reviewHTML += `<div class="mt-2 p-2 bg-gray-100 rounded text-sm"><strong>Giải thích:</strong> ${item.explanation.replace(/\n/g, '<br>')}</div>`;
                 }
                 reviewHTML += `</div>`;
            });
            dom.answerReview.innerHTML = reviewHTML;
            if(window.MathJax) window.MathJax.typesetPromise([dom.answerReview]);
        }

        dom.startBtn.addEventListener('click', startQuiz);
        dom.nextBtn.addEventListener('click', () => { if (currentIndex < window.quizData.length - 1) { currentIndex++; renderCurrentQuestion(); }});
        dom.prevBtn.addEventListener('click', () => { if (currentIndex > 0) { currentIndex--; renderCurrentQuestion(); }});
        dom.submitBtn.addEventListener('click', () => { if (confirm('Bạn có chắc chắn muốn nộp bài không?')) { finishQuiz(); }});
    });
    </script>
    