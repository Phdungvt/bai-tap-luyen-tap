
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bài kiểm tra - 15/11/2025</title>
    <style>
        :root {
            --bg-color: #f4f5f7;
            --container-bg: #ffffff;
            --text-color: #1f2937;
            --text-muted: #6b7280;
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --primary-light: #e0e7ff;
            --green-color: #16a34a;
            --green-light: #f0fdf4;
            --red-color: #dc2626;
            --red-light: #fef2f2;
            --border-color: #d1d5db;
            --border-focus: #4f46e5;
        }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); line-height: 1.6; }
        #app { max-width: 800px; margin: 2rem auto; background-color: var(--container-bg); padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        h1, h2 { font-weight: 700; color: #111827; }
        h1 { font-size: 1.875rem; }
        h2 { font-size: 1.5rem; }
        hr { border: 0; border-top: 1px solid #e5e7eb; margin: 1.5rem 0; }
        input[type="text"], textarea { width: 100%; border: 1px solid var(--border-color); border-radius: 0.375rem; padding: 0.5rem 0.75rem; font-size: 1rem; transition: border-color 0.2s; box-sizing: border-box; }
        input[type="text"]:focus, textarea:focus { outline: none; border-color: var(--border-focus); box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2); }
        button { cursor: pointer; border: none; font-weight: 600; border-radius: 0.375rem; padding: 0.75rem 1rem; transition: background-color 0.2s; font-size: 1rem; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-secondary { background-color: #e5e7eb; color: #374151; }
        .btn-secondary:hover { background-color: #d1d5db; }
        .hidden { display: none; }
        #welcome-screen .space-y-4 > div { margin-bottom: 1rem; }
        #quiz-screen .sticky-header { position: -webkit-sticky; position: sticky; top: 0; background-color: var(--container-bg); padding: 1rem 1.5rem; margin: -1.5rem -1.5rem 1rem -1.5rem; border-bottom: 1px solid #e5e7eb; z-index: 10; display: flex; justify-content: space-between; align-items: center; }
        #timer { font-size: 1.25rem; font-weight: 700; color: var(--red-color); background-color: var(--red-light); padding: 0.5rem 1rem; border-radius: 0.5rem; }
        .question-card { margin-bottom: 2rem; padding: 1.5rem; border: 1px solid #e5e7eb; border-radius: 0.75rem; }
        .question-card p { margin: 0; }
        .prose { max-width: none; color: #374151; }
        .prose img { max-width: 100%; height: auto; border-radius: 0.5rem; margin: 0.5rem 0; }
        .prose img.latex-image { display: inline-block; vertical-align: middle; margin: 0; }
        .option { padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: flex-start; }
        .option:hover { background-color: var(--primary-light); border-color: var(--primary-color); }
        .option.selected { border-color: var(--primary-color); background-color: var(--primary-light); }
        .option.correct { border-color: var(--green-color); background-color: var(--green-light); }
        .option.incorrect { border-color: var(--red-color); background-color: var(--red-light); }
        .option > span:first-child { font-weight: 700; margin-right: 0.5rem; }
        .tf-option { display: flex; align-items: center; justify-content: space-between; gap: 1rem; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 0.5rem; }
        .tf-option .btn-group { display: flex; gap: 0.5rem; flex-shrink: 0; }
        .tf-option .btn-group button { padding: 0.5rem 1rem; background-color: #e5e7eb; }
        .tf-option .btn-group button.selected-true { background-color: var(--primary-color); color: white; }
        .tf-option .btn-group button.selected-false { background-color: var(--red-color); color: white; }
        .disabled { pointer-events: none; opacity: 0.7; }
        #results-screen { text-align: center; }
        #score-display { font-size: 3rem; font-weight: 700; color: var(--primary-color); margin: 1.5rem 0; }
        #assessment-display { margin-top: 1rem; padding: 1rem; background-color: #f3f4f6; border-radius: 0.5rem; text-align: left; }
        #review-container { text-align: left; }
        .review-q { margin-bottom: 1.5rem; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; }
        .monitoring-warning { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background-color: #ef4444; color: white; padding: 10px 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; display: none; animation: fade-in-out 5s ease-in-out; }
        @keyframes fade-in-out { 0%, 100% { opacity: 0; transform: translate(-50%, -20px); } 10%, 90% { opacity: 1; transform: translate(-50%, 0); } }
        mjx-container { display: inline-block !important; }
    </style>
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\(', '\)']], displayMath: [['$$', '$$'], ['\[', '\]']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
</head>
<body class="p-4 md:p-8">
    <div id="app" class="max-w-4xl mx-auto bg-white p-6 rounded-2xl shadow-lg">
        
        <div id="welcome-screen">
            <h1 class="text-3xl font-bold text-gray-800">Bài kiểm tra - 15/11/2025</h1>
            <p class="mt-2 text-gray-600">Mã đề: <span class="font-bold text-indigo-600">UMU5B5</span></p>
            <hr class="my-6">
            <div class="space-y-4">
                <div>
                    <label for="name" style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">Họ và tên</label>
                    <input type="text" id="name">
                </div>
                <div>
                    <label for="class" style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">Lớp</label>
                    <input type="text" id="class">
                </div>
            </div>
             <p style="margin-top: 1rem; font-size: 0.875rem; color: var(--red-color);"><strong>Lưu ý:</strong> Hệ thống sẽ giám sát việc chuyển tab, sao chép/dán. Các hành vi này sẽ được ghi lại và báo cáo cho giáo viên.</p>
            <button id="start-btn" class="btn-primary" style="margin-top: 1.5rem; width: 100%;">Bắt đầu làm bài</button>
        </div>

        <div id="quiz-screen" class="hidden">
             <div class="sticky-header">
                <h2 style="font-size: 1.5rem; font-weight: 700; color: #111827;">Bài kiểm tra - 15/11/2025</h2>
                <div id="timer"></div>
            </div>
            <div id="all-questions-container" style="margin-top: 1.5rem;"></div>
            <div style="margin-top: 2rem; display: flex; justify-content: flex-end;">
                <button id="submit-btn" style="background-color: var(--green-color); color: white; padding: 0.75rem 2rem; font-size: 1.125rem;">Nộp bài</button>
            </div>
        </div>

        <div id="results-screen" class="hidden">
            <h2 class="text-3xl font-bold text-center text-gray-800">Kết quả bài làm</h2>
            <div id="score-display" class="hidden"></div>
            <div id="assessment-display" class="hidden"></div>
            <div id="review-container" style="margin-top: 2rem;"></div>
            <div style="margin-top: 2rem; text-align: center;">
                <button id="retry-btn" class="hidden btn-primary" style="margin-right: 1rem;">Làm lại bài</button>
                <button id="restart-btn" class="btn-secondary">Về trang chủ</button>
            </div>
        </div>
        
        <div id="monitoring-warning" class="monitoring-warning">⚠️ Đã phát hiện hành vi không hợp lệ!</div>
    </div>

    <script>
    (function() {
        const API_KEY = "AIzaSyAzvr2Py2_mr5Z4R3YWXi-dyO1ufA2paas";
        const quizData = [{"question":"Lực từ là lực do từ trường tác dụng lên đối tượng nào?","options":["Điện tích đứng yên","Dây dẫn không có dòng điện","Điện tích chuyển động","Vật không nhiễm từ"],"correctAnswerIndex":2,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Lực từ là lực do từ trường tác dụng lên đối tượng nào?","rendered_options":["Điện tích đứng yên","Dây dẫn không có dòng điện","Điện tích chuyển động","Vật không nhiễm từ"]},{"question":"Một đoạn dây dẫn thẳng có dòng điện $I$ chạy qua đặt trong từ trường đều $\\vec{B}$. Nếu dòng điện có chiều từ dưới lên trên và cảm ứng từ $\\vec{B}$ có chiều đi vào mặt phẳng giấy (vuông góc với dây dẫn), thì lực từ $\\vec{F}$ tác dụng lên đoạn dây dẫn có chiều như thế nào?","options":["Từ trên xuống dưới","Từ trái sang phải","Từ phải sang trái","Đi ra khỏi mặt phẳng giấy"],"correctAnswerIndex":2,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Một đoạn dây dẫn thẳng có dòng điện $I$ chạy qua đặt trong từ trường đều $\\vec{B}$. Nếu dòng điện có chiều từ dưới lên trên và cảm ứng từ $\\vec{B}$ có chiều đi vào mặt phẳng giấy (vuông góc với dây dẫn), thì lực từ $\\vec{F}$ tác dụng lên đoạn dây dẫn có chiều như thế nào?","rendered_options":["Từ trên xuống dưới","Từ trái sang phải","Từ phải sang trái","Đi ra khỏi mặt phẳng giấy"]},{"question":"Trong trường hợp nào sau đây, một đoạn dây dẫn có dòng điện đặt trong từ trường đều sẽ không chịu tác dụng của lực từ?","options":["Dây dẫn đặt vuông góc với đường sức từ","Dây dẫn đặt song song với đường sức từ","Dây dẫn đặt hợp với đường sức từ một góc $30^{\\circ}$","Dây dẫn đặt hợp với đường sức từ một góc $60^{\\circ}$"],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Trong trường hợp nào sau đây, một đoạn dây dẫn có dòng điện đặt trong từ trường đều sẽ không chịu tác dụng của lực từ?","rendered_options":["Dây dẫn đặt vuông góc với đường sức từ","Dây dẫn đặt song song với đường sức từ","Dây dẫn đặt hợp với đường sức từ một góc $30^{\\circ}$","Dây dẫn đặt hợp với đường sức từ một góc $60^{\\circ}$"]},{"question":"Độ lớn lực từ tác dụng lên một đoạn dây dẫn có dòng điện đặt trong từ trường không phụ thuộc vào yếu tố nào sau đây?","options":["Cường độ dòng điện chạy trong dây dẫn","Chiều dài đoạn dây dẫn","Nhiệt độ của dây dẫn","Cảm ứng từ tại vị trí đặt dây dẫn"],"correctAnswerIndex":2,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Độ lớn lực từ tác dụng lên một đoạn dây dẫn có dòng điện đặt trong từ trường không phụ thuộc vào yếu tố nào sau đây?","rendered_options":["Cường độ dòng điện chạy trong dây dẫn","Chiều dài đoạn dây dẫn","Nhiệt độ của dây dẫn","Cảm ứng từ tại vị trí đặt dây dẫn"]},{"question":"Một đoạn dây dẫn thẳng có dòng điện chạy theo chiều từ phải sang trái. Đoạn dây này chịu tác dụng của lực từ có chiều từ dưới lên trên. Theo quy tắc bàn tay trái, từ trường tại vị trí đặt dây dẫn phải có chiều như thế nào?","options":["Từ trên xuống dưới","Từ trái sang phải","Đi vào mặt phẳng giấy","Đi ra khỏi mặt phẳng giấy"],"correctAnswerIndex":3,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Một đoạn dây dẫn thẳng có dòng điện chạy theo chiều từ phải sang trái. Đoạn dây này chịu tác dụng của lực từ có chiều từ dưới lên trên. Theo quy tắc bàn tay trái, từ trường tại vị trí đặt dây dẫn phải có chiều như thế nào?","rendered_options":["Từ trên xuống dưới","Từ trái sang phải","Đi vào mặt phẳng giấy","Đi ra khỏi mặt phẳng giấy"]}];
        const options = {"title":"Bài kiểm tra - 15/11/2025","timeLimit":45,"retries":1,"showAnswers":true,"showExplanation":true,"aiAssessment":true,"examCode":"UMU5B5","teacherName":"sss","scoring":{"mc":5,"tf":2,"sa":2,"essay":1,"tfMethod":"progressive"}};
        const googleScriptUrl = "https://script.google.com/macros/s/AKfycbxV_S0rNHbOQx-hnjjlQGqdvLBN5GlTog0q8erd1XMpPX7XkuGjIxJnDEPPDJQnpGnf9g/exec";
        const examCode = "UMU5B5";

        let userAnswers = new Array(quizData.length).fill(null);
        let studentName = '';
        let studentClass = '';
        let timerInterval;
        let timeRemaining = options.timeLimit * 60;
        let retriesCount = 0;
        let submissionStatus = 'pending';
        let monitoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0 };
        let genaiModulePromise = null;
        
        const welcomeScreen = document.getElementById('welcome-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const resultsScreen = document.getElementById('results-screen');
        const startBtn = document.getElementById('start-btn');
        const nameInput = document.getElementById('name');
        const classInput = document.getElementById('class');
        const timerEl = document.getElementById('timer');
        const submitBtn = document.getElementById('submit-btn');
        const scoreDisplay = document.getElementById('score-display');
        const assessmentDisplay = document.getElementById('assessment-display');
        const reviewContainer = document.getElementById('review-container');
        const retryBtn = document.getElementById('retry-btn');
        const restartBtn = document.getElementById('restart-btn');
        const warningEl = document.getElementById('monitoring-warning');

        window.selectOption = selectOption;
        window.selectTFOption = selectTFOption;
        window.saveTextAnswer = saveTextAnswer;
        window.getAIExplanation = getAIExplanation;

        startBtn.addEventListener('click', startQuiz);
        submitBtn.addEventListener('click', confirmSubmit);
        retryBtn.addEventListener('click', retryQuiz);
        restartBtn.addEventListener('click', function() { window.location.reload(); });
        
        nameInput.value = localStorage.getItem('studentName') || '';
        classInput.value = localStorage.getItem('studentClass') || '';
        
        function safeTypeset(elements) {
            if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                window.MathJax.typesetPromise(elements).catch(function (err) {
                    console.error('MathJax error: ' + err.message);
                });
            }
        }

        function loadGoogleGenAI() {
            if (!genaiModulePromise) {
                genaiModulePromise = new Promise((resolve, reject) => {
                    if (window.GoogleGenAI_Module) {
                        return resolve(window.GoogleGenAI_Module);
                    }
                    const script = document.createElement('script');
                    script.type = 'module';
                    script.onload = () => {
                        setTimeout(() => {
                            if (window.GoogleGenAI_Module) {
                                resolve(window.GoogleGenAI_Module);
                            } else {
                                reject(new Error("Failed to attach Google GenAI module to window."));
                            }
                        }, 0);
                    };
                    script.onerror = () => reject(new Error("Failed to load Google GenAI script. Check network connection."));
                    script.innerHTML = 'import { GoogleGenAI } from "https://esm.sh/@google/genai"; window.GoogleGenAI_Module = { GoogleGenAI };';
                    document.head.appendChild(script);
                });
            }
            return genaiModulePromise;
        }
        
        function startQuiz() {
            studentName = nameInput.value.trim();
            studentClass = classInput.value.trim();
            if (!studentName || !studentClass) {
                alert('Vui lòng nhập đầy đủ Họ và tên và Lớp.');
                return;
            }
            localStorage.setItem('studentName', studentName);
            localStorage.setItem('studentClass', studentClass);
            
            welcomeScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            resultsScreen.classList.add('hidden');
            
            userAnswers.fill(null);
            submissionStatus = 'pending';
            
            renderAllQuestions();
            
            if (options.timeLimit > 0) {
                timeRemaining = options.timeLimit * 60;
                startTimer();
            } else {
                timerEl.textContent = 'Không giới hạn';
            }
            startMonitoring();
        }

        function mapType(typeStr) {
             if (!typeStr) return 'multiple-choice';
             if (typeStr.startsWith('mc-') || ['cloze-test', 'sentence-ordering', 'multiple-choice', 'paragraph-sentence-ordering'].includes(typeStr)) return 'multiple-choice';
             if (typeStr.startsWith('tf-') || typeStr === 'true-false') return 'true-false';
             if (typeStr === 'short-answer' || typeStr === 'sentence-transformation') return 'short-answer';
             return 'essay';
        }
        
        function renderAllQuestions() {
            const container = document.getElementById('all-questions-container');
            let allHTML = '';

            const groupedQuestions = quizData.reduce(function(acc, q) {
                const type = mapType(q.type);
                if (!acc[type]) acc[type] = [];
                acc[type].push(q);
                return acc;
            }, {});

            const groupInfo = {
                'multiple-choice': { title: 'PHẦN I. TRẮC NGHIỆM KHÁCH QUAN' },
                'true-false': { title: 'PHẦN II. CÂU HỎI ĐÚNG - SAI' },
                'short-answer': { title: 'PHẦN III. CÂU HỎI TRẢ LỜI NGẮN' },
                'essay': { title: 'PHẦN IV. CÂU HỎI TỰ LUẬN' },
            };
            
            let questionCounter = 0;
            const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];

            partOrder.forEach(function(partType) {
                const questions = groupedQuestions[partType];
                if (!questions || questions.length === 0) return;

                const info = groupInfo[partType];
                allHTML += '<div style="margin-bottom: 1.5rem; padding-bottom: 0.75rem; border-bottom: 2px solid #e5e7eb;"><h2 style="font-size: 1.5rem; font-weight: 700; color: #111827;">' + info.title + '</h2></div>';
                
                questions.forEach(function(item) {
                    const index = quizData.indexOf(item);
                    questionCounter++;
                    
                    let contentHTML = '<div class="question-card" id="q-' + index + '">';
                    contentHTML += '<p style="font-weight: 600; font-size: 1.125rem; color: #111827; margin-bottom: 1rem;">Câu ' + questionCounter + ':</p>';
                    contentHTML += '<div class="prose" style="margin-bottom: 1rem;">' + (item.rendered_question || '') + '</div>';

                    let answerHTML = '';
                    const savedAnswer = userAnswers[index];
                    const type = mapType(item.type);
                    
                    if (type === 'multiple-choice') {
                        answerHTML = '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';
                        (item.rendered_options || []).forEach(function(opt, i) {
                            const isSelected = savedAnswer === i;
                            answerHTML += '<div class="option ' + (isSelected ? 'selected' : '') + '" data-q-index="' + index + '" data-opt-index="' + i + '" onclick="selectOption(this, ' + index + ', ' + i + ')">' +
                                                '<span>' + String.fromCharCode(65 + i) + '.</span>' +
                                                '<div>' + opt + '</div>' +
                                            '</div>';
                        });
                        answerHTML += '</div>';
                    } else if (type === 'true-false') {
                         answerHTML = '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';
                         (item.statements || []).forEach(function(stmt, i) {
                            const savedStmtAnswer = savedAnswer ? savedAnswer[i] : null;
                            const isTrueSelected = savedStmtAnswer === true;
                            const isFalseSelected = savedStmtAnswer === false;
                            answerHTML += '<div class="tf-option">' +
                                                '<div class="prose">' + (stmt.rendered_statement || '') + '</div>' +
                                                '<div class="btn-group">' +
                                                    '<button class="' + (isTrueSelected ? 'selected-true' : '') + '" onclick="selectTFOption(this, ' + index + ', ' + i + ', true)">Đúng</button>' +
                                                    '<button class="' + (isFalseSelected ? 'selected-false' : '') + '" onclick="selectTFOption(this, ' + index + ', ' + i + ', false)">Sai</button>' +
                                                '</div>' +
                                            '</div>';
                        });
                        answerHTML += '</div>';
                    } else if (type === 'short-answer') {
                        answerHTML = '<input type="text" value="' + (savedAnswer || '') + '" onchange="saveTextAnswer(this, ' + index + ')">';
                    } else if (type === 'essay') {
                        answerHTML = '<textarea rows="5" onchange="saveTextAnswer(this, ' + index + ')">' + (savedAnswer || '') + '</textarea>';
                    }

                    contentHTML += answerHTML + '</div>';
                    allHTML += contentHTML;
                });
            });
            container.innerHTML = allHTML;
            safeTypeset([container]);
        }

        function selectOption(element, qIndex, optIndex) {
            userAnswers[qIndex] = optIndex;
            const questionCard = document.getElementById('q-' + qIndex);
            questionCard.querySelectorAll('.option').forEach(function(opt) { opt.classList.remove('selected'); });
            element.classList.add('selected');
        }
        
        function selectTFOption(button, qIndex, stmtIndex, answer) {
            if (!userAnswers[qIndex] || !Array.isArray(userAnswers[qIndex])) {
                userAnswers[qIndex] = new Array(quizData[qIndex].statements.length).fill(null);
            }
            userAnswers[qIndex][stmtIndex] = answer;
            const parent = button.parentElement;
            Array.from(parent.children).forEach(function(btn) { btn.classList.remove('selected-true', 'selected-false'); });
            button.classList.add(answer ? 'selected-true' : 'selected-false');
        }
        
        function saveTextAnswer(element, qIndex) {
            userAnswers[qIndex] = element.value;
        }

        function confirmSubmit() {
            const unansweredQuestions = userAnswers.map(function(answer, index) { return { answer: answer, index: index }; })
                                                .filter(function(item) { return item.answer === null || (Array.isArray(item.answer) && item.answer.some(function(a) { return a === null; })); });

            let message = "Bạn có chắc chắn muốn nộp bài không?";
            if (unansweredQuestions.length > 0) {
                message = 'Bạn còn ' + unansweredQuestions.length + ' câu chưa hoàn thành. Bạn có chắc chắn muốn nộp bài không?';
            }

            if (confirm(message)) {
                submitQuiz();
            }
        }
        
        async function submitQuiz() {
            if (submissionStatus !== 'pending') return;
            submissionStatus = 'submitting';
            stopTimer();
            stopMonitoring();
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span style="animation: pulse 1.5s infinite;">Đang nộp bài...</span>';

            const result = calculateScore();
            const finalScore = (result.totalPossibleScore > 0 ? (result.score / result.totalPossibleScore * 10) : 0).toFixed(2);
            let aiAssessment = 'Không có';
            
            // Wait for AI Assessment before doing anything else
            try {
                if (options.aiAssessment && API_KEY) {
                    assessmentDisplay.innerHTML = '<strong>Nhận xét từ AI:</strong> <span style="animation: pulse 1.5s infinite;">AI đang phân tích bài làm...</span>';
                    assessmentDisplay.classList.remove('hidden');
                    aiAssessment = await getAIAssessment(finalScore, result.answerDetails);
                }
            } catch (e) {
                console.error("Error getting AI assessment:", e);
                aiAssessment = "Đã xảy ra lỗi khi AI tạo nhận xét.";
            }
            
            // Create data payload
            const submissionData = new URLSearchParams();
            submissionData.append('timestamp', new Date().toLocaleString('vi-VN'));
            submissionData.append('name', studentName);
            submissionData.append('class', studentClass);
            submissionData.append('score', finalScore);
            submissionData.append('assessment', aiAssessment);
            submissionData.append('examCode', examCode);
            submissionData.append('monitoringLog', JSON.stringify(monitoringLog));
            submissionData.append('answerDetails', JSON.stringify(result.answerDetails));

            // Fire-and-forget submission to Google Script
            if (googleScriptUrl) {
                fetch(googleScriptUrl, {
                    method: 'POST',
                    body: submissionData,
                }).then(response => {
                    if (!response.ok) {
                        console.error('Lỗi khi gửi bài lên Google Script (nền):', response.statusText);
                    } else {
                        console.log('Đã gửi bài thành công (nền).');
                    }
                }).catch(error => {
                    console.error('Lỗi mạng khi gửi bài (nền):', error);
                });
            }
            
            // Immediately transition to results screen
            submissionStatus = 'submitted';
            showResults(finalScore, aiAssessment, result.answerDetails);
        }

        function showResults(score, assessment, answerDetails) {
            quizScreen.classList.add('hidden');
            resultsScreen.classList.remove('hidden');
            
            if (options.showAnswers) {
                scoreDisplay.textContent = score + ' / 10';
                scoreDisplay.classList.remove('hidden');
            } else {
                scoreDisplay.innerHTML = '<p style="font-size: 1.875rem; text-align: center; color: var(--green-color);">Nộp bài thành công!</p>';
                scoreDisplay.classList.remove('hidden');
            }
            
            if (options.aiAssessment) {
                assessmentDisplay.innerHTML = '<strong>Nhận xét từ AI:</strong> <br> ' + assessment.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                assessmentDisplay.classList.remove('hidden');
            } else {
                assessmentDisplay.classList.add('hidden');
            }
            
            if (options.showAnswers) {
                renderReview(answerDetails);
            } else {
                reviewContainer.innerHTML = '<p style="text-align: center; color: var(--text-muted);">Giáo viên đã chọn không hiển thị đáp án và giải thích chi tiết.</p>';
            }
            
            if (retriesCount < options.retries) retryBtn.classList.remove('hidden');
        }

        function calculateScore() {
            let score = 0;
            let totalPossibleScore = 0;
            const answerDetails = [];
            
            const mcCount = quizData.filter(function(q) { return mapType(q.type) === 'multiple-choice'; }).length;
            const tfCount = quizData.filter(function(q) { return mapType(q.type) === 'true-false'; }).length;
            const saCount = quizData.filter(function(q) { return mapType(q.type) === 'short-answer'; }).length;

            const pointsPerMc = mcCount > 0 ? (options.scoring.mc || 0) / mcCount : 0;
            const pointsPerTf = tfCount > 0 ? (options.scoring.tf || 0) / tfCount : 0;
            const pointsPerSa = saCount > 0 ? (options.scoring.sa || 0) / saCount : 0;
            
            totalPossibleScore = (options.scoring.mc || 0) + (options.scoring.tf || 0) + (options.scoring.sa || 0) + (options.scoring.essay || 0);
            if (totalPossibleScore === 0) { // Fallback if scoring not set
                 totalPossibleScore = (pointsPerMc * mcCount) + (pointsPerTf * tfCount) + (pointsPerSa * saCount);
                 if (totalPossibleScore === 0 && quizData.length > 0) totalPossibleScore = 10;
            }

            quizData.forEach(function(item, index) {
                const userAnswer = userAnswers[index];
                let isCorrect = false;
                let detail = null;
                const type = mapType(item.type);

                if (type === 'multiple-choice') {
                    isCorrect = userAnswer === item.correctAnswerIndex;
                    if(isCorrect) score += pointsPerMc;
                } else if (type === 'true-false') {
                    let correctStatements = 0;
                    detail = [];
                    (item.statements || []).forEach(function(stmt, i) {
                        const isStmtCorrect = (userAnswer && userAnswer[i] === stmt.is_correct);
                        if(isStmtCorrect) correctStatements++;
                        detail.push({isCorrect: isStmtCorrect});
                    });

                    if (options.scoring.tfMethod === 'even') {
                        score += (correctStatements / 4) * pointsPerTf;
                    } else { // progressive
                        if (correctStatements === 4) score += pointsPerTf;
                        else if (correctStatements === 3) score += 0.5 * pointsPerTf;
                        else if (correctStatements === 2) score += 0.25 * pointsPerTf;
                        else if (correctStatements === 1) score += 0.1 * pointsPerTf;
                    }
                    isCorrect = correctStatements === 4;
                } else {
                    isCorrect = null;
                }
                answerDetails.push({ questionNumber: index + 1, isCorrect: isCorrect, type: type, details: detail });
            });
            return { score: score, totalPossibleScore: totalPossibleScore, answerDetails: answerDetails };
        }
        
        function renderReview(answerDetails) {
            let reviewHTML = '<h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem;">Xem lại bài làm</h3>';
            quizData.forEach(function(item, index) {
                reviewHTML += '<div class="review-q">';
                reviewHTML += '<p style="font-weight: 600; margin-bottom: 0.5rem;">Câu ' + (index + 1) + ':</p><div class="prose">' + item.rendered_question + '</div>';
                const type = mapType(item.type);
                const detail = answerDetails.find(function(d) { return d.questionNumber === index + 1; });

                if (type === 'multiple-choice') {
                     reviewHTML += '<div style="margin-top: 1rem; display: flex; flex-direction: column; gap: 0.5rem;">';
                     (item.rendered_options || []).forEach(function(opt, i) {
                        let classes = 'option';
                        if (i === item.correctAnswerIndex) classes += ' correct';
                        if (userAnswers[index] === i && i !== item.correctAnswerIndex) classes += ' incorrect';
                        reviewHTML += '<div class="' + classes + '"><span>' + String.fromCharCode(65 + i) + '.</span> <div>' + opt + '</div></div>';
                     });
                     reviewHTML += '</div>';
                } else if (type === 'true-false') {
                     reviewHTML += '<div style="margin-top: 1rem; display: flex; flex-direction: column; gap: 0.5rem;">';
                     (item.statements || []).forEach(function(stmt, i) {
                         let classes = 'tf-option';
                         const userChoice = userAnswers[index] ? userAnswers[index][i] : null;
                         const isCorrect = userChoice === stmt.is_correct;
                         if (isCorrect) classes += ' correct';
                         else if (userChoice !== null) classes += ' incorrect';

                         reviewHTML += '<div class="' + classes + '">' +
                                         '<div class="prose">' + stmt.rendered_statement + '</div>' +
                                         '<div style="flex-shrink: 0; font-weight: 700; font-size: 0.875rem; text-align: right;">' +
                                             '<span>Đáp án: ' + (stmt.is_correct ? 'Đ' : 'S') + '</span><br>' +
                                             '<span>Bạn chọn: ' + (userChoice === true ? 'Đ' : userChoice === false ? 'S' : '...') + '</span>' +
                                         '</div>' +
                                     '</div>';
                     });
                     reviewHTML += '</div>';
                } else {
                    reviewHTML += '<div style="margin-top: 1rem; padding: 0.75rem; background-color: #f3f4f6; border-radius: 0.5rem;"><strong>Câu trả lời của bạn:</strong><br>' + (userAnswers[index] || '<em>Chưa trả lời</em>') + '</div>';
                    if (item.rendered_answer) {
                        reviewHTML += '<div style="margin-top: 0.5rem; padding: 0.75rem; background-color: var(--primary-light); border-radius: 0.5rem;"><strong>Đáp án gợi ý:</strong><br><div class="prose">' + item.rendered_answer + '</div></div>';
                    }
                }
                
                if (options.showExplanation && API_KEY) {
                     reviewHTML += '<div style="margin-top: 1rem;">' +
                                      '<button style="font-size: 0.875rem; color: var(--primary-color); text-decoration: underline; background: none; border: none; padding: 0;" onclick="getAIExplanation(' + index + ', this)">Xem giải thích từ AI</button>' +
                                      '<div id="explanation-' + index + '" class="hidden" style="margin-top: 0.5rem; padding: 0.75rem; background-color: var(--primary-light); border: 1px solid #c7d2fe; border-radius: 0.5rem;"></div>' +
                                   '</div>';
                }
                reviewHTML += '</div>';
            });
            reviewContainer.innerHTML = reviewHTML;
            safeTypeset([reviewContainer]);
        }

        function retryQuiz() {
            retriesCount++;
            startQuiz();
        }
        
        function startTimer() {
            stopTimer();
            timerInterval = setInterval(function() {
                timeRemaining--;
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                timerEl.textContent = String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
                if (timeRemaining <= 0) {
                    stopTimer();
                    alert('Đã hết thời gian làm bài!');
                    submitQuiz();
                }
            }, 1000);
        }

        function stopTimer() { clearInterval(timerInterval); }
        
        function showWarning(message) {
            warningEl.textContent = message;
            warningEl.style.display = 'block';
            warningEl.style.animation = 'none';
            warningEl.offsetHeight; 
            warningEl.style.animation = 'fade-in-out 5s ease-in-out';
        }

        function handleVisibilityChange() {
            if (document.hidden) {
                monitoringLog.thoatManHinh++;
                showWarning('⚠️ Đã phát hiện chuyển tab hoặc thu nhỏ cửa sổ!');
            }
        }
        function handleCopy() { monitoringLog.saoChep++; showWarning('⚠️ Đã phát hiện hành vi sao chép!'); }
        function handlePaste() { monitoringLog.dan++; showWarning('⚠️ Đã phát hiện hành vi dán!'); }
        function startMonitoring() {
            monitoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0 };
            document.addEventListener('visibilitychange', handleVisibilityChange);
            document.addEventListener('copy', handleCopy);
            document.addEventListener('paste', handlePaste);
        }
        function stopMonitoring() {
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            document.removeEventListener('copy', handleCopy);
            document.removeEventListener('paste', handlePaste);
        }

        function stripHtml(html) {
            if (!html) return "";
            let tempDiv = document.createElement("div");
            tempDiv.innerHTML = html;
            return tempDiv.textContent || tempDiv.innerText || "";
        }

        async function getAIExplanation(index, button) {
            if (!API_KEY) return;
            const explanationContainer = document.getElementById('explanation-' + index);
            if (!explanationContainer) return;
            
            const isHidden = explanationContainer.classList.contains('hidden');

            if (!isHidden && quizData[index].explanation) {
                explanationContainer.classList.add('hidden');
                button.textContent = 'Xem giải thích từ AI';
                return;
            }
            
            explanationContainer.classList.remove('hidden');

            if (quizData[index].explanation) {
                explanationContainer.innerHTML = quizData[index].rendered_explanation;
                safeTypeset([explanationContainer]);
                button.textContent = 'Ẩn giải thích';
                return;
            }

            button.disabled = true;
            button.textContent = 'AI đang giải thích...';
            explanationContainer.innerHTML = '<div style="animation: pulse 1.5s infinite;">Đang tải...</div>';
            
            try {
                const { GoogleGenAI } = await loadGoogleGenAI();
                const ai = new GoogleGenAI({apiKey: API_KEY});
                
                const item = quizData[index];
                const questionText = (mapType(item.type) === 'true-false') ? item.main_question : item.question;
                let prompt = 'Bạn là một trợ lý giáo viên AI, am hiểu sâu sắc Chương trình GDPT 2018 của Việt Nam. Hãy cung cấp một lời giải chi tiết, từng bước một cho câu hỏi sau đây. Lời giải phải chính xác, dễ hiểu và phù hợp với phương pháp giảng dạy của chương trình GDPT 2018.\n---**CÂU HỎI:**\n' + stripHtml(item.rendered_question) + '\n---';

                if (mapType(item.type) === 'multiple-choice') {
                    prompt += '\n**CÁC LỰA CHỌN:**\n';
                    item.options.forEach(function(opt, i) { prompt += String.fromCharCode(65 + i) + '. ' + stripHtml(item.rendered_options[i]) + '\n'; });
                    prompt += '---\n**ĐÁP ÁN ĐÚNG:** ' + String.fromCharCode(65 + item.correctAnswerIndex) + '. ' + stripHtml(item.rendered_options[item.correctAnswerIndex]);
                } else if (mapType(item.type) === 'true-false') {
                    prompt += '\n**CÁC MỆNH ĐỀ VÀ ĐÁP ÁN:**\n';
                    item.statements.forEach(function(s, i) { prompt += String.fromCharCode(97 + i) + ') ' + stripHtml(s.rendered_statement) + ' -> ' + (s.is_correct ? 'Đúng' : 'Sai') + '\n'; });
                } else {
                    prompt += '---\n**ĐÁP ÁN / GỢI Ý:** ' + stripHtml(item.rendered_answer);
                }
                
                prompt += '\n---\n**YÊU CẦU:** Hãy giải thích chi tiết từng bước để đi đến đáp án đúng. Định dạng tất cả các công thức toán học bằng LaTeX. Dùng **...** để in đậm các thuật ngữ quan trọng.';
                
                const response = await ai.models.generateContent({ model: "gemini-2.5-flash", contents: prompt });
                const explanationText = response.text || "Không thể tạo giải thích.";
                
                quizData[index].explanation = explanationText;
                
                let htmlContent = explanationText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                quizData[index].rendered_explanation = htmlContent;
                
                explanationContainer.innerHTML = htmlContent;
                safeTypeset([explanationContainer]);

            } catch (error) {
                console.error("Error getting AI explanation:", error);
                explanationContainer.innerHTML = '<p style="color: var(--red-color);">Lỗi khi tạo giải thích.</p>';
            } finally {
                button.disabled = false;
                button.textContent = 'Ẩn giải thích';
            }
        }

        async function getAIAssessment(score, answerDetails) {
            if (!API_KEY) return "Không thể tạo nhận xét do thiếu API key.";
            
            try {
                const { GoogleGenAI } = await loadGoogleGenAI();
                const ai = new GoogleGenAI({apiKey: API_KEY});
                
                const wrongAnswers = answerDetails.filter(function(d) { return d.isCorrect === false || (d.type === 'true-false' && d.details && d.details.some(function(sub) { return !sub.isCorrect; })); });

                if (wrongAnswers.length === 0) {
                    return "Chúc mừng em đã hoàn thành bài làm rất tốt và không sai câu nào! Em đã nắm vững kiến thức. Hãy tiếp tục phát huy nhé!";
                }

                const wrongQuestionsSummary = wrongAnswers.map(function(d) {
                    const q = quizData[d.questionNumber - 1];
                    const questionContent = stripHtml(q.rendered_question || q.question || q.main_question);
                    return '- Câu ' + d.questionNumber + ': ' + questionContent;
                }).join('\n');
                
                const prompt = 'Bạn là một giáo viên AI tận tâm và giàu kinh nghiệm, chuyên đưa ra những nhận xét mang tính xây dựng. Dựa vào kết quả bài làm của một học sinh, hãy đưa ra một nhận xét chi tiết (khoảng 4-5 câu) về năng lực của học sinh.\n\n**Kết quả bài làm:**\n- **Điểm số:** ' + score + ' / 10\n- **Các câu học sinh đã trả lời sai:**\n' + wrongQuestionsSummary + '\n\n**YÊU CẦU NHẬN XÉT (RẤT QUAN TRỌNG):**\n1.  Bắt đầu bằng một lời động viên, ghi nhận sự cố gắng của học sinh.\n2.  **Phân tích nội dung các câu sai:** Đọc và hiểu nội dung của từng câu học sinh làm sai. Từ đó, **xác định cụ thể các mảng kiến thức hoặc kỹ năng mà học sinh còn yếu.**\n    *   **VÍ DỤ TỐT (Nên làm):** "Qua các câu sai, cô/thầy nhận thấy em có vẻ chưa vững kiến thức về \'tính đơn điệu của hàm số bậc ba\' (câu 5) và còn nhầm lẫn khi áp dụng \'định lý Viète\' (câu 12)."\n    *   **VÍ DỤ KÉM (Không làm):** "Em đã làm sai một số câu. Em cần cẩn thận hơn." (Quá chung chung).\n3.  **Đưa ra gợi ý cụ thể:** Dựa trên phân tích ở bước 2, hãy đưa ra lời khuyên cụ thể, mang tính hành động. Ví dụ: "Em nên xem lại bài giảng về..., làm thêm các bài tập dạng..., hoặc chú ý hơn đến các trường hợp đặc biệt của...".\n4.  Kết thúc bằng một lời khích lệ, tạo động lực cho học sinh cố gắng hơn trong lần sau.\n5.  Giọng văn phải thật sự thân thiện, tích cực, như một giáo viên đang trực tiếp nhận xét cho học trò của mình.';

                const response = await ai.models.generateContent({ model: "gemini-2.5-flash", contents: prompt });
                return response.text || "Không thể tạo nhận xét.";

            } catch (error) {
                console.error("Error generating AI assessment:", error);
                return "Đã có lỗi xảy ra trong quá trình AI tạo nhận xét.";
            }
        }
    })();
    </script>
</body>
</html>
    