<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BÀI TẬP VỀ NHÀ - LŨY THỪA</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- MathJax Configuration -->
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #f9fafb; -webkit-tap-highlight-color: transparent; }
        .prose img { border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); max-width: 100%; height: auto; }
        .hidden { display: none !important; }
        /* Sticky Header Progress */
        #header-progress { position: sticky; top: 0; z-index: 40; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        /* Mobile Navigation Bottom Bar */
        .mobile-bottom-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; border-top: 1px solid #e5e7eb;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0.75rem 1rem; z-index: 50;
            padding-bottom: env(safe-area-inset-bottom, 0.75rem);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Drawer Transition */
        #nav-panel { transition: transform 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col text-gray-800">

    <!-- WELCOME SCREEN -->
    <div id="welcome-screen" class="flex-grow flex items-center justify-center p-4">
        <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl w-full max-w-md border border-indigo-50">
            <div class="text-center mb-6">
                <div class="bg-indigo-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                    </svg>
                </div>
                <h1 class="text-xl sm:text-2xl font-bold text-gray-800 mb-1 leading-tight">BÀI TẬP VỀ NHÀ - LŨY THỪA</h1>
                <p class="text-gray-500 text-sm">Giáo viên: PHẠM ANH DŨNG</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Họ và tên</label>
                    <input type="text" id="name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow outline-none" placeholder="Nhập họ tên của bạn">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Lớp</label>
                    <input type="text" id="class" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow outline-none" placeholder="Nhập lớp (VD: 12A1)">
                </div>
                 
                <div id="api-key-input-container">
                    <div class="flex justify-between items-center mb-1">
                        <label class="block text-sm font-medium text-gray-700">Gemini API Key (Nhập key nếu GV yêu cầu)</label>
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-red-600 hover:text-red-800 font-bold hover:underline">Link lấy API KEY miễn phí</a>
                    </div>
                    <input type="password" id="student-api-key" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow outline-none" placeholder="Nhập API Key">
                </div>
                <button id="start-btn" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-3.5 px-4 rounded-xl shadow-md transition-transform transform active:scale-95 mt-2 text-base">
                    BẮT ĐẦU LÀM BÀI
                </button>
            </div>
        </div>
    </div>

    <!-- QUIZ SCREEN -->
    <div id="quiz-screen" class="hidden flex flex-col h-screen bg-gray-50">
        <!-- Sticky Header with Info & Progress -->
        <header id="header-progress" class="flex-shrink-0 bg-white shadow-sm z-40">
            <div class="px-4 py-3 flex items-center justify-between border-b border-gray-100">
                <div class="flex items-center gap-3 overflow-hidden">
                    <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold text-xs shrink-0">HS</div>
                    <div class="flex flex-col min-w-0">
                        <div class="font-bold text-gray-800 text-sm truncate" id="student-name-display">--</div>
                        <div class="text-xs text-gray-500 truncate" id="progress-text">0/60</div>
                    </div>
                </div>
                <div class="flex flex-col items-end">
                    <span class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Thời gian</span>
                    <span id="timer" class="text-lg font-mono font-bold text-indigo-600">00:00</span>
                </div>
            </div>
            <!-- Progress Bar -->
            <div class="h-1 w-full bg-gray-200">
                <div class="h-1 bg-green-500 transition-all duration-300" style="width: 0%" id="progress-bar"></div>
            </div>
        </header>

        <!-- Body Container -->
        <div class="flex flex-1 overflow-hidden relative">
            <!-- Main Scrollable Area (Questions) -->
            <main class="flex-1 overflow-y-auto p-4 sm:p-6 bg-gray-50 scroll-smooth relative" id="main-scroll-area">
                <div class="max-w-6xl mx-auto" id="questions-wrapper">
                     <div id="questions-container">
                        <!-- Questions injected here -->
                     </div>
                     <!-- NEW SUBMIT BUTTON -->
                    <div class="mt-8 mb-20 text-center">
                        <button id="main-submit-btn" class="inline-flex items-center justify-center gap-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-4 px-12 rounded-xl shadow-lg transition-transform transform active:scale-95 text-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" /></svg>
                            NỘP BÀI THI
                        </button>
                    </div>
                </div>
            </main>
            
            <!-- Navigation Sidebar (Desktop) -->
            <aside id="nav-panel" class="w-80 bg-white border-l border-gray-200 overflow-y-auto hidden md:flex flex-col z-30 shadow-lg md:shadow-none">
                <div class="p-4 border-b border-gray-100 bg-gray-50 sticky top-0 z-10">
                    <h3 class="font-bold text-gray-700 text-lg">Danh sách câu hỏi</h3>
                </div>
                
                <div class="flex-1 p-4">
                    <div class="grid grid-cols-5 gap-3" id="nav-grid">
                        <!-- Nav buttons injected here -->
                    </div>
                </div>
                
                <div class="p-4 border-t border-gray-100 bg-white sticky bottom-0 z-10">
                     <div class="grid grid-cols-2 gap-2 text-xs text-center mb-4 text-gray-500">
                        <div class="flex items-center gap-1 justify-center"><span class="w-3 h-3 rounded bg-gray-100 border border-gray-200"></span> Chưa làm</div>
                        <div class="flex items-center gap-1 justify-center"><span class="w-3 h-3 rounded bg-indigo-600 border border-indigo-600"></span> Đã làm</div>
                    </div>
                    <button id="submit-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl shadow-md transition-colors flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" /></svg>
                        NỘP BÀI
                    </button>
                </div>
            </aside>
        </div>
        
        <!-- Mobile Bottom Navigation Bar -->
        <div class="mobile-bottom-bar md:hidden">
            <button id="mobile-prev-btn" class="p-2 text-gray-500 hover:text-indigo-600 disabled:opacity-30 disabled:cursor-not-allowed">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
            </button>
            
            <button id="mobile-menu-btn" class="flex items-center gap-2 px-4 py-2 bg-indigo-50 text-indigo-700 rounded-full font-semibold text-sm hover:bg-indigo-100 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                <span id="mobile-current-q">Câu 1/60</span>
            </button>
            
            <button id="mobile-next-btn" class="p-2 text-gray-500 hover:text-indigo-600 disabled:opacity-30 disabled:cursor-not-allowed">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
            </button>
        </div>

        <!-- Mobile Drawer Overlay -->
        <div id="nav-overlay" class="fixed inset-0 bg-black/30 z-40 hidden md:hidden glass-effect" onclick="document.getElementById('mobile-drawer').classList.add('translate-x-full'); this.classList.add('hidden');"></div>
        
        <!-- Mobile Drawer -->
        <aside id="mobile-drawer" class="fixed inset-y-0 right-0 w-72 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-50 flex flex-col md:hidden">
             <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-gray-700 text-lg">Danh sách câu hỏi</h3>
                <button class="p-2 text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-200" onclick="document.getElementById('mobile-drawer').classList.add('translate-x-full'); document.getElementById('nav-overlay').classList.add('hidden');">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-4" id="mobile-nav-grid-container">
                <!-- Will duplicate nav grid here via JS -->
            </div>
             <div class="p-4 border-t border-gray-100 bg-white">
                 <button id="drawer-submit-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 px-4 rounded-xl shadow-lg transition-colors flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" /></svg>
                    NỘP BÀI THI
                </button>
            </div>
        </aside>
    </div>

    <!-- RESULT SCREEN -->
    <div id="result-screen" class="hidden flex-grow bg-gray-50 overflow-y-auto p-4">
        <div class="max-w-4xl mx-auto space-y-6">
            <!-- Score Card -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden text-center p-8 border border-gray-200 relative">
                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-green-400 to-blue-500"></div>
                <h2 class="text-3xl font-bold text-gray-800 mb-2">Kết Quả Bài Làm</h2>
                <div class="text-6xl font-black text-indigo-600 my-6 tracking-tighter" id="score-display">--</div>
                
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm bg-gray-50 p-4 rounded-xl border border-gray-100">
                    <div>
                        <p class="text-gray-500 uppercase text-xs font-semibold">Họ tên</p>
                        <p class="font-medium text-gray-900 text-lg" id="result-name">--</p>
                    </div>
                    <div>
                        <p class="text-gray-500 uppercase text-xs font-semibold">Lớp</p>
                        <p class="font-medium text-gray-900 text-lg" id="result-class">--</p>
                    </div>
                    <div>
                        <p class="text-gray-500 uppercase text-xs font-semibold">Thời gian</p>
                        <p class="font-medium text-gray-900 text-lg" id="result-time">--</p>
                    </div>
                </div>

                <div id="ai-assessment-container" class="mt-8 hidden text-left bg-indigo-50 p-6 rounded-xl border border-indigo-100">
                    <h3 class="flex items-center gap-2 font-bold text-indigo-800 mb-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                        Nhận xét từ AI
                    </h3>
                    <div id="ai-assessment-content" class="prose prose-sm prose-indigo max-w-none text-gray-700"></div>
                </div>

                <div class="mt-8">
                     <button id="view-answers-btn" class="hidden inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                        Xem đáp án chi tiết
                    </button>
                </div>
            </div>

            <!-- Detailed Answers -->
            <div id="detailed-answers" class="hidden bg-white rounded-2xl shadow-lg border border-gray-200 p-6 sm:p-8">
                <!-- Content injected by JS -->
            </div>
        </div>
    </div>

    <!-- CLIENT LOGIC SCRIPT -->
    <script type="module">
        
    import { GoogleGenAI } from "https://esm.sh/@google/genai@^1.13.0";

    // --- 1. DECODE DATA ---
    const quizData = JSON.parse(decodeURIComponent(escape(atob("W3sicXVlc3Rpb24iOiJDaG8gc+G7kSB0aOG7sWMgJGEkIHbDoCBjw6FjIHPhu5Egbmd1ecOqbiBkxrDGoW5nICRtLCBuJC4gS2jhurNuZyDEkeG7i25oIG7DoG8gc2F1IMSRw6J5IGzDoCDEkcO6bmc/Iiwib3B0aW9ucyI6WyIkYV5tIFx0LiBhXm4gPSBhXnttK259JCIsIiRhXm0gLiBhXm4gPSBhXnttIC4gbn0kIiwiJGFebSBcdC4gYV5uID0gYV57bS1ufSQiLCIkYV5tIFx0LiBhXm4gPSAoMmEpXnttK259JCJdLCJjb3JyZWN0QW5zd2VySW5kZXgiOjAsInR5cGUiOiJtdWx0aXBsZS1jaG9pY2UiLCJpc0RpcnR5Ijp0cnVlLCJleHBsYW5hdGlvbiI6bnVsbCwic2h1ZmZsZU9wdGlvbnMiOnsic3RlbSI6dHJ1ZSwiYW5zd2VycyI6dHJ1ZX0sInF1ZXN0aW9uTnVtYmVyIjoxLCJxdWVzdGlvbkltYWdlIjpudWxsLCJvcHRpb25zSW1hZ2UiOltudWxsLG51bGwsbnVsbCxudWxsXSwiaWQiOiJxXzE0ODg1MjQyODUiLCJxdWVzdGlvblNuaXBwZXQiOiJDaG8gc+G7kSB0aOG7sWMgJGEkIHbDoCBjw6FjIHPhu5Egbmd1ecOqbiBkxrDGoW5nICRtLCBuJC4gS2jhurNuZyDEkeG7i25oIG7DoG8gc2F1IMSRw6J5IC4uLiIsInJlbmRlcmVkX3F1ZXN0aW9uIjoiQ2hvIHPhu5EgdGjhu7FjICRhJCB2w6AgY8OhYyBz4buRIG5ndXnDqm4gZMawxqFuZyAkbSwgbiQuIEto4bqzbmcgxJHhu4tuaCBuw6BvIHNhdSDEkcOieSBsw6AgxJHDum5nPyIsInJlbmRlcmVkX29wdGlvbnMiOlsiJGFebSBcdC4gYV5uID0gYV57bStufSQiLCIkYV5tIC4gYV5uID0gYV57bSAuIG59JCIsIiRhXm0gXHQuIGFebiA9IGFee20tbn0kIiwiJGFebSBcdC4gYV5uID0gKDJhKV57bStufSQiXX0seyJxdWVzdGlvbiI6Ilbhu5tpICRhJCBsw6Agc+G7kSB0aOG7sWMgZMawxqFuZyB0w7l5IMO9LCBiaeG7g3UgdGjhu6ljICRcXHNxcnRbNV17YV4yfSQgxJHGsOG7o2Mgdmnhur90IGTGsOG7m2kgZOG6oW5nIGzFqXkgdGjhu6thIHbhu5tpIHPhu5EgbcWpIGjhu691IHThu4kgbMOgPyIsIm9wdGlvbnMiOlsiJGFee1xcZGZyYWN7NX17Mn19JCIsIiRhXntcXGRmcmFjezJ9ezV9fSQiLCIkYV57MTB9JCIsIiRhXjckIl0sImNvcnJlY3RBbnN3ZXJJbmRleCI6MSwidHlwZSI6Im11bHRpcGxlLWNob2ljZSIsImlzRGlydHkiOmZhbHNlLCJleHBsYW5hdGlvbiI6bnVsbCwic2h1ZmZsZU9wdGlvbnMiOnsic3RlbSI6dHJ1ZSwiYW5zd2VycyI6dHJ1ZX0sInF1ZXN0aW9uTnVtYmVyIjoyLCJpZCI6InFfMTg2NDU4NDA0MyIsInF1ZXN0aW9uU25pcHBldCI6Ilbhu5tpICRhJCBsw6Agc+G7kSB0aOG7sWMgZMawxqFuZyB0w7l5IMO9LCBiaeG7g3UgdGjhu6ljICRcXHNxcnRbNV17YV4yfSQgxJHGsOG7o2Mgdmnhur90IGTGsC4uLiIsInJlbmRlcmVkX3F1ZXN0aW9uIjoiVuG7m2kgJGEkIGzDoCBz4buRIHRo4buxYyBkxrDGoW5nIHTDuXkgw70sIGJp4buDdSB0aOG7qWMgJFxcc3FydFs1XXthXjJ9JCDEkcaw4bujYyB2aeG6v3QgZMaw4bubaSBk4bqhbmcgbMWpeSB0aOG7q2EgduG7m2kgc+G7kSBtxakgaOG7r3UgdOG7iSBsw6A/IiwicmVuZGVyZWRfb3B0aW9ucyI6WyIkYV57XFxkZnJhY3s1fXsyfX0kIiwiJGFee1xcZGZyYWN7Mn17NX19JCIsIiRhXnsxMH0kIiwiJGFeNyQiXX0seyJxdWVzdGlvbiI6IkNobyAkYSQgbMOgIHPhu5EgdGjhu7FjIGTGsMahbmcuIEJp4buDdSB0aOG7qWMgJFAgPSBhXntcXGRmcmFjezJ9ezN9fSAuICBhXntcXGRmcmFjezF9ezN9fSQgYuG6sW5nPyIsIm9wdGlvbnMiOlsiJGFee1xcZGZyYWN7Mn17OX19JCIsIiRhJCIsIiRhXntcXGRmcmFjezF9ezN9fSQiLCIkYV4yJCJdLCJjb3JyZWN0QW5zd2VySW5kZXgiOjEsInR5cGUiOiJtdWx0aXBsZS1jaG9pY2UiLCJpc0RpcnR5Ijp0cnVlLCJleHBsYW5hdGlvbiI6bnVsbCwic2h1ZmZsZU9wdGlvbnMiOnsic3RlbSI6dHJ1ZSwiYW5zd2VycyI6dHJ1ZX0sInF1ZXN0aW9uTnVtYmVyIjozLCJxdWVzdGlvbkltYWdlIjpudWxsLCJvcHRpb25zSW1hZ2UiOltudWxsLG51bGwsbnVsbCxudWxsXSwiaWQiOiJxXzExMzcxMjE4NjkiLCJxdWVzdGlvblNuaXBwZXQiOiJDaG8gJGEkIGzDoCBz4buRIHRo4buxYyBkxrDGoW5nLiBCaeG7g3UgdGjhu6ljICRQID0gYV57XFxkZnJhY3syfXszfX0gLiAgYV57XFxkZnJhYy4uLiIsInJlbmRlcmVkX3F1ZXN0aW9uIjoiQ2hvICRhJCBsw6Agc+G7kSB0aOG7sWMgZMawxqFuZy4gQmnhu4N1IHRo4bupYyAkUCA9IGFee1xcZGZyYWN7Mn17M319IC4gIGFee1xcZGZyYWN7MX17M319JCBi4bqxbmc/IiwicmVuZGVyZWRfb3B0aW9ucyI6WyIkYV57XFxkZnJhY3syfXs5fX0kIiwiJGEkIiwiJGFee1xcZGZyYWN7MX17M319JCIsIiRhXjIkIl19LHsicXVlc3Rpb24iOiJW4bubaSAkYSwgYiQgbMOgIGPDoWMgc+G7kSB0aOG7sWMgZMawxqFuZyB2w6AgJFxcYWxwaGEkIGzDoCBz4buRIHRo4buxYyB0w7l5IMO9LCBraOG6s25nIMSR4buLbmggbsOgbyBzYXUgxJHDonkgbMOgIMSRw7puZz8iLCJvcHRpb25zIjpbIiQoYSAuIGIpXntcXGFscGhhfSA9IGFee1xcYWxwaGF9ICsgYl57XFxhbHBoYX0kIiwiJChhK2IpXntcXGFscGhhfSA9IGFee1xcYWxwaGF9ICsgYl57XFxhbHBoYX0kIiwiJChhIC4gYilee1xcYWxwaGF9ID0gYV57XFxhbHBoYX0gLiBiXntcXGFscGhhfSQiLCIkKGEgLiBiKV57XFxhbHBoYX0gPSBhIC4gYl57XFxhbHBoYX0kIl0sImNvcnJlY3RBbnN3ZXJJbmRleCI6MiwidHlwZSI6Im11bHRpcGxlLWNob2ljZSIsImlzRGlydHkiOnRydWUsImV4cGxhbmF0aW9uIjpudWxsLCJzaHVmZmxlT3B0aW9ucyI6eyJzdGVtIjp0cnVlLCJhbnN3ZXJzIjp0cnVlfSwicXVlc3Rpb25OdW1iZXIiOjQsInF1ZXN0aW9uSW1hZ2UiOm51bGwsIm9wdGlvbnNJbWFnZSI6W251bGwsbnVsbCxudWxsLG51bGxdLCJpZCI6InFfMTQ4ODk5NTUxNCIsInF1ZXN0aW9uU25pcHBldCI6Ilbhu5tpICRhLCBiJCBsw6AgY8OhYyBz4buRIHRo4buxYyBkxrDGoW5nIHbDoCAkXFxhbHBoYSQgbMOgIHPhu5EgdGjhu7FjIHTDuXkgw70sIGto4bqzbmcgxJHhu4suLi4iLCJyZW5kZXJlZF9xdWVzdGlvbiI6Ilbhu5tpICRhLCBiJCBsw6AgY8OhYyBz4buRIHRo4buxYyBkxrDGoW5nIHbDoCAkXFxhbHBoYSQgbMOgIHPhu5EgdGjhu7FjIHTDuXkgw70sIGto4bqzbmcgxJHhu4tuaCBuw6BvIHNhdSDEkcOieSBsw6AgxJHDum5nPyIsInJlbmRlcmVkX29wdGlvbnMiOlsiJChhIC4gYilee1xcYWxwaGF9ID0gYV57XFxhbHBoYX0gKyBiXntcXGFscGhhfSQiLCIkKGErYilee1xcYWxwaGF9ID0gYV57XFxhbHBoYX0gKyBiXntcXGFscGhhfSQiLCIkKGEgLiBiKV57XFxhbHBoYX0gPSBhXntcXGFscGhhfSAuIGJee1xcYWxwaGF9JCIsIiQoYSAuIGIpXntcXGFscGhhfSA9IGEgLiBiXntcXGFscGhhfSQiXX0seyJxdWVzdGlvbiI6Ilbhu5tpICRhJCBsw6Agc+G7kSB0aOG7sWMgZMawxqFuZyB0w7l5IMO9LCBiaeG7g3UgdGjhu6ljICRQID0gXFxkZnJhY3thXntcXHNxcnR7NX19fXthXntcXHNxcnR7NX0tMn19JCBi4bqxbmc/Iiwib3B0aW9ucyI6WyIkYV57XFxzcXJ0ezV9fSQiLCIkYV57Mlxcc3FydHs1fS0yfSQiLCIkYV4yJCIsIiRhXnstMn0kIl0sImNvcnJlY3RBbnN3ZXJJbmRleCI6MiwidHlwZSI6Im11bHRpcGxlLWNob2ljZSIsImlzRGlydHkiOmZhbHNlLCJleHBsYW5hdGlvbiI6bnVsbCwic2h1ZmZsZU9wdGlvbnMiOnsic3RlbSI6dHJ1ZSwiYW5zd2VycyI6dHJ1ZX0sInF1ZXN0aW9uTnVtYmVyIjo1LCJpZCI6InFfNTYwMjI3ODQ0IiwicXVlc3Rpb25TbmlwcGV0IjoiVuG7m2kgJGEkIGzDoCBz4buRIHRo4buxYyBkxrDGoW5nIHTDuXkgw70sIGJp4buDdSB0aOG7qWMgJFAgPSBcXGRmcmFje2Fee1xcc3FydHs1fX19e2FeLi4uIiwicmVuZGVyZWRfcXVlc3Rpb24iOiJW4bubaSAkYSQgbMOgIHPhu5EgdGjhu7FjIGTGsMahbmcgdMO5eSDDvSwgYmnhu4N1IHRo4bupYyAkUCA9IFxcZGZyYWN7YV57XFxzcXJ0ezV9fX17YV57XFxzcXJ0ezV9LTJ9fSQgYuG6sW5nPyIsInJlbmRlcmVkX29wdGlvbnMiOlsiJGFee1xcc3FydHs1fX0kIiwiJGFeezJcXHNxcnR7NX0tMn0kIiwiJGFeMiQiLCIkYV57LTJ9JCJdfSx7InF1ZXN0aW9uIjoiVuG7m2kgJGEkIGzDoCBz4buRIHRo4buxYyBraMOhYyAkMCQsIGJp4buDdSB0aOG7qWMgJGFeey0zfSQgYuG6sW5nPyIsIm9wdGlvbnMiOlsiJC1hXjMkIiwiJFxcZGZyYWN7MX17YV4zfSQiLCIkXFxzcXJ0WzNde2F9JCIsIiQtM2EkIl0sImNvcnJlY3RBbnN3ZXJJbmRleCI6MSwidHlwZSI6Im11bHRpcGxlLWNob2ljZSIsImlzRGlydHkiOmZhbHNlLCJleHBsYW5hdGlvbiI6bnVsbCwic2h1ZmZsZU9wdGlvbnMiOnsic3RlbSI6dHJ1ZSwiYW5zd2VycyI6dHJ1ZX0sInF1ZXN0aW9uTnVtYmVyIjo2LCJpZCI6InFfMjA1MjI0ODk4OCIsInF1ZXN0aW9uU25pcHBldCI6Ilbhu5tpICRhJCBsw6Agc+G7kSB0aOG7sWMga2jDoWMgJDAkLCBiaeG7g3UgdGjhu6ljICRhXnstM30kIGLhurFuZz8iLCJyZW5kZXJlZF9xdWVzdGlvbiI6Ilbhu5tpICRhJCBsw6Agc+G7kSB0aOG7sWMga2jDoWMgJDAkLCBiaeG7g3UgdGjhu6ljICRhXnstM30kIGLhurFuZz8iLCJyZW5kZXJlZF9vcHRpb25zIjpbIiQtYV4zJCIsIiRcXGRmcmFjezF9e2FeM30kIiwiJFxcc3FydFszXXthfSQiLCIkLTNhJCJdfSx7InF1ZXN0aW9uIjoiS2jhurNuZyDEkeG7i25oIG7DoG8gc2F1IMSRw6J5IGzDoCDEkcO6bmc/Iiwib3B0aW9ucyI6WyIkNV57XFxzcXJ0ezJ9fSA8IDVee1xcc3FydHszfX0kIiwiJDVee1xcc3FydHsyfX0gPiA1XntcXHNxcnR7M319JCIsIiQwLDVee1xcc3FydHsyfX0gPCAwLDVee1xcc3FydHszfX0kIiwiJFxcbGVmdCggXFxkZnJhY3sxfXszfSBcXHJpZ2h0KV57XFxwaX0gPiBcXGxlZnQoIFxcZGZyYWN7MX17M30gXFxyaWdodCleezN9JCJdLCJjb3JyZWN0QW5zd2VySW5kZXgiOjAsInR5cGUiOiJtdWx0aXBsZS1jaG9pY2UiLCJpc0RpcnR5IjpmYWxzZSwiZXhwbGFuYXRpb24iOm51bGwsInNodWZmbGVPcHRpb25zIjp7InN0ZW0iOnRydWUsImFuc3dlcnMiOnRydWV9LCJxdWVzdGlvbk51bWJlciI6NywiaWQiOiJxXzEyOTc1MjQwOTgiLCJxdWVzdGlvblNuaXBwZXQiOiJLaOG6s25nIMSR4buLbmggbsOgbyBzYXUgxJHDonkgbMOgIMSRw7puZz8iLCJyZW5kZXJlZF9xdWVzdGlvbiI6Ikto4bqzbmcgxJHhu4tuaCBuw6BvIHNhdSDEkcOieSBsw6AgxJHDum5nPyIsInJlbmRlcmVkX29wdGlvbnMiOlsiJDVee1xcc3FydHsyfX0gPCA1XntcXHNxcnR7M319JCIsIiQ1XntcXHNxcnR7Mn19ID4gNV57XFxzcXJ0ezN9fSQiLCIkMCw1XntcXHNxcnR7Mn19IDwgMCw1XntcXHNxcnR7M319JCIsIiRcXGxlZnQoIFxcZGZyYWN7MX17M30gXFxyaWdodClee1xccGl9ID4gXFxsZWZ0KCBcXGRmcmFjezF9ezN9IFxccmlnaHQpXnszfSQiXX0seyJxdWVzdGlvbiI6IkNobyAkYSQgbMOgIHPhu5EgdGjhu7FjIGTGsMahbmcuIFLDunQgZ+G7jW4gYmnhu4N1IHRo4bupYyAkUCA9IFxcbGVmdCggYV57XFxzcXJ0ezJ9fSBcXHJpZ2h0KV57XFxzcXJ0ezJ9fSQgdGEgxJHGsOG7o2Mga+G6v3QgcXXhuqMgbMOgPyIsIm9wdGlvbnMiOlsiJGFeMiQiLCIkYV57Mlxcc3FydHsyfX0kIiwiJGFee1xcc3FydHsyfX0kIiwiJGFeNCQiXSwiY29ycmVjdEFuc3dlckluZGV4IjowLCJ0eXBlIjoibXVsdGlwbGUtY2hvaWNlIiwiaXNEaXJ0eSI6ZmFsc2UsImV4cGxhbmF0aW9uIjpudWxsLCJzaHVmZmxlT3B0aW9ucyI6eyJzdGVtIjp0cnVlLCJhbnN3ZXJzIjp0cnVlfSwicXVlc3Rpb25OdW1iZXIiOjgsImlkIjoicV8xMDUyODUyNjc3IiwicXVlc3Rpb25TbmlwcGV0IjoiQ2hvICRhJCBsw6Agc+G7kSB0aOG7sWMgZMawxqFuZy4gUsO6dCBn4buNbiBiaeG7g3UgdGjhu6ljICRQID0gXFxsZWZ0KCBhXntcXHNxcnR7Mn19IFxcLi4uIiwicmVuZGVyZWRfcXVlc3Rpb24iOiJDaG8gJGEkIGzDoCBz4buRIHRo4buxYyBkxrDGoW5nLiBSw7p0IGfhu41uIGJp4buDdSB0aOG7qWMgJFAgPSBcXGxlZnQoIGFee1xcc3FydHsyfX0gXFxyaWdodClee1xcc3FydHsyfX0kIHRhIMSRxrDhu6NjIGvhur90IHF14bqjIGzDoD8iLCJyZW5kZXJlZF9vcHRpb25zIjpbIiRhXjIkIiwiJGFeezJcXHNxcnR7Mn19JCIsIiRhXntcXHNxcnR7Mn19JCIsIiRhXjQkIl19LHsicXVlc3Rpb24iOiJW4bubaSBz4buRIHRo4buxYyAkYSQga2jDoWMgJDAkLCBiaeG7g3UgdGjhu6ljICRhXjAkIGLhurFuZz8iLCJvcHRpb25zIjpbIiQwJCIsIiRhJCIsIiQxJCIsIiRcXGluZnR5JCJdLCJjb3JyZWN0QW5zd2VySW5kZXgiOjIsInR5cGUiOiJtdWx0aXBsZS1jaG9pY2UiLCJpc0RpcnR5IjpmYWxzZSwiZXhwbGFuYXRpb24iOm51bGwsInNodWZmbGVPcHRpb25zIjp7InN0ZW0iOnRydWUsImFuc3dlcnMiOnRydWV9LCJxdWVzdGlvbk51bWJlciI6OSwiaWQiOiJxXzU3MzM2NjkyNyIsInF1ZXN0aW9uU25pcHBldCI6Ilbhu5tpIHPhu5EgdGjhu7FjICRhJCBraMOhYyAkMCQsIGJp4buDdSB0aOG7qWMgJGFeMCQgYuG6sW5nPyIsInJlbmRlcmVkX3F1ZXN0aW9uIjoiVuG7m2kgc+G7kSB0aOG7sWMgJGEkIGtow6FjICQwJCwgYmnhu4N1IHRo4bupYyAkYV4wJCBi4bqxbmc/IiwicmVuZGVyZWRfb3B0aW9ucyI6WyIkMCQiLCIkYSQiLCIkMSQiLCIkXFxpbmZ0eSQiXX0seyJxdWVzdGlvbiI6Ilbhu5tpICR4JCBsw6Agc+G7kSB0aOG7sWMgZMawxqFuZywgYmnhu4N1IHRo4bupYyAkUCA9IHhee1xcZGZyYWN7MX17Mn19IFx0Llxcc3FydFs0XXt4fSQgYuG6sW5nPyIsIm9wdGlvbnMiOlsiJHhee1xcZGZyYWN7MX17OH19JCIsIiR4XntcXGRmcmFjezF9ezR9fSQiLCIkeF57XFxkZnJhY3szfXs0fX0kIiwiJHgkIl0sImNvcnJlY3RBbnN3ZXJJbmRleCI6MiwidHlwZSI6Im11bHRpcGxlLWNob2ljZSIsImlzRGlydHkiOnRydWUsImV4cGxhbmF0aW9uIjpudWxsLCJzaHVmZmxlT3B0aW9ucyI6eyJzdGVtIjp0cnVlLCJhbnN3ZXJzIjp0cnVlfSwicXVlc3Rpb25OdW1iZXIiOjEwLCJxdWVzdGlvbkltYWdlIjpudWxsLCJvcHRpb25zSW1hZ2UiOltudWxsLG51bGwsbnVsbCxudWxsXSwiaWQiOiJxXzEyNTQ0OTM4OTUiLCJxdWVzdGlvblNuaXBwZXQiOiJW4bubaSAkeCQgbMOgIHPhu5EgdGjhu7FjIGTGsMahbmcsIGJp4buDdSB0aOG7qWMgJFAgPSB4XntcXGRmcmFjezF9ezJ9fSBcdC5cXHNxcnRbNF17eC4uLiIsInJlbmRlcmVkX3F1ZXN0aW9uIjoiVuG7m2kgJHgkIGzDoCBz4buRIHRo4buxYyBkxrDGoW5nLCBiaeG7g3UgdGjhu6ljICRQID0geF57XFxkZnJhY3sxfXsyfX0gXHQuXFxzcXJ0WzRde3h9JCBi4bqxbmc/IiwicmVuZGVyZWRfb3B0aW9ucyI6WyIkeF57XFxkZnJhY3sxfXs4fX0kIiwiJHhee1xcZGZyYWN7MX17NH19JCIsIiR4XntcXGRmcmFjezN9ezR9fSQiLCIkeCQiXX0seyJxdWVzdGlvbiI6Ik3hu5l0IGtow6FjaCBow6BuZyBn4butaSAkMTAwJCB0cmnhu4d1IMSR4buTbmcgdsOgbyBuZ8OibiBow6BuZyB24bubaSBsw6NpIHN14bqldCAkNiw4XFwlJCBt4buZdCBuxINtIHRoZW8gaMOsbmggdGjhu6ljIGzDo2kga8OpcC4gQmnhur90IHLhurFuZyBu4bq/dSBraMO0bmcgcsO6dCB0aeG7gW4gcmEga2jhu49pIG5nw6JuIGjDoG5nIHRow6wgY+G7qSBzYXUgbeG7l2kgbsSDbSBz4buRIHRp4buBbiBsw6NpIHPhur0gxJHGsOG7o2Mgbmjhuq1wIHbDoG8gZ+G7kWMgxJHhu4MgdMOtbmggbMOjaSBjaG8gbsSDbSB0aeG6v3AgdGhlby4gU+G7rSBk4bulbmcgY8O0bmcgdGjhu6ljIGzFqXkgdGjhu6thIHbhu5tpIHPhu5EgbcWpIHRo4buxYywgaMOjeSB0w61uaCBz4buRIHRp4buBbiBraMOhY2ggaMOgbmcgbmjhuq1uIMSRxrDhu6NjIHNhdSAkNSQgbsSDbSAkOSQgdGjDoW5nIChnaeG6oyBz4butIGzDo2kgc3XhuqV0IGtow7RuZyB0aGF5IMSR4buVaSB2w6Agc+G7kSB0aeG7gW4gbMOjaSDEkcaw4bujYyB0w61uaCB04buJIGzhu4cgduG7m2kgdGjhu51pIGdpYW4gZ+G7rWkpLiBMw6BtIHRyw7JuIGvhur90IHF14bqjIMSR4bq/biBow6BuZyDEkcahbiB24buLIG5naMOsbiDEkeG7k25nLiIsIm9wdGlvbnMiOlsiMTQ2LjEyNC4wMDAgxJHhu5NuZyIsIjE0NS4yODAuMDAwIMSR4buTbmciLCIxNDcuMjM1LjAwMCDEkeG7k25nIiwiMTQ0LjE1MC4wMDAgxJHhu5NuZyJdLCJjb3JyZWN0QW5zd2VySW5kZXgiOjAsInR5cGUiOiJtdWx0aXBsZS1jaG9pY2UiLCJpc0RpcnR5IjpmYWxzZSwiZXhwbGFuYXRpb24iOm51bGwsInNodWZmbGVPcHRpb25zIjp7InN0ZW0iOnRydWUsImFuc3dlcnMiOnRydWV9LCJxdWVzdGlvbk51bWJlciI6MTEsImlkIjoicV8zNTY1NzE2MDMiLCJxdWVzdGlvblNuaXBwZXQiOiJN4buZdCBraMOhY2ggaMOgbmcgZ+G7rWkgJDEwMCQgdHJp4buHdSDEkeG7k25nIHbDoG8gbmfDom4gaMOgbmcgduG7m2kgbMOjaSBzdeG6pXQgJDYsOFxcJSQuLi4iLCJyZW5kZXJlZF9xdWVzdGlvbiI6Ik3hu5l0IGtow6FjaCBow6BuZyBn4butaSAkMTAwJCB0cmnhu4d1IMSR4buTbmcgdsOgbyBuZ8OibiBow6BuZyB24bubaSBsw6NpIHN14bqldCAkNiw4XFwlJCBt4buZdCBuxINtIHRoZW8gaMOsbmggdGjhu6ljIGzDo2kga8OpcC4gQmnhur90IHLhurFuZyBu4bq/dSBraMO0bmcgcsO6dCB0aeG7gW4gcmEga2jhu49pIG5nw6JuIGjDoG5nIHRow6wgY+G7qSBzYXUgbeG7l2kgbsSDbSBz4buRIHRp4buBbiBsw6NpIHPhur0gxJHGsOG7o2Mgbmjhuq1wIHbDoG8gZ+G7kWMgxJHhu4MgdMOtbmggbMOjaSBjaG8gbsSDbSB0aeG6v3AgdGhlby4gU+G7rSBk4bulbmcgY8O0bmcgdGjhu6ljIGzFqXkgdGjhu6thIHbhu5tpIHPhu5EgbcWpIHRo4buxYywgaMOjeSB0w61uaCBz4buRIHRp4buBbiBraMOhY2ggaMOgbmcgbmjhuq1uIMSRxrDhu6NjIHNhdSAkNSQgbsSDbSAkOSQgdGjDoW5nIChnaeG6oyBz4butIGzDo2kgc3XhuqV0IGtow7RuZyB0aGF5IMSR4buVaSB2w6Agc+G7kSB0aeG7gW4gbMOjaSDEkcaw4bujYyB0w61uaCB04buJIGzhu4cgduG7m2kgdGjhu51pIGdpYW4gZ+G7rWkpLiBMw6BtIHRyw7JuIGvhur90IHF14bqjIMSR4bq/biBow6BuZyDEkcahbiB24buLIG5naMOsbiDEkeG7k25nLiIsInJlbmRlcmVkX29wdGlvbnMiOlsiMTQ2LjEyNC4wMDAgxJHhu5NuZyIsIjE0NS4yODAuMDAwIMSR4buTbmciLCIxNDcuMjM1LjAwMCDEkeG7k25nIiwiMTQ0LjE1MC4wMDAgxJHhu5NuZyJdfSx7InF1ZXN0aW9uIjoiU+G7sSB0xINuZyB0csaw4bufbmcgZMOibiBz4buRIGPhu6dhIG3hu5l0IHRow6BuaCBwaOG7kSDEkcaw4bujYyDGsOG7m2MgdMOtbmggdGhlbyBjw7RuZyB0aOG7qWMgJFMgPSBBIFxcY2RvdCAoMSArIHIpXm4kLCB0cm9uZyDEkcOzICRBJCBsw6AgZMOibiBz4buRIGPhu6dhIG7Eg20gbOG6pXkgbMOgbSBt4buRYyB0w61uaCwgJFMkIGzDoCBkw6JuIHPhu5Egc2F1ICRuJCBuxINtLCAkciQgbMOgIHThu4kgbOG7hyB0xINuZyBkw6JuIHPhu5EgaMOgbmcgbsSDbS4gVOG6oWkgdGjhu51pIMSRaeG7g20gxJHhuqd1IG7Eg20gMjAyMiwgZMOibiBz4buRIHRow6BuaCBwaOG7kSBuw6B5IGzDoCAkMiwyJCB0cmnhu4d1IG5nxrDhu51pLiBCaeG6v3QgcuG6sW5nIHThu4kgbOG7hyB0xINuZyBkw6JuIHPhu5EgaMOgbmcgbsSDbSBsw6AgJDEsMjVcXCUkLiBI4buPaSDEkeG6v24gZ2nhu69hIG7Eg20gMjAzMCAodMawxqFuZyDhu6luZyB24bubaSAkbiA9IDgsNSQgbsSDbSksIGTDom4gc+G7kSBj4bunYSB0aMOgbmggcGjhu5EgxJHDsyB44bqlcCB44buJIGJhbyBuaGnDqnUgdHJp4buHdSBuZ8aw4budaT8gKEzDoG0gdHLDsm4ga+G6v3QgcXXhuqMgxJHhur9uIGNo4buvIHPhu5EgdGjhuq1wIHBow6JuIHRo4bupIGJhKS4iLCJvcHRpb25zIjpbIjIsNDQ2IHRyaeG7h3UgbmfGsOG7nWkiLCIyLDQ0MCB0cmnhu4d1IG5nxrDhu51pIiwiMiw0NTIgdHJp4buHdSBuZ8aw4budaSIsIjIsNDM1IHRyaeG7h3UgbmfGsOG7nWkiXSwiY29ycmVjdEFuc3dlckluZGV4IjowLCJ0eXBlIjoibXVsdGlwbGUtY2hvaWNlIiwiaXNEaXJ0eSI6ZmFsc2UsImV4cGxhbmF0aW9uIjpudWxsLCJzaHVmZmxlT3B0aW9ucyI6eyJzdGVtIjp0cnVlLCJhbnN3ZXJzIjp0cnVlfSwicXVlc3Rpb25OdW1iZXIiOjEyLCJpZCI6InFfMTY2OTUwMDIwNSIsInF1ZXN0aW9uU25pcHBldCI6IlPhu7EgdMSDbmcgdHLGsOG7n25nIGTDom4gc+G7kSBj4bunYSBt4buZdCB0aMOgbmggcGjhu5EgxJHGsOG7o2MgxrDhu5tjIHTDrW5oIHRoZW8gY8O0bmcgdGjhu6ljICQuLi4iLCJyZW5kZXJlZF9xdWVzdGlvbiI6IlPhu7EgdMSDbmcgdHLGsOG7n25nIGTDom4gc+G7kSBj4bunYSBt4buZdCB0aMOgbmggcGjhu5EgxJHGsOG7o2MgxrDhu5tjIHTDrW5oIHRoZW8gY8O0bmcgdGjhu6ljICRTID0gQSBcXGNkb3QgKDEgKyByKV5uJCwgdHJvbmcgxJHDsyAkQSQgbMOgIGTDom4gc+G7kSBj4bunYSBuxINtIGzhuqV5IGzDoG0gbeG7kWMgdMOtbmgsICRTJCBsw6AgZMOibiBz4buRIHNhdSAkbiQgbsSDbSwgJHIkIGzDoCB04buJIGzhu4cgdMSDbmcgZMOibiBz4buRIGjDoG5nIG7Eg20uIFThuqFpIHRo4budaSDEkWnhu4NtIMSR4bqndSBuxINtIDIwMjIsIGTDom4gc+G7kSB0aMOgbmggcGjhu5EgbsOgeSBsw6AgJDIsMiQgdHJp4buHdSBuZ8aw4budaS4gQmnhur90IHLhurFuZyB04buJIGzhu4cgdMSDbmcgZMOibiBz4buRIGjDoG5nIG7Eg20gbMOgICQxLDI1XFwlJC4gSOG7j2kgxJHhur9uIGdp4buvYSBuxINtIDIwMzAgKHTGsMahbmcg4bupbmcgduG7m2kgJG4gPSA4LDUkIG7Eg20pLCBkw6JuIHPhu5EgY+G7p2EgdGjDoG5oIHBo4buRIMSRw7MgeOG6pXAgeOG7iSBiYW8gbmhpw6p1IHRyaeG7h3UgbmfGsOG7nWk/IChMw6BtIHRyw7JuIGvhur90IHF14bqjIMSR4bq/biBjaOG7ryBz4buRIHRo4bqtcCBwaMOibiB0aOG7qSBiYSkuIiwicmVuZGVyZWRfb3B0aW9ucyI6WyIyLDQ0NiB0cmnhu4d1IG5nxrDhu51pIiwiMiw0NDAgdHJp4buHdSBuZ8aw4budaSIsIjIsNDUyIHRyaeG7h3UgbmfGsOG7nWkiLCIyLDQzNSB0cmnhu4d1IG5nxrDhu51pIl19XQ=="))));
    const options = JSON.parse(decodeURIComponent(escape(atob("eyJ0aW1lTGltaXQiOjQ1LCJyZXRyaWVzIjoxLCJzdGFydFRpbWUiOiIyMDI2LTAxLTE2VDA5OjQ4OjAwLjAwMFoiLCJlbmRUaW1lIjoiMjAyNi0wMS0xOFQwOTo0ODowMC4wMDBaIiwic2hvcnRBbnN3ZXJGb3JtYXQiOiJmcmVlZm9ybSIsInBvaW50c01DIjoxMCwicG9pbnRzVEYiOjAsInBvaW50c1NBIjowLCJwb2ludHNFc3NheSI6MCwicG9pbnRzVEZNZXRob2QiOiJwcm9ncmVzc2l2ZSIsInNob3dBbnN3ZXJzIjp0cnVlLCJzaG93RXhwbGFuYXRpb24iOnRydWUsImFpQXNzZXNzbWVudCI6ZmFsc2UsInRlYWNoZXJOYW1lIjoiUEjhuqBNIEFOSCBExahORyJ9"))));
    const apiKeysEncoded = JSON.parse(decodeURIComponent(escape(atob("eyJnZW1pbmkiOiIiLCJvcGVuYWkiOiIiLCJkZWVwc2VlayI6IiJ9"))));
    const googleScriptUrl = "https://script.google.com/macros/s/AKfycbzuY4eIahyu7rl9BvXtMgtr5l3wDv1L0SBUX61_o8VLwMDDPddaEQrITr3Oj5h-6bvt/exec";
    const examCode = "T1QLIA";
    const teacherName = "PHẠM ANH DŨNG";

    const apiKeys = {
        gemini: atob(apiKeysEncoded.gemini),
    };

    // --- 2. STATE ---
    let userAnswers = {};
    let timeLeft = options.timeLimit * 60;
    let timerInterval;
    let isSubmitted = false;
    let startTime = new Date();
    let currentQuestionIndex = 0; // Track view for mobile nav
    let monitorLog = {
        thoatManHinh: 0,
        saoChep: 0,
        dan: 0
    };

    // --- 3. DOM ELEMENTS ---
    const dom = {
        welcomeScreen: document.getElementById('welcome-screen'),
        quizScreen: document.getElementById('quiz-screen'),
        resultScreen: document.getElementById('result-screen'),
        nameInput: document.getElementById('name'),
        classInput: document.getElementById('class'),
        studentApiKeyInput: document.getElementById('student-api-key'),
        startBtn: document.getElementById('start-btn'),
        studentNameDisplay: document.getElementById('student-name-display'),
        timerDisplay: document.getElementById('timer'),
        questionsContainer: document.getElementById('questions-container'),
        navGrid: document.getElementById('nav-grid'),
        submitBtn: document.getElementById('submit-btn'),
        drawerSubmitBtn: document.getElementById('drawer-submit-btn'),
        mainSubmitBtn: document.getElementById('main-submit-btn'),
        scoreDisplay: document.getElementById('score-display'),
        resultName: document.getElementById('result-name'),
        resultClass: document.getElementById('result-class'),
        resultTime: document.getElementById('result-time'),
        detailedAnswers: document.getElementById('detailed-answers'),
        viewAnswersBtn: document.getElementById('view-answers-btn'),
        aiAssessmentContainer: document.getElementById('ai-assessment-container'),
        aiAssessmentContent: document.getElementById('ai-assessment-content'),
        progressBar: document.getElementById('progress-bar'),
        progressText: document.getElementById('progress-text'),
        navPanel: document.getElementById('nav-panel'),
        navOverlay: document.getElementById('nav-overlay'),
        mobilePrevBtn: document.getElementById('mobile-prev-btn'),
        mobileNextBtn: document.getElementById('mobile-next-btn'),
        mobileMenuBtn: document.getElementById('mobile-menu-btn'),
        mobileCurrentQ: document.getElementById('mobile-current-q')
    };

    // --- 4. INIT ---
    dom.startBtn.addEventListener('click', startQuiz);
    
    // Mobile Nav Listeners
    if(dom.mobilePrevBtn) dom.mobilePrevBtn.addEventListener('click', () => scrollToQ(currentQuestionIndex - 1));
    if(dom.mobileNextBtn) dom.mobileNextBtn.addEventListener('click', () => scrollToQ(currentQuestionIndex + 1));
    if(dom.mobileMenuBtn) dom.mobileMenuBtn.addEventListener('click', toggleNav);
    if(dom.navOverlay) dom.navOverlay.addEventListener('click', closeNav);

    document.addEventListener('visibilitychange', () => {
        if (document.hidden && !isSubmitted && dom.quizScreen.style.display !== 'none') {
            monitorLog.thoatManHinh++;
        }
    });
    
    document.addEventListener('copy', () => { if(!isSubmitted) monitorLog.saoChep++; });
    document.addEventListener('paste', () => { if(!isSubmitted) monitorLog.dan++; });

    function startQuiz() {
        const name = dom.nameInput.value.trim();
        const className = dom.classInput.value.trim();
        if (!name || !className) {
            alert('Vui lòng nhập đầy đủ Họ tên và Lớp!');
            return;
        }
        
        // NEW: Get Student API Key if provided
        if (dom.studentApiKeyInput && dom.studentApiKeyInput.value.trim()) {
            apiKeys.gemini = dom.studentApiKeyInput.value.trim();
        }

        dom.studentNameDisplay.textContent = name;
        dom.welcomeScreen.classList.add('hidden');
        dom.quizScreen.classList.remove('hidden');
        
        renderQuestions();
        renderNav();
        updateProgress();
        
        if (options.timeLimit > 0) {
            startTimer();
        } else {
            dom.timerDisplay.textContent = "--:--";
        }
        
        // Setup intersection observer to update current question index on scroll
        setupScrollObserver();
        
        window.scrollTo(0, 0);
    }

    function startTimer() {
        updateTimerDisplay();
        timerInterval = setInterval(() => {
            timeLeft--;
            updateTimerDisplay();
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                submitQuiz(true);
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        const m = Math.floor(timeLeft / 60);
        const s = timeLeft % 60;
        dom.timerDisplay.textContent = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        
        // Change color when time is running out (< 5 mins)
        if (timeLeft < 300) {
            dom.timerDisplay.classList.add('text-red-600', 'animate-pulse');
            dom.timerDisplay.classList.remove('text-indigo-600');
        }
    }

    function updateProgress() {
        const total = quizData.length;
        const answered = Object.keys(userAnswers).length;
        const percent = (answered / total) * 100;
        dom.progressBar.style.width = `${percent}%`;
        if(dom.progressText) dom.progressText.textContent = `${answered}/${total}`;
        
        // Update Grid Colors
        quizData.forEach((_, idx) => {
            const btn = document.getElementById(`nav-${idx}`);
            if (btn) {
                if (userAnswers[idx] !== undefined) {
                    btn.classList.remove('bg-gray-100', 'text-gray-600', 'border-gray-200');
                    btn.classList.add('bg-indigo-600', 'text-white', 'border-indigo-600');
                } else {
                    btn.classList.add('bg-gray-100', 'text-gray-600', 'border-gray-200');
                    btn.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-600');
                }
                
                // Highlight current
                if (idx === currentQuestionIndex) {
                     btn.classList.add('ring-2', 'ring-offset-2', 'ring-indigo-500');
                } else {
                     btn.classList.remove('ring-2', 'ring-offset-2', 'ring-indigo-500');
                }
            }
        });
    }

    function toggleNav() {
        const isOpen = !dom.navPanel.classList.contains('translate-x-full');
        if (isOpen) closeNav();
        else openNav();
    }
    
    function openNav() {
        dom.navPanel.classList.remove('translate-x-full');
        if(dom.navOverlay) dom.navOverlay.classList.remove('hidden');
    }
    
    function closeNav() {
        dom.navPanel.classList.add('translate-x-full');
        if(dom.navOverlay) dom.navOverlay.classList.add('hidden');
    }
    
    function scrollToQ(index) {
        if (index < 0 || index >= quizData.length) return;
        currentQuestionIndex = index;
        const qEl = document.getElementById(`q-${index}`);
        if (qEl) {
            // Scroll with offset for sticky header
            const headerOffset = 100;
            const elementPosition = qEl.getBoundingClientRect().top;
            const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
            window.scrollTo({ top: offsetPosition, behavior: "smooth" });
        }
        updateMobileControls();
        updateProgress(); // To update grid highlight
    }
    
    function updateMobileControls() {
        if(dom.mobileCurrentQ) dom.mobileCurrentQ.textContent = `Câu ${currentQuestionIndex + 1}/${quizData.length}`;
        dom.mobilePrevBtn.disabled = currentQuestionIndex === 0;
        dom.mobileNextBtn.disabled = currentQuestionIndex === quizData.length - 1;
        
        dom.mobilePrevBtn.classList.toggle('opacity-50', currentQuestionIndex === 0);
        dom.mobileNextBtn.classList.toggle('opacity-50', currentQuestionIndex === quizData.length - 1);
    }
    
    function setupScrollObserver() {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const id = entry.target.id; // q-0, q-1...
                    const idx = parseInt(id.split('-')[1]);
                    currentQuestionIndex = idx;
                    updateMobileControls();
                    updateProgress();
                }
            });
        }, { threshold: 0.5 });
        
        quizData.forEach((_, idx) => {
            const el = document.getElementById(`q-${idx}`);
            if(el) observer.observe(el);
        });
    }

    // --- 5. RENDER ---
    function renderQuestions() {
        dom.questionsContainer.innerHTML = '';
        quizData.forEach((item, index) => {
            const qDiv = document.createElement('div');
            qDiv.id = `q-${index}`;
            qDiv.className = "bg-white p-4 sm:p-6 rounded-xl shadow-sm border border-gray-200 mb-4 sm:mb-6 scroll-mt-24";
            
            let html = `<div class="mb-3">
                <div class="flex justify-between items-start mb-2">
                    <span class="inline-flex items-center justify-center bg-indigo-100 text-indigo-800 text-xs font-bold px-2.5 py-1 rounded-md">Câu ${index + 1}</span>
                    ${item.type !== 'multiple-choice' ? `<span class="text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded">${getVNType(item.type)}</span>` : ''}
                </div>
                <div class="font-medium text-gray-800 text-base sm:text-lg leading-relaxed">${item.rendered_question || item.question}</div>
            </div>`;

            if (item.type === 'multiple-choice' || item.type.startsWith('mc-')) {
                html += `<div class="grid grid-cols-1 gap-3">`;
                item.rendered_options.forEach((opt, i) => {
                    html += `
                    <label class="cursor-pointer group">
                        <div class="flex items-start p-3 rounded-lg border border-gray-200 bg-gray-50 hover:bg-indigo-50 hover:border-indigo-200 transition-all">
                            <div class="flex items-center h-5">
                                <input type="radio" name="q-${index}" value="${i}" class="h-5 w-5 text-indigo-600 border-gray-300 focus:ring-indigo-500" onchange="selectAnswer(${index}, ${i})">
                            </div>
                            <span class="ml-3 text-sm sm:text-base text-gray-700 group-hover:text-indigo-900">${String.fromCharCode(65+i)}. ${opt}</span>
                        </div>
                    </label>`;
                });
                html += `</div>`;
            } else if (item.type === 'true-false' || item.type.startsWith('tf-')) {
                 html += `<div class="overflow-x-auto border border-gray-200 rounded-lg">
                 <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50"><tr><th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Mệnh đề</th><th class="px-2 py-2 text-center text-xs font-medium text-gray-500 w-16">Đúng</th><th class="px-2 py-2 text-center text-xs font-medium text-gray-500 w-16">Sai</th></tr></thead>
                    <tbody class="bg-white divide-y divide-gray-200">`;
                 item.statements.forEach((stmt, i) => {
                     html += `<tr>
                        <td class="px-3 py-2 text-sm">${stmt.rendered_statement || stmt.statement}</td>
                        <td class="px-2 py-2 text-center"><input type="radio" name="q-${index}-${i}" value="true" class="h-4 w-4 text-indigo-600" onchange="selectTFAnswer(${index}, ${i}, true)"></td>
                        <td class="px-2 py-2 text-center"><input type="radio" name="q-${index}-${i}" value="false" class="h-4 w-4 text-indigo-600" onchange="selectTFAnswer(${index}, ${i}, false)"></td>
                     </tr>`;
                 });
                 html += `</tbody></table></div>`;
            } else {
                 html += `<textarea class="w-full border border-gray-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" rows="3" placeholder="Nhập câu trả lời của bạn..." oninput="inputAnswer(${index}, this.value)"></textarea>`;
            }

            qDiv.innerHTML = html;
            dom.questionsContainer.appendChild(qDiv);
        });
        
        // Add a spacer at the bottom for mobile nav bar
        const spacer = document.createElement('div');
        spacer.className = "h-20 sm:hidden"; 
        dom.questionsContainer.appendChild(spacer);

        if (window.MathJax) {
            window.MathJax.typesetPromise();
        }
    }
    
    function getVNType(type) {
        if(type === 'short-answer') return 'Trả lời ngắn';
        if(type === 'essay') return 'Tự luận';
        if(type === 'true-false') return 'Đúng/Sai';
        return '';
    }

    function renderNav() {
        dom.navGrid.innerHTML = '';
        quizData.forEach((_, index) => {
            const btn = document.createElement('button');
            btn.id = `nav-${index}`;
            btn.className = "w-full aspect-square flex items-center justify-center rounded border border-gray-200 bg-gray-100 text-gray-600 text-xs font-bold hover:bg-gray-200 transition-all";
            btn.textContent = index + 1;
            btn.onclick = () => {
                scrollToQ(index);
                if(window.innerWidth < 1024) closeNav();
            };
            dom.navGrid.appendChild(btn);
        });
    }

    window.selectAnswer = (qIndex, oIndex) => {
        userAnswers[qIndex] = oIndex;
        updateProgress();
    };

    window.selectTFAnswer = (qIndex, sIndex, val) => {
        if (!userAnswers[qIndex]) userAnswers[qIndex] = {};
        userAnswers[qIndex][sIndex] = val;
        // Check if all statements in this question are answered? 
        // Logic: if user touched any, mark as in-progress. 
        // Or strictly check length. Let's strictly check length for 'done' status.
        if (Object.keys(userAnswers[qIndex]).length === quizData[qIndex].statements.length) {
            updateProgress();
        } else {
             // Optional: mark partially done? For now just rely on updateProgress logic which checks userAnswers[idx] !== undefined
             updateProgress(); 
        }
    };

    window.inputAnswer = (qIndex, val) => {
        if (val.trim()) {
            userAnswers[qIndex] = val.trim();
        } else {
            delete userAnswers[qIndex];
        }
        updateProgress();
    };

    // Submit handlers
    const handleSubmit = () => {
        const answeredCount = Object.keys(userAnswers).length;
        const total = quizData.length;
        let confirmMsg = `Bạn đã làm ${answeredCount}/${total} câu.`;
        if (answeredCount < total) confirmMsg += "\nBạn vẫn còn câu chưa làm!";
        confirmMsg += "\nBạn có chắc chắn muốn nộp bài?";
        
        if (confirm(confirmMsg)) {
            submitQuiz();
        }
    };

    if(dom.submitBtn) dom.submitBtn.addEventListener('click', handleSubmit);
    if(dom.drawerSubmitBtn) dom.drawerSubmitBtn.addEventListener('click', handleSubmit);
    if(dom.mainSubmitBtn) dom.mainSubmitBtn.addEventListener('click', handleSubmit);

    async function submitQuiz(autoSubmit = false) {
        if (isSubmitted) return;
        isSubmitted = true;
        clearInterval(timerInterval);

        let score = 0;
        let detailResults = [];

        quizData.forEach((item, index) => {
            let isCorrect = false;
            let detail = {};
            let scoreEarned = 0;
            const maxScorePerQ = 10 / quizData.length;

            if (item.type === 'multiple-choice' || item.type.startsWith('mc-')) {
                if (userAnswers[index] === item.correctAnswerIndex) {
                    isCorrect = true;
                    scoreEarned = maxScorePerQ;
                }
                detail = { userAnswer: userAnswers[index], correctAnswer: item.correctAnswerIndex };
            } else if (item.type === 'true-false' || item.type.startsWith('tf-')) {
                let correctStmtCount = 0;
                let stmtResults = [];
                item.statements.forEach((stmt, i) => {
                    const userVal = userAnswers[index] ? userAnswers[index][i] : null;
                    const stmtCorrect = userVal === stmt.is_correct;
                    if (stmtCorrect) correctStmtCount++;
                    stmtResults.push({ statement: i, user: userVal, correct: stmt.is_correct, isCorrect: stmtCorrect });
                });
                
                // Progressive scoring for True/False
                if(correctStmtCount === 1) scoreEarned = maxScorePerQ * 0.1;
                else if(correctStmtCount === 2) scoreEarned = maxScorePerQ * 0.25;
                else if(correctStmtCount === 3) scoreEarned = maxScorePerQ * 0.5;
                else if(correctStmtCount === 4) { scoreEarned = maxScorePerQ; isCorrect = true; }
                
                detail = { statements: stmtResults };
            }
            // For Essay/Short Answer, auto-grading is hard, score is 0 by default or needs manual review logic.
            // Here we assume 0 for now unless exact match (simple short answer)
            
            score += scoreEarned;

            detailResults.push({
                id: item.id, // ID để thống kê câu hay sai
                questionNumber: index + 1,
                type: item.type,
                isCorrect: isCorrect,
                scoreEarned: scoreEarned,
                details: detail
            });
        });

        score = Math.min(10, Math.max(0, score));

        dom.quizScreen.classList.add('hidden');
        dom.resultScreen.classList.remove('hidden');
        
        dom.scoreDisplay.textContent = score.toFixed(2);
        dom.resultName.textContent = dom.nameInput.value;
        dom.resultClass.textContent = dom.classInput.value;
        dom.resultTime.textContent = new Date().toLocaleString();

        if (googleScriptUrl) {
            const payload = {
                timestamp: new Date().toISOString(),
                name: dom.nameInput.value,
                class: dom.classInput.value,
                score: score.toFixed(2),
                examCode: examCode,
                monitoringLog: JSON.stringify(monitorLog),
                answerDetails: JSON.stringify(detailResults)
            };
            
            fetch(googleScriptUrl, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).catch(e => console.error("Lỗi gửi điểm:", e));
        }

        if (options.showAnswers) {
            dom.viewAnswersBtn.classList.remove('hidden');
            renderDetailedAnswers(detailResults);
        }
        
        if (options.aiAssessment) {
            generateAIAssessment(score, detailResults);
        }
    }

    function renderDetailedAnswers(results) {
        let html = '<h3 class="text-xl font-bold mb-4 text-gray-800">Chi tiết đáp án</h3>';
        
        quizData.forEach((item, index) => {
            const result = results[index];
            const isCorrect = result.isCorrect;
            const color = isCorrect ? 'text-green-600' : 'text-red-600';
            
            html += `<div class="mb-6 p-4 border rounded-lg ${isCorrect ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}">
                <div class="flex justify-between items-start mb-2">
                    <div class="font-bold ${color}">Câu ${index + 1}: ${isCorrect ? 'ĐÚNG' : 'SAI'} <span class="text-xs text-gray-500">(${result.scoreEarned.toFixed(2)} điểm)</span></div>
                    ${options.showExplanation ? `
                    <button class="ai-explain-btn text-xs bg-indigo-600 text-white px-2 py-1 rounded hover:bg-indigo-700 transition-colors flex items-center gap-1" data-index="${index}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                           <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                        Giải thích chi tiết
                    </button>`: ''}
                </div>
                <div class="mb-2 text-gray-800">${item.rendered_question || item.question}</div>`;

            if (item.type === 'multiple-choice') {
                const userIdx = userAnswers[index];
                const correctIdx = item.correctAnswerIndex;
                html += `<div class="text-sm">
                    <p>Bạn chọn: <span class="font-semibold">${userIdx !== undefined ? String.fromCharCode(65+userIdx) : 'Không trả lời'}</span></p>
                    <p class="font-bold text-green-700">Đáp án đúng: ${String.fromCharCode(65+correctIdx)}. ${item.options[correctIdx]}</p>
                </div>`;
            } else if (item.type === 'true-false') {
                 html += '<ul class="list-disc pl-5 text-sm">';
                 item.statements.forEach((s, i) => {
                     const userVal = userAnswers[index] ? userAnswers[index][i] : null;
                     const isStmtCorrect = userVal === s.is_correct;
                     html += `<li class="${isStmtCorrect ? 'text-green-700' : 'text-red-700'}">
                        Ý ${String.fromCharCode(97+i)}: ${s.statement} (Đáp án: ${s.is_correct ? 'Đúng' : 'Sai'} - Bạn chọn: ${userVal === null ? 'Trống' : (userVal ? 'Đúng' : 'Sai')})
                     </li>`;
                 });
                 html += '</ul>';
            }
            
            // Container cho giải thích AI
            html += `<div id="ai-explanation-${index}" class="hidden mt-3 p-3 bg-blue-50 text-sm text-blue-800 rounded border border-blue-200">
                <div class="font-bold mb-1">🤖 AI Giải thích:</div>
                <div class="ai-content">Đang tải...</div>
            </div>`;
            
            if (options.showExplanation && item.rendered_answer) {
                 html += `<div class="mt-3 pt-2 border-t border-gray-200 text-sm text-gray-600">
                    <strong>Giải thích/Đáp án chi tiết (Có sẵn):</strong><br>
                    ${item.rendered_answer}
                 </div>`;
            }

            html += `</div>`;
        });
        
        dom.detailedAnswers.innerHTML = html;
        if (window.MathJax) window.MathJax.typesetPromise();

        // Gắn sự kiện cho các nút giải thích AI
        document.querySelectorAll('.ai-explain-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const idx = parseInt(e.target.closest('button').dataset.index);
                explainQuestionWithAI(idx, results[idx]);
            });
        });
    }
    
    dom.viewAnswersBtn.addEventListener('click', () => {
        dom.detailedAnswers.classList.remove('hidden');
        dom.viewAnswersBtn.classList.add('hidden');
    });

    async function explainQuestionWithAI(index, resultItem) {
        if (!apiKeys.gemini) {
            const key = prompt("Tính năng này yêu cầu Gemini API Key.\nVui lòng nhập API Key của bạn:");
            if (key && key.trim()) {
                apiKeys.gemini = key.trim();
            } else {
                return alert("Bạn cần nhập API Key để xem giải thích từ AI.");
            }
        }
        
        const explanationDiv = document.getElementById(`ai-explanation-${index}`);
        const contentDiv = explanationDiv.querySelector('.ai-content');
        
        if (!explanationDiv.classList.contains('hidden') && contentDiv.innerHTML !== 'Đang tải...') {
             explanationDiv.classList.add('hidden'); // Toggle tắt nếu đang mở
             return;
        }

        explanationDiv.classList.remove('hidden');
        contentDiv.textContent = "Đang phân tích câu hỏi...";

        const item = quizData[index];
        let prompt = "Hãy đóng vai một giáo viên giỏi, giải thích chi tiết câu hỏi sau cho học sinh:\n";
        prompt += `Câu hỏi: ${item.question || item.main_question}\n`;
        
        if (item.type === 'multiple-choice') {
            prompt += `Các lựa chọn: ${item.options.join(', ')}\n`;
            prompt += `Đáp án đúng là: ${item.options[item.correctAnswerIndex]}\n`;
            if (userAnswers[index] !== undefined) {
                prompt += `Học sinh chọn: ${item.options[userAnswers[index]]} (Đây là đáp án ${resultItem.isCorrect ? 'đúng' : 'sai'}).\n`;
            }
        } else if (item.type === 'true-false') {
             prompt += `Các mệnh đề:\n`;
             item.statements.forEach((s, i) => {
                 prompt += `${String.fromCharCode(97+i)}) ${s.statement} -> Đáp án: ${s.is_correct ? 'Đúng' : 'Sai'}\n`;
             });
        }
        
        prompt += "\nHãy giải thích tại sao đáp án đúng lại đúng, và tại sao các phương án nhiễu lại sai (nếu có). Ngắn gọn, dễ hiểu.";

        try {
            const ai = new GoogleGenAI({ apiKey: apiKeys.gemini });
            const response = await ai.models.generateContent({
                model: "gemini-2.5-flash",
                contents: prompt
            });
            const text = response.text;
            contentDiv.innerHTML = text.replace(/\n/g, '<br>');
        } catch (e) {
            contentDiv.textContent = "Lỗi khi gọi AI: " + e.message;
        }
    }

    async function generateAIAssessment(score, results) {
        if (!apiKeys.gemini) {
             dom.aiAssessmentContainer.classList.remove('hidden');
             dom.aiAssessmentContent.innerHTML = `
                <div class="mb-2">
                    <div class="flex justify-between items-center mb-1">
                         <p class="text-red-600 font-medium">Cần có API Key để xem nhận xét.</p>
                         <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-red-600 hover:text-red-800 font-bold hover:underline">Link lấy API KEY miễn phí</a>
                    </div>
                    <div class="flex gap-2">
                        <input type="password" id="result-api-key" class="border p-2 rounded text-sm w-full outline-none focus:border-indigo-500" placeholder="Nhập Gemini API Key">
                        <button id="submit-result-key" class="bg-indigo-600 text-white px-4 py-2 rounded text-sm font-semibold hover:bg-indigo-700 transition">Gửi</button>
                    </div>
                </div>
             `;
             // Add listener for this inline button
             document.getElementById('submit-result-key').addEventListener('click', () => {
                const key = document.getElementById('result-api-key').value.trim();
                if(key) {
                    apiKeys.gemini = key;
                    generateAIAssessment(score, results); // Recursive call with key
                }
             });
             return;
        }

        dom.aiAssessmentContainer.classList.remove('hidden');
        dom.aiAssessmentContent.textContent = "AI đang phân tích bài làm của bạn...";
        
        // Tạo tóm tắt kết quả để gửi AI
        let summary = `Điểm số: ${score}/10.\n`;
        let weakTopics = [];
        let strongTopics = [];
        
        // Phân tích sơ bộ (giả lập, thực tế cần metadata topic trong quizData)
        const wrongAnswers = results.filter(r => r.isCorrect === false);
        const correctAnswers = results.filter(r => r.isCorrect === true);
        
        summary += `Số câu đúng: ${correctAnswers.length}/${results.length}.\n`;
        summary += `Các câu làm sai: ${wrongAnswers.map(w => w.questionNumber).join(', ')}.\n`;
        
        const prompt = `Hãy đóng vai một giáo viên tâm lý và có chuyên môn. Dựa vào kết quả bài kiểm tra dưới đây của học sinh, hãy viết một đoạn nhận xét ngắn gọn (khoảng 100-150 từ):
        1. Nhận xét chung về kết quả.
        2. Động viên tinh thần học sinh.
        3. Đưa ra 1-2 lời khuyên học tập chung dựa trên số lượng câu sai.
        
        Thông tin kết quả:
        ${summary}`;

        try {
            const ai = new GoogleGenAI({ apiKey: apiKeys.gemini });
            const response = await ai.models.generateContent({
                model: "gemini-2.5-flash",
                contents: prompt
            });
            const text = response.text;
            
            dom.aiAssessmentContent.innerHTML = text.replace(/\n/g, '<br>');
        } catch (e) {
            console.error("AI Error:", e);
            dom.aiAssessmentContent.textContent = "Không thể tải nhận xét từ AI lúc này. Vui lòng kiểm tra kết nối hoặc API Key.";
        }
    }
    
    </script>
</body>
</html>