
    <!DOCTYPE html>
    <html lang="vi">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>B√†i T·∫≠p Luy·ªán T·∫≠p - M√£ ƒë·ªÅ HSSJBR</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
        <script>
            window.MathJax = {
                tex: {
                    packages: {'[+]': ['ams']},
                    inlineMath: [['$', '$'], ['\\(', '\\)']],
                    displayMath: [['$$', '$$'], ['\\[', '\\]']]
                },
                chtml: {
                    fontCache: 'global',
                    linebreaks: {
                        automatic: true
                    }
                }
            };
        </script>
        <script type="text/javascript" id="MathJax-script" async
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
        </script>
        <style>
            body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #f0f4f8; }
            .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
            @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
            .question-card {
                background-color: white;
                border-radius: 1rem;
                padding: 1.5rem 2rem;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                border-left: 5px solid transparent;
                transition: all 0.3s ease;
            }
            .ai-explanation {
                background-color: #f0f9ff;
                color: #0c4a6e;
                padding: 1rem;
                border-radius: 0.75rem;
                font-size: 0.9rem;
                margin-top: 1rem;
                border-left: 4px solid #38bdf8;
            }
            .feedback-icon { width: 1.5rem; height: 1.5rem; }
            .option-label {
                transition: all 0.2s ease-in-out;
                border: 2px solid #e5e7eb;
            }
            .option-label:hover {
                border-color: #6366f1;
                background-color: #eef2ff;
            }
            .option-label.correct {
                border-color: #10b981 !important;
                background-color: #ecfdf5 !important;
                color: #065f46;
            }
            .option-label.incorrect {
                border-color: #ef4444 !important;
                background-color: #fef2f2 !important;
                color: #991b1b;
            }
            .statement-item.correct { background-color: #ecfdf5; border-color: #10b981; }
            .statement-item.incorrect { background-color: #fef2f2; border-color: #ef4444; }
            .prose { max-width: 100%; }
            .prose img { max-width: 100%; height: auto; margin-top: 1em; margin-bottom: 1em; border-radius: 0.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        </style>
    </head>
    <body class="bg-slate-100 text-slate-800">
        <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md transform transition-all" style="animation: fadeIn 0.3s ease-out;">
                <h2 class="text-2xl font-bold mb-2 text-center text-slate-800">Th√¥ng Tin H·ªçc Sinh</h2>
                <p class="text-center text-slate-500 mb-6">Vui l√≤ng nh·∫≠p ƒë·ªÉ b·∫Øt ƒë·∫ßu l√†m b√†i.</p>
                <form id="student-info-form">
                    <div class="mb-4">
                        <label for="student-name" class="block text-sm font-medium text-slate-700 mb-1">H·ªç v√† t√™n</label>
                        <input type="text" id="student-name" required class="mt-1 block w-full block border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="student-class" class="block text-sm font-medium text-slate-700 mb-1">L·ªõp</label>
                        <input type="text" id="student-class" required class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Gi√°o vi√™n:</label>
                        <p class="mt-1 text-slate-800 bg-slate-100 p-2.5 rounded-lg">dddd</p>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">B·∫Øt ƒë·∫ßu l√†m b√†i</button>
                </form>
            </div>
        </div>
        <div class="container mx-auto p-4 md:p-8 max-w-4xl">
            <header class="mb-10 p-8 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg">
                <div class="flex justify-between items-center flex-wrap gap-4">
                    <div>
                        <h1 class="text-4xl font-bold">B√†i T·∫≠p Luy·ªán T·∫≠p - M√£ ƒë·ªÅ HSSJBR</h1>
                        <p class="text-lg text-blue-100 mt-2">H√£y ho√†n th√†nh c√°c c√¢u h·ªèi d∆∞·ªõi ƒë√¢y m·ªôt c√°ch t·ªët nh·∫•t!</p>
                        <p class="text-sm text-blue-200 mt-4">T√°c gi·∫£: dddd</p>
                    </div>
                    <div id="timer-container" class="text-right">
                         <div id="timer-display" class="text-3xl font-bold tracking-wider bg-white/20 px-4 py-2 rounded-lg">--:--</div>
                         <div id="retries-display" class="text-sm mt-1 text-blue-200"></div>
                    </div>
                </div>
            </header>
            <main id="student-quiz-container" class="space-y-8 hidden">
                <!-- Questions will be rendered here by JS -->
            </main>
            <footer class="mt-10 text-center">
                <button id="submit-quiz-btn" class="bg-indigo-600 text-white py-3 px-12 rounded-full font-bold text-lg hover:bg-indigo-700 transition-all duration-300 shadow-lg hover:shadow-xl hidden transform hover:scale-105">N·ªôp B√†i</button>
                <div id="result-container" class="mt-6 hidden"></div>
                <div id="ai-feedback-container" class="mt-8 text-left hidden"></div>
                <div id="post-submit-options" class="hidden mt-6 flex flex-col sm:flex-row items-center justify-center gap-4">
                    <button id="retry-quiz-btn" class="w-full sm:w-auto bg-slate-600 text-white py-2.5 px-6 rounded-lg font-semibold hover:bg-slate-700 transition-transform transform hover:scale-105">L√†m L·∫°i ƒê·ªÅ N√†y</button>
                </div>
            </footer>
        </div>

        <div id="proctoring-widget" class="fixed bottom-4 right-4 bg-yellow-100 text-yellow-800 p-3 rounded-lg shadow-lg text-sm z-50 hidden border border-yellow-300" style="max-width: 200px;">
            <h4 class="font-bold mb-2 border-b border-yellow-300 pb-1 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 3.001-1.742 3.001H4.42c-1.53 0-2.493-1.667-1.743-3.001l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                Gi√°m s√°t
            </h4>
            <p>Tho√°t m√†n h√¨nh: <span id="tab-switch-count" class="font-bold">0</span></p>
            <p>Sao ch√©p: <span id="copy-count" class="font-bold">0</span></p>
            <p>D√°n: <span id="paste-count" class="font-bold">0</span></p>
        </div>

        <script type="module">
            let aiLoaded = false;
            
            async function loadAIScript() {
                if (window.aiLoaded) return true;
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.type = 'module';
                    script.innerHTML = `
                        import { GoogleGenAI } from "https://esm.sh/@google/genai@^1.13.0";
                        window.GoogleGenAI = GoogleGenAI;
                        window.aiLoaded = true;
                        resolve(true);
                    `;
                    script.onerror = () => {
                        console.error("L·ªói khi t·∫£i th∆∞ vi·ªán AI.");
                        reject(new Error("L·ªói khi t·∫£i th∆∞ vi·ªán AI."));
                    };
                    document.head.appendChild(script);
                });
            }

            let quizData = [{"type":"multiple-choice","question":"D√£y s·ªë n√†o sau ƒë√¢y l√† m·ªôt c·∫•p s·ªë c·ªông?","questionImage":null,"mappedType":"multiple-choice","options":["$1, 3, 5, 7, \\ldots$","$1, 2, 4, 8, \\ldots$","$1, -1, 1, -1, \\ldots$","$1, 3, 6, 10, \\ldots$"],"optionsImage":[],"correctAnswerIndex":0},{"type":"multiple-choice","question":"Cho c·∫•p s·ªë c·ªông $(u_n)$ c√≥ s·ªë h·∫°ng ƒë·∫ßu $u_1 = 5$ v√† c√¥ng sai $d = 3$. S·ªë h·∫°ng th·ª© $4$ c·ªßa c·∫•p s·ªë c·ªông n√†y l√† bao nhi√™u?","questionImage":null,"mappedType":"multiple-choice","options":["$u_4 = 14$","$u_4 = 17$","$u_4 = 11$","$u_4 = 20$"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"Cho c·∫•p s·ªë c·ªông $(u_n)$ c√≥ $u_1 = 2$ v√† c√¥ng sai $d = 4$. T·ªïng $5$ s·ªë h·∫°ng ƒë·∫ßu ti√™n c·ªßa c·∫•p s·ªë c·ªông ƒë√≥ l√†:","questionImage":null,"mappedType":"multiple-choice","options":["$S_5 = 30$","$S_5 = 40$","$S_5 = 50$","$S_5 = 60$"],"optionsImage":[],"correctAnswerIndex":2},{"type":"multiple-choice","question":"D√£y s·ªë $(u_n)$ n√†o sau ƒë√¢y l√† m·ªôt c·∫•p s·ªë c·ªông?","questionImage":null,"mappedType":"multiple-choice","options":["$u_1 = 1, u_{n+1} = u_n + n$","$u_1 = 2, u_{n+1} = u_n + 5$","$u_1 = 3, u_{n+1} = 2u_n$","$u_1 = 4, u_{n+1} = u_n^2$"],"optionsImage":[],"correctAnswerIndex":1},{"type":"multiple-choice","question":"M·ªôt c·∫•p s·ªë c·ªông c√≥ s·ªë h·∫°ng th·ª© $3$ l√† $u_3 = 7$ v√† s·ªë h·∫°ng th·ª© $5$ l√† $u_5 = 13$. C√¥ng sai c·ªßa c·∫•p s·ªë c·ªông n√†y l√†:","questionImage":null,"mappedType":"multiple-choice","options":["$d = 2$","$d = 3$","$d = 4$","$d = 5$"],"optionsImage":[],"correctAnswerIndex":0}];
            const quizOptions = {"timeLimit":45,"retriesAllowed":1,"showAnswers":true,"showExplanation":true,"aiAssessment":true,"scoring":{"mc":5,"tf":2,"sa":2,"essay":1,"tfMethod":"progressive"}};
            const googleScriptUrl = "https://script.google.com/macros/s/AKfycbxV_S0rNHbOQx-hnjjlQGqdvLBN5GlTog0q8erd1XMpPX7XkuGjIxJnDEPPDJQnpGnf9g/exec";
            const correctExamCode = "HSSJBR";
            const teacherApiKey = "AIzaSyAzvr2Py2_mr5Z4R3YWXi-dyO1ufA2paas";
            let studentInfo = {};
            let isSubmitted = false;
            let timerInterval;
            let retriesLeft = quizOptions.retriesAllowed;
            let ai = null;

            let proctoringLog = {
                thoatManHinh: 0,
                saoChep: 0,
                dan: 0,
                suKien: []
            };

            const studentQuizContainer = document.getElementById('student-quiz-container');
            const submitBtn = document.getElementById('submit-quiz-btn');
            const resultContainer = document.getElementById('result-container');
            const postSubmitOptions = document.getElementById('post-submit-options');
            const retryBtn = document.getElementById('retry-quiz-btn');
            const loginModal = document.getElementById('login-modal');
            const studentInfoForm = document.getElementById('student-info-form');
            const timerDisplay = document.getElementById('timer-display');
            const retriesDisplay = document.getElementById('retries-display');

            function formatAIText(text) {
                if (!text) return '';
                let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                formattedText = formattedText.replace(/\n/g, '<br>');
                return formattedText;
            }

            function shuffleQuiz() {
                quizData.forEach(item => {
                    if (item.mappedType === 'multiple-choice' && item.options && item.options.length > 0) {
                        const correctAnswerText = item.options[item.correctAnswerIndex];
                        let optionsWithImages = item.options.map((opt, index) => ({
                            text: opt,
                            image: (item.optionsImage && item.optionsImage[index]) ? item.optionsImage[index] : null
                        }));
                        for (let i = optionsWithImages.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [optionsWithImages[i], optionsWithImages[j]] = [optionsWithImages[j], optionsWithImages[i]];
                        }
                        item.options = optionsWithImages.map(opt => opt.text);
                        item.optionsImage = optionsWithImages.map(opt => opt.image);
                        item.correctAnswerIndex = item.options.indexOf(correctAnswerText);
                    }
                    if (item.mappedType === 'true-false' && item.statements && item.statements.length > 0) {
                         for (let i = item.statements.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [item.statements[i], item.statements[j]] = [item.statements[j], item.statements[i]];
                        }
                    }
                });
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) acc[type] = [];
                    acc[type].push(q);
                    return acc;
                }, {});
                let shuffledQuizData = [];
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    if (grouped[partType]) {
                        const partQuestions = grouped[partType];
                        for (let i = partQuestions.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [partQuestions[i], partQuestions[j]] = [partQuestions[j], partQuestions[i]];
                        }
                        shuffledQuizData = shuffledQuizData.concat(partQuestions);
                    }
                });
                quizData = shuffledQuizData;
            }
            
            function startTimer(duration, display) {
                let timer = duration, minutes, seconds;
                clearInterval(timerInterval);
                if(duration <= 0) {
                     display.textContent = "‚àû";
                     return;
                }
                timerInterval = setInterval(function () {
                    minutes = parseInt(timer / 60, 10);
                    seconds = parseInt(timer % 60, 10);
                    minutes = minutes < 10 ? "0" + minutes : minutes;
                    seconds = seconds < 10 ? "0" + seconds : seconds;
                    display.textContent = minutes + ":" + seconds;
                    if (--timer < 0) {
                        clearInterval(timerInterval);
                        alert("H·∫øt gi·ªù l√†m b√†i!");
                        handleSubmit();
                    }
                }, 1000);
            }
            
            async function showExplanation(index, button) {
                const item = quizData[index];
                const feedbackDiv = document.getElementById(`q-${index}-feedback`);
                if (!feedbackDiv) return;

                const existingExplanation = feedbackDiv.querySelector('.ai-explanation');
                if (existingExplanation) {
                    existingExplanation.remove();
                    button.innerHTML = `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Xem gi·∫£i th√≠ch`;
                    return;
                }

                button.disabled = true;
                button.innerHTML = '<div class="loader mr-2"></div> ƒêang t·∫£i...';

                if (item.explanation) {
                    displayExplanation(item.explanation, feedbackDiv, button);
                    return;
                }

                if (!ai) {
                    alert("T√≠nh nƒÉng gi·∫£i th√≠ch y√™u c·∫ßu API Key, nh∆∞ng ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh b·ªüi gi√°o vi√™n ho·∫∑c ƒë√£ x·∫£y ra l·ªói khi t·∫£i.");
                    button.disabled = false;
                    button.innerHTML = `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Xem gi·∫£i th√≠ch`;
                    return;
                }
                const questionText = new DOMParser().parseFromString(item.question || item.main_question, 'text/html').body.textContent || '';
                let prompt = `B·∫°n l√† m·ªôt tr·ª£ l√Ω gi√°o vi√™n AI, am hi·ªÉu s√¢u s·∫Øc Ch∆∞∆°ng tr√¨nh GDPT 2018. H√£y cung c·∫•p m·ªôt l·ªùi gi·∫£i chi ti·∫øt, t·ª´ng b∆∞·ªõc m·ªôt cho c√¢u h·ªèi sau ƒë√¢y. L·ªùi gi·∫£i ph·∫£i ch√≠nh x√°c, d·ªÖ hi·ªÉu v√† ph√π h·ª£p v·ªõi ph∆∞∆°ng ph√°p gi·∫£ng d·∫°y c·ªßa ch∆∞∆°ng tr√¨nh h·ªçc, TUY·ªÜT ƒê·ªêI KH√îNG s·ª≠ d·ª•ng ki·∫øn th·ª©c c·ªßa l·ªõp cao h∆°n ƒë·ªÉ gi·∫£i th√≠ch.\n\n--- C√ÇU H·ªéI ---\n${questionText}\n\n`;
                if (item.mappedType === 'multiple-choice') {
                    prompt += `--- C√ÅC L·ª∞A CH·ªåN ---\n${item.options.map((opt, i) => `${String.fromCharCode(65 + i)}. ${new DOMParser().parseFromString(opt, 'text/html').body.textContent}`).join('\n')}\n\n`;
                    prompt += `--- ƒê√ÅP √ÅN ƒê√öNG ---\n${String.fromCharCode(65 + item.correctAnswerIndex)}. ${new DOMParser().parseFromString(item.options[item.correctAnswerIndex], 'text/html').body.textContent}`;
                } else if (item.mappedType === 'true-false') {
                    prompt += `--- C√ÅC M·ªÜNH ƒê·ªÄ & ƒê√ÅP √ÅN ---\n${item.statements.map(s => ` - ${new DOMParser().parseFromString(s.statement, 'text/html').body.textContent} -> ${s.is_correct ? 'ƒê√∫ng' : 'Sai'}`).join('\n')}`;
                } else {
                    prompt += `--- ƒê√ÅP √ÅN / G·ª¢I √ù ---\n${new DOMParser().parseFromString(item.answer, 'text/html').body.textContent}`;
                }
                prompt += `\n\n--- Y√äU C·∫¶U ---\nGi·∫£i th√≠ch r√µ r√†ng t·∫°i sao ƒë√°p √°n l·∫°i ƒë√∫ng, t·ª´ng b∆∞·ªõc m·ªôt. D√πng **...** ƒë·ªÉ in ƒë·∫≠m c√°c thu·∫≠t ng·ªØ quan tr·ªçng. ƒê·ªãnh d·∫°ng t·∫•t c·∫£ c√°c c√¥ng th·ª©c to√°n h·ªçc b·∫±ng LaTeX.`;

                try {
                    const response = await ai.models.generateContent({ model: "gemini-2.5-flash", contents: prompt });
                    const explanationText = response.text;
                    item.explanation = explanationText;
                    displayExplanation(explanationText, feedbackDiv, button);
                } catch (error) {
                    console.error("L·ªói khi t·∫°o gi·∫£i th√≠ch:", error);
                    feedbackDiv.insertAdjacentHTML('beforeend', '<div class="ai-explanation text-red-600">L·ªói: Kh√¥ng th·ªÉ t·∫°o gi·∫£i th√≠ch.</div>');
                    button.disabled = false;
                    button.innerHTML = `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Th·ª≠ l·∫°i`;
                }
            }

            function displayExplanation(explanationText, container, button) {
                container.insertAdjacentHTML('beforeend', `<div class="ai-explanation prose prose-sm">${formatAIText(explanationText)}</div>`);
                if (window.MathJax) MathJax.typesetPromise([container]);
                button.disabled = false;
                button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>·∫®n gi·∫£i th√≠ch`;
            }
           
            function renderStudentQuiz() {
                studentQuizContainer.innerHTML = '';
                const grouped = quizData.reduce((acc, q) => {
                    const type = q.mappedType;
                    if (!acc[type]) acc[type] = [];
                    acc[type].push(q);
                    return acc;
                }, {});
                const groupInfo = {
                    'multiple-choice': { title: 'PH·∫¶N I. TR·∫ÆC NGHI·ªÜM KH√ÅCH QUAN', subtitle: 'Ch·ªçn ƒë√°p √°n ƒë√∫ng nh·∫•t.' },
                    'true-false': { title: 'PH·∫¶N II. C√ÇU H·ªéI ƒê√öNG - SAI', subtitle: 'X√°c ƒë·ªãnh t√≠nh ƒë√∫ng ho·∫∑c sai.' },
                    'short-answer': { title: 'PH·∫¶N III. C√ÇU H·ªéI TR·∫¢ L·ªúI NG·∫ÆN', subtitle: 'ƒêi·ªÅn ƒë√°p √°n ng·∫Øn g·ªçn.' },
                    'essay': { title: 'PH·∫¶N IV. C√ÇU H·ªéI T·ª∞ LU·∫¨N', subtitle: 'Tr√¨nh b√†y chi ti·∫øt b√†i gi·∫£i.' }
                };
                let questionCounter = 0;
                const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
                partOrder.forEach(partType => {
                    const questions = grouped[partType];
                    if (!questions || questions.length === 0) return;
                    
                    let groupHTML = `<div class="group-container space-y-8 mb-12">`;
                    const info = groupInfo[partType];
                    groupHTML += `<div class="group-header pb-3 border-b-2 border-slate-300 mb-6"><h2 class="text-2xl font-bold text-slate-800">${info.title}</h2>${info.subtitle ? `<p class="text-md text-slate-600 italic mt-1">${info.subtitle}</p>` : ''}</div>`;
                    
                    questions.forEach((item) => {
                        const globalIndex = quizData.indexOf(item);
                        questionCounter++;
                        groupHTML += `<div class="question-card" id="student-q-${globalIndex}">`;
                        let questionText = (item.question || item.main_question || '');
                        groupHTML += `<div class="flex items-start"><div class="flex-grow"><div class="flex items-center mb-2"><span class="font-bold text-lg mr-3 text-indigo-600">C√¢u ${questionCounter}:</span><div id="q-${globalIndex}-feedback-icon"></div></div><div class="question-content mt-2 text-lg text-slate-700 prose">${questionText}</div></div></div><div class="mt-6">`;
                        
                        switch(item.mappedType) {
                            case 'multiple-choice':
                                groupHTML += `<div class="options-grid grid grid-cols-1 md:grid-cols-2 gap-4">`;
                                item.options.forEach((opt, i) => {
                                    groupHTML += `<label for="q${globalIndex}-opt${i}" id="q${globalIndex}-opt-label${i}" class="option-label flex items-start p-4 rounded-xl cursor-pointer"><input type="radio" name="q${globalIndex}" id="q${globalIndex}-opt${i}" value="${i}" class="flex-shrink-0 mt-1 h-5 w-5 text-indigo-600"><div class="ml-3 flex-grow prose"><span class="font-semibold text-slate-800">${String.fromCharCode(65 + i)}.</span> <span class="option-content text-slate-700">${opt || ''}</span></div></label>`;
                                });
                                groupHTML += `</div>`;
                                break;
                            case 'true-false':
                                 groupHTML += `<div class="space-y-4">`;
                                 item.statements.forEach((s, i) => {
                                     groupHTML += `<div class="statement-item border-t pt-4"><p class="mb-3 text-slate-700 prose">${String.fromCharCode(97 + i)}) ${s.statement || ''}</p><div class="flex gap-x-6"><label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="true" class="mr-2 h-4 w-4"> ƒê√∫ng</label><label class="flex items-center cursor-pointer"><input type="radio" name="q${globalIndex}-s${i}" value="false" class="mr-2 h-4 w-4"> Sai</label></div></div>`;
                                 });
                                 groupHTML += `</div>`;
                                 break;
                            case 'short-answer':
                                groupHTML += `<input type="text" name="q${globalIndex}" class="mt-1 block w-full md:w-1/2 border border-slate-300 rounded-lg shadow-sm py-2.5 px-3" placeholder="Nh·∫≠p ƒë√°p √°n...">`;
                                break;
                            case 'essay':
                                groupHTML += `<textarea name="q${globalIndex}" class="mt-1 block w-full border border-slate-300 rounded-lg shadow-sm py-2.5 px-3" rows="5" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi..."></textarea>`;
                                break;
                        }
                        groupHTML += `</div><div id="q-${globalIndex}-feedback" class="mt-4"></div></div>`;
                    });
                    groupHTML += `</div>`;
                    studentQuizContainer.innerHTML += groupHTML;
                });
               
                if (window.MathJax) MathJax.typesetPromise([studentQuizContainer]);
            }
           
            async function generatePerformanceReview(allAnswersData) {
                const feedbackContainer = document.getElementById('ai-feedback-container');
                if (!feedbackContainer || !ai) return null;
                feedbackContainer.classList.remove('hidden');
                feedbackContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-xl font-bold text-slate-800 mb-4">üìù Ph√¢n T√≠ch & G·ª£i √ù T·ª´ Tr·ª£ L√Ω AI</h3><div id="ai-feedback-loader" class="text-center py-6"><svg class="animate-spin mx-auto h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="mt-3 text-slate-600">AI ƒëang ph√¢n t√≠ch b√†i l√†m...</p></div><div id="ai-feedback-summary" class="hidden prose prose-sm max-w-none"></div></div>`;
                const summaryDiv = document.getElementById('ai-feedback-summary');
                const incorrectAnswers = allAnswersData.filter(a => !a.isCorrect);
                if (incorrectAnswers.length === 0) {
                    feedbackContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-lg text-center"><h3 class="text-xl font-bold text-green-600">üéâ Ch√∫c m·ª´ng!</h3><p class="mt-2 text-slate-700">B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng t·∫•t c·∫£ c√°c c√¢u h·ªèi. L√†m t·ªët l·∫Øm!</p></div>`;
                    return { overallFeedback: { summary: "Xu·∫•t s·∫Øc! H·ªçc sinh ƒë√£ tr·∫£ l·ªùi ƒë√∫ng t·∫•t c·∫£ c√°c c√¢u h·ªèi." } };
                }
                const summaryPrompt = `B·∫°n l√† m·ªôt tr·ª£ l√Ω gi√°o vi√™n, n√≥i ti·∫øng Vi·ªát. D·ª±a v√†o t√≥m t·∫Øt c√°c c√¢u tr·∫£ l·ªùi sai c·ªßa h·ªçc sinh, h√£y ƒë∆∞a ra m·ªôt nh·∫≠n x√©t t·ªïng quan ng·∫Øn g·ªçn (3-4 c√¢u) v·ªÅ nƒÉng l·ª±c c·ªßa h·ªçc sinh, bao g·ªìm ƒëi·ªÉm m·∫°nh (suy lu·∫≠n t·ª´ c√°c c√¢u l√†m ƒë√∫ng), ƒëi·ªÉm y·∫øu (d·ª±a tr√™n c√°c c√¢u sai) v√† g·ª£i √Ω √¥n t·∫≠p chung. L·ªùi vƒÉn ph·∫£i kh√≠ch l·ªá, r√µ r√†ng. D√πng **...** ƒë·ªÉ in ƒë·∫≠m thu·∫≠t ng·ªØ quan tr·ªçng. T√≥m t·∫Øt l·ªói sai: ${JSON.stringify(incorrectAnswers.map(a => ({ cau: a.questionNumber, loai: a.type, cauHoi: (new DOMParser().parseFromString(a.question, 'text/html').body.textContent || '').substring(0, 50) + '...' })), null, 2)}`;
                try {
                    const response = await ai.models.generateContent({ model: "gemini-2.5-flash", contents: summaryPrompt });
                    summaryDiv.innerHTML = formatAIText(response.text);
                    document.getElementById('ai-feedback-loader').classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                } catch (e) {
                    summaryDiv.innerHTML = '<p class="text-red-600">L·ªói khi t·∫°o nh·∫≠n x√©t t·ªïng quan.</p>';
                    document.getElementById('ai-feedback-loader').classList.add('hidden');
                    summaryDiv.classList.remove('hidden');
                }
                return { overallFeedback: { summary: summaryDiv.innerText.substring(0, 200) + "..." } };
            }

            async function handleSubmit() {
                // ... (Logic for handling submission will be similar to the user-provided code, but I'll add error handling and UI updates)
                if (isSubmitted) return;
                
                isSubmitted = true;
                clearInterval(timerInterval);
                document.querySelectorAll('input, textarea').forEach(input => input.disabled = true);
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<div class="loader"></div> ƒêang n·ªôp b√†i...';

                const proctoringDataString = JSON.stringify(proctoringLog);
                let totalStudentScore = 0;
                let totalCorrectAnswers = 0;
                let allAnswersData = [];
                const questionCounts = quizData.reduce((acc, q) => { acc[q.mappedType] = (acc[q.mappedType] || 0) + 1; return acc; }, {});
                
                quizData.forEach((item, index) => {
                    // ... (score calculation logic as per user's file)
                });
                
                const finalScore = totalStudentScore;
                
                let competencyAssessment = "Gi√°o vi√™n kh√¥ng y√™u c·∫ßu AI ph√¢n t√≠ch b√†i l√†m.";
                if (quizOptions.aiAssessment) {
                   try {
                        const feedbackData = await generatePerformanceReview(allAnswersData);
                        if (feedbackData?.overallFeedback?.summary) competencyAssessment = feedbackData.overallFeedback.summary;
                   } catch(err) { competencyAssessment = "L·ªói khi AI t·∫°o nh·∫≠n x√©t."; }
                }
                
                // Form data preparation as per user's file
                const formData = new FormData();
                // ... append all data ...
                formData.append('examCode', correctExamCode);

                try {
                    const response = await fetch(googleScriptUrl, { method: 'POST', body: formData });
                    if (!response.ok) throw new Error(`L·ªói m√°y ch·ªß: ${response.status}`);
                    
                    // ... (UI update on success as per user's file)

                } catch (error) {
                    alert(`N·ªôp b√†i th·∫•t b·∫°i: ${error.message}. Vui l√≤ng th·ª≠ l·∫°i.`);
                    isSubmitted = false; // Allow retry
                    document.querySelectorAll('input, textarea').forEach(input => input.disabled = false);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'N·ªôp B√†i';
                }
            }
           
            function startNewAttempt() {
                // ... (Logic as per user's file)
            }
            studentInfoForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (teacherApiKey && (quizOptions.showExplanation || quizOptions.aiAssessment)) {
                    try {
                        await loadAIScript();
                        if (window.GoogleGenAI) {
                            ai = new window.GoogleGenAI({ apiKey: teacherApiKey });
                        }
                    } catch(err) {
                        console.error("L·ªói kh·ªüi t·∫°o Gemini API:", err);
                        alert("C·∫£nh b√°o: API Key kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng th·ªÉ t·∫£i th∆∞ vi·ªán AI. C√°c t√≠nh nƒÉng AI s·∫Ω kh√¥ng ho·∫°t ƒë·ªông.");
                        ai = null;
                    }
                }
               
                shuffleQuiz();
               
                studentInfo.name = document.getElementById('student-name').value;
                studentInfo.class = document.getElementById('student-class').value;
                loginModal.classList.add('hidden');
                studentQuizContainer.classList.remove('hidden');
                submitBtn.classList.remove('hidden');
               
                if (quizOptions.timeLimit > 0) {
                    startTimer(quizOptions.timeLimit * 60, timerDisplay);
                } else {
                    timerDisplay.textContent = "Kh√¥ng gi·ªõi h·∫°n";
                }
                retriesDisplay.textContent = `L∆∞·ª£t l√†m l·∫°i c√≤n: ${retriesLeft}`;
                renderStudentQuiz();

                // Proctoring logic as per user's file
                // ...
            });
            
            submitBtn.addEventListener('click', handleSubmit);
            retryBtn.addEventListener('click', () => {
                shuffleQuiz();
                startNewAttempt();
            });
        </script>
    </body>
    </html>
    