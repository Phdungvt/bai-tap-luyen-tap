<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>B√†i ki·ªÉm tra toan</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- MathJax Configuration -->
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #f9fafb; -webkit-tap-highlight-color: transparent; }
        .prose img { border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); max-width: 100%; height: auto; }
        .hidden { display: none !important; }
        /* Sticky Header Progress */
        #header-progress { position: sticky; top: 0; z-index: 40; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        /* Mobile Navigation Bottom Bar */
        .mobile-bottom-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; border-top: 1px solid #e5e7eb;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0.75rem 1rem; z-index: 50;
            padding-bottom: env(safe-area-inset-bottom, 0.75rem);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Drawer Transition */
        #nav-panel { transition: transform 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col text-gray-800">

    <!-- WELCOME SCREEN -->
    <div id="welcome-screen" class="flex-grow flex items-center justify-center p-4">
        <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl w-full max-w-md border border-indigo-50">
            <div class="text-center mb-6">
                <div class="bg-indigo-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                    </svg>
                </div>
                <h1 class="text-xl sm:text-2xl font-bold text-gray-800 mb-1 leading-tight">B√†i ki·ªÉm tra toan</h1>
                <p class="text-gray-500 text-sm">Gi√°o vi√™n: Gi√°o vi√™n b·ªô m√¥n</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">H·ªç v√† t√™n</label>
                    <input type="text" id="name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow outline-none" placeholder="Nh·∫≠p h·ªç t√™n c·ªßa b·∫°n">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">L·ªõp</label>
                    <input type="text" id="class" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow outline-none" placeholder="Nh·∫≠p l·ªõp (VD: 12A1)">
                </div>
                 
                <div id="api-key-input-container">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Gemini API Key (Nh·∫≠p key n·∫øu GV y√™u c·∫ßu)</label>
                    <input type="password" id="student-api-key" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow outline-none" placeholder="Nh·∫≠p API Key">
                </div>
                <button id="start-btn" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-3.5 px-4 rounded-xl shadow-md transition-transform transform active:scale-95 mt-2 text-base">
                    B·∫ÆT ƒê·∫¶U L√ÄM B√ÄI
                </button>
            </div>
        </div>
    </div>

    <!-- QUIZ SCREEN -->
    <div id="quiz-screen" class="hidden flex flex-col h-screen bg-gray-50">
        <!-- Sticky Header with Info & Progress -->
        <header id="header-progress" class="flex-shrink-0 bg-white shadow-sm z-40">
            <div class="px-4 py-3 flex items-center justify-between border-b border-gray-100">
                <div class="flex items-center gap-3 overflow-hidden">
                    <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold text-xs shrink-0">HS</div>
                    <div class="flex flex-col min-w-0">
                        <div class="font-bold text-gray-800 text-sm truncate" id="student-name-display">--</div>
                        <div class="text-xs text-gray-500 truncate" id="progress-text">0/25</div>
                    </div>
                </div>
                <div class="flex flex-col items-end">
                    <span class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Th·ªùi gian</span>
                    <span id="timer" class="text-lg font-mono font-bold text-indigo-600">00:00</span>
                </div>
            </div>
            <!-- Progress Bar -->
            <div class="h-1 w-full bg-gray-200">
                <div class="h-1 bg-green-500 transition-all duration-300" style="width: 0%" id="progress-bar"></div>
            </div>
        </header>

        <!-- Body Container -->
        <div class="flex flex-1 overflow-hidden relative">
            <!-- Main Scrollable Area (Questions) -->
            <main class="flex-1 overflow-y-auto p-4 sm:p-6 bg-gray-50 scroll-smooth relative" id="main-scroll-area">
                <div class="max-w-6xl mx-auto" id="questions-wrapper">
                     <div id="questions-container">
                        <!-- Questions injected here -->
                     </div>
                     <!-- NEW SUBMIT BUTTON -->
                    <div class="mt-8 mb-20 text-center">
                        <button id="main-submit-btn" class="inline-flex items-center justify-center gap-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-4 px-12 rounded-xl shadow-lg transition-transform transform active:scale-95 text-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" /></svg>
                            N·ªòP B√ÄI THI
                        </button>
                    </div>
                </div>
            </main>
            
            <!-- Navigation Sidebar (Desktop) -->
            <aside id="nav-panel" class="w-80 bg-white border-l border-gray-200 overflow-y-auto hidden md:flex flex-col z-30 shadow-lg md:shadow-none">
                <div class="p-4 border-b border-gray-100 bg-gray-50 sticky top-0 z-10">
                    <h3 class="font-bold text-gray-700 text-lg">Danh s√°ch c√¢u h·ªèi</h3>
                </div>
                
                <div class="flex-1 p-4">
                    <div class="grid grid-cols-5 gap-3" id="nav-grid">
                        <!-- Nav buttons injected here -->
                    </div>
                </div>
                
                <div class="p-4 border-t border-gray-100 bg-white sticky bottom-0 z-10">
                     <div class="grid grid-cols-2 gap-2 text-xs text-center mb-4 text-gray-500">
                        <div class="flex items-center gap-1 justify-center"><span class="w-3 h-3 rounded bg-gray-100 border border-gray-200"></span> Ch∆∞a l√†m</div>
                        <div class="flex items-center gap-1 justify-center"><span class="w-3 h-3 rounded bg-indigo-600 border border-indigo-600"></span> ƒê√£ l√†m</div>
                    </div>
                    <button id="submit-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl shadow-md transition-colors flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" /></svg>
                        N·ªòP B√ÄI
                    </button>
                </div>
            </aside>
        </div>
        
        <!-- Mobile Bottom Navigation Bar -->
        <div class="mobile-bottom-bar md:hidden">
            <button id="mobile-prev-btn" class="p-2 text-gray-500 hover:text-indigo-600 disabled:opacity-30 disabled:cursor-not-allowed">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
            </button>
            
            <button id="mobile-menu-btn" class="flex items-center gap-2 px-4 py-2 bg-indigo-50 text-indigo-700 rounded-full font-semibold text-sm hover:bg-indigo-100 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                <span id="mobile-current-q">C√¢u 1/25</span>
            </button>
            
            <button id="mobile-next-btn" class="p-2 text-gray-500 hover:text-indigo-600 disabled:opacity-30 disabled:cursor-not-allowed">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
            </button>
        </div>

        <!-- Mobile Drawer Overlay -->
        <div id="nav-overlay" class="fixed inset-0 bg-black/30 z-40 hidden md:hidden glass-effect" onclick="document.getElementById('mobile-drawer').classList.add('translate-x-full'); this.classList.add('hidden');"></div>
        
        <!-- Mobile Drawer -->
        <aside id="mobile-drawer" class="fixed inset-y-0 right-0 w-72 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-50 flex flex-col md:hidden">
             <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-gray-700 text-lg">Danh s√°ch c√¢u h·ªèi</h3>
                <button class="p-2 text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-200" onclick="document.getElementById('mobile-drawer').classList.add('translate-x-full'); document.getElementById('nav-overlay').classList.add('hidden');">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-4" id="mobile-nav-grid-container">
                <!-- Will duplicate nav grid here via JS -->
            </div>
             <div class="p-4 border-t border-gray-100 bg-white">
                 <button id="drawer-submit-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 px-4 rounded-xl shadow-lg transition-colors flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" /></svg>
                    N·ªòP B√ÄI THI
                </button>
            </div>
        </aside>
    </div>

    <!-- RESULT SCREEN -->
    <div id="result-screen" class="hidden flex-grow bg-gray-50 overflow-y-auto p-4">
        <div class="max-w-4xl mx-auto space-y-6">
            <!-- Score Card -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden text-center p-8 border border-gray-200 relative">
                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-green-400 to-blue-500"></div>
                <h2 class="text-3xl font-bold text-gray-800 mb-2">K·∫øt Qu·∫£ B√†i L√†m</h2>
                <div class="text-6xl font-black text-indigo-600 my-6 tracking-tighter" id="score-display">--</div>
                
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm bg-gray-50 p-4 rounded-xl border border-gray-100">
                    <div>
                        <p class="text-gray-500 uppercase text-xs font-semibold">H·ªç t√™n</p>
                        <p class="font-medium text-gray-900 text-lg" id="result-name">--</p>
                    </div>
                    <div>
                        <p class="text-gray-500 uppercase text-xs font-semibold">L·ªõp</p>
                        <p class="font-medium text-gray-900 text-lg" id="result-class">--</p>
                    </div>
                    <div>
                        <p class="text-gray-500 uppercase text-xs font-semibold">Th·ªùi gian</p>
                        <p class="font-medium text-gray-900 text-lg" id="result-time">--</p>
                    </div>
                </div>

                <div id="ai-assessment-container" class="mt-8 hidden text-left bg-indigo-50 p-6 rounded-xl border border-indigo-100">
                    <h3 class="flex items-center gap-2 font-bold text-indigo-800 mb-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                        Nh·∫≠n x√©t t·ª´ AI
                    </h3>
                    <div id="ai-assessment-content" class="prose prose-sm prose-indigo max-w-none text-gray-700"></div>
                </div>

                <div class="mt-8">
                     <button id="view-answers-btn" class="hidden inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                        Xem ƒë√°p √°n chi ti·∫øt
                    </button>
                </div>
            </div>

            <!-- Detailed Answers -->
            <div id="detailed-answers" class="hidden bg-white rounded-2xl shadow-lg border border-gray-200 p-6 sm:p-8">
                <!-- Content injected by JS -->
            </div>
        </div>
    </div>

    <!-- CLIENT LOGIC SCRIPT -->
    <script type="module">
        
    import { GoogleGenAI } from "https://esm.sh/@google/genai@^1.13.0";

    // --- 1. DECODE DATA ---
    const quizData = JSON.parse(decodeURIComponent(escape(atob("W3sicXVlc3Rpb24iOiJL4bq/dCBxdeG6oyBj4bunYSBwaMOpcCB0w61uaCAkXFxkZnJhY3sxfXsyfSArIFxcZGZyYWN7MX17M30kIGzDoCIsIm9wdGlvbnMiOlsiJFxcZGZyYWN7NX17Nn0kIiwiJFxcZGZyYWN7Mn17NX0kIiwiJFxcZGZyYWN7MX17Nn0kIiwiJFxcZGZyYWN7M317Mn0kIl0sImNvcnJlY3RBbnN3ZXJJbmRleCI6MCwidHlwZSI6Im11bHRpcGxlLWNob2ljZSIsImlzRGlydHkiOmZhbHNlLCJleHBsYW5hdGlvbiI6bnVsbCwic2h1ZmZsZU9wdGlvbnMiOnsic3RlbSI6dHJ1ZSwiYW5zd2VycyI6dHJ1ZX0sInF1ZXN0aW9uTnVtYmVyIjoxLCJpZCI6InFfNDUwNTQwODIyIiwicXVlc3Rpb25TbmlwcGV0IjoiS+G6v3QgcXXhuqMgY+G7p2EgcGjDqXAgdMOtbmggJFxcZGZyYWN7MX17Mn0gKyBcXGRmcmFjezF9ezN9JCBsw6AiLCJyZW5kZXJlZF9xdWVzdGlvbiI6Ikvhur90IHF14bqjIGPhu6dhIHBow6lwIHTDrW5oICRcXGRmcmFjezF9ezJ9ICsgXFxkZnJhY3sxfXszfSQgbMOgIiwicmVuZGVyZWRfb3B0aW9ucyI6WyIkXFxkZnJhY3s1fXs2fSQiLCIkXFxkZnJhY3syfXs1fSQiLCIkXFxkZnJhY3sxfXs2fSQiLCIkXFxkZnJhY3szfXsyfSQiXX0seyJxdWVzdGlvbiI6Ikvhur90IHF14bqjIGPhu6dhIHBow6lwIHTDrW5oICRcXGRmcmFjezN9ezR9IC0gXFxkZnJhY3sxfXsyfSQgbMOgIiwib3B0aW9ucyI6WyIkXFxkZnJhY3sxfXs0fSQiLCIkXFxkZnJhY3s1fXs0fSQiLCIkXFxkZnJhY3sxfXsyfSQiLCIkXFxkZnJhY3stMX17NH0kIl0sImNvcnJlY3RBbnN3ZXJJbmRleCI6MCwidHlwZSI6Im11bHRpcGxlLWNob2ljZSIsImlzRGlydHkiOmZhbHNlLCJleHBsYW5hdGlvbiI6bnVsbCwic2h1ZmZsZU9wdGlvbnMiOnsic3RlbSI6dHJ1ZSwiYW5zd2VycyI6dHJ1ZX0sInF1ZXN0aW9uTnVtYmVyIjoyLCJpZCI6InFfMTYzNTA5NDkzIiwicXVlc3Rpb25TbmlwcGV0IjoiS+G6v3QgcXXhuqMgY+G7p2EgcGjDqXAgdMOtbmggJFxcZGZyYWN7M317NH0gLSBcXGRmcmFjezF9ezJ9JCBsw6AiLCJyZW5kZXJlZF9xdWVzdGlvbiI6Ikvhur90IHF14bqjIGPhu6dhIHBow6lwIHTDrW5oICRcXGRmcmFjezN9ezR9IC0gXFxkZnJhY3sxfXsyfSQgbMOgIiwicmVuZGVyZWRfb3B0aW9ucyI6WyIkXFxkZnJhY3sxfXs0fSQiLCIkXFxkZnJhY3s1fXs0fSQiLCIkXFxkZnJhY3sxfXsyfSQiLCIkXFxkZnJhY3stMX17NH0kIl19LHsicXVlc3Rpb24iOiJL4bq/dCBxdeG6oyBj4bunYSBwaMOpcCB0w61uaCAkXFxkZnJhY3stMn17NX0gXFx0aW1lcyBcXGRmcmFjezE1fXs0fSQgbMOgIiwib3B0aW9ucyI6WyIkXFxkZnJhY3stM317Mn0kIiwiJFxcZGZyYWN7M317Mn0kIiwiJFxcZGZyYWN7LTh9ezc1fSQiLCIkXFxkZnJhY3stMzB9ezIwfSQiXSwiY29ycmVjdEFuc3dlckluZGV4IjowLCJ0eXBlIjoibXVsdGlwbGUtY2hvaWNlIiwiaXNEaXJ0eSI6ZmFsc2UsImV4cGxhbmF0aW9uIjpudWxsLCJzaHVmZmxlT3B0aW9ucyI6eyJzdGVtIjp0cnVlLCJhbnN3ZXJzIjp0cnVlfSwicXVlc3Rpb25OdW1iZXIiOjMsImlkIjoicV8xODcxMDkzMDgiLCJxdWVzdGlvblNuaXBwZXQiOiJL4bq/dCBxdeG6oyBj4bunYSBwaMOpcCB0w61uaCAkXFxkZnJhY3stMn17NX0gXFx0aW1lcyBcXGRmcmFjezE1fXs0fSQgbMOgIiwicmVuZGVyZWRfcXVlc3Rpb24iOiJL4bq/dCBxdeG6oyBj4bunYSBwaMOpcCB0w61uaCAkXFxkZnJhY3stMn17NX0gXFx0aW1lcyBcXGRmcmFjezE1fXs0fSQgbMOgIiwicmVuZGVyZWRfb3B0aW9ucyI6WyIkXFxkZnJhY3stM317Mn0kIiwiJFxcZGZyYWN7M317Mn0kIiwiJFxcZGZyYWN7LTh9ezc1fSQiLCIkXFxkZnJhY3stMzB9ezIwfSQiXX0seyJxdWVzdGlvbiI6Ikvhur90IHF14bqjIGPhu6dhIHBow6lwIHTDrW5oICRcXGRmcmFjezN9ezd9IFxcZGl2IFxcbGVmdCggXFxkZnJhY3stOX17MTR9IFxccmlnaHQpJCBsw6AiLCJvcHRpb25zIjpbIiRcXGRmcmFjey0yfXszfSQiLCIkXFxkZnJhY3syfXszfSQiLCIkXFxkZnJhY3stMjd9ezk4fSQiLCIkXFxkZnJhY3stMX17Mn0kIl0sImNvcnJlY3RBbnN3ZXJJbmRleCI6MCwidHlwZSI6Im11bHRpcGxlLWNob2ljZSIsImlzRGlydHkiOmZhbHNlLCJleHBsYW5hdGlvbiI6bnVsbCwic2h1ZmZsZU9wdGlvbnMiOnsic3RlbSI6dHJ1ZSwiYW5zd2VycyI6dHJ1ZX0sInF1ZXN0aW9uTnVtYmVyIjo0LCJpZCI6InFfMTYxMjIzNTIyOSIsInF1ZXN0aW9uU25pcHBldCI6Ikvhur90IHF14bqjIGPhu6dhIHBow6lwIHTDrW5oICRcXGRmcmFjezN9ezd9IFxcZGl2IFxcbGVmdCggXFxkZnJhY3stOX17MTR9IFxccmlnaHQpLi4uIiwicmVuZGVyZWRfcXVlc3Rpb24iOiJL4bq/dCBxdeG6oyBj4bunYSBwaMOpcCB0w61uaCAkXFxkZnJhY3szfXs3fSBcXGRpdiBcXGxlZnQoIFxcZGZyYWN7LTl9ezE0fSBcXHJpZ2h0KSQgbMOgIiwicmVuZGVyZWRfb3B0aW9ucyI6WyIkXFxkZnJhY3stMn17M30kIiwiJFxcZGZyYWN7Mn17M30kIiwiJFxcZGZyYWN7LTI3fXs5OH0kIiwiJFxcZGZyYWN7LTF9ezJ9JCJdfSx7InF1ZXN0aW9uIjoiS+G6v3QgcXXhuqMgY+G7p2EgcGjDqXAgdMOtbmggJFxcZGZyYWN7MX17M30gKyBcXGRmcmFjezJ9ezN9IFxcdGltZXMgXFxkZnJhY3sxfXsyfSQgbMOgIiwib3B0aW9ucyI6WyIkXFxkZnJhY3syfXszfSQiLCIkXFxkZnJhY3sxfXszfSQiLCIkMSQiLCIkXFxkZnJhY3sxfXsyfSQiXSwiY29ycmVjdEFuc3dlckluZGV4IjowLCJ0eXBlIjoibXVsdGlwbGUtY2hvaWNlIiwiaXNEaXJ0eSI6ZmFsc2UsImV4cGxhbmF0aW9uIjpudWxsLCJzaHVmZmxlT3B0aW9ucyI6eyJzdGVtIjp0cnVlLCJhbnN3ZXJzIjp0cnVlfSwicXVlc3Rpb25OdW1iZXIiOjUsImlkIjoicV8yMTAzMzc2MzEiLCJxdWVzdGlvblNuaXBwZXQiOiJL4bq/dCBxdeG6oyBj4bunYSBwaMOpcCB0w61uaCAkXFxkZnJhY3sxfXszfSArIFxcZGZyYWN7Mn17M30gXFx0aW1lcyBcXGRmcmFjezF9ezJ9Li4uIiwicmVuZGVyZWRfcXVlc3Rpb24iOiJL4bq/dCBxdeG6oyBj4bunYSBwaMOpcCB0w61uaCAkXFxkZnJhY3sxfXszfSArIFxcZGZyYWN7Mn17M30gXFx0aW1lcyBcXGRmcmFjezF9ezJ9JCBsw6AiLCJyZW5kZXJlZF9vcHRpb25zIjpbIiRcXGRmcmFjezJ9ezN9JCIsIiRcXGRmcmFjezF9ezN9JCIsIiQxJCIsIiRcXGRmcmFjezF9ezJ9JCJdfV0="))));
    const options = JSON.parse(decodeURIComponent(escape(atob("eyJ0aW1lTGltaXQiOjQ1LCJyZXRyaWVzIjoxLCJzdGFydFRpbWUiOm51bGwsImVuZFRpbWUiOm51bGwsInNob3J0QW5zd2VyRm9ybWF0IjoiZnJlZWZvcm0iLCJwb2ludHNNQyI6NSwicG9pbnRzVEYiOjIsInBvaW50c1NBIjoyLCJwb2ludHNFc3NheSI6MSwicG9pbnRzVEZNZXRob2QiOiJwcm9ncmVzc2l2ZSIsInNob3dBbnN3ZXJzIjp0cnVlLCJzaG93RXhwbGFuYXRpb24iOnRydWUsImFpQXNzZXNzbWVudCI6dHJ1ZSwidGVhY2hlck5hbWUiOiIifQ=="))));
    const apiKeysEncoded = JSON.parse(decodeURIComponent(escape(atob("eyJnZW1pbmkiOiJRVWw2WVZONVJHbHRZVzFGUW5aNkxWcDNiakp0VjJGb1oyOVpPRkpsUkRjNVlrUkpkSFV3Iiwib3BlbmFpIjoiIiwiZGVlcHNlZWsiOiIifQ=="))));
    const googleScriptUrl = "https://script.google.com/macros/s/AKfycbx47NhmJsIRJOq2h6M__DtkzbuXwjFBNvvIPL6uNIMj0DUkmeKMtTePa8DordWHsYiQYA/exec";
    const examCode = "EPOURH";
    const teacherName = "Gi√°o vi√™n b·ªô m√¥n";

    const apiKeys = {
        gemini: atob(apiKeysEncoded.gemini),
    };

    // --- 2. STATE ---
    let userAnswers = {};
    let timeLeft = options.timeLimit * 60;
    let timerInterval;
    let isSubmitted = false;
    let startTime = new Date();
    let currentQuestionIndex = 0; // Track view for mobile nav
    let monitorLog = {
        thoatManHinh: 0,
        saoChep: 0,
        dan: 0
    };

    // --- 3. DOM ELEMENTS ---
    const dom = {
        welcomeScreen: document.getElementById('welcome-screen'),
        quizScreen: document.getElementById('quiz-screen'),
        resultScreen: document.getElementById('result-screen'),
        nameInput: document.getElementById('name'),
        classInput: document.getElementById('class'),
        studentApiKeyInput: document.getElementById('student-api-key'),
        startBtn: document.getElementById('start-btn'),
        studentNameDisplay: document.getElementById('student-name-display'),
        timerDisplay: document.getElementById('timer'),
        questionsContainer: document.getElementById('questions-container'),
        navGrid: document.getElementById('nav-grid'),
        submitBtn: document.getElementById('submit-btn'),
        drawerSubmitBtn: document.getElementById('drawer-submit-btn'),
        mainSubmitBtn: document.getElementById('main-submit-btn'),
        scoreDisplay: document.getElementById('score-display'),
        resultName: document.getElementById('result-name'),
        resultClass: document.getElementById('result-class'),
        resultTime: document.getElementById('result-time'),
        detailedAnswers: document.getElementById('detailed-answers'),
        viewAnswersBtn: document.getElementById('view-answers-btn'),
        aiAssessmentContainer: document.getElementById('ai-assessment-container'),
        aiAssessmentContent: document.getElementById('ai-assessment-content'),
        progressBar: document.getElementById('progress-bar'),
        progressText: document.getElementById('progress-text'),
        navPanel: document.getElementById('nav-panel'),
        navOverlay: document.getElementById('nav-overlay'),
        mobilePrevBtn: document.getElementById('mobile-prev-btn'),
        mobileNextBtn: document.getElementById('mobile-next-btn'),
        mobileMenuBtn: document.getElementById('mobile-menu-btn'),
        mobileCurrentQ: document.getElementById('mobile-current-q')
    };

    // --- 4. INIT ---
    dom.startBtn.addEventListener('click', startQuiz);
    
    // Mobile Nav Listeners
    if(dom.mobilePrevBtn) dom.mobilePrevBtn.addEventListener('click', () => scrollToQ(currentQuestionIndex - 1));
    if(dom.mobileNextBtn) dom.mobileNextBtn.addEventListener('click', () => scrollToQ(currentQuestionIndex + 1));
    if(dom.mobileMenuBtn) dom.mobileMenuBtn.addEventListener('click', toggleNav);
    if(dom.navOverlay) dom.navOverlay.addEventListener('click', closeNav);

    document.addEventListener('visibilitychange', () => {
        if (document.hidden && !isSubmitted && dom.quizScreen.style.display !== 'none') {
            monitorLog.thoatManHinh++;
        }
    });
    
    document.addEventListener('copy', () => { if(!isSubmitted) monitorLog.saoChep++; });
    document.addEventListener('paste', () => { if(!isSubmitted) monitorLog.dan++; });

    function startQuiz() {
        const name = dom.nameInput.value.trim();
        const className = dom.classInput.value.trim();
        if (!name || !className) {
            alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß H·ªç t√™n v√† L·ªõp!');
            return;
        }
        
        // NEW: Get Student API Key if provided
        if (dom.studentApiKeyInput && dom.studentApiKeyInput.value.trim()) {
            apiKeys.gemini = dom.studentApiKeyInput.value.trim();
        }

        dom.studentNameDisplay.textContent = name;
        dom.welcomeScreen.classList.add('hidden');
        dom.quizScreen.classList.remove('hidden');
        
        renderQuestions();
        renderNav();
        updateProgress();
        
        if (options.timeLimit > 0) {
            startTimer();
        } else {
            dom.timerDisplay.textContent = "--:--";
        }
        
        // Setup intersection observer to update current question index on scroll
        setupScrollObserver();
        
        window.scrollTo(0, 0);
    }

    function startTimer() {
        updateTimerDisplay();
        timerInterval = setInterval(() => {
            timeLeft--;
            updateTimerDisplay();
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                submitQuiz(true);
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        const m = Math.floor(timeLeft / 60);
        const s = timeLeft % 60;
        dom.timerDisplay.textContent = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        
        // Change color when time is running out (< 5 mins)
        if (timeLeft < 300) {
            dom.timerDisplay.classList.add('text-red-600', 'animate-pulse');
            dom.timerDisplay.classList.remove('text-indigo-600');
        }
    }

    function updateProgress() {
        const total = quizData.length;
        const answered = Object.keys(userAnswers).length;
        const percent = (answered / total) * 100;
        dom.progressBar.style.width = `${percent}%`;
        if(dom.progressText) dom.progressText.textContent = `${answered}/${total}`;
        
        // Update Grid Colors
        quizData.forEach((_, idx) => {
            const btn = document.getElementById(`nav-${idx}`);
            if (btn) {
                if (userAnswers[idx] !== undefined) {
                    btn.classList.remove('bg-gray-100', 'text-gray-600', 'border-gray-200');
                    btn.classList.add('bg-indigo-600', 'text-white', 'border-indigo-600');
                } else {
                    btn.classList.add('bg-gray-100', 'text-gray-600', 'border-gray-200');
                    btn.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-600');
                }
                
                // Highlight current
                if (idx === currentQuestionIndex) {
                     btn.classList.add('ring-2', 'ring-offset-2', 'ring-indigo-500');
                } else {
                     btn.classList.remove('ring-2', 'ring-offset-2', 'ring-indigo-500');
                }
            }
        });
    }

    function toggleNav() {
        const isOpen = !dom.navPanel.classList.contains('translate-x-full');
        if (isOpen) closeNav();
        else openNav();
    }
    
    function openNav() {
        dom.navPanel.classList.remove('translate-x-full');
        if(dom.navOverlay) dom.navOverlay.classList.remove('hidden');
    }
    
    function closeNav() {
        dom.navPanel.classList.add('translate-x-full');
        if(dom.navOverlay) dom.navOverlay.classList.add('hidden');
    }
    
    function scrollToQ(index) {
        if (index < 0 || index >= quizData.length) return;
        currentQuestionIndex = index;
        const qEl = document.getElementById(`q-${index}`);
        if (qEl) {
            // Scroll with offset for sticky header
            const headerOffset = 100;
            const elementPosition = qEl.getBoundingClientRect().top;
            const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
            window.scrollTo({ top: offsetPosition, behavior: "smooth" });
        }
        updateMobileControls();
        updateProgress(); // To update grid highlight
    }
    
    function updateMobileControls() {
        if(dom.mobileCurrentQ) dom.mobileCurrentQ.textContent = `C√¢u ${currentQuestionIndex + 1}/${quizData.length}`;
        dom.mobilePrevBtn.disabled = currentQuestionIndex === 0;
        dom.mobileNextBtn.disabled = currentQuestionIndex === quizData.length - 1;
        
        dom.mobilePrevBtn.classList.toggle('opacity-50', currentQuestionIndex === 0);
        dom.mobileNextBtn.classList.toggle('opacity-50', currentQuestionIndex === quizData.length - 1);
    }
    
    function setupScrollObserver() {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const id = entry.target.id; // q-0, q-1...
                    const idx = parseInt(id.split('-')[1]);
                    currentQuestionIndex = idx;
                    updateMobileControls();
                    updateProgress();
                }
            });
        }, { threshold: 0.5 });
        
        quizData.forEach((_, idx) => {
            const el = document.getElementById(`q-${idx}`);
            if(el) observer.observe(el);
        });
    }

    // --- 5. RENDER ---
    function renderQuestions() {
        dom.questionsContainer.innerHTML = '';
        quizData.forEach((item, index) => {
            const qDiv = document.createElement('div');
            qDiv.id = `q-${index}`;
            qDiv.className = "bg-white p-4 sm:p-6 rounded-xl shadow-sm border border-gray-200 mb-4 sm:mb-6 scroll-mt-24";
            
            let html = `<div class="mb-3">
                <div class="flex justify-between items-start mb-2">
                    <span class="inline-flex items-center justify-center bg-indigo-100 text-indigo-800 text-xs font-bold px-2.5 py-1 rounded-md">C√¢u ${index + 1}</span>
                    ${item.type !== 'multiple-choice' ? `<span class="text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded">${getVNType(item.type)}</span>` : ''}
                </div>
                <div class="font-medium text-gray-800 text-base sm:text-lg leading-relaxed">${item.rendered_question || item.question}</div>
            </div>`;

            if (item.type === 'multiple-choice' || item.type.startsWith('mc-')) {
                html += `<div class="grid grid-cols-1 gap-3">`;
                item.rendered_options.forEach((opt, i) => {
                    html += `
                    <label class="cursor-pointer group">
                        <div class="flex items-start p-3 rounded-lg border border-gray-200 bg-gray-50 hover:bg-indigo-50 hover:border-indigo-200 transition-all">
                            <div class="flex items-center h-5">
                                <input type="radio" name="q-${index}" value="${i}" class="h-5 w-5 text-indigo-600 border-gray-300 focus:ring-indigo-500" onchange="selectAnswer(${index}, ${i})">
                            </div>
                            <span class="ml-3 text-sm sm:text-base text-gray-700 group-hover:text-indigo-900">${String.fromCharCode(65+i)}. ${opt}</span>
                        </div>
                    </label>`;
                });
                html += `</div>`;
            } else if (item.type === 'true-false' || item.type.startsWith('tf-')) {
                 html += `<div class="overflow-x-auto border border-gray-200 rounded-lg">
                 <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50"><tr><th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">M·ªánh ƒë·ªÅ</th><th class="px-2 py-2 text-center text-xs font-medium text-gray-500 w-16">ƒê√∫ng</th><th class="px-2 py-2 text-center text-xs font-medium text-gray-500 w-16">Sai</th></tr></thead>
                    <tbody class="bg-white divide-y divide-gray-200">`;
                 item.statements.forEach((stmt, i) => {
                     html += `<tr>
                        <td class="px-3 py-2 text-sm">${stmt.rendered_statement || stmt.statement}</td>
                        <td class="px-2 py-2 text-center"><input type="radio" name="q-${index}-${i}" value="true" class="h-4 w-4 text-indigo-600" onchange="selectTFAnswer(${index}, ${i}, true)"></td>
                        <td class="px-2 py-2 text-center"><input type="radio" name="q-${index}-${i}" value="false" class="h-4 w-4 text-indigo-600" onchange="selectTFAnswer(${index}, ${i}, false)"></td>
                     </tr>`;
                 });
                 html += `</tbody></table></div>`;
            } else {
                 html += `<textarea class="w-full border border-gray-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" rows="3" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n..." oninput="inputAnswer(${index}, this.value)"></textarea>`;
            }

            qDiv.innerHTML = html;
            dom.questionsContainer.appendChild(qDiv);
        });
        
        // Add a spacer at the bottom for mobile nav bar
        const spacer = document.createElement('div');
        spacer.className = "h-20 sm:hidden"; 
        dom.questionsContainer.appendChild(spacer);

        if (window.MathJax) {
            window.MathJax.typesetPromise();
        }
    }
    
    function getVNType(type) {
        if(type === 'short-answer') return 'Tr·∫£ l·ªùi ng·∫Øn';
        if(type === 'essay') return 'T·ª± lu·∫≠n';
        if(type === 'true-false') return 'ƒê√∫ng/Sai';
        return '';
    }

    function renderNav() {
        dom.navGrid.innerHTML = '';
        quizData.forEach((_, index) => {
            const btn = document.createElement('button');
            btn.id = `nav-${index}`;
            btn.className = "w-full aspect-square flex items-center justify-center rounded border border-gray-200 bg-gray-100 text-gray-600 text-xs font-bold hover:bg-gray-200 transition-all";
            btn.textContent = index + 1;
            btn.onclick = () => {
                scrollToQ(index);
                if(window.innerWidth < 1024) closeNav();
            };
            dom.navGrid.appendChild(btn);
        });
    }

    window.selectAnswer = (qIndex, oIndex) => {
        userAnswers[qIndex] = oIndex;
        updateProgress();
    };

    window.selectTFAnswer = (qIndex, sIndex, val) => {
        if (!userAnswers[qIndex]) userAnswers[qIndex] = {};
        userAnswers[qIndex][sIndex] = val;
        // Check if all statements in this question are answered? 
        // Logic: if user touched any, mark as in-progress. 
        // Or strictly check length. Let's strictly check length for 'done' status.
        if (Object.keys(userAnswers[qIndex]).length === quizData[qIndex].statements.length) {
            updateProgress();
        } else {
             // Optional: mark partially done? For now just rely on updateProgress logic which checks userAnswers[idx] !== undefined
             updateProgress(); 
        }
    };

    window.inputAnswer = (qIndex, val) => {
        if (val.trim()) {
            userAnswers[qIndex] = val.trim();
        } else {
            delete userAnswers[qIndex];
        }
        updateProgress();
    };

    // Submit handlers
    const handleSubmit = () => {
        const answeredCount = Object.keys(userAnswers).length;
        const total = quizData.length;
        let confirmMsg = `B·∫°n ƒë√£ l√†m ${answeredCount}/${total} c√¢u.`;
        if (answeredCount < total) confirmMsg += "\nB·∫°n v·∫´n c√≤n c√¢u ch∆∞a l√†m!";
        confirmMsg += "\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i?";
        
        if (confirm(confirmMsg)) {
            submitQuiz();
        }
    };

    if(dom.submitBtn) dom.submitBtn.addEventListener('click', handleSubmit);
    if(dom.drawerSubmitBtn) dom.drawerSubmitBtn.addEventListener('click', handleSubmit);
    if(dom.mainSubmitBtn) dom.mainSubmitBtn.addEventListener('click', handleSubmit);

    async function submitQuiz(autoSubmit = false) {
        if (isSubmitted) return;
        isSubmitted = true;
        clearInterval(timerInterval);

        let score = 0;
        let detailResults = [];

        quizData.forEach((item, index) => {
            let isCorrect = false;
            let detail = {};
            let scoreEarned = 0;
            const maxScorePerQ = 10 / quizData.length;

            if (item.type === 'multiple-choice' || item.type.startsWith('mc-')) {
                if (userAnswers[index] === item.correctAnswerIndex) {
                    isCorrect = true;
                    scoreEarned = maxScorePerQ;
                }
                detail = { userAnswer: userAnswers[index], correctAnswer: item.correctAnswerIndex };
            } else if (item.type === 'true-false' || item.type.startsWith('tf-')) {
                let correctStmtCount = 0;
                let stmtResults = [];
                item.statements.forEach((stmt, i) => {
                    const userVal = userAnswers[index] ? userAnswers[index][i] : null;
                    const stmtCorrect = userVal === stmt.is_correct;
                    if (stmtCorrect) correctStmtCount++;
                    stmtResults.push({ statement: i, user: userVal, correct: stmt.is_correct, isCorrect: stmtCorrect });
                });
                
                // Progressive scoring for True/False
                if(correctStmtCount === 1) scoreEarned = maxScorePerQ * 0.1;
                else if(correctStmtCount === 2) scoreEarned = maxScorePerQ * 0.25;
                else if(correctStmtCount === 3) scoreEarned = maxScorePerQ * 0.5;
                else if(correctStmtCount === 4) { scoreEarned = maxScorePerQ; isCorrect = true; }
                
                detail = { statements: stmtResults };
            }
            // For Essay/Short Answer, auto-grading is hard, score is 0 by default or needs manual review logic.
            // Here we assume 0 for now unless exact match (simple short answer)
            
            score += scoreEarned;

            detailResults.push({
                id: item.id, // ID ƒë·ªÉ th·ªëng k√™ c√¢u hay sai
                questionNumber: index + 1,
                type: item.type,
                isCorrect: isCorrect,
                scoreEarned: scoreEarned,
                details: detail
            });
        });

        score = Math.min(10, Math.max(0, score));

        dom.quizScreen.classList.add('hidden');
        dom.resultScreen.classList.remove('hidden');
        
        dom.scoreDisplay.textContent = score.toFixed(2);
        dom.resultName.textContent = dom.nameInput.value;
        dom.resultClass.textContent = dom.classInput.value;
        dom.resultTime.textContent = new Date().toLocaleString();

        if (googleScriptUrl) {
            const payload = {
                timestamp: new Date().toISOString(),
                name: dom.nameInput.value,
                class: dom.classInput.value,
                score: score.toFixed(2),
                examCode: examCode,
                monitoringLog: JSON.stringify(monitorLog),
                answerDetails: JSON.stringify(detailResults)
            };
            
            fetch(googleScriptUrl, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).catch(e => console.error("L·ªói g·ª≠i ƒëi·ªÉm:", e));
        }

        if (options.showAnswers) {
            dom.viewAnswersBtn.classList.remove('hidden');
            renderDetailedAnswers(detailResults);
        }
        
        if (options.aiAssessment) {
            generateAIAssessment(score, detailResults);
        }
    }

    function renderDetailedAnswers(results) {
        let html = '<h3 class="text-xl font-bold mb-4 text-gray-800">Chi ti·∫øt ƒë√°p √°n</h3>';
        
        quizData.forEach((item, index) => {
            const result = results[index];
            const isCorrect = result.isCorrect;
            const color = isCorrect ? 'text-green-600' : 'text-red-600';
            
            html += `<div class="mb-6 p-4 border rounded-lg ${isCorrect ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}">
                <div class="flex justify-between items-start mb-2">
                    <div class="font-bold ${color}">C√¢u ${index + 1}: ${isCorrect ? 'ƒê√öNG' : 'SAI'} <span class="text-xs text-gray-500">(${result.scoreEarned.toFixed(2)} ƒëi·ªÉm)</span></div>
                    ${apiKeys.gemini ? `
                    <button class="ai-explain-btn text-xs bg-indigo-600 text-white px-2 py-1 rounded hover:bg-indigo-700 transition-colors flex items-center gap-1" data-index="${index}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                           <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                        Gi·∫£i th√≠ch chi ti·∫øt
                    </button>`: ''}
                </div>
                <div class="mb-2 text-gray-800">${item.rendered_question || item.question}</div>`;

            if (item.type === 'multiple-choice') {
                const userIdx = userAnswers[index];
                const correctIdx = item.correctAnswerIndex;
                html += `<div class="text-sm">
                    <p>B·∫°n ch·ªçn: <span class="font-semibold">${userIdx !== undefined ? String.fromCharCode(65+userIdx) : 'Kh√¥ng tr·∫£ l·ªùi'}</span></p>
                    <p class="font-bold text-green-700">ƒê√°p √°n ƒë√∫ng: ${String.fromCharCode(65+correctIdx)}. ${item.options[correctIdx]}</p>
                </div>`;
            } else if (item.type === 'true-false') {
                 html += '<ul class="list-disc pl-5 text-sm">';
                 item.statements.forEach((s, i) => {
                     const userVal = userAnswers[index] ? userAnswers[index][i] : null;
                     const isStmtCorrect = userVal === s.is_correct;
                     html += `<li class="${isStmtCorrect ? 'text-green-700' : 'text-red-700'}">
                        √ù ${String.fromCharCode(97+i)}: ${s.statement} (ƒê√°p √°n: ${s.is_correct ? 'ƒê√∫ng' : 'Sai'} - B·∫°n ch·ªçn: ${userVal === null ? 'Tr·ªëng' : (userVal ? 'ƒê√∫ng' : 'Sai')})
                     </li>`;
                 });
                 html += '</ul>';
            }
            
            // Container cho gi·∫£i th√≠ch AI
            html += `<div id="ai-explanation-${index}" class="hidden mt-3 p-3 bg-blue-50 text-sm text-blue-800 rounded border border-blue-200">
                <div class="font-bold mb-1">ü§ñ AI Gi·∫£i th√≠ch:</div>
                <div class="ai-content">ƒêang t·∫£i...</div>
            </div>`;
            
            if (options.showExplanation && item.rendered_answer) {
                 html += `<div class="mt-3 pt-2 border-t border-gray-200 text-sm text-gray-600">
                    <strong>Gi·∫£i th√≠ch/ƒê√°p √°n chi ti·∫øt (C√≥ s·∫µn):</strong><br>
                    ${item.rendered_answer}
                 </div>`;
            }

            html += `</div>`;
        });
        
        dom.detailedAnswers.innerHTML = html;
        if (window.MathJax) window.MathJax.typesetPromise();

        // G·∫Øn s·ª± ki·ªán cho c√°c n√∫t gi·∫£i th√≠ch AI
        document.querySelectorAll('.ai-explain-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const idx = parseInt(e.target.closest('button').dataset.index);
                explainQuestionWithAI(idx, results[idx]);
            });
        });
    }
    
    dom.viewAnswersBtn.addEventListener('click', () => {
        dom.detailedAnswers.classList.remove('hidden');
        dom.viewAnswersBtn.classList.add('hidden');
    });

    async function explainQuestionWithAI(index, resultItem) {
        if (!apiKeys.gemini) return alert("Ch∆∞a c√≥ API Key ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng n√†y.");
        
        const explanationDiv = document.getElementById(`ai-explanation-${index}`);
        const contentDiv = explanationDiv.querySelector('.ai-content');
        
        if (!explanationDiv.classList.contains('hidden') && contentDiv.innerHTML !== 'ƒêang t·∫£i...') {
             explanationDiv.classList.add('hidden'); // Toggle t·∫Øt n·∫øu ƒëang m·ªü
             return;
        }

        explanationDiv.classList.remove('hidden');
        contentDiv.textContent = "ƒêang ph√¢n t√≠ch c√¢u h·ªèi...";

        const item = quizData[index];
        let prompt = "H√£y ƒë√≥ng vai m·ªôt gi√°o vi√™n gi·ªèi, gi·∫£i th√≠ch chi ti·∫øt c√¢u h·ªèi sau cho h·ªçc sinh:\n";
        prompt += `C√¢u h·ªèi: ${item.question || item.main_question}\n`;
        
        if (item.type === 'multiple-choice') {
            prompt += `C√°c l·ª±a ch·ªçn: ${item.options.join(', ')}\n`;
            prompt += `ƒê√°p √°n ƒë√∫ng l√†: ${item.options[item.correctAnswerIndex]}\n`;
            if (userAnswers[index] !== undefined) {
                prompt += `H·ªçc sinh ch·ªçn: ${item.options[userAnswers[index]]} (ƒê√¢y l√† ƒë√°p √°n ${resultItem.isCorrect ? 'ƒë√∫ng' : 'sai'}).\n`;
            }
        } else if (item.type === 'true-false') {
             prompt += `C√°c m·ªánh ƒë·ªÅ:\n`;
             item.statements.forEach((s, i) => {
                 prompt += `${String.fromCharCode(97+i)}) ${s.statement} -> ƒê√°p √°n: ${s.is_correct ? 'ƒê√∫ng' : 'Sai'}\n`;
             });
        }
        
        prompt += "\nH√£y gi·∫£i th√≠ch t·∫°i sao ƒë√°p √°n ƒë√∫ng l·∫°i ƒë√∫ng, v√† t·∫°i sao c√°c ph∆∞∆°ng √°n nhi·ªÖu l·∫°i sai (n·∫øu c√≥). Ng·∫Øn g·ªçn, d·ªÖ hi·ªÉu.";

        try {
            const genAI = new GoogleGenAI({ apiKey: apiKeys.gemini });
            const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });
            const result = await model.generateContent(prompt);
            const response = await result.response;
            const text = response.text();
            contentDiv.innerHTML = text.replace(/\n/g, '<br>');
        } catch (e) {
            contentDiv.textContent = "L·ªói khi g·ªçi AI: " + e.message;
        }
    }

    async function generateAIAssessment(score, results) {
        if (!apiKeys.gemini) return;

        dom.aiAssessmentContainer.classList.remove('hidden');
        dom.aiAssessmentContent.textContent = "AI ƒëang ph√¢n t√≠ch b√†i l√†m c·ªßa b·∫°n...";
        
        // T·∫°o t√≥m t·∫Øt k·∫øt qu·∫£ ƒë·ªÉ g·ª≠i AI
        let summary = `ƒêi·ªÉm s·ªë: ${score}/10.\n`;
        let weakTopics = [];
        let strongTopics = [];
        
        // Ph√¢n t√≠ch s∆° b·ªô (gi·∫£ l·∫≠p, th·ª±c t·∫ø c·∫ßn metadata topic trong quizData)
        const wrongAnswers = results.filter(r => r.isCorrect === false);
        const correctAnswers = results.filter(r => r.isCorrect === true);
        
        summary += `S·ªë c√¢u ƒë√∫ng: ${correctAnswers.length}/${results.length}.\n`;
        summary += `C√°c c√¢u l√†m sai: ${wrongAnswers.map(w => w.questionNumber).join(', ')}.\n`;
        
        const prompt = `H√£y ƒë√≥ng vai m·ªôt gi√°o vi√™n t√¢m l√Ω v√† c√≥ chuy√™n m√¥n. D·ª±a v√†o k·∫øt qu·∫£ b√†i ki·ªÉm tra d∆∞·ªõi ƒë√¢y c·ªßa h·ªçc sinh, h√£y vi·∫øt m·ªôt ƒëo·∫°n nh·∫≠n x√©t ng·∫Øn g·ªçn (kho·∫£ng 100-150 t·ª´):
        1. Nh·∫≠n x√©t chung v·ªÅ k·∫øt qu·∫£.
        2. ƒê·ªông vi√™n tinh th·∫ßn h·ªçc sinh.
        3. ƒê∆∞a ra 1-2 l·ªùi khuy√™n h·ªçc t·∫≠p chung d·ª±a tr√™n s·ªë l∆∞·ª£ng c√¢u sai.
        
        Th√¥ng tin k·∫øt qu·∫£:
        ${summary}`;

        try {
            const genAI = new GoogleGenAI({ apiKey: apiKeys.gemini });
            const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });
            const result = await model.generateContent(prompt);
            const response = await result.response;
            const text = response.text();
            
            dom.aiAssessmentContent.innerHTML = text.replace(/\n/g, '<br>');
        } catch (e) {
            console.error("AI Error:", e);
            dom.aiAssessmentContent.textContent = "Kh√¥ng th·ªÉ t·∫£i nh·∫≠n x√©t t·ª´ AI l√∫c n√†y. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi ho·∫∑c API Key.";
        }
    }
    
    </script>
</body>
</html>