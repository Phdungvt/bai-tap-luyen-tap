
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bài kiểm tra - 14/11/2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f5f7; }
        .option.selected { border-color: #3b82f6; background-color: #eff6ff; }
        .option.correct { border-color: #22c55e; background-color: #f0fdf4; }
        .option.incorrect { border-color: #ef4444; background-color: #fef2f2; }
        .disabled { pointer-events: none; opacity: 0.7; }
        .monitoring-warning { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background-color: #ef4444; color: white; padding: 10px 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; display: none; animation: fade-in-out 5s ease-in-out; }
        @keyframes fade-in-out { 0%, 100% { opacity: 0; transform: translate(-50%, -20px); } 10%, 90% { opacity: 1; transform: translate(-50%, 0); } }
        /* MathJax basic styling */
        mjx-container { text-align: left !important; }
    </style>
    <script>
      window.MathJax = {
        tex: { inlineMath: [['$', '$'], ['\(', '\)']], displayMath: [['$$', '$$'], ['\[', '\]']] },
        svg: { fontCache: 'global' }
      };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@google/genai@latest/dist/index.min.js"></script>
</head>
<body class="bg-gray-100">
    <div id="app" class="container mx-auto p-4 max-w-4xl"></div>
    <div id="monitoring-warning-container" class="monitoring-warning">Bạn đã thoát khỏi chế độ toàn màn hình!</div>
    <script type="module">
        import { GoogleGenAI } from "https://cdn.jsdelivr.net/npm/@google/genai@latest/dist/index.min.js";

        const quizData = [{"question":"Cho vectơ $\\vec{a}$ khác vectơ không và số thực $k$. Nếu $k < 0$, thì vectơ $k\\vec{a}$ có mối quan hệ như thế nào về hướng so với vectơ $\\vec{a}$?","options":["Cùng hướng với $\\vec{a}$.","Ngược hướng với $\\vec{a}$.","Vuông góc với $\\vec{a}$.","Không xác định được."],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Cho vectơ $\\vec{a}$ khác vectơ không và số thực $k$. Nếu $k < 0$, thì vectơ $k\\vec{a}$ có mối quan hệ như thế nào về hướng so với vectơ $\\vec{a}$?","rendered_options":["Cùng hướng với $\\vec{a}$.","Ngược hướng với $\\vec{a}$.","Vuông góc với $\\vec{a}$.","Không xác định được."]},{"question":"Cho vectơ $\\vec{a}$ và một số thực $k$. Độ dài của vectơ $k\\vec{a}$ được tính bằng công thức nào sau đây?","options":["$k|\\vec{a}|$.","$-k|\\vec{a}|$.","$|k|\\cdot|\\vec{a}|$.","$k^2|\\vec{a}|$. "],"correctAnswerIndex":2,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Cho vectơ $\\vec{a}$ và một số thực $k$. Độ dài của vectơ $k\\vec{a}$ được tính bằng công thức nào sau đây?","rendered_options":["$k|\\vec{a}|$.","$-k|\\vec{a}|$.","$|k|\\cdot|\\vec{a}|$.","$k^2|\\vec{a}|$. "]},{"question":"Cho vectơ $\\vec{u}$ khác vectơ không. Vectơ $3\\vec{u}$ có mối quan hệ gì về hướng so với vectơ $\\vec{u}$?","options":["Cùng hướng.","Ngược hướng.","Vuông góc.","Không cùng phương."],"correctAnswerIndex":0,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Cho vectơ $\\vec{u}$ khác vectơ không. Vectơ $3\\vec{u}$ có mối quan hệ gì về hướng so với vectơ $\\vec{u}$?","rendered_options":["Cùng hướng.","Ngược hướng.","Vuông góc.","Không cùng phương."]},{"question":"Cho vectơ $\\vec{v}$ khác vectơ không. Vectơ $-5\\vec{v}$ có mối quan hệ gì về hướng so với vectơ $\\vec{v}$?","options":["Cùng hướng.","Ngược hướng.","Vuông góc.","Không cùng phương."],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Cho vectơ $\\vec{v}$ khác vectơ không. Vectơ $-5\\vec{v}$ có mối quan hệ gì về hướng so với vectơ $\\vec{v}$?","rendered_options":["Cùng hướng.","Ngược hướng.","Vuông góc.","Không cùng phương."]},{"question":"Cho vectơ $\\vec{b}$ có độ dài $|\\vec{b}| = 7$. Tính độ dài của vectơ $-2\\vec{b}$.","options":["$14$.","$-14$.","$7$.","$2$. "],"correctAnswerIndex":0,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Cho vectơ $\\vec{b}$ có độ dài $|\\vec{b}| = 7$. Tính độ dài của vectơ $-2\\vec{b}$.","rendered_options":["$14$.","$-14$.","$7$.","$2$. "]}];
        const options = {"title":"Bài kiểm tra - 14/11/2025","timeLimit":45,"retries":1,"showAnswers":true,"showExplanation":true,"aiAssessment":true,"examCode":"QGBSRS","teacherName":"vvvv","scoring":{"mc":5,"tf":2,"sa":2,"essay":1,"tfMethod":"progressive"}};
        const googleScriptUrl = "https://script.google.com/macros/s/AKfycbxV_S0rNHbOQx-hnjjlQGqdvLBN5GlTog0q8erd1XMpPX7XkuGjIxJnDEPPDJQnpGnf9g/exec";
        const apiKey = "AIzaSyAzvr2Py2_mr5Z4R3YWXi-dyO1ufA2paas";
        const app = document.getElementById('app');
        const warningEl = document.getElementById('monitoring-warning-container');
        let ai;
        if (apiKey) {
            try {
                ai = new GoogleGenAI({ apiKey });
            } catch (e) {
                console.error("Lỗi khởi tạo AI:", e);
                ai = null;
            }
        }
        
        const appState = {
            studentName: '',
            studentClass: '',
            currentQuestionIndex: -1,
            userAnswers: [],
            timeLeft: options.timeLimit > 0 ? options.timeLimit * 60 : null,
            timerInterval: null,
            isFinished: false,
            monitoringLog: { thoatManHinh: 0, saoChep: 0, dan: 0 },
            startTime: null,
            retriesLeft: options.retries || 0,
        };

        function showWarning(message) {
            warningEl.textContent = message;
            warningEl.style.display = 'block';
            setTimeout(() => {
                warningEl.style.display = 'none';
            }, 5000);
        }
        
        function handleVisibilityChange() {
            if (document.visibilityState === 'hidden' && !appState.isFinished) {
                appState.monitoringLog.thoatManHinh++;
                showWarning(`Bạn đã thoát khỏi màn hình làm bài ${appState.monitoringLog.thoatManHinh} lần!`);
            }
        }

        function handleCopyPaste(event) {
            if(appState.isFinished) return;
            if(event.type === 'copy') appState.monitoringLog.saoChep++;
            if(event.type === 'paste') appState.monitoringLog.dan++;
        }

        function safeTypeset(elements) {
            if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                window.MathJax.typesetPromise(elements).catch(err => console.error('MathJax error:', err));
            }
        }

        function formatTime(seconds) {
            if (seconds === null) return 'Không giới hạn';
            const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
            const secs = (seconds % 60).toString().padStart(2, '0');
            return `${mins}:${secs}`;
        }
        
        function stopTimer() {
            if (appState.timerInterval) {
                clearInterval(appState.timerInterval);
                appState.timerInterval = null;
            }
        }

        function startTimer() {
            stopTimer();
            if(appState.timeLeft === null) return;
            const timerEl = document.getElementById('timer');
            timerEl.textContent = formatTime(appState.timeLeft);

            appState.timerInterval = setInterval(() => {
                appState.timeLeft--;
                timerEl.textContent = formatTime(appState.timeLeft);
                if (appState.timeLeft <= 0) {
                    stopTimer();
                    alert('Đã hết thời gian làm bài!');
                    submitQuiz();
                }
            }, 1000);
        }

        function renderStartScreen() {
            stopTimer();
            app.innerHTML = `
                <div class="bg-white p-8 rounded-lg shadow-md text-center">
                    <h1 class="text-2xl font-bold mb-2">${options.title}</h1>
                    <p class="text-gray-600">Giáo viên: ${options.teacherName}</p>
                    <p class="text-gray-600">Mã đề: ${options.examCode}</p>
                    <p class="mt-4">Thời gian làm bài: ${options.timeLimit > 0 ? options.timeLimit + ' phút' : 'Không giới hạn'}</p>
                    <p>Số lần làm lại: ${options.retries}</p>
                    <div class="mt-6 text-left max-w-md mx-auto">
                        <div class="mb-4">
                            <label for="student-name" class="block text-sm font-medium text-gray-700">Họ và tên</label>
                            <input type="text" id="student-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="mb-4">
                            <label for="student-class" class="block text-sm font-medium text-gray-700">Lớp</label>
                            <input type="text" id="student-class" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                    <button id="start-btn" class="mt-6 bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition">Bắt đầu làm bài</button>
                </div>
            `;
            document.getElementById('start-btn').addEventListener('click', startQuiz);
        }
        
        function renderQuestionScreen() {
           // ... (full implementation)
        }

        function startQuiz() {
            appState.studentName = document.getElementById('student-name').value.trim();
            appState.studentClass = document.getElementById('student-class').value.trim();
            if (!appState.studentName || !appState.studentClass) {
                alert('Vui lòng nhập đầy đủ Họ tên và Lớp.');
                return;
            }

            appState.currentQuestionIndex = 0;
            appState.userAnswers = new Array(quizData.length).fill(null);
            appState.startTime = new Date();
            appState.isFinished = false;

            // Start monitoring
            document.addEventListener('visibilitychange', handleVisibilityChange);
            document.addEventListener('copy', handleCopyPaste);
            document.addEventListener('paste', handleCopyPaste);
            
            // Fullscreen request
            document.documentElement.requestFullscreen().catch(err => {
                console.warn(`Fullscreen request failed: ${err.message}`);
            });

            renderQuestionScreen();
            startTimer();
        }
        
        async function submitQuiz() {
            // ... (full implementation)
        }
        
        function renderResultScreen(finalScore, totalQuestions, assessmentText) {
            // ... (full implementation)
        }

        // Full implementation of the student-side app logic
        document.addEventListener('DOMContentLoaded', () => {
            renderStartScreen();
        });

    </script>
</body>
</html>