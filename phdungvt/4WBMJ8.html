<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bài kiểm tra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        window.MathJax = {
            tex: { packages: {'[+]': ['ams']}, inlineMath: [['$', '$']], displayMath: [['$$', '$$']] },
            chtml: { fontCache: 'global' }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    <style>
        body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #f0f9ff; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #e2e8f0; }
        .q-header { font-weight: 700; color: #1e40af; margin-bottom: 10px; font-size: 1.1rem; }
        .q-content img { max-width: 100%; height: auto; border-radius: 4px; display: block; margin: 10px auto; }
        .option-item { background-color: #f8fafc; border: 1px solid #cbd5e1; padding: 10px; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; }
        .option-item:hover { background-color: #e0f2fe; border-color: #3b82f6; }
        .option-item.selected { background-color: #dbeafe; border-color: #2563eb; color: #1e40af; font-weight: 500; }
        .true-false-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f1f5f9; align-items: center; }
        .tf-btn { padding: 4px 12px; border-radius: 6px; border: 1px solid #cbd5e1; cursor: pointer; font-size: 0.85rem; margin-left: 5px; }
        .tf-btn.active.true { background-color: #dcfce7; color: #15803d; border-color: #86efac; }
        .tf-btn.active.false { background-color: #fee2e2; color: #b91c1c; border-color: #fca5a5; }
        .short-input { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; outline: none; focus: border-indigo-500; }
        .submit-btn { position: fixed; bottom: 20px; right: 20px; background: #4f46e5; color: white; padding: 12px 24px; border-radius: 50px; font-weight: bold; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.4); cursor: pointer; transition: transform 0.2s; }
        .submit-btn:hover { transform: scale(1.05); }
    </style>
</head>
<body>
    <div class="container">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-slate-800">Bài kiểm tra</h1>
            <p class="text-slate-500 mt-2">Mã đề: 4WBMJ8 • Giáo viên: Giáo viên bộ môn</p>
        </div>
        <div id="quiz-content"></div>
    </div>
    <button class="submit-btn" onclick="submitExam()">Nộp bài</button>

    <script>
        const quizData = JSON.parse(decodeURIComponent(escape(atob("W3sicXVlc3Rpb24iOiJL4bq/dCBxdeG6oyBj4bunYSB2aeG7h2MgYuG7jyBk4bqldSBuZ2/hurdjIHRyb25nIGJp4buDdSB0aOG7qWMgJGEgKyAoYiAtIGMpJCBsw6A6Iiwib3B0aW9ucyI6WyIkYSArIGIgLSBjJCIsIiRhIC0gYiArIGMkIiwiJGEgKyBiICsgYyQiLCIkYSAtIGIgLSBjJCJdLCJjb3JyZWN0QW5zd2VySW5kZXgiOjAsInR5cGUiOiJtdWx0aXBsZS1jaG9pY2UiLCJpc0RpcnR5IjpmYWxzZSwiZXhwbGFuYXRpb24iOm51bGwsInNodWZmbGVPcHRpb25zIjp7InN0ZW0iOnRydWUsImFuc3dlcnMiOnRydWV9LCJzdWJqZWN0IjoidG9hbiIsImdyYWRlIjoiNiIsImNoYXB0ZXIiOiJT4buQIE5HVVnDik4iLCJ0b3BpYyI6IkLDoGkgMTUuIFF1eSB04bqvYyBk4bqldSBuZ2/hurdjIiwiZGlmZmljdWx0eSI6IkJp4bq/dCIsInNjb3JlIjoxLCJxdWVzdGlvbk51bWJlciI6MSwiaWQiOiJxXzE4OTgzMTcwOTQiLCJxdWVzdGlvblNuaXBwZXQiOiJL4bq/dCBxdeG6oyBj4bunYSB2aeG7h2MgYuG7jyBk4bqldSBuZ2/hurdjIHRyb25nIGJp4buDdSB0aOG7qWMgJGEgKyAoYiAtIGMpJCBsw6A6In0seyJxdWVzdGlvbiI6IlNhdSBraGkgYuG7jyBk4bqldSBuZ2/hurdjLCBiaeG7g3UgdGjhu6ljICR4IC0gKHkgKyB6KSQgdHLhu58gdGjDoG5oOiIsIm9wdGlvbnMiOlsiJHggLSB5ICsgeiQiLCIkeCArIHkgKyB6JCIsIiR4IC0geSAtIHokIiwiJHggKyB5IC0geiQiXSwiY29ycmVjdEFuc3dlckluZGV4IjoyLCJ0eXBlIjoibXVsdGlwbGUtY2hvaWNlIiwiaXNEaXJ0eSI6ZmFsc2UsImV4cGxhbmF0aW9uIjpudWxsLCJzaHVmZmxlT3B0aW9ucyI6eyJzdGVtIjp0cnVlLCJhbnN3ZXJzIjp0cnVlfSwic3ViamVjdCI6InRvYW4iLCJncmFkZSI6IjYiLCJjaGFwdGVyIjoiU+G7kCBOR1VZw4pOIiwidG9waWMiOiJCw6BpIDE1LiBRdXkgdOG6r2MgZOG6pXUgbmdv4bq3YyIsImRpZmZpY3VsdHkiOiJCaeG6v3QiLCJzY29yZSI6MSwicXVlc3Rpb25OdW1iZXIiOjIsImlkIjoicV82NDkzODY2NDciLCJxdWVzdGlvblNuaXBwZXQiOiJTYXUga2hpIGLhu48gZOG6pXUgbmdv4bq3YywgYmnhu4N1IHRo4bupYyAkeCAtICh5ICsgeikkIHRy4bufIHRow6BuaDoifSx7InF1ZXN0aW9uIjoiS2hpIGLhu48gZOG6pXUgbmdv4bq3YyBj4bunYSBiaeG7g3UgdGjhu6ljICQxNSAtICgtMyArIDcpJCwgdGEgdGh1IMSRxrDhu6NjIGJp4buDdSB0aOG7qWMgbsOgbyBzYXUgxJHDonk/Iiwib3B0aW9ucyI6WyIkMTUgLSAzICsgNyQiLCIkMTUgKyAzICsgNyQiLCIkMTUgKyAzIC0gNyQiLCIkMTUgLSAzIC0gNyQiXSwiY29ycmVjdEFuc3dlckluZGV4IjoyLCJ0eXBlIjoibXVsdGlwbGUtY2hvaWNlIiwiaXNEaXJ0eSI6ZmFsc2UsImV4cGxhbmF0aW9uIjpudWxsLCJzaHVmZmxlT3B0aW9ucyI6eyJzdGVtIjp0cnVlLCJhbnN3ZXJzIjp0cnVlfSwic3ViamVjdCI6InRvYW4iLCJncmFkZSI6IjYiLCJjaGFwdGVyIjoiU+G7kCBOR1VZw4pOIiwidG9waWMiOiJCw6BpIDE1LiBRdXkgdOG6r2MgZOG6pXUgbmdv4bq3YyIsImRpZmZpY3VsdHkiOiJCaeG6v3QiLCJzY29yZSI6MSwicXVlc3Rpb25OdW1iZXIiOjMsImlkIjoicV82MjU1OTc0MDYiLCJxdWVzdGlvblNuaXBwZXQiOiJLaGkgYuG7jyBk4bqldSBuZ2/hurdjIGPhu6dhIGJp4buDdSB0aOG7qWMgJDE1IC0gKC0zICsgNykkLCB0YSB0aHUgxJHGsOG7o2MgYmnhu4N1IHRo4bupYyAuLi4ifSx7InF1ZXN0aW9uIjoiQ2hvIGJp4buDdSB0aOG7qWMgJEEgPSAobSAtIG4pIC0gKHAgLSBxKSQuIFNhdSBraGkgdGjhu7FjIGhp4buHbiBxdXkgdOG6r2MgYuG7jyBk4bqldSBuZ2/hurdjLCBiaeG7g3UgdGjhu6ljICRBJCBi4bqxbmc6Iiwib3B0aW9ucyI6WyIkbSAtIG4gLSBwIC0gcSQiLCIkbSAtIG4gLSBwICsgcSQiLCIkbSArIG4gLSBwICsgcSQiLCIkbSAtIG4gKyBwIC0gcSQiXSwiY29ycmVjdEFuc3dlckluZGV4IjoxLCJ0eXBlIjoibXVsdGlwbGUtY2hvaWNlIiwiaXNEaXJ0eSI6ZmFsc2UsImV4cGxhbmF0aW9uIjpudWxsLCJzaHVmZmxlT3B0aW9ucyI6eyJzdGVtIjp0cnVlLCJhbnN3ZXJzIjp0cnVlfSwic3ViamVjdCI6InRvYW4iLCJncmFkZSI6IjYiLCJjaGFwdGVyIjoiU+G7kCBOR1VZw4pOIiwidG9waWMiOiJCw6BpIDE1LiBRdXkgdOG6r2MgZOG6pXUgbmdv4bq3YyIsImRpZmZpY3VsdHkiOiJCaeG6v3QiLCJzY29yZSI6MSwicXVlc3Rpb25OdW1iZXIiOjQsImlkIjoicV8xNzM0Njk5Mjc4IiwicXVlc3Rpb25TbmlwcGV0IjoiQ2hvIGJp4buDdSB0aOG7qWMgJEEgPSAobSAtIG4pIC0gKHAgLSBxKSQuIFNhdSBraGkgdGjhu7FjIGhp4buHbiBxdXkgdOG6r2MgYuG7jyBk4bqlLi4uIn0seyJxdWVzdGlvbiI6IlBow6F0IGJp4buDdSBuw6BvIHNhdSDEkcOieSDEkcO6bmcgduG7gSBxdXkgdOG6r2MgZOG6pXUgbmdv4bq3Yz8iLCJvcHRpb25zIjpbIktoaSBi4buPIGThuqV1IG5nb+G6t2MgY8OzIGThuqV1ICQrJCDEkeG6sW5nIHRyxrDhu5tjLCB0YSBwaOG6o2kgxJHhu5VpIGThuqV1IHThuqV0IGPhuqMgc+G7kSBo4bqhbmcgdHJvbmcgbmdv4bq3Yy4iLCJLaGkgYuG7jyBk4bqldSBuZ2/hurdjIGPDsyBk4bqldSAkLSQgxJHhurFuZyB0csaw4bubYywgdGEgZ2nhu68gbmd1ecOqbiBk4bqldSBjw6FjIHPhu5EgaOG6oW5nIHRyb25nIG5nb+G6t2MuIiwiS2hpIGLhu48gZOG6pXUgbmdv4bq3YyBjw7MgZOG6pXUgJC0kIMSR4bqxbmcgdHLGsOG7m2MsIHRhIHBo4bqjaSDEkeG7lWkgZOG6pXUgdOG6pXQgY+G6oyBz4buRIGjhuqFuZyB0cm9uZyBuZ2/hurdjLiIsIktoaSBi4buPIGThuqV1IG5nb+G6t2MgY8OzIGThuqV1ICQrJCDEkeG6sW5nIHRyxrDhu5tjLCB0YSBwaOG6o2kgxJHhu5VpIGThuqV1IHPhu5EgaOG6oW5nIMSR4bqndSB0acOqbi4iXSwiY29ycmVjdEFuc3dlckluZGV4IjoyLCJ0eXBlIjoibXVsdGlwbGUtY2hvaWNlIiwiaXNEaXJ0eSI6ZmFsc2UsImV4cGxhbmF0aW9uIjpudWxsLCJzaHVmZmxlT3B0aW9ucyI6eyJzdGVtIjp0cnVlLCJhbnN3ZXJzIjp0cnVlfSwic3ViamVjdCI6InRvYW4iLCJncmFkZSI6IjYiLCJjaGFwdGVyIjoiU+G7kCBOR1VZw4pOIiwidG9waWMiOiJCw6BpIDE1LiBRdXkgdOG6r2MgZOG6pXUgbmdv4bq3YyIsImRpZmZpY3VsdHkiOiJCaeG6v3QiLCJzY29yZSI6MSwicXVlc3Rpb25OdW1iZXIiOjUsImlkIjoicV8xNzI3MjIzNTMwIiwicXVlc3Rpb25TbmlwcGV0IjoiUGjDoXQgYmnhu4N1IG7DoG8gc2F1IMSRw6J5IMSRw7puZyB24buBIHF1eSB04bqvYyBk4bqldSBuZ2/hurdjPyJ9XQ=="))));
        const examCode = "4WBMJ8";
        const GOOGLE_SCRIPT_URL = "";
        
        function renderExam() {
            const container = document.getElementById('quiz-content');
            quizData.forEach((q, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                let html = '<div class="q-header">Câu ' + (index + 1) + '</div>';
                
                // Question Content
                const qText = (q.type.includes('true-false') ? q.main_question : q.question) || '';
                html += '<div class="q-content mb-4 text-gray-700">' + qText + '</div>';

                // Input Area
                if (q.type === 'multiple-choice') {
                    html += '<div class="space-y-2">';
                    q.options.forEach((opt, i) => {
                        html += '<div class="option-item" onclick="selectOption(this, ' + index + ', ' + i + ')"><span class="font-bold mr-2">' + String.fromCharCode(65+i) + '.</span> ' + opt + '</div>';
                    });
                    html += '</div>';
                } else if (q.type === 'true-false') {
                    q.statements.forEach((stmt, i) => {
                        html += '<div class="true-false-row"><div class="flex-1 mr-4"><strong>' + String.fromCharCode(97+i) + ')</strong> ' + stmt.statement + '</div><div class="flex gap-2 shrink-0"><button class="tf-btn" onclick="selectTF(this, ' + index + ', ' + i + ', true)">Đúng</button><button class="tf-btn" onclick="selectTF(this, ' + index + ', ' + i + ', false)">Sai</button></div></div>';
                    });
                } else {
                    html += '<textarea class="short-input" rows="3" placeholder="Nhập câu trả lời của bạn..." onchange="saveAnswer(' + index + ', this.value)"></textarea>';
                }
                
                card.innerHTML = html;
                container.appendChild(card);
            });
            
            // Re-render MathJax after inserting content
            if (window.MathJax && MathJax.typesetPromise) {
                MathJax.typesetPromise([container]);
            }
        }

        const userAnswers = {};

        function selectOption(el, qIdx, optIdx) {
            const parent = el.parentElement;
            parent.querySelectorAll('.option-item').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            userAnswers[qIdx] = optIdx;
        }

        function selectTF(el, qIdx, sIdx, val) {
            const parent = el.parentElement;
            parent.querySelectorAll('.tf-btn').forEach(e => e.classList.remove('active', 'true', 'false'));
            el.classList.add('active', val ? 'true' : 'false');
            if (!userAnswers[qIdx]) userAnswers[qIdx] = {};
            userAnswers[qIdx][sIdx] = val;
        }

        function saveAnswer(qIdx, val) {
            userAnswers[qIdx] = val;
        }

        function submitExam() {
            if (!confirm('Bạn có chắc chắn muốn nộp bài?')) return;
            const name = prompt('Vui lòng nhập Họ và Tên của bạn:');
            if (!name) return;
            const studentClass = prompt('Vui lòng nhập Lớp:');
            if (!studentClass) return;

            // Simple grading logic (Client-side for immediate feedback, secure grading should be server-side)
            let score = 0;
            let totalScore = 0;
            const details = [];

            quizData.forEach((q, idx) => {
                 let qScore = 0;
                 let maxQScore = q.score || 0; // Use assigned score from system
                 if (maxQScore === 0) maxQScore = 1; // Fallback
                 totalScore += maxQScore;
                 
                 const ans = userAnswers[idx];
                 let isCorrect = false;

                 if (q.type === 'multiple-choice') {
                     if (ans === q.correctAnswerIndex) {
                         qScore = maxQScore;
                         isCorrect = true;
                     }
                 } else if (q.type === 'true-false') {
                     // Partial credit logic
                     let correctCount = 0;
                     q.statements.forEach((s, i) => {
                         if (ans && ans[i] === s.is_correct) correctCount++;
                     });
                     // Sample logic: 1->0.1, 2->0.25, 3->0.5, 4->1.0 * maxQScore
                     const ratios = [0, 0.1, 0.25, 0.5, 1.0];
                     qScore = ratios[correctCount] * maxQScore;
                     if (correctCount === 4) isCorrect = true;
                 } else {
                     // Manual grading for text
                     qScore = 0; 
                 }
                 
                 score += qScore;
                 details.push({ id: q.id, type: q.type, score: qScore, isCorrect });
            });
            
            // Send to Google Sheet
            const payload = {
                action: 'submit',
                timestamp: new Date().toISOString(),
                name: name,
                class: studentClass,
                score: score.toFixed(2),
                examCode: examCode,
                answerSummary: details.map((d, i) => 'C' + (i+1) + ':' + (d.isCorrect ? 'Đ' : 'S')).join('; '),
                assessment: score >= 5 ? 'Đạt' : 'Chưa đạt',
                answerDetails: JSON.stringify(details)
            };

            // Post to GAS
            if (GOOGLE_SCRIPT_URL) {
                 fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                }).then(() => {
                    alert('Nộp bài thành công! Điểm số của bạn: ' + score.toFixed(2));
                }).catch(err => {
                    alert('Lỗi kết nối. Vui lòng thử lại.');
                });
            } else {
                alert('Nộp bài thành công (Mô phỏng)! Điểm: ' + score.toFixed(2));
            }
        }

        renderExam();
        
        // Additional check to trigger MathJax if the script runs before MathJax loads
        document.addEventListener('DOMContentLoaded', () => {
             if (window.MathJax && MathJax.typesetPromise) {
                MathJax.typesetPromise();
             }
        });
    </script>
</body>
</html>