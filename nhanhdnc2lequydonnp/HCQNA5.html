
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đề Kiểm tra Tin học 45 phút</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%); min-height: 100vh; }
        .option { transition: all 0.2s ease; }
        .option:hover { background-color: #f3f4f6; }
        .option.selected { border-color: #4f46e5; background-color: #eef2ff; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2); }
        .option.correct { border-color: #22c55e; background-color: #f0fdf4; }
        .option.incorrect { border-color: #ef4444; background-color: #fef2f2; }
        .disabled { pointer-events: none; opacity: 0.7; }
        .monitoring-warning { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: #ef4444; color: white; padding: 12px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 1000; display: none; font-weight: bold; animation: fade-in-out 5s ease-in-out; }
        @keyframes fade-in-out { 0%, 100% { opacity: 0; transform: translate(-50%, -20px); } 10%, 90% { opacity: 1; transform: translate(-50%, 0); } }
        /* MathJax basic styling */
        mjx-container { display: inline-block !important; }
        .prose img.latex-image { display: inline-block; vertical-align: middle; }
        
        /* Progress Bar */
        .progress-container { position: fixed; top: 0; left: 0; width: 100%; height: 4px; background: #e5e7eb; z-index: 50; }
        .progress-bar { height: 100%; background: #4f46e5; transition: width 0.3s; width: 0%; }

        /* Navigation Panel */
        .nav-panel {
            position: fixed; right: 0; top: 0; bottom: 0; width: 280px;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            box-shadow: -4px 0 15px rgba(0,0,0,0.05);
            z-index: 40; overflow-y: auto; padding-top: 60px;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .nav-panel.open { transform: translateX(0); }
        .nav-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; padding: 16px; }
        .nav-btn {
            width: 40px; height: 40px; border-radius: 8px; border: 1px solid #e5e7eb;
            background: white; color: #4b5563; font-size: 14px; font-weight: 600;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .nav-btn:hover { border-color: #6366f1; color: #6366f1; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .nav-btn.answered { background-color: #6366f1; color: white; border-color: #6366f1; }
        .nav-btn.current { border-color: #f59e0b; color: #f59e0b; border-width: 2px; background-color: #fffbeb; }

        /* Layout Adjustment for Nav Panel */
        #app { transition: margin-right 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        body.nav-open #app { margin-right: 280px; }
        
        @media (max-width: 1024px) {
            body.nav-open #app { margin-right: 0; } /* On mobile, nav covers content */
        }

        #toggle-nav-btn {
            position: fixed; right: 24px; bottom: 24px; width: 56px; height: 56px;
            background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; border-radius: 50%;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
            display: flex; align-items: center; justify-content: center;
            z-index: 50; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
        }
        #toggle-nav-btn:hover { transform: scale(1.05); box-shadow: 0 6px 16px rgba(79, 70, 229, 0.5); }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        .question-card { transition: box-shadow 0.3s; }
        .question-card:hover { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.01); }
    </style>
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$']], displayMath: [['$$', '$$']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    <script type="importmap">
    { "imports": { 
        "@google/genai": "https://esm.sh/@google/genai@^1.13.0",
        "canvas-confetti": "https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/+esm"
    } }
    </script>
</head>
<body class="p-4 md:p-6">
    <div id="progress-container" class="progress-container hidden"><div id="progress-bar" class="progress-bar"></div></div>
    
    <button id="toggle-nav-btn" class="hidden" title="Danh sách câu hỏi">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" />
        </svg>
    </button>

    <div id="nav-panel" class="nav-panel">
        <div class="px-4 py-3 border-b bg-gray-50 sticky top-0 z-10">
            <h3 class="font-bold text-gray-800 text-lg">Danh sách câu hỏi</h3>
            <div class="flex items-center gap-4 mt-3 text-sm text-gray-600">
                <div class="flex items-center gap-1.5"><div class="w-3 h-3 border rounded bg-white"></div> Chưa làm</div>
                <div class="flex items-center gap-1.5"><div class="w-3 h-3 rounded bg-indigo-500"></div> Đã làm</div>
            </div>
        </div>
        <div id="nav-grid" class="nav-grid pb-20"></div>
    </div>

    <div id="app" class="max-w-5xl mx-auto transition-all duration-300">
        
        <div id="welcome-screen" class="bg-white rounded-2xl shadow-xl overflow-hidden max-w-2xl mx-auto mt-10">
            <div class="bg-gradient-to-r from-indigo-600 to-violet-600 p-8 text-center text-white relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9IiNmZmYiLz48L3N2Zz4=')]"></div>
                <h1 class="text-2xl md:text-3xl font-bold mb-2 relative z-10">Đề Kiểm tra Tin học 45 phút</h1>
                <p class="text-indigo-100 text-sm md:text-base relative z-10">Mã đề: <span class="font-mono font-bold bg-white/20 px-2 py-1 rounded text-white">HCQNA5</span></p>
                 <div class="mt-4 inline-flex items-center bg-white/10 backdrop-blur-sm px-4 py-2 rounded-full relative z-10">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd" />
                    </svg>
                    <span>Giáo viên: <span class="font-bold text-yellow-300">Đàng Năng Nhanh</span></span>
                </div>
            </div>
            <div class="p-8">
                <div class="space-y-5">
                    <div>
                        <label for="name" class="block text-sm font-semibold text-gray-700 mb-1">Họ và tên học sinh</label>
                        <input type="text" id="name" class="w-full border-gray-300 rounded-lg shadow-sm py-3 px-4 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all text-gray-800 placeholder-gray-400" placeholder="Nhập họ tên của bạn...">
                    </div>
                    <div>
                        <label for="class" class="block text-sm font-semibold text-gray-700 mb-1">Lớp</label>
                        <input type="text" id="class" class="w-full border-gray-300 rounded-lg shadow-sm py-3 px-4 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all text-gray-800 placeholder-gray-400" placeholder="Ví dụ: 12A1">
                    </div>
                    
                    <!-- API Key Input for Students -->
                    <div id="api-key-input-container" class="hidden mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <label class="block text-sm font-semibold text-blue-800 mb-2">
                            Gemini API Key <span class="font-normal text-gray-600">(Yêu cầu để xem lời giải/nhận xét AI)</span>
                        </label>
                        <div class="flex gap-2">
                            <input type="password" id="student-api-key" class="flex-grow border-gray-300 rounded-lg shadow-sm py-2 px-3 text-sm focus:ring-blue-500 focus:border-blue-500 placeholder-gray-400" placeholder="Nhập API Key của bạn (bắt đầu bằng AIza...)">
                            <a href="https://aistudio.google.com/app/apikey" target="_blank" class="flex-shrink-0 bg-white text-blue-600 border border-blue-300 hover:bg-blue-50 font-semibold py-2 px-4 rounded-lg text-sm flex items-center transition-colors whitespace-nowrap">
                                Lấy Key miễn phí
                            </a>
                        </div>
                         <p class="text-xs text-gray-500 mt-2">
                            * Sử dụng Key cá nhân giúp bạn trải nghiệm đầy đủ các tính năng AI mà không bị gián đoạn.
                        </p>
                    </div>
                </div>
                 <div class="mt-6 bg-amber-50 border-l-4 border-amber-400 p-4 rounded-r-lg">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-amber-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-amber-700">
                                <span class="font-bold">Lưu ý:</span> Hệ thống sẽ giám sát việc chuyển tab, sao chép/dán. Các hành vi này sẽ được ghi lại và báo cáo cho giáo viên.
                            </p>
                        </div>
                    </div>
                </div>
                <button id="start-btn" class="mt-8 w-full bg-gradient-to-r from-indigo-600 to-violet-600 text-white py-3.5 px-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl hover:translate-y-[-2px] transition-all flex items-center justify-center gap-2">
                    <span>Bắt đầu làm bài</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>

        <div id="quiz-screen" class="hidden">
             <div class="sticky top-0 z-30 -mx-4 md:-mx-6 mb-6">
                 <div class="bg-white/90 backdrop-blur-md shadow-md border-b border-gray-200 py-3 px-4 md:px-8 flex justify-between items-center">
                    <div>
                         <h2 class="text-lg md:text-xl font-bold text-gray-800 truncate max-w-[200px] md:max-w-md">Đề Kiểm tra Tin học 45 phút</h2>
                         <p class="text-xs text-gray-500 hidden md:block">Thí sinh: <span id="student-name-display" class="font-semibold"></span></p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div id="timer" class="text-lg md:text-xl font-mono font-bold text-red-600 bg-red-50 px-3 py-1.5 rounded-lg border border-red-100 min-w-[80px] text-center shadow-sm"></div>
                        <button id="submit-btn-top" class="md:hidden bg-green-600 text-white px-3 py-1.5 rounded-lg text-sm font-semibold shadow-sm">Nộp</button>
                    </div>
                 </div>
            </div>
            
            <div id="all-questions-container" class="space-y-6 pb-10"></div>
            
            <div class="mt-8 flex justify-end sticky bottom-4 z-20">
                <div class="bg-white/80 backdrop-blur p-2 rounded-2xl shadow-lg border border-gray-100">
                    <button id="submit-btn" class="bg-gradient-to-r from-emerald-500 to-green-600 text-white py-3 px-8 rounded-xl font-bold text-lg shadow-md hover:shadow-lg hover:from-emerald-600 hover:to-green-700 transition-all flex items-center gap-2">
                        <span>Nộp bài</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div id="results-screen" class="hidden max-w-3xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="bg-gradient-to-r from-blue-500 to-cyan-500 p-8 text-center text-white">
                <h2 class="text-3xl font-bold mb-2">Kết quả bài làm</h2>
                <p class="opacity-90">Chúc mừng bạn đã hoàn thành bài thi!</p>
            </div>
            <div class="p-8">
                <div id="score-display" class="hidden flex flex-col items-center justify-center my-4">
                    <span class="text-gray-500 text-lg uppercase tracking-widest font-semibold mb-2">Tổng điểm</span>
                    <span class="text-6xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-br from-blue-600 to-cyan-500 drop-shadow-sm"></span>
                </div>
                
                <div id="assessment-display" class="hidden mt-6 p-6 bg-indigo-50 border border-indigo-100 rounded-xl text-gray-700 shadow-inner relative">
                     <div class="absolute top-0 left-0 w-1 h-full bg-indigo-400 rounded-l-xl"></div>
                     <h3 class="font-bold text-indigo-800 mb-2 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z" />
                            <path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z" />
                        </svg>
                        Nhận xét từ AI Giáo viên
                     </h3>
                     <div class="assessment-content prose prose-indigo max-w-none"></div>
                </div>

                <div id="review-container" class="mt-10 border-t pt-8"></div>
                
                <div class="mt-10 flex flex-col sm:flex-row justify-center gap-4">
                    <button id="retry-btn" class="hidden bg-white text-indigo-600 border-2 border-indigo-600 py-3 px-6 rounded-xl font-bold hover:bg-indigo-50 transition-colors">Làm lại bài</button>
                    <button id="restart-btn" class="bg-gray-800 text-white py-3 px-6 rounded-xl font-bold hover:bg-gray-900 transition-colors shadow-md">Về trang chủ</button>
                </div>
            </div>
        </div>
        
        <div id="monitoring-warning" class="monitoring-warning">⚠️ Đã phát hiện hành vi không hợp lệ!</div>
    </div>

    <script type="module">
        import { GoogleGenAI } from "@google/genai";
        import confetti from "https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/+esm";

        // Decode keys at runtime to bypass GitHub secret scanning
        const _k = {"gemini":"QUl6YVN5QXlSYm90bGw2LXJUTnI0LXpsNWR6SjFRMnhGb2J0aVhz","openai":"c2stcHJvai1OZW1Nd2l4RG95N1N1cEVJeXo5SDl4V2pRWmVjeFNSU1pTRnNmX3VyQ3pGOTF0WmVkMXF6eV9GckhzeUxDb3lkMGs0VXdUazRNcVQzQmxia0ZKVjNrSi1oaEY0eXZ4SGZ4M29pV1RkTkFaUUoxYlE4a1I2UlNYX0pNRW5rRUI3VmxuWWVUakZzZGF2aS1KM3NCT1pVTjFQVl8xWUE=","deepseek":""};
        const API_KEYS = {
            gemini: atob(_k.gemini),
            openai: atob(_k.openai),
            deepseek: atob(_k.deepseek)
        };
        
        let quizData = [{"question":"Khi sao chép công thức từ ô $A1$ chứa công thức $=B1+C1$ sang ô $A2$, công thức trong ô $A2$ sẽ tự động thay đổi thành gì?","options":["$=B1+C1$","$=B2+C2$","$=B1+C2$","$=B2+C1$"],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Khi sao chép công thức từ ô $A1$ chứa công thức $=B1+C1$ sang ô $A2$, công thức trong ô $A2$ sẽ tự động thay đổi thành gì?","rendered_options":["$=B1+C1$","$=B2+C2$","$=B1+C2$","$=B2+C1$"]},{"question":"Mục đích chính của việc sử dụng địa chỉ tuyệt đối của một ô tính trong công thức (ví dụ: $A$1 hoặc $A$$1) là gì?","options":["Giúp công thức tự động thay đổi tham chiếu khi sao chép đến vị trí khác.","Giữ nguyên tham chiếu đến một ô cụ thể dù công thức được sao chép đến bất kỳ đâu.","Rút ngắn độ dài của công thức.","Tăng tốc độ tính toán của bảng tính."],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Mục đích chính của việc sử dụng địa chỉ tuyệt đối của một ô tính trong công thức (ví dụ: $A$1 hoặc $A$$1) là gì?","rendered_options":["Giúp công thức tự động thay đổi tham chiếu khi sao chép đến vị trí khác.","Giữ nguyên tham chiếu đến một ô cụ thể dù công thức được sao chép đến bất kỳ đâu.","Rút ngắn độ dài của công thức.","Tăng tốc độ tính toán của bảng tính."]},{"question":"Trong phần mềm bảng tính, địa chỉ tuyệt đối của một ô tính được sử dụng với mục đích chính nào?","options":["Giữ nguyên tham chiếu ô khi công thức được sao chép.","Tự động điều chỉnh tham chiếu ô khi công thức được sao chép.","Thay đổi màu nền của ô tính.","Chuyển đổi định dạng dữ liệu trong ô."],"correctAnswerIndex":0,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Trong phần mềm bảng tính, địa chỉ tuyệt đối của một ô tính được sử dụng với mục đích chính nào?","rendered_options":["Giữ nguyên tham chiếu ô khi công thức được sao chép.","Tự động điều chỉnh tham chiếu ô khi công thức được sao chép.","Thay đổi màu nền của ô tính.","Chuyển đổi định dạng dữ liệu trong ô."]},{"question":"Trong phần mềm bảng tính, kí hiệu nào được sử dụng để cố định tham chiếu đến một ô (tức là tạo địa chỉ tuyệt đối) khi sao chép công thức?","options":["$","#","&","@"],"correctAnswerIndex":0,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Trong phần mềm bảng tính, kí hiệu nào được sử dụng để cố định tham chiếu đến một ô (tức là tạo địa chỉ tuyệt đối) khi sao chép công thức?","rendered_options":["$","#","&","@"]},{"question":"Trong phần mềm bảng tính, khi sao chép công thức \"=A1+B1\" từ ô C1 sang ô D2, công thức tại ô D2 sẽ tự động thay đổi thành gì?","options":["=B2+C2","=A1+B1","=A2+B2","=A1+C1"],"correctAnswerIndex":0,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Trong phần mềm bảng tính, khi sao chép công thức \"=A1+B1\" từ ô C1 sang ô D2, công thức tại ô D2 sẽ tự động thay đổi thành gì?","rendered_options":["=B2+C2","=A1+B1","=A2+B2","=A1+C1"]},{"question":"Trong phần mềm bảng tính, nếu bạn muốn địa chỉ ô A1 được giữ cố định (không thay đổi) khi công thức chứa nó được sao chép sang các ô khác, bạn sẽ sử dụng cú pháp nào?","options":["$A$1","A1","$A1","A$1"],"correctAnswerIndex":0,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Trong phần mềm bảng tính, nếu bạn muốn địa chỉ ô A1 được giữ cố định (không thay đổi) khi công thức chứa nó được sao chép sang các ô khác, bạn sẽ sử dụng cú pháp nào?","rendered_options":["$A$1","A1","$A1","A$1"]},{"question":"Trong một bảng tính, khi bạn sao chép công thức `=A1+B$2` từ ô C1 sang ô C2, công thức ở ô C2 sẽ trở thành gì?","options":["=`A2+B$2`","=`A1+B$2`","=`A2+B2`","=`A1+B3`"],"correctAnswerIndex":0,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Trong một bảng tính, khi bạn sao chép công thức `=A1+B$2` từ ô C1 sang ô C2, công thức ở ô C2 sẽ trở thành gì?","rendered_options":["=`A2+B$2`","=`A1+B$2`","=`A2+B2`","=`A1+B3`"]},{"question":"Trong phần mềm bảng tính, phát biểu nào sau đây giải thích đúng nhất sự thay đổi địa chỉ tương đối trong công thức khi sao chép công thức sang một ô khác?","options":["Địa chỉ tương đối sẽ tự động điều chỉnh để tham chiếu đến các ô mới có cùng vị trí tương đối với ô chứa công thức gốc.","Địa chỉ tương đối sẽ giữ nguyên không thay đổi khi sao chép công thức đến bất kỳ đâu.","Địa chỉ tương đối sẽ tự động thay đổi thành địa chỉ tuyệt đối khi sao chép công thức.","Địa chỉ tương đối chỉ thay đổi khi sao chép sang một cột khác, không thay đổi khi sao chép sang một hàng khác."],"correctAnswerIndex":0,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Trong phần mềm bảng tính, phát biểu nào sau đây giải thích đúng nhất sự thay đổi địa chỉ tương đối trong công thức khi sao chép công thức sang một ô khác?","rendered_options":["Địa chỉ tương đối sẽ tự động điều chỉnh để tham chiếu đến các ô mới có cùng vị trí tương đối với ô chứa công thức gốc.","Địa chỉ tương đối sẽ giữ nguyên không thay đổi khi sao chép công thức đến bất kỳ đâu.","Địa chỉ tương đối sẽ tự động thay đổi thành địa chỉ tuyệt đối khi sao chép công thức.","Địa chỉ tương đối chỉ thay đổi khi sao chép sang một cột khác, không thay đổi khi sao chép sang một hàng khác."]},{"question":"Trong phần mềm bảng tính, khi em muốn sắp xếp danh sách học sinh theo thứ tự tăng dần của điểm trung bình môn Tin học, em sẽ sử dụng chức năng nào?","options":["Sắp xếp dữ liệu","Lọc dữ liệu","Định dạng dữ liệu","Tìm kiếm dữ liệu"],"correctAnswerIndex":0,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Trong phần mềm bảng tính, khi em muốn sắp xếp danh sách học sinh theo thứ tự tăng dần của điểm trung bình môn Tin học, em sẽ sử dụng chức năng nào?","rendered_options":["Sắp xếp dữ liệu","Lọc dữ liệu","Định dạng dữ liệu","Tìm kiếm dữ liệu"]},{"question":"Bạn An có một bảng dữ liệu về các sản phẩm và muốn chỉ hiển thị những sản phẩm có giá trên 100.000 đồng. Chức năng nào trong phần mềm bảng tính sẽ giúp An thực hiện điều này?","options":["Sắp xếp dữ liệu","Lọc dữ liệu","Tạo biểu đồ","Tính tổng tự động"],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Bạn An có một bảng dữ liệu về các sản phẩm và muốn chỉ hiển thị những sản phẩm có giá trên 100.000 đồng. Chức năng nào trong phần mềm bảng tính sẽ giúp An thực hiện điều này?","rendered_options":["Sắp xếp dữ liệu","Lọc dữ liệu","Tạo biểu đồ","Tính tổng tự động"]},{"question":"Mục đích chính của việc sắp xếp dữ liệu trong phần mềm bảng tính là gì?","options":["Ẩn đi các dữ liệu không cần thiết","Sắp xếp dữ liệu theo một thứ tự nhất định để dễ dàng quan sát và phân tích","Thay đổi màu sắc của các ô dữ liệu","Thực hiện các phép tính toán học phức tạp"],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Mục đích chính của việc sắp xếp dữ liệu trong phần mềm bảng tính là gì?","rendered_options":["Ẩn đi các dữ liệu không cần thiết","Sắp xếp dữ liệu theo một thứ tự nhất định để dễ dàng quan sát và phân tích","Thay đổi màu sắc của các ô dữ liệu","Thực hiện các phép tính toán học phức tạp"]},{"question":"Chức năng lọc dữ liệu trong phần mềm bảng tính giúp người dùng làm gì?","options":["Thay đổi thứ tự các hàng trong bảng","Tìm kiếm và chỉ hiển thị các hàng dữ liệu thỏa mãn một tiêu chí nhất định","Định dạng lại toàn bộ bảng dữ liệu","Tạo ra một bảng dữ liệu mới từ đầu"],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Chức năng lọc dữ liệu trong phần mềm bảng tính giúp người dùng làm gì?","rendered_options":["Thay đổi thứ tự các hàng trong bảng","Tìm kiếm và chỉ hiển thị các hàng dữ liệu thỏa mãn một tiêu chí nhất định","Định dạng lại toàn bộ bảng dữ liệu","Tạo ra một bảng dữ liệu mới từ đầu"]},{"question":"Tình huống nào sau đây cần sử dụng chức năng sắp xếp dữ liệu trong phần mềm bảng tính?","options":["Tìm kiếm tất cả các học sinh có điểm môn Tin học trên 8.","Hiển thị danh sách học sinh theo thứ tự tăng dần của tên.","Ẩn đi các hàng chứa thông tin không liên quan.","Tính tổng điểm của tất cả học sinh trong lớp."],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Tình huống nào sau đây cần sử dụng chức năng sắp xếp dữ liệu trong phần mềm bảng tính?","rendered_options":["Tìm kiếm tất cả các học sinh có điểm môn Tin học trên 8.","Hiển thị danh sách học sinh theo thứ tự tăng dần của tên.","Ẩn đi các hàng chứa thông tin không liên quan.","Tính tổng điểm của tất cả học sinh trong lớp."]},{"question":"Bạn cần tìm và chỉ hiển thị các sản phẩm còn số lượng tồn kho lớn hơn 0 trong một bảng dữ liệu về cửa hàng. Chức năng nào trong phần mềm bảng tính sẽ giúp bạn thực hiện điều này một cách hiệu quả nhất?","options":["Sắp xếp dữ liệu.","Định dạng có điều kiện.","Lọc dữ liệu.","Sử dụng công thức tính toán."],"correctAnswerIndex":2,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Bạn cần tìm và chỉ hiển thị các sản phẩm còn số lượng tồn kho lớn hơn 0 trong một bảng dữ liệu về cửa hàng. Chức năng nào trong phần mềm bảng tính sẽ giúp bạn thực hiện điều này một cách hiệu quả nhất?","rendered_options":["Sắp xếp dữ liệu.","Định dạng có điều kiện.","Lọc dữ liệu.","Sử dụng công thức tính toán."]},{"question":"Khi bạn sắp xếp một cột dữ liệu trong bảng tính theo thứ tự giảm dần, điều gì sẽ xảy ra?","options":["Các hàng dữ liệu không liên quan sẽ bị ẩn đi.","Thứ tự các hàng trong bảng sẽ thay đổi để dữ liệu trong cột đó được sắp xếp từ giá trị lớn nhất đến nhỏ nhất.","Chỉ các giá trị trùng lặp trong cột đó mới được hiển thị.","Dữ liệu trong các ô còn lại của bảng sẽ không thay đổi vị trí."],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Khi bạn sắp xếp một cột dữ liệu trong bảng tính theo thứ tự giảm dần, điều gì sẽ xảy ra?","rendered_options":["Các hàng dữ liệu không liên quan sẽ bị ẩn đi.","Thứ tự các hàng trong bảng sẽ thay đổi để dữ liệu trong cột đó được sắp xếp từ giá trị lớn nhất đến nhỏ nhất.","Chỉ các giá trị trùng lặp trong cột đó mới được hiển thị.","Dữ liệu trong các ô còn lại của bảng sẽ không thay đổi vị trí."]},{"question":"Sau khi áp dụng chức năng lọc dữ liệu trên một bảng tính với điều kiện nhất định, điều gì sẽ xảy ra với các hàng không thỏa mãn điều kiện lọc?","options":["Chúng sẽ bị xóa vĩnh viễn khỏi bảng tính.","Chúng sẽ được chuyển sang một bảng tính mới.","Chúng sẽ bị ẩn đi tạm thời khỏi chế độ xem nhưng không bị xóa.","Chúng sẽ được tô màu khác để dễ nhận biết."],"correctAnswerIndex":2,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Sau khi áp dụng chức năng lọc dữ liệu trên một bảng tính với điều kiện nhất định, điều gì sẽ xảy ra với các hàng không thỏa mãn điều kiện lọc?","rendered_options":["Chúng sẽ bị xóa vĩnh viễn khỏi bảng tính.","Chúng sẽ được chuyển sang một bảng tính mới.","Chúng sẽ bị ẩn đi tạm thời khỏi chế độ xem nhưng không bị xóa.","Chúng sẽ được tô màu khác để dễ nhận biết."]},{"question":"Trong phần mềm bảng tính, chức năng tạo biểu đồ được sử dụng để làm gì?","options":["Tính toán các công thức phức tạp","Lưu trữ dữ liệu một cách an toàn","Minh họa dữ liệu một cách trực quan, dễ hiểu","Sắp xếp dữ liệu theo thứ tự bảng chữ cái"],"correctAnswerIndex":2,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Trong phần mềm bảng tính, chức năng tạo biểu đồ được sử dụng để làm gì?","rendered_options":["Tính toán các công thức phức tạp","Lưu trữ dữ liệu một cách an toàn","Minh họa dữ liệu một cách trực quan, dễ hiểu","Sắp xếp dữ liệu theo thứ tự bảng chữ cái"]},{"question":"Khi muốn so sánh doanh số bán hàng của các sản phẩm khác nhau trong một quý, loại biểu đồ nào sau đây thường được sử dụng hiệu quả nhất để trực quan hóa dữ liệu?","options":["Biểu đồ đường","Biểu đồ cột","Biểu đồ miền","Biểu đồ phân tán"],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Khi muốn so sánh doanh số bán hàng của các sản phẩm khác nhau trong một quý, loại biểu đồ nào sau đây thường được sử dụng hiệu quả nhất để trực quan hóa dữ liệu?","rendered_options":["Biểu đồ đường","Biểu đồ cột","Biểu đồ miền","Biểu đồ phân tán"]},{"question":"Để tạo biểu đồ trong phần mềm bảng tính như Microsoft Excel hoặc Google Sheets, bước đầu tiên cần làm là gì?","options":["In toàn bộ bảng tính","Gửi bảng tính qua email","Chọn vùng dữ liệu cần tạo biểu đồ","Đổi tên tệp bảng tính"],"correctAnswerIndex":2,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Để tạo biểu đồ trong phần mềm bảng tính như Microsoft Excel hoặc Google Sheets, bước đầu tiên cần làm là gì?","rendered_options":["In toàn bộ bảng tính","Gửi bảng tính qua email","Chọn vùng dữ liệu cần tạo biểu đồ","Đổi tên tệp bảng tính"]},{"question":"Biểu đồ nào phù hợp nhất để thể hiện sự thay đổi về nhiệt độ trung bình hàng tháng trong một năm?","options":["Biểu đồ tròn","Biểu đồ cột","Biểu đồ đường","Biểu đồ miền"],"correctAnswerIndex":2,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Biểu đồ nào phù hợp nhất để thể hiện sự thay đổi về nhiệt độ trung bình hàng tháng trong một năm?","rendered_options":["Biểu đồ tròn","Biểu đồ cột","Biểu đồ đường","Biểu đồ miền"]},{"question":"Trong các tình huống sau, tình huống nào cần sử dụng chức năng tạo biểu đồ trong phần mềm bảng tính để trực quan hóa dữ liệu?","options":["Soạn thảo một lá thư cá nhân gửi bạn bè.","Vẽ một bức tranh nghệ thuật phức tạp.","Tạo báo cáo thống kê kết quả học tập của học sinh trong một học kì.","Lập trình một trò chơi điện tử."],"correctAnswerIndex":2,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Trong các tình huống sau, tình huống nào cần sử dụng chức năng tạo biểu đồ trong phần mềm bảng tính để trực quan hóa dữ liệu?","rendered_options":["Soạn thảo một lá thư cá nhân gửi bạn bè.","Vẽ một bức tranh nghệ thuật phức tạp.","Tạo báo cáo thống kê kết quả học tập của học sinh trong một học kì.","Lập trình một trò chơi điện tử."]},{"question":"Lợi ích chính của việc sử dụng biểu đồ để trực quan hóa dữ liệu trong phần mềm bảng tính là gì?","options":["Giúp giảm dung lượng tệp tin bảng tính.","Giúp che giấu thông tin quan trọng khỏi người xem.","Giúp dữ liệu dễ hiểu, dễ phân tích và dễ nhận biết xu hướng hơn.","Giúp tăng tốc độ nhập liệu vào bảng tính."],"correctAnswerIndex":2,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Lợi ích chính của việc sử dụng biểu đồ để trực quan hóa dữ liệu trong phần mềm bảng tính là gì?","rendered_options":["Giúp giảm dung lượng tệp tin bảng tính.","Giúp che giấu thông tin quan trọng khỏi người xem.","Giúp dữ liệu dễ hiểu, dễ phân tích và dễ nhận biết xu hướng hơn.","Giúp tăng tốc độ nhập liệu vào bảng tính."]},{"question":"Bước đầu tiên và quan trọng nhất khi muốn tạo một biểu đồ từ dữ liệu trong phần mềm bảng tính (ví dụ: Microsoft Excel, Google Sheets) là gì?","options":["In toàn bộ bảng tính ra giấy.","Chọn vùng dữ liệu cần biểu diễn trên biểu đồ.","Thay đổi phông chữ và kích thước chữ của tất cả các ô.","Lưu bảng tính dưới định dạng PDF."],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Bước đầu tiên và quan trọng nhất khi muốn tạo một biểu đồ từ dữ liệu trong phần mềm bảng tính (ví dụ: Microsoft Excel, Google Sheets) là gì?","rendered_options":["In toàn bộ bảng tính ra giấy.","Chọn vùng dữ liệu cần biểu diễn trên biểu đồ.","Thay đổi phông chữ và kích thước chữ của tất cả các ô.","Lưu bảng tính dưới định dạng PDF."]},{"question":"Để thể hiện tỷ lệ phần trăm đóng góp của các thành phần vào một tổng thể (ví dụ: tỷ lệ học sinh đạt loại Giỏi, Khá, Trung bình trong một lớp), loại biểu đồ nào thường được sử dụng phù hợp nhất?","options":["Biểu đồ cột (Column chart)","Biểu đồ tròn (Pie chart)","Biểu đồ đường (Line chart)","Biểu đồ miền (Area chart)"],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Để thể hiện tỷ lệ phần trăm đóng góp của các thành phần vào một tổng thể (ví dụ: tỷ lệ học sinh đạt loại Giỏi, Khá, Trung bình trong một lớp), loại biểu đồ nào thường được sử dụng phù hợp nhất?","rendered_options":["Biểu đồ cột (Column chart)","Biểu đồ tròn (Pie chart)","Biểu đồ đường (Line chart)","Biểu đồ miền (Area chart)"]},{"question":"Để tạo danh sách dạng liệt kê có đánh số thứ tự trong phần mềm soạn thảo văn bản, em sẽ chọn chức năng nào?","options":["Bullets","Numbering","Multilevel List","Decrease Indent"],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Để tạo danh sách dạng liệt kê có đánh số thứ tự trong phần mềm soạn thảo văn bản, em sẽ chọn chức năng nào?","rendered_options":["Bullets","Numbering","Multilevel List","Decrease Indent"]},{"question":"Thao tác nào sau đây được sử dụng để chèn một hình ảnh từ máy tính vào văn bản?","options":["Home -> Picture","Insert -> Shape","Insert -> Picture","Layout -> Image"],"correctAnswerIndex":2,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Thao tác nào sau đây được sử dụng để chèn một hình ảnh từ máy tính vào văn bản?","rendered_options":["Home -> Picture","Insert -> Shape","Insert -> Picture","Layout -> Image"]},{"question":"Khi muốn thay đổi kích thước của một hình ảnh đã chèn vào văn bản, em cần thực hiện thao tác nào?","options":["Nhấn chuột phải vào hình ảnh và chọn 'Delete'","Kéo các nút điều khiển (handles) ở góc hoặc cạnh của hình ảnh","Chọn hình ảnh và nhấn phím 'Enter'","Chọn hình ảnh và vào menu 'View' để điều chỉnh"],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Khi muốn thay đổi kích thước của một hình ảnh đã chèn vào văn bản, em cần thực hiện thao tác nào?","rendered_options":["Nhấn chuột phải vào hình ảnh và chọn 'Delete'","Kéo các nút điều khiển (handles) ở góc hoặc cạnh của hình ảnh","Chọn hình ảnh và nhấn phím 'Enter'","Chọn hình ảnh và vào menu 'View' để điều chỉnh"]},{"question":"Để vẽ một hình chữ nhật trong phần mềm soạn thảo văn bản, em sẽ tìm kiếm công cụ nào trong thẻ 'Insert'?","options":["Charts","SmartArt","Shapes","Screenshot"],"correctAnswerIndex":2,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Để vẽ một hình chữ nhật trong phần mềm soạn thảo văn bản, em sẽ tìm kiếm công cụ nào trong thẻ 'Insert'?","rendered_options":["Charts","SmartArt","Shapes","Screenshot"]},{"question":"Mục đích chính của việc sử dụng đầu trang (Header) và chân trang (Footer) trong văn bản là gì?","options":["Để dễ dàng áp dụng định dạng cho toàn bộ tài liệu.","Để hiển thị thông tin như số trang, tiêu đề tài liệu hoặc tên tác giả một cách nhất quán trên nhiều trang.","Để bảo vệ tài liệu khỏi việc chỉnh sửa trái phép.","Để nhanh chóng điều hướng giữa các phần khác nhau của tài liệu."],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Mục đích chính của việc sử dụng đầu trang (Header) và chân trang (Footer) trong văn bản là gì?","rendered_options":["Để dễ dàng áp dụng định dạng cho toàn bộ tài liệu.","Để hiển thị thông tin như số trang, tiêu đề tài liệu hoặc tên tác giả một cách nhất quán trên nhiều trang.","Để bảo vệ tài liệu khỏi việc chỉnh sửa trái phép.","Để nhanh chóng điều hướng giữa các phần khác nhau của tài liệu."]},{"question":"Để chèn số trang vào văn bản một cách nhất quán trên mỗi trang, người dùng thường chọn vị trí nào?","options":["Chỉ trong phần nội dung chính của văn bản.","Trong khu vực đầu trang (Header) hoặc chân trang (Footer).","Trong một hộp văn bản nổi trên tài liệu.","Là một hình ảnh được chèn vào văn bản."],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Để chèn số trang vào văn bản một cách nhất quán trên mỗi trang, người dùng thường chọn vị trí nào?","rendered_options":["Chỉ trong phần nội dung chính của văn bản.","Trong khu vực đầu trang (Header) hoặc chân trang (Footer).","Trong một hộp văn bản nổi trên tài liệu.","Là một hình ảnh được chèn vào văn bản."]},{"question":"Những yếu tố nào sau đây có thể được chèn vào đầu trang (Header) hoặc chân trang (Footer) của một văn bản?","options":["Chỉ số trang.","Chỉ tiêu đề tài liệu và tên tác giả.","Số trang, tiêu đề tài liệu, tên tác giả, ngày, giờ và hình ảnh.","Chỉ các công thức toán học phức tạp."],"correctAnswerIndex":2,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Những yếu tố nào sau đây có thể được chèn vào đầu trang (Header) hoặc chân trang (Footer) của một văn bản?","rendered_options":["Chỉ số trang.","Chỉ tiêu đề tài liệu và tên tác giả.","Số trang, tiêu đề tài liệu, tên tác giả, ngày, giờ và hình ảnh.","Chỉ các công thức toán học phức tạp."]},{"question":"Sau khi tạo đầu trang hoặc chân trang, nội dung của nó thường xuất hiện ở đâu trong tài liệu?","options":["Chỉ trên trang đầu tiên của tài liệu.","Chỉ trên các trang có số chẵn.","Chỉ khi tài liệu được in ra.","Ở lề trên (đầu trang) hoặc lề dưới (chân trang) của mỗi trang, hoặc các trang cụ thể theo cấu hình."],"correctAnswerIndex":3,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Sau khi tạo đầu trang hoặc chân trang, nội dung của nó thường xuất hiện ở đâu trong tài liệu?","rendered_options":["Chỉ trên trang đầu tiên của tài liệu.","Chỉ trên các trang có số chẵn.","Chỉ khi tài liệu được in ra.","Ở lề trên (đầu trang) hoặc lề dưới (chân trang) của mỗi trang, hoặc các trang cụ thể theo cấu hình."]},{"main_question":"Trong phần mềm bảng tính, chức năng sắp xếp và lọc dữ liệu giúp ích rất nhiều trong việc quản lí và phân tích thông tin.","statements":[{"statement":"Chức năng sắp xếp (Sort) dữ liệu cho phép người dùng thay đổi thứ tự các hàng dữ liệu dựa trên giá trị của một hoặc nhiều cột.","is_correct":true,"rendered_statement":"Chức năng sắp xếp (Sort) dữ liệu cho phép người dùng thay đổi thứ tự các hàng dữ liệu dựa trên giá trị của một hoặc nhiều cột."},{"statement":"Khi sắp xếp dữ liệu theo một cột, các dữ liệu trên cùng hàng của các cột khác có liên quan sẽ tự động di chuyển theo để giữ nguyên tính toàn vẹn của dữ liệu gốc.","is_correct":true,"rendered_statement":"Khi sắp xếp dữ liệu theo một cột, các dữ liệu trên cùng hàng của các cột khác có liên quan sẽ tự động di chuyển theo để giữ nguyên tính toàn vẹn của dữ liệu gốc."},{"statement":"Để hiển thị chỉ những học sinh có điểm môn Tin học từ 8 trở lên trong một danh sách điểm lớn, chức năng Lọc (Filter) với điều kiện số là \"Lớn hơn hoặc bằng 8\" là phương pháp hiệu quả nhất.","is_correct":true,"rendered_statement":"Để hiển thị chỉ những học sinh có điểm môn Tin học từ 8 trở lên trong một danh sách điểm lớn, chức năng Lọc (Filter) với điều kiện số là \"Lớn hơn hoặc bằng 8\" là phương pháp hiệu quả nhất."},{"statement":"Trong phần mềm bảng tính, việc thực hiện sắp xếp dữ liệu theo nhiều cấp độ (ví dụ: sắp xếp theo lớp trước, sau đó sắp xếp theo tên trong mỗi lớp) chỉ có thể thực hiện được bằng cách sắp xếp từng cột riêng lẻ theo thứ tự ngược từ cột thứ cấp đến cột chính.","is_correct":false,"rendered_statement":"Trong phần mềm bảng tính, việc thực hiện sắp xếp dữ liệu theo nhiều cấp độ (ví dụ: sắp xếp theo lớp trước, sau đó sắp xếp theo tên trong mỗi lớp) chỉ có thể thực hiện được bằng cách sắp xếp từng cột riêng lẻ theo thứ tự ngược từ cột thứ cấp đến cột chính."}],"type":"true-false","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Trong phần mềm bảng tính, chức năng sắp xếp và lọc dữ liệu giúp ích rất nhiều trong việc quản lí và phân tích thông tin."},{"main_question":"Chức năng lọc dữ liệu trong phần mềm bảng tính cung cấp nhiều tùy chọn để hiển thị các tập con dữ liệu mong muốn.","statements":[{"statement":"Chức năng lọc (Filter) trong phần mềm bảng tính được dùng để ẩn tạm thời các hàng dữ liệu không đáp ứng tiêu chí đã chọn, không làm mất dữ liệu gốc.","is_correct":true,"rendered_statement":"Chức năng lọc (Filter) trong phần mềm bảng tính được dùng để ẩn tạm thời các hàng dữ liệu không đáp ứng tiêu chí đã chọn, không làm mất dữ liệu gốc."},{"statement":"Khi bật chức năng lọc, một mũi tên nhỏ sẽ xuất hiện ở tiêu đề mỗi cột, cho phép người dùng mở danh sách tùy chọn lọc cho cột đó.","is_correct":true,"rendered_statement":"Khi bật chức năng lọc, một mũi tên nhỏ sẽ xuất hiện ở tiêu đề mỗi cột, cho phép người dùng mở danh sách tùy chọn lọc cho cột đó."},{"statement":"Để tìm tất cả các sản phẩm có tên bắt đầu bằng chữ \"A\" trong một cột danh sách sản phẩm, người dùng có thể sử dụng chức năng lọc văn bản (Text Filters) và chọn tùy chọn \"Bắt đầu bằng\" (Begins With).","is_correct":true,"rendered_statement":"Để tìm tất cả các sản phẩm có tên bắt đầu bằng chữ \"A\" trong một cột danh sách sản phẩm, người dùng có thể sử dụng chức năng lọc văn bản (Text Filters) và chọn tùy chọn \"Bắt đầu bằng\" (Begins With)."},{"statement":"Sau khi áp dụng nhiều điều kiện lọc khác nhau trên các cột (ví dụ: lọc theo Tên lớp và lọc theo Điểm trung bình), việc hủy bỏ một điều kiện lọc cụ thể trên một cột sẽ tự động xóa bỏ tất cả các điều kiện lọc khác đã áp dụng trên các cột còn lại.","is_correct":false,"rendered_statement":"Sau khi áp dụng nhiều điều kiện lọc khác nhau trên các cột (ví dụ: lọc theo Tên lớp và lọc theo Điểm trung bình), việc hủy bỏ một điều kiện lọc cụ thể trên một cột sẽ tự động xóa bỏ tất cả các điều kiện lọc khác đã áp dụng trên các cột còn lại."}],"type":"true-false","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Chức năng lọc dữ liệu trong phần mềm bảng tính cung cấp nhiều tùy chọn để hiển thị các tập con dữ liệu mong muốn."},{"main_question":"Phát biểu nào sau đây đúng khi nói về chức năng sắp xếp và lọc dữ liệu trong phần mềm bảng tính?","statements":[{"statement":"Chức năng sắp xếp dữ liệu giúp người dùng đổi vị trí các hàng để các giá trị trong một cột được xếp theo thứ tự mong muốn (tăng dần hoặc giảm dần).","is_correct":true,"rendered_statement":"Chức năng sắp xếp dữ liệu giúp người dùng đổi vị trí các hàng để các giá trị trong một cột được xếp theo thứ tự mong muốn (tăng dần hoặc giảm dần)."},{"statement":"Chức năng lọc dữ liệu sẽ xóa vĩnh viễn những hàng không thỏa mãn điều kiện lọc.","is_correct":false,"rendered_statement":"Chức năng lọc dữ liệu sẽ xóa vĩnh viễn những hàng không thỏa mãn điều kiện lọc."},{"statement":"Để tìm tất cả các sản phẩm có giá trị lớn hơn 500.000 đồng trong một danh sách, cách hiệu quả nhất là sử dụng chức năng sắp xếp tăng dần theo giá rồi tìm thủ công.","is_correct":false,"rendered_statement":"Để tìm tất cả các sản phẩm có giá trị lớn hơn 500.000 đồng trong một danh sách, cách hiệu quả nhất là sử dụng chức năng sắp xếp tăng dần theo giá rồi tìm thủ công."},{"statement":"Khi sắp xếp dữ liệu theo nhiều tiêu chí (ví dụ: sắp xếp theo Lớp, sau đó theo Tên), thứ tự chọn tiêu chí sắp xếp không ảnh hưởng đến kết quả cuối cùng.","is_correct":false,"rendered_statement":"Khi sắp xếp dữ liệu theo nhiều tiêu chí (ví dụ: sắp xếp theo Lớp, sau đó theo Tên), thứ tự chọn tiêu chí sắp xếp không ảnh hưởng đến kết quả cuối cùng."}],"type":"true-false","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Phát biểu nào sau đây đúng khi nói về chức năng sắp xếp và lọc dữ liệu trong phần mềm bảng tính?"},{"main_question":"Khi làm việc với chức năng sắp xếp và lọc dữ liệu trong phần mềm bảng tính, những phát biểu sau có đúng không?","statements":[{"statement":"Khi sắp xếp dữ liệu trong một bảng tính, toàn bộ hàng chứa dữ liệu sẽ được di chuyển để đảm bảo tính toàn vẹn của dữ liệu.","is_correct":true,"rendered_statement":"Khi sắp xếp dữ liệu trong một bảng tính, toàn bộ hàng chứa dữ liệu sẽ được di chuyển để đảm bảo tính toàn vẹn của dữ liệu."},{"statement":"Chức năng lọc dữ liệu cho phép người dùng chọn nhiều hơn một giá trị hoặc sử dụng các điều kiện phức tạp (ví dụ: lớn hơn một số cụ thể) để hiển thị dữ liệu.","is_correct":true,"rendered_statement":"Chức năng lọc dữ liệu cho phép người dùng chọn nhiều hơn một giá trị hoặc sử dụng các điều kiện phức tạp (ví dụ: lớn hơn một số cụ thể) để hiển thị dữ liệu."},{"statement":"Để sắp xếp một danh sách học sinh theo điểm tổng kết từ cao xuống thấp, sau đó sắp xếp những học sinh có cùng điểm tổng kết theo tên từ A đến Z, ta cần thực hiện hai lần sắp xếp độc lập.","is_correct":false,"rendered_statement":"Để sắp xếp một danh sách học sinh theo điểm tổng kết từ cao xuống thấp, sau đó sắp xếp những học sinh có cùng điểm tổng kết theo tên từ A đến Z, ta cần thực hiện hai lần sắp xếp độc lập."},{"statement":"Khi áp dụng bộ lọc dữ liệu vào một bảng tính, các hàng dữ liệu bị ẩn đi sẽ không được tính toán hoặc hiển thị trong các hàm thống kê cơ bản như SUM, AVERAGE nếu các hàm này tham chiếu đến toàn bộ vùng dữ liệu bị lọc.","is_correct":false,"rendered_statement":"Khi áp dụng bộ lọc dữ liệu vào một bảng tính, các hàng dữ liệu bị ẩn đi sẽ không được tính toán hoặc hiển thị trong các hàm thống kê cơ bản như SUM, AVERAGE nếu các hàm này tham chiếu đến toàn bộ vùng dữ liệu bị lọc."}],"type":"true-false","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Khi làm việc với chức năng sắp xếp và lọc dữ liệu trong phần mềm bảng tính, những phát biểu sau có đúng không?"},{"main_question":"Trong phần mềm soạn thảo văn bản, để xử lý hình ảnh, em hãy xác định các phát biểu sau đây là Đúng hay Sai:","statements":[{"statement":"Để chèn hình ảnh vào văn bản, ta thường sử dụng lệnh \"Insert Picture\" hoặc \"Chèn Ảnh\" có trong nhóm công cụ Minh họa (Illustrations).","is_correct":true,"rendered_statement":"Để chèn hình ảnh vào văn bản, ta thường sử dụng lệnh \"Insert Picture\" hoặc \"Chèn Ảnh\" có trong nhóm công cụ Minh họa (Illustrations)."},{"statement":"Sau khi chèn ảnh, để thay đổi kích thước ảnh, ta chỉ có thể dùng chuột kéo các góc ảnh, không thể dùng các nút điều chỉnh ở giữa cạnh ảnh.","is_correct":false,"rendered_statement":"Sau khi chèn ảnh, để thay đổi kích thước ảnh, ta chỉ có thể dùng chuột kéo các góc ảnh, không thể dùng các nút điều chỉnh ở giữa cạnh ảnh."},{"statement":"Khi muốn hình ảnh nằm phía sau văn bản (chữ đè lên ảnh) hoặc ảnh nằm trên văn bản (ảnh đè lên chữ), ta sử dụng các tùy chọn trong nhóm \"Text Wrapping\" (hoặc \"Ngắt dòng văn bản\") của công cụ Hình ảnh.","is_correct":true,"rendered_statement":"Khi muốn hình ảnh nằm phía sau văn bản (chữ đè lên ảnh) hoặc ảnh nằm trên văn bản (ảnh đè lên chữ), ta sử dụng các tùy chọn trong nhóm \"Text Wrapping\" (hoặc \"Ngắt dòng văn bản\") của công cụ Hình ảnh."},{"statement":"Để tạo hiệu ứng ảnh trong suốt (transparent) cho một hình ảnh có sẵn trong văn bản, ta bắt buộc phải sử dụng phần mềm chỉnh sửa ảnh chuyên nghiệp bên ngoài rồi mới chèn lại vào.","is_correct":false,"rendered_statement":"Để tạo hiệu ứng ảnh trong suốt (transparent) cho một hình ảnh có sẵn trong văn bản, ta bắt buộc phải sử dụng phần mềm chỉnh sửa ảnh chuyên nghiệp bên ngoài rồi mới chèn lại vào."}],"type":"true-false","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Trong phần mềm soạn thảo văn bản, để xử lý hình ảnh, em hãy xác định các phát biểu sau đây là Đúng hay Sai:"},{"main_question":"Trong phần mềm soạn thảo văn bản, khi làm việc với danh sách dạng liệt kê và hình đồ họa, hãy xác định các phát biểu sau là Đúng hay Sai:","statements":[{"statement":"Danh sách dạng liệt kê có thể được tạo bằng cách sử dụng các dấu đầu dòng (bullet) hoặc số thứ tự (numbering).","is_correct":true,"rendered_statement":"Danh sách dạng liệt kê có thể được tạo bằng cách sử dụng các dấu đầu dòng (bullet) hoặc số thứ tự (numbering)."},{"statement":"Khi muốn chuyển đổi một danh sách đang được đánh số thành danh sách dấu đầu dòng, ta phải xóa toàn bộ các số thứ tự và gõ lại thủ công các dấu đầu dòng mới.","is_correct":false,"rendered_statement":"Khi muốn chuyển đổi một danh sách đang được đánh số thành danh sách dấu đầu dòng, ta phải xóa toàn bộ các số thứ tự và gõ lại thủ công các dấu đầu dòng mới."},{"statement":"Khi tạo danh sách dạng liệt kê nhiều cấp (ví dụ: cấp 1, cấp con 1.1, cấp con 1.2), ta có thể sử dụng phím Tab hoặc Shift + Tab để thay đổi cấp độ của mục trong danh sách.","is_correct":true,"rendered_statement":"Khi tạo danh sách dạng liệt kê nhiều cấp (ví dụ: cấp 1, cấp con 1.1, cấp con 1.2), ta có thể sử dụng phím Tab hoặc Shift + Tab để thay đổi cấp độ của mục trong danh sách."},{"statement":"Các hình đồ họa được vẽ trực tiếp trong phần mềm soạn thảo văn bản (ví dụ: hình chữ nhật, hình tròn) không thể thay đổi màu sắc đường viền hay màu nền sau khi đã vẽ xong.","is_correct":false,"rendered_statement":"Các hình đồ họa được vẽ trực tiếp trong phần mềm soạn thảo văn bản (ví dụ: hình chữ nhật, hình tròn) không thể thay đổi màu sắc đường viền hay màu nền sau khi đã vẽ xong."}],"type":"true-false","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Trong phần mềm soạn thảo văn bản, khi làm việc với danh sách dạng liệt kê và hình đồ họa, hãy xác định các phát biểu sau là Đúng hay Sai:"},{"main_question":"Khi làm việc với đầu trang và chân trang trong phần mềm soạn thảo văn bản, hãy cho biết các nhận định sau đây là đúng hay sai:","statements":[{"statement":"Để mở hoặc chỉnh sửa đầu trang (Header) hoặc chân trang (Footer), người dùng có thể nháy đúp chuột vào vùng trên cùng hoặc dưới cùng của trang văn bản.","is_correct":true,"rendered_statement":"Để mở hoặc chỉnh sửa đầu trang (Header) hoặc chân trang (Footer), người dùng có thể nháy đúp chuột vào vùng trên cùng hoặc dưới cùng của trang văn bản."},{"statement":"Nội dung được nhập vào đầu trang hoặc chân trang chỉ xuất hiện trên trang hiện tại mà người dùng đang làm việc.","is_correct":false,"rendered_statement":"Nội dung được nhập vào đầu trang hoặc chân trang chỉ xuất hiện trên trang hiện tại mà người dùng đang làm việc."},{"statement":"Tùy chọn 'Different First Page' (Trang đầu khác nhau) cho phép tạo một đầu trang hoặc chân trang riêng biệt chỉ cho trang đầu tiên của tài liệu hoặc của một phần (section).","is_correct":true,"rendered_statement":"Tùy chọn 'Different First Page' (Trang đầu khác nhau) cho phép tạo một đầu trang hoặc chân trang riêng biệt chỉ cho trang đầu tiên của tài liệu hoặc của một phần (section)."},{"statement":"Để có thể tạo các đầu trang và chân trang hoàn toàn khác nhau cho từng chương trong một tài liệu dài, người dùng cần chèn một ngắt trang (Page Break) vào cuối mỗi chương.","is_correct":false,"rendered_statement":"Để có thể tạo các đầu trang và chân trang hoàn toàn khác nhau cho từng chương trong một tài liệu dài, người dùng cần chèn một ngắt trang (Page Break) vào cuối mỗi chương."}],"type":"true-false","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Khi làm việc với đầu trang và chân trang trong phần mềm soạn thảo văn bản, hãy cho biết các nhận định sau đây là đúng hay sai:"},{"main_question":"Về thao tác đánh số trang trong phần mềm soạn thảo văn bản, các nhận định sau đây là đúng hay sai:","statements":[{"statement":"Để chèn số trang vào văn bản, người dùng thường tìm chức năng 'Page Number' (Số trang) trong thẻ 'Insert' (Chèn).","is_correct":true,"rendered_statement":"Để chèn số trang vào văn bản, người dùng thường tìm chức năng 'Page Number' (Số trang) trong thẻ 'Insert' (Chèn)."},{"statement":"Mặc định, phần mềm soạn thảo văn bản chỉ cho phép đánh số trang bằng chữ số La Mã (I, II, III, ...).","is_correct":false,"rendered_statement":"Mặc định, phần mềm soạn thảo văn bản chỉ cho phép đánh số trang bằng chữ số La Mã (I, II, III, ...)."},{"statement":"Sau khi chèn số trang, nếu muốn bắt đầu đánh số từ một số khác (ví dụ: bắt đầu từ số 5 thay vì số 1), người dùng có thể điều chỉnh trong phần 'Format Page Numbers' (Định dạng số trang).","is_correct":true,"rendered_statement":"Sau khi chèn số trang, nếu muốn bắt đầu đánh số từ một số khác (ví dụ: bắt đầu từ số 5 thay vì số 1), người dùng có thể điều chỉnh trong phần 'Format Page Numbers' (Định dạng số trang)."},{"statement":"Việc sử dụng các kiểu ngắt trang (Page Break) khác nhau, như 'Next Page' hoặc 'Continuous', có thể giúp tạo các phần (sections) độc lập để áp dụng các định dạng số trang khác nhau trong cùng một tài liệu.","is_correct":false,"rendered_statement":"Việc sử dụng các kiểu ngắt trang (Page Break) khác nhau, như 'Next Page' hoặc 'Continuous', có thể giúp tạo các phần (sections) độc lập để áp dụng các định dạng số trang khác nhau trong cùng một tài liệu."}],"type":"true-false","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Về thao tác đánh số trang trong phần mềm soạn thảo văn bản, các nhận định sau đây là đúng hay sai:"},{"question":"Trong phần mềm soạn thảo văn bản cung cấp những kiểu danh sách dạng liệt kê nào? Nêu các bước tạo danh sách có thứ tự?","answer":"- Phần mềm soạn thảo văn bản cung cấp hai kiểu danh sách dạng liệt kê: danh sách dấu đầu dòng, danh sách có thứ tự\n\n- Tạo danh sách có thứ tự:\n\n1. Chọn các đoạn văn bản muốn tạo danh sách có thứ tự\n\n2. Chọn Home\n\n3. Nháy chuột vào hình tam giác nhỏ bên cạnh lệnh Numbering\n\n4. Chọn kiểu danh sách có thứ tự\n\n","type":"essay","isDirty":true,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"questionImage":null,"rendered_question":"Trong phần mềm soạn thảo văn bản cung cấp những kiểu danh sách dạng liệt kê nào? Nêu các bước tạo danh sách có thứ tự?","rendered_answer":"- Phần mềm soạn thảo văn bản cung cấp hai kiểu danh sách dạng liệt kê: danh sách dấu đầu dòng, danh sách có thứ tự<br><br>- Tạo danh sách có thứ tự:<br><br>1. Chọn các đoạn văn bản muốn tạo danh sách có thứ tự<br><br>2. Chọn Home<br><br>3. Nháy chuột vào hình tam giác nhỏ bên cạnh lệnh Numbering<br><br>4. Chọn kiểu danh sách có thứ tự<br><br>"},{"question":"Em hãy nêu các bước tạo biểu đồ hình quạt tròn?\n","answer":"Bước 1. Chọn vùng dữ liệu\nBước 2. Vào thẻ Insert, nhóm Charts, chọn Insert Pie or Doughnut Chart\nBước 3. Trong nhóm biểu đồ 2-D Pie, chọn kiểu biểu đồ Pie\nBước 4. Vào Chart Elements để bổ sung thông tin cho biểu đồ\n","type":"essay","isDirty":true,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"questionImage":null,"rendered_question":"Em hãy nêu các bước tạo biểu đồ hình quạt tròn?<br>","rendered_answer":"Bước 1. Chọn vùng dữ liệu<br>Bước 2. Vào thẻ Insert, nhóm Charts, chọn Insert Pie or Doughnut Chart<br>Bước 3. Trong nhóm biểu đồ 2-D Pie, chọn kiểu biểu đồ Pie<br>Bước 4. Vào Chart Elements để bổ sung thông tin cho biểu đồ<br>"},{"question":"Ngoài các mẫu danh sách liệt kê mà phần mềm soạn thảo cung cấp, người sử dụng có thể tự tạo các mẫu dấu đầu dòng, mẫu thứ tự theo ý thích của mình. Em hãy tìm hiểu cách làm và tạo ba mẫu dấu đầu dòng, mẫu thứ tự mới.\n","answer":"Tạo mẫu dấu đầu dòng:\nHome/Paragraph/Bullets/Define New Bullet\nTạo mẫu thứ tự:\nHome/Paragraph/Numbering/Define New Number Format\n","type":"essay","isDirty":true,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"questionImage":null,"rendered_question":"Ngoài các mẫu danh sách liệt kê mà phần mềm soạn thảo cung cấp, người sử dụng có thể tự tạo các mẫu dấu đầu dòng, mẫu thứ tự theo ý thích của mình. Em hãy tìm hiểu cách làm và tạo ba mẫu dấu đầu dòng, mẫu thứ tự mới.<br>","rendered_answer":"Tạo mẫu dấu đầu dòng:<br>Home/Paragraph/Bullets/Define New Bullet<br>Tạo mẫu thứ tự:<br>Home/Paragraph/Numbering/Define New Number Format<br>"},{"question":"Em hãy nêu các bước chèn ảnh vào phần mềm soạn thảo văn bản","answer":"Đặt con trỏ tại vị trí cần thêm ảnh\nChọn Insert/Pictures/This Device\nChọn ảnh cần chèn\nChọn Insert\n","type":"essay","isDirty":true,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"questionImage":null,"rendered_question":"Em hãy nêu các bước chèn ảnh vào phần mềm soạn thảo văn bản","rendered_answer":"Đặt con trỏ tại vị trí cần thêm ảnh<br>Chọn Insert/Pictures/This Device<br>Chọn ảnh cần chèn<br>Chọn Insert<br>"},{"question":"Em hãy nêu các bước tạo đầu trang và chân trang trong Phần mềm soạn thảo văn bản","answer":"1. Tạo đầu trang:\nVào thẻ Insert\nTrong nhóm lệnh Header & Footer chọn Footer\nChọn Blank rồi nhập nội dung vào ô [Type Here]\nĐịnh dạng văn bản cho nội dung đầu trang\n2. Tạo chân trang:\nVào thẻ Insert\nTrong nhóm lệnh Header & Footer chọn Header\nChọn Blank rồi nhập nội dung vào ô [Type Here]\nĐịnh dạng văn bản cho nội dung đầu trang\n\n","type":"essay","isDirty":true,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"questionImage":null,"rendered_question":"Em hãy nêu các bước tạo đầu trang và chân trang trong Phần mềm soạn thảo văn bản","rendered_answer":"1. Tạo đầu trang:<br>Vào thẻ Insert<br>Trong nhóm lệnh Header & Footer chọn Footer<br>Chọn Blank rồi nhập nội dung vào ô [Type Here]<br>Định dạng văn bản cho nội dung đầu trang<br>2. Tạo chân trang:<br>Vào thẻ Insert<br>Trong nhóm lệnh Header & Footer chọn Header<br>Chọn Blank rồi nhập nội dung vào ô [Type Here]<br>Định dạng văn bản cho nội dung đầu trang<br><br>"}];
        const options = {"title":"Đề Kiểm tra Tin học 45 phút","timeLimit":45,"retriesAllowed":10,"showAnswers":true,"showExplanation":true,"aiAssessment":true,"shortAnswerFormat":"freeform","examCode":"HCQNA5","teacherName":"Đàng Năng Nhanh","scoring":{"mc":3,"tf":4,"sa":0,"essay":3,"tfMethod":"progressive"}};
        const googleScriptUrl = "https://script.google.com/macros/s/AKfycbxx-BtRQ4SJJG5DkUOTYicW5ATk6hQu3X_J6it2d9bucw53uGQYwBa4QgMsfFbtcHo3-g/exec";
        const examCode = "HCQNA5";
        
        let userAnswers = new Array(quizData.length).fill(null);
        let studentName = '';
        let studentClass = '';
        let timerInterval;
        let timeRemaining = options.timeLimit * 60;
        let retriesCount = 0;
        let submissionStatus = 'pending';
        let monitoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0 };
        let lastScore, lastAnswerDetails; // For retrying AI assessment
        let isQuizActive = false;

        const studentApiKeyInput = document.getElementById('student-api-key');

        // Check if AI features are enabled by teacher
        const needsAiKey = options.showExplanation || options.aiAssessment;
        if (needsAiKey) {
            document.getElementById('api-key-input-container').classList.remove('hidden');
        }
        
        window.addEventListener('beforeunload', (e) => {
            if (isQuizActive) {
                const message = "Bạn đang làm bài, có muốn thoát không? Hãy nộp bài và thoát.";
                e.preventDefault();
                e.returnValue = message;
                return message;
            }
        });

        // --- UTILS FOR SHUFFLING ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function mapType(typeStr) {
             if (!typeStr) return 'multiple-choice';
             if (typeStr.startsWith('mc-') || ['cloze-test', 'sentence-ordering', 'multiple-choice', 'paragraph-sentence-ordering'].includes(typeStr)) return 'multiple-choice';
             if (typeStr.startsWith('tf-') || typeStr === 'true-false') return 'true-false';
             if (typeStr === 'short-answer' || typeStr === 'sentence-transformation') return 'short-answer';
             return 'essay';
        }

        // --- SHUFFLE LOGIC FOR ONLINE QUIZ ---
        function applyShuffling() {
            // 1. Shuffle Options/Statements within each question
            quizData.forEach(item => {
                const shuffleOpts = item.shuffleOptions || { answers: true };
                const type = mapType(item.type);
                
                if (shuffleOpts.answers) {
                    if (type === 'multiple-choice' && item.rendered_options && item.rendered_options.length > 0) {
                        // Create indices array to shuffle
                        const indices = item.rendered_options.map((_, i) => i);
                        shuffleArray(indices);
                        
                        // Reorder rendered_options based on shuffled indices
                        item.rendered_options = indices.map(i => item.rendered_options[i]);
                        
                        // Reorder raw options (needed for review/explanation context, though mostly rendered is used)
                        if (item.options) {
                            item.options = indices.map(i => item.options[i]);
                        }
                        
                        // Update correctAnswerIndex
                        // Old index was item.correctAnswerIndex. We need to find where it went.
                        // New index is the position of the old correct index in the shuffled 'indices' array.
                        item.correctAnswerIndex = indices.indexOf(item.correctAnswerIndex);

                    } else if (type === 'true-false' && item.statements && item.statements.length > 0) {
                        // Shuffle statements array directly
                        shuffleArray(item.statements);
                    }
                }
            });

            // 2. Shuffle Question Order within Parts (respecting "Câu dẫn" aka Stem shuffle option)
            // We group questions by type first to ensure we don't mix sections
            const groupedQuestions = quizData.reduce((acc, q, index) => {
                const type = mapType(q.type);
                if (!acc[type]) acc[type] = [];
                acc[type].push({ ...q, originalIndex: index });
                return acc;
            }, {});
            
            const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
            let newQuizData = [];

            partOrder.forEach(partType => {
                const questions = groupedQuestions[partType];
                if (questions) {
                    const finalPartQuestions = new Array(questions.length).fill(null);
                    const shufflableQuestions = [];
                    
                    // Separate fixed and shufflable questions
                    questions.forEach((q, i) => {
                        const shuffleOpts = q.shuffleOptions || { stem: true };
                        if (shuffleOpts.stem) {
                            shufflableQuestions.push(q);
                        } else {
                            finalPartQuestions[i] = q;
                        }
                    });

                    // Shuffle the shufflable ones
                    shuffleArray(shufflableQuestions);

                    // Merge back
                    let shufflableIndex = 0;
                    for (let i = 0; i < finalPartQuestions.length; i++) {
                        if (finalPartQuestions[i] === null) {
                            finalPartQuestions[i] = shufflableQuestions[shufflableIndex];
                            shufflableIndex++;
                        }
                    }
                    newQuizData = newQuizData.concat(finalPartQuestions);
                }
            });
            
            // Update the global quizData with the shuffled version
            if (newQuizData.length === quizData.length) {
                quizData = newQuizData;
            }
            
            // Reset user answers array to match new length (though length is same) and clear it
            userAnswers = new Array(quizData.length).fill(null);
        }
        
        // --- SMART FALLBACK GENERATOR ---
        const PROVIDERS = [
             {
                id: 'gemini',
                name: 'Google Gemini',
                isValid: () => !!API_KEYS.gemini && API_KEYS.gemini.trim().length > 0,
                execute: async (prompt) => {
                     const ai = new GoogleGenAI({ apiKey: API_KEYS.gemini });
                     // Fallback models for Gemini specifically
                     const models = ["gemini-2.5-flash", "gemini-2.0-flash", "gemini-1.5-flash"];
                     let lastErr;
                     for (const model of models) {
                        try {
                            const res = await ai.models.generateContent({ model, contents: prompt });
                            return res.text;
                        } catch (e) { 
                            console.warn(`Gemini ${model} error:`, e);
                            lastErr = e; 
                        }
                     }
                     throw lastErr || new Error("All Gemini models failed");
                }
            },
            {
                id: 'deepseek',
                name: 'DeepSeek',
                isValid: () => !!API_KEYS.deepseek && API_KEYS.deepseek.trim().length > 0,
                execute: async (prompt) => {
                     const res = await fetch("https://api.deepseek.com/chat/completions", {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${API_KEYS.deepseek}` },
                        body: JSON.stringify({ model: "deepseek-chat", messages: [{role: "user", content: prompt}], temperature: 0.7 })
                     });
                     if(!res.ok) throw new Error(`DeepSeek status ${res.status}: ${await res.text()}`);
                     const data = await res.json();
                     return data.choices[0].message.content;
                }
            },
            {
                id: 'openai',
                name: 'OpenAI',
                isValid: () => !!API_KEYS.openai && API_KEYS.openai.trim().length > 0,
                execute: async (prompt) => {
                     const res = await fetch("https://api.openai.com/v1/chat/completions", {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${API_KEYS.openai}` },
                        body: JSON.stringify({ model: "gpt-4o-mini", messages: [{role: "user", content: prompt}], temperature: 0.7 })
                     });
                     if(!res.ok) throw new Error(`OpenAI status ${res.status}: ${await res.text()}`);
                     const data = await res.json();
                     return data.choices[0].message.content;
                }
            }
        ];

        async function generateContentWithSmartFallback(prompt) {
            const validProviders = PROVIDERS.filter(p => p.isValid());
            if (validProviders.length === 0) {
                throw new Error("Không có API Key nào được cấu hình. Vui lòng liên hệ giáo viên.");
            }
            
            let errors = [];
            for (const provider of validProviders) {
                try {
                    console.log(`Trying provider: ${provider.name}`);
                    const text = await provider.execute(prompt);
                    return { text };
                } catch (err) {
                    console.error(`Provider ${provider.name} failed:`, err);
                    errors.push(`${provider.name}: ${err.message}`);
                }
            }
            
            throw new Error("Tất cả các mô hình AI đều thất bại:\n" + errors.join("\n"));
        }

        const welcomeScreen = document.getElementById('welcome-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const resultsScreen = document.getElementById('results-screen');
        const startBtn = document.getElementById('start-btn');
        const nameInput = document.getElementById('name');
        const classInput = document.getElementById('class');
        const timerEl = document.getElementById('timer');
        const submitBtn = document.getElementById('submit-btn');
        const submitBtnTop = document.getElementById('submit-btn-top');
        const scoreDisplay = document.getElementById('score-display');
        const assessmentDisplay = document.getElementById('assessment-display');
        const reviewContainer = document.getElementById('review-container');
        const retryBtn = document.getElementById('retry-btn');
        const restartBtn = document.getElementById('restart-btn');
        const warningEl = document.getElementById('monitoring-warning');
        const progressBar = document.getElementById('progress-bar');
        const progressContainer = document.getElementById('progress-container');
        const toggleNavBtn = document.getElementById('toggle-nav-btn');
        const navPanel = document.getElementById('nav-panel');
        const navGrid = document.getElementById('nav-grid');
        

        window.selectOption = selectOption;
        window.selectTFOption = selectTFOption;
        window.saveTextAnswer = saveTextAnswer;
        window.toggleExplanation = toggleExplanation;
        window.fetchAndRenderExplanation = fetchAndRenderExplanation;
        window.retryAIAssessment = retryAIAssessment;
        window.setupFormInputs = setupFormInputs;
        window.saveFormAnswer = saveFormAnswer;
        window.scrollToQuestion = scrollToQuestion;

        startBtn.addEventListener('click', startQuiz);
        submitBtn.addEventListener('click', confirmSubmit);
        submitBtnTop.addEventListener('click', confirmSubmit);
        retryBtn.addEventListener('click', retryQuiz);
        restartBtn.addEventListener('click', () => window.location.reload());
        
        toggleNavBtn.addEventListener('click', () => {
            navPanel.classList.toggle('open');
            document.body.classList.toggle('nav-open');
        });

        nameInput.value = localStorage.getItem('studentName') || '';
        classInput.value = localStorage.getItem('studentClass') || '';
        // Restore key if exists
        if (studentApiKeyInput) {
            studentApiKeyInput.value = localStorage.getItem('studentApiKey') || '';
        }
        
        function safeTypeset(elements) {
            if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                window.MathJax.typesetPromise(elements).catch(function (err) {
                    console.error('MathJax error: ' + err.message);
                });
            }
        }
        
        function startQuiz() {
            studentName = nameInput.value.trim();
            studentClass = classInput.value.trim();
            
            if (!studentName || !studentClass) {
                alert('Vui lòng nhập đầy đủ Họ và tên và Lớp.');
                return;
            }
            
            // Handle Student API Key
            if (studentApiKeyInput) {
                const studentKey = studentApiKeyInput.value.trim();
                if (studentKey) {
                    API_KEYS.gemini = studentKey; // Prioritize student key
                    localStorage.setItem('studentApiKey', studentKey);
                }
            }

            localStorage.setItem('studentName', studentName);
            localStorage.setItem('studentClass', studentClass);
            
            document.getElementById('student-name-display').textContent = studentName;

            applyShuffling();
            
            welcomeScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            resultsScreen.classList.add('hidden');
            progressContainer.classList.remove('hidden');
            toggleNavBtn.classList.remove('hidden');
            
            if (window.innerWidth > 1024) {
                navPanel.classList.add('open');
                document.body.classList.add('nav-open');
            }

            userAnswers = new Array(quizData.length).fill(null);
            submissionStatus = 'pending';
            isQuizActive = true;
            
            renderAllQuestions();
            renderNavPanel();
            updateProgress();
            
            if (options.timeLimit > 0) {
                timeRemaining = options.timeLimit * 60;
                startTimer();
            } else {
                timerEl.textContent = '∞';
            }
            startMonitoring();
        }

        function renderNavPanel() {
            navGrid.innerHTML = '';
            quizData.forEach((_, index) => {
                const btn = document.createElement('button');
                btn.className = 'nav-btn';
                btn.id = `nav-btn-${index}`;
                btn.textContent = index + 1;
                btn.onclick = () => scrollToQuestion(index);
                navGrid.appendChild(btn);
            });
        }

        function scrollToQuestion(index) {
            const el = document.getElementById(`q-${index}`);
            if (el) {
                const offset = 100; 
                const elementPosition = el.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - offset;
                window.scrollTo({ top: offsetPosition, behavior: "smooth" });
                
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('current'));
                document.getElementById(`nav-btn-${index}`)?.classList.add('current');
            }
            if (window.innerWidth <= 1024) {
                navPanel.classList.remove('open');
                document.body.classList.remove('nav-open');
            }
        }

        function updateProgress() {
            let answeredCount = 0;
            quizData.forEach((item, index) => {
                const answer = userAnswers[index];
                const type = mapType(item.type);
                let isAnswered = false;

                if (type === 'multiple-choice') {
                    isAnswered = answer !== null;
                } else if (type === 'true-false') {
                    isAnswered = Array.isArray(answer) && answer.filter(x => x !== null).length === item.statements.length;
                } else { 
                    isAnswered = answer && String(answer).trim().length > 0;
                }

                const btn = document.getElementById(`nav-btn-${index}`);
                if (isAnswered) {
                    answeredCount++;
                    btn?.classList.add('answered');
                } else {
                    btn?.classList.remove('answered');
                }
            });

            const percent = Math.round((answeredCount / quizData.length) * 100);
            progressBar.style.width = `${percent}%`;
        }
        
        function renderAllQuestions() {
            const container = document.getElementById('all-questions-container');
            let allHTML = '';

            const groupedQuestions = quizData.reduce((acc, q) => {
                const type = mapType(q.type);
                if (!acc[type]) acc[type] = [];
                acc[type].push(q);
                return acc;
            }, {});

            const groupInfo = {
                'multiple-choice': { title: 'PHẦN I. TRẮC NGHIỆM NHIỀU LỰA CHỌN', color: 'blue' },
                'true-false': { title: 'PHẦN II. TRẮC NGHIỆM ĐÚNG/SAI', color: 'purple' },
                'short-answer': { title: 'PHẦN III. TRẢ LỜI NGẮN', color: 'teal' },
                'essay': { title: 'PHẦN IV. TỰ LUẬN', color: 'orange' },
            };
            
            let questionCounter = 0;
            const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];

            partOrder.forEach(partType => {
                const questions = groupedQuestions[partType];
                if (!questions || questions.length === 0) return;

                const info = groupInfo[partType];
                allHTML += `
                    <div class="mb-6 pb-2 border-b-2 border-${info.color}-200 flex items-center gap-2">
                        <span class="bg-${info.color}-100 text-${info.color}-700 p-1.5 rounded-md">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                            </svg>
                        </span>
                        <h2 class="text-xl md:text-2xl font-bold text-gray-800">${info.title}</h2>
                    </div>`;
                
                questions.forEach((item) => {
                    const index = quizData.indexOf(item);
                    questionCounter++;
                    
                    let contentHTML = `<div class="question-card mb-8 p-6 border border-gray-200 bg-white rounded-2xl shadow-sm hover:shadow-md transition-shadow scroll-mt-32" id="q-${index}">`;
                    contentHTML += `
                        <div class="flex items-start gap-3 mb-4">
                             <span class="bg-gray-100 text-gray-700 font-bold px-3 py-1 rounded-lg text-sm shadow-sm">Câu ${questionCounter}</span>
                        </div>
                    `;
                    contentHTML += `<div class="prose max-w-none text-gray-800 mb-6 font-medium text-lg leading-relaxed">${item.rendered_question || ''}</div>`;

                    let answerHTML = '';
                    const savedAnswer = userAnswers[index];
                    const type = mapType(item.type);
                    
                    if (type === 'multiple-choice') {
                        answerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;
                        (item.rendered_options || []).forEach((opt, i) => {
                            const isSelected = savedAnswer === i;
                            answerHTML += `
                                <div class="option ${isSelected ? 'selected' : ''} p-4 border border-gray-200 rounded-xl cursor-pointer flex items-start gap-3 hover:bg-gray-50" data-q-index="${index}" data-opt-index="${i}" onclick="selectOption(this, ${index}, ${i})">
                                    <div class="flex-shrink-0 w-8 h-8 rounded-full border-2 ${isSelected ? 'border-indigo-600 bg-indigo-600 text-white' : 'border-gray-300 text-gray-500'} flex items-center justify-center font-bold text-sm transition-colors">${String.fromCharCode(65 + i)}</div>
                                    <div class="flex-grow pt-1 text-gray-700">${opt}</div>
                                </div>`;
                        });
                        answerHTML += `</div>`;
                    } else if (type === 'true-false') {
                         answerHTML = `<div class="space-y-3">`;
                         (item.statements || []).forEach((stmt, i) => {
                            const savedStmtAnswer = savedAnswer ? savedAnswer[i] : null;
                            const isTrueSelected = savedStmtAnswer === true;
                            const isFalseSelected = savedStmtAnswer === false;
                            answerHTML += `<div class="p-4 border border-gray-200 rounded-xl bg-gray-50 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                                                <div class="flex-grow flex gap-3">
                                                    <span class="font-bold text-gray-500">${String.fromCharCode(97 + i)})</span>
                                                    <div class="prose max-w-none text-gray-700">${stmt.rendered_statement}</div>
                                                </div>
                                                <div class="flex-shrink-0 flex gap-2 self-end sm:self-auto">
                                                    <button class="${isTrueSelected ? 'bg-blue-600 text-white shadow-md ring-2 ring-blue-300' : 'bg-white text-gray-600 border border-gray-300 hover:bg-blue-50'} px-5 py-2 rounded-lg font-semibold transition-all" onclick="selectTFOption(this, ${index}, ${i}, true)">Đúng</button>
                                                    <button class="${isFalseSelected ? 'bg-red-500 text-white shadow-md ring-2 ring-red-300' : 'bg-white text-gray-600 border border-gray-300 hover:bg-red-50'} px-5 py-2 rounded-lg font-semibold transition-all" onclick="selectTFOption(this, ${index}, ${i}, false)">Sai</button>
                                                </div>
                                            </div>`;
                        });
                        answerHTML += `</div>`;
                    } else if (type === 'short-answer') {
                        const savedAnswerStr = userAnswers[index] || '';
                        if (options.shortAnswerFormat === 'form') {
                             answerHTML = `<div id="sa-form-${index}" class="flex items-center gap-3 p-4 bg-teal-50 rounded-xl border border-teal-100">`;
                            for (let i = 0; i < 4; i++) {
                                answerHTML += `<input type="text" maxlength="1" data-q-index="${index}" class="w-12 h-14 text-center text-2xl font-bold border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring focus:ring-teal-200 focus:outline-none bg-white shadow-sm transition-all" value="">`;
                            }
                            answerHTML += `</div>`;
                        } else {
                            answerHTML = `<input type="text" class="w-full border-gray-300 rounded-xl p-4 shadow-sm focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all text-lg" placeholder="Nhập câu trả lời của bạn..." value="${savedAnswerStr}" onchange="saveTextAnswer(this, ${index})">`;
                        }
                    } else if (type === 'essay') {
                        answerHTML = `<textarea class="w-full border-gray-300 rounded-xl p-4 shadow-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all" rows="6" placeholder="Nhập bài làm tự luận..." onchange="saveTextAnswer(this, ${index})">${savedAnswer || ''}</textarea>`;
                    }

                    contentHTML += answerHTML + '</div>';
                    allHTML += contentHTML;
                });
            });
            container.innerHTML = allHTML;

            document.querySelectorAll('[id^="sa-form-"]').forEach(formContainer => {
                const inputs = formContainer.querySelectorAll('input');
                if (inputs.length > 0) {
                    setupFormInputs(inputs);
                }
            });

            safeTypeset([container]);
        }

        function setupFormInputs(inputs) {
            const qIndex = inputs[0].dataset.qIndex;
            inputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    if (e.target.value && index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }
                    saveFormAnswer(qIndex, inputs);
                });

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        inputs[index - 1].focus();
                    }
                     saveFormAnswer(qIndex, inputs);
                });
                 input.addEventListener('change', () => saveFormAnswer(qIndex, inputs));
            });
        }

        function saveFormAnswer(qIndex, inputs) {
            let combinedValue = '';
            inputs.forEach(inp => { combinedValue += inp.value; });
            userAnswers[qIndex] = combinedValue;
            updateProgress();
        }

        function selectOption(element, qIndex, optIndex) {
            userAnswers[qIndex] = optIndex;
            const questionCard = document.getElementById(`q-${qIndex}`);
            questionCard.querySelectorAll('.option').forEach(opt => {
                opt.classList.remove('selected');
                opt.querySelector('div:first-child').classList.remove('border-indigo-600', 'bg-indigo-600', 'text-white');
                opt.querySelector('div:first-child').classList.add('border-gray-300', 'text-gray-500');
            });
            element.classList.add('selected');
            element.querySelector('div:first-child').classList.remove('border-gray-300', 'text-gray-500');
            element.querySelector('div:first-child').classList.add('border-indigo-600', 'bg-indigo-600', 'text-white');
            updateProgress();
        }
        
        function selectTFOption(button, qIndex, stmtIndex, answer) {
            if (!userAnswers[qIndex] || !Array.isArray(userAnswers[qIndex])) {
                userAnswers[qIndex] = new Array(quizData[qIndex].statements.length).fill(null);
            }
            userAnswers[qIndex][stmtIndex] = answer;
            const parent = button.parentElement;
            
            // Reset styles
            const trueBtn = parent.children[0];
            const falseBtn = parent.children[1];
            
            trueBtn.className = 'bg-white text-gray-600 border border-gray-300 hover:bg-blue-50 px-5 py-2 rounded-lg font-semibold transition-all';
            falseBtn.className = 'bg-white text-gray-600 border border-gray-300 hover:bg-red-50 px-5 py-2 rounded-lg font-semibold transition-all';

            if (answer) {
                trueBtn.className = 'bg-blue-600 text-white shadow-md ring-2 ring-blue-300 px-5 py-2 rounded-lg font-semibold transition-all';
            } else {
                falseBtn.className = 'bg-red-500 text-white shadow-md ring-2 ring-red-300 px-5 py-2 rounded-lg font-semibold transition-all';
            }
            updateProgress();
        }
        
        function saveTextAnswer(element, qIndex) {
            userAnswers[qIndex] = element.value;
            updateProgress();
        }

        function confirmSubmit() {
            const unansweredQuestions = userAnswers.map((answer, index) => ({ answer, index }))
                                                .filter(item => item.answer === null || 
                                                                (Array.isArray(item.answer) && item.answer.some(a => a === null)));

            let message = "Bạn có chắc chắn muốn nộp bài không?";
            if (unansweredQuestions.length > 0) {
                message = `Bạn còn ${unansweredQuestions.length} câu chưa hoàn thành. Bạn có chắc chắn muốn nộp bài không?`;
            }

            if (confirm(message)) {
                submitQuiz();
            }
        }

        async function submitQuiz() {
            if (submissionStatus !== 'pending') return;
            submissionStatus = 'submitting';
            stopTimer();
            stopMonitoring();
            isQuizActive = false;
            
            const submitBtnEl = document.getElementById('submit-btn');
            submitBtnEl.disabled = true;
            submitBtnEl.innerHTML = '<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Đang nộp bài...';
            
            progressContainer.classList.add('hidden');
            toggleNavBtn.classList.add('hidden');
            navPanel.classList.remove('open');
            document.body.classList.remove('nav-open');

            const { score, totalPossibleScore, answerDetails } = calculateScore();
            lastScore = score;
            lastAnswerDetails = answerDetails;
            const finalScore = (totalPossibleScore > 0 ? (score / totalPossibleScore * 10) : 0).toFixed(2);
            let aiAssessment = 'Không có';

            if (options.aiAssessment) {
                aiAssessment = await getAIAssessment(finalScore, answerDetails);
            }
            
            const submissionData = new FormData();
            submissionData.append('timestamp', new Date().toLocaleString('vi-VN'));
            submissionData.append('name', studentName);
            submissionData.append('class', studentClass);
            submissionData.append('score', finalScore);
            submissionData.append('assessment', aiAssessment);
            submissionData.append('examCode', examCode);
            submissionData.append('monitoringLog', JSON.stringify(monitoringLog));
            submissionData.append('answerDetails', JSON.stringify(answerDetails));
            
            if (googleScriptUrl) {
                try {
                    await fetch(googleScriptUrl, { method: 'POST', body: new URLSearchParams(submissionData) });
                } catch (error) {
                    console.error('Error submitting to Google Script:', error);
                    alert('Lỗi: Không thể nộp kết quả lên hệ thống. Vui lòng kiểm tra lại kết nối mạng và thử lại.');
                }
            }
            submissionStatus = 'submitted';
            showResults(finalScore, aiAssessment, answerDetails);
        }
        
        function showResults(score, assessment, answerDetails) {
            quizScreen.classList.add('hidden');
            resultsScreen.classList.remove('hidden');
            
            // Trigger Confetti
            confetti({
                particleCount: 150,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#6366f1', '#8b5cf6', '#ec4899', '#14b8a6']
            });
            
            if (options.showAnswers) {
                const scoreDisplay = document.getElementById('score-display');
                scoreDisplay.querySelector('span:last-child').textContent = score;
                scoreDisplay.classList.remove('hidden');
            } else {
                const scoreDisplay = document.getElementById('score-display');
                scoreDisplay.innerHTML = '<p class="text-3xl text-center text-green-600 font-bold mb-4">Nộp bài thành công!</p><p class="text-gray-500">Kết quả đã được ghi nhận.</p>';
                scoreDisplay.classList.remove('hidden');
            }
            
            if (options.aiAssessment) {
                if (assessment.startsWith("Lỗi")) {
                    // handled
                } else {
                     document.querySelector('#assessment-display .assessment-content').innerHTML = assessment.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                     assessmentDisplay.classList.remove('hidden');
                }
            } else {
                assessmentDisplay.classList.add('hidden');
            }
            
            if (options.showAnswers) {
                renderReview(answerDetails);
            } else {
                reviewContainer.innerHTML = '<div class="text-center p-8 bg-gray-50 rounded-xl border border-gray-200"><p class="text-gray-600">Giáo viên đã chọn không hiển thị đáp án và giải thích chi tiết.</p></div>';
            }
            
            if (retriesCount < options.retriesAllowed) retryBtn.classList.remove('hidden');
        }

        function calculateScore() {
            let score = 0;
            let totalPossibleScore = 0;
            const answerDetails = [];
            
            const mcCount = quizData.filter(q => mapType(q.type) === 'multiple-choice').length;
            const tfCount = quizData.filter(q => mapType(q.type) === 'true-false').length;
            const saCount = quizData.filter(q => mapType(q.type) === 'short-answer').length;

            const pointsPerMc = mcCount > 0 ? options.scoring.mc / mcCount : 0;
            const pointsPerTf = tfCount > 0 ? options.scoring.tf / tfCount : 0;
            const pointsPerSa = saCount > 0 ? options.scoring.sa / saCount : 0;
            
            totalPossibleScore = (options.scoring.mc || 0) + (options.scoring.tf || 0) + (options.scoring.sa || 0) + (options.scoring.essay || 0);
            if (totalPossibleScore === 0 && (mcCount + tfCount + saCount > 0)) {
                 totalPossibleScore = (pointsPerMc * mcCount) + (pointsPerTf * tfCount) + (pointsPerSa * saCount);
            }
            if (totalPossibleScore === 0 && quizData.length > 0) totalPossibleScore = 10; 

            quizData.forEach((item, index) => {
                const userAnswer = userAnswers[index];
                let isCorrect = false;
                let detail = null;
                const type = mapType(item.type);

                if (type === 'multiple-choice') {
                    isCorrect = userAnswer === item.correctAnswerIndex;
                    if(isCorrect) score += pointsPerMc;
                } else if (type === 'true-false') {
                    let correctStatements = 0;
                    detail = [];
                    (item.statements || []).forEach((stmt, i) => {
                        const isStmtCorrect = (userAnswer && userAnswer[i] === stmt.is_correct);
                        if(isStmtCorrect) correctStatements++;
                        detail.push({isCorrect: isStmtCorrect});
                    });

                    if (options.scoring.tfMethod === 'even') {
                        score += (correctStatements / 4) * pointsPerTf;
                    } else { // progressive
                        if (correctStatements === 4) score += pointsPerTf;
                        else if (correctStatements === 3) score += 0.5 * pointsPerTf;
                        else if (correctStatements === 2) score += 0.25 * pointsPerTf;
                        else if (correctStatements === 1) score += 0.1 * pointsPerTf;
                    }
                    isCorrect = correctStatements === 4;
                } else if (type === 'short-answer') {
                    const correctAnswer = (item.answer || '').toString().trim().toLowerCase();
                    const studentAnswer = (userAnswer || '').toString().trim().toLowerCase();
                    isCorrect = studentAnswer === correctAnswer;
                    if (isCorrect) {
                        score += pointsPerSa;
                    }
                } else {
                    isCorrect = null; // For 'essay' type
                }
                answerDetails.push({ questionNumber: index + 1, isCorrect, type, details: detail });
            });
            return { score, totalPossibleScore, answerDetails };
        }
        
        function renderReview(answerDetails) {
            let reviewHTML = '<h3 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-2">Xem lại bài làm chi tiết</h3>';
            quizData.forEach((item, index) => {
                const type = mapType(item.type);
                const detail = answerDetails.find(d => d.questionNumber === index + 1);
                const isCorrectQuestion = detail?.isCorrect;

                let borderColor = isCorrectQuestion ? 'border-green-200' : (isCorrectQuestion === false ? 'border-red-200' : 'border-gray-200');
                let bgColor = isCorrectQuestion ? 'bg-green-50' : (isCorrectQuestion === false ? 'bg-red-50' : 'bg-gray-50');
                
                reviewHTML += `<div class="mb-8 p-6 border ${borderColor} rounded-2xl ${bgColor} shadow-sm relative overflow-hidden">`;
                
                // Status Badge
                if (type !== 'essay') {
                     reviewHTML += `<div class="absolute top-0 right-0 px-3 py-1 text-xs font-bold uppercase tracking-wider rounded-bl-lg ${isCorrectQuestion ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}">${isCorrectQuestion ? 'Đúng' : 'Sai'}</div>`;
                }

                reviewHTML += `<div class="flex gap-2 mb-3"><span class="bg-white border border-gray-200 text-gray-700 font-bold px-2.5 py-0.5 rounded-md text-sm">Câu ${index + 1}</span></div>`;
                reviewHTML += `<div class="prose max-w-none mb-4 text-gray-800">${item.rendered_question}</div>`;

                if (type === 'multiple-choice') {
                     reviewHTML += '<div class="space-y-2">';
                     (item.rendered_options || []).forEach((opt, i) => {
                        let classes = 'p-3 border rounded-lg flex items-start gap-3';
                        let icon = '';
                        
                        if (i === item.correctAnswerIndex) {
                            classes += ' bg-green-100 border-green-400 ring-1 ring-green-400'; // Correct answer style
                            icon = '<svg class="w-5 h-5 text-green-600 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>';
                        } else if (userAnswers[index] === i) {
                            classes += ' bg-red-100 border-red-400'; // Selected wrong answer
                            icon = '<svg class="w-5 h-5 text-red-600 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>';
                        } else {
                            classes += ' bg-white border-gray-200 opacity-70';
                        }

                        reviewHTML += `<div class="${classes}">
                            <span class="font-bold flex-shrink-0 w-6">${String.fromCharCode(65 + i)}.</span>
                            <div class="flex-grow">${opt}</div>
                            ${icon}
                        </div>`;
                     });
                     reviewHTML += '</div>';
                } else if (type === 'true-false') {
                     reviewHTML += '<div class="space-y-2 mt-4">';
                     (item.statements || []).forEach((stmt, i) => {
                         const userChoice = userAnswers[index] ? userAnswers[index][i] : null;
                         const isStmtCorrect = userChoice === stmt.is_correct;
                         let classes = 'p-3 border rounded-lg flex items-center justify-between gap-4 bg-white';
                         
                         if (userChoice !== null) {
                            classes = isStmtCorrect ? 'p-3 border border-green-300 bg-green-100 rounded-lg flex items-center justify-between gap-4' : 'p-3 border border-red-300 bg-red-100 rounded-lg flex items-center justify-between gap-4';
                         }

                         reviewHTML += `<div class="${classes}">
                                         <div class="prose max-w-none text-sm">${stmt.rendered_statement}</div>
                                         <div class="flex-shrink-0 text-right text-sm">
                                             <div class="${stmt.is_correct ? 'text-green-700 font-bold' : 'text-red-700 font-bold'}">Đáp án: ${stmt.is_correct ? 'Đúng' : 'Sai'}</div>
                                             <div class="text-gray-600">Bạn chọn: <span class="font-medium">${userChoice === true ? 'Đúng' : userChoice === false ? 'Sai' : '...'}</span></div>
                                         </div>
                                     </div>`;
                     });
                     reviewHTML += '</div>';
                } else {
                    reviewHTML += `<div class="mt-4 p-4 bg-white border border-gray-200 rounded-xl">
                        <p class="text-sm font-bold text-gray-500 mb-1">Câu trả lời của bạn:</p>
                        <div class="text-gray-800">${userAnswers[index] || '<em class="text-gray-400">Chưa trả lời</em>'}</div>
                    </div>`;
                    if (item.rendered_answer) {
                        reviewHTML += `<div class="mt-3 p-4 bg-green-50 border border-green-200 rounded-xl">
                            <p class="text-sm font-bold text-green-700 mb-1">Đáp án gợi ý:</p>
                            <div class="prose max-w-none text-green-900">${item.rendered_answer}</div>
                        </div>`;
                    }
                }
                
                if (options.showExplanation) {
                     reviewHTML += `<div class="mt-4 pt-4 border-t border-gray-200/50">
                                      <button class="flex items-center gap-1 text-sm font-semibold text-indigo-600 hover:text-indigo-800 transition-colors" onclick="toggleExplanation(${index}, this)">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                        Xem giải thích chi tiết từ AI
                                      </button>
                                      <div id="explanation-${index}" class="mt-3 p-4 bg-indigo-50 border border-indigo-100 rounded-xl hidden text-sm text-gray-700 leading-relaxed"></div>
                                   </div>`;
                }
                reviewHTML += '</div>';
            });
            reviewContainer.innerHTML = reviewHTML;
            safeTypeset([reviewContainer]);
        }

        function retryQuiz() {
            retriesCount++;
            startQuiz();
        }
        
        function startTimer() {
            stopTimer();
            timerInterval = setInterval(() => {
                timeRemaining--;
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                if (timeRemaining <= 0) {
                    stopTimer();
                    alert('Đã hết thời gian làm bài!');
                    submitQuiz();
                }
            }, 1000);
        }

        function stopTimer() { clearInterval(timerInterval); }
        
        function showWarning(message) {
            warningEl.textContent = message;
            warningEl.style.display = 'block';
            warningEl.style.animation = 'none';
            warningEl.offsetHeight; 
            warningEl.style.animation = 'fade-in-out 5s ease-in-out';
        }

        function handleVisibilityChange() {
            if (document.hidden) {
                monitoringLog.thoatManHinh++;
                showWarning('⚠️ Đã phát hiện chuyển tab hoặc thu nhỏ cửa sổ!');
            }
        }
        function handleCopy() { monitoringLog.saoChep++; showWarning('⚠️ Đã phát hiện hành vi sao chép!'); }
        function handlePaste() { monitoringLog.dan++; showWarning('⚠️ Đã phát hiện hành vi dán!'); }
        function startMonitoring() {
            monitoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0 };
            document.addEventListener('visibilitychange', handleVisibilityChange);
            document.addEventListener('copy', handleCopy);
            document.addEventListener('paste', handlePaste);
        }
        function stopMonitoring() {
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            document.removeEventListener('copy', handleCopy);
            document.removeEventListener('paste', handlePaste);
        }

        async function toggleExplanation(index, button) {
            const explanationContainer = document.getElementById(`explanation-${index}`);
            if (!explanationContainer) return;

            const isHidden = explanationContainer.classList.toggle('hidden');
            button.innerHTML = isHidden 
                ? '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> Xem giải thích chi tiết từ AI' 
                : '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" /></svg> Ẩn giải thích';

            const hasLoaded = explanationContainer.hasAttribute('data-loaded');
            const hadError = explanationContainer.getAttribute('data-loaded') === 'error';

            if (!isHidden && (!hasLoaded || hadError)) {
                await fetchAndRenderExplanation(index);
            }
        }

        async function fetchAndRenderExplanation(index) {
            const explanationContainer = document.getElementById(`explanation-${index}`);
            explanationContainer.innerHTML = '<div class="flex items-center gap-2 text-indigo-500"><svg class="animate-spin h-4 w-4" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> AI đang soạn lời giải...</div>';
            explanationContainer.setAttribute('data-loaded', 'loading');

            try {
                const item = quizData[index];
                const questionText = (mapType(item.type) === 'true-false') ? (item.main_question || '') : (item.question || '');
                let prompt = `Bạn là một trợ lý giáo viên AI xuất sắc. Hãy viết lời giải chi tiết, dễ hiểu cho câu hỏi này.\n---\nCÂU HỎI:\n${questionText}\n---`;
                
                if (mapType(item.type) === 'multiple-choice') {
                    prompt += `\n**ĐÁP ÁN ĐÚNG:** ${String.fromCharCode(65 + item.correctAnswerIndex)}. ${item.options[item.correctAnswerIndex] || ''}`;
                } else if (mapType(item.type) === 'true-false') {
                    prompt += `\n**CÁC MỆNH ĐỀ VÀ ĐÁP ÁN:**\n${item.statements.map((s, i) => `${String.fromCharCode(97 + i)}) ${s.statement || ''} -> ${s.is_correct ? 'Đúng' : 'Sai'}`).join('\n')}`;
                } else {
                    prompt += `---\n**ĐÁP ÁN / GỢI Ý:** ${item.answer || ''}`;
                }
                prompt += `\n---\n**YÊU CẦU:** Giải thích từng bước logic. Định dạng công thức toán bằng LaTeX (trong dấu $). Dùng **...** để in đậm các ý quan trọng.`;
                
                const response = await generateContentWithSmartFallback(prompt);
                const explanationText = response.text || "Không thể tạo giải thích.";
                
                let htmlContent = explanationText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                explanationContainer.innerHTML = htmlContent;
                safeTypeset([explanationContainer]);
                explanationContainer.setAttribute('data-loaded', 'true');

            } catch (error) {
                console.error("AI Explanation Error:", error);
                explanationContainer.innerHTML = `<div class="text-red-600 text-sm">Đã xảy ra lỗi khi tải lời giải. ${error.message}. <button onclick="event.preventDefault(); fetchAndRenderExplanation(${index})" class="underline font-semibold ml-1">Thử lại</button></div>`;
                explanationContainer.setAttribute('data-loaded', 'error');
            }
        }

        async function getAIAssessment(score, answerDetails) {
            document.querySelector('#assessment-display .assessment-content').innerHTML = '<div class="flex items-center gap-2 text-indigo-600"><svg class="animate-spin h-5 w-5" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> AI đang phân tích bài làm của bạn...</div>';
            assessmentDisplay.classList.remove('hidden');

            try {
                const wrongAnswers = answerDetails.filter(d => d.isCorrect === false || (d.type === 'true-false' && d.details && d.details.some(sub => !sub.isCorrect)));
                if (wrongAnswers.length === 0) {
                    const congrats = "Tuyệt vời! Em đã làm bài xuất sắc và không sai câu nào. Kiến thức của em rất vững vàng. Hãy tiếp tục duy trì phong độ này nhé! 🌟";
                    document.querySelector('#assessment-display .assessment-content').innerHTML = congrats;
                    return congrats;
                }
                const wrongQuestionsSummary = wrongAnswers.map(d => {
                    const item = quizData[d.questionNumber - 1];
                    const questionText = item.question || item.main_question || '';
                    return `- Câu ${d.questionNumber}: ${questionText}`;
                }).join('\n');
                
                const prompt = `Bạn là một giáo viên AI tâm lý và tận tụy. Dựa vào kết quả bài làm sau, hãy viết một đoạn nhận xét ngắn gọn (khoảng 100 từ) cho học sinh.\n**Kết quả:**\n- Điểm số: ${score} / 10\n- Các câu làm sai (nội dung tóm tắt):\n${wrongQuestionsSummary}\n**YÊU CẦU:**\n1. Bắt đầu bằng lời khen ngợi nỗ lực.\n2. Chỉ ra các mảng kiến thức cần ôn tập lại dựa trên các câu sai.\n3. Đưa ra 1 lời khuyên cụ thể để cải thiện.\n4. Kết thúc bằng lời động viên ấm áp.\n5. Sử dụng icon cảm xúc phù hợp.`;

                const response = await generateContentWithSmartFallback(prompt);
                const assessmentText = response.text || "Không thể tạo nhận xét.";
                
                document.querySelector('#assessment-display .assessment-content').innerHTML = assessmentText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                return assessmentText;

            } catch (error) {
                console.error("AI Assessment Error:", error);
                document.querySelector('#assessment-display .assessment-content').innerHTML = `<div class="text-red-600">Lỗi kết nối với AI: ${error.message}. <button onclick="retryAIAssessment()" class="underline font-bold ml-1">Thử lại</button></div>`;
                return "Lỗi khi tạo nhận xét AI.";
            }
        }
        
        async function retryAIAssessment() {
            if (lastAnswerDetails) {
                const finalScore = (lastScore / (quizData.length > 0 ? 10 : 1) * 10).toFixed(2);
                await getAIAssessment(finalScore, lastAnswerDetails);
            }
        }
    </script>
</body>
</html>
    