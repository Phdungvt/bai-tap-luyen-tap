
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bài kiểm tra - 10/12/2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%); min-height: 100vh; }
        .option { transition: all 0.2s ease; }
        .option:hover { background-color: #f3f4f6; }
        .option.selected { border-color: #4f46e5; background-color: #eef2ff; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2); }
        .option.correct { border-color: #22c55e; background-color: #f0fdf4; }
        .option.incorrect { border-color: #ef4444; background-color: #fef2f2; }
        .disabled { pointer-events: none; opacity: 0.7; }
        .monitoring-warning { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: #ef4444; color: white; padding: 12px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 1000; display: none; font-weight: bold; animation: fade-in-out 5s ease-in-out; }
        @keyframes fade-in-out { 0%, 100% { opacity: 0; transform: translate(-50%, -20px); } 10%, 90% { opacity: 1; transform: translate(-50%, 0); } }
        /* MathJax basic styling */
        mjx-container { display: inline-block !important; }
        .prose img.latex-image { display: inline-block; vertical-align: middle; }
        
        /* Progress Bar */
        .progress-container { position: fixed; top: 0; left: 0; width: 100%; height: 4px; background: #e5e7eb; z-index: 50; }
        .progress-bar { height: 100%; background: #4f46e5; transition: width 0.3s; width: 0%; }

        /* Navigation Panel */
        .nav-panel {
            position: fixed; right: 0; top: 0; bottom: 0; width: 280px;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            box-shadow: -4px 0 15px rgba(0,0,0,0.05);
            z-index: 40; overflow-y: auto; padding-top: 60px;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .nav-panel.open { transform: translateX(0); }
        .nav-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; padding: 16px; }
        .nav-btn {
            width: 40px; height: 40px; border-radius: 8px; border: 1px solid #e5e7eb;
            background: white; color: #4b5563; font-size: 14px; font-weight: 600;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .nav-btn:hover { border-color: #6366f1; color: #6366f1; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .nav-btn.answered { background-color: #6366f1; color: white; border-color: #6366f1; }
        .nav-btn.current { border-color: #f59e0b; color: #f59e0b; border-width: 2px; background-color: #fffbeb; }

        /* Layout Adjustment for Nav Panel */
        #app { transition: margin-right 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        body.nav-open #app { margin-right: 280px; }
        
        @media (max-width: 1024px) {
            body.nav-open #app { margin-right: 0; } /* On mobile, nav covers content */
        }

        #toggle-nav-btn {
            position: fixed; right: 24px; bottom: 24px; width: 56px; height: 56px;
            background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; border-radius: 50%;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
            display: flex; align-items: center; justify-content: center;
            z-index: 50; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
        }
        #toggle-nav-btn:hover { transform: scale(1.05); box-shadow: 0 6px 16px rgba(79, 70, 229, 0.5); }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        .question-card { transition: box-shadow 0.3s; }
        .question-card:hover { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.01); }
    </style>
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$']], displayMath: [['$$', '$$']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    <script type="importmap">
    { "imports": { 
        "@google/genai": "https://esm.sh/@google/genai@^1.13.0",
        "canvas-confetti": "https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/+esm"
    } }
    </script>
</head>
<body class="p-4 md:p-6">
    <div id="progress-container" class="progress-container hidden"><div id="progress-bar" class="progress-bar"></div></div>
    
    <button id="toggle-nav-btn" class="hidden" title="Danh sách câu hỏi">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" />
        </svg>
    </button>

    <div id="nav-panel" class="nav-panel">
        <div class="px-4 py-3 border-b bg-gray-50 sticky top-0 z-10">
            <h3 class="font-bold text-gray-800 text-lg">Danh sách câu hỏi</h3>
            <div class="flex items-center gap-4 mt-3 text-sm text-gray-600">
                <div class="flex items-center gap-1.5"><div class="w-3 h-3 border rounded bg-white"></div> Chưa làm</div>
                <div class="flex items-center gap-1.5"><div class="w-3 h-3 rounded bg-indigo-500"></div> Đã làm</div>
            </div>
        </div>
        <div id="nav-grid" class="nav-grid pb-20"></div>
    </div>

    <div id="app" class="max-w-5xl mx-auto transition-all duration-300">
        
        <div id="welcome-screen" class="bg-white rounded-2xl shadow-xl overflow-hidden max-w-2xl mx-auto mt-10">
            <div class="bg-gradient-to-r from-indigo-600 to-violet-600 p-8 text-center text-white relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9IiNmZmYiLz48L3N2Zz4=')]"></div>
                <h1 class="text-2xl md:text-3xl font-bold mb-2 relative z-10">Bài kiểm tra - 10/12/2025</h1>
                <p class="text-indigo-100 text-sm md:text-base relative z-10">Mã đề: <span class="font-mono font-bold bg-white/20 px-2 py-1 rounded text-white">J6GCTB</span></p>
                 <div class="mt-4 inline-flex items-center bg-white/10 backdrop-blur-sm px-4 py-2 rounded-full relative z-10">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd" />
                    </svg>
                    <span>Giáo viên: <span class="font-bold text-yellow-300">Đàng Năng Nhanh</span></span>
                </div>
            </div>
            <div class="p-8">
                <div class="space-y-5">
                    <div>
                        <label for="name" class="block text-sm font-semibold text-gray-700 mb-1">Họ và tên học sinh</label>
                        <input type="text" id="name" class="w-full border-gray-300 rounded-lg shadow-sm py-3 px-4 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all text-gray-800 placeholder-gray-400" placeholder="Nhập họ tên của bạn...">
                    </div>
                    <div>
                        <label for="class" class="block text-sm font-semibold text-gray-700 mb-1">Lớp</label>
                        <input type="text" id="class" class="w-full border-gray-300 rounded-lg shadow-sm py-3 px-4 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all text-gray-800 placeholder-gray-400" placeholder="Ví dụ: 12A1">
                    </div>
                    
                    <!-- API Key Input for Students -->
                    <div id="api-key-input-container" class="hidden mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <label class="block text-sm font-semibold text-blue-800 mb-2">
                            Gemini API Key <span class="font-normal text-gray-600">(Yêu cầu để xem lời giải/nhận xét AI)</span>
                        </label>
                        <div class="flex gap-2">
                            <input type="password" id="student-api-key" class="flex-grow border-gray-300 rounded-lg shadow-sm py-2 px-3 text-sm focus:ring-blue-500 focus:border-blue-500 placeholder-gray-400" placeholder="Nhập API Key của bạn (bắt đầu bằng AIza...)">
                            <a href="https://aistudio.google.com/app/apikey" target="_blank" class="flex-shrink-0 bg-white text-blue-600 border border-blue-300 hover:bg-blue-50 font-semibold py-2 px-4 rounded-lg text-sm flex items-center transition-colors whitespace-nowrap">
                                Lấy Key miễn phí
                            </a>
                        </div>
                         <p class="text-xs text-gray-500 mt-2">
                            * Sử dụng Key cá nhân giúp bạn trải nghiệm đầy đủ các tính năng AI mà không bị gián đoạn.
                        </p>
                    </div>
                </div>
                 <div class="mt-6 bg-amber-50 border-l-4 border-amber-400 p-4 rounded-r-lg">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-amber-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-amber-700">
                                <span class="font-bold">Lưu ý:</span> Hệ thống sẽ giám sát việc chuyển tab, sao chép/dán. Các hành vi này sẽ được ghi lại và báo cáo cho giáo viên.
                            </p>
                        </div>
                    </div>
                </div>
                <button id="start-btn" class="mt-8 w-full bg-gradient-to-r from-indigo-600 to-violet-600 text-white py-3.5 px-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl hover:translate-y-[-2px] transition-all flex items-center justify-center gap-2">
                    <span>Bắt đầu làm bài</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>

        <div id="quiz-screen" class="hidden">
             <div class="sticky top-0 z-30 -mx-4 md:-mx-6 mb-6">
                 <div class="bg-white/90 backdrop-blur-md shadow-md border-b border-gray-200 py-3 px-4 md:px-8 flex justify-between items-center">
                    <div>
                         <h2 class="text-lg md:text-xl font-bold text-gray-800 truncate max-w-[200px] md:max-w-md">Bài kiểm tra - 10/12/2025</h2>
                         <p class="text-xs text-gray-500 hidden md:block">Thí sinh: <span id="student-name-display" class="font-semibold"></span></p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div id="timer" class="text-lg md:text-xl font-mono font-bold text-red-600 bg-red-50 px-3 py-1.5 rounded-lg border border-red-100 min-w-[80px] text-center shadow-sm"></div>
                        <button id="submit-btn-top" class="md:hidden bg-green-600 text-white px-3 py-1.5 rounded-lg text-sm font-semibold shadow-sm">Nộp</button>
                    </div>
                 </div>
            </div>
            
            <div id="all-questions-container" class="space-y-6 pb-10"></div>
            
            <div class="mt-8 flex justify-end sticky bottom-4 z-20">
                <div class="bg-white/80 backdrop-blur p-2 rounded-2xl shadow-lg border border-gray-100">
                    <button id="submit-btn" class="bg-gradient-to-r from-emerald-500 to-green-600 text-white py-3 px-8 rounded-xl font-bold text-lg shadow-md hover:shadow-lg hover:from-emerald-600 hover:to-green-700 transition-all flex items-center gap-2">
                        <span>Nộp bài</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div id="results-screen" class="hidden max-w-3xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="bg-gradient-to-r from-blue-500 to-cyan-500 p-8 text-center text-white">
                <h2 class="text-3xl font-bold mb-2">Kết quả bài làm</h2>
                <p class="opacity-90">Chúc mừng bạn đã hoàn thành bài thi!</p>
            </div>
            <div class="p-8">
                <div id="score-display" class="hidden flex flex-col items-center justify-center my-4">
                    <span class="text-gray-500 text-lg uppercase tracking-widest font-semibold mb-2">Tổng điểm</span>
                    <span class="text-6xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-br from-blue-600 to-cyan-500 drop-shadow-sm"></span>
                </div>
                
                <div id="assessment-display" class="hidden mt-6 p-6 bg-indigo-50 border border-indigo-100 rounded-xl text-gray-700 shadow-inner relative">
                     <div class="absolute top-0 left-0 w-1 h-full bg-indigo-400 rounded-l-xl"></div>
                     <h3 class="font-bold text-indigo-800 mb-2 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z" />
                            <path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z" />
                        </svg>
                        Nhận xét từ AI Giáo viên
                     </h3>
                     <div class="assessment-content prose prose-indigo max-w-none"></div>
                </div>

                <div id="review-container" class="mt-10 border-t pt-8"></div>
                
                <div class="mt-10 flex flex-col sm:flex-row justify-center gap-4">
                    <button id="retry-btn" class="hidden bg-white text-indigo-600 border-2 border-indigo-600 py-3 px-6 rounded-xl font-bold hover:bg-indigo-50 transition-colors">Làm lại bài</button>
                    <button id="restart-btn" class="bg-gray-800 text-white py-3 px-6 rounded-xl font-bold hover:bg-gray-900 transition-colors shadow-md">Về trang chủ</button>
                </div>
            </div>
        </div>
        
        <div id="monitoring-warning" class="monitoring-warning">⚠️ Đã phát hiện hành vi không hợp lệ!</div>
    </div>

    <script type="module">
        import { GoogleGenAI } from "@google/genai";
        import confetti from "https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/+esm";

        // Decode keys at runtime to bypass GitHub secret scanning
        const _k = {"gemini":"QUl6YVN5QXlSYm90bGw2LXJUTnI0LXpsNWR6SjFRMnhGb2J0aVhz","openai":"c2stcHJvai1OZW1Nd2l4RG95N1N1cEVJeXo5SDl4V2pRWmVjeFNSU1pTRnNmX3VyQ3pGOTF0WmVkMXF6eV9GckhzeUxDb3lkMGs0VXdUazRNcVQzQmxia0ZKVjNrSi1oaEY0eXZ4SGZ4M29pV1RkTkFaUUoxYlE4a1I2UlNYX0pNRW5rRUI3VmxuWWVUakZzZGF2aS1KM3NCT1pVTjFQVl8xWUE=","deepseek":""};
        const API_KEYS = {
            gemini: atob(_k.gemini),
            openai: atob(_k.openai),
            deepseek: atob(_k.deepseek)
        };
        
        let quizData = [{"question":"Trong phần mềm bảng tính, chức năng nào giúp người dùng tổ chức lại dữ liệu theo một thứ tự nhất định (ví dụ: tăng dần hoặc giảm dần)?","options":["Chức năng lọc dữ liệu.","Chức năng định dạng dữ liệu.","Chức năng sắp xếp dữ liệu.","Chức năng tìm kiếm dữ liệu."],"correctAnswerIndex":2,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Trong phần mềm bảng tính, chức năng nào giúp người dùng tổ chức lại dữ liệu theo một thứ tự nhất định (ví dụ: tăng dần hoặc giảm dần)?","rendered_options":["Chức năng lọc dữ liệu.","Chức năng định dạng dữ liệu.","Chức năng sắp xếp dữ liệu.","Chức năng tìm kiếm dữ liệu."]},{"question":"Trong phần mềm bảng tính, chức năng sắp xếp dữ liệu (Sort) có mục đích chính là gì?","options":["Ẩn đi những hàng dữ liệu không thỏa mãn một điều kiện nào đó.","Chỉ hiển thị những hàng dữ liệu đáp ứng tiêu chí đã cho.","Sắp xếp các hàng dữ liệu theo một thứ tự xác định (tăng dần hoặc giảm dần) dựa trên giá trị của một cột.","Thay đổi kích thước và kiểu chữ của dữ liệu trong bảng."],"correctAnswerIndex":2,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Trong phần mềm bảng tính, chức năng sắp xếp dữ liệu (Sort) có mục đích chính là gì?","rendered_options":["Ẩn đi những hàng dữ liệu không thỏa mãn một điều kiện nào đó.","Chỉ hiển thị những hàng dữ liệu đáp ứng tiêu chí đã cho.","Sắp xếp các hàng dữ liệu theo một thứ tự xác định (tăng dần hoặc giảm dần) dựa trên giá trị của một cột.","Thay đổi kích thước và kiểu chữ của dữ liệu trong bảng."]},{"question":"Mục đích chính của việc trực quan hoá dữ liệu bằng biểu đồ trong phần mềm bảng tính là gì?","options":["Để lưu trữ dữ liệu hiệu quả hơn.","Để nhập dữ liệu nhanh hơn.","Để trình bày dữ liệu một cách trực quan, dễ hiểu và dễ phân tích.","Để mã hoá dữ liệu, tăng cường bảo mật."],"correctAnswerIndex":2,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Mục đích chính của việc trực quan hoá dữ liệu bằng biểu đồ trong phần mềm bảng tính là gì?","rendered_options":["Để lưu trữ dữ liệu hiệu quả hơn.","Để nhập dữ liệu nhanh hơn.","Để trình bày dữ liệu một cách trực quan, dễ hiểu và dễ phân tích.","Để mã hoá dữ liệu, tăng cường bảo mật."]},{"question":"Trong phần mềm bảng tính, việc sử dụng biểu đồ để trực quan hóa dữ liệu mang lại lợi ích chính nào?","options":["Giúp bảng tính trở nên phức tạp hơn, khó đọc hơn.","Tiết kiệm không gian lưu trữ dữ liệu.","Trình bày dữ liệu một cách sinh động, dễ hiểu, giúp người xem nhanh chóng nhận biết xu hướng và so sánh thông tin.","Tự động chỉnh sửa các lỗi trong dữ liệu gốc."],"correctAnswerIndex":2,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Trong phần mềm bảng tính, việc sử dụng biểu đồ để trực quan hóa dữ liệu mang lại lợi ích chính nào?","rendered_options":["Giúp bảng tính trở nên phức tạp hơn, khó đọc hơn.","Tiết kiệm không gian lưu trữ dữ liệu.","Trình bày dữ liệu một cách sinh động, dễ hiểu, giúp người xem nhanh chóng nhận biết xu hướng và so sánh thông tin.","Tự động chỉnh sửa các lỗi trong dữ liệu gốc."]},{"question":"Để thay đổi kích thước của một hình ảnh đã chèn vào văn bản trong phần mềm soạn thảo văn bản, người dùng thường thực hiện thao tác nào sau đây?","options":["Nhấn đúp chuột vào hình ảnh.","Kéo các điểm neo (sizing handles) ở các góc hoặc cạnh của hình ảnh.","Nhấn tổ hợp phím Ctrl + Z.","Chọn hình ảnh và nhấn phím Delete."],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Để thay đổi kích thước của một hình ảnh đã chèn vào văn bản trong phần mềm soạn thảo văn bản, người dùng thường thực hiện thao tác nào sau đây?","rendered_options":["Nhấn đúp chuột vào hình ảnh.","Kéo các điểm neo (sizing handles) ở các góc hoặc cạnh của hình ảnh.","Nhấn tổ hợp phím Ctrl + Z.","Chọn hình ảnh và nhấn phím Delete."]},{"question":"Trong phần mềm soạn thảo văn bản, việc sử dụng danh sách dạng liệt kê (bulleted list hoặc numbered list) có mục đích chính là gì?","options":["Để trang trí văn bản thêm đẹp mắt với nhiều biểu tượng khác nhau.","Để giúp người đọc dễ dàng theo dõi và nắm bắt các ý chính một cách có tổ chức, rõ ràng.","Để tăng kích thước tệp của tài liệu, giúp lưu trữ nhiều thông tin hơn.","Để thay đổi kiểu chữ và màu sắc của toàn bộ đoạn văn bản."],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Trong phần mềm soạn thảo văn bản, việc sử dụng danh sách dạng liệt kê (bulleted list hoặc numbered list) có mục đích chính là gì?","rendered_options":["Để trang trí văn bản thêm đẹp mắt với nhiều biểu tượng khác nhau.","Để giúp người đọc dễ dàng theo dõi và nắm bắt các ý chính một cách có tổ chức, rõ ràng.","Để tăng kích thước tệp của tài liệu, giúp lưu trữ nhiều thông tin hơn.","Để thay đổi kiểu chữ và màu sắc của toàn bộ đoạn văn bản."]},{"question":"Chức năng đầu trang (Header) và chân trang (Footer) trong phần mềm soạn thảo văn bản giúp người dùng thực hiện điều gì?","options":["Chèn hình ảnh vào giữa các đoạn văn bản.","Đánh số trang, thêm tiêu đề, ngày tháng hoặc thông tin tác giả xuất hiện ở mỗi trang văn bản.","Thay đổi font chữ và kích thước chữ của toàn bộ văn bản.","Tạo bảng biểu và biểu đồ phức tạp."],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Chức năng đầu trang (Header) và chân trang (Footer) trong phần mềm soạn thảo văn bản giúp người dùng thực hiện điều gì?","rendered_options":["Chèn hình ảnh vào giữa các đoạn văn bản.","Đánh số trang, thêm tiêu đề, ngày tháng hoặc thông tin tác giả xuất hiện ở mỗi trang văn bản.","Thay đổi font chữ và kích thước chữ của toàn bộ văn bản.","Tạo bảng biểu và biểu đồ phức tạp."]},{"question":"Việc thêm đầu trang, chân trang và đánh số trang vào văn bản chủ yếu nhằm mục đích gì?","options":["Giúp văn bản trở nên chuyên nghiệp, dễ theo dõi và quản lí cấu trúc.","Thay đổi định dạng phông chữ và kích thước chữ của toàn bộ văn bản.","Chèn hình ảnh hoặc biểu đồ vào tất cả các trang một cách tự động.","Bảo vệ nội dung văn bản khỏi bị chỉnh sửa trái phép."],"correctAnswerIndex":0,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Việc thêm đầu trang, chân trang và đánh số trang vào văn bản chủ yếu nhằm mục đích gì?","rendered_options":["Giúp văn bản trở nên chuyên nghiệp, dễ theo dõi và quản lí cấu trúc.","Thay đổi định dạng phông chữ và kích thước chữ của toàn bộ văn bản.","Chèn hình ảnh hoặc biểu đồ vào tất cả các trang một cách tự động.","Bảo vệ nội dung văn bản khỏi bị chỉnh sửa trái phép."]},{"question":"Trong phần mềm bảng tính, khi sao chép một công thức chứa địa chỉ tương đối từ ô này sang ô khác, điều gì xảy ra với địa chỉ tương đối đó?","options":["Địa chỉ tương đối sẽ giữ nguyên giá trị.","Địa chỉ tương đối sẽ tự động thay đổi để phù hợp với vị trí mới của ô chứa công thức.","Địa chỉ tương đối sẽ biến thành địa chỉ tuyệt đối.","Phần mềm bảng tính sẽ báo lỗi và không cho phép sao chép."],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Trong phần mềm bảng tính, khi sao chép một công thức chứa địa chỉ tương đối từ ô này sang ô khác, điều gì xảy ra với địa chỉ tương đối đó?","rendered_options":["Địa chỉ tương đối sẽ giữ nguyên giá trị.","Địa chỉ tương đối sẽ tự động thay đổi để phù hợp với vị trí mới của ô chứa công thức.","Địa chỉ tương đối sẽ biến thành địa chỉ tuyệt đối.","Phần mềm bảng tính sẽ báo lỗi và không cho phép sao chép."]},{"question":"Trong một bảng tính, cột Thành tiền được tính ở cột D (bắt đầu từ D3) và Tỉ lệ giảm giá cố định được lưu ở ô D1. Để tính Tiền giảm giá cho sản phẩm ở dòng 3, người dùng nhập công thức `=D3*$D$1` vào ô E3. Nếu công thức này được sao chép từ ô E3 xuống ô E4, công thức tại ô E4 sẽ tự động thay đổi thành công thức nào sau đây?","options":["=D4*$D$1","=D3*$D$1","=D4*D2","=$D$3*$D$1"],"correctAnswerIndex":0,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Trong một bảng tính, cột Thành tiền được tính ở cột D (bắt đầu từ D3) và Tỉ lệ giảm giá cố định được lưu ở ô D1. Để tính Tiền giảm giá cho sản phẩm ở dòng 3, người dùng nhập công thức `=D3*$D$1` vào ô E3. Nếu công thức này được sao chép từ ô E3 xuống ô E4, công thức tại ô E4 sẽ tự động thay đổi thành công thức nào sau đây?","rendered_options":["=D4*$D$1","=D3*$D$1","=D4*D2","=$D$3*$D$1"]},{"question":"Khi sao chép một công thức có chứa địa chỉ tương đối sang một ô tính khác, địa chỉ tương đối trong công thức sẽ thay đổi như thế nào?","options":["Không thay đổi","Tự động điều chỉnh theo vị trí của ô đích","Chuyển thành địa chỉ tuyệt đối","Gây ra lỗi"],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Khi sao chép một công thức có chứa địa chỉ tương đối sang một ô tính khác, địa chỉ tương đối trong công thức sẽ thay đổi như thế nào?","rendered_options":["Không thay đổi","Tự động điều chỉnh theo vị trí của ô đích","Chuyển thành địa chỉ tuyệt đối","Gây ra lỗi"]},{"question":"Trong phần mềm bảng tính, khi bạn cần sao chép một công thức từ ô $B2$ xuống các ô phía dưới ($B3, B4, ...$) mà muốn một tham chiếu đến ô $A1$ chứa giá trị cố định (ví dụ: thuế suất, tỉ giá) không bị thay đổi, bạn sẽ sử dụng loại địa chỉ ô nào cho ô $A1$?","options":["Địa chỉ tương đối","Địa chỉ tuyệt đối","Địa chỉ hỗn hợp","Địa chỉ văn bản"],"correctAnswerIndex":1,"type":"multiple-choice","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Trong phần mềm bảng tính, khi bạn cần sao chép một công thức từ ô $B2$ xuống các ô phía dưới ($B3, B4, ...$) mà muốn một tham chiếu đến ô $A1$ chứa giá trị cố định (ví dụ: thuế suất, tỉ giá) không bị thay đổi, bạn sẽ sử dụng loại địa chỉ ô nào cho ô $A1$?","rendered_options":["Địa chỉ tương đối","Địa chỉ tuyệt đối","Địa chỉ hỗn hợp","Địa chỉ văn bản"]},{"main_question":"Chọn các phát biểu Đúng/Sai về chức năng sắp xếp và lọc dữ liệu trong phần mềm bảng tính:","statements":[{"statement":"Sắp xếp dữ liệu là quá trình tổ chức các bản ghi trong bảng tính theo một thứ tự nhất định (ví dụ: tăng dần hoặc giảm dần theo một trường dữ liệu).","is_correct":true,"rendered_statement":"Sắp xếp dữ liệu là quá trình tổ chức các bản ghi trong bảng tính theo một thứ tự nhất định (ví dụ: tăng dần hoặc giảm dần theo một trường dữ liệu)."},{"statement":"Chức năng Lọc (Filter) trong phần mềm bảng tính giúp hiển thị tất cả các hàng dữ liệu, bao gồm cả những hàng không thỏa mãn điều kiện tìm kiếm.","is_correct":false,"rendered_statement":"Chức năng Lọc (Filter) trong phần mềm bảng tính giúp hiển thị tất cả các hàng dữ liệu, bao gồm cả những hàng không thỏa mãn điều kiện tìm kiếm."},{"statement":"Khi thực hiện sắp xếp dữ liệu theo nhiều cấp độ (ví dụ: sắp xếp theo Tên rồi đến Lớp), phần mềm bảng tính sẽ ưu tiên cấp độ sắp xếp đầu tiên được thiết lập.","is_correct":true,"rendered_statement":"Khi thực hiện sắp xếp dữ liệu theo nhiều cấp độ (ví dụ: sắp xếp theo Tên rồi đến Lớp), phần mềm bảng tính sẽ ưu tiên cấp độ sắp xếp đầu tiên được thiết lập."},{"statement":"Để đảm bảo tính toàn vẹn của dữ liệu khi sắp xếp, người dùng chỉ cần chọn riêng cột muốn sắp xếp mà không cần chọn các cột dữ liệu liên quan khác trong cùng bảng.","is_correct":false,"rendered_statement":"Để đảm bảo tính toàn vẹn của dữ liệu khi sắp xếp, người dùng chỉ cần chọn riêng cột muốn sắp xếp mà không cần chọn các cột dữ liệu liên quan khác trong cùng bảng."}],"type":"true-false","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Chọn các phát biểu Đúng/Sai về chức năng sắp xếp và lọc dữ liệu trong phần mềm bảng tính:"},{"main_question":"Chọn khẳng định ĐÚNG hoặc SAI về chức năng và thao tác tạo biểu đồ trong phần mềm bảng tính.","statements":[{"statement":"Biểu đồ giúp trình bày dữ liệu dạng số một cách trực quan, dễ hiểu hơn so với việc chỉ nhìn vào các con số.","is_correct":true,"rendered_statement":"Biểu đồ giúp trình bày dữ liệu dạng số một cách trực quan, dễ hiểu hơn so với việc chỉ nhìn vào các con số."},{"statement":"Để tạo biểu đồ từ một bảng dữ liệu, người dùng chỉ cần đặt con trỏ chuột vào một ô bất kỳ trong bảng rồi chọn chức năng tạo biểu đồ.","is_correct":false,"rendered_statement":"Để tạo biểu đồ từ một bảng dữ liệu, người dùng chỉ cần đặt con trỏ chuột vào một ô bất kỳ trong bảng rồi chọn chức năng tạo biểu đồ."},{"statement":"Biểu đồ cột thường được sử dụng để so sánh giá trị giữa các danh mục khác nhau hoặc sự thay đổi của một đại lượng theo thời gian.","is_correct":true,"rendered_statement":"Biểu đồ cột thường được sử dụng để so sánh giá trị giữa các danh mục khác nhau hoặc sự thay đổi của một đại lượng theo thời gian."},{"statement":"Sau khi biểu đồ đã được tạo, người dùng không thể thay đổi loại biểu đồ hiện có hoặc các thành phần như tiêu đề, chú giải của biểu đồ.","is_correct":false,"rendered_statement":"Sau khi biểu đồ đã được tạo, người dùng không thể thay đổi loại biểu đồ hiện có hoặc các thành phần như tiêu đề, chú giải của biểu đồ."}],"type":"true-false","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Chọn khẳng định ĐÚNG hoặc SAI về chức năng và thao tác tạo biểu đồ trong phần mềm bảng tính."},{"main_question":"Phát biểu nào sau đây là đúng hoặc sai khi thực hiện các thao tác với hình ảnh và các đối tượng đồ họa trong phần mềm soạn thảo văn bản?","statements":[{"statement":"Người dùng có thể chèn hình ảnh có sẵn từ máy tính vào tài liệu văn bản đang soạn thảo.","is_correct":true,"rendered_statement":"Người dùng có thể chèn hình ảnh có sẵn từ máy tính vào tài liệu văn bản đang soạn thảo."},{"statement":"Sau khi chèn, để điều chỉnh kích thước hình ảnh mà vẫn đảm bảo giữ nguyên tỉ lệ ban đầu của ảnh, người dùng nên kéo thả các điểm neo ở các góc của hình ảnh.","is_correct":true,"rendered_statement":"Sau khi chèn, để điều chỉnh kích thước hình ảnh mà vẫn đảm bảo giữ nguyên tỉ lệ ban đầu của ảnh, người dùng nên kéo thả các điểm neo ở các góc của hình ảnh."},{"statement":"Để sắp xếp văn bản tự động bao quanh hình ảnh một cách linh hoạt (ví dụ: văn bản chảy xung quanh hình ảnh hoặc qua hình ảnh), người dùng cần thay đổi kiểu bố trí văn bản (Text Wrapping) cho hình ảnh đó.","is_correct":true,"rendered_statement":"Để sắp xếp văn bản tự động bao quanh hình ảnh một cách linh hoạt (ví dụ: văn bản chảy xung quanh hình ảnh hoặc qua hình ảnh), người dùng cần thay đổi kiểu bố trí văn bản (Text Wrapping) cho hình ảnh đó."},{"statement":"Việc vẽ các hình đồ họa cơ bản như hình chữ nhật, hình tròn, mũi tên trong phần mềm soạn thảo văn bản thường đòi hỏi phải sử dụng một phần mềm thiết kế đồ họa chuyên dụng bên ngoài rồi mới chèn vào.","is_correct":false,"rendered_statement":"Việc vẽ các hình đồ họa cơ bản như hình chữ nhật, hình tròn, mũi tên trong phần mềm soạn thảo văn bản thường đòi hỏi phải sử dụng một phần mềm thiết kế đồ họa chuyên dụng bên ngoài rồi mới chèn vào."}],"type":"true-false","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Phát biểu nào sau đây là đúng hoặc sai khi thực hiện các thao tác với hình ảnh và các đối tượng đồ họa trong phần mềm soạn thảo văn bản?"},{"main_question":"Khi làm việc với các chức năng đầu trang, chân trang và đánh số trang trong phần mềm soạn thảo văn bản (ví dụ như Microsoft Word), hãy cho biết các phát biểu sau là đúng hay sai?","statements":[{"statement":"Đầu trang (Header) là khu vực ở phía trên cùng của mỗi trang, nơi người dùng có thể chèn các thông tin lặp lại như tiêu đề văn bản, tên tác giả.","is_correct":true,"rendered_statement":"Đầu trang (Header) là khu vực ở phía trên cùng của mỗi trang, nơi người dùng có thể chèn các thông tin lặp lại như tiêu đề văn bản, tên tác giả."},{"statement":"Nội dung được chèn vào đầu trang hoặc chân trang của một trang bất kỳ sẽ chỉ hiển thị trên trang đó mà không xuất hiện trên các trang khác trong cùng một phần văn bản.","is_correct":false,"rendered_statement":"Nội dung được chèn vào đầu trang hoặc chân trang của một trang bất kỳ sẽ chỉ hiển thị trên trang đó mà không xuất hiện trên các trang khác trong cùng một phần văn bản."},{"statement":"Để đánh số trang bắt đầu từ một số cụ thể khác 1 (ví dụ: bắt đầu từ số 5), người dùng cần truy cập vào tùy chọn 'Format Page Numbers' để thay đổi giá trị bắt đầu.","is_correct":true,"rendered_statement":"Để đánh số trang bắt đầu từ một số cụ thể khác 1 (ví dụ: bắt đầu từ số 5), người dùng cần truy cập vào tùy chọn 'Format Page Numbers' để thay đổi giá trị bắt đầu."},{"statement":"Nếu muốn trang đầu tiên của văn bản không có đầu trang, chân trang hoặc số trang trong khi các trang còn lại vẫn có, người dùng chỉ cần xóa thủ công nội dung đó trên trang đầu tiên.","is_correct":false,"rendered_statement":"Nếu muốn trang đầu tiên của văn bản không có đầu trang, chân trang hoặc số trang trong khi các trang còn lại vẫn có, người dùng chỉ cần xóa thủ công nội dung đó trên trang đầu tiên."}],"type":"true-false","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Khi làm việc với các chức năng đầu trang, chân trang và đánh số trang trong phần mềm soạn thảo văn bản (ví dụ như Microsoft Word), hãy cho biết các phát biểu sau là đúng hay sai?"},{"question":"Một trường học có danh sách điểm của học sinh khối 8 trong học kì I được lưu trữ trong một bảng tính điện tử (ví dụ: Microsoft Excel, Google Sheets). Bảng dữ liệu bao gồm các cột: 'STT', 'Họ và tên', 'Lớp', 'Điểm Toán', 'Điểm Ngữ văn', 'Điểm Tiếng Anh', 'Điểm Trung bình môn'.Ban Giám hiệu nhà trường muốn tìm ra:a. Top 5 học sinh có Điểm Trung bình môn cao nhất khối 8 để khen thưởng.b. Danh sách tất cả học sinh của lớp '8A1' có Điểm Toán từ $8.0$ trở lên để xếp vào đội tuyển học sinh giỏi Toán.Bạn hãy mô tả các bước cụ thể sử dụng chức năng 'Sắp xếp' (Sort) và 'Lọc' (Filter) trong phần mềm bảng tính để giúp nhà trường thực hiện được hai yêu cầu trên một cách nhanh chóng và hiệu quả nhất. Giải thích rõ ràng từng bước bạn thực hiện và mục đích của nó.","answer":"Để giải quyết các yêu cầu của Ban Giám hiệu, ta thực hiện như sau:a. Để tìm Top 5 học sinh có Điểm Trung bình môn cao nhất khối 8:Bước 1: Chọn toàn bộ vùng dữ liệu chứa danh sách điểm (bao gồm cả các cột tiêu đề).Mục đích: Đảm bảo tất cả các dữ liệu liên quan đến mỗi học sinh đều được sắp xếp cùng nhau.Bước 2: Sử dụng chức năng 'Sắp xếp' (Sort). Chọn sắp xếp theo cột 'Điểm Trung bình môn' với thứ tự 'Giảm dần' (Largest to Smallest).Mục đích: Xếp các học sinh có điểm cao nhất lên đầu danh sách.Bước 3: Sau khi sắp xếp, 5 hàng đầu tiên (không tính hàng tiêu đề) trong danh sách sẽ là Top 5 học sinh có Điểm Trung bình môn cao nhất.b. Để tìm danh sách học sinh của lớp '8A1' có Điểm Toán từ $8.0$ trở lên:Bước 1: Chọn toàn bộ vùng dữ liệu.Mục đích: Áp dụng bộ lọc cho tất cả dữ liệu.Bước 2: Kích hoạt chức năng 'Lọc' (Filter) cho vùng dữ liệu đã chọn.Mục đích: Hiển thị các mũi tên lọc ở tiêu đề mỗi cột để dễ dàng lọc dữ liệu.Bước 3: Tại cột 'Lớp', nhấp vào mũi tên lọc, bỏ chọn 'Select All' (Chọn tất cả) và chỉ chọn '8A1'. Sau đó nhấn 'OK'.Mục đích: Chỉ hiển thị dữ liệu của học sinh thuộc lớp '8A1'.Bước 4: Tại cột 'Điểm Toán', nhấp vào mũi tên lọc. Chọn 'Number Filters' (Bộ lọc số) và chọn 'Greater Than or Equal To...' (Lớn hơn hoặc bằng...). Nhập giá trị $8.0$ vào ô và nhấn 'OK'.Mục đích: Trong số các học sinh lớp '8A1' đã được lọc, chỉ giữ lại những em có Điểm Toán từ $8.0$ trở lên.Bước 5: Danh sách các hàng hiển thị trên bảng tính sau các bước lọc chính là danh sách học sinh cần tìm.","type":"essay","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Một trường học có danh sách điểm của học sinh khối 8 trong học kì I được lưu trữ trong một bảng tính điện tử (ví dụ: Microsoft Excel, Google Sheets). Bảng dữ liệu bao gồm các cột: 'STT', 'Họ và tên', 'Lớp', 'Điểm Toán', 'Điểm Ngữ văn', 'Điểm Tiếng Anh', 'Điểm Trung bình môn'.Ban Giám hiệu nhà trường muốn tìm ra:a. Top 5 học sinh có Điểm Trung bình môn cao nhất khối 8 để khen thưởng.b. Danh sách tất cả học sinh của lớp '8A1' có Điểm Toán từ $8.0$ trở lên để xếp vào đội tuyển học sinh giỏi Toán.Bạn hãy mô tả các bước cụ thể sử dụng chức năng 'Sắp xếp' (Sort) và 'Lọc' (Filter) trong phần mềm bảng tính để giúp nhà trường thực hiện được hai yêu cầu trên một cách nhanh chóng và hiệu quả nhất. Giải thích rõ ràng từng bước bạn thực hiện và mục đích của nó.","rendered_answer":"Để giải quyết các yêu cầu của Ban Giám hiệu, ta thực hiện như sau:a. Để tìm Top 5 học sinh có Điểm Trung bình môn cao nhất khối 8:Bước 1: Chọn toàn bộ vùng dữ liệu chứa danh sách điểm (bao gồm cả các cột tiêu đề).Mục đích: Đảm bảo tất cả các dữ liệu liên quan đến mỗi học sinh đều được sắp xếp cùng nhau.Bước 2: Sử dụng chức năng 'Sắp xếp' (Sort). Chọn sắp xếp theo cột 'Điểm Trung bình môn' với thứ tự 'Giảm dần' (Largest to Smallest).Mục đích: Xếp các học sinh có điểm cao nhất lên đầu danh sách.Bước 3: Sau khi sắp xếp, 5 hàng đầu tiên (không tính hàng tiêu đề) trong danh sách sẽ là Top 5 học sinh có Điểm Trung bình môn cao nhất.b. Để tìm danh sách học sinh của lớp '8A1' có Điểm Toán từ $8.0$ trở lên:Bước 1: Chọn toàn bộ vùng dữ liệu.Mục đích: Áp dụng bộ lọc cho tất cả dữ liệu.Bước 2: Kích hoạt chức năng 'Lọc' (Filter) cho vùng dữ liệu đã chọn.Mục đích: Hiển thị các mũi tên lọc ở tiêu đề mỗi cột để dễ dàng lọc dữ liệu.Bước 3: Tại cột 'Lớp', nhấp vào mũi tên lọc, bỏ chọn 'Select All' (Chọn tất cả) và chỉ chọn '8A1'. Sau đó nhấn 'OK'.Mục đích: Chỉ hiển thị dữ liệu của học sinh thuộc lớp '8A1'.Bước 4: Tại cột 'Điểm Toán', nhấp vào mũi tên lọc. Chọn 'Number Filters' (Bộ lọc số) và chọn 'Greater Than or Equal To...' (Lớn hơn hoặc bằng...). Nhập giá trị $8.0$ vào ô và nhấn 'OK'.Mục đích: Trong số các học sinh lớp '8A1' đã được lọc, chỉ giữ lại những em có Điểm Toán từ $8.0$ trở lên.Bước 5: Danh sách các hàng hiển thị trên bảng tính sau các bước lọc chính là danh sách học sinh cần tìm."},{"question":"Bạn được giao nhiệm vụ thiết kế một poster thông báo về \"Ngày hội tái chế giấy\" của trường. Hãy sử dụng phần mềm soạn thảo văn bản (ví dụ: Microsoft Word hoặc Google Docs) để thực hiện các yêu cầu sau: 1. Tạo một danh sách dạng liệt kê (ví dụ: gạch đầu dòng hoặc đánh số) để trình bày các loại giấy có thể tái chế (sách báo cũ, vỏ hộp sữa, giấy vụn, bìa carton). 2. Chèn một hình ảnh minh họa liên quan đến hoạt động tái chế (ví dụ: biểu tượng tái chế hoặc hình ảnh thùng rác phân loại). Sau đó, điều chỉnh kích thước hình ảnh sao cho phù hợp và đặt nó ở vị trí bên phải của tiêu đề. 3. Vẽ một hình mũi tên đơn giản để chỉ dẫn từ phần tiêu đề đến danh sách các loại giấy tái chế.","answer":"Để hoàn thành nhiệm vụ, học sinh cần: 1. Mở phần mềm soạn thảo văn bản và tạo tài liệu mới. 2. Nhập tiêu đề và sau đó sử dụng chức năng tạo danh sách (ví dụ: Bullet hoặc Numbering) để liệt kê các loại giấy tái chế. 3. Sử dụng lệnh \"Insert\" -> \"Picture\" để chèn hình ảnh. Sau đó, dùng các điểm neo để co dãn hình ảnh và sử dụng tùy chọn \"Wrap Text\" để đặt hình ảnh ở vị trí bên phải tiêu đề. 4. Sử dụng lệnh \"Insert\" -> \"Shapes\" để chọn và vẽ hình mũi tên, sau đó điều chỉnh vị trí và hướng của mũi tên.","type":"essay","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Bạn được giao nhiệm vụ thiết kế một poster thông báo về \"Ngày hội tái chế giấy\" của trường. Hãy sử dụng phần mềm soạn thảo văn bản (ví dụ: Microsoft Word hoặc Google Docs) để thực hiện các yêu cầu sau: 1. Tạo một danh sách dạng liệt kê (ví dụ: gạch đầu dòng hoặc đánh số) để trình bày các loại giấy có thể tái chế (sách báo cũ, vỏ hộp sữa, giấy vụn, bìa carton). 2. Chèn một hình ảnh minh họa liên quan đến hoạt động tái chế (ví dụ: biểu tượng tái chế hoặc hình ảnh thùng rác phân loại). Sau đó, điều chỉnh kích thước hình ảnh sao cho phù hợp và đặt nó ở vị trí bên phải của tiêu đề. 3. Vẽ một hình mũi tên đơn giản để chỉ dẫn từ phần tiêu đề đến danh sách các loại giấy tái chế.","rendered_answer":"Để hoàn thành nhiệm vụ, học sinh cần: 1. Mở phần mềm soạn thảo văn bản và tạo tài liệu mới. 2. Nhập tiêu đề và sau đó sử dụng chức năng tạo danh sách (ví dụ: Bullet hoặc Numbering) để liệt kê các loại giấy tái chế. 3. Sử dụng lệnh \"Insert\" -> \"Picture\" để chèn hình ảnh. Sau đó, dùng các điểm neo để co dãn hình ảnh và sử dụng tùy chọn \"Wrap Text\" để đặt hình ảnh ở vị trí bên phải tiêu đề. 4. Sử dụng lệnh \"Insert\" -> \"Shapes\" để chọn và vẽ hình mũi tên, sau đó điều chỉnh vị trí và hướng của mũi tên."},{"question":"Một nhóm học sinh lớp 8 đang chuẩn bị một bài báo cáo khoa học dài 15 trang cho cuộc thi cấp trường. Để bài báo cáo trông chuyên nghiệp và dễ theo dõi, nhóm cần thực hiện các yêu cầu sau:1.  **Đánh số trang tự động:** Số trang phải được hiển thị ở góc dưới bên phải của mỗi trang, theo định dạng \"Trang X của Y\" (ví dụ: \"Trang 1 của 15\").2.  **Đầu trang:** Thêm tiêu đề \"Báo cáo Khoa học Lớp 8\" vào giữa đầu trang của tất cả các trang.3.  **Chân trang:** Thêm tên nhóm \"Nhóm Sáng Tạo\" vào góc dưới bên trái của mỗi trang, ngay bên cạnh số trang.Em hãy mô tả chi tiết các bước thực hiện để đáp ứng ba yêu cầu trên trong một phần mềm soạn thảo văn bản thông dụng (ví dụ: Microsoft Word).","answer":"Để thực hiện các yêu cầu trên trong một phần mềm soạn thảo văn bản như Microsoft Word, các bước chi tiết như sau:1.  **Đánh số trang tự động:**    *   Mở văn bản cần chỉnh sửa.    *   Vào thẻ **Insert** (Chèn) trên thanh công cụ.    *   Trong nhóm **Header & Footer** (Đầu trang & Chân trang), chọn **Page Number** (Số trang).    *   Chọn **Bottom of Page** (Cuối trang) để đặt số trang ở chân trang.    *   Chọn một kiểu số trang có định dạng \"Page X of Y\" hoặc \"Trang X của Y\" (ví dụ: Plain Number 3, hoặc tìm kiểu có chữ \"Page X of Y\").    *   Nếu cần, hãy căn chỉnh lại vị trí của số trang để đảm bảo nó nằm ở góc dưới bên phải.2.  **Thêm đầu trang (\"Báo cáo Khoa học Lớp 8\"):**    *   Vào thẻ **Insert** (Chèn).    *   Trong nhóm **Header & Footer** (Đầu trang & Chân trang), chọn **Header** (Đầu trang).    *   Chọn **Edit Header** (Chỉnh sửa Đầu trang). Lúc này, con trỏ sẽ nhảy lên vùng đầu trang.    *   Gõ vào tiêu đề \"Báo cáo Khoa học Lớp 8\".    *   Sử dụng các công cụ căn chỉnh trong thẻ **Home** (Trang chủ) hoặc **Header & Footer Tools/Design** để căn giữa tiêu đề.    *   Sau khi hoàn thành, nhấn **Close Header and Footer** (Đóng Đầu trang và Chân trang) hoặc nhấn phím Esc hai lần để thoát khỏi chế độ chỉnh sửa.3.  **Thêm chân trang (\"Nhóm Sáng Tạo\"):**    *   Bạn có thể vào lại chế độ chỉnh sửa chân trang bằng cách double-click vào vùng chân trang bất kỳ, hoặc vào **Insert > Footer > Edit Footer**.    *   Trong vùng chân trang, di chuyển con trỏ đến vị trí góc dưới bên trái (cạnh số trang đã có).    *   Gõ \"Nhóm Sáng Tạo\".    *   Đảm bảo không chồng lấn với số trang hiện có.    *   Nhấn **Close Header and Footer** (Đóng Đầu trang và Chân trang) hoặc nhấn phím Esc hai lần để thoát khỏi chế độ chỉnh sửa.","type":"essay","isDirty":false,"explanation":null,"shuffleOptions":{"stem":true,"answers":true},"rendered_question":"Một nhóm học sinh lớp 8 đang chuẩn bị một bài báo cáo khoa học dài 15 trang cho cuộc thi cấp trường. Để bài báo cáo trông chuyên nghiệp và dễ theo dõi, nhóm cần thực hiện các yêu cầu sau:1.  <strong>Đánh số trang tự động:</strong> Số trang phải được hiển thị ở góc dưới bên phải của mỗi trang, theo định dạng \"Trang X của Y\" (ví dụ: \"Trang 1 của 15\").2.  <strong>Đầu trang:</strong> Thêm tiêu đề \"Báo cáo Khoa học Lớp 8\" vào giữa đầu trang của tất cả các trang.3.  <strong>Chân trang:</strong> Thêm tên nhóm \"Nhóm Sáng Tạo\" vào góc dưới bên trái của mỗi trang, ngay bên cạnh số trang.Em hãy mô tả chi tiết các bước thực hiện để đáp ứng ba yêu cầu trên trong một phần mềm soạn thảo văn bản thông dụng (ví dụ: Microsoft Word).","rendered_answer":"Để thực hiện các yêu cầu trên trong một phần mềm soạn thảo văn bản như Microsoft Word, các bước chi tiết như sau:1.  <strong>Đánh số trang tự động:</strong>    *   Mở văn bản cần chỉnh sửa.    *   Vào thẻ <strong>Insert</strong> (Chèn) trên thanh công cụ.    *   Trong nhóm <strong>Header & Footer</strong> (Đầu trang & Chân trang), chọn <strong>Page Number</strong> (Số trang).    *   Chọn <strong>Bottom of Page</strong> (Cuối trang) để đặt số trang ở chân trang.    *   Chọn một kiểu số trang có định dạng \"Page X of Y\" hoặc \"Trang X của Y\" (ví dụ: Plain Number 3, hoặc tìm kiểu có chữ \"Page X of Y\").    *   Nếu cần, hãy căn chỉnh lại vị trí của số trang để đảm bảo nó nằm ở góc dưới bên phải.2.  <strong>Thêm đầu trang (\"Báo cáo Khoa học Lớp 8\"):</strong>    *   Vào thẻ <strong>Insert</strong> (Chèn).    *   Trong nhóm <strong>Header & Footer</strong> (Đầu trang & Chân trang), chọn <strong>Header</strong> (Đầu trang).    *   Chọn <strong>Edit Header</strong> (Chỉnh sửa Đầu trang). Lúc này, con trỏ sẽ nhảy lên vùng đầu trang.    *   Gõ vào tiêu đề \"Báo cáo Khoa học Lớp 8\".    *   Sử dụng các công cụ căn chỉnh trong thẻ <strong>Home</strong> (Trang chủ) hoặc <strong>Header & Footer Tools/Design</strong> để căn giữa tiêu đề.    *   Sau khi hoàn thành, nhấn <strong>Close Header and Footer</strong> (Đóng Đầu trang và Chân trang) hoặc nhấn phím Esc hai lần để thoát khỏi chế độ chỉnh sửa.3.  <strong>Thêm chân trang (\"Nhóm Sáng Tạo\"):</strong>    *   Bạn có thể vào lại chế độ chỉnh sửa chân trang bằng cách double-click vào vùng chân trang bất kỳ, hoặc vào <strong>Insert > Footer > Edit Footer</strong>.    *   Trong vùng chân trang, di chuyển con trỏ đến vị trí góc dưới bên trái (cạnh số trang đã có).    *   Gõ \"Nhóm Sáng Tạo\".    *   Đảm bảo không chồng lấn với số trang hiện có.    *   Nhấn <strong>Close Header and Footer</strong> (Đóng Đầu trang và Chân trang) hoặc nhấn phím Esc hai lần để thoát khỏi chế độ chỉnh sửa."}];
        const options = {"title":"Bài kiểm tra - 10/12/2025","timeLimit":45,"retriesAllowed":1,"showAnswers":true,"showExplanation":true,"aiAssessment":true,"shortAnswerFormat":"freeform","examCode":"J6GCTB","teacherName":"Đàng Năng Nhanh","scoring":{"mc":5,"tf":2,"sa":0,"essay":3,"tfMethod":"progressive"}};
        const googleScriptUrl = "https://script.google.com/macros/s/AKfycbxx-BtRQ4SJJG5DkUOTYicW5ATk6hQu3X_J6it2d9bucw53uGQYwBa4QgMsfFbtcHo3-g/exec";
        const examCode = "J6GCTB";
        
        let userAnswers = new Array(quizData.length).fill(null);
        let studentName = '';
        let studentClass = '';
        let timerInterval;
        let timeRemaining = options.timeLimit * 60;
        let retriesCount = 0;
        let submissionStatus = 'pending';
        let monitoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0 };
        let lastScore, lastAnswerDetails; // For retrying AI assessment
        let isQuizActive = false;

        const studentApiKeyInput = document.getElementById('student-api-key');

        // Check if AI features are enabled by teacher
        const needsAiKey = options.showExplanation || options.aiAssessment;
        if (needsAiKey) {
            document.getElementById('api-key-input-container').classList.remove('hidden');
        }
        
        window.addEventListener('beforeunload', (e) => {
            if (isQuizActive) {
                const message = "Bạn đang làm bài, có muốn thoát không? Hãy nộp bài và thoát.";
                e.preventDefault();
                e.returnValue = message;
                return message;
            }
        });

        // --- UTILS FOR SHUFFLING ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function mapType(typeStr) {
             if (!typeStr) return 'multiple-choice';
             if (typeStr.startsWith('mc-') || ['cloze-test', 'sentence-ordering', 'multiple-choice', 'paragraph-sentence-ordering'].includes(typeStr)) return 'multiple-choice';
             if (typeStr.startsWith('tf-') || typeStr === 'true-false') return 'true-false';
             if (typeStr === 'short-answer' || typeStr === 'sentence-transformation') return 'short-answer';
             return 'essay';
        }

        // --- SHUFFLE LOGIC FOR ONLINE QUIZ ---
        function applyShuffling() {
            // 1. Shuffle Options/Statements within each question
            quizData.forEach(item => {
                const shuffleOpts = item.shuffleOptions || { answers: true };
                const type = mapType(item.type);
                
                if (shuffleOpts.answers) {
                    if (type === 'multiple-choice' && item.rendered_options && item.rendered_options.length > 0) {
                        // Create indices array to shuffle
                        const indices = item.rendered_options.map((_, i) => i);
                        shuffleArray(indices);
                        
                        // Reorder rendered_options based on shuffled indices
                        item.rendered_options = indices.map(i => item.rendered_options[i]);
                        
                        // Reorder raw options (needed for review/explanation context, though mostly rendered is used)
                        if (item.options) {
                            item.options = indices.map(i => item.options[i]);
                        }
                        
                        // Update correctAnswerIndex
                        // Old index was item.correctAnswerIndex. We need to find where it went.
                        // New index is the position of the old correct index in the shuffled 'indices' array.
                        item.correctAnswerIndex = indices.indexOf(item.correctAnswerIndex);

                    } else if (type === 'true-false' && item.statements && item.statements.length > 0) {
                        // Shuffle statements array directly
                        shuffleArray(item.statements);
                    }
                }
            });

            // 2. Shuffle Question Order within Parts (respecting "Câu dẫn" aka Stem shuffle option)
            // We group questions by type first to ensure we don't mix sections
            const groupedQuestions = quizData.reduce((acc, q, index) => {
                const type = mapType(q.type);
                if (!acc[type]) acc[type] = [];
                acc[type].push({ ...q, originalIndex: index });
                return acc;
            }, {});
            
            const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];
            let newQuizData = [];

            partOrder.forEach(partType => {
                const questions = groupedQuestions[partType];
                if (questions) {
                    const finalPartQuestions = new Array(questions.length).fill(null);
                    const shufflableQuestions = [];
                    
                    // Separate fixed and shufflable questions
                    questions.forEach((q, i) => {
                        const shuffleOpts = q.shuffleOptions || { stem: true };
                        if (shuffleOpts.stem) {
                            shufflableQuestions.push(q);
                        } else {
                            finalPartQuestions[i] = q;
                        }
                    });

                    // Shuffle the shufflable ones
                    shuffleArray(shufflableQuestions);

                    // Merge back
                    let shufflableIndex = 0;
                    for (let i = 0; i < finalPartQuestions.length; i++) {
                        if (finalPartQuestions[i] === null) {
                            finalPartQuestions[i] = shufflableQuestions[shufflableIndex];
                            shufflableIndex++;
                        }
                    }
                    newQuizData = newQuizData.concat(finalPartQuestions);
                }
            });
            
            // Update the global quizData with the shuffled version
            if (newQuizData.length === quizData.length) {
                quizData = newQuizData;
            }
            
            // Reset user answers array to match new length (though length is same) and clear it
            userAnswers = new Array(quizData.length).fill(null);
        }
        
        // --- SMART FALLBACK GENERATOR ---
        const PROVIDERS = [
             {
                id: 'gemini',
                name: 'Google Gemini',
                isValid: () => !!API_KEYS.gemini && API_KEYS.gemini.trim().length > 0,
                execute: async (prompt) => {
                     const ai = new GoogleGenAI({ apiKey: API_KEYS.gemini });
                     // Fallback models for Gemini specifically
                     const models = ["gemini-2.5-flash", "gemini-2.0-flash", "gemini-1.5-flash"];
                     let lastErr;
                     for (const model of models) {
                        try {
                            const res = await ai.models.generateContent({ model, contents: prompt });
                            return res.text;
                        } catch (e) { 
                            console.warn(`Gemini ${model} error:`, e);
                            lastErr = e; 
                        }
                     }
                     throw lastErr || new Error("All Gemini models failed");
                }
            },
            {
                id: 'deepseek',
                name: 'DeepSeek',
                isValid: () => !!API_KEYS.deepseek && API_KEYS.deepseek.trim().length > 0,
                execute: async (prompt) => {
                     const res = await fetch("https://api.deepseek.com/chat/completions", {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${API_KEYS.deepseek}` },
                        body: JSON.stringify({ model: "deepseek-chat", messages: [{role: "user", content: prompt}], temperature: 0.7 })
                     });
                     if(!res.ok) throw new Error(`DeepSeek status ${res.status}: ${await res.text()}`);
                     const data = await res.json();
                     return data.choices[0].message.content;
                }
            },
            {
                id: 'openai',
                name: 'OpenAI',
                isValid: () => !!API_KEYS.openai && API_KEYS.openai.trim().length > 0,
                execute: async (prompt) => {
                     const res = await fetch("https://api.openai.com/v1/chat/completions", {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${API_KEYS.openai}` },
                        body: JSON.stringify({ model: "gpt-4o-mini", messages: [{role: "user", content: prompt}], temperature: 0.7 })
                     });
                     if(!res.ok) throw new Error(`OpenAI status ${res.status}: ${await res.text()}`);
                     const data = await res.json();
                     return data.choices[0].message.content;
                }
            }
        ];

        async function generateContentWithSmartFallback(prompt) {
            const validProviders = PROVIDERS.filter(p => p.isValid());
            if (validProviders.length === 0) {
                throw new Error("Không có API Key nào được cấu hình. Vui lòng liên hệ giáo viên.");
            }
            
            let errors = [];
            for (const provider of validProviders) {
                try {
                    console.log(`Trying provider: ${provider.name}`);
                    const text = await provider.execute(prompt);
                    return { text };
                } catch (err) {
                    console.error(`Provider ${provider.name} failed:`, err);
                    errors.push(`${provider.name}: ${err.message}`);
                }
            }
            
            throw new Error("Tất cả các mô hình AI đều thất bại:\n" + errors.join("\n"));
        }

        const welcomeScreen = document.getElementById('welcome-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const resultsScreen = document.getElementById('results-screen');
        const startBtn = document.getElementById('start-btn');
        const nameInput = document.getElementById('name');
        const classInput = document.getElementById('class');
        const timerEl = document.getElementById('timer');
        const submitBtn = document.getElementById('submit-btn');
        const submitBtnTop = document.getElementById('submit-btn-top');
        const scoreDisplay = document.getElementById('score-display');
        const assessmentDisplay = document.getElementById('assessment-display');
        const reviewContainer = document.getElementById('review-container');
        const retryBtn = document.getElementById('retry-btn');
        const restartBtn = document.getElementById('restart-btn');
        const warningEl = document.getElementById('monitoring-warning');
        const progressBar = document.getElementById('progress-bar');
        const progressContainer = document.getElementById('progress-container');
        const toggleNavBtn = document.getElementById('toggle-nav-btn');
        const navPanel = document.getElementById('nav-panel');
        const navGrid = document.getElementById('nav-grid');
        

        window.selectOption = selectOption;
        window.selectTFOption = selectTFOption;
        window.saveTextAnswer = saveTextAnswer;
        window.toggleExplanation = toggleExplanation;
        window.fetchAndRenderExplanation = fetchAndRenderExplanation;
        window.retryAIAssessment = retryAIAssessment;
        window.setupFormInputs = setupFormInputs;
        window.saveFormAnswer = saveFormAnswer;
        window.scrollToQuestion = scrollToQuestion;

        startBtn.addEventListener('click', startQuiz);
        submitBtn.addEventListener('click', confirmSubmit);
        submitBtnTop.addEventListener('click', confirmSubmit);
        retryBtn.addEventListener('click', retryQuiz);
        restartBtn.addEventListener('click', () => window.location.reload());
        
        toggleNavBtn.addEventListener('click', () => {
            navPanel.classList.toggle('open');
            document.body.classList.toggle('nav-open');
        });

        nameInput.value = localStorage.getItem('studentName') || '';
        classInput.value = localStorage.getItem('studentClass') || '';
        // Restore key if exists
        if (studentApiKeyInput) {
            studentApiKeyInput.value = localStorage.getItem('studentApiKey') || '';
        }
        
        function safeTypeset(elements) {
            if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                window.MathJax.typesetPromise(elements).catch(function (err) {
                    console.error('MathJax error: ' + err.message);
                });
            }
        }
        
        function startQuiz() {
            studentName = nameInput.value.trim();
            studentClass = classInput.value.trim();
            
            if (!studentName || !studentClass) {
                alert('Vui lòng nhập đầy đủ Họ và tên và Lớp.');
                return;
            }
            
            // Handle Student API Key
            if (studentApiKeyInput) {
                const studentKey = studentApiKeyInput.value.trim();
                if (studentKey) {
                    API_KEYS.gemini = studentKey; // Prioritize student key
                    localStorage.setItem('studentApiKey', studentKey);
                }
            }

            localStorage.setItem('studentName', studentName);
            localStorage.setItem('studentClass', studentClass);
            
            document.getElementById('student-name-display').textContent = studentName;

            applyShuffling();
            
            welcomeScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            resultsScreen.classList.add('hidden');
            progressContainer.classList.remove('hidden');
            toggleNavBtn.classList.remove('hidden');
            
            if (window.innerWidth > 1024) {
                navPanel.classList.add('open');
                document.body.classList.add('nav-open');
            }

            userAnswers = new Array(quizData.length).fill(null);
            submissionStatus = 'pending';
            isQuizActive = true;
            
            renderAllQuestions();
            renderNavPanel();
            updateProgress();
            
            if (options.timeLimit > 0) {
                timeRemaining = options.timeLimit * 60;
                startTimer();
            } else {
                timerEl.textContent = '∞';
            }
            startMonitoring();
        }

        function renderNavPanel() {
            navGrid.innerHTML = '';
            quizData.forEach((_, index) => {
                const btn = document.createElement('button');
                btn.className = 'nav-btn';
                btn.id = `nav-btn-${index}`;
                btn.textContent = index + 1;
                btn.onclick = () => scrollToQuestion(index);
                navGrid.appendChild(btn);
            });
        }

        function scrollToQuestion(index) {
            const el = document.getElementById(`q-${index}`);
            if (el) {
                const offset = 100; 
                const elementPosition = el.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - offset;
                window.scrollTo({ top: offsetPosition, behavior: "smooth" });
                
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('current'));
                document.getElementById(`nav-btn-${index}`)?.classList.add('current');
            }
            if (window.innerWidth <= 1024) {
                navPanel.classList.remove('open');
                document.body.classList.remove('nav-open');
            }
        }

        function updateProgress() {
            let answeredCount = 0;
            quizData.forEach((item, index) => {
                const answer = userAnswers[index];
                const type = mapType(item.type);
                let isAnswered = false;

                if (type === 'multiple-choice') {
                    isAnswered = answer !== null;
                } else if (type === 'true-false') {
                    isAnswered = Array.isArray(answer) && answer.filter(x => x !== null).length === item.statements.length;
                } else { 
                    isAnswered = answer && String(answer).trim().length > 0;
                }

                const btn = document.getElementById(`nav-btn-${index}`);
                if (isAnswered) {
                    answeredCount++;
                    btn?.classList.add('answered');
                } else {
                    btn?.classList.remove('answered');
                }
            });

            const percent = Math.round((answeredCount / quizData.length) * 100);
            progressBar.style.width = `${percent}%`;
        }
        
        function renderAllQuestions() {
            const container = document.getElementById('all-questions-container');
            let allHTML = '';

            const groupedQuestions = quizData.reduce((acc, q) => {
                const type = mapType(q.type);
                if (!acc[type]) acc[type] = [];
                acc[type].push(q);
                return acc;
            }, {});

            const groupInfo = {
                'multiple-choice': { title: 'PHẦN I. TRẮC NGHIỆM NHIỀU LỰA CHỌN', color: 'blue' },
                'true-false': { title: 'PHẦN II. TRẮC NGHIỆM ĐÚNG/SAI', color: 'purple' },
                'short-answer': { title: 'PHẦN III. TRẢ LỜI NGẮN', color: 'teal' },
                'essay': { title: 'PHẦN IV. TỰ LUẬN', color: 'orange' },
            };
            
            let questionCounter = 0;
            const partOrder = ['multiple-choice', 'true-false', 'short-answer', 'essay'];

            partOrder.forEach(partType => {
                const questions = groupedQuestions[partType];
                if (!questions || questions.length === 0) return;

                const info = groupInfo[partType];
                allHTML += `
                    <div class="mb-6 pb-2 border-b-2 border-${info.color}-200 flex items-center gap-2">
                        <span class="bg-${info.color}-100 text-${info.color}-700 p-1.5 rounded-md">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                            </svg>
                        </span>
                        <h2 class="text-xl md:text-2xl font-bold text-gray-800">${info.title}</h2>
                    </div>`;
                
                questions.forEach((item) => {
                    const index = quizData.indexOf(item);
                    questionCounter++;
                    
                    let contentHTML = `<div class="question-card mb-8 p-6 border border-gray-200 bg-white rounded-2xl shadow-sm hover:shadow-md transition-shadow scroll-mt-32" id="q-${index}">`;
                    contentHTML += `
                        <div class="flex items-start gap-3 mb-4">
                             <span class="bg-gray-100 text-gray-700 font-bold px-3 py-1 rounded-lg text-sm shadow-sm">Câu ${questionCounter}</span>
                        </div>
                    `;
                    contentHTML += `<div class="prose max-w-none text-gray-800 mb-6 font-medium text-lg leading-relaxed">${item.rendered_question || ''}</div>`;

                    let answerHTML = '';
                    const savedAnswer = userAnswers[index];
                    const type = mapType(item.type);
                    
                    if (type === 'multiple-choice') {
                        answerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;
                        (item.rendered_options || []).forEach((opt, i) => {
                            const isSelected = savedAnswer === i;
                            answerHTML += `
                                <div class="option ${isSelected ? 'selected' : ''} p-4 border border-gray-200 rounded-xl cursor-pointer flex items-start gap-3 hover:bg-gray-50" data-q-index="${index}" data-opt-index="${i}" onclick="selectOption(this, ${index}, ${i})">
                                    <div class="flex-shrink-0 w-8 h-8 rounded-full border-2 ${isSelected ? 'border-indigo-600 bg-indigo-600 text-white' : 'border-gray-300 text-gray-500'} flex items-center justify-center font-bold text-sm transition-colors">${String.fromCharCode(65 + i)}</div>
                                    <div class="flex-grow pt-1 text-gray-700">${opt}</div>
                                </div>`;
                        });
                        answerHTML += `</div>`;
                    } else if (type === 'true-false') {
                         answerHTML = `<div class="space-y-3">`;
                         (item.statements || []).forEach((stmt, i) => {
                            const savedStmtAnswer = savedAnswer ? savedAnswer[i] : null;
                            const isTrueSelected = savedStmtAnswer === true;
                            const isFalseSelected = savedStmtAnswer === false;
                            answerHTML += `<div class="p-4 border border-gray-200 rounded-xl bg-gray-50 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                                                <div class="flex-grow flex gap-3">
                                                    <span class="font-bold text-gray-500">${String.fromCharCode(97 + i)})</span>
                                                    <div class="prose max-w-none text-gray-700">${stmt.rendered_statement}</div>
                                                </div>
                                                <div class="flex-shrink-0 flex gap-2 self-end sm:self-auto">
                                                    <button class="${isTrueSelected ? 'bg-blue-600 text-white shadow-md ring-2 ring-blue-300' : 'bg-white text-gray-600 border border-gray-300 hover:bg-blue-50'} px-5 py-2 rounded-lg font-semibold transition-all" onclick="selectTFOption(this, ${index}, ${i}, true)">Đúng</button>
                                                    <button class="${isFalseSelected ? 'bg-red-500 text-white shadow-md ring-2 ring-red-300' : 'bg-white text-gray-600 border border-gray-300 hover:bg-red-50'} px-5 py-2 rounded-lg font-semibold transition-all" onclick="selectTFOption(this, ${index}, ${i}, false)">Sai</button>
                                                </div>
                                            </div>`;
                        });
                        answerHTML += `</div>`;
                    } else if (type === 'short-answer') {
                        const savedAnswerStr = userAnswers[index] || '';
                        if (options.shortAnswerFormat === 'form') {
                             answerHTML = `<div id="sa-form-${index}" class="flex items-center gap-3 p-4 bg-teal-50 rounded-xl border border-teal-100">`;
                            for (let i = 0; i < 4; i++) {
                                answerHTML += `<input type="text" maxlength="1" data-q-index="${index}" class="w-12 h-14 text-center text-2xl font-bold border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:ring focus:ring-teal-200 focus:outline-none bg-white shadow-sm transition-all" value="">`;
                            }
                            answerHTML += `</div>`;
                        } else {
                            answerHTML = `<input type="text" class="w-full border-gray-300 rounded-xl p-4 shadow-sm focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all text-lg" placeholder="Nhập câu trả lời của bạn..." value="${savedAnswerStr}" onchange="saveTextAnswer(this, ${index})">`;
                        }
                    } else if (type === 'essay') {
                        answerHTML = `<textarea class="w-full border-gray-300 rounded-xl p-4 shadow-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all" rows="6" placeholder="Nhập bài làm tự luận..." onchange="saveTextAnswer(this, ${index})">${savedAnswer || ''}</textarea>`;
                    }

                    contentHTML += answerHTML + '</div>';
                    allHTML += contentHTML;
                });
            });
            container.innerHTML = allHTML;

            document.querySelectorAll('[id^="sa-form-"]').forEach(formContainer => {
                const inputs = formContainer.querySelectorAll('input');
                if (inputs.length > 0) {
                    setupFormInputs(inputs);
                }
            });

            safeTypeset([container]);
        }

        function setupFormInputs(inputs) {
            const qIndex = inputs[0].dataset.qIndex;
            inputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    if (e.target.value && index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }
                    saveFormAnswer(qIndex, inputs);
                });

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        inputs[index - 1].focus();
                    }
                     saveFormAnswer(qIndex, inputs);
                });
                 input.addEventListener('change', () => saveFormAnswer(qIndex, inputs));
            });
        }

        function saveFormAnswer(qIndex, inputs) {
            let combinedValue = '';
            inputs.forEach(inp => { combinedValue += inp.value; });
            userAnswers[qIndex] = combinedValue;
            updateProgress();
        }

        function selectOption(element, qIndex, optIndex) {
            userAnswers[qIndex] = optIndex;
            const questionCard = document.getElementById(`q-${qIndex}`);
            questionCard.querySelectorAll('.option').forEach(opt => {
                opt.classList.remove('selected');
                opt.querySelector('div:first-child').classList.remove('border-indigo-600', 'bg-indigo-600', 'text-white');
                opt.querySelector('div:first-child').classList.add('border-gray-300', 'text-gray-500');
            });
            element.classList.add('selected');
            element.querySelector('div:first-child').classList.remove('border-gray-300', 'text-gray-500');
            element.querySelector('div:first-child').classList.add('border-indigo-600', 'bg-indigo-600', 'text-white');
            updateProgress();
        }
        
        function selectTFOption(button, qIndex, stmtIndex, answer) {
            if (!userAnswers[qIndex] || !Array.isArray(userAnswers[qIndex])) {
                userAnswers[qIndex] = new Array(quizData[qIndex].statements.length).fill(null);
            }
            userAnswers[qIndex][stmtIndex] = answer;
            const parent = button.parentElement;
            
            // Reset styles
            const trueBtn = parent.children[0];
            const falseBtn = parent.children[1];
            
            trueBtn.className = 'bg-white text-gray-600 border border-gray-300 hover:bg-blue-50 px-5 py-2 rounded-lg font-semibold transition-all';
            falseBtn.className = 'bg-white text-gray-600 border border-gray-300 hover:bg-red-50 px-5 py-2 rounded-lg font-semibold transition-all';

            if (answer) {
                trueBtn.className = 'bg-blue-600 text-white shadow-md ring-2 ring-blue-300 px-5 py-2 rounded-lg font-semibold transition-all';
            } else {
                falseBtn.className = 'bg-red-500 text-white shadow-md ring-2 ring-red-300 px-5 py-2 rounded-lg font-semibold transition-all';
            }
            updateProgress();
        }
        
        function saveTextAnswer(element, qIndex) {
            userAnswers[qIndex] = element.value;
            updateProgress();
        }

        function confirmSubmit() {
            const unansweredQuestions = userAnswers.map((answer, index) => ({ answer, index }))
                                                .filter(item => item.answer === null || 
                                                                (Array.isArray(item.answer) && item.answer.some(a => a === null)));

            let message = "Bạn có chắc chắn muốn nộp bài không?";
            if (unansweredQuestions.length > 0) {
                message = `Bạn còn ${unansweredQuestions.length} câu chưa hoàn thành. Bạn có chắc chắn muốn nộp bài không?`;
            }

            if (confirm(message)) {
                submitQuiz();
            }
        }

        async function submitQuiz() {
            if (submissionStatus !== 'pending') return;
            submissionStatus = 'submitting';
            stopTimer();
            stopMonitoring();
            isQuizActive = false;
            
            const submitBtnEl = document.getElementById('submit-btn');
            submitBtnEl.disabled = true;
            submitBtnEl.innerHTML = '<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Đang nộp bài...';
            
            progressContainer.classList.add('hidden');
            toggleNavBtn.classList.add('hidden');
            navPanel.classList.remove('open');
            document.body.classList.remove('nav-open');

            const { score, totalPossibleScore, answerDetails } = calculateScore();
            lastScore = score;
            lastAnswerDetails = answerDetails;
            const finalScore = (totalPossibleScore > 0 ? (score / totalPossibleScore * 10) : 0).toFixed(2);
            let aiAssessment = 'Không có';

            if (options.aiAssessment) {
                aiAssessment = await getAIAssessment(finalScore, answerDetails);
            }
            
            const submissionData = new FormData();
            submissionData.append('timestamp', new Date().toLocaleString('vi-VN'));
            submissionData.append('name', studentName);
            submissionData.append('class', studentClass);
            submissionData.append('score', finalScore);
            submissionData.append('assessment', aiAssessment);
            submissionData.append('examCode', examCode);
            submissionData.append('monitoringLog', JSON.stringify(monitoringLog));
            submissionData.append('answerDetails', JSON.stringify(answerDetails));
            
            if (googleScriptUrl) {
                try {
                    await fetch(googleScriptUrl, { method: 'POST', body: new URLSearchParams(submissionData) });
                } catch (error) {
                    console.error('Error submitting to Google Script:', error);
                    alert('Lỗi: Không thể nộp kết quả lên hệ thống. Vui lòng kiểm tra lại kết nối mạng và thử lại.');
                }
            }
            submissionStatus = 'submitted';
            showResults(finalScore, aiAssessment, answerDetails);
        }
        
        function showResults(score, assessment, answerDetails) {
            quizScreen.classList.add('hidden');
            resultsScreen.classList.remove('hidden');
            
            // Trigger Confetti
            confetti({
                particleCount: 150,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#6366f1', '#8b5cf6', '#ec4899', '#14b8a6']
            });
            
            if (options.showAnswers) {
                const scoreDisplay = document.getElementById('score-display');
                scoreDisplay.querySelector('span:last-child').textContent = score;
                scoreDisplay.classList.remove('hidden');
            } else {
                const scoreDisplay = document.getElementById('score-display');
                scoreDisplay.innerHTML = '<p class="text-3xl text-center text-green-600 font-bold mb-4">Nộp bài thành công!</p><p class="text-gray-500">Kết quả đã được ghi nhận.</p>';
                scoreDisplay.classList.remove('hidden');
            }
            
            if (options.aiAssessment) {
                if (assessment.startsWith("Lỗi")) {
                    // handled
                } else {
                     document.querySelector('#assessment-display .assessment-content').innerHTML = assessment.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                     assessmentDisplay.classList.remove('hidden');
                }
            } else {
                assessmentDisplay.classList.add('hidden');
            }
            
            if (options.showAnswers) {
                renderReview(answerDetails);
            } else {
                reviewContainer.innerHTML = '<div class="text-center p-8 bg-gray-50 rounded-xl border border-gray-200"><p class="text-gray-600">Giáo viên đã chọn không hiển thị đáp án và giải thích chi tiết.</p></div>';
            }
            
            if (retriesCount < options.retriesAllowed) retryBtn.classList.remove('hidden');
        }

        function calculateScore() {
            let score = 0;
            let totalPossibleScore = 0;
            const answerDetails = [];
            
            const mcCount = quizData.filter(q => mapType(q.type) === 'multiple-choice').length;
            const tfCount = quizData.filter(q => mapType(q.type) === 'true-false').length;
            const saCount = quizData.filter(q => mapType(q.type) === 'short-answer').length;

            const pointsPerMc = mcCount > 0 ? options.scoring.mc / mcCount : 0;
            const pointsPerTf = tfCount > 0 ? options.scoring.tf / tfCount : 0;
            const pointsPerSa = saCount > 0 ? options.scoring.sa / saCount : 0;
            
            totalPossibleScore = (options.scoring.mc || 0) + (options.scoring.tf || 0) + (options.scoring.sa || 0) + (options.scoring.essay || 0);
            if (totalPossibleScore === 0 && (mcCount + tfCount + saCount > 0)) {
                 totalPossibleScore = (pointsPerMc * mcCount) + (pointsPerTf * tfCount) + (pointsPerSa * saCount);
            }
            if (totalPossibleScore === 0 && quizData.length > 0) totalPossibleScore = 10; 

            quizData.forEach((item, index) => {
                const userAnswer = userAnswers[index];
                let isCorrect = false;
                let detail = null;
                const type = mapType(item.type);

                if (type === 'multiple-choice') {
                    isCorrect = userAnswer === item.correctAnswerIndex;
                    if(isCorrect) score += pointsPerMc;
                } else if (type === 'true-false') {
                    let correctStatements = 0;
                    detail = [];
                    (item.statements || []).forEach((stmt, i) => {
                        const isStmtCorrect = (userAnswer && userAnswer[i] === stmt.is_correct);
                        if(isStmtCorrect) correctStatements++;
                        detail.push({isCorrect: isStmtCorrect});
                    });

                    if (options.scoring.tfMethod === 'even') {
                        score += (correctStatements / 4) * pointsPerTf;
                    } else { // progressive
                        if (correctStatements === 4) score += pointsPerTf;
                        else if (correctStatements === 3) score += 0.5 * pointsPerTf;
                        else if (correctStatements === 2) score += 0.25 * pointsPerTf;
                        else if (correctStatements === 1) score += 0.1 * pointsPerTf;
                    }
                    isCorrect = correctStatements === 4;
                } else if (type === 'short-answer') {
                    const correctAnswer = (item.answer || '').toString().trim().toLowerCase();
                    const studentAnswer = (userAnswer || '').toString().trim().toLowerCase();
                    isCorrect = studentAnswer === correctAnswer;
                    if (isCorrect) {
                        score += pointsPerSa;
                    }
                } else {
                    isCorrect = null; // For 'essay' type
                }
                answerDetails.push({ questionNumber: index + 1, isCorrect, type, details: detail });
            });
            return { score, totalPossibleScore, answerDetails };
        }
        
        function renderReview(answerDetails) {
            let reviewHTML = '<h3 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-2">Xem lại bài làm chi tiết</h3>';
            quizData.forEach((item, index) => {
                const type = mapType(item.type);
                const detail = answerDetails.find(d => d.questionNumber === index + 1);
                const isCorrectQuestion = detail?.isCorrect;

                let borderColor = isCorrectQuestion ? 'border-green-200' : (isCorrectQuestion === false ? 'border-red-200' : 'border-gray-200');
                let bgColor = isCorrectQuestion ? 'bg-green-50' : (isCorrectQuestion === false ? 'bg-red-50' : 'bg-gray-50');
                
                reviewHTML += `<div class="mb-8 p-6 border ${borderColor} rounded-2xl ${bgColor} shadow-sm relative overflow-hidden">`;
                
                // Status Badge
                if (type !== 'essay') {
                     reviewHTML += `<div class="absolute top-0 right-0 px-3 py-1 text-xs font-bold uppercase tracking-wider rounded-bl-lg ${isCorrectQuestion ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}">${isCorrectQuestion ? 'Đúng' : 'Sai'}</div>`;
                }

                reviewHTML += `<div class="flex gap-2 mb-3"><span class="bg-white border border-gray-200 text-gray-700 font-bold px-2.5 py-0.5 rounded-md text-sm">Câu ${index + 1}</span></div>`;
                reviewHTML += `<div class="prose max-w-none mb-4 text-gray-800">${item.rendered_question}</div>`;

                if (type === 'multiple-choice') {
                     reviewHTML += '<div class="space-y-2">';
                     (item.rendered_options || []).forEach((opt, i) => {
                        let classes = 'p-3 border rounded-lg flex items-start gap-3';
                        let icon = '';
                        
                        if (i === item.correctAnswerIndex) {
                            classes += ' bg-green-100 border-green-400 ring-1 ring-green-400'; // Correct answer style
                            icon = '<svg class="w-5 h-5 text-green-600 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>';
                        } else if (userAnswers[index] === i) {
                            classes += ' bg-red-100 border-red-400'; // Selected wrong answer
                            icon = '<svg class="w-5 h-5 text-red-600 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>';
                        } else {
                            classes += ' bg-white border-gray-200 opacity-70';
                        }

                        reviewHTML += `<div class="${classes}">
                            <span class="font-bold flex-shrink-0 w-6">${String.fromCharCode(65 + i)}.</span>
                            <div class="flex-grow">${opt}</div>
                            ${icon}
                        </div>`;
                     });
                     reviewHTML += '</div>';
                } else if (type === 'true-false') {
                     reviewHTML += '<div class="space-y-2 mt-4">';
                     (item.statements || []).forEach((stmt, i) => {
                         const userChoice = userAnswers[index] ? userAnswers[index][i] : null;
                         const isStmtCorrect = userChoice === stmt.is_correct;
                         let classes = 'p-3 border rounded-lg flex items-center justify-between gap-4 bg-white';
                         
                         if (userChoice !== null) {
                            classes = isStmtCorrect ? 'p-3 border border-green-300 bg-green-100 rounded-lg flex items-center justify-between gap-4' : 'p-3 border border-red-300 bg-red-100 rounded-lg flex items-center justify-between gap-4';
                         }

                         reviewHTML += `<div class="${classes}">
                                         <div class="prose max-w-none text-sm">${stmt.rendered_statement}</div>
                                         <div class="flex-shrink-0 text-right text-sm">
                                             <div class="${stmt.is_correct ? 'text-green-700 font-bold' : 'text-red-700 font-bold'}">Đáp án: ${stmt.is_correct ? 'Đúng' : 'Sai'}</div>
                                             <div class="text-gray-600">Bạn chọn: <span class="font-medium">${userChoice === true ? 'Đúng' : userChoice === false ? 'Sai' : '...'}</span></div>
                                         </div>
                                     </div>`;
                     });
                     reviewHTML += '</div>';
                } else {
                    reviewHTML += `<div class="mt-4 p-4 bg-white border border-gray-200 rounded-xl">
                        <p class="text-sm font-bold text-gray-500 mb-1">Câu trả lời của bạn:</p>
                        <div class="text-gray-800">${userAnswers[index] || '<em class="text-gray-400">Chưa trả lời</em>'}</div>
                    </div>`;
                    if (item.rendered_answer) {
                        reviewHTML += `<div class="mt-3 p-4 bg-green-50 border border-green-200 rounded-xl">
                            <p class="text-sm font-bold text-green-700 mb-1">Đáp án gợi ý:</p>
                            <div class="prose max-w-none text-green-900">${item.rendered_answer}</div>
                        </div>`;
                    }
                }
                
                if (options.showExplanation) {
                     reviewHTML += `<div class="mt-4 pt-4 border-t border-gray-200/50">
                                      <button class="flex items-center gap-1 text-sm font-semibold text-indigo-600 hover:text-indigo-800 transition-colors" onclick="toggleExplanation(${index}, this)">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                        Xem giải thích chi tiết từ AI
                                      </button>
                                      <div id="explanation-${index}" class="mt-3 p-4 bg-indigo-50 border border-indigo-100 rounded-xl hidden text-sm text-gray-700 leading-relaxed"></div>
                                   </div>`;
                }
                reviewHTML += '</div>';
            });
            reviewContainer.innerHTML = reviewHTML;
            safeTypeset([reviewContainer]);
        }

        function retryQuiz() {
            retriesCount++;
            startQuiz();
        }
        
        function startTimer() {
            stopTimer();
            timerInterval = setInterval(() => {
                timeRemaining--;
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                if (timeRemaining <= 0) {
                    stopTimer();
                    alert('Đã hết thời gian làm bài!');
                    submitQuiz();
                }
            }, 1000);
        }

        function stopTimer() { clearInterval(timerInterval); }
        
        function showWarning(message) {
            warningEl.textContent = message;
            warningEl.style.display = 'block';
            warningEl.style.animation = 'none';
            warningEl.offsetHeight; 
            warningEl.style.animation = 'fade-in-out 5s ease-in-out';
        }

        function handleVisibilityChange() {
            if (document.hidden) {
                monitoringLog.thoatManHinh++;
                showWarning('⚠️ Đã phát hiện chuyển tab hoặc thu nhỏ cửa sổ!');
            }
        }
        function handleCopy() { monitoringLog.saoChep++; showWarning('⚠️ Đã phát hiện hành vi sao chép!'); }
        function handlePaste() { monitoringLog.dan++; showWarning('⚠️ Đã phát hiện hành vi dán!'); }
        function startMonitoring() {
            monitoringLog = { thoatManHinh: 0, saoChep: 0, dan: 0 };
            document.addEventListener('visibilitychange', handleVisibilityChange);
            document.addEventListener('copy', handleCopy);
            document.addEventListener('paste', handlePaste);
        }
        function stopMonitoring() {
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            document.removeEventListener('copy', handleCopy);
            document.removeEventListener('paste', handlePaste);
        }

        async function toggleExplanation(index, button) {
            const explanationContainer = document.getElementById(`explanation-${index}`);
            if (!explanationContainer) return;

            const isHidden = explanationContainer.classList.toggle('hidden');
            button.innerHTML = isHidden 
                ? '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> Xem giải thích chi tiết từ AI' 
                : '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" /></svg> Ẩn giải thích';

            const hasLoaded = explanationContainer.hasAttribute('data-loaded');
            const hadError = explanationContainer.getAttribute('data-loaded') === 'error';

            if (!isHidden && (!hasLoaded || hadError)) {
                await fetchAndRenderExplanation(index);
            }
        }

        async function fetchAndRenderExplanation(index) {
            const explanationContainer = document.getElementById(`explanation-${index}`);
            explanationContainer.innerHTML = '<div class="flex items-center gap-2 text-indigo-500"><svg class="animate-spin h-4 w-4" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> AI đang soạn lời giải...</div>';
            explanationContainer.setAttribute('data-loaded', 'loading');

            try {
                const item = quizData[index];
                const questionText = (mapType(item.type) === 'true-false') ? (item.main_question || '') : (item.question || '');
                let prompt = `Bạn là một trợ lý giáo viên AI xuất sắc. Hãy viết lời giải chi tiết, dễ hiểu cho câu hỏi này.\n---\nCÂU HỎI:\n${questionText}\n---`;
                
                if (mapType(item.type) === 'multiple-choice') {
                    prompt += `\n**ĐÁP ÁN ĐÚNG:** ${String.fromCharCode(65 + item.correctAnswerIndex)}. ${item.options[item.correctAnswerIndex] || ''}`;
                } else if (mapType(item.type) === 'true-false') {
                    prompt += `\n**CÁC MỆNH ĐỀ VÀ ĐÁP ÁN:**\n${item.statements.map((s, i) => `${String.fromCharCode(97 + i)}) ${s.statement || ''} -> ${s.is_correct ? 'Đúng' : 'Sai'}`).join('\n')}`;
                } else {
                    prompt += `---\n**ĐÁP ÁN / GỢI Ý:** ${item.answer || ''}`;
                }
                prompt += `\n---\n**YÊU CẦU:** Giải thích từng bước logic. Định dạng công thức toán bằng LaTeX (trong dấu $). Dùng **...** để in đậm các ý quan trọng.`;
                
                const response = await generateContentWithSmartFallback(prompt);
                const explanationText = response.text || "Không thể tạo giải thích.";
                
                let htmlContent = explanationText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                explanationContainer.innerHTML = htmlContent;
                safeTypeset([explanationContainer]);
                explanationContainer.setAttribute('data-loaded', 'true');

            } catch (error) {
                console.error("AI Explanation Error:", error);
                explanationContainer.innerHTML = `<div class="text-red-600 text-sm">Đã xảy ra lỗi khi tải lời giải. ${error.message}. <button onclick="event.preventDefault(); fetchAndRenderExplanation(${index})" class="underline font-semibold ml-1">Thử lại</button></div>`;
                explanationContainer.setAttribute('data-loaded', 'error');
            }
        }

        async function getAIAssessment(score, answerDetails) {
            document.querySelector('#assessment-display .assessment-content').innerHTML = '<div class="flex items-center gap-2 text-indigo-600"><svg class="animate-spin h-5 w-5" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> AI đang phân tích bài làm của bạn...</div>';
            assessmentDisplay.classList.remove('hidden');

            try {
                const wrongAnswers = answerDetails.filter(d => d.isCorrect === false || (d.type === 'true-false' && d.details && d.details.some(sub => !sub.isCorrect)));
                if (wrongAnswers.length === 0) {
                    const congrats = "Tuyệt vời! Em đã làm bài xuất sắc và không sai câu nào. Kiến thức của em rất vững vàng. Hãy tiếp tục duy trì phong độ này nhé! 🌟";
                    document.querySelector('#assessment-display .assessment-content').innerHTML = congrats;
                    return congrats;
                }
                const wrongQuestionsSummary = wrongAnswers.map(d => {
                    const item = quizData[d.questionNumber - 1];
                    const questionText = item.question || item.main_question || '';
                    return `- Câu ${d.questionNumber}: ${questionText}`;
                }).join('\n');
                
                const prompt = `Bạn là một giáo viên AI tâm lý và tận tụy. Dựa vào kết quả bài làm sau, hãy viết một đoạn nhận xét ngắn gọn (khoảng 100 từ) cho học sinh.\n**Kết quả:**\n- Điểm số: ${score} / 10\n- Các câu làm sai (nội dung tóm tắt):\n${wrongQuestionsSummary}\n**YÊU CẦU:**\n1. Bắt đầu bằng lời khen ngợi nỗ lực.\n2. Chỉ ra các mảng kiến thức cần ôn tập lại dựa trên các câu sai.\n3. Đưa ra 1 lời khuyên cụ thể để cải thiện.\n4. Kết thúc bằng lời động viên ấm áp.\n5. Sử dụng icon cảm xúc phù hợp.`;

                const response = await generateContentWithSmartFallback(prompt);
                const assessmentText = response.text || "Không thể tạo nhận xét.";
                
                document.querySelector('#assessment-display .assessment-content').innerHTML = assessmentText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                return assessmentText;

            } catch (error) {
                console.error("AI Assessment Error:", error);
                document.querySelector('#assessment-display .assessment-content').innerHTML = `<div class="text-red-600">Lỗi kết nối với AI: ${error.message}. <button onclick="retryAIAssessment()" class="underline font-bold ml-1">Thử lại</button></div>`;
                return "Lỗi khi tạo nhận xét AI.";
            }
        }
        
        async function retryAIAssessment() {
            if (lastAnswerDetails) {
                const finalScore = (lastScore / (quizData.length > 0 ? 10 : 1) * 10).toFixed(2);
                await getAIAssessment(finalScore, lastAnswerDetails);
            }
        }
    </script>
</body>
</html>
    